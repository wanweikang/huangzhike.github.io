<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
        <script>
            var timeStart = new Date();
        </script>
        
        <title>[ç¬”è®°]-Nacos-Naming-Client | ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜</title>
        
        <meta name="author" content="huangzhike">
        
        
        <meta name="description" content="NacosNamingService#init
    private void init(Properties properties) throws NacosException {
        ValidatorUtils.checkInitParam(properties);
      ">
        
        
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        
        <meta property="og:title" content="[ç¬”è®°]-Nacos-Naming-Client"/>
        
        <meta property="og:site_name" content="ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜"/>
        
        
        <!-- favicon -->
        <link rel="icon" type="image/ico" href="/ok.ico" sizes="32x32">
        <meta name="msapplication-TileColor" content="#009688">
        <meta name="msapplication-TileImage" content="/mstile-144x144.ico">
        <meta name="theme-color" content="#009688">
        <!-- favicon end -->
        <!-- <link href="//ok.ico" rel="icon"> -->
        
        <!-- toc -->
        <!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
        <!-- material design -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
        <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
        
        <!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
        <!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
    <meta name="generator" content="Hexo 4.2.1"></head>

<body>
    <nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">èœå•</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" title="ä¸‹ä¸€å¥æ˜¯ï¼šå®¢æœ‰å¯äººæœŸä¸æ¥ã€‚å°æ—¶å€™ï¼Œå–œæ¬¢é åœ¨é˜³å°ä¸Šï¼Œä¸€è¾¹å¹é£ï¼Œä¸€è¾¹çœ‹ä¹¦ï¼Œå–œæ¬¢è¯»ä¹¦å—ï¼Œéªšå¹´ï¼Ÿ" href="/">ä¹¦å½“å¿«æ„è¯»æ˜“å°½</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" target="_blank" rel="noopener" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

    <div class="container" >
        <div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[ç¬”è®°]-Nacos-Naming-Client</h2>
				
				<div>
					<div class="post-time">2020-06-25</div>
				</div>
				
				<div class="article-content">
				<p>NacosNamingService#init</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span>Properties properties<span class="token punctuation">)</span> <span class="token keyword">throws</span> NacosException <span class="token punctuation">{</span>
        ValidatorUtils<span class="token punctuation">.</span><span class="token function">checkInitParam</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// åˆå§‹åŒ–å‘½åç©ºé—´ï¼Œç”¨äºå¤šç§Ÿæˆ·éš”ç¦»ï¼Œé»˜è®¤public</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>namespace <span class="token operator">=</span> InitUtils<span class="token punctuation">.</span><span class="token function">initNamespaceForNaming</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
        InitUtils<span class="token punctuation">.</span><span class="token function">initSerialization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// åˆå§‹åŒ–Serveråˆ—è¡¨</span>
        <span class="token function">initServerAddr</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
        InitUtils<span class="token punctuation">.</span><span class="token function">initWebRootContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// åˆå§‹åŒ–æœ¬åœ°æŒä¹…åŒ–ç¼“å­˜ç›®å½•</span>
        <span class="token function">initCacheDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">initLogName</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// äº‹ä»¶åˆ†å‘å™¨ï¼Œåœ¨ä¸€ä¸ªçº¿ç¨‹å¾ªç¯å†…ä»é˜»å¡é˜Ÿåˆ—å–å‡ºäº‹ä»¶ï¼Œå¹¶æ‰§è¡Œè®¢é˜…çš„å›è°ƒ</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>eventDispatcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventDispatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ä¸Serveré€šä¿¡çš„ä»£ç†å¯¹è±¡</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>serverProxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NamingProxy</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>namespace<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>endpoint<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>serverList<span class="token punctuation">,</span> properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// åˆå§‹åŒ–å¿ƒè·³çº¿ç¨‹æ± ï¼Œä¸ªäººæ„Ÿè§‰è¿™ä¸ªReactorå‘½åæœ‰ç‚¹ä¸çŸ¥æ‰€äº‘</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>beatReactor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BeatReactor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>serverProxy<span class="token punctuation">,</span> <span class="token function">initClientBeatThreadCount</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// åˆå§‹åŒ–ä¸Serveräº¤äº’çš„å¯¹è±¡</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>hostReactor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HostReactor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>eventDispatcher<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>serverProxy<span class="token punctuation">,</span> beatReactor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cacheDir<span class="token punctuation">,</span>
            <span class="token function">isLoadCacheAtStart</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">initPollingThreadCount</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>NacosNamingService#initServerAddr</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initServerAddr</span><span class="token punctuation">(</span>Properties properties<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        serverList <span class="token operator">=</span> properties<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span>PropertyKeyConst<span class="token punctuation">.</span>SERVER_ADDR<span class="token punctuation">)</span><span class="token punctuation">;</span>
        endpoint <span class="token operator">=</span> InitUtils<span class="token punctuation">.</span><span class="token function">initEndpoint</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¦‚æœé…ç½®äº†Endpointé‚£å°±ä»Endpointæ›´æ–°Serveråœ°å€</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>endpoint<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            serverList <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>NamingProxy#initRefreshTask</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initRefreshTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>executorService <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment" spellcheck="true">// å¦‚æœé…ç½®äº†Endpointå°±å®šæœŸä»åœ°å€æœåŠ¡å™¨æ›´æ–°ServerList</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>executorService<span class="token punctuation">.</span><span class="token function">scheduleWithFixedDelay</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">refreshSrvIfNeed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> vipSrvRefInterMillis<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// å®šæœŸç™»å½•Serverï¼Œå¦‚æœé…ç½®äº†ç”¨æˆ·åå’Œå¯†ç </span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>executorService<span class="token punctuation">.</span><span class="token function">scheduleWithFixedDelay</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                securityProxy<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token function">getServerList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> securityInfoRefreshIntervalMills<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">refreshSrvIfNeed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>securityProxy<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token function">getServerList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>NamingProxy#refreshSrvIfNeed</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">refreshSrvIfNeed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// é…ç½®äº†Serveråˆ—è¡¨å°±ä½¿ç”¨é…ç½®çš„</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>CollectionUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>serverList<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> lastSrvRefTime <span class="token operator">&lt;</span> vipSrvRefInterMillis<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å¦åˆ™ä»Endpointæ›´æ–°Serveråˆ—è¡¨ï¼ŒAddressServer</span>
            List<span class="token operator">&lt;</span>String<span class="token operator">></span> list <span class="token operator">=</span> <span class="token function">getServerListFromEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ...</span>
            serversFromEndpoint <span class="token operator">=</span> list<span class="token punctuation">;</span>
            lastSrvRefTime <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>Nacosçš„AddressServeræ˜¯æŠŠServerListä¹Ÿå½“æˆæœåŠ¡æ¥å¤„ç†çš„ï¼Œæ‰€ä»¥åœ°å€æœåŠ¡å™¨æ¨¡å—ä¾èµ–Namingæ¨¡å—ã€‚</p>
<hr>
<p>NacosNamingService#registerInstance</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerInstance</span><span class="token punctuation">(</span>String serviceName<span class="token punctuation">,</span> String groupName<span class="token punctuation">,</span> String ip<span class="token punctuation">,</span> <span class="token keyword">int</span> port<span class="token punctuation">,</span> String clusterName<span class="token punctuation">)</span> <span class="token keyword">throws</span> NacosException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// æœåŠ¡å®ä¾‹</span>
        <span class="token comment" spellcheck="true">// é»˜è®¤åˆ†ç»„ä¸ºDEFAULT_GROUPï¼Œé»˜è®¤é›†ç¾¤ä¸ºDEFAULT</span>
        Instance instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        instance<span class="token punctuation">.</span><span class="token function">setIp</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
        instance<span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
        instance<span class="token punctuation">.</span><span class="token function">setWeight</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        instance<span class="token punctuation">.</span><span class="token function">setClusterName</span><span class="token punctuation">(</span>clusterName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ³¨å†Œå®ä¾‹</span>
        <span class="token function">registerInstance</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> groupName<span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>Instance</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Instance</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> String instanceId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> String ip<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> port<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">double</span> weight <span class="token operator">=</span> <span class="token number">1.0D</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> healthy <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> enabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/**
     * é»˜è®¤æ˜¯ä¸´æ—¶èŠ‚ç‚¹ï¼Œéœ€è¦å¿ƒè·³æ¥ç»´æŠ¤å­˜åœ¨
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> ephemeral <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> String clusterName<span class="token punctuation">;</span>
    <span class="token keyword">private</span> String serviceName<span class="token punctuation">;</span>
    <span class="token keyword">private</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> metadata <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>NacosNamingService#registerInstance</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerInstance</span><span class="token punctuation">(</span>String serviceName<span class="token punctuation">,</span> String groupName<span class="token punctuation">,</span> Instance instance<span class="token punctuation">)</span> <span class="token keyword">throws</span> NacosException <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token function">isEphemeral</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            BeatInfo beatInfo <span class="token operator">=</span> beatReactor<span class="token punctuation">.</span><span class="token function">buildBeatInfo</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// åˆ›å»ºå¿ƒè·³ä»»åŠ¡</span>
            beatReactor<span class="token punctuation">.</span><span class="token function">addBeatInfo</span><span class="token punctuation">(</span>NamingUtils<span class="token punctuation">.</span><span class="token function">getGroupedName</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> groupName<span class="token punctuation">)</span><span class="token punctuation">,</span> beatInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// æ³¨å†Œåˆ°Server</span>
        serverProxy<span class="token punctuation">.</span><span class="token function">registerService</span><span class="token punctuation">(</span>NamingUtils<span class="token punctuation">.</span><span class="token function">getGroupedName</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> groupName<span class="token punctuation">)</span><span class="token punctuation">,</span> groupName<span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>BeatReactor$BeatTask#run</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">long</span> nextTime <span class="token operator">=</span> beatInfo<span class="token punctuation">.</span><span class="token function">getPeriod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å‘é€å¿ƒè·³ç»™Serverï¼ŒHTTPåè®®</span>
                JsonNode result <span class="token operator">=</span> serverProxy<span class="token punctuation">.</span><span class="token function">sendBeat</span><span class="token punctuation">(</span>beatInfo<span class="token punctuation">,</span> BeatReactor<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>lightBeatEnabled<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// æ ¹æ®Serverçš„è¿”å›å€¼è°ƒæ•´å¿ƒè·³é—´éš”</span>
                <span class="token keyword">long</span> interval <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"clientBeatInterval"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">boolean</span> lightBeatEnabled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// æ ¹æ®Serverçš„è¿”å›å€¼è°ƒæ•´æ˜¯å¦ä½¿ç”¨è½»é‡çº§å¿ƒè·³</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>CommonParams<span class="token punctuation">.</span>LIGHT_BEAT_ENABLED<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    lightBeatEnabled <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>CommonParams<span class="token punctuation">.</span>LIGHT_BEAT_ENABLED<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asBoolean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                BeatReactor<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>lightBeatEnabled <span class="token operator">=</span> lightBeatEnabled<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>interval <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    nextTime <span class="token operator">=</span> interval<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">int</span> code <span class="token operator">=</span> NamingResponseCode<span class="token punctuation">.</span>OK<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ...</span>
                <span class="token comment" spellcheck="true">// Serveræ²¡æœ‰å¯¹åº”çš„æœåŠ¡å®ä¾‹</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">==</span> NamingResponseCode<span class="token punctuation">.</span>RESOURCE_NOT_FOUND<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    Instance instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// é‡æ–°æ³¨å†Œ</span>
                        serverProxy<span class="token punctuation">.</span><span class="token function">registerService</span><span class="token punctuation">(</span>beatInfo<span class="token punctuation">.</span><span class="token function">getServiceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> NamingUtils<span class="token punctuation">.</span><span class="token function">getGroupName</span><span class="token punctuation">(</span>beatInfo<span class="token punctuation">.</span><span class="token function">getServiceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ignore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NacosException</span> ne<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ä¸‹æ¬¡å¿ƒè·³</span>
            executorService<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BeatTask</span><span class="token punctuation">(</span>beatInfo<span class="token punctuation">)</span><span class="token punctuation">,</span> nextTime<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>NamingProxy#reqAPI</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> String <span class="token function">reqAPI</span><span class="token punctuation">(</span>String api<span class="token punctuation">,</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> params<span class="token punctuation">,</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> body<span class="token punctuation">,</span> List<span class="token operator">&lt;</span>String<span class="token operator">></span> servers<span class="token punctuation">,</span> String method<span class="token punctuation">)</span> <span class="token keyword">throws</span> NacosException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>servers <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>servers<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Random random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> index <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>servers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// éšæœºè½®è¯¢ä¸€ä¸ªServerå‘é€æˆåŠŸå°±ç›´æ¥è¿”å›ï¼Œä¸ç®¡æ˜¯å¿ƒè·³è¿˜æ˜¯æœåŠ¡æ³¨å†Œï¼Œäº¤ç»™ServeråŒæ­¥å°±å¥½</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> servers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                String server <span class="token operator">=</span> servers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// HTTPè¯·æ±‚</span>
                    <span class="token keyword">return</span> <span class="token function">callServer</span><span class="token punctuation">(</span>api<span class="token punctuation">,</span> params<span class="token punctuation">,</span> body<span class="token punctuation">,</span> server<span class="token punctuation">,</span> method<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NacosException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                index <span class="token operator">=</span> <span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> servers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å¦‚æœæ‰‹åŠ¨é…ç½®çš„ServerListåªæœ‰ä¸€ä¸ªServer</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>nacosDomain<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å¤±è´¥é‡è¯•æ¬¡æ•°</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> UtilAndComs<span class="token punctuation">.</span>REQUEST_DOMAIN_RETRY_COUNT<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token function">callServer</span><span class="token punctuation">(</span>api<span class="token punctuation">,</span> params<span class="token punctuation">,</span> body<span class="token punctuation">,</span> nacosDomain<span class="token punctuation">,</span> method<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NacosException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ...</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>NacosNamingService#getAllInstances</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> List<span class="token operator">&lt;</span>Instance<span class="token operator">></span> <span class="token function">getAllInstances</span><span class="token punctuation">(</span>String serviceName<span class="token punctuation">,</span> String groupName<span class="token punctuation">,</span> List<span class="token operator">&lt;</span>String<span class="token operator">></span> clusters<span class="token punctuation">,</span> <span class="token keyword">boolean</span> subscribe<span class="token punctuation">)</span> <span class="token keyword">throws</span> NacosException <span class="token punctuation">{</span>
        ServiceInfo serviceInfo<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// é»˜è®¤æ˜¯è‡ªåŠ¨è®¢é˜…çš„</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>subscribe<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è·å–æœåŠ¡çš„ä¿¡æ¯</span>
            serviceInfo <span class="token operator">=</span> hostReactor<span class="token punctuation">.</span><span class="token function">getServiceInfo</span><span class="token punctuation">(</span>NamingUtils<span class="token punctuation">.</span><span class="token function">getGroupedName</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> groupName<span class="token punctuation">)</span><span class="token punctuation">,</span> StringUtils<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>clusters<span class="token punctuation">,</span> <span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            serviceInfo <span class="token operator">=</span> hostReactor<span class="token punctuation">.</span><span class="token function">getServiceInfoDirectlyFromServer</span><span class="token punctuation">(</span>NamingUtils<span class="token punctuation">.</span><span class="token function">getGroupedName</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> groupName<span class="token punctuation">)</span><span class="token punctuation">,</span> StringUtils<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>clusters<span class="token punctuation">,</span> <span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        List<span class="token operator">&lt;</span>Instance<span class="token operator">></span> list<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>serviceInfo <span class="token operator">==</span> null <span class="token operator">||</span> CollectionUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>list <span class="token operator">=</span> serviceInfo<span class="token punctuation">.</span><span class="token function">getHosts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>Instance<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// è¿”å›æœåŠ¡ä¸‹çš„å®ä¾‹</span>
        <span class="token keyword">return</span> list<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>HostReactor#getServiceInfo</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> ServiceInfo <span class="token function">getServiceInfo</span><span class="token punctuation">(</span><span class="token keyword">final</span> String serviceName<span class="token punctuation">,</span> <span class="token keyword">final</span> String clusters<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        String key <span class="token operator">=</span> ServiceInfo<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> clusters<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¦‚æœæœ¬åœ°çš„FAILOVER_SWITCHæ–‡ä»¶å­˜åœ¨çš„å¹¶ä¸”è¢«æ ‡è®°ä¸ºæ‰“å¼€ï¼Œé‚£ä¹ˆå°±ä»æœ¬åœ°æŒä¹…åŒ–çš„ç¼“å­˜ä¸­è·å–æœåŠ¡ä¿¡æ¯è¿”å›</span>
        <span class="token comment" spellcheck="true">// ä¸è¿‡æˆ‘æ€ä¹ˆä¹Ÿæ²¡æ‰¾åˆ°è¿™ä¸ªæ–‡ä»¶æ˜¯æ€ä¹ˆåˆ›å»ºçš„</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>failoverReactor<span class="token punctuation">.</span><span class="token function">isFailoverSwitch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// FailoverReactorä¼šå®šæ—¶æŒä¹…åŒ–æœåŠ¡ä¿¡æ¯åˆ°ç£ç›˜ï¼Œç”¨äºå®¢æˆ·ç«¯å®¹ç¾</span>
            <span class="token keyword">return</span> failoverReactor<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å…ˆä»æœ¬åœ°å†…å­˜çš„Mapè·å–æœåŠ¡çš„ä¿¡æ¯</span>
        ServiceInfo serviceObj <span class="token operator">=</span> <span class="token function">getServiceInfo0</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> clusters<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æœ¬åœ°ç¼“å­˜æ²¡æœ‰</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">==</span> serviceObj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            serviceObj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceInfo</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> clusters<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// åˆ›å»ºä¸€ä¸ªå¹¶åŠ å…¥</span>
            serviceInfoMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>serviceObj<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> serviceObj<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ ‡è®°è¯¥æœåŠ¡ä¿¡æ¯æ­£åœ¨æ›´æ–°</span>
            updatingMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ä»Serverè·å–è¯¥æœåŠ¡çš„ä¿¡æ¯</span>
            <span class="token function">updateServiceNow</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> clusters<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// Timeline 1</span>
            <span class="token comment" spellcheck="true">// æ›´æ–°å®ŒæŠŠæ›´æ–°æ ‡è®°ç§»é™¤</span>
            updatingMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Timeline 2</span>
        <span class="token comment" spellcheck="true">// æœåŠ¡ä¿¡æ¯æ­£åœ¨æ›´æ–°</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>updatingMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>UPDATE_HOLD_INTERVAL <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å…ˆé˜»å¡è·å–é”</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>serviceObj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// é‡Šæ”¾é”ï¼Œé˜»å¡ç­‰å¾…è‡³5sè¶…æ—¶æˆ–è€…æ›´æ–°å®Œåè¢«å”¤é†’</span>
                        serviceObj<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>UPDATE_HOLD_INTERVAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// è‡ªåŠ¨è®¢é˜…ï¼Œå³è‡ªåŠ¨ä»Serveræ›´æ–°æœåŠ¡ä¿¡æ¯</span>
        <span class="token function">scheduleUpdateIfAbsent</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> clusters<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è¿”å›æœåŠ¡ä¿¡æ¯</span>
        <span class="token keyword">return</span> serviceInfoMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>serviceObj<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ä¸Šé¢è¿™æ®µä»£ç å…¶å®æ˜¯æœ‰ç‚¹å°é—®é¢˜çš„ï¼Œä¹‹å‰æˆ‘ä¹Ÿæäº†ä¸€ä¸ªIssueï¼Œå°±æ˜¯åœ¨å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œçº¿ç¨‹Aæ‰§è¡Œå®ŒupdateServiceNowï¼Œä½†æ˜¯è¿˜æ²¡æ¥å¾—åŠå°†æ›´æ–°æ ‡è®°ç§»é™¤ï¼ˆTimeline 1ï¼‰ï¼Œæ­¤æ—¶æœ‰å¤šä¸ªçº¿ç¨‹è¿›å…¥ä¸‹é¢çš„æ¡ä»¶åˆ¤æ–­ï¼ˆTimeline 2ï¼‰ï¼Œé‚£ä¹ˆè¿™äº›çº¿ç¨‹æ˜¯æ”¶ä¸åˆ°æ›´æ–°çš„å”¤é†’çš„ï¼Œåªèƒ½å…¨éƒ¨ç­‰å¾…5sï¼Œä½†å®é™…ä¸Šæ­¤æ—¶æœåŠ¡ä¿¡æ¯æ˜¯å·²ç»æ›´æ–°å®Œäº†çš„ï¼Œæ²¡å¿…è¦ç­‰å¾…ã€‚</p>
<p>æˆ‘æƒ³åˆ°çš„ä¸€ä¸ªæ–¹æ³•æ˜¯ä½¿ç”¨ç±»ä¼¼åŒé‡æ£€æŸ¥é”å’ŒString#internçš„æ–¹æ³•ï¼Œä½†æ˜¯è²Œä¼¼æ²¡æœ‰å¿…è¦ï¼Ÿ</p>
<p>Nacosçš„æœåŠ¡å‘ç°æ˜¯APçš„ï¼Œå› ä¸ºå®¢æˆ·ç«¯æœ‰ç¼“å­˜ï¼Œå¹¶ä¸”æœåŠ¡ç«¯è™½ç„¶è¯´ä½¿ç”¨äº†RaftåŒæ­¥ï¼Œä½†å®é™…ä¸Šå¹¶ä¸ä¸¥æ ¼ã€‚</p>
<p>å½“ç„¶é…ç½®ä¸­å¿ƒéƒ¨åˆ†æ˜¯ä¸¥æ ¼çš„Raftåè®®ã€‚</p>
<p>HostReactor#updateServiceNow</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateServiceNow</span><span class="token punctuation">(</span>String serviceName<span class="token punctuation">,</span> String clusters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ä»å†…å­˜ç¼“å­˜è·å–æœåŠ¡ä¿¡æ¯</span>
        ServiceInfo oldService <span class="token operator">=</span> <span class="token function">getServiceInfo0</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> clusters<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ä»æœåŠ¡å™¨è·å–æœåŠ¡ä¿¡æ¯</span>
            String result <span class="token operator">=</span> serverProxy<span class="token punctuation">.</span><span class="token function">queryList</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> clusters<span class="token punctuation">,</span> pushReceiver<span class="token punctuation">.</span><span class="token function">getUDPPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ›´æ–°æœåŠ¡ä¿¡æ¯</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">processServiceJSON</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>oldService <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// è·å–é”</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>oldService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å”¤é†’ç­‰å¾…çš„çº¿ç¨‹</span>
                    oldService<span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>HostReactor#scheduleUpdateIfAbsent</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">scheduleUpdateIfAbsent</span><span class="token punctuation">(</span>String serviceName<span class="token punctuation">,</span> String clusters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// å·²ç»å­˜åœ¨æ›´æ–°ä»»åŠ¡äº†</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>futureMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ServiceInfo<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> clusters<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// åŠ é”</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>futureMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// åŒé‡æ£€æŸ¥åŠ é”</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>futureMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ServiceInfo<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> clusters<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// æäº¤ä»»åŠ¡</span>
            ScheduledFuture<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> future <span class="token operator">=</span> <span class="token function">addTask</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UpdateTask</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> clusters<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            futureMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>ServiceInfo<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> clusters<span class="token punctuation">)</span><span class="token punctuation">,</span> future<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>Clienté™¤äº†ä¸»åŠ¨é€šè¿‡HTTPçš„APIå‘Serveré€šè®¯ï¼Œä¹Ÿå¯ä»¥é€šè¿‡UDPç«¯å£æ¥æ”¶Serverçš„ä¸»åŠ¨é€šçŸ¥ã€‚</p>
<p>å¦‚æœä½ è®¢é˜…äº†ç›¸å…³çš„æœåŠ¡çš„äº‹ä»¶ï¼Œå¹¶æ³¨å†Œäº†å›è°ƒçš„è¯ã€‚</p>
<p>PushReceiver#run</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// byte[] is initialized with 0 full filled by default</span>
                <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span>UDP_MSS<span class="token punctuation">]</span><span class="token punctuation">;</span>
                DatagramPacket packet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DatagramPacket</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> buffer<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
                udpSocket<span class="token punctuation">.</span><span class="token function">receive</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
                String json <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>IoUtils<span class="token punctuation">.</span><span class="token function">tryDecompress</span><span class="token punctuation">(</span>packet<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                PushPacket pushPacket <span class="token operator">=</span> JacksonUtils<span class="token punctuation">.</span><span class="token function">toObj</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> PushPacket<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                String ack<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"dom"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>pushPacket<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">"service"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>pushPacket<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å¤„ç†</span>
                    hostReactor<span class="token punctuation">.</span><span class="token function">processServiceJSON</span><span class="token punctuation">(</span>pushPacket<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"dump"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>pushPacket<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// åº”ç­”</span>
                udpSocket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DatagramPacket</span><span class="token punctuation">(</span>ack<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span>Charset<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    ack<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span>Charset<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">,</span> packet<span class="token punctuation">.</span><span class="token function">getSocketAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>HostReactor#processServiceJSON</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> ServiceInfo <span class="token function">processServiceJSON</span><span class="token punctuation">(</span>String json<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ServiceInfo serviceInfo <span class="token operator">=</span> JacksonUtils<span class="token punctuation">.</span><span class="token function">toObj</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> ServiceInfo<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ServiceInfo oldService <span class="token operator">=</span> serviceInfoMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>serviceInfo<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">boolean</span> changed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldService <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
            serviceInfoMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>serviceInfo<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> serviceInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

            Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Instance<span class="token operator">></span> oldHostMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Instance<span class="token operator">></span><span class="token punctuation">(</span>oldService<span class="token punctuation">.</span><span class="token function">getHosts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>Instance host <span class="token operator">:</span> oldService<span class="token punctuation">.</span><span class="token function">getHosts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>

            Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Instance<span class="token operator">></span> newHostMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Instance<span class="token operator">></span><span class="token punctuation">(</span>serviceInfo<span class="token punctuation">.</span><span class="token function">getHosts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>Instance host <span class="token operator">:</span> serviceInfo<span class="token punctuation">.</span><span class="token function">getHosts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>

            Set<span class="token operator">&lt;</span>Instance<span class="token operator">></span> modHosts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token operator">&lt;</span>Instance<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Set<span class="token operator">&lt;</span>Instance<span class="token operator">></span> newHosts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token operator">&lt;</span>Instance<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Set<span class="token operator">&lt;</span>Instance<span class="token operator">></span> remvHosts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token operator">&lt;</span>Instance<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            List<span class="token operator">&lt;</span>Map<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Instance<span class="token operator">>></span> newServiceHosts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>Map<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Instance<span class="token operator">>></span><span class="token punctuation">(</span>newHostMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>Map<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Instance<span class="token operator">></span> entry <span class="token operator">:</span> newServiceHosts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span>Map<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Instance<span class="token operator">></span> entry <span class="token operator">:</span> oldHostMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>newHosts<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>remvHosts<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>modHosts<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>newHosts<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">||</span> remvHosts<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">||</span> modHosts<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                eventDispatcher<span class="token punctuation">.</span><span class="token function">serviceChanged</span><span class="token punctuation">(</span>serviceInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
                DiskCache<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>serviceInfo<span class="token punctuation">,</span> cacheDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            changed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            serviceInfoMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>serviceInfo<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> serviceInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            eventDispatcher<span class="token punctuation">.</span><span class="token function">serviceChanged</span><span class="token punctuation">(</span>serviceInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            serviceInfo<span class="token punctuation">.</span><span class="token function">setJsonFromServer</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>
            DiskCache<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>serviceInfo<span class="token punctuation">,</span> cacheDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> serviceInfo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


        <footer>
             
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

        </footer>
    </div>
    <!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
    <script>
        var timeEnd = new Date();
        console.log('è€—æ—¶ï¼š' + (timeEnd - timeStart));
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre').forEach((block) => {
                block.classList.add("line-numbers");
            });
        });
    </script>
    <!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
    <!-- material design -->
    <!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
    <!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
    <!-- toc -->
    <!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
    <!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
    <!-- <script src="/js/main.js"></script> -->
    <script src="/js/prism.js"></script>
</body>
</html>
