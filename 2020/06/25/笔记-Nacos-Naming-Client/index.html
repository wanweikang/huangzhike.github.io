<!DOCTYPE HTML>
<html>

<head>
    <script>
        var timeStart = new Date();
    </script>
    <meta charset="utf-8">
    
    <title>[笔记]-Nacos-Naming-Client | 草木禾</title>
    
    <meta name="author" content="huangzhike">
    
    
    <meta name="description"
        content="NacosNamingService#init
    private void init(Properties properties) throws NacosException {
        ValidatorUtils.checkInitParam(properties);
      ">
    
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta property="og:title" content="[笔记]-Nacos-Naming-Client" />
    
    <meta property="og:site_name" content="草木禾" />
    
    
    <!-- favicon -->
    <link rel="icon" type="image/ico" href="/logo.ico" sizes="32x32">
    <meta name="msapplication-TileColor" content="#009688">
    <meta name="msapplication-TileImage" content="/mstile-144x144.ico">
    <meta name="theme-color" content="#009688">
    <!-- favicon end -->
    <!-- <link href="//ok.ico" rel="icon"> -->
    

    <!-- <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.5.0/css/bootstrap.min.css" rel="stylesheet"> -->
    <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
    <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
    <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">

<meta name="generator" content="Hexo 4.2.1"></head>
<body>
    <nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">菜单</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" title="早く来い、クラウド" href="/">Reunion...</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" target="_blank" rel="noopener" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

    <div class="container" >
        <div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[笔记]-Nacos-Naming-Client</h2>
				
				<div>
					<div class="post-time">2020-06-25</div>
				</div>
				
				<div class="article-content">
				<p>NacosNamingService#init</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span>Properties properties<span class="token punctuation">)</span> <span class="token keyword">throws</span> NacosException <span class="token punctuation">{</span>
        ValidatorUtils<span class="token punctuation">.</span><span class="token function">checkInitParam</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 初始化命名空间，用于多租户隔离，默认public</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>namespace <span class="token operator">=</span> InitUtils<span class="token punctuation">.</span><span class="token function">initNamespaceForNaming</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
        InitUtils<span class="token punctuation">.</span><span class="token function">initSerialization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 初始化Server列表</span>
        <span class="token function">initServerAddr</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
        InitUtils<span class="token punctuation">.</span><span class="token function">initWebRootContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 初始化本地持久化缓存目录</span>
        <span class="token function">initCacheDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">initLogName</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 事件分发器，在一个线程循环内从阻塞队列取出事件，并执行订阅的回调</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>eventDispatcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventDispatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 与Server通信的代理对象</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>serverProxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NamingProxy</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>namespace<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>endpoint<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>serverList<span class="token punctuation">,</span> properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 初始化心跳线程池，个人感觉这个Reactor命名有点不知所云</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>beatReactor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BeatReactor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>serverProxy<span class="token punctuation">,</span> <span class="token function">initClientBeatThreadCount</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 初始化与Server交互的对象</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>hostReactor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HostReactor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>eventDispatcher<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>serverProxy<span class="token punctuation">,</span> beatReactor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cacheDir<span class="token punctuation">,</span>
            <span class="token function">isLoadCacheAtStart</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">initPollingThreadCount</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>NacosNamingService#initServerAddr</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initServerAddr</span><span class="token punctuation">(</span>Properties properties<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        serverList <span class="token operator">=</span> properties<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span>PropertyKeyConst<span class="token punctuation">.</span>SERVER_ADDR<span class="token punctuation">)</span><span class="token punctuation">;</span>
        endpoint <span class="token operator">=</span> InitUtils<span class="token punctuation">.</span><span class="token function">initEndpoint</span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 如果配置了Endpoint那就从Endpoint更新Server地址</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>endpoint<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            serverList <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>NamingProxy#initRefreshTask</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initRefreshTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>executorService <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment" spellcheck="true">// 如果配置了Endpoint就定期从地址服务器更新ServerList</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>executorService<span class="token punctuation">.</span><span class="token function">scheduleWithFixedDelay</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">refreshSrvIfNeed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> vipSrvRefInterMillis<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 定期登录Server，如果配置了用户名和密码</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>executorService<span class="token punctuation">.</span><span class="token function">scheduleWithFixedDelay</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                securityProxy<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token function">getServerList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> securityInfoRefreshIntervalMills<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">refreshSrvIfNeed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>securityProxy<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token function">getServerList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>NamingProxy#refreshSrvIfNeed</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">refreshSrvIfNeed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 配置了Server列表就使用配置的</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>CollectionUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>serverList<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> lastSrvRefTime <span class="token operator">&lt;</span> vipSrvRefInterMillis<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 否则从Endpoint更新Server列表，AddressServer</span>
            List<span class="token operator">&lt;</span>String<span class="token operator">></span> list <span class="token operator">=</span> <span class="token function">getServerListFromEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ...</span>
            serversFromEndpoint <span class="token operator">=</span> list<span class="token punctuation">;</span>
            lastSrvRefTime <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>Nacos的AddressServer是把ServerList也当成服务来处理的，所以地址服务器模块依赖Naming模块。</p>
<hr>
<p>NacosNamingService#registerInstance</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerInstance</span><span class="token punctuation">(</span>String serviceName<span class="token punctuation">,</span> String groupName<span class="token punctuation">,</span> String ip<span class="token punctuation">,</span> <span class="token keyword">int</span> port<span class="token punctuation">,</span> String clusterName<span class="token punctuation">)</span> <span class="token keyword">throws</span> NacosException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 服务实例</span>
        <span class="token comment" spellcheck="true">// 默认分组为DEFAULT_GROUP，默认集群为DEFAULT</span>
        Instance instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        instance<span class="token punctuation">.</span><span class="token function">setIp</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
        instance<span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
        instance<span class="token punctuation">.</span><span class="token function">setWeight</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        instance<span class="token punctuation">.</span><span class="token function">setClusterName</span><span class="token punctuation">(</span>clusterName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 注册实例</span>
        <span class="token function">registerInstance</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> groupName<span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>Instance</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Instance</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> String instanceId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> String ip<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> port<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">double</span> weight <span class="token operator">=</span> <span class="token number">1.0D</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> healthy <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> enabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/**
     * 默认是临时节点，需要心跳来维护存在
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> ephemeral <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> String clusterName<span class="token punctuation">;</span>
    <span class="token keyword">private</span> String serviceName<span class="token punctuation">;</span>
    <span class="token keyword">private</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> metadata <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>NacosNamingService#registerInstance</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerInstance</span><span class="token punctuation">(</span>String serviceName<span class="token punctuation">,</span> String groupName<span class="token punctuation">,</span> Instance instance<span class="token punctuation">)</span> <span class="token keyword">throws</span> NacosException <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token function">isEphemeral</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            BeatInfo beatInfo <span class="token operator">=</span> beatReactor<span class="token punctuation">.</span><span class="token function">buildBeatInfo</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 创建心跳任务</span>
            beatReactor<span class="token punctuation">.</span><span class="token function">addBeatInfo</span><span class="token punctuation">(</span>NamingUtils<span class="token punctuation">.</span><span class="token function">getGroupedName</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> groupName<span class="token punctuation">)</span><span class="token punctuation">,</span> beatInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 注册到Server</span>
        serverProxy<span class="token punctuation">.</span><span class="token function">registerService</span><span class="token punctuation">(</span>NamingUtils<span class="token punctuation">.</span><span class="token function">getGroupedName</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> groupName<span class="token punctuation">)</span><span class="token punctuation">,</span> groupName<span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>BeatReactor$BeatTask#run</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">long</span> nextTime <span class="token operator">=</span> beatInfo<span class="token punctuation">.</span><span class="token function">getPeriod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 发送心跳给Server，HTTP协议</span>
                JsonNode result <span class="token operator">=</span> serverProxy<span class="token punctuation">.</span><span class="token function">sendBeat</span><span class="token punctuation">(</span>beatInfo<span class="token punctuation">,</span> BeatReactor<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>lightBeatEnabled<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 根据Server的返回值调整心跳间隔</span>
                <span class="token keyword">long</span> interval <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"clientBeatInterval"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">boolean</span> lightBeatEnabled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 根据Server的返回值调整是否使用轻量级心跳</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>CommonParams<span class="token punctuation">.</span>LIGHT_BEAT_ENABLED<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    lightBeatEnabled <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>CommonParams<span class="token punctuation">.</span>LIGHT_BEAT_ENABLED<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asBoolean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                BeatReactor<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>lightBeatEnabled <span class="token operator">=</span> lightBeatEnabled<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>interval <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    nextTime <span class="token operator">=</span> interval<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">int</span> code <span class="token operator">=</span> NamingResponseCode<span class="token punctuation">.</span>OK<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ...</span>
                <span class="token comment" spellcheck="true">// Server没有对应的服务实例</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">==</span> NamingResponseCode<span class="token punctuation">.</span>RESOURCE_NOT_FOUND<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    Instance instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 重新注册</span>
                        serverProxy<span class="token punctuation">.</span><span class="token function">registerService</span><span class="token punctuation">(</span>beatInfo<span class="token punctuation">.</span><span class="token function">getServiceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> NamingUtils<span class="token punctuation">.</span><span class="token function">getGroupName</span><span class="token punctuation">(</span>beatInfo<span class="token punctuation">.</span><span class="token function">getServiceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ignore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NacosException</span> ne<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 下次心跳</span>
            executorService<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BeatTask</span><span class="token punctuation">(</span>beatInfo<span class="token punctuation">)</span><span class="token punctuation">,</span> nextTime<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>NamingProxy#reqAPI</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> String <span class="token function">reqAPI</span><span class="token punctuation">(</span>String api<span class="token punctuation">,</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> params<span class="token punctuation">,</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> body<span class="token punctuation">,</span> List<span class="token operator">&lt;</span>String<span class="token operator">></span> servers<span class="token punctuation">,</span> String method<span class="token punctuation">)</span> <span class="token keyword">throws</span> NacosException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>servers <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>servers<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Random random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> index <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>servers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 随机轮询一个Server发送成功就直接返回，不管是心跳还是服务注册，交给Server同步就好</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> servers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                String server <span class="token operator">=</span> servers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// HTTP请求</span>
                    <span class="token keyword">return</span> <span class="token function">callServer</span><span class="token punctuation">(</span>api<span class="token punctuation">,</span> params<span class="token punctuation">,</span> body<span class="token punctuation">,</span> server<span class="token punctuation">,</span> method<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NacosException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                index <span class="token operator">=</span> <span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> servers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 如果手动配置的ServerList只有一个Server</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>nacosDomain<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 失败重试次数</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> UtilAndComs<span class="token punctuation">.</span>REQUEST_DOMAIN_RETRY_COUNT<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token function">callServer</span><span class="token punctuation">(</span>api<span class="token punctuation">,</span> params<span class="token punctuation">,</span> body<span class="token punctuation">,</span> nacosDomain<span class="token punctuation">,</span> method<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NacosException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ...</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>NacosNamingService#getAllInstances</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> List<span class="token operator">&lt;</span>Instance<span class="token operator">></span> <span class="token function">getAllInstances</span><span class="token punctuation">(</span>String serviceName<span class="token punctuation">,</span> String groupName<span class="token punctuation">,</span> List<span class="token operator">&lt;</span>String<span class="token operator">></span> clusters<span class="token punctuation">,</span> <span class="token keyword">boolean</span> subscribe<span class="token punctuation">)</span> <span class="token keyword">throws</span> NacosException <span class="token punctuation">{</span>
        ServiceInfo serviceInfo<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 默认是自动订阅的</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>subscribe<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 获取服务的信息</span>
            serviceInfo <span class="token operator">=</span> hostReactor<span class="token punctuation">.</span><span class="token function">getServiceInfo</span><span class="token punctuation">(</span>NamingUtils<span class="token punctuation">.</span><span class="token function">getGroupedName</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> groupName<span class="token punctuation">)</span><span class="token punctuation">,</span> StringUtils<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>clusters<span class="token punctuation">,</span> <span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            serviceInfo <span class="token operator">=</span> hostReactor<span class="token punctuation">.</span><span class="token function">getServiceInfoDirectlyFromServer</span><span class="token punctuation">(</span>NamingUtils<span class="token punctuation">.</span><span class="token function">getGroupedName</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> groupName<span class="token punctuation">)</span><span class="token punctuation">,</span> StringUtils<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>clusters<span class="token punctuation">,</span> <span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        List<span class="token operator">&lt;</span>Instance<span class="token operator">></span> list<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>serviceInfo <span class="token operator">==</span> null <span class="token operator">||</span> CollectionUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>list <span class="token operator">=</span> serviceInfo<span class="token punctuation">.</span><span class="token function">getHosts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>Instance<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 返回服务下的实例</span>
        <span class="token keyword">return</span> list<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>HostReactor#getServiceInfo</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> ServiceInfo <span class="token function">getServiceInfo</span><span class="token punctuation">(</span><span class="token keyword">final</span> String serviceName<span class="token punctuation">,</span> <span class="token keyword">final</span> String clusters<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        String key <span class="token operator">=</span> ServiceInfo<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> clusters<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 如果本地的FAILOVER_SWITCH文件存在的并且被标记为打开，那么就从本地持久化的缓存中获取服务信息返回</span>
        <span class="token comment" spellcheck="true">// 不过我怎么也没找到这个文件是怎么创建的</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>failoverReactor<span class="token punctuation">.</span><span class="token function">isFailoverSwitch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// FailoverReactor会定时持久化服务信息到磁盘，用于客户端容灾</span>
            <span class="token keyword">return</span> failoverReactor<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 先从本地内存的Map获取服务的信息</span>
        ServiceInfo serviceObj <span class="token operator">=</span> <span class="token function">getServiceInfo0</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> clusters<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 本地缓存没有</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">==</span> serviceObj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            serviceObj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceInfo</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> clusters<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 创建一个并加入</span>
            serviceInfoMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>serviceObj<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> serviceObj<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 标记该服务信息正在更新</span>
            updatingMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 从Server获取该服务的信息</span>
            <span class="token function">updateServiceNow</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> clusters<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// Timeline 1</span>
            <span class="token comment" spellcheck="true">// 更新完把更新标记移除</span>
            updatingMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Timeline 2</span>
        <span class="token comment" spellcheck="true">// 服务信息正在更新</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>updatingMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>UPDATE_HOLD_INTERVAL <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 先阻塞获取锁</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>serviceObj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 释放锁，阻塞等待至5s超时或者更新完后被唤醒</span>
                        serviceObj<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>UPDATE_HOLD_INTERVAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 自动订阅，即自动从Server更新服务信息</span>
        <span class="token function">scheduleUpdateIfAbsent</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> clusters<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 返回服务信息</span>
        <span class="token keyword">return</span> serviceInfoMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>serviceObj<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>上面这段代码其实是有点小问题的，之前我也提了一个Issue，就是在并发的情况下，线程A执行完updateServiceNow，但是还没来得及将更新标记移除（Timeline 1），此时有多个线程进入下面的条件判断（Timeline 2），那么这些线程是收不到更新的唤醒的，只能全部等待5s，但实际上此时服务信息是已经更新完了的，没必要等待。</p>
<p>我想到的一个方法是使用类似双重检查锁和String#intern的方法，但是貌似没有必要？</p>
<p>Nacos的服务发现是AP的，因为客户端有缓存，并且服务端虽然说使用了Raft同步，但实际上并不严格。</p>
<p>当然配置中心部分是严格的Raft协议。</p>
<p>HostReactor#updateServiceNow</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateServiceNow</span><span class="token punctuation">(</span>String serviceName<span class="token punctuation">,</span> String clusters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 从内存缓存获取服务信息</span>
        ServiceInfo oldService <span class="token operator">=</span> <span class="token function">getServiceInfo0</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> clusters<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 从服务器获取服务信息</span>
            String result <span class="token operator">=</span> serverProxy<span class="token punctuation">.</span><span class="token function">queryList</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> clusters<span class="token punctuation">,</span> pushReceiver<span class="token punctuation">.</span><span class="token function">getUDPPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 更新服务信息</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">processServiceJSON</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>oldService <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 获取锁</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>oldService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 唤醒等待的线程</span>
                    oldService<span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>HostReactor#scheduleUpdateIfAbsent</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">scheduleUpdateIfAbsent</span><span class="token punctuation">(</span>String serviceName<span class="token punctuation">,</span> String clusters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 已经存在更新任务了</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>futureMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ServiceInfo<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> clusters<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 加锁</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>futureMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 双重检查加锁</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>futureMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ServiceInfo<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> clusters<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 提交任务</span>
            ScheduledFuture<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> future <span class="token operator">=</span> <span class="token function">addTask</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UpdateTask</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> clusters<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            futureMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>ServiceInfo<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> clusters<span class="token punctuation">)</span><span class="token punctuation">,</span> future<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>Client除了主动通过HTTP的API向Server通讯，也可以通过UDP端口接收Server的主动通知。</p>
<p>如果你订阅了相关的服务的事件，并注册了回调的话。</p>
<p>PushReceiver#run</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// byte[] is initialized with 0 full filled by default</span>
                <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span>UDP_MSS<span class="token punctuation">]</span><span class="token punctuation">;</span>
                DatagramPacket packet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DatagramPacket</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> buffer<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
                udpSocket<span class="token punctuation">.</span><span class="token function">receive</span><span class="token punctuation">(</span>packet<span class="token punctuation">)</span><span class="token punctuation">;</span>
                String json <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>IoUtils<span class="token punctuation">.</span><span class="token function">tryDecompress</span><span class="token punctuation">(</span>packet<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                PushPacket pushPacket <span class="token operator">=</span> JacksonUtils<span class="token punctuation">.</span><span class="token function">toObj</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> PushPacket<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                String ack<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"dom"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>pushPacket<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">"service"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>pushPacket<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 处理</span>
                    hostReactor<span class="token punctuation">.</span><span class="token function">processServiceJSON</span><span class="token punctuation">(</span>pushPacket<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"dump"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>pushPacket<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 应答</span>
                udpSocket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DatagramPacket</span><span class="token punctuation">(</span>ack<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span>Charset<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    ack<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span>Charset<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">,</span> packet<span class="token punctuation">.</span><span class="token function">getSocketAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>HostReactor#processServiceJSON</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> ServiceInfo <span class="token function">processServiceJSON</span><span class="token punctuation">(</span>String json<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ServiceInfo serviceInfo <span class="token operator">=</span> JacksonUtils<span class="token punctuation">.</span><span class="token function">toObj</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> ServiceInfo<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ServiceInfo oldService <span class="token operator">=</span> serviceInfoMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>serviceInfo<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">boolean</span> changed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldService <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
            serviceInfoMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>serviceInfo<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> serviceInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

            Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Instance<span class="token operator">></span> oldHostMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Instance<span class="token operator">></span><span class="token punctuation">(</span>oldService<span class="token punctuation">.</span><span class="token function">getHosts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>Instance host <span class="token operator">:</span> oldService<span class="token punctuation">.</span><span class="token function">getHosts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>

            Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Instance<span class="token operator">></span> newHostMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Instance<span class="token operator">></span><span class="token punctuation">(</span>serviceInfo<span class="token punctuation">.</span><span class="token function">getHosts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>Instance host <span class="token operator">:</span> serviceInfo<span class="token punctuation">.</span><span class="token function">getHosts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>

            Set<span class="token operator">&lt;</span>Instance<span class="token operator">></span> modHosts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token operator">&lt;</span>Instance<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Set<span class="token operator">&lt;</span>Instance<span class="token operator">></span> newHosts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token operator">&lt;</span>Instance<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Set<span class="token operator">&lt;</span>Instance<span class="token operator">></span> remvHosts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token operator">&lt;</span>Instance<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            List<span class="token operator">&lt;</span>Map<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Instance<span class="token operator">>></span> newServiceHosts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>Map<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Instance<span class="token operator">>></span><span class="token punctuation">(</span>newHostMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>Map<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Instance<span class="token operator">></span> entry <span class="token operator">:</span> newServiceHosts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span>Map<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Instance<span class="token operator">></span> entry <span class="token operator">:</span> oldHostMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>newHosts<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>remvHosts<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>modHosts<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>newHosts<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">||</span> remvHosts<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">||</span> modHosts<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                eventDispatcher<span class="token punctuation">.</span><span class="token function">serviceChanged</span><span class="token punctuation">(</span>serviceInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
                DiskCache<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>serviceInfo<span class="token punctuation">,</span> cacheDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            changed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            serviceInfoMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>serviceInfo<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> serviceInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            eventDispatcher<span class="token punctuation">.</span><span class="token function">serviceChanged</span><span class="token punctuation">(</span>serviceInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            serviceInfo<span class="token punctuation">.</span><span class="token function">setJsonFromServer</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>
            DiskCache<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>serviceInfo<span class="token punctuation">,</span> cacheDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> serviceInfo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


        <footer>
             
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

        </footer>
    </div>
    <!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
    <script>
        var timeEnd = new Date();
        console.log('耗时：' + (timeEnd - timeStart));
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre').forEach((block) => {
                block.classList.add("line-numbers");
            });
        });
    </script>

    <script src="/js/prism.js"></script>
</body>
</html>
