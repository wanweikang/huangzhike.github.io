<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
        <script>
            var timeStart = new Date();
        </script>
        
        <title>[ç¬”è®°]-Nacos-Config-Server | ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜</title>
        
        <meta name="author" content="huangzhike">
        
        
        <meta name="description" content="Configæ¨¡å—æŒºå¤šä¸­æ–‡æ³¨é‡Šçš„ï¼Œæˆ‘å€’æ˜¯å¾ˆæ¬¢è¿å•¦ã€‚
ä½†æ˜¯ä½œè€…è‚¯å®šæ²¡æ‰“å¼€P3Cä»£ç è§„èŒƒæ£€æŸ¥æ’ä»¶ã€‚
è¿™æ¢è¡Œï¼Œè¡€å‹é£™å‡ï¼Œå¤ªä¸‘äº†ã€‚
åˆTabåˆç©ºæ ¼ï¼Œæˆ‘ã€‚ã€‚ã€‚
æŠŠå¤´ä¼¸è¿‡æ¥ï¼Œæˆ‘ç»™ä½ åŠ ä¸ªBuffã€‚

NacosConfigConfiguration#transferToLeader
    @Conditional">
        
        
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        
        <meta property="og:title" content="[ç¬”è®°]-Nacos-Config-Server"/>
        
        <meta property="og:site_name" content="ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜"/>
        
        
        <!-- favicon -->
        <link rel="icon" type="image/ico" href="/ok.ico" sizes="32x32">
        <meta name="msapplication-TileColor" content="#009688">
        <meta name="msapplication-TileImage" content="/mstile-144x144.ico">
        <meta name="theme-color" content="#009688">
        <!-- favicon end -->
        <!-- <link href="//ok.ico" rel="icon"> -->
        
        <!-- toc -->
        <!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
        <!-- material design -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
        <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
        
        <!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
        <!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
    <meta name="generator" content="Hexo 4.2.1"></head>

<body>
    <nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">èœå•</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" title="ä¸‹ä¸€å¥æ˜¯ï¼šå®¢æœ‰å¯äººæœŸä¸æ¥ã€‚å°æ—¶å€™ï¼Œå–œæ¬¢é åœ¨é˜³å°ä¸Šï¼Œä¸€è¾¹å¹é£ï¼Œä¸€è¾¹çœ‹ä¹¦ï¼Œå–œæ¬¢è¯»ä¹¦å—ï¼Œéªšå¹´ï¼Ÿ" href="/">ä¹¦å½“å¿«æ„è¯»æ˜“å°½</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" target="_blank" rel="noopener" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

    <div class="container" >
        <div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[ç¬”è®°]-Nacos-Config-Server</h2>
				
				<div>
					<div class="post-time">2020-06-25</div>
				</div>
				
				<div class="article-content">
				<p>Configæ¨¡å—æŒºå¤šä¸­æ–‡æ³¨é‡Šçš„ï¼Œæˆ‘å€’æ˜¯å¾ˆæ¬¢è¿å•¦ã€‚</p>
<p>ä½†æ˜¯ä½œè€…è‚¯å®šæ²¡æ‰“å¼€P3Cä»£ç è§„èŒƒæ£€æŸ¥æ’ä»¶ã€‚</p>
<p>è¿™æ¢è¡Œï¼Œè¡€å‹é£™å‡ï¼Œå¤ªä¸‘äº†ã€‚</p>
<p>åˆTabåˆç©ºæ ¼ï¼Œæˆ‘ã€‚ã€‚ã€‚</p>
<p>æŠŠå¤´ä¼¸è¿‡æ¥ï¼Œæˆ‘ç»™ä½ åŠ ä¸ªBuffã€‚</p>
<hr>
<p>NacosConfigConfiguration#transferToLeader</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Conditional</span><span class="token punctuation">(</span>ConditionDistributedEmbedStorage<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token comment" spellcheck="true">// ï¼Ÿï¼Ÿï¼Ÿ</span>
    <span class="token keyword">public</span> CurcuitFilter <span class="token function">transferToLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CurcuitFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>CurcuitFilter#listenerSelfInCluster</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">listenerSelfInCluster</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        protocol<span class="token punctuation">.</span><span class="token function">protocolMetaData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>Constants<span class="token punctuation">.</span>CONFIG_MODEL_RAFT_GROUP<span class="token punctuation">,</span>
                MetadataKey<span class="token punctuation">.</span>RAFT_GROUP_MEMBER<span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">Observer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span>Observable o<span class="token punctuation">,</span> Object arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">final</span> List<span class="token operator">&lt;</span>String<span class="token operator">></span> peers <span class="token operator">=</span> <span class="token punctuation">(</span>List<span class="token operator">&lt;</span>String<span class="token operator">></span><span class="token punctuation">)</span> arg<span class="token punctuation">;</span>
                        <span class="token keyword">final</span> Member self <span class="token operator">=</span> memberManager<span class="token punctuation">.</span><span class="token function">getSelf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">final</span> String raftAddress <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token function">getIp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> self<span class="token punctuation">.</span><span class="token function">getExtendVal</span><span class="token punctuation">(</span>MemberMetaDataConstants<span class="token punctuation">.</span>RAFT_PORT<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// Only when you are in the cluster and the current Leader is</span>
                        <span class="token comment" spellcheck="true">// elected can you provide external services</span>
                        isOpenService <span class="token operator">=</span> peers<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>raftAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<blockquote>
<p>If the embedded distributed storage is enabled, all requests are routed to the Leader node for processing, and the maximum number of forwards for a single request cannot exceed three</p>
</blockquote>
<p>å½“ä½¿ç”¨å†…åµŒçš„åˆ†å¸ƒå¼å­˜å‚¨æ—¶ï¼Œåªæœ‰Leaderæ‰èƒ½å¤„ç†è¯·æ±‚ï¼Œè¯·æ±‚éƒ½ä¼šè¢«è½¬å‘åˆ°Leaderï¼ŒCurcuitFilterçš„æ³¨é‡Šæ˜¯è¿™ä¹ˆè¯´çš„ï¼Œç†è®ºä¸Šä¹Ÿåº”è¯¥æ˜¯è¿™æ ·ã€‚</p>
<p>ä½†æ˜¯CurcuitFilterçš„ä»£ç ä¸­å®Œå…¨æ²¡æœ‰ä½“ç°è¿™ä¸€ç‚¹ï¼Œåªè¦å½“å‰Serveråœ¨é›†ç¾¤ä¸­å°±æ”¾è¡Œï¼Œå®é™…çš„è½¬å‘æ“ä½œéƒ½ä¸‹æ²‰åˆ°DistributedDatabaseOperateImplä¸Šäº†ã€‚</p>
<hr>
<p>ConfigController#publishConfig</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@PostMapping</span>
    <span class="token annotation punctuation">@Secured</span><span class="token punctuation">(</span>action <span class="token operator">=</span> ActionTypes<span class="token punctuation">.</span>WRITE<span class="token punctuation">,</span> parser <span class="token operator">=</span> ConfigResourceParser<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> Boolean <span class="token function">publishConfig</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">,</span> HttpServletResponse response<span class="token punctuation">,</span>
                                 <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"dataId"</span><span class="token punctuation">)</span> String dataId<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"group"</span><span class="token punctuation">)</span> String group<span class="token punctuation">,</span>
                                 <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"tenant"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> defaultValue <span class="token operator">=</span> StringUtils<span class="token punctuation">.</span>EMPTY<span class="token punctuation">)</span> String tenant<span class="token punctuation">,</span>
                                 <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"content"</span><span class="token punctuation">)</span> String content<span class="token punctuation">,</span>
                                 <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"tag"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> String tag<span class="token punctuation">,</span>
                                 <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"appName"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> String appName<span class="token punctuation">,</span>
                                 <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"src_user"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> String srcUser<span class="token punctuation">,</span>
                                 <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"config_tags"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> String configTags<span class="token punctuation">,</span>
                                 <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"desc"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> String desc<span class="token punctuation">,</span>
                                 <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"use"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> String use<span class="token punctuation">,</span>
                                 <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"effect"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> String effect<span class="token punctuation">,</span>
                                 <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"type"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> String type<span class="token punctuation">,</span>
                                 <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"schema"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> String schema<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> NacosException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>betaIps<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                persistService<span class="token punctuation">.</span><span class="token function">insertOrUpdate</span><span class="token punctuation">(</span>srcIp<span class="token punctuation">,</span> srcUser<span class="token punctuation">,</span> configInfo<span class="token punctuation">,</span> time<span class="token punctuation">,</span> configAdvanceInfo<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                ConfigChangePublisher<span class="token punctuation">.</span><span class="token function">notifyConfigChange</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ConfigDataChangeEvent</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> dataId<span class="token punctuation">,</span> group<span class="token punctuation">,</span> tenant<span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ä½¿ç”¨å¤–ç½®çš„æŒä¹…åŒ–å°±ä¸éœ€è¦Raftåè®®ç»´æŠ¤ä¸€è‡´æ€§äº†ï¼Œå¤„ç†ä¼šç®€å•å¾ˆå¤šã€‚</p>
<p>ExternalStoragePersistServiceImpl#insertOrUpdate</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">insertOrUpdate</span><span class="token punctuation">(</span>String srcIp<span class="token punctuation">,</span> String srcUser<span class="token punctuation">,</span>
                               ConfigInfo configInfo<span class="token punctuation">,</span> Timestamp time<span class="token punctuation">,</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span> configAdvanceInfo<span class="token punctuation">,</span>
                               <span class="token keyword">boolean</span> notify<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// äº‹åŠ¡ç›¸å…³çš„å¤„ç†äº¤ç»™äº†AOP</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å…ˆå°è¯•æ’å…¥</span>
            <span class="token function">addConfigInfo</span><span class="token punctuation">(</span>srcIp<span class="token punctuation">,</span> srcUser<span class="token punctuation">,</span> configInfo<span class="token punctuation">,</span> time<span class="token punctuation">,</span> configAdvanceInfo<span class="token punctuation">,</span> notify<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">DataIntegrityViolationException</span> ive<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// å”¯ä¸€æ€§çº¦æŸå†²çª</span>
            <span class="token comment" spellcheck="true">// æ’å…¥å¤±è´¥é‚£å°±æ˜¯æ›´æ–°äº†</span>
            <span class="token function">updateConfigInfo</span><span class="token punctuation">(</span>configInfo<span class="token punctuation">,</span> srcIp<span class="token punctuation">,</span> srcUser<span class="token punctuation">,</span> time<span class="token punctuation">,</span> configAdvanceInfo<span class="token punctuation">,</span> notify<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>CapacityManagementAspect#aroundSyncUpdateConfigAll</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Around</span><span class="token punctuation">(</span>SYNC_UPDATE_CONFIG_ALL<span class="token punctuation">)</span>
    <span class="token keyword">public</span> Object <span class="token function">aroundSyncUpdateConfigAll</span><span class="token punctuation">(</span>ProceedingJoinPoint pjp<span class="token punctuation">,</span> HttpServletRequest request<span class="token punctuation">,</span>
                                            HttpServletResponse response<span class="token punctuation">,</span> String dataId<span class="token punctuation">,</span> String group<span class="token punctuation">,</span> String content<span class="token punctuation">,</span>
                                            String appName<span class="token punctuation">,</span> String srcUser<span class="token punctuation">,</span> String tenant<span class="token punctuation">,</span> String tag<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> Throwable <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// å¦‚æœæ²¡å¼€å§‹å®¹é‡ç®¡ç†å°±ç›´æ¥æ”¾è¡Œ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>PropertyUtil<span class="token punctuation">.</span><span class="token function">isManageCapacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> pjp<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        String betaIps <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"betaIps"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>betaIps<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// åªå¯¹å†™å…¥æˆ–æ›´æ–°config_infoè¡¨çš„åšå®¹é‡ç®¡ç†çš„é™åˆ¶æ£€éªŒ</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>persistService<span class="token punctuation">.</span><span class="token function">findConfigInfo</span><span class="token punctuation">(</span>dataId<span class="token punctuation">,</span> group<span class="token punctuation">,</span> tenant<span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å†™å…¥æ“ä½œ</span>
                    <span class="token keyword">return</span> <span class="token function">do4Insert</span><span class="token punctuation">(</span>pjp<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> group<span class="token punctuation">,</span> tenant<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// æ›´æ–°æ“ä½œ</span>
                <span class="token keyword">return</span> <span class="token function">do4Update</span><span class="token punctuation">(</span>pjp<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> dataId<span class="token punctuation">,</span> group<span class="token punctuation">,</span> tenant<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> pjp<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>CapacityManagementAspect#do4Insert</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> Object <span class="token function">do4Insert</span><span class="token punctuation">(</span>ProceedingJoinPoint pjp<span class="token punctuation">,</span> HttpServletRequest request<span class="token punctuation">,</span>
                             HttpServletResponse response<span class="token punctuation">,</span> String group<span class="token punctuation">,</span> String tenant<span class="token punctuation">,</span> String content<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> Throwable <span class="token punctuation">{</span>
        CounterMode counterMode <span class="token operator">=</span> CounterMode<span class="token punctuation">.</span>INCREMENT<span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> hasTenant <span class="token operator">=</span> <span class="token function">hasTenant</span><span class="token punctuation">(</span>tenant<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>PropertyUtil<span class="token punctuation">.</span><span class="token function">isCapacityLimitCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å…ˆå†™å…¥æˆ–æ›´æ–°ï¼šusage + 1</span>
            LimitType limitType <span class="token operator">=</span> <span class="token function">getLimitType</span><span class="token punctuation">(</span>counterMode<span class="token punctuation">,</span> group<span class="token punctuation">,</span> tenant<span class="token punctuation">,</span> content<span class="token punctuation">,</span> hasTenant<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>limitType <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token function">response4Limit</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> limitType<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å…ˆå†™å…¥æˆ–æ›´æ–°ï¼šusage + 1</span>
            <span class="token function">insertOrUpdateUsage</span><span class="token punctuation">(</span>group<span class="token punctuation">,</span> tenant<span class="token punctuation">,</span> counterMode<span class="token punctuation">,</span> hasTenant<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">getResult</span><span class="token punctuation">(</span>pjp<span class="token punctuation">,</span> response<span class="token punctuation">,</span> group<span class="token punctuation">,</span> tenant<span class="token punctuation">,</span> counterMode<span class="token punctuation">,</span> hasTenant<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>CapacityManagementAspect#getResult</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> Object <span class="token function">getResult</span><span class="token punctuation">(</span>ProceedingJoinPoint pjp<span class="token punctuation">,</span> HttpServletResponse response<span class="token punctuation">,</span> String group<span class="token punctuation">,</span> String tenant<span class="token punctuation">,</span>
                             CounterMode counterMode<span class="token punctuation">,</span> <span class="token keyword">boolean</span> hasTenant<span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ‰§è¡Œå®é™…æ“ä½œ</span>
            Object result <span class="token operator">=</span> pjp<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ ¹æ®æ‰§è¡Œç»“æœåˆ¤å®šæ˜¯å¦éœ€è¦å›æ»šï¼Œè¿™ä¸ªå›æ»šä¸ä¾èµ–æ•°æ®åº“äº‹åŠ¡ï¼Œè€Œæ˜¯æ‰‹åŠ¨çš„æ¶ˆé™¤ï¼ŒåŠ ä¸€çš„å›æ»šå°±æ˜¯å‡ä¸€</span>
            <span class="token function">doResult</span><span class="token punctuation">(</span>counterMode<span class="token punctuation">,</span> response<span class="token punctuation">,</span> group<span class="token punctuation">,</span> tenant<span class="token punctuation">,</span> result<span class="token punctuation">,</span> hasTenant<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">rollback</span><span class="token punctuation">(</span>counterMode<span class="token punctuation">,</span> group<span class="token punctuation">,</span> tenant<span class="token punctuation">,</span> hasTenant<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> throwable<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>æ›´æ–°å®Œåè§¦å‘ç›‘å¬å›è°ƒã€‚</p>
<p>AsyncNotifyService#onEvent</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onEvent</span><span class="token punctuation">(</span>Event event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// å¹¶å‘äº§ç”Ÿ ConfigDataChangeEvent</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token keyword">instanceof</span> <span class="token class-name">ConfigDataChangeEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ConfigDataChangeEvent evt <span class="token operator">=</span> <span class="token punctuation">(</span>ConfigDataChangeEvent<span class="token punctuation">)</span> event<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ...</span>
            Collection<span class="token operator">&lt;</span>Member<span class="token operator">></span> ipList <span class="token operator">=</span> memberManager<span class="token punctuation">.</span><span class="token function">allMembers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Queue<span class="token operator">&lt;</span>NotifySingleTask<span class="token operator">></span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token operator">&lt;</span>NotifySingleTask<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ¯ä¸ªServerèŠ‚ç‚¹éƒ½è¦é€šçŸ¥</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>Member member <span class="token operator">:</span> ipList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                queue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NotifySingleTask</span><span class="token punctuation">(</span>dataId<span class="token punctuation">,</span> group<span class="token punctuation">,</span> tenant<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> dumpTs<span class="token punctuation">,</span> member<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> evt<span class="token punctuation">.</span>isBeta<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// æäº¤ä»»åŠ¡</span>
            EXECUTOR<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AsyncTask</span><span class="token punctuation">(</span>httpclient<span class="token punctuation">,</span> queue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>AsyncNotifyService$AsyncTask#executeAsyncInvoke</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">executeAsyncInvoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>queue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                NotifySingleTask task <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                String targetIp <span class="token operator">=</span> task<span class="token punctuation">.</span><span class="token function">getTargetIP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>memberManager<span class="token punctuation">.</span><span class="token function">hasMember</span><span class="token punctuation">(</span>targetIp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å¯åŠ¨å¥åº·æ£€æŸ¥ä¸”æœ‰ä¸ç›‘æ§çš„ipåˆ™ç›´æ¥æŠŠæ”¾åˆ°é€šçŸ¥é˜Ÿåˆ—ï¼Œå¦åˆ™é€šçŸ¥</span>
                    <span class="token keyword">boolean</span> unHealthNeedDelay <span class="token operator">=</span> memberManager<span class="token punctuation">.</span><span class="token function">isUnHealth</span><span class="token punctuation">(</span>targetIp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>unHealthNeedDelay<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// target ip ä¸å¥åº·ï¼Œåˆ™æ”¾å…¥é€šçŸ¥åˆ—è¡¨ä¸­</span>
                        ConfigTraceService<span class="token punctuation">.</span><span class="token function">logNotifyEvent</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getDataId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> task<span class="token punctuation">.</span><span class="token function">getGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                        task<span class="token punctuation">.</span><span class="token function">getTenant</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> null<span class="token punctuation">,</span> task<span class="token punctuation">.</span><span class="token function">getLastModified</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                        InetUtils<span class="token punctuation">.</span><span class="token function">getSelfIp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                        ConfigTraceService<span class="token punctuation">.</span>NOTIFY_EVENT_UNHEALTH<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
                                        task<span class="token punctuation">.</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// get delay time and set fail count to the task</span>
                        <span class="token function">asyncTaskExecute</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        HttpGet request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpGet</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                        httpclient<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">AsyncNotifyCallBack</span><span class="token punctuation">(</span>httpclient<span class="token punctuation">,</span> task<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span></code></pre>
<p>CommunicationController#notifyConfigInfo</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/dataChange"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> Boolean <span class="token function">notifyConfigInfo</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">,</span>
                                    <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"dataId"</span><span class="token punctuation">)</span> String dataId<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"group"</span><span class="token punctuation">)</span> String group<span class="token punctuation">,</span>
                                    <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"tenant"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> defaultValue <span class="token operator">=</span> StringUtils<span class="token punctuation">.</span>EMPTY<span class="token punctuation">)</span> String tenant<span class="token punctuation">,</span>
                                    <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"tag"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> String tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>isBetaStr<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> trueStr<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>isBetaStr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            dumpService<span class="token punctuation">.</span><span class="token function">dump</span><span class="token punctuation">(</span>dataId<span class="token punctuation">,</span> group<span class="token punctuation">,</span> tenant<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> lastModifiedTs<span class="token punctuation">,</span> handleIp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>DumpProcessor#process</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">process</span><span class="token punctuation">(</span>String taskType<span class="token punctuation">,</span> AbstractTask task<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> PersistService persistService <span class="token operator">=</span> dumpService<span class="token punctuation">.</span><span class="token function">getPersistService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        DumpTask dumpTask <span class="token operator">=</span> <span class="token punctuation">(</span>DumpTask<span class="token punctuation">)</span> task<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        ConfigDumpEvent<span class="token punctuation">.</span>ConfigDumpEventBuilder build <span class="token operator">=</span> <span class="token comment" spellcheck="true">// ...</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>isBeta<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">//  å…ˆæŸ¥è¯¢</span>
                ConfigInfo cf <span class="token operator">=</span> persistService<span class="token punctuation">.</span><span class="token function">findConfigInfo</span><span class="token punctuation">(</span>dataId<span class="token punctuation">,</span> group<span class="token punctuation">,</span> tenant<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ...</span>
                <span class="token comment" spellcheck="true">// æ›´æ–°ç¼“å­˜</span>
                <span class="token keyword">return</span> DumpConfigHandler<span class="token punctuation">.</span><span class="token function">configDump</span><span class="token punctuation">(</span>build<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>DumpConfigHandler#configDump</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">configDump</span><span class="token punctuation">(</span>ConfigDumpEvent event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">isBeta</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">boolean</span> result<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>event<span class="token punctuation">.</span><span class="token function">isRemove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                result <span class="token operator">=</span> ConfigCacheService<span class="token punctuation">.</span><span class="token function">dump</span><span class="token punctuation">(</span>dataId<span class="token punctuation">,</span> group<span class="token punctuation">,</span> namespaceId<span class="token punctuation">,</span> content<span class="token punctuation">,</span> lastModified<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>ConfigCacheService#dump</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">static</span> <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">dump</span><span class="token punctuation">(</span>String dataId<span class="token punctuation">,</span> String group<span class="token punctuation">,</span> String tenant<span class="token punctuation">,</span> String content<span class="token punctuation">,</span> <span class="token keyword">long</span> lastModifiedTs<span class="token punctuation">,</span> String type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        String groupKey <span class="token operator">=</span> GroupKey2<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span>dataId<span class="token punctuation">,</span> group<span class="token punctuation">,</span> tenant<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å…ˆä¿è¯åˆ›å»ºç¼“å­˜</span>
        CacheItem ci <span class="token operator">=</span> <span class="token function">makeSure</span><span class="token punctuation">(</span>groupKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å…ˆè·å–è¯»é”</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> lockResult <span class="token operator">=</span> <span class="token function">tryWriteLock</span><span class="token punctuation">(</span>groupKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">assert</span> <span class="token punctuation">(</span>lockResult <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è·å–è¯»é”å¤±è´¥</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lockResult <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å…ˆè®¡ç®—MD5</span>
            <span class="token keyword">final</span> String md5 <span class="token operator">=</span> MD5Utils<span class="token punctuation">.</span><span class="token function">md5Hex</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> Constants<span class="token punctuation">.</span>ENCODE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ²¡å˜åŒ–ï¼Œå¿½ç•¥</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>md5<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>ConfigCacheService<span class="token punctuation">.</span><span class="token function">getContentMd5</span><span class="token punctuation">(</span>groupKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>PropertyUtil<span class="token punctuation">.</span><span class="token function">isDirectRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æœ¬åœ°æ–‡ä»¶æŒä¹…åŒ–ï¼Œè¿™æ˜¯ä¸ºäº†é™ä½è¯»å‹åŠ›</span>
                DiskUtil<span class="token punctuation">.</span><span class="token function">saveToDisk</span><span class="token punctuation">(</span>dataId<span class="token punctuation">,</span> group<span class="token punctuation">,</span> tenant<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// æ›´æ–°æœ¬åœ°ç¼“å­˜çš„MD5ï¼ŒåŒæ—¶è§¦å‘LocalDataChangeEvent</span>
            <span class="token function">updateMd5</span><span class="token punctuation">(</span>groupKey<span class="token punctuation">,</span> md5<span class="token punctuation">,</span> lastModifiedTs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ioe<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token function">releaseWriteLock</span><span class="token punctuation">(</span>groupKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>ConfigServletInner#doGetConfig</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> String <span class="token function">doGetConfig</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">,</span> HttpServletResponse response<span class="token punctuation">,</span> String dataId<span class="token punctuation">,</span> String group<span class="token punctuation">,</span>
                              String tenant<span class="token punctuation">,</span> String tag<span class="token punctuation">,</span> String clientIp<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException<span class="token punctuation">,</span> ServletException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// è·å–è¯»é”ï¼ŒåŒ…è£…äº†ç®€å•çš„é‡è¯•ï¼Œé”çš„ç²’åº¦ä¸ºGroupKey</span>
        <span class="token keyword">int</span> lockResult <span class="token operator">=</span> <span class="token function">tryConfigReadLock</span><span class="token punctuation">(</span>groupKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// è·å–é”æˆåŠŸ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lockResult <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            FileInputStream fis <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
                <span class="token comment" spellcheck="true">// è·å–è¯»é”åæ‰èƒ½è¯»ç¼“å­˜</span>
                CacheItem cacheItem <span class="token operator">=</span> ConfigCacheService<span class="token punctuation">.</span><span class="token function">getContentCache</span><span class="token punctuation">(</span>groupKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>cacheItem <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                File file <span class="token operator">=</span> null<span class="token punctuation">;</span>
                ConfigInfoBase configInfoBase <span class="token operator">=</span> null<span class="token punctuation">;</span>
                PrintWriter out <span class="token operator">=</span> null<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>isBeta<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUseTag</span><span class="token punctuation">(</span>cacheItem<span class="token punctuation">,</span> autoTag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// ...</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            md5 <span class="token operator">=</span> cacheItem<span class="token punctuation">.</span><span class="token function">getMd5</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            lastModified <span class="token operator">=</span> cacheItem<span class="token punctuation">.</span><span class="token function">getLastModifiedTs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>PropertyUtil<span class="token punctuation">.</span><span class="token function">isDirectRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token comment" spellcheck="true">// ç›´æ¥è¯»</span>
                                configInfoBase <span class="token operator">=</span> persistService<span class="token punctuation">.</span><span class="token function">findConfigInfo</span><span class="token punctuation">(</span>dataId<span class="token punctuation">,</span> group<span class="token punctuation">,</span> tenant<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                                <span class="token comment" spellcheck="true">// è¯»æœ¬åœ°æ–‡ä»¶</span>
                                file <span class="token operator">=</span> DiskUtil<span class="token punctuation">.</span><span class="token function">targetFile</span><span class="token punctuation">(</span>dataId<span class="token punctuation">,</span> group<span class="token punctuation">,</span> tenant<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>configInfoBase <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> <span class="token function">fileNotExist</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token comment" spellcheck="true">// ...</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>lockResult <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> HttpServletResponse<span class="token punctuation">.</span>SC_OK <span class="token operator">+</span> <span class="token string">""</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>OKï¼Œæ‰€ä»¥ä¸ç®¡æ˜¯Namingæˆ–è€…Configï¼Œå…¶å®éƒ½ä¸æ˜¯ä¸¥æ ¼çš„CPï¼Œå…ˆä¸è¯´å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„ç¼“å­˜ï¼ŒConfigServerè¿™é‡Œæ›´æ–°äº†é…ç½®åï¼Œé€šçŸ¥å…¶å®ƒServeræ˜¯å¼‚æ­¥çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ªçº¿ç¨‹æ›´æ–°æˆåŠŸè¿”å›åï¼Œä¸ä¿è¯å¯ä»¥è¯»åˆ°è‡ªå·±æ›´æ–°çš„æ•°æ®ï¼ˆè™½ç„¶æ¯æ¬¡éƒ½ä¼šä»åŒä¸€ä¸ªServerè¯»ï¼Œä½†æ˜¯å‡å¦‚è¯¥Serverå®•æœºäº†ï¼Œé‚£å°±ä¼šFailOveråˆ°å…¶å®ƒServeräº†ï¼‰ã€‚</p>
<hr>
<p>ConfigServletInner#doPollingConfig</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> String <span class="token function">doPollingConfig</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">,</span> HttpServletResponse response<span class="token punctuation">,</span>
                                  Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> clientMd5Map<span class="token punctuation">,</span> <span class="token keyword">int</span> probeRequestSize<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// é•¿è½®è¯¢</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>LongPollingService<span class="token punctuation">.</span><span class="token function">isSupportLongPolling</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            longPollingService<span class="token punctuation">.</span><span class="token function">addLongPollingClient</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> clientMd5Map<span class="token punctuation">,</span> probeRequestSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> HttpServletResponse<span class="token punctuation">.</span>SC_OK <span class="token operator">+</span> <span class="token string">""</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// else å…¼å®¹çŸ­è½®è¯¢é€»è¾‘ï¼Œé€šè¿‡å¯¹æ¯”MD5åˆ¤æ–­æ˜¯å¦å‘ç”Ÿäº†æ”¹å˜</span>
        List<span class="token operator">&lt;</span>String<span class="token operator">></span> changedGroups <span class="token operator">=</span> MD5Util<span class="token punctuation">.</span><span class="token function">compareMd5</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> clientMd5Map<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">return</span> HttpServletResponse<span class="token punctuation">.</span>SC_OK <span class="token operator">+</span> <span class="token string">""</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ConfigServletInner#addLongPollingClient</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addLongPollingClient</span><span class="token punctuation">(</span>HttpServletRequest req<span class="token punctuation">,</span> HttpServletResponse rsp<span class="token punctuation">,</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> clientMd5Map<span class="token punctuation">,</span>
                                     <span class="token keyword">int</span> probeRequestSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">/**
         * æå‰500msè¿”å›å“åº”ï¼Œä¸ºé¿å…å®¢æˆ·ç«¯è¶…æ—¶ @qiaoyi.dingqy 2013.10.22æ”¹åŠ¨  add delay time for LoadBalance
         */</span>
        <span class="token keyword">long</span> timeout <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">,</span> Long<span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token operator">-</span> delayTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFixedPolling</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">long</span> start <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//  å¯¹æ¯”MD5</span>
            List<span class="token operator">&lt;</span>String<span class="token operator">></span> changedGroups <span class="token operator">=</span> MD5Util<span class="token punctuation">.</span><span class="token function">compareMd5</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> rsp<span class="token punctuation">,</span> clientMd5Map<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// é…ç½®å‘ç”Ÿäº†å˜åŒ–</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>changedGroups<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">generateResponse</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> rsp<span class="token punctuation">,</span> changedGroups<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>noHangUpFlag <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> noHangUpFlag<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>TRUE_STR<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        String ip <span class="token operator">=</span> RequestUtil<span class="token punctuation">.</span><span class="token function">getRemoteIp</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ä¸€å®šè¦ç”±HTTPçº¿ç¨‹è°ƒç”¨ï¼Œå¦åˆ™ç¦»å¼€åå®¹å™¨ä¼šç«‹å³å‘é€å“åº”</span>
        <span class="token keyword">final</span> AsyncContext asyncContext <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">startAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// AsyncContext.setTimeout()çš„è¶…æ—¶æ—¶é—´ä¸å‡†ï¼Œæ‰€ä»¥åªèƒ½è‡ªå·±æ§åˆ¶</span>
        asyncContext<span class="token punctuation">.</span><span class="token function">setTimeout</span><span class="token punctuation">(</span>0L<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ä¼ å…¥äº†å¼‚æ­¥Servletä¸Šä¸‹æ–‡</span>
        scheduler<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClientLongPolling</span><span class="token punctuation">(</span>asyncContext<span class="token punctuation">,</span> clientMd5Map<span class="token punctuation">,</span> ip<span class="token punctuation">,</span> probeRequestSize<span class="token punctuation">,</span> timeout<span class="token punctuation">,</span> appName<span class="token punctuation">,</span> tag<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è¿™é‡ŒServletçº¿ç¨‹ç›´æ¥è¿”å›</span>
    <span class="token punctuation">}</span></code></pre>
<p>æ‰€ä»¥è¿™é‡Œä½¿ç”¨çš„æ˜¯å¼‚æ­¥Servletå¤„ç†é•¿è½®è¯¢ï¼Œä¸ç„¶å·¥ä½œçº¿ç¨‹å¾ˆå¿«å°±ä¼šè¢«å æ»¡ç„¶åæ‹’ç»æœåŠ¡ã€‚</p>
<p>LongPollingService$ClientLongPolling#run</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è¶…æ—¶åæ‰§è¡Œ</span>
            asyncTimeoutFuture <span class="token operator">=</span> scheduler<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token function">getRetainIps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>ClientLongPolling<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>ip<span class="token punctuation">,</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">/**
                         * åˆ é™¤è®¢é˜…å…³ç³»
                         */</span>
                        allSubs<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>ClientLongPolling<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFixedPolling</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// ...</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            <span class="token function">sendResponse</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> timeoutTime<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// åŠ å…¥è®¢é˜…</span>
            allSubs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>LongPollingService#onEvent</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onEvent</span><span class="token punctuation">(</span>Event event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFixedPolling</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ignore</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token keyword">instanceof</span> <span class="token class-name">LocalDataChangeEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                LocalDataChangeEvent evt <span class="token operator">=</span> <span class="token punctuation">(</span>LocalDataChangeEvent<span class="token punctuation">)</span> event<span class="token punctuation">;</span>
                scheduler<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DataChangeTask</span><span class="token punctuation">(</span>evt<span class="token punctuation">.</span>groupKey<span class="token punctuation">,</span> evt<span class="token punctuation">.</span>isBeta<span class="token punctuation">,</span> evt<span class="token punctuation">.</span>betaIps<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>LongPollingService$DataChangeTask#run</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                ConfigCacheService<span class="token punctuation">.</span><span class="token function">getContentBetaMd5</span><span class="token punctuation">(</span>groupKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// éå†è®¢é˜…</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>Iterator<span class="token operator">&lt;</span>ClientLongPolling<span class="token operator">></span> iter <span class="token operator">=</span> allSubs<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> iter<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    ClientLongPolling clientSub <span class="token operator">=</span> iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>clientSub<span class="token punctuation">.</span>clientMd5Map<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>groupKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                        <span class="token function">getRetainIps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>clientSub<span class="token punctuation">.</span>ip<span class="token punctuation">,</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        iter<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// åˆ é™¤è®¢é˜…å…³ç³»</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                        <span class="token comment" spellcheck="true">// æ‰§è¡Œå›è°ƒ</span>
                        clientSub<span class="token punctuation">.</span><span class="token function">sendResponse</span><span class="token punctuation">(</span>Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>groupKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span></code></pre>
<p>ä¹‹æ‰€ä»¥ä¸ä½¿ç”¨ä¸»åŠ¨çš„é•¿è¿æ¥æ¨é€ï¼Œæˆ‘çš„çœ‹æ³•æ˜¯è¿™æ ·æœåŠ¡ç«¯éœ€è¦ç»´æŠ¤å¤ªå¤šçŠ¶æ€ï¼Œé€»è¾‘æ¯”è¾ƒå¤æ‚ï¼Œä¸ä»…éœ€è¦ç»´æŠ¤å’Œå®¢æˆ·ç«¯çš„é•¿è¿æ¥ï¼Œå¿ƒè·³ï¼Œè¿˜éœ€è¦å¯¹å‘çš„æ¶ˆæ¯è¿›è¡Œç¡®è®¤å’Œé‡ä¼ ï¼Œéå¸¸éº»çƒ¦ã€‚</p>
<p>è€Œä½¿ç”¨å®¢æˆ·ç«¯çš„é•¿è½®è¯¢ï¼Œå…¶å®æ˜¯æŠŠçŠ¶æ€äº¤ç»™äº†å®¢æˆ·ç«¯ç»´æŠ¤ï¼ŒæœåŠ¡ç«¯çš„é€»è¾‘å°±ç®€å•äº†å¾ˆå¤šï¼Œè€Œä¸”æ–¹ä¾¿æœåŠ¡ç«¯çš„æ‰©å±•ã€‚</p>
<p>åƒæŸäº›æ¶ˆæ¯é˜Ÿåˆ—æ¯”å¦‚æŸå¡ï¼ŒæŸç«ç®­ï¼Œä¹Ÿæ˜¯ä½¿ç”¨äº†é•¿è½®è¯¢çš„æ–¹å¼ã€‚</p>
<p>å®Œã€‚</p>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


        <footer>
             
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

        </footer>
    </div>
    <!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
    <script>
        var timeEnd = new Date();
        console.log('è€—æ—¶ï¼š' + (timeEnd - timeStart));
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre').forEach((block) => {
                block.classList.add("line-numbers");
            });
        });
    </script>
    <!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
    <!-- material design -->
    <!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
    <!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
    <!-- toc -->
    <!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
    <!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
    <!-- <script src="/js/main.js"></script> -->
    <script src="/js/prism.js"></script>
</body>
</html>
