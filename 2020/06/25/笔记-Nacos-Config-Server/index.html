<!DOCTYPE HTML>
<html>

<head>
    <script>
        var timeStart = new Date();
    </script>
    <meta charset="utf-8">
    
    <title>[笔记]-Nacos-Config-Server | Reunion...</title>
    
    <meta name="author" content="huangzhike">
    
    
    <meta name="description"
        content="Config模块挺多中文注释的，我倒是很欢迎啦。
但是作者肯定没打开P3C代码规范检查插件。
这换行，血压飙升，太丑了。
又Tab又空格，我。。。
把头伸过来，我给你加个Buff。

NacosConfigConfiguration#transferToLeader
    @Conditional">
    
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta property="og:title" content="[笔记]-Nacos-Config-Server" />
    
    <meta property="og:site_name" content="Reunion..." />
    
    
    <!-- favicon -->
    <link rel="icon" type="image/ico" href="/logo.ico" sizes="32x32">
    <meta name="msapplication-TileColor" content="#009688">
    <meta name="msapplication-TileImage" content="/mstile-144x144.ico">
    <meta name="theme-color" content="#009688">
    <!-- favicon end -->
    <!-- <link href="//ok.ico" rel="icon"> -->
    

    <!-- <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.5.0/css/bootstrap.min.css" rel="stylesheet"> -->
    <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
    <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
    <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">

<meta name="generator" content="Hexo 4.2.1"></head>
<body>
    <nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">菜单</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" title="早く来い、クラウド" href="/">Reunion...</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" target="_blank" rel="noopener" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

    <div class="container" >
        <div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[笔记]-Nacos-Config-Server</h2>
				
				<div>
					<div class="post-time">2020-06-25</div>
				</div>
				
				<div class="article-content">
				<p>Config模块挺多中文注释的，我倒是很欢迎啦。</p>
<p>但是作者肯定没打开P3C代码规范检查插件。</p>
<p>这换行，血压飙升，太丑了。</p>
<p>又Tab又空格，我。。。</p>
<p>把头伸过来，我给你加个Buff。</p>
<hr>
<p>NacosConfigConfiguration#transferToLeader</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Conditional</span><span class="token punctuation">(</span>ConditionDistributedEmbedStorage<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token comment" spellcheck="true">// ？？？</span>
    <span class="token keyword">public</span> CurcuitFilter <span class="token function">transferToLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CurcuitFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>CurcuitFilter#listenerSelfInCluster</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">listenerSelfInCluster</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        protocol<span class="token punctuation">.</span><span class="token function">protocolMetaData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>Constants<span class="token punctuation">.</span>CONFIG_MODEL_RAFT_GROUP<span class="token punctuation">,</span>
                MetadataKey<span class="token punctuation">.</span>RAFT_GROUP_MEMBER<span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">Observer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span>Observable o<span class="token punctuation">,</span> Object arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">final</span> List<span class="token operator">&lt;</span>String<span class="token operator">></span> peers <span class="token operator">=</span> <span class="token punctuation">(</span>List<span class="token operator">&lt;</span>String<span class="token operator">></span><span class="token punctuation">)</span> arg<span class="token punctuation">;</span>
                        <span class="token keyword">final</span> Member self <span class="token operator">=</span> memberManager<span class="token punctuation">.</span><span class="token function">getSelf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">final</span> String raftAddress <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token function">getIp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> self<span class="token punctuation">.</span><span class="token function">getExtendVal</span><span class="token punctuation">(</span>MemberMetaDataConstants<span class="token punctuation">.</span>RAFT_PORT<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// Only when you are in the cluster and the current Leader is</span>
                        <span class="token comment" spellcheck="true">// elected can you provide external services</span>
                        isOpenService <span class="token operator">=</span> peers<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>raftAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<blockquote>
<p>If the embedded distributed storage is enabled, all requests are routed to the Leader node for processing, and the maximum number of forwards for a single request cannot exceed three</p>
</blockquote>
<p>当使用内嵌的分布式存储时，只有Leader才能处理请求，请求都会被转发到Leader，CurcuitFilter的注释是这么说的，理论上也应该是这样。</p>
<p>但是CurcuitFilter的代码中完全没有体现这一点，只要当前Server在集群中就放行，实际的转发操作都下沉到DistributedDatabaseOperateImpl上了。</p>
<hr>
<p>ConfigController#publishConfig</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@PostMapping</span>
    <span class="token annotation punctuation">@Secured</span><span class="token punctuation">(</span>action <span class="token operator">=</span> ActionTypes<span class="token punctuation">.</span>WRITE<span class="token punctuation">,</span> parser <span class="token operator">=</span> ConfigResourceParser<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> Boolean <span class="token function">publishConfig</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">,</span> HttpServletResponse response<span class="token punctuation">,</span>
                                 <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"dataId"</span><span class="token punctuation">)</span> String dataId<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"group"</span><span class="token punctuation">)</span> String group<span class="token punctuation">,</span>
                                 <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"tenant"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> defaultValue <span class="token operator">=</span> StringUtils<span class="token punctuation">.</span>EMPTY<span class="token punctuation">)</span> String tenant<span class="token punctuation">,</span>
                                 <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"content"</span><span class="token punctuation">)</span> String content<span class="token punctuation">,</span>
                                 <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"tag"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> String tag<span class="token punctuation">,</span>
                                 <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"appName"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> String appName<span class="token punctuation">,</span>
                                 <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"src_user"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> String srcUser<span class="token punctuation">,</span>
                                 <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"config_tags"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> String configTags<span class="token punctuation">,</span>
                                 <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"desc"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> String desc<span class="token punctuation">,</span>
                                 <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"use"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> String use<span class="token punctuation">,</span>
                                 <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"effect"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> String effect<span class="token punctuation">,</span>
                                 <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"type"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> String type<span class="token punctuation">,</span>
                                 <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"schema"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> String schema<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> NacosException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>betaIps<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                persistService<span class="token punctuation">.</span><span class="token function">insertOrUpdate</span><span class="token punctuation">(</span>srcIp<span class="token punctuation">,</span> srcUser<span class="token punctuation">,</span> configInfo<span class="token punctuation">,</span> time<span class="token punctuation">,</span> configAdvanceInfo<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                ConfigChangePublisher<span class="token punctuation">.</span><span class="token function">notifyConfigChange</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ConfigDataChangeEvent</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> dataId<span class="token punctuation">,</span> group<span class="token punctuation">,</span> tenant<span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>使用外置的持久化就不需要Raft协议维护一致性了，处理会简单很多。</p>
<p>ExternalStoragePersistServiceImpl#insertOrUpdate</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">insertOrUpdate</span><span class="token punctuation">(</span>String srcIp<span class="token punctuation">,</span> String srcUser<span class="token punctuation">,</span>
                               ConfigInfo configInfo<span class="token punctuation">,</span> Timestamp time<span class="token punctuation">,</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token operator">></span> configAdvanceInfo<span class="token punctuation">,</span>
                               <span class="token keyword">boolean</span> notify<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 事务相关的处理交给了AOP</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 先尝试插入</span>
            <span class="token function">addConfigInfo</span><span class="token punctuation">(</span>srcIp<span class="token punctuation">,</span> srcUser<span class="token punctuation">,</span> configInfo<span class="token punctuation">,</span> time<span class="token punctuation">,</span> configAdvanceInfo<span class="token punctuation">,</span> notify<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">DataIntegrityViolationException</span> ive<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 唯一性约束冲突</span>
            <span class="token comment" spellcheck="true">// 插入失败那就是更新了</span>
            <span class="token function">updateConfigInfo</span><span class="token punctuation">(</span>configInfo<span class="token punctuation">,</span> srcIp<span class="token punctuation">,</span> srcUser<span class="token punctuation">,</span> time<span class="token punctuation">,</span> configAdvanceInfo<span class="token punctuation">,</span> notify<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>CapacityManagementAspect#aroundSyncUpdateConfigAll</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Around</span><span class="token punctuation">(</span>SYNC_UPDATE_CONFIG_ALL<span class="token punctuation">)</span>
    <span class="token keyword">public</span> Object <span class="token function">aroundSyncUpdateConfigAll</span><span class="token punctuation">(</span>ProceedingJoinPoint pjp<span class="token punctuation">,</span> HttpServletRequest request<span class="token punctuation">,</span>
                                            HttpServletResponse response<span class="token punctuation">,</span> String dataId<span class="token punctuation">,</span> String group<span class="token punctuation">,</span> String content<span class="token punctuation">,</span>
                                            String appName<span class="token punctuation">,</span> String srcUser<span class="token punctuation">,</span> String tenant<span class="token punctuation">,</span> String tag<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> Throwable <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 如果没开始容量管理就直接放行</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>PropertyUtil<span class="token punctuation">.</span><span class="token function">isManageCapacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> pjp<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        String betaIps <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"betaIps"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>betaIps<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 只对写入或更新config_info表的做容量管理的限制检验</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>persistService<span class="token punctuation">.</span><span class="token function">findConfigInfo</span><span class="token punctuation">(</span>dataId<span class="token punctuation">,</span> group<span class="token punctuation">,</span> tenant<span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 写入操作</span>
                    <span class="token keyword">return</span> <span class="token function">do4Insert</span><span class="token punctuation">(</span>pjp<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> group<span class="token punctuation">,</span> tenant<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 更新操作</span>
                <span class="token keyword">return</span> <span class="token function">do4Update</span><span class="token punctuation">(</span>pjp<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> dataId<span class="token punctuation">,</span> group<span class="token punctuation">,</span> tenant<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> pjp<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>CapacityManagementAspect#do4Insert</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> Object <span class="token function">do4Insert</span><span class="token punctuation">(</span>ProceedingJoinPoint pjp<span class="token punctuation">,</span> HttpServletRequest request<span class="token punctuation">,</span>
                             HttpServletResponse response<span class="token punctuation">,</span> String group<span class="token punctuation">,</span> String tenant<span class="token punctuation">,</span> String content<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> Throwable <span class="token punctuation">{</span>
        CounterMode counterMode <span class="token operator">=</span> CounterMode<span class="token punctuation">.</span>INCREMENT<span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> hasTenant <span class="token operator">=</span> <span class="token function">hasTenant</span><span class="token punctuation">(</span>tenant<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>PropertyUtil<span class="token punctuation">.</span><span class="token function">isCapacityLimitCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 先写入或更新：usage + 1</span>
            LimitType limitType <span class="token operator">=</span> <span class="token function">getLimitType</span><span class="token punctuation">(</span>counterMode<span class="token punctuation">,</span> group<span class="token punctuation">,</span> tenant<span class="token punctuation">,</span> content<span class="token punctuation">,</span> hasTenant<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>limitType <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token function">response4Limit</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> limitType<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 先写入或更新：usage + 1</span>
            <span class="token function">insertOrUpdateUsage</span><span class="token punctuation">(</span>group<span class="token punctuation">,</span> tenant<span class="token punctuation">,</span> counterMode<span class="token punctuation">,</span> hasTenant<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token function">getResult</span><span class="token punctuation">(</span>pjp<span class="token punctuation">,</span> response<span class="token punctuation">,</span> group<span class="token punctuation">,</span> tenant<span class="token punctuation">,</span> counterMode<span class="token punctuation">,</span> hasTenant<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>CapacityManagementAspect#getResult</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> Object <span class="token function">getResult</span><span class="token punctuation">(</span>ProceedingJoinPoint pjp<span class="token punctuation">,</span> HttpServletResponse response<span class="token punctuation">,</span> String group<span class="token punctuation">,</span> String tenant<span class="token punctuation">,</span>
                             CounterMode counterMode<span class="token punctuation">,</span> <span class="token keyword">boolean</span> hasTenant<span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 执行实际操作</span>
            Object result <span class="token operator">=</span> pjp<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 根据执行结果判定是否需要回滚，这个回滚不依赖数据库事务，而是手动的消除，加一的回滚就是减一</span>
            <span class="token function">doResult</span><span class="token punctuation">(</span>counterMode<span class="token punctuation">,</span> response<span class="token punctuation">,</span> group<span class="token punctuation">,</span> tenant<span class="token punctuation">,</span> result<span class="token punctuation">,</span> hasTenant<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">rollback</span><span class="token punctuation">(</span>counterMode<span class="token punctuation">,</span> group<span class="token punctuation">,</span> tenant<span class="token punctuation">,</span> hasTenant<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> throwable<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>更新完后触发监听回调。</p>
<p>AsyncNotifyService#onEvent</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onEvent</span><span class="token punctuation">(</span>Event event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 并发产生 ConfigDataChangeEvent</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token keyword">instanceof</span> <span class="token class-name">ConfigDataChangeEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ConfigDataChangeEvent evt <span class="token operator">=</span> <span class="token punctuation">(</span>ConfigDataChangeEvent<span class="token punctuation">)</span> event<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ...</span>
            Collection<span class="token operator">&lt;</span>Member<span class="token operator">></span> ipList <span class="token operator">=</span> memberManager<span class="token punctuation">.</span><span class="token function">allMembers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Queue<span class="token operator">&lt;</span>NotifySingleTask<span class="token operator">></span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token operator">&lt;</span>NotifySingleTask<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 每个Server节点都要通知</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>Member member <span class="token operator">:</span> ipList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                queue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NotifySingleTask</span><span class="token punctuation">(</span>dataId<span class="token punctuation">,</span> group<span class="token punctuation">,</span> tenant<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> dumpTs<span class="token punctuation">,</span> member<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> evt<span class="token punctuation">.</span>isBeta<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 提交任务</span>
            EXECUTOR<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AsyncTask</span><span class="token punctuation">(</span>httpclient<span class="token punctuation">,</span> queue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>AsyncNotifyService$AsyncTask#executeAsyncInvoke</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">executeAsyncInvoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>queue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                NotifySingleTask task <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                String targetIp <span class="token operator">=</span> task<span class="token punctuation">.</span><span class="token function">getTargetIP</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>memberManager<span class="token punctuation">.</span><span class="token function">hasMember</span><span class="token punctuation">(</span>targetIp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 启动健康检查且有不监控的ip则直接把放到通知队列，否则通知</span>
                    <span class="token keyword">boolean</span> unHealthNeedDelay <span class="token operator">=</span> memberManager<span class="token punctuation">.</span><span class="token function">isUnHealth</span><span class="token punctuation">(</span>targetIp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>unHealthNeedDelay<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// target ip 不健康，则放入通知列表中</span>
                        ConfigTraceService<span class="token punctuation">.</span><span class="token function">logNotifyEvent</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getDataId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> task<span class="token punctuation">.</span><span class="token function">getGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                        task<span class="token punctuation">.</span><span class="token function">getTenant</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> null<span class="token punctuation">,</span> task<span class="token punctuation">.</span><span class="token function">getLastModified</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                        InetUtils<span class="token punctuation">.</span><span class="token function">getSelfIp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                        ConfigTraceService<span class="token punctuation">.</span>NOTIFY_EVENT_UNHEALTH<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
                                        task<span class="token punctuation">.</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// get delay time and set fail count to the task</span>
                        <span class="token function">asyncTaskExecute</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        HttpGet request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpGet</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                        httpclient<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">AsyncNotifyCallBack</span><span class="token punctuation">(</span>httpclient<span class="token punctuation">,</span> task<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span></code></pre>
<p>CommunicationController#notifyConfigInfo</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/dataChange"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> Boolean <span class="token function">notifyConfigInfo</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">,</span>
                                    <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"dataId"</span><span class="token punctuation">)</span> String dataId<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">"group"</span><span class="token punctuation">)</span> String group<span class="token punctuation">,</span>
                                    <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"tenant"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> defaultValue <span class="token operator">=</span> StringUtils<span class="token punctuation">.</span>EMPTY<span class="token punctuation">)</span> String tenant<span class="token punctuation">,</span>
                                    <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"tag"</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> String tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>isBetaStr<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> trueStr<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>isBetaStr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            dumpService<span class="token punctuation">.</span><span class="token function">dump</span><span class="token punctuation">(</span>dataId<span class="token punctuation">,</span> group<span class="token punctuation">,</span> tenant<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> lastModifiedTs<span class="token punctuation">,</span> handleIp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>DumpProcessor#process</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">process</span><span class="token punctuation">(</span>String taskType<span class="token punctuation">,</span> AbstractTask task<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> PersistService persistService <span class="token operator">=</span> dumpService<span class="token punctuation">.</span><span class="token function">getPersistService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        DumpTask dumpTask <span class="token operator">=</span> <span class="token punctuation">(</span>DumpTask<span class="token punctuation">)</span> task<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        ConfigDumpEvent<span class="token punctuation">.</span>ConfigDumpEventBuilder build <span class="token operator">=</span> <span class="token comment" spellcheck="true">// ...</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>isBeta<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">//  先查询</span>
                ConfigInfo cf <span class="token operator">=</span> persistService<span class="token punctuation">.</span><span class="token function">findConfigInfo</span><span class="token punctuation">(</span>dataId<span class="token punctuation">,</span> group<span class="token punctuation">,</span> tenant<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ...</span>
                <span class="token comment" spellcheck="true">// 更新缓存</span>
                <span class="token keyword">return</span> DumpConfigHandler<span class="token punctuation">.</span><span class="token function">configDump</span><span class="token punctuation">(</span>build<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>DumpConfigHandler#configDump</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">configDump</span><span class="token punctuation">(</span>ConfigDumpEvent event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">isBeta</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">boolean</span> result<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>event<span class="token punctuation">.</span><span class="token function">isRemove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                result <span class="token operator">=</span> ConfigCacheService<span class="token punctuation">.</span><span class="token function">dump</span><span class="token punctuation">(</span>dataId<span class="token punctuation">,</span> group<span class="token punctuation">,</span> namespaceId<span class="token punctuation">,</span> content<span class="token punctuation">,</span> lastModified<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>ConfigCacheService#dump</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">static</span> <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">dump</span><span class="token punctuation">(</span>String dataId<span class="token punctuation">,</span> String group<span class="token punctuation">,</span> String tenant<span class="token punctuation">,</span> String content<span class="token punctuation">,</span> <span class="token keyword">long</span> lastModifiedTs<span class="token punctuation">,</span> String type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        String groupKey <span class="token operator">=</span> GroupKey2<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span>dataId<span class="token punctuation">,</span> group<span class="token punctuation">,</span> tenant<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 先保证创建缓存</span>
        CacheItem ci <span class="token operator">=</span> <span class="token function">makeSure</span><span class="token punctuation">(</span>groupKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 先获取读锁</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> lockResult <span class="token operator">=</span> <span class="token function">tryWriteLock</span><span class="token punctuation">(</span>groupKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">assert</span> <span class="token punctuation">(</span>lockResult <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 获取读锁失败</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lockResult <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 先计算MD5</span>
            <span class="token keyword">final</span> String md5 <span class="token operator">=</span> MD5Utils<span class="token punctuation">.</span><span class="token function">md5Hex</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> Constants<span class="token punctuation">.</span>ENCODE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 没变化，忽略</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>md5<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>ConfigCacheService<span class="token punctuation">.</span><span class="token function">getContentMd5</span><span class="token punctuation">(</span>groupKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>PropertyUtil<span class="token punctuation">.</span><span class="token function">isDirectRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 本地文件持久化，这是为了降低读压力</span>
                DiskUtil<span class="token punctuation">.</span><span class="token function">saveToDisk</span><span class="token punctuation">(</span>dataId<span class="token punctuation">,</span> group<span class="token punctuation">,</span> tenant<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 更新本地缓存的MD5，同时触发LocalDataChangeEvent</span>
            <span class="token function">updateMd5</span><span class="token punctuation">(</span>groupKey<span class="token punctuation">,</span> md5<span class="token punctuation">,</span> lastModifiedTs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ioe<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token function">releaseWriteLock</span><span class="token punctuation">(</span>groupKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>ConfigServletInner#doGetConfig</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> String <span class="token function">doGetConfig</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">,</span> HttpServletResponse response<span class="token punctuation">,</span> String dataId<span class="token punctuation">,</span> String group<span class="token punctuation">,</span>
                              String tenant<span class="token punctuation">,</span> String tag<span class="token punctuation">,</span> String clientIp<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException<span class="token punctuation">,</span> ServletException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// 获取读锁，包装了简单的重试，锁的粒度为GroupKey</span>
        <span class="token keyword">int</span> lockResult <span class="token operator">=</span> <span class="token function">tryConfigReadLock</span><span class="token punctuation">(</span>groupKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// 获取锁成功</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lockResult <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            FileInputStream fis <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
                <span class="token comment" spellcheck="true">// 获取读锁后才能读缓存</span>
                CacheItem cacheItem <span class="token operator">=</span> ConfigCacheService<span class="token punctuation">.</span><span class="token function">getContentCache</span><span class="token punctuation">(</span>groupKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>cacheItem <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                File file <span class="token operator">=</span> null<span class="token punctuation">;</span>
                ConfigInfoBase configInfoBase <span class="token operator">=</span> null<span class="token punctuation">;</span>
                PrintWriter out <span class="token operator">=</span> null<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>isBeta<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUseTag</span><span class="token punctuation">(</span>cacheItem<span class="token punctuation">,</span> autoTag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// ...</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            md5 <span class="token operator">=</span> cacheItem<span class="token punctuation">.</span><span class="token function">getMd5</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            lastModified <span class="token operator">=</span> cacheItem<span class="token punctuation">.</span><span class="token function">getLastModifiedTs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>PropertyUtil<span class="token punctuation">.</span><span class="token function">isDirectRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token comment" spellcheck="true">// 直接读</span>
                                configInfoBase <span class="token operator">=</span> persistService<span class="token punctuation">.</span><span class="token function">findConfigInfo</span><span class="token punctuation">(</span>dataId<span class="token punctuation">,</span> group<span class="token punctuation">,</span> tenant<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                                <span class="token comment" spellcheck="true">// 读本地文件</span>
                                file <span class="token operator">=</span> DiskUtil<span class="token punctuation">.</span><span class="token function">targetFile</span><span class="token punctuation">(</span>dataId<span class="token punctuation">,</span> group<span class="token punctuation">,</span> tenant<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>configInfoBase <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> <span class="token function">fileNotExist</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token comment" spellcheck="true">// ...</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>lockResult <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> HttpServletResponse<span class="token punctuation">.</span>SC_OK <span class="token operator">+</span> <span class="token string">""</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>OK，所以不管是Naming或者Config，其实都不是严格的CP，先不说客户端和服务端的缓存，ConfigServer这里更新了配置后，通知其它Server是异步的，也就是说，一个线程更新成功返回后，不保证可以读到自己更新的数据（虽然每次都会从同一个Server读，但是假如该Server宕机了，那就会FailOver到其它Server了）。</p>
<hr>
<p>ConfigServletInner#doPollingConfig</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> String <span class="token function">doPollingConfig</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">,</span> HttpServletResponse response<span class="token punctuation">,</span>
                                  Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> clientMd5Map<span class="token punctuation">,</span> <span class="token keyword">int</span> probeRequestSize<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 长轮询</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>LongPollingService<span class="token punctuation">.</span><span class="token function">isSupportLongPolling</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            longPollingService<span class="token punctuation">.</span><span class="token function">addLongPollingClient</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> clientMd5Map<span class="token punctuation">,</span> probeRequestSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> HttpServletResponse<span class="token punctuation">.</span>SC_OK <span class="token operator">+</span> <span class="token string">""</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// else 兼容短轮询逻辑，通过对比MD5判断是否发生了改变</span>
        List<span class="token operator">&lt;</span>String<span class="token operator">></span> changedGroups <span class="token operator">=</span> MD5Util<span class="token punctuation">.</span><span class="token function">compareMd5</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> clientMd5Map<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">return</span> HttpServletResponse<span class="token punctuation">.</span>SC_OK <span class="token operator">+</span> <span class="token string">""</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ConfigServletInner#addLongPollingClient</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addLongPollingClient</span><span class="token punctuation">(</span>HttpServletRequest req<span class="token punctuation">,</span> HttpServletResponse rsp<span class="token punctuation">,</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> clientMd5Map<span class="token punctuation">,</span>
                                     <span class="token keyword">int</span> probeRequestSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">/**
         * 提前500ms返回响应，为避免客户端超时 @qiaoyi.dingqy 2013.10.22改动  add delay time for LoadBalance
         */</span>
        <span class="token keyword">long</span> timeout <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">,</span> Long<span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token operator">-</span> delayTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFixedPolling</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">long</span> start <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//  对比MD5</span>
            List<span class="token operator">&lt;</span>String<span class="token operator">></span> changedGroups <span class="token operator">=</span> MD5Util<span class="token punctuation">.</span><span class="token function">compareMd5</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> rsp<span class="token punctuation">,</span> clientMd5Map<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 配置发生了变化</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>changedGroups<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">generateResponse</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> rsp<span class="token punctuation">,</span> changedGroups<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>noHangUpFlag <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> noHangUpFlag<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>TRUE_STR<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        String ip <span class="token operator">=</span> RequestUtil<span class="token punctuation">.</span><span class="token function">getRemoteIp</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 一定要由HTTP线程调用，否则离开后容器会立即发送响应</span>
        <span class="token keyword">final</span> AsyncContext asyncContext <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">startAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// AsyncContext.setTimeout()的超时时间不准，所以只能自己控制</span>
        asyncContext<span class="token punctuation">.</span><span class="token function">setTimeout</span><span class="token punctuation">(</span>0L<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 传入了异步Servlet上下文</span>
        scheduler<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClientLongPolling</span><span class="token punctuation">(</span>asyncContext<span class="token punctuation">,</span> clientMd5Map<span class="token punctuation">,</span> ip<span class="token punctuation">,</span> probeRequestSize<span class="token punctuation">,</span> timeout<span class="token punctuation">,</span> appName<span class="token punctuation">,</span> tag<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 这里Servlet线程直接返回</span>
    <span class="token punctuation">}</span></code></pre>
<p>所以这里使用的是异步Servlet处理长轮询，不然工作线程很快就会被占满然后拒绝服务。</p>
<p>LongPollingService$ClientLongPolling#run</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 超时后执行</span>
            asyncTimeoutFuture <span class="token operator">=</span> scheduler<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token function">getRetainIps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>ClientLongPolling<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>ip<span class="token punctuation">,</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">/**
                         * 删除订阅关系
                         */</span>
                        allSubs<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>ClientLongPolling<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFixedPolling</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// ...</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            <span class="token function">sendResponse</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> timeoutTime<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 加入订阅</span>
            allSubs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>LongPollingService#onEvent</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onEvent</span><span class="token punctuation">(</span>Event event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFixedPolling</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ignore</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token keyword">instanceof</span> <span class="token class-name">LocalDataChangeEvent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                LocalDataChangeEvent evt <span class="token operator">=</span> <span class="token punctuation">(</span>LocalDataChangeEvent<span class="token punctuation">)</span> event<span class="token punctuation">;</span>
                scheduler<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DataChangeTask</span><span class="token punctuation">(</span>evt<span class="token punctuation">.</span>groupKey<span class="token punctuation">,</span> evt<span class="token punctuation">.</span>isBeta<span class="token punctuation">,</span> evt<span class="token punctuation">.</span>betaIps<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>LongPollingService$DataChangeTask#run</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                ConfigCacheService<span class="token punctuation">.</span><span class="token function">getContentBetaMd5</span><span class="token punctuation">(</span>groupKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 遍历订阅</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>Iterator<span class="token operator">&lt;</span>ClientLongPolling<span class="token operator">></span> iter <span class="token operator">=</span> allSubs<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> iter<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    ClientLongPolling clientSub <span class="token operator">=</span> iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>clientSub<span class="token punctuation">.</span>clientMd5Map<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>groupKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                        <span class="token function">getRetainIps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>clientSub<span class="token punctuation">.</span>ip<span class="token punctuation">,</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        iter<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 删除订阅关系</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                        <span class="token comment" spellcheck="true">// 执行回调</span>
                        clientSub<span class="token punctuation">.</span><span class="token function">sendResponse</span><span class="token punctuation">(</span>Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>groupKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span></code></pre>
<p>之所以不使用主动的长连接推送，我的看法是这样服务端需要维护太多状态，逻辑比较复杂，不仅需要维护和客户端的长连接，心跳，还需要对发的消息进行确认和重传，非常麻烦。</p>
<p>而使用客户端的长轮询，其实是把状态交给了客户端维护，服务端的逻辑就简单了很多，而且方便服务端的扩展。</p>
<p>像某些消息队列比如某卡，某火箭，也是使用了长轮询的方式。</p>
<p>完。</p>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


        <footer>
             
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

        </footer>
    </div>
    <!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
    <script>
        var timeEnd = new Date();
        console.log('耗时：' + (timeEnd - timeStart));
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre').forEach((block) => {
                block.classList.add("line-numbers");
            });
        });
    </script>

    <script src="/js/prism.js"></script>
</body>
</html>
