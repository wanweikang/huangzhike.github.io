<!DOCTYPE HTML>
<html>
	<head><meta name="generator" content="Hexo 3.9.0">
		<meta charset="utf-8">
		<script src="/js/highlight.js"></script>
				<script>hljs.initHighlightingOnLoad();var timeStart = new Date();</script>
		
		<title>[笔记]-Nacos-Config-Server | 学而时习之</title>
		
		<meta name="author" content="Huangzhike">
		
		
		<meta name="description" content="K.I.S.S">
		
		
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		
		<meta property="og:title" content="[笔记]-Nacos-Config-Server">
		
		<meta property="og:site_name" content="学而时习之">
		
		
		<!-- favicon -->
		<link rel="icon" type="image/ico" href="/ok.ico" sizes="32x32">
 


		<meta name="msapplication-TileColor" content="#009688">
		<meta name="msapplication-TileImage" content="/mstile-144x144.ico">
		<meta name="theme-color" content="#009688">

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Didact+Gothic"> 

		<!-- favicon end -->
		<!-- <link href="//ok.ico" rel="icon"> -->
		
		<!-- toc -->
		<!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
		<!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
		<!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
		<!-- material design -->
		<!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
		<!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
		<!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
		<!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
		<!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
		<link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
		 
		 
		<!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
		<!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
	</head>
</html>
<body>
	<nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">菜单</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" href="/">学而时习之</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

	<div class="container" >
		<div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[笔记]-Nacos-Config-Server</h2>
				
				<div>
					<div class="post-time">2020-06-25</div>
				</div>
				
				<div class="article-content">
				<p>Config模块挺多中文注释的，我倒是很欢迎啦。</p>
<p>但是作者肯定没打开P3C代码规范检查插件。</p>
<p>这换行，血压飙升，太丑了。</p>
<p>又Tab又空格，我。。。</p>
<p>把头伸过来，我给你加个Buff。</p>
<hr>
<p>NacosConfigConfiguration#transferToLeader</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Conditional</span>(ConditionDistributedEmbedStorage.class)</span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="comment">// ？？？</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> CurcuitFilter <span class="title">transferToLeader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> CurcuitFilter();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>CurcuitFilter#listenerSelfInCluster</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">listenerSelfInCluster</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    protocol.protocolMetaData().subscribe(Constants.CONFIG_MODEL_RAFT_GROUP,</span><br><span class="line">            MetadataKey.RAFT_GROUP_MEMBER,</span><br><span class="line">            <span class="keyword">new</span> Observer() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(Observable o, Object arg)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">final</span> List&lt;String&gt; peers = (List&lt;String&gt;) arg;</span><br><span class="line">                    <span class="keyword">final</span> Member self = memberManager.getSelf();</span><br><span class="line">                    <span class="keyword">final</span> String raftAddress = self.getIp() + <span class="string">":"</span> + self.getExtendVal(MemberMetaDataConstants.RAFT_PORT);</span><br><span class="line">                    <span class="comment">// Only when you are in the cluster and the current Leader is</span></span><br><span class="line">                    <span class="comment">// elected can you provide external services</span></span><br><span class="line">                    isOpenService = peers.contains(raftAddress);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>If the embedded distributed storage is enabled, all requests are routed to the Leader node for processing, and the maximum number of forwards for a single request cannot exceed three</p>
</blockquote>
<p>当使用内嵌的分布式存储时，只有Leader才能处理请求，请求都会被转发到Leader，CurcuitFilter的注释是这么说的，理论上也应该是这样。</p>
<p>但是CurcuitFilter的代码中完全没有体现这一点，只要当前Server在集群中就放行，实际的转发操作都下沉到DistributedDatabaseOperateImpl上了。</p>
<hr>
<p>ConfigController#publishConfig</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span></span><br><span class="line"><span class="meta">@Secured</span>(action = ActionTypes.WRITE, parser = ConfigResourceParser.class)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Boolean <span class="title">publishConfig</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span></span><br><span class="line"><span class="function"><span class="params">                             @RequestParam(value = <span class="string">"dataId"</span>)</span> String dataId, @<span class="title">RequestParam</span><span class="params">(value = <span class="string">"group"</span>)</span> String group,</span></span><br><span class="line"><span class="function">                             @<span class="title">RequestParam</span><span class="params">(value = <span class="string">"tenant"</span>, required = <span class="keyword">false</span>, defaultValue = StringUtils.EMPTY)</span> String tenant,</span></span><br><span class="line"><span class="function">                             @<span class="title">RequestParam</span><span class="params">(value = <span class="string">"content"</span>)</span> String content,</span></span><br><span class="line"><span class="function">                             @<span class="title">RequestParam</span><span class="params">(value = <span class="string">"tag"</span>, required = <span class="keyword">false</span>)</span> String tag,</span></span><br><span class="line"><span class="function">                             @<span class="title">RequestParam</span><span class="params">(value = <span class="string">"appName"</span>, required = <span class="keyword">false</span>)</span> String appName,</span></span><br><span class="line"><span class="function">                             @<span class="title">RequestParam</span><span class="params">(value = <span class="string">"src_user"</span>, required = <span class="keyword">false</span>)</span> String srcUser,</span></span><br><span class="line"><span class="function">                             @<span class="title">RequestParam</span><span class="params">(value = <span class="string">"config_tags"</span>, required = <span class="keyword">false</span>)</span> String configTags,</span></span><br><span class="line"><span class="function">                             @<span class="title">RequestParam</span><span class="params">(value = <span class="string">"desc"</span>, required = <span class="keyword">false</span>)</span> String desc,</span></span><br><span class="line"><span class="function">                             @<span class="title">RequestParam</span><span class="params">(value = <span class="string">"use"</span>, required = <span class="keyword">false</span>)</span> String use,</span></span><br><span class="line"><span class="function">                             @<span class="title">RequestParam</span><span class="params">(value = <span class="string">"effect"</span>, required = <span class="keyword">false</span>)</span> String effect,</span></span><br><span class="line"><span class="function">                             @<span class="title">RequestParam</span><span class="params">(value = <span class="string">"type"</span>, required = <span class="keyword">false</span>)</span> String type,</span></span><br><span class="line"><span class="function">                             @<span class="title">RequestParam</span><span class="params">(value = <span class="string">"schema"</span>, required = <span class="keyword">false</span>)</span> String schema)</span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> NacosException </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(betaIps)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(tag)) &#123;</span><br><span class="line">            persistService.insertOrUpdate(srcIp, srcUser, configInfo, time, configAdvanceInfo, <span class="keyword">true</span>);</span><br><span class="line">            ConfigChangePublisher.notifyConfigChange(<span class="keyword">new</span> ConfigDataChangeEvent(<span class="keyword">false</span>, dataId, group, tenant, time.getTime()));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用外置的持久化就不需要Raft协议维护一致性了，处理会简单很多。</p>
<p>ExternalStoragePersistServiceImpl#insertOrUpdate</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertOrUpdate</span><span class="params">(String srcIp, String srcUser,</span></span></span><br><span class="line"><span class="function"><span class="params">                           ConfigInfo configInfo, Timestamp time, Map&lt;String, Object&gt; configAdvanceInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">                           <span class="keyword">boolean</span> notify)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 事务相关的处理交给了AOP</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 先尝试插入</span></span><br><span class="line">        addConfigInfo(srcIp, srcUser, configInfo, time, configAdvanceInfo, notify);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (DataIntegrityViolationException ive) &#123; <span class="comment">// 唯一性约束冲突</span></span><br><span class="line">        <span class="comment">// 插入失败那就是更新了</span></span><br><span class="line">        updateConfigInfo(configInfo, srcIp, srcUser, time, configAdvanceInfo, notify);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>CapacityManagementAspect#aroundSyncUpdateConfigAll</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Around</span>(SYNC_UPDATE_CONFIG_ALL)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">aroundSyncUpdateConfigAll</span><span class="params">(ProceedingJoinPoint pjp, HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">                                        HttpServletResponse response, String dataId, String group, String content,</span></span></span><br><span class="line"><span class="function"><span class="params">                                        String appName, String srcUser, String tenant, String tag)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    <span class="comment">// 如果没开始容量管理就直接放行</span></span><br><span class="line">    <span class="keyword">if</span> (!PropertyUtil.isManageCapacity()) &#123;</span><br><span class="line">        <span class="keyword">return</span> pjp.proceed();</span><br><span class="line">    &#125;</span><br><span class="line">    String betaIps = request.getHeader(<span class="string">"betaIps"</span>);</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(betaIps)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(tag)) &#123;</span><br><span class="line">            <span class="comment">// 只对写入或更新config_info表的做容量管理的限制检验</span></span><br><span class="line">            <span class="keyword">if</span> (persistService.findConfigInfo(dataId, group, tenant) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 写入操作</span></span><br><span class="line">                <span class="keyword">return</span> do4Insert(pjp, request, response, group, tenant, content);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 更新操作</span></span><br><span class="line">            <span class="keyword">return</span> do4Update(pjp, request, response, dataId, group, tenant, content);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> pjp.proceed();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>CapacityManagementAspect#do4Insert</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">do4Insert</span><span class="params">(ProceedingJoinPoint pjp, HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">                         HttpServletResponse response, String group, String tenant, String content)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    CounterMode counterMode = CounterMode.INCREMENT;</span><br><span class="line">    <span class="keyword">boolean</span> hasTenant = hasTenant(tenant);</span><br><span class="line">    <span class="keyword">if</span> (PropertyUtil.isCapacityLimitCheck()) &#123;</span><br><span class="line">        <span class="comment">// 先写入或更新：usage + 1</span></span><br><span class="line">        LimitType limitType = getLimitType(counterMode, group, tenant, content, hasTenant);</span><br><span class="line">        <span class="keyword">if</span> (limitType != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> response4Limit(request, response, limitType);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 先写入或更新：usage + 1</span></span><br><span class="line">        insertOrUpdateUsage(group, tenant, counterMode, hasTenant);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> getResult(pjp, response, group, tenant, counterMode, hasTenant);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>CapacityManagementAspect#getResult</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">getResult</span><span class="params">(ProceedingJoinPoint pjp, HttpServletResponse response, String group, String tenant,</span></span></span><br><span class="line"><span class="function"><span class="params">                         CounterMode counterMode, <span class="keyword">boolean</span> hasTenant)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 执行实际操作</span></span><br><span class="line">        Object result = pjp.proceed();</span><br><span class="line">        <span class="comment">// 根据执行结果判定是否需要回滚，这个回滚不依赖数据库事务，而是手动的消除，加一的回滚就是减一</span></span><br><span class="line">        doResult(counterMode, response, group, tenant, result, hasTenant);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">        rollback(counterMode, group, tenant, hasTenant);</span><br><span class="line">        <span class="keyword">throw</span> throwable;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>更新完后触发监听回调。</p>
<p>AsyncNotifyService#onEvent</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEvent</span><span class="params">(Event event)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 并发产生 ConfigDataChangeEvent</span></span><br><span class="line">    <span class="keyword">if</span> (event <span class="keyword">instanceof</span> ConfigDataChangeEvent) &#123;</span><br><span class="line">        ConfigDataChangeEvent evt = (ConfigDataChangeEvent) event;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        Collection&lt;Member&gt; ipList = memberManager.allMembers();</span><br><span class="line">        Queue&lt;NotifySingleTask&gt; queue = <span class="keyword">new</span> LinkedList&lt;NotifySingleTask&gt;();</span><br><span class="line">        <span class="comment">// 每个Server节点都要通知</span></span><br><span class="line">        <span class="keyword">for</span> (Member member : ipList) &#123;</span><br><span class="line">            queue.add(<span class="keyword">new</span> NotifySingleTask(dataId, group, tenant, tag, dumpTs, member.getAddress(), evt.isBeta));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 提交任务</span></span><br><span class="line">        EXECUTOR.execute(<span class="keyword">new</span> AsyncTask(httpclient, queue));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>AsyncNotifyService$AsyncTask#executeAsyncInvoke</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">executeAsyncInvoke</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (!queue.isEmpty()) &#123;</span><br><span class="line">        NotifySingleTask task = queue.poll();</span><br><span class="line">        String targetIp = task.getTargetIP();</span><br><span class="line">        <span class="keyword">if</span> (memberManager.hasMember(targetIp)) &#123;</span><br><span class="line">            <span class="comment">// 启动健康检查且有不监控的ip则直接把放到通知队列，否则通知</span></span><br><span class="line">            <span class="keyword">boolean</span> unHealthNeedDelay = memberManager.isUnHealth(targetIp);</span><br><span class="line">            <span class="keyword">if</span> (unHealthNeedDelay) &#123;</span><br><span class="line">                <span class="comment">// target ip 不健康，则放入通知列表中</span></span><br><span class="line">                ConfigTraceService.logNotifyEvent(task.getDataId(), task.getGroup(),</span><br><span class="line">                                task.getTenant(), <span class="keyword">null</span>, task.getLastModified(),</span><br><span class="line">                                InetUtils.getSelfIp(),</span><br><span class="line">                                ConfigTraceService.NOTIFY_EVENT_UNHEALTH, <span class="number">0</span>,</span><br><span class="line">                                task.target);</span><br><span class="line">                <span class="comment">// get delay time and set fail count to the task</span></span><br><span class="line">                asyncTaskExecute(task);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                HttpGet request = <span class="keyword">new</span> HttpGet(task.url);</span><br><span class="line">                <span class="comment">// ...</span></span><br><span class="line">                httpclient.execute(request, <span class="keyword">new</span> AsyncNotifyCallBack(httpclient, task));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>CommunicationController#notifyConfigInfo</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/dataChange"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Boolean <span class="title">notifyConfigInfo</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">                                @RequestParam(<span class="string">"dataId"</span>)</span> String dataId, @<span class="title">RequestParam</span><span class="params">(<span class="string">"group"</span>)</span> String group,</span></span><br><span class="line"><span class="function">                                @<span class="title">RequestParam</span><span class="params">(value = <span class="string">"tenant"</span>, required = <span class="keyword">false</span>, defaultValue = StringUtils.EMPTY)</span> String tenant,</span></span><br><span class="line"><span class="function">                                @<span class="title">RequestParam</span><span class="params">(value = <span class="string">"tag"</span>, required = <span class="keyword">false</span>)</span> String tag) </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isNotBlank(isBetaStr) &amp;&amp; trueStr.equals(isBetaStr)) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        dumpService.dump(dataId, group, tenant, tag, lastModifiedTs, handleIp);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>DumpProcessor#process</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(String taskType, AbstractTask task)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> PersistService persistService = dumpService.getPersistService();</span><br><span class="line">    DumpTask dumpTask = (DumpTask) task;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    ConfigDumpEvent.ConfigDumpEventBuilder build = <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isBeta) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(tag)) &#123;</span><br><span class="line">            <span class="comment">//  先查询</span></span><br><span class="line">            ConfigInfo cf = persistService.findConfigInfo(dataId, group, tenant);</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">            <span class="comment">// 更新缓存</span></span><br><span class="line">            <span class="keyword">return</span> DumpConfigHandler.configDump(build.build());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>DumpConfigHandler#configDump</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">configDump</span><span class="params">(ConfigDumpEvent event)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> (event.isBeta()) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(event.getTag())) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">boolean</span> result;</span><br><span class="line">        <span class="keyword">if</span> (!event.isRemove()) &#123;</span><br><span class="line">            result = ConfigCacheService.dump(dataId, group, namespaceId, content, lastModified, type);</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ConfigCacheService#dump</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dump</span><span class="params">(String dataId, String group, String tenant, String content, <span class="keyword">long</span> lastModifiedTs, String type)</span> </span>&#123;</span><br><span class="line">    String groupKey = GroupKey2.getKey(dataId, group, tenant);</span><br><span class="line">    <span class="comment">// 先保证创建缓存</span></span><br><span class="line">    CacheItem ci = makeSure(groupKey);</span><br><span class="line">    <span class="comment">// 先获取读锁</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> lockResult = tryWriteLock(groupKey);</span><br><span class="line">    <span class="keyword">assert</span> (lockResult != <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 获取读锁失败</span></span><br><span class="line">    <span class="keyword">if</span> (lockResult &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 先计算MD5</span></span><br><span class="line">        <span class="keyword">final</span> String md5 = MD5Utils.md5Hex(content, Constants.ENCODE);</span><br><span class="line">        <span class="comment">// 没变化，忽略</span></span><br><span class="line">        <span class="keyword">if</span> (md5.equals(ConfigCacheService.getContentMd5(groupKey))) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!PropertyUtil.isDirectRead()) &#123;</span><br><span class="line">            <span class="comment">// 本地文件持久化，这是为了降低读压力</span></span><br><span class="line">            DiskUtil.saveToDisk(dataId, group, tenant, content);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 更新本地缓存的MD5，同时触发LocalDataChangeEvent</span></span><br><span class="line">        updateMd5(groupKey, md5, lastModifiedTs);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        releaseWriteLock(groupKey);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p>ConfigServletInner#doGetConfig</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">doGetConfig</span><span class="params">(HttpServletRequest request, HttpServletResponse response, String dataId, String group,</span></span></span><br><span class="line"><span class="function"><span class="params">                          String tenant, String tag, String clientIp)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 获取读锁，包装了简单的重试，锁的粒度为GroupKey</span></span><br><span class="line">    <span class="keyword">int</span> lockResult = tryConfigReadLock(groupKey);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 获取锁成功</span></span><br><span class="line">    <span class="keyword">if</span> (lockResult &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        FileInputStream fis = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">            <span class="comment">// 获取读锁后才能读缓存</span></span><br><span class="line">            CacheItem cacheItem = ConfigCacheService.getContentCache(groupKey);</span><br><span class="line">            <span class="keyword">if</span> (cacheItem != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// ...</span></span><br><span class="line">            &#125;</span><br><span class="line">            File file = <span class="keyword">null</span>;</span><br><span class="line">            ConfigInfoBase configInfoBase = <span class="keyword">null</span>;</span><br><span class="line">            PrintWriter out = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (isBeta) &#123;</span><br><span class="line">                <span class="comment">// ...</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (StringUtils.isBlank(tag)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (isUseTag(cacheItem, autoTag)) &#123;</span><br><span class="line">                        <span class="comment">// ...</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        md5 = cacheItem.getMd5();</span><br><span class="line">                        lastModified = cacheItem.getLastModifiedTs();</span><br><span class="line">                        <span class="keyword">if</span> (PropertyUtil.isDirectRead()) &#123;</span><br><span class="line">                            <span class="comment">// 直接读</span></span><br><span class="line">                            configInfoBase = persistService.findConfigInfo(dataId, group, tenant);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="comment">// 读本地文件</span></span><br><span class="line">                            file = DiskUtil.targetFile(dataId, group, tenant);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (configInfoBase == <span class="keyword">null</span> &amp;&amp; fileNotExist(file)) &#123;</span><br><span class="line">                            <span class="comment">// ...</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// ...</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (lockResult == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> HttpServletResponse.SC_OK + <span class="string">""</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>OK，所以不管是Naming或者Config，其实都不是严格的CP，先不说客户端和服务端的缓存，ConfigServer这里更新了配置后，通知其它Server是异步的，也就是说，一个线程更新成功返回后，不保证可以读到自己更新的数据（虽然每次都会从同一个Server读，但是假如该Server宕机了，那就会FailOver到其它Server了）。</p>
<hr>
<p>ConfigServletInner#doPollingConfig</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">doPollingConfig</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span></span><br><span class="line"><span class="function"><span class="params">                              Map&lt;String, String&gt; clientMd5Map, <span class="keyword">int</span> probeRequestSize)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// 长轮询</span></span><br><span class="line">    <span class="keyword">if</span> (LongPollingService.isSupportLongPolling(request)) &#123;</span><br><span class="line">        longPollingService.addLongPollingClient(request, response, clientMd5Map, probeRequestSize);</span><br><span class="line">        <span class="keyword">return</span> HttpServletResponse.SC_OK + <span class="string">""</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// else 兼容短轮询逻辑，通过对比MD5判断是否发生了改变</span></span><br><span class="line">    List&lt;String&gt; changedGroups = MD5Util.compareMd5(request, response, clientMd5Map);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">return</span> HttpServletResponse.SC_OK + <span class="string">""</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ConfigServletInner#addLongPollingClient</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addLongPollingClient</span><span class="params">(HttpServletRequest req, HttpServletResponse rsp, Map&lt;String, String&gt; clientMd5Map,</span></span></span><br><span class="line"><span class="function"><span class="params">                                 <span class="keyword">int</span> probeRequestSize)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 提前500ms返回响应，为避免客户端超时 <span class="doctag">@qiaoyi</span>.dingqy 2013.10.22改动  add delay time for LoadBalance</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">long</span> timeout = Math.max(<span class="number">10000</span>, Long.parseLong(str) - delayTime);</span><br><span class="line">    <span class="keyword">if</span> (isFixedPolling()) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">        <span class="comment">//  对比MD5</span></span><br><span class="line">        List&lt;String&gt; changedGroups = MD5Util.compareMd5(req, rsp, clientMd5Map);</span><br><span class="line">        <span class="comment">// 配置发生了变化</span></span><br><span class="line">        <span class="keyword">if</span> (changedGroups.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            generateResponse(req, rsp, changedGroups);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (noHangUpFlag != <span class="keyword">null</span> &amp;&amp; noHangUpFlag.equalsIgnoreCase(TRUE_STR)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    String ip = RequestUtil.getRemoteIp(req);</span><br><span class="line">    <span class="comment">// 一定要由HTTP线程调用，否则离开后容器会立即发送响应</span></span><br><span class="line">    <span class="keyword">final</span> AsyncContext asyncContext = req.startAsync();</span><br><span class="line">    <span class="comment">// AsyncContext.setTimeout()的超时时间不准，所以只能自己控制</span></span><br><span class="line">    asyncContext.setTimeout(<span class="number">0L</span>);</span><br><span class="line">    <span class="comment">// 传入了异步Servlet上下文</span></span><br><span class="line">    scheduler.execute(<span class="keyword">new</span> ClientLongPolling(asyncContext, clientMd5Map, ip, probeRequestSize, timeout, appName, tag));</span><br><span class="line">    <span class="comment">// 这里Servlet线程直接返回</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以这里使用的是异步Servlet处理长轮询，不然工作线程很快就会被占满然后拒绝服务。</p>
<p>LongPollingService$ClientLongPolling#run</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 超时后执行</span></span><br><span class="line">    asyncTimeoutFuture = scheduler.schedule(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                getRetainIps().put(ClientLongPolling.<span class="keyword">this</span>.ip, System.currentTimeMillis());</span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * 删除订阅关系</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                allSubs.remove(ClientLongPolling.<span class="keyword">this</span>);</span><br><span class="line">                <span class="keyword">if</span> (isFixedPolling()) &#123;</span><br><span class="line">                    <span class="comment">// ...</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    sendResponse(<span class="keyword">null</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                <span class="comment">// ...</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, timeoutTime, TimeUnit.MILLISECONDS);</span><br><span class="line">    <span class="comment">// 加入订阅</span></span><br><span class="line">    allSubs.add(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>LongPollingService#onEvent</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEvent</span><span class="params">(Event event)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (isFixedPolling()) &#123;</span><br><span class="line">        <span class="comment">// ignore</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (event <span class="keyword">instanceof</span> LocalDataChangeEvent) &#123;</span><br><span class="line">            LocalDataChangeEvent evt = (LocalDataChangeEvent) event;</span><br><span class="line">            scheduler.execute(<span class="keyword">new</span> DataChangeTask(evt.groupKey, evt.isBeta, evt.betaIps));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>LongPollingService$DataChangeTask#run</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ConfigCacheService.getContentBetaMd5(groupKey);</span><br><span class="line">        <span class="comment">// 遍历订阅</span></span><br><span class="line">        <span class="keyword">for</span> (Iterator&lt;ClientLongPolling&gt; iter = allSubs.iterator(); iter.hasNext(); ) &#123;</span><br><span class="line">            ClientLongPolling clientSub = iter.next();</span><br><span class="line">            <span class="keyword">if</span> (clientSub.clientMd5Map.containsKey(groupKey)) &#123;</span><br><span class="line">                <span class="comment">// ...</span></span><br><span class="line">                getRetainIps().put(clientSub.ip, System.currentTimeMillis());</span><br><span class="line">                iter.remove(); <span class="comment">// 删除订阅关系</span></span><br><span class="line">                <span class="comment">// ...</span></span><br><span class="line">                <span class="comment">// 执行回调</span></span><br><span class="line">                clientSub.sendResponse(Arrays.asList(groupKey));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>完。</p>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


		<footer>
			 
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

		</footer>
	</div>
	<!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->

	<script>var timeEnd = new Date();console.log('耗时：' + (timeEnd - timeStart));</script>
	<!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
	<!-- material design -->
	<!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
	<!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
	<!-- toc -->
	<!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
	<!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
	<!-- <script src="/js/main.js"></script> -->
</body>
</html>
