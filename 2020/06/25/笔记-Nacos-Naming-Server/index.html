<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
        <script>
            var timeStart = new Date();
        </script>
        
        <title>[ç¬”è®°]-Nacos-Naming-Server | ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜</title>
        
        <meta name="author" content="huangzhike">
        
        
        <meta name="description" content="NacosæœåŠ¡å™¨å°±æ˜¯HTTPæœåŠ¡å™¨ï¼ŒåŸºæœ¬éƒ½æ˜¯Restfulé£æ ¼ï¼Œä¸€äº›æ§åˆ¶éƒ½æ˜¯é€šè¿‡Filterå®ç°çš„ã€‚
AuthFilterï¼šæ‹¦æˆªè¢«@Securedæ³¨è§£çš„Controlleræ–¹æ³•ï¼Œæƒé™æ§åˆ¶ä¹Ÿæ˜¯åŸºäºRole-Permissionæ¨¡å‹ã€‚
TrafficReviseFilterï¼šæ ¹æ®è¯·æ±‚çš„URIå’Œå½“å‰æœåŠ¡å™¨">
        
        
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        
        <meta property="og:title" content="[ç¬”è®°]-Nacos-Naming-Server"/>
        
        <meta property="og:site_name" content="ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜"/>
        
        
        <!-- favicon -->
        <link rel="icon" type="image/ico" href="/ok.ico" sizes="32x32">
        <meta name="msapplication-TileColor" content="#009688">
        <meta name="msapplication-TileImage" content="/mstile-144x144.ico">
        <meta name="theme-color" content="#009688">
        <!-- favicon end -->
        <!-- <link href="//ok.ico" rel="icon"> -->
        
        <!-- toc -->
        <!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
        <!-- material design -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
        <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
        
        <!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
        <!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
    <meta name="generator" content="Hexo 4.2.1"></head>

<body>
    <nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">èœå•</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" title="ä¸‹ä¸€å¥æ˜¯ï¼šå®¢æœ‰å¯äººæœŸä¸æ¥ã€‚å°æ—¶å€™ï¼Œå–œæ¬¢é åœ¨é˜³å°ä¸Šï¼Œä¸€è¾¹å¹é£ï¼Œä¸€è¾¹çœ‹ä¹¦ï¼Œå–œæ¬¢è¯»ä¹¦å—ï¼Œéªšå¹´ï¼Ÿ" href="/">ä¹¦å½“å¿«æ„è¯»æ˜“å°½</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" target="_blank" rel="noopener" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

    <div class="container" >
        <div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[ç¬”è®°]-Nacos-Naming-Server</h2>
				
				<div>
					<div class="post-time">2020-06-25</div>
				</div>
				
				<div class="article-content">
				<p>NacosæœåŠ¡å™¨å°±æ˜¯HTTPæœåŠ¡å™¨ï¼ŒåŸºæœ¬éƒ½æ˜¯Restfulé£æ ¼ï¼Œä¸€äº›æ§åˆ¶éƒ½æ˜¯é€šè¿‡Filterå®ç°çš„ã€‚</p>
<p>AuthFilterï¼šæ‹¦æˆªè¢«@Securedæ³¨è§£çš„Controlleræ–¹æ³•ï¼Œæƒé™æ§åˆ¶ä¹Ÿæ˜¯åŸºäºRole-Permissionæ¨¡å‹ã€‚</p>
<p>TrafficReviseFilterï¼šæ ¹æ®è¯·æ±‚çš„URIå’Œå½“å‰æœåŠ¡å™¨çš„çŠ¶æ€è¿›è¡Œé™æµã€‚</p>
<p>DistroFilterï¼šæ‹¦æˆªè¢«@CanDistroæ³¨è§£çš„æ–¹æ³•ï¼Œç®€å•çš„è¯´ï¼Œå°±æ˜¯ä¸€ä¸ªæœåŠ¡å¯¹åº”çš„äº‹ä»¶äº¤ç»™ç‰¹å®šçš„æœåŠ¡å™¨å¤„ç†ï¼Œå¦‚æœæœåŠ¡å™¨æ¥æ”¶åˆ°äº†ä¸å±äºåˆ†é…ç»™è‡ªå·±çš„æœåŠ¡çš„å¤„ç†è¯·æ±‚ï¼Œå°±è½¬å‘ç»™å¯¹åº”çš„çš„Serverå¤„ç†å†è¿”å›ç»“æœã€‚</p>
<p>åŸç†ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯æœåŠ¡åçš„å“ˆå¸Œå€¼å¯¹æœåŠ¡å™¨æ•°é‡å–æ¨¡ã€‚</p>
<p>ä¸è¿‡è¿™ä¸ªæœåŠ¡å™¨é›†ç¾¤çš„åˆ—è¡¨çš„ä¸€è‡´æ€§å¹¶ä¸ä¸¥æ ¼ã€‚</p>
<hr>
<ul>
<li>ApiControllerï¼šå·²åºŸå¼ƒï¼›</li>
<li>CatalogControllerï¼šè·å–æœåŠ¡ç›¸å…³çš„ä¿¡æ¯ï¼›</li>
<li>ClusterControllerï¼šæ›´æ–°æŸæœåŠ¡ä¸‹çš„é›†ç¾¤ä¿¡æ¯ï¼›</li>
<li>DistroControllerï¼šä¸€ä¸ªServeråªè´Ÿè´£éƒ¨åˆ†æœåŠ¡ï¼Œæ‰€ä»¥éœ€è¦åŒæ­¥æ‰èƒ½è·å–å®Œæ•´çš„ä¿¡æ¯ï¼›</li>
<li>HealthControllerï¼šæœåŠ¡ç«¯ä¸»åŠ¨çš„å¥åº·æ£€æŸ¥ç›¸å…³æ“ä½œæ¥å£ï¼›</li>
<li>InstanceControllerï¼šæœåŠ¡å®ä¾‹ç›¸å…³ï¼Œæ³¨å†Œã€è·å–æœåŠ¡å®ä¾‹ï¼Œå¤„ç†å®ä¾‹å¿ƒè·³ç­‰ï¼›</li>
<li>OperatorControllerï¼šæ“ä½œã€ç»Ÿè®¡ã€çŠ¶æ€ç›¸å…³ï¼›</li>
<li>RaftControllerï¼šRaftåè®®ç›¸å…³é€šä¿¡æ¥å£ï¼Œä¸è¿‡Namingéƒ¨åˆ†çš„Raftå®ç°å¹¶ä¸ä¸¥æ ¼ï¼›</li>
<li>ServiceControllerï¼šæœåŠ¡ä¿¡æ¯æ“ä½œç›¸å…³çš„æ¥å£ï¼›</li>
</ul>
<hr>
<p>ServiceManager#init</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// æäº¤æœåŠ¡æŠ¥å‘Šçš„ä»»åŠ¡ï¼Œæ ¹æ®æœåŠ¡ä¿¡æ¯çš„æ ¡éªŒå’Œæ¥åˆ¤æ–­ä¸åŒæœåŠ¡å™¨é—´çš„ä¸ä¸€è‡´</span>
        UtilsAndCommons<span class="token punctuation">.</span>SERVICE_SYNCHRONIZATION_EXECUTOR<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ServiceReporter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">60000</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¤„ç†æ”¶åˆ°çš„æœåŠ¡æ ¡éªŒå’Œä¸ä¸€è‡´çš„æƒ…å†µ</span>
        UtilsAndCommons<span class="token punctuation">.</span>SERVICE_UPDATE_EXECUTOR<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UpdatedServiceProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>emptyServiceAutoClean<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å°†è‡ªå·±å½“åšå›è°ƒï¼Œå‘ä¸€è‡´æ€§æœåŠ¡æ³¨å†ŒæœåŠ¡å…ƒæ•°æ®å˜åŒ–äº‹ä»¶</span>
            consistencyService<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>KeyBuilder<span class="token punctuation">.</span>SERVICE_META_KEY_PREFIX<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NacosException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>ServiceManager$ServiceReporter#run</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æœ¬åœ°æ‰€æœ‰çš„æœåŠ¡ä¿¡æ¯</span>
                Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Set<span class="token operator">&lt;</span>String<span class="token operator">>></span> allServiceNames <span class="token operator">=</span> <span class="token function">getAllServiceNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ...</span>
                <span class="token comment" spellcheck="true">// ä»¥å‘½åç©ºé—´ä¸ºç»´åº¦</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>String namespaceId <span class="token operator">:</span> allServiceNames<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    ServiceChecksum checksum <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceChecksum</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// éå†è¯¥å‘½åç©ºé—´ä¸‹çš„æ‰€æœ‰æœåŠ¡</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span>String serviceName <span class="token operator">:</span> allServiceNames<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// è·³è¿‡ä¸å±äºè‡ªå·±è´Ÿè´£çš„æœåŠ¡</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>distroMapper<span class="token punctuation">.</span><span class="token function">responsible</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">continue</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment" spellcheck="true">// è·å–æœ¬åœ°çš„æœåŠ¡ä¿¡æ¯</span>
                        Service service <span class="token operator">=</span> <span class="token function">getService</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                        <span class="token comment" spellcheck="true">// è®¡ç®—Checksum</span>
                        service<span class="token punctuation">.</span><span class="token function">recalculateChecksum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// åŠ å…¥</span>
                        checksum<span class="token punctuation">.</span><span class="token function">addItem</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> service<span class="token punctuation">.</span><span class="token function">getChecksum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    Message msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    msg<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>JacksonUtils<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span>checksum<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// æ‰€æœ‰æœåŠ¡å™¨æˆå‘˜</span>
                    Collection<span class="token operator">&lt;</span>Member<span class="token operator">></span> sameSiteServers <span class="token operator">=</span> memberManager<span class="token punctuation">.</span><span class="token function">allMembers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token comment" spellcheck="true">// éå†æ‰€æœ‰æœåŠ¡å™¨æˆå‘˜</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span>Member server <span class="token operator">:</span> sameSiteServers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// è·³è¿‡è‡ªå·±</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>NetUtils<span class="token punctuation">.</span><span class="token function">localServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">continue</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment" spellcheck="true">// æŠ¥å‘ŠæœåŠ¡çš„æ ¡éªŒå’Œ</span>
                        synchronizer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// è®¡åˆ’ä¸‹ä¸€æ¬¡æŠ¥å‘Š</span>
                UtilsAndCommons<span class="token punctuation">.</span>SERVICE_SYNCHRONIZATION_EXECUTOR<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> switchDomain<span class="token punctuation">.</span><span class="token function">getServiceStatusSynchronizationPeriodMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span></code></pre>
<p>ServiceController#serviceStatus</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/status"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> String <span class="token function">serviceStatus</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>Map<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> entry <span class="token operator">:</span> checksums<span class="token punctuation">.</span>serviceName2Checksum<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
                <span class="token comment" spellcheck="true">// æœ¬åœ°çš„æœåŠ¡ä¿¡æ¯</span>
                Service service <span class="token operator">=</span> serviceManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span>checksums<span class="token punctuation">.</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ...</span>
                <span class="token comment" spellcheck="true">// è®¡ç®—æœ¬åœ°çš„æœåŠ¡çš„Checksum</span>
                service<span class="token punctuation">.</span><span class="token function">recalculateChecksum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// Checksumä¸ä¸€è‡´ï¼Œè¯´æ˜æœåŠ¡ä¿¡æ¯å¯èƒ½è½åäº†</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>checksum<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>service<span class="token punctuation">.</span><span class="token function">getChecksum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token comment" spellcheck="true">// æäº¤ä¸€ä¸ªæ›´æ–°ä»»åŠ¡</span>
                    serviceManager<span class="token punctuation">.</span><span class="token function">addUpdatedServiceToQueue</span><span class="token punctuation">(</span>checksums<span class="token punctuation">.</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">,</span> serverIp<span class="token punctuation">,</span> checksum<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ...</span>
    <span class="token punctuation">}</span></code></pre>
<p>ServiceManager#updatedHealthStatus</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updatedHealthStatus</span><span class="token punctuation">(</span>String namespaceId<span class="token punctuation">,</span> String serviceName<span class="token punctuation">,</span> String serverIP<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ä»å¯¹åº”çš„Serverè·å–å¯¹åº”çš„æœåŠ¡ä¿¡æ¯</span>
        Message msg <span class="token operator">=</span> synchronizer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>serverIP<span class="token punctuation">,</span> UtilsAndCommons<span class="token punctuation">.</span><span class="token function">assembleFullServiceName</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        JsonNode serviceJson <span class="token operator">=</span> JacksonUtils<span class="token punctuation">.</span><span class="token function">toObj</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æœåŠ¡å®ä¾‹çš„ä¿¡æ¯</span>
        ArrayNode ipList <span class="token operator">=</span> <span class="token punctuation">(</span>ArrayNode<span class="token punctuation">)</span> serviceJson<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"ips"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> ipsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>ipList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ipList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// æœ¬åœ°çš„æœåŠ¡ä¿¡æ¯</span>
        Service service <span class="token operator">=</span> <span class="token function">getService</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">boolean</span> changed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        List<span class="token operator">&lt;</span>Instance<span class="token operator">></span> instances <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token function">allIPs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>Instance instance <span class="token operator">:</span> instances<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è¯¥å®ä¾‹æ˜¯å¦å¥åº·</span>
            <span class="token keyword">boolean</span> valid <span class="token operator">=</span> Boolean<span class="token punctuation">.</span><span class="token function">parseBoolean</span><span class="token punctuation">(</span>ipsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token function">toIpAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>valid <span class="token operator">!=</span> instance<span class="token punctuation">.</span><span class="token function">isHealthy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                changed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                instance<span class="token punctuation">.</span><span class="token function">setHealthy</span><span class="token punctuation">(</span>valid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å‘ç”Ÿäº†å˜åŒ–</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>changed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            pushService<span class="token punctuation">.</span><span class="token function">serviceChanged</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span></code></pre>
<p>åŠ å…¥é˜»å¡é˜Ÿåˆ—ï¼Œçº¿ç¨‹å–å‡ºï¼Œæäº¤å¼‚æ­¥ä»»åŠ¡ï¼Œç„¶åè‡ªå·±å‘å¸ƒè‡ªå·±ç›‘å¬ã€‚</p>
<p>PushService#onApplicationEvent</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onApplicationEvent</span><span class="token punctuation">(</span>ServiceChangeEvent event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// æäº¤ä¸€ä¸ªå¼‚æ­¥æ›´æ–°ä»»åŠ¡</span>
        Future future <span class="token operator">=</span> udpSender<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// è·å–è¯¥æœåŠ¡ä¸‹çš„å®ä¾‹å¯¹åº”çš„å®¢æˆ·ç«¯ï¼Œè¯¥å®¢æˆ·ç«¯åœ¨é€šè¿‡InstanceController#listæ¥å£è·å–æœåŠ¡å®ä¾‹åˆ—è¡¨æ—¶åˆ›å»º</span>
                <span class="token comment" spellcheck="true">// ä¸»åŠ¨å‘å®¢æˆ·ç«¯æ¨é€æœåŠ¡å®ä¾‹çš„å˜åŒ–ï¼Œå³ä½¿è‡ªå·±ä¸è´Ÿè´£è¯¥æœåŠ¡ï¼Œåæ­£ä¹Ÿä¸ä¿è¯å¼ºä¸€è‡´æ€§</span>
                ConcurrentMap<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> PushClient<span class="token operator">></span> clients <span class="token operator">=</span> clientMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>UtilsAndCommons<span class="token punctuation">.</span><span class="token function">assembleFullServiceName</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ...</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>PushClient client <span class="token operator">:</span> clients<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">zombie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token comment" spellcheck="true">// å¤ç”¨ç¼“å­˜</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>switchDomain<span class="token punctuation">.</span><span class="token function">getDefaultPushCacheMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">20000</span> <span class="token operator">&amp;&amp;</span> cache<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>compressData <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        ackEntry <span class="token operator">=</span> <span class="token function">prepareAckEntry</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> compressData<span class="token punctuation">,</span> data<span class="token punctuation">,</span> lastRefTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// æ¶ˆæ¯åŒ…</span>
                        ackEntry <span class="token operator">=</span> <span class="token function">prepareAckEntry</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> <span class="token function">prepareHostsData</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">,</span> lastRefTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>ackEntry <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">org<span class="token punctuation">.</span>javatuples<span class="token punctuation">.</span>Pair</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>ackEntry<span class="token punctuation">.</span>origin<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ackEntry<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token comment" spellcheck="true">// UDPå‘é€æ¶ˆæ¯</span>
                    <span class="token function">udpPush</span><span class="token punctuation">(</span>ackEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æ›´æ–°å®Œç§»é™¤</span>
                futureMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>UtilsAndCommons<span class="token punctuation">.</span><span class="token function">assembleFullServiceName</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ ‡è®°ä¸ºæ›´æ–°ä¸­</span>
        futureMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>UtilsAndCommons<span class="token punctuation">.</span><span class="token function">assembleFullServiceName</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">,</span> future<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>PushService#udpPush</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">static</span> Receiver<span class="token punctuation">.</span>AckEntry <span class="token function">udpPush</span><span class="token punctuation">(</span>Receiver<span class="token punctuation">.</span>AckEntry ackEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// é‡ä¼ æ¬¡æ•°è¿‡å¤š</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ackEntry<span class="token punctuation">.</span><span class="token function">getRetryTimes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> MAX_RETRY_TIMES<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ä¸å†ç®¡å®ƒäº†</span>
            ackMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>ackEntry<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            udpSendTimeMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>ackEntry<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            failedPush <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> ackEntry<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// å¾…åº”ç­”</span>
            ackMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>ackEntry<span class="token punctuation">.</span>key<span class="token punctuation">,</span> ackEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
            udpSendTimeMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>ackEntry<span class="token punctuation">.</span>key<span class="token punctuation">,</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// å‘é€</span>
            udpSocket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>ackEntry<span class="token punctuation">.</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ackEntry<span class="token punctuation">.</span><span class="token function">increaseRetryTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è®¡åˆ’é‡ä¼ </span>
            executorService<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Retransmitter</span><span class="token punctuation">(</span>ackEntry<span class="token punctuation">)</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>NANOSECONDS<span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span>ACK_TIMEOUT_NANOS<span class="token punctuation">)</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> ackEntry<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>è¿™ä¸ªç±»æ®è¯´1.3.0åè¦è¢«ç§»é™¤äº†ã€‚</p>
<p>ServerListManager#init</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// æäº¤å¹¿æ’­æ›´æ–°æœåŠ¡å™¨çŠ¶æ€çš„ä»»åŠ¡</span>
        GlobalExecutor<span class="token punctuation">.</span><span class="token function">registerServerStatusReporter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ServerStatusReporter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æäº¤ä¸»åŠ¨æ›´æ–°æˆå‘˜çŠ¶æ€çš„ä»»åŠ¡</span>
        GlobalExecutor<span class="token punctuation">.</span><span class="token function">registerServerInfoUpdater</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ServerInfoUpdater</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ServerListManager$ServerStatusReporter#run</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
                List<span class="token operator">&lt;</span>Member<span class="token operator">></span> allServers <span class="token operator">=</span> <span class="token function">getServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// æœåŠ¡å™¨åˆ—è¡¨ä¸åŒ…å«è‡ªå·±ï¼Œä½ å·²ç»è¢«å¼€é™¤äº†</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">contains</span><span class="token punctuation">(</span>ApplicationUtils<span class="token punctuation">.</span><span class="token function">getLocalAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>allServers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>ApplicationUtils<span class="token punctuation">.</span><span class="token function">getLocalAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>UtilsAndCommons<span class="token punctuation">.</span>LOCAL_HOST_IP<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// éå†æˆå‘˜æœåŠ¡å™¨</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span>Member server <span class="token operator">:</span> allServers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// è·³è¿‡è‡ªå·±</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>Objects<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ApplicationUtils<span class="token punctuation">.</span><span class="token function">getLocalAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">continue</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                        Message msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        msg<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// å‘åˆ«çš„æœåŠ¡å™¨æ›´æ–°è‡ªå·±çš„çŠ¶æ€</span>
                        synchronizer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// è®¡åˆ’ä¸‹ä¸€æ¬¡</span>
                GlobalExecutor<span class="token punctuation">.</span><span class="token function">registerServerStatusReporter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> switchDomain<span class="token punctuation">.</span><span class="token function">getServerStatusSynchronizationPeriodMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span></code></pre>
<p>ServerListManager#onReceiveServerStatus</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">onReceiveServerStatus</span><span class="token punctuation">(</span>String configInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>String config <span class="token operator">:</span> configs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// site:ip:lastReportTime:weight</span>
            String<span class="token punctuation">[</span><span class="token punctuation">]</span> params <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"#"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// æ‰¾åˆ°è¯¥Serveræˆå‘˜</span>
            Member server <span class="token operator">=</span> Optional<span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>memberManager<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>params<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span>Member<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ip</span><span class="token punctuation">(</span>params<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>UtilsAndCommons<span class="token punctuation">.</span>IP_PORT_SPLITER<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span>NodeState<span class="token punctuation">.</span>UP<span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">port</span><span class="token punctuation">(</span>Integer<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>params<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>UtilsAndCommons<span class="token punctuation">.</span>IP_PORT_SPLITER<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            server<span class="token punctuation">.</span><span class="token function">setExtendVal</span><span class="token punctuation">(</span>MemberMetaDataConstants<span class="token punctuation">.</span>SITE_KEY<span class="token punctuation">,</span> params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            server<span class="token punctuation">.</span><span class="token function">setExtendVal</span><span class="token punctuation">(</span>MemberMetaDataConstants<span class="token punctuation">.</span>WEIGHT<span class="token punctuation">,</span> params<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">4</span> <span class="token operator">?</span> Integer<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>params<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ›´æ–°å®ƒ</span>
            memberManager<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>ServerMemberManager#update</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">update</span><span class="token punctuation">(</span>Member newMember<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// æ›´æ–°</span>
        serverList<span class="token punctuation">.</span><span class="token function">computeIfPresent</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> <span class="token punctuation">(</span>s<span class="token punctuation">,</span> member<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>NodeState<span class="token punctuation">.</span>DOWN<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>newMember<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                memberAddressInfos<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>newMember<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            MemberUtils<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>newMember<span class="token punctuation">,</span> member<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> member<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å‘å¸ƒæˆå‘˜å˜åŒ–äº‹ä»¶</span>
        NotifyCenter<span class="token punctuation">.</span><span class="token function">publishEvent</span><span class="token punctuation">(</span>MembersChangeEvent<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">members</span><span class="token punctuation">(</span><span class="token function">allMembers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>æœ‰ç‚¹èŠ±é‡Œèƒ¡å“¨ï¼Œè®¾è®¡è¿‡åº¦ã€‚æˆ‘çœç•¥äº†ä¸€äº›ä»£ç ã€‚</p>
<p>ServerListManager#onEvent</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onEvent</span><span class="token punctuation">(</span>MembersChangeEvent event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>servers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getMembers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ServerListManager$ServerInfoUpdater#run</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            List<span class="token operator">&lt;</span>Member<span class="token operator">></span> members <span class="token operator">=</span> servers<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// å–æ¨¡è½®è¯¢æœåŠ¡å™¨</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>cursor <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cursor <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> members<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Member target <span class="token operator">=</span> members<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cursor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                String content <span class="token operator">=</span> NamingProxy<span class="token punctuation">.</span><span class="token function">reqCommon</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> params<span class="token punctuation">,</span> server<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>StringUtils<span class="token punctuation">.</span>EMPTY<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    RaftPeer raftPeer <span class="token operator">=</span> JacksonUtils<span class="token punctuation">.</span><span class="token function">toObj</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> RaftPeer<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">!=</span> raftPeer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                        <span class="token comment" spellcheck="true">// ä¸»åŠ¨æ›´æ–°</span>
                        memberManager<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ignore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">//</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span></code></pre>
<p>ServerMemberManagerè¿˜æœ‰ä¸€ä¸ªä¸»åŠ¨æ‹‰å–æ›´æ–°æœåŠ¡å™¨é…ç½®åˆ—è¡¨çš„åŠŸèƒ½ã€‚</p>
<p>ServerMemberManager#initAndStartLookup</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initAndStartLookup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> NacosException <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>lookup <span class="token operator">=</span> LookupFactory<span class="token punctuation">.</span><span class="token function">createLookUp</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>lookup<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<ul>
<li><p>StandaloneMemberLookupï¼šå•æœºï¼›</p>
</li>
<li><p>FileConfigMemberLookupï¼šä»é…ç½®æ–‡ä»¶æ›´æ–°ï¼›</p>
</li>
<li><p>AddressServerMemberLookupï¼šä»åœ°å€æœåŠ¡å™¨æ›´æ–°ï¼›</p>
</li>
</ul>
<p>ä¸‰ç§æ–¹å¼å®šæœŸæ›´æ–°æœåŠ¡å™¨åˆ—è¡¨ã€‚</p>
<hr>
<p>ServiceManager#registerInstance</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerInstance</span><span class="token punctuation">(</span>String namespaceId<span class="token punctuation">,</span> String serviceName<span class="token punctuation">,</span> Instance instance<span class="token punctuation">)</span> <span class="token keyword">throws</span> NacosException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// åˆ›å»ºæœåŠ¡ï¼Œå¦‚æœå¯¹åº”çš„æœåŠ¡ä¸å­˜åœ¨</span>
        <span class="token function">createEmptyService</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">,</span> instance<span class="token punctuation">.</span><span class="token function">isEphemeral</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Service service <span class="token operator">=</span> <span class="token function">getService</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// æ³¨å†Œå®ä¾‹</span>
        <span class="token function">addInstance</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">,</span> instance<span class="token punctuation">.</span><span class="token function">isEphemeral</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ServiceManager#createEmptyService</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createServiceIfAbsent</span><span class="token punctuation">(</span>String namespaceId<span class="token punctuation">,</span> String serviceName<span class="token punctuation">,</span> <span class="token keyword">boolean</span> local<span class="token punctuation">,</span> Cluster cluster<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> NacosException <span class="token punctuation">{</span>
        Service service <span class="token operator">=</span> <span class="token function">getService</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>service <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            service <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Service</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ...</span>
            service<span class="token punctuation">.</span><span class="token function">recalculateChecksum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cluster <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                cluster<span class="token punctuation">.</span><span class="token function">setService</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
                service<span class="token punctuation">.</span><span class="token function">getClusterMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cluster<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cluster<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            service<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// åˆå§‹åŒ–</span>
            <span class="token function">putServiceAndInit</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æŒä¹…åŒ–ç±»å‹çš„å®ä¾‹</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>local<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">addOrReplaceService</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>å±‚çº§ç»“æ„ä¸ºService-Cluster-Instanceã€‚</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">putServiceAndInit</span><span class="token punctuation">(</span>Service service<span class="token punctuation">)</span> <span class="token keyword">throws</span> NacosException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// åŠ å…¥æœ¬åœ°ç¼“å­˜ï¼ŒåŒé‡æ£€æµ‹åŠ é”ä¿è¯çº¿ç¨‹å®‰å…¨</span>
        <span class="token function">putService</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// åˆå§‹åŒ–</span>
        service<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å‘ä¸€è‡´æ€§æœåŠ¡æ³¨å†Œäº‹ä»¶å›è°ƒï¼Œæœ‰å˜åŒ–æ—¶ä¼šè‡ªåŠ¨æ›´æ–°</span>
        consistencyService<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>KeyBuilder<span class="token punctuation">.</span><span class="token function">buildInstanceListKey</span><span class="token punctuation">(</span>service<span class="token punctuation">.</span><span class="token function">getNamespaceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> service<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span> service<span class="token punctuation">)</span><span class="token punctuation">;</span>
        consistencyService<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>KeyBuilder<span class="token punctuation">.</span><span class="token function">buildInstanceListKey</span><span class="token punctuation">(</span>service<span class="token punctuation">.</span><span class="token function">getNamespaceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> service<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span> service<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>Service#init</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// æ¯ä¸ªServiceä¸€ä¸ªä»»åŠ¡ï¼Œå®šæœŸæ£€æŸ¥ä¸‹å±çš„å®ä¾‹çš„å¿ƒè·³è¶…æ—¶å¹¶å¤„ç†ï¼Œå‘å¸ƒå¯¹åº”çš„äº‹ä»¶ç­‰</span>
        HealthCheckReactor<span class="token punctuation">.</span><span class="token function">scheduleCheck</span><span class="token punctuation">(</span>clientBeatCheckTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>Map<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Cluster<span class="token operator">></span> entry <span class="token operator">:</span> clusterMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setService</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æœåŠ¡ç«¯ä¸»åŠ¨çš„å¥åº·æ£€æµ‹æ˜¯äº¤ç»™Clusterå¤„ç†çš„</span>
            <span class="token comment" spellcheck="true">// æ”¯æŒMysqlã€HTTPã€TCPç­‰è‡ªå®šä¹‰æ–¹å¼ï¼Œå‰ææ˜¯å½“å‰Serveræ ¹æ®Distroçš„æ˜ å°„è´Ÿè´£è¯¥æœåŠ¡</span>
            entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<ul>
<li>PersistentConsistencyServiceï¼šè´Ÿè´£æŒä¹…ç±»å‹çš„å®ä¾‹çš„ä¸€è‡´æ€§ï¼Œå†…éƒ¨æ˜¯ç®€å•çš„Raftå®ç°ã€‚</li>
<li>EphemeralConsistencyServiceï¼šè´Ÿè´£ä¸´æ—¶ç±»å‹çš„å®ä¾‹çš„ä¸€è‡´æ€§ï¼Œå³éœ€è¦å¿ƒè·³ç»´æŒå­˜åœ¨ã€‚</li>
</ul>
<p>Nacosçš„Seviceä¼šæ³¨å†Œåˆ°ä¸¤ç§ä¸€è‡´æ€§æœåŠ¡ä¸Šï¼Œä½†æ˜¯Instanceä¼šæ ¹æ®ç±»å‹æ³¨å†Œåˆ°å¯¹åº”çš„æœåŠ¡ã€‚</p>
<p>EphemeralConsistencyServiceåœ¨ç½‘ç»œåˆ†åŒºå‘ç”Ÿæ—¶ï¼Œå†™ä¸€æ ·ä¼šæˆåŠŸï¼Œç½‘ç»œæ¢å¤åï¼Œä¼šåˆå¹¶æˆä¸€ä¸ªï¼Œæ‰€ä»¥ä¿è¯æœ€ç»ˆä¸€è‡´ã€‚</p>
<p>PersistentConsistencyServiceä¿è¯CPï¼Œå½“ç„¶æ˜¯ä¸ä¸¥æ ¼çš„ï¼Œå› ä¸ºå®ƒåªæ˜¯ä¸€ä¸ªç®€å•çš„Raftå®ç°ï¼Œæ ¸å¿ƒä¸€åƒå¤šè¡Œä»£ç ã€‚</p>
<p>Namingè¿™é‡Œçš„Raftåè®®å°±ä¸å¤šè¯´äº†ï¼ŒConfigçš„Raftåè®®ä½¿ç”¨çš„æ˜¯JRaftçš„å®ç°ï¼Œä¹‹å‰åˆ†æè¿‡ã€‚</p>
<hr>
<p>InstanceController#beat</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@CanDistro</span>
    <span class="token annotation punctuation">@PutMapping</span><span class="token punctuation">(</span><span class="token string">"/beat"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Secured</span><span class="token punctuation">(</span>parser <span class="token operator">=</span> NamingResourceParser<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> action <span class="token operator">=</span> ActionTypes<span class="token punctuation">.</span>WRITE<span class="token punctuation">)</span>
    <span class="token keyword">public</span> ObjectNode <span class="token function">beat</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        Instance instance <span class="token operator">=</span> serviceManager<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">,</span> clusterName<span class="token punctuation">,</span> ip<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è¢«ç§»é™¤äº†</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// </span>
            instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// é‡æ–°æ³¨å†Œ</span>
            serviceManager<span class="token punctuation">.</span><span class="token function">registerInstance</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        Service service <span class="token operator">=</span> serviceManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>clientBeat <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">//  å¤„ç†å¿ƒè·³ï¼Œæœ‰å˜åŒ–æ—¶ä¹Ÿä¼šä¸»åŠ¨é€šçŸ¥ç›¸å…³çš„å®¢æˆ·ç«¯</span>
        service<span class="token punctuation">.</span><span class="token function">processClientBeat</span><span class="token punctuation">(</span>clientBeat<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>InstanceController#doSrvIpxt</p>
<p><del>è¶…çº§é•¿çš„æ–¹æ³•ï¼Œè¦æ˜¯æˆ‘å†™å‡ºæ¥ä¼°è®¡ä¼šè¢«é¢†å¯¼ç›´æ¥å¼€é™¤ï¼ˆä¸€é¡¿é˜´é˜³æ€ªæ°”æˆ–è€…æ‰¹æ–—æ˜¯å°‘ä¸äº†çš„ï¼‰ã€‚</del></p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> ObjectNode <span class="token function">doSrvIpxt</span><span class="token punctuation">(</span>String namespaceId<span class="token punctuation">,</span> String serviceName<span class="token punctuation">,</span> String agent<span class="token punctuation">,</span> String clusters<span class="token punctuation">,</span> String clientIP<span class="token punctuation">,</span>
                                <span class="token keyword">int</span> udpPort<span class="token punctuation">,</span> String env<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isCheck<span class="token punctuation">,</span> String app<span class="token punctuation">,</span> String tid<span class="token punctuation">,</span> <span class="token keyword">boolean</span> healthyOnly<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>

        ClientInfo clientInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClientInfo</span><span class="token punctuation">(</span>agent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ObjectNode result <span class="token operator">=</span> JacksonUtils<span class="token punctuation">.</span><span class="token function">createEmptyJsonNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Service service <span class="token operator">=</span> serviceManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ²¡æœ‰æœåŠ¡</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>service <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// è¿™é‡Œä¼šåˆ›å»ºClientï¼Œç”¨äºä¸»åŠ¨å‘å®¢æˆ·ç«¯æ¨é€å˜åŒ–</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>udpPort <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> pushService<span class="token punctuation">.</span><span class="token function">canEnablePush</span><span class="token punctuation">(</span>agent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                pushService<span class="token punctuation">.</span><span class="token function">addClient</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">,</span> clusters<span class="token punctuation">,</span> agent<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span>clientIP<span class="token punctuation">,</span> udpPort<span class="token punctuation">)</span><span class="token punctuation">,</span> pushDataSource<span class="token punctuation">,</span> tid<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>

        List<span class="token operator">&lt;</span>Instance<span class="token operator">></span> srvedIPs<span class="token punctuation">;</span>

        srvedIPs <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token function">srvIPs</span><span class="token punctuation">(</span>Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>clusters<span class="token punctuation">,</span> <span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// æ²¡æœ‰å®ä¾‹</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>CollectionUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>srvedIPs<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        Map<span class="token operator">&lt;</span>Boolean<span class="token punctuation">,</span> List<span class="token operator">&lt;</span>Instance<span class="token operator">>></span> ipMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ipMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>Boolean<span class="token punctuation">.</span>TRUE<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ipMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>Boolean<span class="token punctuation">.</span>FALSE<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span>Instance ip <span class="token operator">:</span> srvedIPs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ipMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ip<span class="token punctuation">.</span><span class="token function">isHealthy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">double</span> threshold <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token function">getProtectThreshold</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å½“å¥åº·çš„å®ä¾‹å æ¯”å°äºä¿æŠ¤é˜ˆå€¼æ—¶</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span> ipMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>Boolean<span class="token punctuation">.</span>TRUE<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> srvedIPs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> threshold<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æŠŠä¸å¥åº·çš„å½“æˆå¥åº·çš„åŠ å…¥ï¼Œå…è®¸éƒ¨åˆ†å¤±è´¥ï¼Œä½†æ˜¯é¿å…æµé‡å…¨éƒ¨å‹åˆ°å¥åº·çš„å®ä¾‹å¯¼è‡´é›ªå´©</span>
            ipMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>Boolean<span class="token punctuation">.</span>TRUE<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>ipMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>Boolean<span class="token punctuation">.</span>FALSE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ipMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>Boolean<span class="token punctuation">.</span>FALSE<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>isCheck<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">return</span> JacksonUtils<span class="token punctuation">.</span><span class="token function">createEmptyJsonNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        ArrayNode hosts <span class="token operator">=</span> JacksonUtils<span class="token punctuation">.</span><span class="token function">createEmptyArrayNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span>Map<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span>Boolean<span class="token punctuation">,</span> List<span class="token operator">&lt;</span>Instance<span class="token operator">>></span> entry <span class="token operator">:</span> ipMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            List<span class="token operator">&lt;</span>Instance<span class="token operator">></span> ips <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>healthyOnly <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>Instance instance <span class="token operator">:</span> ips<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// remove disabled instance:</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>instance<span class="token punctuation">.</span><span class="token function">isEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                ObjectNode ipObj <span class="token operator">=</span> JacksonUtils<span class="token punctuation">.</span><span class="token function">createEmptyJsonNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ...</span>
                hosts<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ipObj<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>DistroConsistencyServiceImpl#init</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// å®šæœŸä»åˆ«çš„ServeråŒæ­¥æ•°æ®ï¼Œå…¨é‡çš„ï¼ŒåŒæ—¶è§¦å‘å›è°ƒæ›´æ–°</span>
        GlobalExecutor<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>loadDataTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¤„ç†å˜åŒ–çš„é€šçŸ¥å›è°ƒ</span>
        GlobalExecutor<span class="token punctuation">.</span><span class="token function">submitDistroNotifyTask</span><span class="token punctuation">(</span>notifier<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


        <footer>
             
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

        </footer>
    </div>
    <!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
    <script>
        var timeEnd = new Date();
        console.log('è€—æ—¶ï¼š' + (timeEnd - timeStart));
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre').forEach((block) => {
                block.classList.add("line-numbers");
            });
        });
    </script>
    <!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
    <!-- material design -->
    <!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
    <!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
    <!-- toc -->
    <!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
    <!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
    <!-- <script src="/js/main.js"></script> -->
    <script src="/js/prism.js"></script>
</body>
</html>
