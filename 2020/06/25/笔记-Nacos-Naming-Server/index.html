<!DOCTYPE HTML>
<html>

<head>
    <script>
        var timeStart = new Date();
    </script>
    <meta charset="utf-8">
    
    <title>[笔记]-Nacos-Naming-Server | Reunion...</title>
    
    <meta name="author" content="huangzhike">
    
    
    <meta name="description"
        content="Nacos服务器就是HTTP服务器，基本都是Restful风格，一些控制都是通过Filter实现的。
AuthFilter：拦截被@Secured注解的Controller方法，权限控制也是基于Role-Permission模型。
TrafficReviseFilter：根据请求的URI和当前服务器">
    
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta property="og:title" content="[笔记]-Nacos-Naming-Server" />
    
    <meta property="og:site_name" content="Reunion..." />
    
    
    <!-- favicon -->
    <link rel="icon" type="image/ico" href="/logo.ico" sizes="32x32">
    <meta name="msapplication-TileColor" content="#009688">
    <meta name="msapplication-TileImage" content="/mstile-144x144.ico">
    <meta name="theme-color" content="#009688">
    <!-- favicon end -->
    <!-- <link href="//ok.ico" rel="icon"> -->
    

    <!-- <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.5.0/css/bootstrap.min.css" rel="stylesheet"> -->
    <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
    <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
    <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">

<meta name="generator" content="Hexo 4.2.1"></head>
<body>
    <nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">菜单</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" title="早く来い、クラウド" href="/">Reunion...</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" target="_blank" rel="noopener" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

    <div class="container" >
        <div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[笔记]-Nacos-Naming-Server</h2>
				
				<div>
					<div class="post-time">2020-06-25</div>
				</div>
				
				<div class="article-content">
				<p>Nacos服务器就是HTTP服务器，基本都是Restful风格，一些控制都是通过Filter实现的。</p>
<p>AuthFilter：拦截被@Secured注解的Controller方法，权限控制也是基于Role-Permission模型。</p>
<p>TrafficReviseFilter：根据请求的URI和当前服务器的状态进行限流。</p>
<p>DistroFilter：拦截被@CanDistro注解的方法，简单的说，就是一个服务对应的事件交给特定的服务器处理，如果服务器接收到了不属于分配给自己的服务的处理请求，就转发给对应的的Server处理再返回结果。</p>
<p>原理也很简单，就是服务名的哈希值对服务器数量取模。</p>
<p>不过这个服务器集群的列表的一致性并不严格。</p>
<hr>
<ul>
<li>ApiController：已废弃；</li>
<li>CatalogController：获取服务相关的信息；</li>
<li>ClusterController：更新某服务下的集群信息；</li>
<li>DistroController：一个Server只负责部分服务，所以需要同步才能获取完整的信息；</li>
<li>HealthController：服务端主动的健康检查相关操作接口；</li>
<li>InstanceController：服务实例相关，注册、获取服务实例，处理实例心跳等；</li>
<li>OperatorController：操作、统计、状态相关；</li>
<li>RaftController：Raft协议相关通信接口，不过Naming部分的Raft实现并不严格；</li>
<li>ServiceController：服务信息操作相关的接口；</li>
</ul>
<hr>
<p>ServiceManager#init</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 提交服务报告的任务，根据服务信息的校验和来判断不同服务器间的不一致</span>
        UtilsAndCommons<span class="token punctuation">.</span>SERVICE_SYNCHRONIZATION_EXECUTOR<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ServiceReporter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">60000</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 处理收到的服务校验和不一致的情况</span>
        UtilsAndCommons<span class="token punctuation">.</span>SERVICE_UPDATE_EXECUTOR<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UpdatedServiceProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>emptyServiceAutoClean<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 将自己当做回调，向一致性服务注册服务元数据变化事件</span>
            consistencyService<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>KeyBuilder<span class="token punctuation">.</span>SERVICE_META_KEY_PREFIX<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NacosException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>ServiceManager$ServiceReporter#run</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 本地所有的服务信息</span>
                Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Set<span class="token operator">&lt;</span>String<span class="token operator">>></span> allServiceNames <span class="token operator">=</span> <span class="token function">getAllServiceNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ...</span>
                <span class="token comment" spellcheck="true">// 以命名空间为维度</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>String namespaceId <span class="token operator">:</span> allServiceNames<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    ServiceChecksum checksum <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceChecksum</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// 遍历该命名空间下的所有服务</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span>String serviceName <span class="token operator">:</span> allServiceNames<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 跳过不属于自己负责的服务</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>distroMapper<span class="token punctuation">.</span><span class="token function">responsible</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">continue</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment" spellcheck="true">// 获取本地的服务信息</span>
                        Service service <span class="token operator">=</span> <span class="token function">getService</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                        <span class="token comment" spellcheck="true">// 计算Checksum</span>
                        service<span class="token punctuation">.</span><span class="token function">recalculateChecksum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// 加入</span>
                        checksum<span class="token punctuation">.</span><span class="token function">addItem</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> service<span class="token punctuation">.</span><span class="token function">getChecksum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    Message msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    msg<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>JacksonUtils<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span>checksum<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// 所有服务器成员</span>
                    Collection<span class="token operator">&lt;</span>Member<span class="token operator">></span> sameSiteServers <span class="token operator">=</span> memberManager<span class="token punctuation">.</span><span class="token function">allMembers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token comment" spellcheck="true">// 遍历所有服务器成员</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span>Member server <span class="token operator">:</span> sameSiteServers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 跳过自己</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>NetUtils<span class="token punctuation">.</span><span class="token function">localServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">continue</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment" spellcheck="true">// 报告服务的校验和</span>
                        synchronizer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 计划下一次报告</span>
                UtilsAndCommons<span class="token punctuation">.</span>SERVICE_SYNCHRONIZATION_EXECUTOR<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> switchDomain<span class="token punctuation">.</span><span class="token function">getServiceStatusSynchronizationPeriodMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span></code></pre>
<p>ServiceController#serviceStatus</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/status"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> String <span class="token function">serviceStatus</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>Map<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> entry <span class="token operator">:</span> checksums<span class="token punctuation">.</span>serviceName2Checksum<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
                <span class="token comment" spellcheck="true">// 本地的服务信息</span>
                Service service <span class="token operator">=</span> serviceManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span>checksums<span class="token punctuation">.</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ...</span>
                <span class="token comment" spellcheck="true">// 计算本地的服务的Checksum</span>
                service<span class="token punctuation">.</span><span class="token function">recalculateChecksum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// Checksum不一致，说明服务信息可能落后了</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>checksum<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>service<span class="token punctuation">.</span><span class="token function">getChecksum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token comment" spellcheck="true">// 提交一个更新任务</span>
                    serviceManager<span class="token punctuation">.</span><span class="token function">addUpdatedServiceToQueue</span><span class="token punctuation">(</span>checksums<span class="token punctuation">.</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">,</span> serverIp<span class="token punctuation">,</span> checksum<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ...</span>
    <span class="token punctuation">}</span></code></pre>
<p>ServiceManager#updatedHealthStatus</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updatedHealthStatus</span><span class="token punctuation">(</span>String namespaceId<span class="token punctuation">,</span> String serviceName<span class="token punctuation">,</span> String serverIP<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 从对应的Server获取对应的服务信息</span>
        Message msg <span class="token operator">=</span> synchronizer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>serverIP<span class="token punctuation">,</span> UtilsAndCommons<span class="token punctuation">.</span><span class="token function">assembleFullServiceName</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        JsonNode serviceJson <span class="token operator">=</span> JacksonUtils<span class="token punctuation">.</span><span class="token function">toObj</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 服务实例的信息</span>
        ArrayNode ipList <span class="token operator">=</span> <span class="token punctuation">(</span>ArrayNode<span class="token punctuation">)</span> serviceJson<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"ips"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> ipsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>ipList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ipList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 本地的服务信息</span>
        Service service <span class="token operator">=</span> <span class="token function">getService</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">boolean</span> changed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        List<span class="token operator">&lt;</span>Instance<span class="token operator">></span> instances <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token function">allIPs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>Instance instance <span class="token operator">:</span> instances<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 该实例是否健康</span>
            <span class="token keyword">boolean</span> valid <span class="token operator">=</span> Boolean<span class="token punctuation">.</span><span class="token function">parseBoolean</span><span class="token punctuation">(</span>ipsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token function">toIpAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>valid <span class="token operator">!=</span> instance<span class="token punctuation">.</span><span class="token function">isHealthy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                changed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                instance<span class="token punctuation">.</span><span class="token function">setHealthy</span><span class="token punctuation">(</span>valid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 发生了变化</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>changed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            pushService<span class="token punctuation">.</span><span class="token function">serviceChanged</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span></code></pre>
<p>加入阻塞队列，线程取出，提交异步任务，然后自己发布自己监听。</p>
<p>PushService#onApplicationEvent</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onApplicationEvent</span><span class="token punctuation">(</span>ServiceChangeEvent event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// 提交一个异步更新任务</span>
        Future future <span class="token operator">=</span> udpSender<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 获取该服务下的实例对应的客户端，该客户端在通过InstanceController#list接口获取服务实例列表时创建</span>
                <span class="token comment" spellcheck="true">// 主动向客户端推送服务实例的变化，即使自己不负责该服务，反正也不保证强一致性</span>
                ConcurrentMap<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> PushClient<span class="token operator">></span> clients <span class="token operator">=</span> clientMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>UtilsAndCommons<span class="token punctuation">.</span><span class="token function">assembleFullServiceName</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ...</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>PushClient client <span class="token operator">:</span> clients<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>client<span class="token punctuation">.</span><span class="token function">zombie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token comment" spellcheck="true">// 复用缓存</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>switchDomain<span class="token punctuation">.</span><span class="token function">getDefaultPushCacheMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">20000</span> <span class="token operator">&amp;&amp;</span> cache<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>compressData <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        ackEntry <span class="token operator">=</span> <span class="token function">prepareAckEntry</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> compressData<span class="token punctuation">,</span> data<span class="token punctuation">,</span> lastRefTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 消息包</span>
                        ackEntry <span class="token operator">=</span> <span class="token function">prepareAckEntry</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> <span class="token function">prepareHostsData</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">,</span> lastRefTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>ackEntry <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">org<span class="token punctuation">.</span>javatuples<span class="token punctuation">.</span>Pair</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>ackEntry<span class="token punctuation">.</span>origin<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ackEntry<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token comment" spellcheck="true">// UDP发送消息</span>
                    <span class="token function">udpPush</span><span class="token punctuation">(</span>ackEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 更新完移除</span>
                futureMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>UtilsAndCommons<span class="token punctuation">.</span><span class="token function">assembleFullServiceName</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 标记为更新中</span>
        futureMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>UtilsAndCommons<span class="token punctuation">.</span><span class="token function">assembleFullServiceName</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">,</span> future<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>PushService#udpPush</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">static</span> Receiver<span class="token punctuation">.</span>AckEntry <span class="token function">udpPush</span><span class="token punctuation">(</span>Receiver<span class="token punctuation">.</span>AckEntry ackEntry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 重传次数过多</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ackEntry<span class="token punctuation">.</span><span class="token function">getRetryTimes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> MAX_RETRY_TIMES<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 不再管它了</span>
            ackMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>ackEntry<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            udpSendTimeMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>ackEntry<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            failedPush <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> ackEntry<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// 待应答</span>
            ackMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>ackEntry<span class="token punctuation">.</span>key<span class="token punctuation">,</span> ackEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
            udpSendTimeMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>ackEntry<span class="token punctuation">.</span>key<span class="token punctuation">,</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// 发送</span>
            udpSocket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>ackEntry<span class="token punctuation">.</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ackEntry<span class="token punctuation">.</span><span class="token function">increaseRetryTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 计划重传</span>
            executorService<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Retransmitter</span><span class="token punctuation">(</span>ackEntry<span class="token punctuation">)</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>NANOSECONDS<span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span>ACK_TIMEOUT_NANOS<span class="token punctuation">)</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> ackEntry<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>这个类据说1.3.0后要被移除了。</p>
<p>ServerListManager#init</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 提交广播更新服务器状态的任务</span>
        GlobalExecutor<span class="token punctuation">.</span><span class="token function">registerServerStatusReporter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ServerStatusReporter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 提交主动更新成员状态的任务</span>
        GlobalExecutor<span class="token punctuation">.</span><span class="token function">registerServerInfoUpdater</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ServerInfoUpdater</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ServerListManager$ServerStatusReporter#run</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
                List<span class="token operator">&lt;</span>Member<span class="token operator">></span> allServers <span class="token operator">=</span> <span class="token function">getServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 服务器列表不包含自己，你已经被开除了</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">contains</span><span class="token punctuation">(</span>ApplicationUtils<span class="token punctuation">.</span><span class="token function">getLocalAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>allServers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>ApplicationUtils<span class="token punctuation">.</span><span class="token function">getLocalAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>UtilsAndCommons<span class="token punctuation">.</span>LOCAL_HOST_IP<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 遍历成员服务器</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span>Member server <span class="token operator">:</span> allServers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 跳过自己</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>Objects<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ApplicationUtils<span class="token punctuation">.</span><span class="token function">getLocalAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">continue</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                        Message msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        msg<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// 向别的服务器更新自己的状态</span>
                        synchronizer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 计划下一次</span>
                GlobalExecutor<span class="token punctuation">.</span><span class="token function">registerServerStatusReporter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> switchDomain<span class="token punctuation">.</span><span class="token function">getServerStatusSynchronizationPeriodMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span></code></pre>
<p>ServerListManager#onReceiveServerStatus</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">onReceiveServerStatus</span><span class="token punctuation">(</span>String configInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>String config <span class="token operator">:</span> configs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// site:ip:lastReportTime:weight</span>
            String<span class="token punctuation">[</span><span class="token punctuation">]</span> params <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">"#"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// 找到该Server成员</span>
            Member server <span class="token operator">=</span> Optional<span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>memberManager<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>params<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span>Member<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ip</span><span class="token punctuation">(</span>params<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>UtilsAndCommons<span class="token punctuation">.</span>IP_PORT_SPLITER<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span>NodeState<span class="token punctuation">.</span>UP<span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">port</span><span class="token punctuation">(</span>Integer<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>params<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>UtilsAndCommons<span class="token punctuation">.</span>IP_PORT_SPLITER<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            server<span class="token punctuation">.</span><span class="token function">setExtendVal</span><span class="token punctuation">(</span>MemberMetaDataConstants<span class="token punctuation">.</span>SITE_KEY<span class="token punctuation">,</span> params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            server<span class="token punctuation">.</span><span class="token function">setExtendVal</span><span class="token punctuation">(</span>MemberMetaDataConstants<span class="token punctuation">.</span>WEIGHT<span class="token punctuation">,</span> params<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">4</span> <span class="token operator">?</span> Integer<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>params<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 更新它</span>
            memberManager<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>ServerMemberManager#update</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">update</span><span class="token punctuation">(</span>Member newMember<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// 更新</span>
        serverList<span class="token punctuation">.</span><span class="token function">computeIfPresent</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> <span class="token punctuation">(</span>s<span class="token punctuation">,</span> member<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>NodeState<span class="token punctuation">.</span>DOWN<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>newMember<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                memberAddressInfos<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>newMember<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            MemberUtils<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>newMember<span class="token punctuation">,</span> member<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> member<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 发布成员变化事件</span>
        NotifyCenter<span class="token punctuation">.</span><span class="token function">publishEvent</span><span class="token punctuation">(</span>MembersChangeEvent<span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">members</span><span class="token punctuation">(</span><span class="token function">allMembers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>有点花里胡哨，设计过度。我省略了一些代码。</p>
<p>ServerListManager#onEvent</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onEvent</span><span class="token punctuation">(</span>MembersChangeEvent event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>servers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getMembers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ServerListManager$ServerInfoUpdater#run</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            List<span class="token operator">&lt;</span>Member<span class="token operator">></span> members <span class="token operator">=</span> servers<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// 取模轮询服务器</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>cursor <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cursor <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> members<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Member target <span class="token operator">=</span> members<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cursor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                String content <span class="token operator">=</span> NamingProxy<span class="token punctuation">.</span><span class="token function">reqCommon</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> params<span class="token punctuation">,</span> server<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>StringUtils<span class="token punctuation">.</span>EMPTY<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    RaftPeer raftPeer <span class="token operator">=</span> JacksonUtils<span class="token punctuation">.</span><span class="token function">toObj</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> RaftPeer<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">!=</span> raftPeer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                        <span class="token comment" spellcheck="true">// 主动更新</span>
                        memberManager<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ignore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">//</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span></code></pre>
<p>ServerMemberManager还有一个主动拉取更新服务器配置列表的功能。</p>
<p>ServerMemberManager#initAndStartLookup</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initAndStartLookup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> NacosException <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>lookup <span class="token operator">=</span> LookupFactory<span class="token punctuation">.</span><span class="token function">createLookUp</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>lookup<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<ul>
<li><p>StandaloneMemberLookup：单机；</p>
</li>
<li><p>FileConfigMemberLookup：从配置文件更新；</p>
</li>
<li><p>AddressServerMemberLookup：从地址服务器更新；</p>
</li>
</ul>
<p>三种方式定期更新服务器列表。</p>
<hr>
<p>ServiceManager#registerInstance</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerInstance</span><span class="token punctuation">(</span>String namespaceId<span class="token punctuation">,</span> String serviceName<span class="token punctuation">,</span> Instance instance<span class="token punctuation">)</span> <span class="token keyword">throws</span> NacosException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 创建服务，如果对应的服务不存在</span>
        <span class="token function">createEmptyService</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">,</span> instance<span class="token punctuation">.</span><span class="token function">isEphemeral</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Service service <span class="token operator">=</span> <span class="token function">getService</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// 注册实例</span>
        <span class="token function">addInstance</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">,</span> instance<span class="token punctuation">.</span><span class="token function">isEphemeral</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ServiceManager#createEmptyService</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createServiceIfAbsent</span><span class="token punctuation">(</span>String namespaceId<span class="token punctuation">,</span> String serviceName<span class="token punctuation">,</span> <span class="token keyword">boolean</span> local<span class="token punctuation">,</span> Cluster cluster<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> NacosException <span class="token punctuation">{</span>
        Service service <span class="token operator">=</span> <span class="token function">getService</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>service <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            service <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Service</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ...</span>
            service<span class="token punctuation">.</span><span class="token function">recalculateChecksum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cluster <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                cluster<span class="token punctuation">.</span><span class="token function">setService</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
                service<span class="token punctuation">.</span><span class="token function">getClusterMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cluster<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cluster<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            service<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 初始化</span>
            <span class="token function">putServiceAndInit</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 持久化类型的实例</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>local<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">addOrReplaceService</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>层级结构为Service-Cluster-Instance。</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">putServiceAndInit</span><span class="token punctuation">(</span>Service service<span class="token punctuation">)</span> <span class="token keyword">throws</span> NacosException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 加入本地缓存，双重检测加锁保证线程安全</span>
        <span class="token function">putService</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 初始化</span>
        service<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 向一致性服务注册事件回调，有变化时会自动更新</span>
        consistencyService<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>KeyBuilder<span class="token punctuation">.</span><span class="token function">buildInstanceListKey</span><span class="token punctuation">(</span>service<span class="token punctuation">.</span><span class="token function">getNamespaceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> service<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span> service<span class="token punctuation">)</span><span class="token punctuation">;</span>
        consistencyService<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>KeyBuilder<span class="token punctuation">.</span><span class="token function">buildInstanceListKey</span><span class="token punctuation">(</span>service<span class="token punctuation">.</span><span class="token function">getNamespaceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> service<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span> service<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>Service#init</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 每个Service一个任务，定期检查下属的实例的心跳超时并处理，发布对应的事件等</span>
        HealthCheckReactor<span class="token punctuation">.</span><span class="token function">scheduleCheck</span><span class="token punctuation">(</span>clientBeatCheckTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>Map<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Cluster<span class="token operator">></span> entry <span class="token operator">:</span> clusterMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setService</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 服务端主动的健康检测是交给Cluster处理的</span>
            <span class="token comment" spellcheck="true">// 支持Mysql、HTTP、TCP等自定义方式，前提是当前Server根据Distro的映射负责该服务</span>
            entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<ul>
<li>PersistentConsistencyService：负责持久类型的实例的一致性，内部是简单的Raft实现。</li>
<li>EphemeralConsistencyService：负责临时类型的实例的一致性，即需要心跳维持存在。</li>
</ul>
<p>Nacos的Sevice会注册到两种一致性服务上，但是Instance会根据类型注册到对应的服务。</p>
<p>EphemeralConsistencyService在网络分区发生时，写一样会成功，网络恢复后，会合并成一个，所以保证最终一致。</p>
<p>PersistentConsistencyService保证CP，当然是不严格的，因为它只是一个简单的Raft实现，核心一千多行代码。</p>
<p>Naming这里的Raft协议就不多说了，Config的Raft协议使用的是JRaft的实现，之前分析过。</p>
<hr>
<p>InstanceController#beat</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@CanDistro</span>
    <span class="token annotation punctuation">@PutMapping</span><span class="token punctuation">(</span><span class="token string">"/beat"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Secured</span><span class="token punctuation">(</span>parser <span class="token operator">=</span> NamingResourceParser<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> action <span class="token operator">=</span> ActionTypes<span class="token punctuation">.</span>WRITE<span class="token punctuation">)</span>
    <span class="token keyword">public</span> ObjectNode <span class="token function">beat</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        Instance instance <span class="token operator">=</span> serviceManager<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">,</span> clusterName<span class="token punctuation">,</span> ip<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 被移除了</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// </span>
            instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 重新注册</span>
            serviceManager<span class="token punctuation">.</span><span class="token function">registerInstance</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        Service service <span class="token operator">=</span> serviceManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>clientBeat <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">//  处理心跳，有变化时也会主动通知相关的客户端</span>
        service<span class="token punctuation">.</span><span class="token function">processClientBeat</span><span class="token punctuation">(</span>clientBeat<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>InstanceController#doSrvIpxt</p>
<p><del>超级长的方法，要是我写出来估计会被领导直接开除（一顿阴阳怪气或者批斗是少不了的）。</del></p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> ObjectNode <span class="token function">doSrvIpxt</span><span class="token punctuation">(</span>String namespaceId<span class="token punctuation">,</span> String serviceName<span class="token punctuation">,</span> String agent<span class="token punctuation">,</span> String clusters<span class="token punctuation">,</span> String clientIP<span class="token punctuation">,</span>
                                <span class="token keyword">int</span> udpPort<span class="token punctuation">,</span> String env<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isCheck<span class="token punctuation">,</span> String app<span class="token punctuation">,</span> String tid<span class="token punctuation">,</span> <span class="token keyword">boolean</span> healthyOnly<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>

        ClientInfo clientInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClientInfo</span><span class="token punctuation">(</span>agent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ObjectNode result <span class="token operator">=</span> JacksonUtils<span class="token punctuation">.</span><span class="token function">createEmptyJsonNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Service service <span class="token operator">=</span> serviceManager<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 没有服务</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>service <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// 这里会创建Client，用于主动向客户端推送变化</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>udpPort <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> pushService<span class="token punctuation">.</span><span class="token function">canEnablePush</span><span class="token punctuation">(</span>agent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                pushService<span class="token punctuation">.</span><span class="token function">addClient</span><span class="token punctuation">(</span>namespaceId<span class="token punctuation">,</span> serviceName<span class="token punctuation">,</span> clusters<span class="token punctuation">,</span> agent<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">InetSocketAddress</span><span class="token punctuation">(</span>clientIP<span class="token punctuation">,</span> udpPort<span class="token punctuation">)</span><span class="token punctuation">,</span> pushDataSource<span class="token punctuation">,</span> tid<span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>

        List<span class="token operator">&lt;</span>Instance<span class="token operator">></span> srvedIPs<span class="token punctuation">;</span>

        srvedIPs <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token function">srvIPs</span><span class="token punctuation">(</span>Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>clusters<span class="token punctuation">,</span> <span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// 没有实例</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>CollectionUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>srvedIPs<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        Map<span class="token operator">&lt;</span>Boolean<span class="token punctuation">,</span> List<span class="token operator">&lt;</span>Instance<span class="token operator">>></span> ipMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ipMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>Boolean<span class="token punctuation">.</span>TRUE<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ipMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>Boolean<span class="token punctuation">.</span>FALSE<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span>Instance ip <span class="token operator">:</span> srvedIPs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ipMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>ip<span class="token punctuation">.</span><span class="token function">isHealthy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">double</span> threshold <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token function">getProtectThreshold</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 当健康的实例占比小于保护阈值时</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span> ipMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>Boolean<span class="token punctuation">.</span>TRUE<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> srvedIPs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> threshold<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 把不健康的当成健康的加入，允许部分失败，但是避免流量全部压到健康的实例导致雪崩</span>
            ipMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>Boolean<span class="token punctuation">.</span>TRUE<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>ipMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>Boolean<span class="token punctuation">.</span>FALSE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ipMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>Boolean<span class="token punctuation">.</span>FALSE<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>isCheck<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">return</span> JacksonUtils<span class="token punctuation">.</span><span class="token function">createEmptyJsonNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        ArrayNode hosts <span class="token operator">=</span> JacksonUtils<span class="token punctuation">.</span><span class="token function">createEmptyArrayNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span>Map<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span>Boolean<span class="token punctuation">,</span> List<span class="token operator">&lt;</span>Instance<span class="token operator">>></span> entry <span class="token operator">:</span> ipMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            List<span class="token operator">&lt;</span>Instance<span class="token operator">></span> ips <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>healthyOnly <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>Instance instance <span class="token operator">:</span> ips<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// remove disabled instance:</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>instance<span class="token punctuation">.</span><span class="token function">isEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                ObjectNode ipObj <span class="token operator">=</span> JacksonUtils<span class="token punctuation">.</span><span class="token function">createEmptyJsonNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ...</span>
                hosts<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ipObj<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>DistroConsistencyServiceImpl#init</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 定期从别的Server同步数据，全量的，同时触发回调更新</span>
        GlobalExecutor<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>loadDataTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 处理变化的通知回调</span>
        GlobalExecutor<span class="token punctuation">.</span><span class="token function">submitDistroNotifyTask</span><span class="token punctuation">(</span>notifier<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


        <footer>
             
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

        </footer>
    </div>
    <!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
    <script>
        var timeEnd = new Date();
        console.log('耗时：' + (timeEnd - timeStart));
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre').forEach((block) => {
                block.classList.add("line-numbers");
            });
        });
    </script>

    <script src="/js/prism.js"></script>
</body>
</html>
