<!DOCTYPE HTML>
<html>
	<head><meta name="generator" content="Hexo 3.9.0">
		<meta charset="utf-8">
		<script src="/js/highlight.js"></script>
				<script>hljs.initHighlightingOnLoad();var timeStart = new Date();</script>
		
		<title>[笔记]-Nacos-Naming-Server | 学而时习之</title>
		
		<meta name="author" content="Huangzhike">
		
		
		<meta name="description" content="K.I.S.S">
		
		
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		
		<meta property="og:title" content="[笔记]-Nacos-Naming-Server">
		
		<meta property="og:site_name" content="学而时习之">
		
		
		<!-- favicon -->
		<link rel="icon" type="image/ico" href="/ok.ico" sizes="32x32">
 


		<meta name="msapplication-TileColor" content="#009688">
		<meta name="msapplication-TileImage" content="/mstile-144x144.ico">
		<meta name="theme-color" content="#009688">

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Didact+Gothic"> 

		<!-- favicon end -->
		<!-- <link href="//ok.ico" rel="icon"> -->
		
		<!-- toc -->
		<!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
		<!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
		<!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
		<!-- material design -->
		<!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
		<!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
		<!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
		<!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
		<!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
		<link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
		 
		 
		<!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
		<!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
	</head>
</html>
<body>
	<nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">菜单</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" href="/">学而时习之</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

	<div class="container" >
		<div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[笔记]-Nacos-Naming-Server</h2>
				
				<div>
					<div class="post-time">2020-06-25</div>
				</div>
				
				<div class="article-content">
				<p>Nacos服务器就是HTTP服务器，基本都是Restful风格，一些控制都是通过Filter实现的。</p>
<p>AuthFilter：拦截被@Secured注解的Controller方法，权限控制也是基于Role-Permission模型。</p>
<p>TrafficReviseFilter：根据请求的URI和当前服务器的状态进行限流。</p>
<p>DistroFilter：拦截被@CanDistro注解的方法，简单的说，就是一个服务对应的事件交给特定的服务器处理，如果服务器接收到了不属于分配给自己的服务的处理请求，就转发给对应的的Server处理再返回结果。</p>
<p>原理也很简单，就是服务名的哈希值对服务器数量取模。</p>
<p>不过这个服务器集群的列表的一致性并不严格。</p>
<hr>
<ul>
<li>ApiController：已废弃；</li>
<li>CatalogController：获取服务相关的信息；</li>
<li>ClusterController：更新某服务下的集群信息；</li>
<li>DistroController：一个Server只负责部分服务，所以需要同步才能获取完整的信息；</li>
<li>HealthController：服务端主动的健康检查相关操作接口；</li>
<li>InstanceController：服务实例相关，注册、获取服务实例，处理实例心跳等；</li>
<li>OperatorController：操作、统计、状态相关；</li>
<li>RaftController：Raft协议相关通信接口，不过Naming部分的Raft实现并不严格；</li>
<li>ServiceController：服务信息操作相关的接口；</li>
</ul>
<hr>
<p>ServiceManager#init</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostConstruct</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 提交服务报告的任务，根据服务信息的校验和来判断不同服务器间的不一致</span></span><br><span class="line">    UtilsAndCommons.SERVICE_SYNCHRONIZATION_EXECUTOR.schedule(<span class="keyword">new</span> ServiceReporter(), <span class="number">60000</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">    <span class="comment">// 处理收到的服务校验和不一致的情况</span></span><br><span class="line">    UtilsAndCommons.SERVICE_UPDATE_EXECUTOR.submit(<span class="keyword">new</span> UpdatedServiceProcessor());</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (emptyServiceAutoClean) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 将自己当做回调，向一致性服务注册服务元数据变化事件</span></span><br><span class="line">        consistencyService.listen(KeyBuilder.SERVICE_META_KEY_PREFIX, <span class="keyword">this</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NacosException e) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p>ServiceManager$ServiceReporter#run</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 本地所有的服务信息</span></span><br><span class="line">        Map&lt;String, Set&lt;String&gt;&gt; allServiceNames = getAllServiceNames();</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="comment">// 以命名空间为维度</span></span><br><span class="line">        <span class="keyword">for</span> (String namespaceId : allServiceNames.keySet()) &#123;</span><br><span class="line">            ServiceChecksum checksum = <span class="keyword">new</span> ServiceChecksum(namespaceId);</span><br><span class="line">            <span class="comment">// 遍历该命名空间下的所有服务</span></span><br><span class="line">            <span class="keyword">for</span> (String serviceName : allServiceNames.get(namespaceId)) &#123;</span><br><span class="line">                <span class="comment">// 跳过不属于自己负责的服务</span></span><br><span class="line">                <span class="keyword">if</span> (!distroMapper.responsible(serviceName)) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 获取本地的服务信息</span></span><br><span class="line">                Service service = getService(namespaceId, serviceName);</span><br><span class="line">                <span class="comment">// ...</span></span><br><span class="line">                <span class="comment">// 计算Checksum</span></span><br><span class="line">                service.recalculateChecksum();</span><br><span class="line">                <span class="comment">// 加入</span></span><br><span class="line">                checksum.addItem(serviceName, service.getChecksum());</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            Message msg = <span class="keyword">new</span> Message();</span><br><span class="line">            msg.setData(JacksonUtils.toJson(checksum));</span><br><span class="line">            <span class="comment">// 所有服务器成员</span></span><br><span class="line">            Collection&lt;Member&gt; sameSiteServers = memberManager.allMembers();</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">            <span class="comment">// 遍历所有服务器成员</span></span><br><span class="line">            <span class="keyword">for</span> (Member server : sameSiteServers) &#123;</span><br><span class="line">                <span class="comment">// 跳过自己</span></span><br><span class="line">                <span class="keyword">if</span> (server.getAddress().equals(NetUtils.localServer())) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 报告服务的校验和</span></span><br><span class="line">                synchronizer.send(server.getAddress(), msg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// 计划下一次报告</span></span><br><span class="line">        UtilsAndCommons.SERVICE_SYNCHRONIZATION_EXECUTOR.schedule(<span class="keyword">this</span>, switchDomain.getServiceStatusSynchronizationPeriodMillis(), TimeUnit.MILLISECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ServiceController#serviceStatus</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span>(<span class="string">"/status"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">serviceStatus</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; entry : checksums.serviceName2Checksum.entrySet()) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">            <span class="comment">// 本地的服务信息</span></span><br><span class="line">            Service service = serviceManager.getService(checksums.namespaceId, serviceName);</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">            <span class="comment">// 计算本地的服务的Checksum</span></span><br><span class="line">            service.recalculateChecksum();</span><br><span class="line">            <span class="comment">// Checksum不一致，说明服务信息可能落后了</span></span><br><span class="line">            <span class="keyword">if</span> (!checksum.equals(service.getChecksum())) &#123;</span><br><span class="line">                <span class="comment">// ...</span></span><br><span class="line">                <span class="comment">// 提交一个更新任务</span></span><br><span class="line">                serviceManager.addUpdatedServiceToQueue(checksums.namespaceId, serviceName, serverIp, checksum);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ServiceManager#updatedHealthStatus</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updatedHealthStatus</span><span class="params">(String namespaceId, String serviceName, String serverIP)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 从对应的Server获取对应的服务信息</span></span><br><span class="line">    Message msg = synchronizer.get(serverIP, UtilsAndCommons.assembleFullServiceName(namespaceId, serviceName));</span><br><span class="line">    JsonNode serviceJson = JacksonUtils.toObj(msg.getData());</span><br><span class="line">    <span class="comment">// 服务实例的信息</span></span><br><span class="line">    ArrayNode ipList = (ArrayNode) serviceJson.get(<span class="string">"ips"</span>);</span><br><span class="line">    Map&lt;String, String&gt; ipsMap = <span class="keyword">new</span> HashMap&lt;&gt;(ipList.size());</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ipList.size(); i++) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 本地的服务信息</span></span><br><span class="line">    Service service = getService(namespaceId, serviceName);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">boolean</span> changed = <span class="keyword">false</span>;</span><br><span class="line">    List&lt;Instance&gt; instances = service.allIPs();</span><br><span class="line">    <span class="keyword">for</span> (Instance instance : instances) &#123;</span><br><span class="line">        <span class="comment">// 该实例是否健康</span></span><br><span class="line">        <span class="keyword">boolean</span> valid = Boolean.parseBoolean(ipsMap.get(instance.toIpAddr()));</span><br><span class="line">        <span class="keyword">if</span> (valid != instance.isHealthy()) &#123;</span><br><span class="line">            changed = <span class="keyword">true</span>;</span><br><span class="line">            instance.setHealthy(valid);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 发生了变化</span></span><br><span class="line">    <span class="keyword">if</span> (changed) &#123;</span><br><span class="line">        pushService.serviceChanged(service);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>加入阻塞队列，线程取出，提交异步任务，然后自己发布自己监听。</p>
<p>PushService#onApplicationEvent</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(ServiceChangeEvent event)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 提交一个异步更新任务</span></span><br><span class="line">    Future future = udpSender.schedule(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 获取该服务下的实例对应的客户端，该客户端在通过InstanceController#list接口获取服务实例列表时创建</span></span><br><span class="line">            <span class="comment">// 主动向客户端推送服务实例的变化，即使自己不负责该服务，反正也不保证强一致性</span></span><br><span class="line">            ConcurrentMap&lt;String, PushClient&gt; clients = clientMap.get(UtilsAndCommons.assembleFullServiceName(namespaceId, serviceName));</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">            <span class="keyword">for</span> (PushClient client : clients.values()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (client.zombie()) &#123;</span><br><span class="line">                    <span class="comment">// ...</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// ...</span></span><br><span class="line">                <span class="comment">// 复用缓存</span></span><br><span class="line">                <span class="keyword">if</span> (switchDomain.getDefaultPushCacheMillis() &gt;= <span class="number">20000</span> &amp;&amp; cache.containsKey(key)) &#123;</span><br><span class="line">                    <span class="comment">// ...</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (compressData != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    ackEntry = prepareAckEntry(client, compressData, data, lastRefTime);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 消息包</span></span><br><span class="line">                    ackEntry = prepareAckEntry(client, prepareHostsData(client), lastRefTime);</span><br><span class="line">                    <span class="keyword">if</span> (ackEntry != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        cache.put(key, <span class="keyword">new</span> org.javatuples.Pair&lt;&gt;(ackEntry.origin.getData(), ackEntry.data));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// ...</span></span><br><span class="line">                <span class="comment">// UDP发送消息</span></span><br><span class="line">                udpPush(ackEntry);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 更新完移除</span></span><br><span class="line">            futureMap.remove(UtilsAndCommons.assembleFullServiceName(namespaceId, serviceName));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="number">1000</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">    <span class="comment">// 标记为更新中</span></span><br><span class="line">    futureMap.put(UtilsAndCommons.assembleFullServiceName(namespaceId, serviceName), future);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>PushService#udpPush</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Receiver.<span class="function">AckEntry <span class="title">udpPush</span><span class="params">(Receiver.AckEntry ackEntry)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 重传次数过多</span></span><br><span class="line">    <span class="keyword">if</span> (ackEntry.getRetryTimes() &gt; MAX_RETRY_TIMES) &#123;</span><br><span class="line">        <span class="comment">// 不再管它了</span></span><br><span class="line">        ackMap.remove(ackEntry.key);</span><br><span class="line">        udpSendTimeMap.remove(ackEntry.key);</span><br><span class="line">        failedPush += <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> ackEntry;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="comment">// 待应答</span></span><br><span class="line">        ackMap.put(ackEntry.key, ackEntry);</span><br><span class="line">        udpSendTimeMap.put(ackEntry.key, System.currentTimeMillis());</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="comment">// 发送</span></span><br><span class="line">        udpSocket.send(ackEntry.origin);</span><br><span class="line">        ackEntry.increaseRetryTime();</span><br><span class="line">        <span class="comment">// 计划重传</span></span><br><span class="line">        executorService.schedule(<span class="keyword">new</span> Retransmitter(ackEntry), TimeUnit.NANOSECONDS.toMillis(ACK_TIMEOUT_NANOS), TimeUnit.MILLISECONDS);</span><br><span class="line">        <span class="keyword">return</span> ackEntry;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p>这个类据说1.3.0后要被移除了。</p>
<p>ServerListManager#init</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostConstruct</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 提交广播更新服务器状态的任务</span></span><br><span class="line">    GlobalExecutor.registerServerStatusReporter(<span class="keyword">new</span> ServerStatusReporter(), <span class="number">2000</span>);</span><br><span class="line">    <span class="comment">// 提交主动更新成员状态的任务</span></span><br><span class="line">    GlobalExecutor.registerServerInfoUpdater(<span class="keyword">new</span> ServerInfoUpdater());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ServerListManager$ServerStatusReporter#run</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        List&lt;Member&gt; allServers = getServers();</span><br><span class="line">        <span class="comment">// 服务器列表不包含自己，你已经被开除了</span></span><br><span class="line">        <span class="keyword">if</span> (!contains(ApplicationUtils.getLocalAddress())) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (allServers.size() &gt; <span class="number">0</span> &amp;&amp; !ApplicationUtils.getLocalAddress().contains(UtilsAndCommons.LOCAL_HOST_IP)) &#123;</span><br><span class="line">            <span class="comment">// 遍历成员服务器</span></span><br><span class="line">            <span class="keyword">for</span> (Member server : allServers) &#123;</span><br><span class="line">                <span class="comment">// 跳过自己</span></span><br><span class="line">                <span class="keyword">if</span> (Objects.equals(server.getAddress(), ApplicationUtils.getLocalAddress())) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// ...</span></span><br><span class="line">                Message msg = <span class="keyword">new</span> Message();</span><br><span class="line">                msg.setData(status);</span><br><span class="line">                <span class="comment">// 向别的服务器更新自己的状态</span></span><br><span class="line">                synchronizer.send(server.getAddress(), msg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// 计划下一次</span></span><br><span class="line">        GlobalExecutor.registerServerStatusReporter(<span class="keyword">this</span>, switchDomain.getServerStatusSynchronizationPeriodMillis());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ServerListManager#onReceiveServerStatus</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">onReceiveServerStatus</span><span class="params">(String configInfo)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">for</span> (String config : configs) &#123;</span><br><span class="line">        <span class="comment">// site:ip:lastReportTime:weight</span></span><br><span class="line">        String[] params = config.split(<span class="string">"#"</span>);</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="comment">// 找到该Server成员</span></span><br><span class="line">        Member server = Optional.ofNullable(memberManager.find(params[<span class="number">1</span>]))</span><br><span class="line">                .orElse(Member.builder().ip(params[<span class="number">1</span>].split(UtilsAndCommons.IP_PORT_SPLITER)[<span class="number">0</span>]).state(NodeState.UP)</span><br><span class="line">                        .port(Integer.parseInt(params[<span class="number">1</span>].split(UtilsAndCommons.IP_PORT_SPLITER)[<span class="number">1</span>])).build());</span><br><span class="line">        server.setExtendVal(MemberMetaDataConstants.SITE_KEY, params[<span class="number">0</span>]);</span><br><span class="line">        server.setExtendVal(MemberMetaDataConstants.WEIGHT, params.length == <span class="number">4</span> ? Integer.parseInt(params[<span class="number">3</span>]) : <span class="number">1</span>);</span><br><span class="line">        <span class="comment">// 更新它</span></span><br><span class="line">        memberManager.update(server);</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ServerMemberManager#update</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">update</span><span class="params">(Member newMember)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 更新</span></span><br><span class="line">    serverList.computeIfPresent(address, (s, member) -&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (NodeState.DOWN.equals(newMember.getState())) &#123;</span><br><span class="line">            memberAddressInfos.remove(newMember.getAddress());</span><br><span class="line">        &#125;</span><br><span class="line">        MemberUtils.copy(newMember, member);</span><br><span class="line">        <span class="keyword">return</span> member;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 发布成员变化事件</span></span><br><span class="line">    NotifyCenter.publishEvent(MembersChangeEvent.builder()</span><br><span class="line">            .members(allMembers())</span><br><span class="line">            .build());</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>有点花里胡哨，设计过度。我省略了一些代码。</p>
<p>ServerListManager#onEvent</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEvent</span><span class="params">(MembersChangeEvent event)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.servers = <span class="keyword">new</span> ArrayList&lt;&gt;(event.getMembers());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ServerListManager$ServerInfoUpdater#run</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;Member&gt; members = servers;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 取模轮询服务器</span></span><br><span class="line">    <span class="keyword">this</span>.cursor = (<span class="keyword">this</span>.cursor + <span class="number">1</span>) % members.size();</span><br><span class="line">    Member target = members.get(cursor);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        String content = NamingProxy.reqCommon(path, params, server, <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.EMPTY.equals(content)) &#123;</span><br><span class="line">            RaftPeer raftPeer = JacksonUtils.toObj(content, RaftPeer.class);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> != raftPeer) &#123;</span><br><span class="line">                <span class="comment">// ...</span></span><br><span class="line">                <span class="comment">// 主动更新</span></span><br><span class="line">                memberManager.update(target);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception ignore) &#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ServerMemberManager还有一个主动拉取更新服务器配置列表的功能。</p>
<p>ServerMemberManager#initAndStartLookup</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initAndStartLookup</span><span class="params">()</span> <span class="keyword">throws</span> NacosException </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.lookup = LookupFactory.createLookUp(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">this</span>.lookup.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>StandaloneMemberLookup：单机；</p>
</li>
<li><p>FileConfigMemberLookup：从配置文件更新；</p>
</li>
<li><p>AddressServerMemberLookup：从地址服务器更新；</p>
</li>
</ul>
<p>三种方式定期更新服务器列表。</p>
<hr>
<p>ServiceManager#registerInstance</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerInstance</span><span class="params">(String namespaceId, String serviceName, Instance instance)</span> <span class="keyword">throws</span> NacosException </span>&#123;</span><br><span class="line">    <span class="comment">// 创建服务，如果对应的服务不存在</span></span><br><span class="line">    createEmptyService(namespaceId, serviceName, instance.isEphemeral());</span><br><span class="line">    Service service = getService(namespaceId, serviceName);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 注册实例</span></span><br><span class="line">    addInstance(namespaceId, serviceName, instance.isEphemeral(), instance);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ServiceManager#createEmptyService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createServiceIfAbsent</span><span class="params">(String namespaceId, String serviceName, <span class="keyword">boolean</span> local, Cluster cluster)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> NacosException </span>&#123;</span><br><span class="line">    Service service = getService(namespaceId, serviceName);</span><br><span class="line">    <span class="keyword">if</span> (service == <span class="keyword">null</span>) &#123;</span><br><span class="line">        service = <span class="keyword">new</span> Service();</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        service.recalculateChecksum();</span><br><span class="line">        <span class="keyword">if</span> (cluster != <span class="keyword">null</span>) &#123;</span><br><span class="line">            cluster.setService(service);</span><br><span class="line">            service.getClusterMap().put(cluster.getName(), cluster);</span><br><span class="line">        &#125;</span><br><span class="line">        service.validate();</span><br><span class="line">        <span class="comment">// 初始化</span></span><br><span class="line">        putServiceAndInit(service);</span><br><span class="line">        <span class="comment">// 持久化类型的实例</span></span><br><span class="line">        <span class="keyword">if</span> (!local) &#123;</span><br><span class="line">            addOrReplaceService(service);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>层级结构为Service-Cluster-Instance。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">putServiceAndInit</span><span class="params">(Service service)</span> <span class="keyword">throws</span> NacosException </span>&#123;</span><br><span class="line">    <span class="comment">// 加入本地缓存，双重检测加锁保证线程安全</span></span><br><span class="line">    putService(service);</span><br><span class="line">    <span class="comment">// 初始化</span></span><br><span class="line">    service.init();</span><br><span class="line">    <span class="comment">// 向一致性服务注册事件回调，有变化时会自动更新</span></span><br><span class="line">    consistencyService.listen(KeyBuilder.buildInstanceListKey(service.getNamespaceId(), service.getName(), <span class="keyword">true</span>), service);</span><br><span class="line">    consistencyService.listen(KeyBuilder.buildInstanceListKey(service.getNamespaceId(), service.getName(), <span class="keyword">false</span>), service);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Service#init</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 每个Service一个任务，定期检查下属的实例的心跳超时并处理，发布对应的事件等</span></span><br><span class="line">    HealthCheckReactor.scheduleCheck(clientBeatCheckTask);</span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;String, Cluster&gt; entry : clusterMap.entrySet()) &#123;</span><br><span class="line">        entry.getValue().setService(<span class="keyword">this</span>);</span><br><span class="line">        <span class="comment">// 服务端主动的健康检测是交给Cluster处理的</span></span><br><span class="line">        <span class="comment">// 支持Mysql、HTTP、TCP等自定义方式，前提是当前Server根据Distro的映射负责该服务</span></span><br><span class="line">        entry.getValue().init();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>PersistentConsistencyService：负责持久类型的实例的一致性，内部是简单的Raft实现。</li>
<li>EphemeralConsistencyService：负责临时类型的实例的一致性，即需要心跳维持存在。</li>
</ul>
<p>Nacos的Sevice会注册到两种一致性服务上，但是Instance会根据类型注册到对应的服务。</p>
<p>EphemeralConsistencyService在网络分区发生时，写一样会成功，网络恢复后，会合并成一个，所以保证最终一致。</p>
<p>PersistentConsistencyService保证CP，当然是不严格的，因为它只是一个简单的Raft实现，核心一千多行代码。</p>
<p>Naming这里的Raft协议就不多说了，Config的Raft协议使用的是JRaft的实现，之前分析过。</p>
<hr>
<p>InstanceController#beat</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CanDistro</span></span><br><span class="line"><span class="meta">@PutMapping</span>(<span class="string">"/beat"</span>)</span><br><span class="line"><span class="meta">@Secured</span>(parser = NamingResourceParser.class, action = ActionTypes.WRITE)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ObjectNode <span class="title">beat</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    Instance instance = serviceManager.getInstance(namespaceId, serviceName, clusterName, ip, port);</span><br><span class="line">    <span class="comment">// 被移除了</span></span><br><span class="line">    <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// </span></span><br><span class="line">        instance = <span class="keyword">new</span> Instance();</span><br><span class="line">        <span class="comment">// 重新注册</span></span><br><span class="line">        serviceManager.registerInstance(namespaceId, serviceName, instance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Service service = serviceManager.getService(namespaceId, serviceName);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> (clientBeat == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//  处理心跳，有变化时也会主动通知相关的客户端</span></span><br><span class="line">    service.processClientBeat(clientBeat);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p>InstanceController#doSrvIpxt</p>
<p><del>超级长的方法，要是我写出来估计会被领导直接开除（一顿阴阳怪气或者批斗是少不了的）。</del></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ObjectNode <span class="title">doSrvIpxt</span><span class="params">(String namespaceId, String serviceName, String agent, String clusters, String clientIP,</span></span></span><br><span class="line"><span class="function"><span class="params">                            <span class="keyword">int</span> udpPort, String env, <span class="keyword">boolean</span> isCheck, String app, String tid, <span class="keyword">boolean</span> healthyOnly)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    ClientInfo clientInfo = <span class="keyword">new</span> ClientInfo(agent);</span><br><span class="line">    ObjectNode result = JacksonUtils.createEmptyJsonNode();</span><br><span class="line">    Service service = serviceManager.getService(namespaceId, serviceName);</span><br><span class="line">    <span class="comment">// 没有服务</span></span><br><span class="line">    <span class="keyword">if</span> (service == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 这里会创建Client，用于主动向客户端推送变化</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (udpPort &gt; <span class="number">0</span> &amp;&amp; pushService.canEnablePush(agent)) &#123;</span><br><span class="line">            pushService.addClient(namespaceId, serviceName, clusters, agent, <span class="keyword">new</span> InetSocketAddress(clientIP, udpPort), pushDataSource, tid, app);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    List&lt;Instance&gt; srvedIPs;</span><br><span class="line"></span><br><span class="line">    srvedIPs = service.srvIPs(Arrays.asList(StringUtils.split(clusters, <span class="string">","</span>)));</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 没有实例</span></span><br><span class="line">    <span class="keyword">if</span> (CollectionUtils.isEmpty(srvedIPs)) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Map&lt;Boolean, List&lt;Instance&gt;&gt; ipMap = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">2</span>);</span><br><span class="line">    ipMap.put(Boolean.TRUE, <span class="keyword">new</span> ArrayList&lt;&gt;());</span><br><span class="line">    ipMap.put(Boolean.FALSE, <span class="keyword">new</span> ArrayList&lt;&gt;());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Instance ip : srvedIPs) &#123;</span><br><span class="line">        ipMap.get(ip.isHealthy()).add(ip);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">double</span> threshold = service.getProtectThreshold();</span><br><span class="line">    <span class="comment">// 当健康的实例占比小于保护阈值时</span></span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">float</span>) ipMap.get(Boolean.TRUE).size() / srvedIPs.size() &lt;= threshold) &#123;</span><br><span class="line">        <span class="comment">// 把不健康的当成健康的加入，允许部分失败，但是避免流量全部压到健康的实例导致雪崩</span></span><br><span class="line">        ipMap.get(Boolean.TRUE).addAll(ipMap.get(Boolean.FALSE));</span><br><span class="line">        ipMap.get(Boolean.FALSE).clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isCheck) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">return</span> JacksonUtils.createEmptyJsonNode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ArrayNode hosts = JacksonUtils.createEmptyArrayNode();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;Boolean, List&lt;Instance&gt;&gt; entry : ipMap.entrySet()) &#123;</span><br><span class="line">        List&lt;Instance&gt; ips = entry.getValue();</span><br><span class="line">        <span class="keyword">if</span> (healthyOnly &amp;&amp; !entry.getKey()) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (Instance instance : ips) &#123;</span><br><span class="line">            <span class="comment">// remove disabled instance:</span></span><br><span class="line">            <span class="keyword">if</span> (!instance.isEnabled()) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ObjectNode ipObj = JacksonUtils.createEmptyJsonNode();</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">            hosts.add(ipObj);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p>DistroConsistencyServiceImpl#init</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostConstruct</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 定期从别的Server同步数据，全量的，同时触发回调更新</span></span><br><span class="line">    GlobalExecutor.submit(loadDataTask);</span><br><span class="line">    <span class="comment">// 处理变化的通知回调</span></span><br><span class="line">    GlobalExecutor.submitDistroNotifyTask(notifier);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


		<footer>
			 
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

		</footer>
	</div>
	<!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->

	<script>var timeEnd = new Date();console.log('耗时：' + (timeEnd - timeStart));</script>
	<!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
	<!-- material design -->
	<!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
	<!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
	<!-- toc -->
	<!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
	<!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
	<!-- <script src="/js/main.js"></script> -->
</body>
</html>
