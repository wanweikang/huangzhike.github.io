<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
        <script>
            var timeStart = new Date();
        </script>
        
        <title>[ç¬”è®°]-Druid | ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜</title>
        
        <meta name="author" content="huangzhike">
        
        
        <meta name="description" content="ç‰ˆæœ¬1.1.21ã€‚
å­ï¼Œè¯´å¥é¢˜å¤–è¯ï¼Œä¹‹å‰é¢è¯•æŸå¤§å‚çš„æ—¶å€™ï¼Œé¢è¯•å®˜é—®äº†æˆ‘ä¸€ä¸ªé—®é¢˜ï¼Œè¿æ¥æ± æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œæˆ‘çš„å›ç­”æ˜¯ç”¨ä¸€ä¸ªé˜»å¡é˜Ÿåˆ—ï¼ŒAOPæ‹¦æˆªå…³é—­æ–¹æ³•ï¼Œå°†è¿æ¥è¿”å›è¿æ¥æ± ã€‚
å½“æ—¶æˆ‘æ²¡å¤ªå…³æ³¨è¿™æ–¹é¢ï¼Œæ‰€ä»¥åªæ˜¯ç®€å•è¯´äº†æˆ‘çš„æƒ³æ³•ï¼Œä¸è¿‡é¢è¯•å®˜å¬åˆ°æˆ‘ç”¨é˜»å¡é˜Ÿåˆ—å®ç°çš„æ—¶å€™ï¼ŒæƒŠè®¶åœ°å«äº†å‡ºæ¥ï¼Œé¢ï¼Œéš¾é“ä¸å¯ä»¥ä¹ˆã€‚
çœ‹Druid">
        
        
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        
        <meta property="og:title" content="[ç¬”è®°]-Druid"/>
        
        <meta property="og:site_name" content="ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜"/>
        
        
        <!-- favicon -->
        <link rel="icon" type="image/ico" href="/ok.ico" sizes="32x32">
        <meta name="msapplication-TileColor" content="#009688">
        <meta name="msapplication-TileImage" content="/mstile-144x144.ico">
        <meta name="theme-color" content="#009688">
        <!-- favicon end -->
        <!-- <link href="//ok.ico" rel="icon"> -->
        
        <!-- toc -->
        <!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
        <!-- material design -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
        <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
        
        <!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
        <!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
    <meta name="generator" content="Hexo 4.2.1"></head>

<body>
    <nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">èœå•</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" title="ä¸‹ä¸€å¥æ˜¯ï¼šå®¢æœ‰å¯äººæœŸä¸æ¥ã€‚å°æ—¶å€™ï¼Œå–œæ¬¢é åœ¨é˜³å°ä¸Šï¼Œä¸€è¾¹å¹é£ï¼Œä¸€è¾¹çœ‹ä¹¦ï¼Œå–œæ¬¢è¯»ä¹¦å—ï¼Œéªšå¹´ï¼Ÿ" href="/">ä¹¦å½“å¿«æ„è¯»æ˜“å°½</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" target="_blank" rel="noopener" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

    <div class="container" >
        <div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[ç¬”è®°]-Druid</h2>
				
				<div>
					<div class="post-time">2020-05-30</div>
				</div>
				
				<div class="article-content">
				<p>ç‰ˆæœ¬1.1.21ã€‚</p>
<p>å­ï¼Œè¯´å¥é¢˜å¤–è¯ï¼Œä¹‹å‰é¢è¯•æŸå¤§å‚çš„æ—¶å€™ï¼Œé¢è¯•å®˜é—®äº†æˆ‘ä¸€ä¸ªé—®é¢˜ï¼Œè¿æ¥æ± æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œæˆ‘çš„å›ç­”æ˜¯ç”¨ä¸€ä¸ªé˜»å¡é˜Ÿåˆ—ï¼ŒAOPæ‹¦æˆªå…³é—­æ–¹æ³•ï¼Œå°†è¿æ¥è¿”å›è¿æ¥æ± ã€‚</p>
<p>å½“æ—¶æˆ‘æ²¡å¤ªå…³æ³¨è¿™æ–¹é¢ï¼Œæ‰€ä»¥åªæ˜¯ç®€å•è¯´äº†æˆ‘çš„æƒ³æ³•ï¼Œä¸è¿‡é¢è¯•å®˜å¬åˆ°æˆ‘ç”¨é˜»å¡é˜Ÿåˆ—å®ç°çš„æ—¶å€™ï¼ŒæƒŠè®¶åœ°å«äº†å‡ºæ¥ï¼Œé¢ï¼Œéš¾é“ä¸å¯ä»¥ä¹ˆã€‚</p>
<p>çœ‹Druidçš„å®ç°ï¼Œä¹Ÿæ˜¯ç”¨æ•°ç»„ä¿å­˜è¿æ¥ï¼Œç„¶åé€šè¿‡é”å’Œæ¡ä»¶æ§åˆ¶å¹¶å‘ï¼Œè¿™ä¸å°±æ˜¯é˜»å¡é˜Ÿåˆ—ArrayBlockingQueueçš„åŸºæœ¬æ€è·¯ä¹ˆã€‚</p>
<p>è™½ç„¶ç›´æ¥ç”¨é˜»å¡é˜Ÿåˆ—å¯èƒ½ä¸çµæ´»ï¼Œä½†æ˜¯åº”è¯¥ä¹Ÿèƒ½ç”¨å§ï¼ˆå¯èƒ½çš„é—®é¢˜å°±æ˜¯æ¯”è¾ƒéš¾å›æ”¶é—²ç½®çš„è¿æ¥ï¼Œå› ä¸ºæ˜¯FIFOï¼‰ã€‚ã€‚ã€‚</p>
<p>è¿”è¿˜è¿æ¥æ—¶ï¼ŒDruidä¹Ÿæ˜¯åœ¨è¿æ¥çš„ä»£ç†å¯¹è±¡å†…åŒ…äº†ä¸€å±‚è¿‡æ»¤é“¾ï¼Œåœ¨è°ƒç”¨å…³é—­æ–¹æ³•çš„æ—¶å€™å°†è¿æ¥æ”¾å›è¿æ¥æ± ã€‚</p>
<p><del>æ‰€ä»¥å°±æ˜¯æœ‰ç‚¹ç–‘æƒ‘ã€‚ã€‚ã€‚</del></p>
<p>å¥½å§ï¼Œæˆ‘å·²ç»ä¼šè‡ªé—®è‡ªç­”äº†ï¼Œæˆ‘è§‰å¾—åº”è¯¥æ˜¯å› ä¸ºé˜»å¡é˜Ÿåˆ—è¿™ç§é˜Ÿå°¾è¿›é˜Ÿå¤´å‡ºçš„ç»“æ„ä¸é€‚åˆè¿æ¥æ± çš„ä¸šåŠ¡é€»è¾‘ï¼Œæ¯”å¦‚å›æ”¶è¿æ¥æ—¶ï¼Œä¸èƒ½è·³è¿‡å‰é¢çš„è¿æ¥ï¼ˆå…¶å®åº”è¯¥å¯ä»¥åšä¸ªæ‡’å¤„ç†çš„ï¼Œä½†æ˜¯æ€§èƒ½ä¸å¥½ï¼‰ã€‚</p>
<hr>
<p>DruidDataSource#getConnection</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> DruidPooledConnection <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token keyword">long</span> maxWaitMillis<span class="token punctuation">)</span> <span class="token keyword">throws</span> SQLException <span class="token punctuation">{</span>
        <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æœ‰é…ç½®Filterçš„å°±èµ°è¿‡æ»¤é“¾</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>filters<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            FilterChainImpl filterChain <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FilterChainImpl</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> filterChain<span class="token punctuation">.</span><span class="token function">dataSource_connect</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> maxWaitMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å¦åˆ™ç›´æ¥è·å–</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">getConnectionDirect</span><span class="token punctuation">(</span>maxWaitMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>DruidDataSource#init</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> SQLException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">final</span> ReentrantLock lock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è·å–é”æ‰èƒ½ç»§ç»­</span>
            lock<span class="token punctuation">.</span><span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ... </span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// ä»SPIåŠ è½½Filter</span>
            <span class="token function">initFromSPIServiceLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>driver <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>MockDriver<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>driverClass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token comment" spellcheck="true">// åå°„åˆå§‹åŒ–JDBCé©±åŠ¨</span>
                    driver <span class="token operator">=</span> JdbcUtils<span class="token punctuation">.</span><span class="token function">createDriver</span><span class="token punctuation">(</span>driverClassLoader<span class="token punctuation">,</span> driverClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ...</span>
            connections <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DruidConnectionHolder</span><span class="token punctuation">[</span>maxActive<span class="token punctuation">]</span><span class="token punctuation">;</span>
            evictConnections <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DruidConnectionHolder</span><span class="token punctuation">[</span>maxActive<span class="token punctuation">]</span><span class="token punctuation">;</span>
            keepAliveConnections <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DruidConnectionHolder</span><span class="token punctuation">[</span>maxActive<span class="token punctuation">]</span><span class="token punctuation">;</span>

            SQLException connectError <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// é…ç½®äº†åˆ›å»ºè¿æ¥çš„è®¡åˆ’çº¿ç¨‹æ±  &amp;&amp; å¼‚æ­¥åˆå§‹åŒ–</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>createScheduler <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> asyncInit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æäº¤ä»»åŠ¡ç»™çº¿ç¨‹æ± å¼‚æ­¥æ‰§è¡Œ</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> initialSize<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">submitCreateTask</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// é»˜è®¤</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>asyncInit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// åˆå§‹åŒ–è¿æ¥æ± </span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>poolingCount <span class="token operator">&lt;</span> initialSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// åˆ›å»ºè¿æ¥</span>
                        PhysicalConnectionInfo pyConnectInfo <span class="token operator">=</span> <span class="token function">createPhysicalConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        DruidConnectionHolder holder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DruidConnectionHolder</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> pyConnectInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        connections<span class="token punctuation">[</span>poolingCount<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> holder<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å¯åŠ¨æ—¥å¿—çº¿ç¨‹</span>
            <span class="token function">createAndLogThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å¯åŠ¨åˆ›å»ºConnectionçš„åå°çº¿ç¨‹ï¼Œå¦‚æœæ²¡æœ‰é…ç½®è®¡åˆ’çº¿ç¨‹æ± </span>
            <span class="token function">createAndStartCreatorThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å¯åŠ¨é”€æ¯Connectionçš„åå°çº¿ç¨‹ï¼Œå¦‚æœæ²¡æœ‰é…ç½®è®¡åˆ’çº¿ç¨‹æ± </span>
            <span class="token function">createAndStartDestroyThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ç­‰å¾…åˆå§‹åŒ–å®Œæˆ</span>
            initedLatch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// é»˜è®¤å…³é—­</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>keepAlive<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// async fill to minIdle</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>createScheduler <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// æäº¤ä»»åŠ¡ï¼Œåˆ›å»ºæœ€å°é—²ç½®æ•°çš„Connection</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> minIdle<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">submitCreateTask</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emptySignal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Error</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            inited <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>DruidDataSource#getConnectionDirect</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> DruidPooledConnection <span class="token function">getConnectionDirect</span><span class="token punctuation">(</span><span class="token keyword">long</span> maxWaitMillis<span class="token punctuation">)</span> <span class="token keyword">throws</span> SQLException <span class="token punctuation">{</span>
        <span class="token keyword">int</span> notFullTimeoutRetryCnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// handle notFullTimeoutRetry</span>
            DruidPooledConnection poolableConnection<span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// è·å–Connection</span>
                poolableConnection <span class="token operator">=</span> <span class="token function">getConnectionInternal</span><span class="token punctuation">(</span>maxWaitMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">GetConnectionTimeoutException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å°äºè¶…æ—¶é‡è¯•æ¬¡æ•° &amp;&amp; è¿æ¥æ± æ²¡æ»¡</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>notFullTimeoutRetryCnt <span class="token operator">&lt;=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>notFullTimeoutRetryCount <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isFull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    notFullTimeoutRetryCnt<span class="token operator">++</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// é‡è¯•</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// å¦åˆ™æŠ›å¼‚å¸¸</span>
                <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">// å€Ÿå–Connectionæ—¶æ˜¯å¦æ£€æµ‹ï¼Œé»˜è®¤ä¸æ£€æµ‹ï¼Œå¯èƒ½ä¼šè¿”å›å·²ç»è¢«æ•°æ®åº“å…³é—­çš„æ— æ•ˆConnection</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>testOnBorrow<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>poolableConnection<span class="token punctuation">.</span>conn<span class="token punctuation">.</span><span class="token function">isClosed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">discardConnection</span><span class="token punctuation">(</span>poolableConnection<span class="token punctuation">.</span>holder<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ä¼ å…¥nullï¼Œé¿å…é‡å¤å…³é—­</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// æ£€æµ‹é—²ç½®è¿‡ä¹…çš„Connection</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>testWhileIdle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// è¦ç§»é™¤åºŸå¼ƒConnection</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>removeAbandoned<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
                activeConnectionLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å…ˆåŠ å…¥æ´»è·ƒConnectioné›†åˆ</span>
                    activeConnections<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>poolableConnection<span class="token punctuation">,</span> PRESENT<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    activeConnectionLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// è‡ªåŠ¨æäº¤</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultAutoCommit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                poolableConnection<span class="token punctuation">.</span><span class="token function">setAutoCommit</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> poolableConnection<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>DruidDataSource#getConnectionInternal</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> DruidPooledConnection <span class="token function">getConnectionInternal</span><span class="token punctuation">(</span><span class="token keyword">long</span> maxWait<span class="token punctuation">)</span> <span class="token keyword">throws</span> SQLException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// è¿æ¥æ± å·²å…³é—­</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>closed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// è¿æ¥æ± å·²ç¦ç”¨ï¼Œç¦ç”¨åè¿˜è¦å”¤é†’ç­‰å¾…è·å–è¿æ¥çš„çº¿ç¨‹åæ‰èƒ½å…³é—­</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>enable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> <span class="token keyword">long</span> nanos <span class="token operator">=</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">toNanos</span><span class="token punctuation">(</span>maxWait<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> maxWaitThreadCount <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>maxWaitThreadCount<span class="token punctuation">;</span>

        DruidConnectionHolder holder<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// ç›´åˆ°è·å–åˆ°Connection</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">boolean</span> createDirect <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å¦‚æœç›´æ¥åˆ›å»º</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>createDirect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
                <span class="token comment" spellcheck="true">// å½“å‰ä¸èƒ½æœ‰æ­£åœ¨åˆ›å»ºçš„</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>creatingCountUpdater<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// åˆ›å»ºConnection</span>
                    PhysicalConnectionInfo pyConnInfo <span class="token operator">=</span> DruidDataSource<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createPhysicalConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    holder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DruidConnectionHolder</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> pyConnInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    holder<span class="token punctuation">.</span>lastActiveTimeMillis <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// åˆ›å»ºå®Œå‡å›å»</span>
                    creatingCountUpdater<span class="token punctuation">.</span><span class="token function">decrementAndGet</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    directCreateCountUpdater<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">boolean</span> discard <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// è·å–é”ï¼Œä¿è¯æ•°é‡æ›´æ–°çš„åŸå­æ€§</span>
                    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// å½“å‰ä½¿ç”¨ä¸­çš„Connectionæ•°é‡ï¼Œä»è¿æ¥æ± è·å–åˆ°å°±ç®—æ¿€æ´»</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>activeCount <span class="token operator">&lt;</span> maxActive<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            activeCount<span class="token operator">++</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>activeCount <span class="token operator">></span> activePeak<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token comment" spellcheck="true">// æ›´æ–°å·…å³°çš„ä½¿ç”¨æ•°é‡</span>
                                activePeak <span class="token operator">=</span> activeCount<span class="token punctuation">;</span>
                                activePeakTime <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            discard <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// åˆ›å»ºè¶…è¿‡æ•°é‡çš„Connectionè¦åºŸå¼ƒï¼Œå…³é—­Connection</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>discard<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        JdbcUtils<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>pyConnInfo<span class="token punctuation">.</span><span class="token function">getPhysicalConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å¿…é¡»è·å–é”æ‰èƒ½ç»§ç»­</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                lock<span class="token punctuation">.</span><span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">//</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>maxWaitThreadCount <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> notEmptyWaitThreadCount <span class="token operator">>=</span> maxWaitThreadCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">//</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>onFatalError <span class="token operator">&amp;&amp;</span> onFatalErrorMaxActive <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> activeCount <span class="token operator">>=</span> onFatalErrorMaxActive<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// å…¨å±€çš„è·å–Connectionæ¬¡æ•°ï¼Œåªå¢ä¸å‡</span>
                connectCount<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å½“å‰è¿æ¥æ± æ²¡æœ‰Connection &amp;&amp; æ­£åœ¨ä½¿ç”¨çš„Connectionæ•°é‡æ²¡æœ‰è¶…è¿‡é™åˆ¶ &amp;&amp; å½“å‰æ²¡æœ‰åœ¨åˆ›å»ºConnection</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>createScheduler <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> poolingCount <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> activeCount <span class="token operator">&lt;</span> maxActive <span class="token operator">&amp;&amp;</span> creatingCountUpdater<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> createScheduler <span class="token keyword">instanceof</span> <span class="token class-name">ScheduledThreadPoolExecutor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    ScheduledThreadPoolExecutor executor <span class="token operator">=</span> <span class="token punctuation">(</span>ScheduledThreadPoolExecutor<span class="token punctuation">)</span> createScheduler<span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// åˆ›å»ºConnectionçš„è®¡åˆ’ä»»åŠ¡çº¿ç¨‹æ± çš„ä»»åŠ¡é˜Ÿåˆ—è¿˜æœ‰ä»»åŠ¡</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>executor<span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ç›´æ¥åˆ›å»º</span>
                        createDirect <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// é˜»å¡ç­‰å¾…ä»é˜Ÿåˆ—å°¾è·å–Connection</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>maxWait <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    holder <span class="token operator">=</span> <span class="token function">pollLast</span><span class="token punctuation">(</span>nanos<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    holder <span class="token operator">=</span> <span class="token function">takeLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// LOOP ENDS</span>

        <span class="token comment" spellcheck="true">// æ²¡æœ‰è·å–åˆ°Connection</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>holder <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æŠ›å¼‚å¸¸</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// è¯¥Connectionçš„ä½¿ç”¨é‡å¢åŠ </span>
        holder<span class="token punctuation">.</span><span class="token function">incrementUseCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// å†åŒ…è£…Connection</span>
        DruidPooledConnection poolalbeConnection <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DruidPooledConnection</span><span class="token punctuation">(</span>holder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> poolalbeConnection<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>DruidDataSource#pollLast</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> DruidConnectionHolder <span class="token function">pollLast</span><span class="token punctuation">(</span><span class="token keyword">long</span> nanos<span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException<span class="token punctuation">,</span> SQLException <span class="token punctuation">{</span>
        <span class="token keyword">long</span> estimate <span class="token operator">=</span> nanos<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è‡ªæ—‹é‡è¯•</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å½“å‰è¿æ¥æ± å·²ç»æ²¡æœ‰Connectionäº†</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>poolingCount <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å¦‚æœæ²¡æœ‰è®¾ç½®åˆ›å»ºConnectionçš„è®¡åˆ’çº¿ç¨‹æ± ï¼Œåˆ™å”¤é†’é»˜è®¤çš„åˆ›å»ºConnectionçš„åå°çº¿ç¨‹ï¼Œäº¤ç»™å®ƒåˆ›å»ºï¼Œå¦åˆ™æäº¤åˆ›å»ºä»»åŠ¡ç»™è®¡åˆ’çº¿ç¨‹æ± </span>
                <span class="token function">emptySignal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// send signal to CreateThread create connection</span>
                <span class="token comment" spellcheck="true">// è®¾ç½®äº†å¿«é€Ÿå¤±è´¥ &amp;&amp; å·²ç»è¢«æ ‡è®°ä¸ºåˆ›å»ºConnectionæŒç»­æ€§å¤±è´¥</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>failFast <span class="token operator">&amp;&amp;</span> <span class="token function">isFailContinuous</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">DataSourceNotAvailableException</span><span class="token punctuation">(</span>createError<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>estimate <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    waitNanosLocal<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>nanos <span class="token operator">-</span> estimate<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// è¿æ¥æ± ä¸ºç©ºï¼Œç­‰å¾…åˆ›å»ºçš„çº¿ç¨‹è®¡æ•°è‡ªå¢</span>
                notEmptyWaitThreadCount<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// æ›´æ–°è¯¥å·…å³°å€¼</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>notEmptyWaitThreadCount <span class="token operator">></span> notEmptyWaitThreadPeak<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    notEmptyWaitThreadPeak <span class="token operator">=</span> notEmptyWaitThreadCount<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">long</span> startEstimate <span class="token operator">=</span> estimate<span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// ç­‰å¾…å½’è¿˜æˆ–åˆ›å»ºConnectionæ—¶å”¤é†’</span>
                    estimate <span class="token operator">=</span> notEmpty<span class="token punctuation">.</span><span class="token function">awaitNanos</span><span class="token punctuation">(</span>estimate<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// signal by recycle or creator</span>
                    <span class="token comment" spellcheck="true">// å…¨å±€çš„ç­‰å¾…åˆ›å»ºæ¬¡æ•°ï¼Œåªå¢ä¸å‡</span>
                    notEmptyWaitCount<span class="token operator">++</span><span class="token punctuation">;</span>
                    notEmptyWaitNanos <span class="token operator">+=</span> <span class="token punctuation">(</span>startEstimate <span class="token operator">-</span> estimate<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// è¿æ¥æ± è¢«ç¦ç”¨äº†</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>enable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ie<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    notEmpty<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// propagate to non-interrupted thread</span>
                    notEmptySignalCount<span class="token operator">++</span><span class="token punctuation">;</span>
                    <span class="token keyword">throw</span> ie<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ç­‰å¾…åˆ›å»ºçš„çº¿ç¨‹è®¡æ•°è‡ªå‡</span>
                    notEmptyWaitThreadCount<span class="token operator">--</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// è¶…æ—¶åä»æœªåˆ›å»ºConnection</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>poolingCount <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>estimate <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    waitNanosLocal<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>nanos <span class="token operator">-</span> estimate<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// è¿æ¥æ± è¿˜æœ‰Connectionï¼Œå…ˆå‡è®¡æ•°</span>
            <span class="token function">decrementPoolingCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ ˆ FILO</span>
            DruidConnectionHolder last <span class="token operator">=</span> connections<span class="token punctuation">[</span>poolingCount<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ç§»å‡ºè¿æ¥æ± </span>
            connections<span class="token punctuation">[</span>poolingCount<span class="token punctuation">]</span> <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">return</span> last<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>DruidDataSource$CreateConnectionThread#run</p>
<p>é»˜è®¤çš„åˆ›å»ºè¿æ¥çš„çº¿ç¨‹ï¼Œå¦‚æœé…ç½®äº†ä¸“é—¨çš„åˆ›å»ºè¿æ¥çš„çº¿ç¨‹æ± çš„è¯ï¼Œåˆ™æ˜¯å¦å¤–ä»¥æäº¤ä»»åŠ¡çš„æ–¹å¼åˆ›å»ºã€‚</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            initedLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">long</span> lastDiscardCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> errorCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// Loopç›´åˆ°è¢«ä¸­æ–­</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// addLast</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ç­‰å¾…è·å–é”</span>
                    lock<span class="token punctuation">.</span><span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">long</span> discardCount <span class="token operator">=</span> DruidDataSource<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>discardCount<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ä¸Šæ¬¡LOOPåˆ°ç°åœ¨æœ‰æ–°çš„Connectionè¢«æŠ›å¼ƒ</span>
                <span class="token keyword">boolean</span> discardChanged <span class="token operator">=</span> discardCount <span class="token operator">-</span> lastDiscardCount <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span>
                lastDiscardCount <span class="token operator">=</span> discardCount<span class="token punctuation">;</span>

                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">boolean</span> emptyWait <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// æ²¡æœ‰å‘ç”Ÿåˆ›å»ºé”™è¯¯ &amp;&amp; å½“å‰è¿æ¥æ± æ²¡æœ‰Connection &amp;&amp; æ²¡æœ‰æ–°çš„Connectionè¢«åºŸå¼ƒ</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>createError <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> poolingCount <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>discardChanged<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ä¸éœ€è¦ç­‰å¾…è¿æ¥æ± ä¸ºç©ºæ—¶æ‰åˆ›å»º</span>
                        emptyWait <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// å¼‚æ­¥åˆå§‹åŒ–ç›¸å…³</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>emptyWait <span class="token operator">&amp;&amp;</span> asyncInit <span class="token operator">&amp;&amp;</span> createCount <span class="token operator">&lt;</span> initialSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        emptyWait <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// ç­‰å¾…Connectionç”¨å®Œæ‰åˆ›å»º</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>emptyWait<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ç°å­˜çš„Connectionæ•°é‡ >= ç­‰å¾…åˆ›å»ºConnectionçº¿ç¨‹æ•°é‡ &amp;&amp; ä»è¿æ¥æ± æ‹¿å‡ºæ­£åœ¨ä½¿ç”¨çš„Connectionæ•°é‡ + è¿æ¥æ± ç°å­˜çš„æ•°é‡ &lt; æœ€å°é—²ç½®æ•°é‡</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>poolingCount <span class="token operator">>=</span> notEmptyWaitThreadCount <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>keepAlive <span class="token operator">&amp;&amp;</span> activeCount <span class="token operator">+</span> poolingCount <span class="token operator">&lt;</span> minIdle<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isFailContinuous</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// é˜»å¡ç­‰å¾…è¿æ¥æ± è¢«ç”¨å®Œæ—¶å”¤é†’</span>
                            empty<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        <span class="token comment" spellcheck="true">// é˜²æ­¢åˆ›å»ºè¶…è¿‡maxActiveæ•°é‡çš„è¿æ¥</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>activeCount <span class="token operator">+</span> poolingCount <span class="token operator">>=</span> maxActive<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            empty<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">continue</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>

                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                PhysicalConnectionInfo connection <span class="token operator">=</span> null<span class="token punctuation">;</span>

                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// åˆ›å»ºæ•°æ®åº“çš„Connectionï¼Œå¹¶åŒ…è£…FilterChainå’ŒPhysicalConnectionInfo</span>
                    connection <span class="token operator">=</span> <span class="token function">createPhysicalConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SQLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    errorCount<span class="token operator">++</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// åˆ›å»ºå¤±è´¥é‡è¯•æ¬¡æ•°è¿‡å¤š &amp;&amp; é…ç½®äº†é—´éš”å€¼ï¼Œé»˜è®¤500</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>errorCount <span class="token operator">></span> connectionErrorRetryAttempts <span class="token operator">&amp;&amp;</span> timeBetweenConnectErrorMillis <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// fail over retry attempts</span>
                        <span class="token function">setFailContinuous</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>failFast<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                                <span class="token comment" spellcheck="true">// å”¤é†’é˜»å¡ç­‰å¾…è·å–Connectionçš„çº¿ç¨‹ï¼Œå¿«é€Ÿå¤±è´¥</span>
                                notEmpty<span class="token punctuation">.</span><span class="token function">signalAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                                lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment" spellcheck="true">// é»˜è®¤è·å–å¤±è´¥ä¸è·³å‡º</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>breakAfterAcquireFailure<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        <span class="token keyword">try</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// åœ¨é—´éš”é…ç½®çš„æ—¶é—´åå†é‡è¯•</span>
                            Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>timeBetweenConnectErrorMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> interruptEx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">setFailContinuous</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Error</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment" spellcheck="true">// æ²¡åˆ›å»ºæˆåŠŸï¼Œä¸‹ä¸ªå¾ªç¯ç»§ç»­</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>connection <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// å°†ConnectionåŠ å…¥è¿æ¥æ± ï¼Œå¹¶å”¤é†’ç­‰å¾…çš„çº¿ç¨‹</span>
                <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token function">put</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    JdbcUtils<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>connection<span class="token punctuation">.</span><span class="token function">getPhysicalConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                errorCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// reset errorCount</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span></code></pre>
<hr>
<p>DruidPooledConnection#close</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> SQLException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Connectionå‘ç”Ÿå¼‚å¸¸æˆ–è€…å·²ç»å…³é—­</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>disable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        DruidConnectionHolder holder <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>holder<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è¯´æ˜Connectionå·²ç»è¢«å…³é—­ï¼Œé‡å¤å…³é—­</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>holder <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        DruidAbstractDataSource dataSource <span class="token operator">=</span> holder<span class="token punctuation">.</span><span class="token function">getDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> isSameThread <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getOwnerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å…³é—­Connectionçš„å½“å‰çº¿ç¨‹ä¸æ˜¯è·å–Connectionçš„Ownerçº¿ç¨‹</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isSameThread<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            dataSource<span class="token punctuation">.</span><span class="token function">setAsyncCloseConnectionEnable</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// éOwnerçº¿ç¨‹åªæœ‰è·å–äº†Connectionçš„é”æ‰èƒ½æ‰§è¡Œå…³é—­ï¼Œåœºæ™¯æ˜¯ï¼Ÿ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dataSource<span class="token punctuation">.</span><span class="token function">isAsyncCloseConnectionEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">syncClose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// è§¦å‘Connectionå…³é—­äº‹ä»¶ç›‘å¬å™¨</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>ConnectionEventListener listener <span class="token operator">:</span> holder<span class="token punctuation">.</span><span class="token function">getConnectionEventListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            listener<span class="token punctuation">.</span><span class="token function">connectionClosed</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ConnectionEvent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        List<span class="token operator">&lt;</span>Filter<span class="token operator">></span> filters <span class="token operator">=</span> dataSource<span class="token punctuation">.</span><span class="token function">getProxyFilters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æœ‰é…ç½®è¿‡æ»¤å™¨çš„èµ°è¿‡æ»¤é“¾ï¼Œå¦åˆ™ç›´æ¥å›æ”¶</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>filters<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            FilterChainImpl filterChain <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FilterChainImpl</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
            filterChain<span class="token punctuation">.</span><span class="token function">dataSource_recycle</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>disable <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">recycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> SQLException <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>disable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        DruidConnectionHolder holder <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>holder<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>holder <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>abandoned<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            DruidAbstractDataSource dataSource <span class="token operator">=</span> holder<span class="token punctuation">.</span><span class="token function">getDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ”¾å›è¿æ¥æ± </span>
            dataSource<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>holder <span class="token operator">=</span> null<span class="token punctuation">;</span>
        conn <span class="token operator">=</span> null<span class="token punctuation">;</span>
        transactionInfo <span class="token operator">=</span> null<span class="token punctuation">;</span>
        closed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>DruidDataSource#recycle</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">recycle</span><span class="token punctuation">(</span>DruidPooledConnection pooledConnection<span class="token punctuation">)</span> <span class="token keyword">throws</span> SQLException <span class="token punctuation">{</span>
        <span class="token keyword">final</span> DruidConnectionHolder holder <span class="token operator">=</span> pooledConnection<span class="token punctuation">.</span>holder<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>holder <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">final</span> Connection physicalConnection <span class="token operator">=</span> holder<span class="token punctuation">.</span>conn<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>pooledConnection<span class="token punctuation">.</span>traceEnable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Object oldInfo <span class="token operator">=</span> null<span class="token punctuation">;</span>
            activeConnectionLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>pooledConnection<span class="token punctuation">.</span>traceEnable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ä»å½“å‰æ´»è·ƒçš„è¿æ¥åˆ—è¡¨ç§»é™¤ï¼Œæ´»è·ƒæŒ‡çš„æ˜¯ä»è¿æ¥æ± å€Ÿå‡ºå»</span>
                    oldInfo <span class="token operator">=</span> activeConnections<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>pooledConnection<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    pooledConnection<span class="token punctuation">.</span>traceEnable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                activeConnectionLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">final</span> <span class="token keyword">boolean</span> isAutoCommit <span class="token operator">=</span> holder<span class="token punctuation">.</span>underlyingAutoCommit<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> isReadOnly <span class="token operator">=</span> holder<span class="token punctuation">.</span>underlyingReadOnly<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> testOnReturn <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>testOnReturn<span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å¦‚æœConnectionæ²¡æœ‰æ‰“å¼€è‡ªåŠ¨æäº¤ï¼Œå¹¶ä¸”å…è®¸å†™æ“ä½œï¼Œé‚£ä¹ˆå›æ»š</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span>isAutoCommit<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span>isReadOnly<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                pooledConnection<span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">// é‡ç½®Holderçš„ä¿¡æ¯ï¼Œæ–¹ä¾¿ä¸‹æ¬¡å¤ç”¨</span>
            <span class="token keyword">boolean</span> isSameThread <span class="token operator">=</span> pooledConnection<span class="token punctuation">.</span>ownerThread <span class="token operator">==</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å…³é—­å’Œè·å–Connectionçš„çº¿ç¨‹ä¸æ˜¯åŒä¸€ä¸ªï¼Œå³éOwnerçº¿ç¨‹å¿…é¡»è·å–Connectionçš„é”æ‰èƒ½å‘ä¸‹æ‰§è¡Œ</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isSameThread<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> ReentrantLock lock <span class="token operator">=</span> pooledConnection<span class="token punctuation">.</span>lock<span class="token punctuation">;</span>
                lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    holder<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                holder<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// è¢«æ ‡è®°ä¸ºåºŸå¼ƒçš„Connectionä¸ä¼šå†å›æ”¶</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>holder<span class="token punctuation">.</span>discard<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">// Connectionä½¿ç”¨æ¬¡æ•°è¶…è¿‡äº†æœ€å¤§çš„é™åˆ¶åˆ™åºŸå¼ƒï¼Œä¸å†å›æ”¶</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>phyMaxUseCount <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> holder<span class="token punctuation">.</span>useCount <span class="token operator">>=</span> phyMaxUseCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">discardConnection</span><span class="token punctuation">(</span>holder<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å¦‚æœè¢«åŒ…è£…çš„æ•°æ®åº“çš„ç‰©ç†è¿æ¥å·²ç»è¢«å…³é—­ï¼Œåˆ™æ›´æ–°ä¸€ä¸‹è®¡æ•°ï¼Œä¸å†ç»§ç»­</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>physicalConnection<span class="token punctuation">.</span><span class="token function">isClosed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    activeCount<span class="token operator">--</span><span class="token punctuation">;</span>
                    closeCount<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å¦‚æœé…ç½®å¼€å¯äº†è¿”å›è¿æ¥æ± æ—¶æ£€æµ‹è¿æ¥ï¼Œé»˜è®¤å…³é—­ï¼Œæ£€æµ‹ä¸é€šè¿‡åˆ™ä¸æ”¾å›è¿æ¥æ± </span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>testOnReturn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">boolean</span> validate <span class="token operator">=</span> <span class="token function">testConnectionInternal</span><span class="token punctuation">(</span>holder<span class="token punctuation">,</span> physicalConnection<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>validate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    JdbcUtils<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>physicalConnection<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    destroyCountUpdater<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        activeCount<span class="token operator">--</span><span class="token punctuation">;</span>
                        closeCount<span class="token operator">++</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å¦‚æœè¿æ¥æ± å·²ç»è¢«ç¦ç”¨äº†ï¼Œé‚£ä¹ˆåºŸå¼ƒè¿æ¥ï¼Œä¸å†å›æ”¶</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>enable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">discardConnection</span><span class="token punctuation">(</span>holder<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">boolean</span> result<span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> currentTimeMillis <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// åˆ›å»ºConnectionåˆ°ç°åœ¨æ—¶é—´è¿‡é•¿ï¼Œé‚£ä¹ˆåºŸå¼ƒè¿æ¥ï¼Œä¸å†å›æ”¶</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>phyTimeoutMillis <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">long</span> phyConnectTimeMillis <span class="token operator">=</span> currentTimeMillis <span class="token operator">-</span> holder<span class="token punctuation">.</span>connectTimeMillis<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>phyConnectTimeMillis <span class="token operator">></span> phyTimeoutMillis<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">discardConnection</span><span class="token punctuation">(</span>holder<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å…ˆè·å–è¿æ¥æ± çš„é”æ‰èƒ½æ”¾å›è¿æ¥</span>
            lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// è·å–æ—¶è‡ªå¢ï¼Œè¿”å›æ—¶è‡ªå‡ï¼Œä»£è¡¨æ­£åœ¨ä½¿ç”¨çš„Connectionæ•°é‡</span>
                activeCount<span class="token operator">--</span><span class="token punctuation">;</span>
                closeCount<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// æ”¾å›è¿æ¥æ± </span>
                result <span class="token operator">=</span> <span class="token function">putLast</span><span class="token punctuation">(</span>holder<span class="token punctuation">,</span> currentTimeMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
                recycleCount<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// æ”¾å›è¿æ¥æ± å¤±è´¥ï¼Œè¦æŠŠConnectionå…³é—­</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                JdbcUtils<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>holder<span class="token punctuation">.</span>conn<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>æ€»ç»“ï¼š</p>
<p>Druidæ˜¯ä¸€ä¸ªéå¸¸ç¹é‡çš„æ•°æ®åº“è¿æ¥æ± ï¼Œç»´æŠ¤äº†å¤§é‡çš„ç»Ÿè®¡å‚æ•°å’ŒçŠ¶æ€ï¼Œæ‰©å±•é€šè¿‡è¿‡æ»¤é“¾å®ç°ã€‚</p>
<p>æ•°ç»„å®ç°çš„æ ˆï¼ˆFILOï¼‰ï¼ŒåŠ é”å’Œæ¡ä»¶å”¤é†’è¿›è¡Œå¹¶å‘å’Œæµç¨‹æ§åˆ¶ã€‚</p>
<p>è¯è¯´ä¸ºä»€ä¹ˆæ˜¯FILOä¸æ˜¯FIFOï¼Œå¤§æ¦‚æ˜¯å°½é‡è·å–æœ€æ–°çš„è¿æ¥ï¼Ÿ</p>
<p>å¦å¤–æˆ‘è§‰å¾—ä¸€ä¸ªç±»å†™äº†å¤ªå¤šçš„é€»è¾‘ï¼ŒDruidDataSourceè¿™ä¸ªä¸»ç±»å°±æœ‰è¿‘å››åƒè¡Œä»£ç ï¼Œæ‹†åˆ†ä¸€ä¸‹æ˜¯ä¸æ˜¯å¯¹ç»´æŠ¤å’Œé˜…è¯»æ›´åŠ å‹å¥½å‘¢ï¼Ÿ</p>
<p>æ°´å¹³æœ‰é™ï¼Œä¸è¯´å¤ªå¤šã€‚</p>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


        <footer>
             
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

        </footer>
    </div>
    <!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
    <script>
        var timeEnd = new Date();
        console.log('è€—æ—¶ï¼š' + (timeEnd - timeStart));
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre').forEach((block) => {
                block.classList.add("line-numbers");
            });
        });
    </script>
    <!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
    <!-- material design -->
    <!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
    <!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
    <!-- toc -->
    <!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
    <!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
    <!-- <script src="/js/main.js"></script> -->
    <script src="/js/prism.js"></script>
</body>
</html>
