<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
        <script>
            var timeStart = new Date();
        </script>
        
        <title>[ç¬”è®°]-Sentinel | ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜</title>
        
        <meta name="author" content="huangzhike">
        
        
        <meta name="description" content="ç‰ˆæœ¬ï¼š1.8.0-SNAPSHOT
å‚è€ƒå®˜æ–¹æ–‡æ¡£å’ŒWIKIã€‚

Hystrixçš„èµ„æºæ¨¡å‹è®¾è®¡ä¸Šé‡‡ç”¨äº†å‘½ä»¤æ¨¡å¼ï¼Œå°†å¯¹èµ„æºçš„è°ƒç”¨å’ŒFallbacké€»è¾‘å°è£…æˆä¸€ä¸ªå‘½ä»¤å¯¹è±¡ã€‚
çº¿ç¨‹æ± éš”ç¦»æ¨¡å¼ä¸‹éœ€è¦é…ç½®çº¿ç¨‹æ± å¯¹åº”çš„å‚æ•°ï¼Œç„¶åCommandåœ¨æŒ‡å®šçš„çº¿ç¨‹æ± æŒ‰ç…§æŒ‡å®šçš„å®¹é”™ç­–ç•¥æ‰§è¡Œã€‚
ä¿¡å·é‡éš”ç¦»æ¨¡å¼ä¸‹éœ€è¦é…ç½®æœ€å¤§å¹¶å‘">
        
        
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        
        <meta property="og:title" content="[ç¬”è®°]-Sentinel"/>
        
        <meta property="og:site_name" content="ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜"/>
        
        
        <!-- favicon -->
        <link rel="icon" type="image/ico" href="/ok.ico" sizes="32x32">
        <meta name="msapplication-TileColor" content="#009688">
        <meta name="msapplication-TileImage" content="/mstile-144x144.ico">
        <meta name="theme-color" content="#009688">
        <!-- favicon end -->
        <!-- <link href="//ok.ico" rel="icon"> -->
        
        <!-- toc -->
        <!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
        <!-- material design -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
        <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
        
        <!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
        <!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
    <meta name="generator" content="Hexo 4.2.1"></head>

<body>
    <nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">èœå•</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" title="ä¸‹ä¸€å¥æ˜¯ï¼šå®¢æœ‰å¯äººæœŸä¸æ¥ã€‚å°æ—¶å€™ï¼Œå–œæ¬¢é åœ¨é˜³å°ä¸Šï¼Œä¸€è¾¹å¹é£ï¼Œä¸€è¾¹çœ‹ä¹¦ï¼Œå–œæ¬¢è¯»ä¹¦å—ï¼Œéªšå¹´ï¼Ÿ" href="/">ä¹¦å½“å¿«æ„è¯»æ˜“å°½</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" target="_blank" rel="noopener" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

    <div class="container" >
        <div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[ç¬”è®°]-Sentinel</h2>
				
				<div>
					<div class="post-time">2020-07-12</div>
				</div>
				
				<div class="article-content">
				<p>ç‰ˆæœ¬ï¼š1.8.0-SNAPSHOT</p>
<p>å‚è€ƒ<a href="https://sentinelguard.io/zh-cn/docs/introduction.html" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a>å’Œ<a href="https://github.com/alibaba/Sentinel/wiki/" target="_blank" rel="noopener">WIKI</a>ã€‚</p>
<hr>
<p>Hystrixçš„èµ„æºæ¨¡å‹è®¾è®¡ä¸Šé‡‡ç”¨äº†å‘½ä»¤æ¨¡å¼ï¼Œå°†å¯¹èµ„æºçš„è°ƒç”¨å’ŒFallbacké€»è¾‘å°è£…æˆä¸€ä¸ªå‘½ä»¤å¯¹è±¡ã€‚</p>
<p>çº¿ç¨‹æ± éš”ç¦»æ¨¡å¼ä¸‹éœ€è¦é…ç½®çº¿ç¨‹æ± å¯¹åº”çš„å‚æ•°ï¼Œç„¶åCommandåœ¨æŒ‡å®šçš„çº¿ç¨‹æ± æŒ‰ç…§æŒ‡å®šçš„å®¹é”™ç­–ç•¥æ‰§è¡Œã€‚</p>
<p>ä¿¡å·é‡éš”ç¦»æ¨¡å¼ä¸‹éœ€è¦é…ç½®æœ€å¤§å¹¶å‘æ•°ï¼Œæ‰§è¡ŒCommandæ—¶Hystrixå°±ä¼šé™åˆ¶å…¶å¹¶å‘è°ƒç”¨ã€‚</p>
<p>Sentinelçš„èµ„æºä¸è§„åˆ™é…ç½®çš„è€¦åˆåº¦æ›´ä½ã€‚</p>
<p>Sentinelå¹¶ä¸æŒ‡å®šæ‰§è¡Œæ¨¡å‹ï¼Œä¹Ÿä¸å…³æ³¨åº”ç”¨æ˜¯å¦‚ä½•æ‰§è¡Œçš„ã€‚</p>
<p>Sentinelæ²¡æœ‰æä¾›çº¿ç¨‹æ± éš”ç¦»ï¼Œè€Œæä¾›äº†ä¿¡å·é‡éš”ç¦»è¿™ç§è½»é‡çº§çš„éš”ç¦»æ–¹å¼ã€‚</p>
<p>Sentinelé€šè¿‡å¹¶å‘çº¿ç¨‹æ•°æ¨¡å¼çš„æµé‡æ§åˆ¶æ¥æä¾›ä¿¡å·é‡éš”ç¦»çš„åŠŸèƒ½ã€‚</p>
<p>çº¿ç¨‹æ± éš”ç¦»çš„å¥½å¤„æ˜¯éš”ç¦»åº¦æ¯”è¾ƒé«˜ï¼Œä»£ä»·å°±æ˜¯çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æ¯”è¾ƒå¤§ï¼Œå¯¹ä½å»¶æ—¶çš„è°ƒç”¨æœ‰æ¯”è¾ƒå¤§çš„å½±å“ã€‚</p>
<p>å®é™…æƒ…å†µä¸‹ï¼Œè¿‡å¤šçš„çº¿ç¨‹æ± ä¼šéå¸¸å½±å“æ€§èƒ½ã€‚</p>
<p>è€ƒè™‘åœ¨Tomcatä¹‹ç±»çš„Servletå®¹å™¨ä½¿ç”¨Hystrixï¼Œæœ¬èº«Tomcatè‡ªèº«çš„å°±æœ‰å·¥ä½œçº¿ç¨‹æ± ï¼Œå¦‚æœåŠ ä¸ŠHystrixä¸ºå„ä¸ªèµ„æºåˆ›å»ºçš„çº¿ç¨‹æ± ï¼Œæ€»å…±çº¿ç¨‹æ•°ç›®ä¼šéå¸¸å¤šï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢ä¼šæœ‰éå¸¸å¤§çš„æŸè€—ã€‚</p>
<hr>
<p>CtSph#entry</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> Entry <span class="token function">entry</span><span class="token punctuation">(</span>String name<span class="token punctuation">,</span> EntryType type<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> Object<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> BlockException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// èµ„æºæ ‡è¯†</span>
        StringResourceWrapper resource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringResourceWrapper</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">entry</span><span class="token punctuation">(</span>resource<span class="token punctuation">,</span> count<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>CtSph#entryWithPriority</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> Entry <span class="token function">entryWithPriority</span><span class="token punctuation">(</span>ResourceWrapper resourceWrapper<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token keyword">boolean</span> prioritized<span class="token punctuation">,</span> Object<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> BlockException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ä»çº¿ç¨‹æœ¬åœ°å˜é‡è·å–ä¸Šä¸‹æ–‡</span>
        Context context <span class="token operator">=</span> ContextUtil<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è¯´æ˜Sentinelä¿å­˜çš„ä¸Šä¸‹æ–‡é›†åˆå¤§å°å·²ç»è¶…å‡ºé˜ˆå€¼äº†ï¼Œä¸ä¼šå†è¿›è¡Œè¿‡æ»¤ï¼Œç›´æ¥æ”¾è¡Œ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>context <span class="token keyword">instanceof</span> <span class="token class-name">NullContext</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CtEntry</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">,</span> null<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// æ²¡æœ‰ä¸Šä¸‹æ–‡çš„è¯å°±è®¾ç½®ä¸€ä¸ªé»˜è®¤çš„ï¼Œå°±å«sentinel_default_contextï¼Œä¸Šä¸‹æ–‡çš„åç§°å¯èƒ½ç›¸åŒ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>context <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            context <span class="token operator">=</span> InternalContextUtil<span class="token punctuation">.</span><span class="token function">internalEnter</span><span class="token punctuation">(</span>Constants<span class="token punctuation">.</span>CONTEXT_DEFAULT_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Sentinelå…¨å±€çš„å¼€å…³ï¼Œå…³é—­çš„è¯ä¸ä¼šå†è¿›è¡Œè¿‡æ»¤ï¼Œç›´æ¥æ”¾è¡Œ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Constants<span class="token punctuation">.</span>ON<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CtEntry</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">,</span> null<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// æ ¹æ®èµ„æºåç§°è·å–è¿‡æ»¤é“¾ï¼Œä¸€ä¸ªèµ„æºå…±ç”¨ä¸€ä¸ªé“¾</span>
        ProcessorSlot<span class="token operator">&lt;</span>Object<span class="token operator">></span> chain <span class="token operator">=</span> <span class="token function">lookProcessChain</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// è¯´æ˜Sentinelä¿å­˜çš„å¤„ç†é“¾é›†åˆå¤§å°å·²ç»è¶…å‡ºé˜ˆå€¼äº†ï¼Œä¸ä¼šå†è¿›è¡Œè¿‡æ»¤ï¼Œç›´æ¥æ”¾è¡Œ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>chain <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CtEntry</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">,</span> null<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        Entry e <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CtEntry</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">,</span> chain<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ‰§è¡Œè¿‡æ»¤</span>
            chain<span class="token punctuation">.</span><span class="token function">entry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> null<span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BlockException</span> e1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span>count<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> e1<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> e<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ContextUtil#trueEnter</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">protected</span> <span class="token keyword">static</span> Context <span class="token function">trueEnter</span><span class="token punctuation">(</span>String name<span class="token punctuation">,</span> String origin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ä»çº¿ç¨‹æœ¬åœ°å˜é‡è·å–ä¸Šä¸‹æ–‡</span>
        Context context <span class="token operator">=</span> contextHolder<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>context <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> DefaultNode<span class="token operator">></span> localCacheNameMap <span class="token operator">=</span> contextNameNodeMap<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ä»å…¨å±€çš„é›†åˆæ ¹æ®Contextåç§°å–å‡ºEntranceNodeï¼Œä½¿ç”¨é»˜è®¤çš„åç§°çš„è¯å…¨å±€å°±ä¸€ä¸ªEntranceNode</span>
            DefaultNode node <span class="token operator">=</span> localCacheNameMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Contextåç§°æ•°é‡è¶…å‡ºé˜ˆå€¼</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>localCacheNameMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> Constants<span class="token punctuation">.</span>MAX_CONTEXT_NAME_SIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">setNullContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> NULL_CONTEXT<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    LOCK<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        node <span class="token operator">=</span> contextNameNodeMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// åŒé‡æ£€æŸ¥åŠ é”</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>contextNameNodeMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> Constants<span class="token punctuation">.</span>MAX_CONTEXT_NAME_SIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token function">setNullContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">return</span> NULL_CONTEXT<span class="token punctuation">;</span>
                            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                                node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EntranceNode</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringResourceWrapper</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> EntryType<span class="token punctuation">.</span>IN<span class="token punctuation">)</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token comment" spellcheck="true">// ä¸ºè¯¥Contextåç§°åˆ›å»ºä¸€ä¸ªEntranceNodeï¼Œå¹¶æŒ‚è½½åœ¨å…¨å±€çš„æ ¹èŠ‚ç‚¹ä¸‹ï¼Œä¸åŒçš„èµ„æºå¯èƒ½å…±äº«ä¸€ä¸ªEntranceNode</span>
                                Constants<span class="token punctuation">.</span>ROOT<span class="token punctuation">.</span><span class="token function">addChild</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token comment" spellcheck="true">// è¿™é‡Œä¹Ÿæ˜¯CopyOnWriteçš„æ€æƒ³ï¼Œè¯»ä¸åŠ é”ï¼Œå†™åŠ é”ï¼Œå†™æ—¶å¤åˆ¶</span>
                                Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> DefaultNode<span class="token operator">></span> newMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>contextNameNodeMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                newMap<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>contextNameNodeMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                newMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                contextNameNodeMap <span class="token operator">=</span> newMap<span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                        LOCK<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ä¼ å…¥EntranceNodeï¼Œå…¥å£èŠ‚ç‚¹</span>
            context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Context</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            context<span class="token punctuation">.</span><span class="token function">setOrigin</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è®¾ç½®Contextä¸Šä¸‹æ–‡</span>
            contextHolder<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> context<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>å¼‚æ­¥çš„æƒ…å†µï¼š</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">runOnContext</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> Runnable f<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// å…ˆå–å‡ºåŸæœ¬Contextå¹¶æ›¿æ¢</span>
        Context curContext <span class="token operator">=</span> <span class="token function">replaceContext</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            f<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ‰§è¡Œå®Œå†è¿˜åŸ</span>
            <span class="token function">replaceContext</span><span class="token punctuation">(</span>curContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>å¼‚æ­¥å¤„ç†è¿˜æ˜¯æŒºå¤æ‚çš„ï¼Œç•¥è¿‡ä¸çœ‹ã€‚</p>
<p>CtSph#lookProcessChain</p>
<pre class=" language-java"><code class="language-java">    ProcessorSlot<span class="token operator">&lt;</span>Object<span class="token operator">></span> <span class="token function">lookProcessChain</span><span class="token punctuation">(</span>ResourceWrapper resourceWrapper<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// è·å–è¯¥èµ„æºåç§°å¯¹åº”çš„ProcessorSlotChain</span>
        ProcessorSlotChain chain <span class="token operator">=</span> chainMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>chain <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>LOCK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                chain <span class="token operator">=</span> chainMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// åŒé‡æ£€æŸ¥åŠ é”</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>chain <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// Entry size limit.</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>chainMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> Constants<span class="token punctuation">.</span>MAX_SLOT_CHAIN_SIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// SPIåŠ è½½è¿‡æ»¤å™¨ï¼Œç”Ÿæˆè¿‡æ»¤é“¾ï¼Œé€šè¿‡@SpiOrderæ³¨è§£è¿›è¡Œæ’åºï¼Œæ„æˆä¸€ä¸ªå•å‘é“¾è¡¨ï¼Œç±»ä¼¼Nettyçš„PipelineèŒè´£é“¾</span>
                    chain <span class="token operator">=</span> SlotChainProvider<span class="token punctuation">.</span><span class="token function">newSlotChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    Map<span class="token operator">&lt;</span>ResourceWrapper<span class="token punctuation">,</span> ProcessorSlotChain<span class="token operator">></span> newMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span>ResourceWrapper<span class="token punctuation">,</span> ProcessorSlotChain<span class="token operator">></span><span class="token punctuation">(</span>chainMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    newMap<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>chainMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    newMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">,</span> chain<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// ä¹Ÿæ˜¯CopyOnWriteçš„æ€æƒ³</span>
                    chainMap <span class="token operator">=</span> newMap<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> chain<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>å†…ç½®é»˜è®¤çš„ProcessorSloté¡ºåºæ˜¯ï¼š</p>
<ul>
<li>NodeSelectorSlotï¼šæ„å»ºè°ƒç”¨é“¾è·¯ï¼Œä»¥æ ‘çŠ¶ç»“æ„å­˜å‚¨èµ„æºçš„è°ƒç”¨è·¯å¾„ï¼›</li>
<li>ClusterBuilderSlotï¼šæ„å»ºç»Ÿè®¡ç°‡ç‚¹ï¼Œç”¨äºå­˜å‚¨èµ„æºçš„ç»Ÿè®¡ä¿¡æ¯åŠè°ƒç”¨è€…ä¿¡æ¯ï¼Œå¦‚å“åº”æ—¶é—´ã€QPSã€çº¿ç¨‹æ•°é‡ç­‰ï¼›</li>
<li>LogSlotï¼šç•¥ï¼›</li>
<li>StatisticSlotï¼šè®°å½•ã€ç»Ÿè®¡ä¸åŒçº¬åº¦çš„ç›‘æ§ä¿¡æ¯ï¼›</li>
<li>AuthoritySlotï¼šæ ¹æ®é…ç½®çš„é»‘ç™½åå•å’Œè°ƒç”¨æ¥æºOriginï¼Œåšé»‘ç™½åå•æ§åˆ¶ï¼›</li>
<li>SystemSlotï¼šæ ¹æ®ç³»ç»Ÿæ•´ä½“çŠ¶æ€ï¼Œæ§åˆ¶æ€»çš„å…¥å£æµé‡ï¼›</li>
<li>GatewayFlowSlotï¼šç½‘å…³æµé‡æ§åˆ¶ï¼›</li>
<li>ParamFlowSlotï¼šå¯¹åŒ…å«çƒ­ç‚¹å‚æ•°çš„èµ„æºå•ç‹¬è¿›è¡Œé™æµï¼›</li>
<li>FlowSlotï¼šæ ¹æ®ç»Ÿè®¡ä¿¡æ¯ä»¥åŠè§„åˆ™ï¼Œè¿›è¡Œæµé‡æ§åˆ¶ï¼›</li>
<li>DegradeSlotï¼šæ ¹æ®ç»Ÿè®¡ä¿¡æ¯ä»¥åŠè§„åˆ™ï¼Œè¿›è¡Œç†”æ–­é™çº§ï¼›</li>
</ul>
<p>è¡¥å……ï¼š</p>
<ul>
<li>SystemSlotï¼š</li>
</ul>
<p>ä»æ•´ä½“ç»´åº¦å¯¹åº”ç”¨å…¥å£æµé‡è¿›è¡Œæ§åˆ¶ï¼Œè®©ç³»ç»Ÿçš„å…¥å£æµé‡å’Œç³»ç»Ÿçš„è´Ÿè½½è¾¾åˆ°å¹³è¡¡ï¼Œè®©ç³»ç»Ÿå°½å¯èƒ½è·‘åœ¨æœ€å¤§ååé‡çš„åŒæ—¶ä¿è¯ç³»ç»Ÿæ•´ä½“çš„ç¨³å®šæ€§ã€‚</p>
<p>ä¸€èˆ¬çš„æ€è·¯æ˜¯æ ¹æ®ç¡¬æŒ‡æ ‡ï¼Œå³ç³»ç»Ÿçš„è´Ÿè½½æ¥åšç³»ç»Ÿè¿‡è½½ä¿æŠ¤ã€‚</p>
<p>å½“ç³»ç»Ÿè´Ÿè½½é«˜äºæŸä¸ªé˜ˆå€¼ï¼Œå°±ç¦æ­¢æˆ–è€…å‡å°‘æµé‡çš„è¿›å…¥ï¼›å¼€å§‹å¥½è½¬ï¼Œåˆ™æ¢å¤æµé‡çš„è¿›å…¥ã€‚</p>
<p>å¸¦æ¥çš„é—®é¢˜ï¼šè´Ÿè½½æ˜¯â€œæœâ€ï¼Œå¦‚æœæ ¹æ®è´Ÿè½½æ¥è°ƒèŠ‚æµé‡çš„é€šè¿‡ç‡ï¼Œé‚£ä¹ˆå°±æœ‰å»¶è¿Ÿæ€§ï¼Œæ‰€ä»¥æ›²çº¿æ€»æ˜¯ä¼šæœ‰æŠ–åŠ¨ã€‚</p>
<p>åº”è¯¥æ ¹æ®ç³»ç»Ÿèƒ½å¤Ÿå¤„ç†çš„è¯·æ±‚ï¼Œå’Œå…è®¸è¿›æ¥çš„è¯·æ±‚ï¼Œæ¥åšå¹³è¡¡ï¼Œè€Œä¸æ˜¯æ ¹æ®ä¸€ä¸ªé—´æ¥çš„æŒ‡æ ‡ï¼ˆç³»ç»Ÿè´Ÿè½½ï¼‰æ¥åšé™æµã€‚</p>
<p>ç›®æ ‡æ˜¯åœ¨ç³»ç»Ÿä¸è¢«æ‹–å®çš„æƒ…å†µä¸‹ï¼Œæé«˜ç³»ç»Ÿçš„ååç‡ï¼Œè€Œä¸æ˜¯è´Ÿè½½ä¸€å®šè¦åˆ°ä½äºæŸä¸ªé˜ˆå€¼ã€‚</p>
<p>Sentinel åœ¨ç³»ç»Ÿè‡ªé€‚åº”ä¿æŠ¤çš„åšæ³•æ˜¯ï¼Œç”¨ load1 ä½œä¸ºå¯åŠ¨æ§åˆ¶æµé‡çš„å€¼ï¼Œè€Œå…è®¸é€šè¿‡çš„æµé‡ç”±å¤„ç†è¯·æ±‚çš„èƒ½åŠ›ï¼Œå³è¯·æ±‚çš„å“åº”æ—¶é—´ä»¥åŠå½“å‰ç³»ç»Ÿæ­£åœ¨å¤„ç†çš„è¯·æ±‚é€Ÿç‡æ¥å†³å®šã€‚</p>
<p>ç³»ç»Ÿä¿æŠ¤è§„åˆ™æ˜¯åº”ç”¨æ•´ä½“ç»´åº¦çš„ï¼Œè€Œä¸æ˜¯èµ„æºç»´åº¦çš„ï¼Œå¹¶ä¸”ä»…å¯¹å…¥å£æµé‡ç”Ÿæ•ˆã€‚</p>
<ul>
<li>GatewayFlowSlotï¼š</li>
</ul>
<p>Sentinelå°†ç½‘å…³æµæ§è§„åˆ™è½¬åŒ–ä¸ºçƒ­ç‚¹å‚æ•°è§„åˆ™ï¼ˆParamFlowRuleï¼‰ã€‚</p>
<p>å¤–éƒ¨è¯·æ±‚è¿›å…¥API Gatewayæ—¶ä¼šç»è¿‡Sentinelå®ç°çš„Filterï¼Œä¾æ¬¡è¿›è¡Œè·¯ç”±/APIåˆ†ç»„åŒ¹é…ã€è¯·æ±‚å±æ€§è§£æå’Œå‚æ•°ç»„è£…ã€‚</p>
<p>GatewayFlowSlotä¼šæå–ç”Ÿæˆçš„çƒ­ç‚¹å‚æ•°è§„åˆ™ï¼Œæ ¹æ®ä¼ å…¥çš„å‚æ•°ä¾æ¬¡è¿›è¡Œè§„åˆ™æ£€æŸ¥ã€‚</p>
<p>å¦å¤–ï¼Œå³ä½¿ç½‘å…³å±‚å·²ç»é™æµäº†ï¼Œåº”ç”¨å±‚ä¹Ÿè¿˜éœ€è¦é™æµã€‚</p>
<p>ä¸Šæ¸¸çš„èšåˆæœåŠ¡é…ç½®äº†é™æµï¼Œä¸‹æ¸¸çš„åŸºç¡€æœåŠ¡ä¹Ÿéœ€è¦é…ç½®é™æµï¼Œå¦‚æœåªé…ç½®äº†ä¸Šæ¸¸çš„é™æµï¼Œä¸Šæ¸¸å‘èµ·å¤§é‡é‡è¯•å¯èƒ½å‹å®ä¸‹æ¸¸çš„åŸºç¡€æœåŠ¡ã€‚</p>
<ul>
<li>ParamFlowSlotï¼š</li>
</ul>
<p>çƒ­ç‚¹å‚æ•°é™æµå¯ä»¥çœ‹åšæ˜¯ä¸€ç§ç‰¹æ®Šçš„æµé‡æ§åˆ¶ï¼Œä»…å¯¹åŒ…å«çƒ­ç‚¹å‚æ•°çš„èµ„æºè°ƒç”¨ç”Ÿæ•ˆã€‚</p>
<p>åˆ©ç”¨LRUç­–ç•¥ç»Ÿè®¡ç»Ÿè®¡å•ä½æ—¶é—´å†…æœ€å¸¸è®¿é—®çš„çƒ­ç‚¹å‚æ•°ï¼Œè¿›è¡Œå‚æ•°çº§åˆ«çš„æµæ§ã€‚</p>
<hr>
<p>NodeSelectorSlot#entry</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">entry</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> ResourceWrapper resourceWrapper<span class="token punctuation">,</span> Object obj<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token keyword">boolean</span> prioritized<span class="token punctuation">,</span> Object<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> Throwable <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ä¸€ä¸ªResourceåç§°å¯¹åº”ä¸€ä¸ªè¿‡æ»¤é“¾ï¼Œä¹Ÿå¯¹åº”ä¸€ä¸ªNodeSelectorSlotå®ä¾‹</span>
        <span class="token comment" spellcheck="true">// è·å–è¯¥Resourceåç§°ä¸‹ï¼Œè¯¥Contextåç§°å¯¹åº”çš„DefaultNode</span>
        DefaultNode node <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                node <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// åŒé‡æ£€æŸ¥åŠ é”</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// DefaultNode</span>
                    node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultNode</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    HashMap<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> DefaultNode<span class="token operator">></span> cacheMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> DefaultNode<span class="token operator">></span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    cacheMap<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    cacheMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// CopyOnWrite</span>
                    map <span class="token operator">=</span> cacheMap<span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// åˆ›å»ºè°ƒç”¨æ ‘ï¼Œå°†å½“å‰çš„DefaultNodeæŒ‚åˆ°å½“å‰Entryçš„çˆ¶Entryçš„CurNodeä¸‹</span>
                    <span class="token comment" spellcheck="true">// å¦‚æœæ²¡æœ‰åµŒå¥—è°ƒç”¨çš„è¯ï¼Œè¿™é‡Œå°±æ˜¯æŒ‚åˆ°EntranceNodeä¸‹</span>
                    <span class="token punctuation">(</span><span class="token punctuation">(</span>DefaultNode<span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">getLastNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addChild</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// è®¾ç½®ä¸Šä¸‹æ–‡å½“å‰çš„CurNodeä¸ºDefaultNode</span>
        context<span class="token punctuation">.</span><span class="token function">setCurNode</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ‰§è¡Œä¸‹ä¸€ä¸ªå¤„ç†å™¨</span>
        <span class="token function">fireEntry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ClusterBuilderSlot#entry</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">entry</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> ResourceWrapper resourceWrapper<span class="token punctuation">,</span> DefaultNode node<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token keyword">boolean</span> prioritized<span class="token punctuation">,</span> Object<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>clusterNode <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>lock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// åŒé‡æ£€æŸ¥åŠ é”</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>clusterNode <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// åˆ›å»ºClusterNodeï¼Œä¸€ä¸ªResourceåç§°å…¨å±€åªæœ‰ä¸€ä¸ªClusterNode</span>
                    clusterNode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClusterNode</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">.</span><span class="token function">getResourceType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// è¿™é‡Œä¹‹æ‰€ä»¥ä¸ä½¿ç”¨å¹¶å‘é›†åˆï¼Œè€Œæ˜¯ä½¿ç”¨äº†é”ï¼Œå®˜æ–¹çš„è¯´æ³•æ˜¯è¿è¡Œä¸€æ®µæ—¶é—´åï¼Œé›†åˆè¶‹å‘ç¨³å®šï¼Œè€Œä½¿ç”¨å¹¶å‘é›†åˆçš„è¯æ¯æ¬¡éƒ½è¦å–å¾—é”</span>
                    <span class="token comment" spellcheck="true">// ä¸è¿‡æˆ‘è®°å¾—ConcurrentHashMapæ˜¯è¯»æ—¶æ— é”ï¼Œå†™æ—¶å‘ç”Ÿå†²çªæ‰åŠ é”ï¼Œè¿™é‡Œç”¨CopyOnWriteçš„æ–¹æ³•ï¼Œæ€§èƒ½ä¼šæ›´å¥½ï¼ˆå¤§æ¦‚ï¼‰</span>
                    HashMap<span class="token operator">&lt;</span>ResourceWrapper<span class="token punctuation">,</span> ClusterNode<span class="token operator">></span> newMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>clusterNodeMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    newMap<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>clusterNodeMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    newMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> clusterNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// CopyOnWrite</span>
                    clusterNodeMap <span class="token operator">=</span> newMap<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// è®¾ç½®DefaultNodeçš„ClusterNode</span>
        node<span class="token punctuation">.</span><span class="token function">setClusterNode</span><span class="token punctuation">(</span>clusterNode<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// å¦‚æœé…ç½®äº†Originï¼Œç”¨æ¥æ ‡è®°è°ƒç”¨æ–¹ï¼Œé‚£ä¹ˆä¸ºå½“å‰ClusterNodeå…³è”ä¸€ä¸ªè¯¥Originçš„StatisticNode</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token string">""</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getOrigin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Node originNode <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">getClusterNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOrCreateOriginNode</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getOrigin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            context<span class="token punctuation">.</span><span class="token function">getCurEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setOriginNode</span><span class="token punctuation">(</span>originNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">fireEntry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ç®€å•æ€»ç»“ä¸€ä¸‹ï¼Œç»“æ„å¤§æ¦‚æ˜¯ï¼š</p>
<pre class=" language-xml"><code class="language-xml">                                   Root 
                 /                                          \
         EntranceNode(ContextNameA)   EntranceNode(ContextNameB)
              /                                                 \
      DefaultNode(ResourceNameA)                  DefaultNode(ResourceNameA)
             +- - - - - - - -  - - -  - - -  - - -  - -- - +- - - - - - - - - - - - - - - - - -> ClusterNode(ResourceNameA);</code></pre>
<p>ä¸€ä¸ªçº¿ç¨‹å¯¹åº”ä¸€ä¸ªContextå®ä¾‹ï¼Œä¸€ä¸ªContextåç§°å¯¹åº”å¤šä¸ªContextå®ä¾‹ã€‚</p>
<p>ä¸€ä¸ªContextåç§°å¯¹åº”ä¸€ä¸ªEntranceNodeå®ä¾‹ã€‚</p>
<p>Contextåç§°ç›¸åŒï¼Œä¸ä¸€å®šæ˜¯åŒä¸€ä¸ªContextå®ä¾‹ï¼Œä¸€èˆ¬æ²¡æŒ‡æ˜çš„è¯ï¼Œåªæœ‰ä¸€ä¸ªé»˜è®¤çš„Contextåç§°ï¼Œåªæœ‰ä¸€ä¸ªEntranceNodeå®ä¾‹ã€‚</p>
<p>ä¸€ä¸ªResourceåç§°å¯èƒ½æœ‰å¤šä¸ªDefaultNodeå®ä¾‹ï¼Œä½†æ˜¯åªæœ‰ä¸€ä¸ªClusterNodeå®ä¾‹ï¼ˆå¯ä»¥ç®€å•è¿™ä¹ˆè®¤ä¸ºï¼‰ã€‚</p>
<p>å¯¹äºä¸€ä¸ªResourceåç§°å’Œä¸€ä¸ªContextåç§°ï¼ŒåµŒå¥—æˆ–å¹³è¡Œçš„è°ƒç”¨ä¼šå½¢æˆDefaultNodeçš„æ ‘å‹è°ƒç”¨é“¾ã€‚</p>
<p>Spring Cloudä¸‹ï¼Œå¦‚æœæ˜¯RESTfulé£æ ¼çš„URLï¼Œæ¯”å¦‚<code>/api/v1/{xxx}/xxx/{xxx}</code>ï¼Œé‚£ä¹ˆSentinelçš„<code>CommonFilter</code>ä¼šä¸ºURIç”Ÿæˆæ•°ç›®åºå¤§è€Œæ— æ„ä¹‰çš„èµ„æºåï¼Œéœ€è¦è‡ªè¡Œå®ç°<code>UrlCleaner</code>æ¥å£æ¸…æ´—ä¸€ä¸‹èµ„æºï¼ˆå®˜æ–¹è¯´æ³•ï¼‰ã€‚</p>
<hr>
<p>StatisticSlot#entry</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">entry</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> ResourceWrapper resourceWrapper<span class="token punctuation">,</span> DefaultNode node<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token keyword">boolean</span> prioritized<span class="token punctuation">,</span> Object<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ç›´æ¥æ”¾è¡Œ</span>
            <span class="token function">fireEntry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è¯·æ±‚é€šè¿‡ï¼Œé‚£ä¹ˆå¢åŠ DefaultNodeå’ŒClusterNodeçš„è¿›è¡Œçº¿ç¨‹æ•°ï¼Œé€šè¿‡LongAdderå®ç°ï¼Œåœ¨exitæ—¶å†å‡å›å»</span>
            node<span class="token punctuation">.</span><span class="token function">increaseThreadNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è¯·æ±‚é€šè¿‡ï¼Œé‚£ä¹ˆå¢åŠ DefaultNodeå’ŒClusterNodeçš„é€šè¿‡è¯·æ±‚æ•°ï¼Œé€šè¿‡ArrayMetricå®ç°</span>
            node<span class="token punctuation">.</span><span class="token function">addPassRequest</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ ‡æ˜äº†è°ƒç”¨æ–¹çš„è¯è¿˜è¦å¦å¤–ç»´æŠ¤ä¸€ä»½è®°å½•</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getCurEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOriginNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                context<span class="token punctuation">.</span><span class="token function">getCurEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOriginNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increaseThreadNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                context<span class="token punctuation">.</span><span class="token function">getCurEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOriginNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addPassRequest</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">.</span><span class="token function">getEntryType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> EntryType<span class="token punctuation">.</span>IN<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Add count for global inbound entry node for global statistics.</span>
                Constants<span class="token punctuation">.</span>ENTRY_NODE<span class="token punctuation">.</span><span class="token function">increaseThreadNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Constants<span class="token punctuation">.</span>ENTRY_NODE<span class="token punctuation">.</span><span class="token function">addPassRequest</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// æ‰§è¡Œä¸€äº›å¯¹åº”çš„äº‹ä»¶å›è°ƒ</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>ProcessorSlotEntryCallback<span class="token operator">&lt;</span>DefaultNode<span class="token operator">></span> handler <span class="token operator">:</span> StatisticSlotCallbackRegistry<span class="token punctuation">.</span><span class="token function">getEntryCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                handler<span class="token punctuation">.</span><span class="token function">onPass</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PriorityWaitException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BlockException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<ul>
<li><p>è®¡æ•°å™¨ï¼šå‡è®¾æ¯ç§’å¤„ç†100ä¸ªè¯·æ±‚ï¼Œé‚£ä¹ˆå¯ä»¥è®¾ç½®æ»‘åŠ¨çª—å£ä¸º1ç§’ï¼Œå‡è®¾è¯¥çª—å£æœ‰10ä¸ªæ ¼å­ï¼Œé‚£ä¹ˆæ¯ä¸ªæ ¼å­ä»£è¡¨100æ¯«ç§’ï¼Œè®°å½•æœåŠ¡è¯·æ±‚æ•°ï¼Œå¦‚æœå½“å‰å’Œç¬¬ä¸€ä¸ªæ ¼å­ç›¸å·®è¶…è¿‡100ï¼Œè¯´æ˜éœ€è¦é™æµã€‚</p>
<ul>
<li><p>æ¯ä¸ªæ ¼å­åŒ…å«äº†è®¡æ•°çš„èµ·å§‹æ—¶é—´æˆ³ï¼Œæ—¶é—´æ®µå†…çš„è¯·æ±‚æ€»æ•°ï¼Œå¼‚å¸¸è¯·æ±‚æ€»æ•°ï¼›</p>
</li>
<li><p>è¯·æ±‚è¿‡æ¥æ—¶æ ¹æ®å½“å‰çš„æ—¶é—´æˆ³å®šä½åˆ°æ‰€å±çš„æ ¼å­ï¼Œå¹¶åœ¨æ ¼å­ä¸Šè®°å½•è¯·æ±‚æ•°é‡å’Œæ˜¯å¦æœ‰å¼‚å¸¸ï¼›</p>
</li>
</ul>
</li>
<li><p>æ¼æ¡¶ï¼šä¸€ä¸ªæ¼æ¡¶ï¼Œå®¹é‡å›ºå®šï¼ŒæŒ‰å›ºå®šé€Ÿç‡æµå‡ºæ°´æ»´ï¼ŒåŒæ—¶å¯ä»¥ä»¥ä»»æ„é€Ÿç‡æ·»åŠ æ°´ï¼ˆè¯·æ±‚ï¼‰åˆ°æ¼æ¡¶ï¼Œå¦‚æœæµå…¥çš„æ°´è¶…å‡ºäº†æ¡¶çš„å®¹é‡ï¼Œåˆ™æº¢å‡ºï¼ˆè¯·æ±‚è¢«ä¸¢å¼ƒï¼‰ã€‚</p>
</li>
<li><p>ä»¤ç‰Œæ¡¶ï¼šä¸€ä¸ªæ¡¶ï¼Œå®¹é‡å›ºå®šï¼ŒæŒ‰å›ºå®šé€Ÿç‡å¾€æ¡¶é‡Œæ·»åŠ ä»¤ç‰Œï¼Œå½“æ¡¶æ»¡æ—¶ï¼Œæ–°æ·»åŠ çš„ä»¤ç‰Œè¢«ä¸¢å¼ƒï¼Œå¤„ç†è¯·æ±‚éœ€è¦æ¶ˆè€—ä»¤ç‰Œã€‚</p>
<ul>
<li>å…¶å®ä¹Ÿä¸éœ€è¦å¦å¤–çš„çº¿ç¨‹å»éš”å›ºå®šçš„æ—¶é—´æ”¾ä»¤ç‰Œï¼Œæ¯æ¬¡å–Tokenä¹‹å‰ï¼Œæ ¹æ®å½“å‰æ—¶é—´æˆ³å’Œä¸Šæ¬¡æ”¾ç½®Tokençš„æ—¶é—´æˆ³ï¼Œè®¡ç®—éœ€è¦çš„Tokenå¹¶æ”¾å…¥å³å¯ï¼ŒThreadLocalå’ŒGuavaçš„Cacheä¹Ÿæ˜¯ç±»ä¼¼ã€‚</li>
</ul>
</li>
</ul>
<p>LeapArray</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token function">LeapArray</span><span class="token punctuation">(</span><span class="token keyword">int</span> sampleCount<span class="token punctuation">,</span> <span class="token keyword">int</span> intervalInMs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// å•ä¸ªçª—å£çš„é•¿åº¦ï¼Œå‡è®¾æ˜¯500ms</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>windowLengthInMs <span class="token operator">=</span> intervalInMs <span class="token operator">/</span> sampleCount<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ä¸€è½®çª—å£çš„æ€»æ—¶é—´ï¼Œå‡è®¾æ˜¯1000ms</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>intervalInMs <span class="token operator">=</span> intervalInMs<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ä¸€è½®çª—å£çš„æ€»æ•°é‡ï¼Œå‡è®¾æ˜¯2</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>sampleCount <span class="token operator">=</span> sampleCount<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ»‘åŠ¨çª—å£æ•°ç»„ï¼Œé•¿åº¦æ˜¯2ï¼Œä¸¤ä¸ªçª—å£ï¼Œæ¯ä¸ªçª—å£500msï¼Œ1000msèµ°å®Œä¸€è½®ï¼Œç„¶åä»å¤´è¦†ç›–</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>array <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicReferenceArray</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>sampleCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ArrayMetric#addPass</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addPass</span><span class="token punctuation">(</span><span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// è·å–å½“å‰æ—¶é—´å¯¹åº”çš„çª—å£</span>
        WindowWrap<span class="token operator">&lt;</span>MetricBucket<span class="token operator">></span> wrap <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">currentWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ç»Ÿè®¡æ•°æ®åœ¨çª—å£ä¸­</span>
        wrap<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addPass</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>LeapArray#currentWindow</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> WindowWrap<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token function">currentWindow</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeMillis<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// è®¡ç®—è¯¥æ—¶é—´æˆ³å¯¹åº”çš„çª—å£ä¸‹æ ‡ï¼Œå³å¤„äºå“ªä¸ªçª—å£ä¸­ï¼Œç®—æ³•å°±æ˜¯æ—¶é—´æˆ³é™¤å•ä¸ªçª—å£é•¿åº¦ï¼Œç„¶åå¯¹çª—å£æ•°é‡å–æ¨¡</span>
        <span class="token keyword">int</span> idx <span class="token operator">=</span> <span class="token function">calculateTimeIdx</span><span class="token punctuation">(</span>timeMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è®¡ç®—è¯¥æ—¶é—´æˆ³å¯¹åº”çš„çª—å£çš„èµ·å§‹æ—¶é—´</span>
        <span class="token keyword">long</span> windowStart <span class="token operator">=</span> <span class="token function">calculateWindowStart</span><span class="token punctuation">(</span>timeMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è‡ªæ—‹é‡è¯•è·å–æ—¶é—´çª—å£ï¼Œä¸‰ç§æƒ…å†µï¼š</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            WindowWrap<span class="token operator">&lt;</span>T<span class="token operator">></span> old <span class="token operator">=</span> array<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å¯¹åº”ä½ç½®è¿˜æ²¡æœ‰åˆå§‹åŒ–çª—å£</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>old <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                WindowWrap<span class="token operator">&lt;</span>T<span class="token operator">></span> window <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WindowWrap</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">(</span>windowLengthInMs<span class="token punctuation">,</span> windowStart<span class="token punctuation">,</span> <span class="token function">newEmptyBucket</span><span class="token punctuation">(</span>timeMillis<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// CASæ›´æ–°æ•°ç»„æˆåŠŸ</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>array<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> null<span class="token punctuation">,</span> window<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> window<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// è¯´æ˜å­˜åœ¨çº¿ç¨‹ç«äº‰</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    Thread<span class="token punctuation">.</span><span class="token function">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// æ ¹æ®èµ·å§‹æ—¶é—´åˆ¤æ–­çª—å£æœ‰æ²¡è¿‡æœŸï¼Œå¦‚æœæ²¡è¿‡æœŸï¼Œç›´æ¥è¿”å›</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>windowStart <span class="token operator">==</span> old<span class="token punctuation">.</span><span class="token function">windowStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> old<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å¦‚æœçª—å£è¿‡æœŸäº†</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>windowStart <span class="token operator">></span> old<span class="token punctuation">.</span><span class="token function">windowStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// è·å–é”æ‰èƒ½é‡ç½®çª—å£</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>updateLock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> <span class="token function">resetWindowTo</span><span class="token punctuation">(</span>old<span class="token punctuation">,</span> windowStart<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                        updateLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// è·å–é”å¤±è´¥åˆ™ä¸‹ä¸ªå¾ªç¯é‡è¯•</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    Thread<span class="token punctuation">.</span><span class="token function">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ä¸ä¼šå‘ç”Ÿï¼Œé™¤éæ—¶é’Ÿå›æ‹¨</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>windowStart <span class="token operator">&lt;</span> old<span class="token punctuation">.</span><span class="token function">windowStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">WindowWrap</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">(</span>windowLengthInMs<span class="token punctuation">,</span> windowStart<span class="token punctuation">,</span> <span class="token function">newEmptyBucket</span><span class="token punctuation">(</span>timeMillis<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>è¿™é‡Œå¾ˆå¤šè®¡æ•°éƒ½æ˜¯ä½¿ç”¨LongAdderï¼Œè€Œä¸æ˜¯AtomicLongï¼Œå› ä¸ºLongAdderæŠŠè®¡æ•°æ“ä½œåˆ†æ•£è®°å½•åˆ°äº†ä¸åŒçš„æ¡¶ä¸­ï¼Œå‡å°‘äº†å¹¶å‘ä¸‹çš„ç«äº‰é¢‘ç‡ï¼ŒConcurrentHashMapçš„è®¡ç®—å¤§å°ä¹Ÿæ˜¯ç±»ä¼¼é€»è¾‘ï¼Œå¯ä»¥è¯´æ˜¯ä»¥ç©ºé—´æ¢æ—¶é—´ã€‚</p>
<p>é»˜è®¤çš„æ¯ç§’ç»Ÿè®¡åªæœ‰ä¸¤ä¸ªçª—å£ï¼Œä¸€ç§’ä¸€è½®ï¼Œä¸¤ä¸ªçª—å£ï¼Œå‡è®¾ä¸€ç§’å†…è¯·æ±‚å‡åŒ€é€šè¿‡10ä¸ªè¯·æ±‚ï¼Œé‚£ä¹ˆåœ¨æŸä¸€æ—¶åˆ»ï¼Œå‡è®¾ç¬¬ä¸€ä¸ªçª—å£è¢«é‡ç½®äº†ï¼Œé‚£ä¹ˆåªæœ‰ç¬¬äºŒä¸ªçª—å£æœ‰å€¼ï¼Œå¦‚æœåœ¨è¿™ä¸ªæ—¶å€™è§‚å¯Ÿç»Ÿè®¡ï¼Œä¼šå‘è§‰è¯·æ±‚æ•°å°‘äº†ä¸€åŠï¼Œè§£å†³åŠæ³•åªèƒ½æ˜¯å¢åŠ çª—å£æ•°é‡ï¼Œä½†è¿™æ ·åˆä¼šå¢åŠ ç«äº‰çš„é¢‘ç‡ï¼ˆæ¯•ç«Ÿè¿‡æœŸéœ€è¦é‡ç½®çš„çª—å£å˜å¤šäº†ï¼‰ï¼Œå½±å“æ€§èƒ½ã€‚</p>
<hr>
<p>é™æµé€»è¾‘ï¼š</p>
<p>ç›‘æ§æŒ‡æ ‡ï¼šQPSå’Œçº¿ç¨‹æ•°ã€‚</p>
<p>å¤„ç†ç­–ç•¥ï¼šç›´æ¥æ‹’ç»ï¼Œå†·å¯åŠ¨ï¼ŒåŒ€é€Ÿå™¨ã€‚</p>
<ul>
<li>ç›´æ¥æ‹’ç»ï¼š</li>
</ul>
<p>é»˜è®¤ï¼Œå½“QPSè¶…è¿‡é˜ˆå€¼åï¼Œç«‹å³æ‹’ç»æ–°è¯·æ±‚ï¼ŒæŠ›å‡ºFlowExceptionã€‚</p>
<p>é€‚ç”¨äºå¯¹ç³»ç»Ÿå¤„ç†èƒ½åŠ›ç¡®åˆ‡å·²çŸ¥çš„æƒ…å†µä¸‹ï¼Œæ¯”å¦‚é€šè¿‡å‹æµ‹ç¡®å®šäº†ç³»ç»Ÿçš„å‡†ç¡®æ°´ä½æ—¶ã€‚</p>
<p>DefaultController#canPass</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">canPass</span><span class="token punctuation">(</span>Node node<span class="token punctuation">,</span> <span class="token keyword">int</span> acquireCount<span class="token punctuation">,</span> <span class="token keyword">boolean</span> prioritized<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// è·å–å·²ä½¿ç”¨çš„ä»¤ç‰Œï¼Œå…¶å®å°±æ˜¯è¿”å›æ»‘åŠ¨çª—å£çš„å½“å‰çº¿ç¨‹æˆ–è€…QPSçš„ç»Ÿè®¡æ•°</span>
        <span class="token keyword">int</span> curCount <span class="token operator">=</span> <span class="token function">avgUsedTokens</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¤§äºé˜ˆå€¼</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>curCount <span class="token operator">+</span> acquireCount <span class="token operator">></span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è®¾ç½®äº†ä¼˜å…ˆçº§çš„è¯ï¼Œä¸èƒ½ç›´æ¥å¤±è´¥</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>prioritized <span class="token operator">&amp;&amp;</span> grade <span class="token operator">==</span> RuleConstant<span class="token punctuation">.</span>FLOW_GRADE_QPS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">long</span> currentTime<span class="token punctuation">;</span>
                <span class="token keyword">long</span> waitInMs<span class="token punctuation">;</span>
                currentTime <span class="token operator">=</span> TimeUtil<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å ç”¨æœªæ¥ä¸€æ®µæ—¶é—´çš„æ»‘åŠ¨çª—å£çš„å€¼ï¼Œç›¸å½“äºè·å–Tokenï¼Œå¤„ç†é€»è¾‘åœ¨OccupiableBucketLeapArrayå†…çš„FutureBucketLeapArray</span>
                waitInMs <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">tryOccupyNext</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">,</span> acquireCount<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>waitInMs <span class="token operator">&lt;</span> OccupyTimeoutProperty<span class="token punctuation">.</span><span class="token function">getOccupyTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    node<span class="token punctuation">.</span><span class="token function">addWaitingRequest</span><span class="token punctuation">(</span>currentTime <span class="token operator">+</span> waitInMs<span class="token punctuation">,</span> acquireCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    node<span class="token punctuation">.</span><span class="token function">addOccupiedPass</span><span class="token punctuation">(</span>acquireCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// ç¡ä¸€ä¼š</span>
                    <span class="token function">sleep</span><span class="token punctuation">(</span>waitInMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// æŠ›å‡ºè¿™ä¸ªPriorityWaitExceptionå¼‚å¸¸é€šçŸ¥ä¸Šçº§åï¼Œè¯·æ±‚ä¼šé€šè¿‡</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">PriorityWaitException</span><span class="token punctuation">(</span>waitInMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<ul>
<li>å†·å¯åŠ¨ï¼š</li>
</ul>
<p>ç³»ç»Ÿé•¿æœŸå¤„äºä½æ°´ä½çš„æƒ…å†µä¸‹ï¼Œå½“æµé‡çªç„¶å¢åŠ æ—¶ï¼Œç›´æ¥æŠŠç³»ç»Ÿæ‹‰å‡åˆ°é«˜æ°´ä½å¯èƒ½ç¬é—´æŠŠç³»ç»Ÿå‹å®ã€‚</p>
<p>è®©é€šè¿‡çš„æµé‡ç¼“æ…¢å¢åŠ ï¼Œç»™å†·ç³»ç»Ÿä¸€ä¸ªé¢„çƒ­çš„æ—¶é—´ï¼Œé¿å…å†·ç³»ç»Ÿè¢«å‹å®ã€‚</p>
<p>WarmUpController#canPass</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">canPass</span><span class="token punctuation">(</span>Node node<span class="token punctuation">,</span> <span class="token keyword">int</span> acquireCount<span class="token punctuation">,</span> <span class="token keyword">boolean</span> prioritized<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// è·å–å½“å‰æ•´ä¸ªæ»‘åŠ¨çª—å£çš„QPSè®¡æ•°ï¼ˆæ‰€æœ‰æ ¼å­/æ¡¶ï¼‰</span>
        <span class="token keyword">long</span> passQps <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> node<span class="token punctuation">.</span><span class="token function">passQps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è·å–å½“å‰çª—å£çš„å‰ä¸€ä¸ªçª—å£çš„QPSè®¡æ•°ï¼ˆä¸Šä¸€ä¸ªæ ¼å­/æ¡¶ï¼‰</span>
        <span class="token keyword">long</span> previousQps <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> node<span class="token punctuation">.</span><span class="token function">previousPassQps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// åŒæ­¥ä»¤ç‰Œ</span>
        <span class="token function">syncToken</span><span class="token punctuation">(</span>previousQps<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">long</span> restToken <span class="token operator">=</span> storedTokens<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å‰©ä½™ä»¤ç‰Œæ¯”è¾ƒå¤šï¼Œå¤§äºè­¦æˆ’å€¼ï¼Œè¯´æ˜å¤„äºè¾ƒç©ºé—²çš„çŠ¶æ€ï¼Œä½æ°´ä½</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>restToken <span class="token operator">>=</span> warningToken<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">long</span> aboveToken <span class="token operator">=</span> restToken <span class="token operator">-</span> warningToken<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// QPSä¸èƒ½ä¸€ä¸‹å­å‡å¤ªå¿«ï¼Œä¾é æ–œç‡æ¥è®¡ç®—é˜ˆå€¼</span>
            <span class="token keyword">double</span> warningQps <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">nextUp</span><span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">/</span> <span class="token punctuation">(</span>aboveToken <span class="token operator">*</span> slope <span class="token operator">+</span> <span class="token number">1.0</span> <span class="token operator">/</span> count<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>passQps <span class="token operator">+</span> acquireCount <span class="token operator">&lt;=</span> warningQps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å‰©ä½™ä»¤ç‰Œæ¯”è¾ƒå°‘ï¼Œè¯´æ˜è¯·æ±‚æ¯”è¾ƒé¢‘ç¹</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// åªè¦ä¿è¯ä¸è¶…è¿‡é˜ˆå€¼å³å¯</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>passQps <span class="token operator">+</span> acquireCount <span class="token operator">&lt;=</span> count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>WarmUpController#syncToken</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">syncToken</span><span class="token punctuation">(</span><span class="token keyword">long</span> passQps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> currentTime <span class="token operator">=</span> TimeUtil<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å½“å‰æ—¶é—´æˆ³çš„ç›¸å¯¹ä½ç½®ï¼Œå•ä½æ˜¯ç§’ï¼Œè¿™é‡Œå°±æ˜¯æ¢ç®—æˆç§’</span>
        currentTime <span class="token operator">=</span> currentTime <span class="token operator">-</span> currentTime <span class="token operator">%</span> <span class="token number">1000</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ä¸Šæ¬¡è£…å¡«ä»¤ç‰Œæ¡¶çš„æ—¶é—´</span>
        <span class="token keyword">long</span> oldLastFillTime <span class="token operator">=</span> lastFilledTime<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å·²ç»å¡«å……è¿‡äº†ï¼Œä¸€ç§’æœ€å¤šä¸€æ¬¡</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentTime <span class="token operator">&lt;=</span> oldLastFillTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å½“å‰ä»¤ç‰Œæ¡¶ä¸­çš„ä»¤ç‰Œæ•°</span>
        <span class="token keyword">long</span> oldValue <span class="token operator">=</span> storedTokens<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ ¹æ®å½“å‰æ—¶é—´å’Œå’Œä¸Šä¸€ç§’çš„QPSè®¡ç®—å½“å‰ä»¤ç‰Œæ•°</span>
        <span class="token keyword">long</span> newValue <span class="token operator">=</span> <span class="token function">coolDownTokens</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">,</span> passQps<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// CASæ›´æ–°ä»¤ç‰Œæ•°æˆåŠŸ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>storedTokens<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>oldValue<span class="token punctuation">,</span> newValue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ä¿è¯ä»¤ç‰Œæ•°ä¸ä¸ºè´Ÿ</span>
            <span class="token keyword">long</span> currentValue <span class="token operator">=</span> storedTokens<span class="token punctuation">.</span><span class="token function">addAndGet</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">-</span> passQps<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>currentValue <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                storedTokens<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>0L<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// æ›´æ–°å¡«å……æ—¶é—´</span>
            lastFilledTime<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// CASå¤±è´¥ä¹Ÿæ— æ‰€è°“ï¼Œåªè¦æœ‰çº¿ç¨‹æˆåŠŸå°±è¡Œï¼Œä¿è¯ä¸€ç§’æ›´æ–°ä¸€æ¬¡ä»¤ç‰Œæ•°</span>
    <span class="token punctuation">}</span></code></pre>
<p>WarmUpController#coolDownTokens</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">long</span> <span class="token function">coolDownTokens</span><span class="token punctuation">(</span><span class="token keyword">long</span> currentTime<span class="token punctuation">,</span> <span class="token keyword">long</span> passQps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> oldValue <span class="token operator">=</span> storedTokens<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> newValue <span class="token operator">=</span> oldValue<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å½“ä»¤ç‰Œçš„å‰©ä½™æ•°ä½äºè­¦æˆ’å€¼æ—¶</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldValue <span class="token operator">&lt;</span> warningToken<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            newValue <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>oldValue <span class="token operator">+</span> <span class="token punctuation">(</span>currentTime <span class="token operator">-</span> lastFilledTime<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> count <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å½“ä»¤ç‰Œå‰©ä½™æ¯”è¾ƒå¤šæ—¶ï¼Œæ ¹æ®è¿‡å»çš„QPSå†³å®šæ˜¯å¦è£…å¡«ï¼Œå¤ªå°å°±ä¸è£…äº†</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldValue <span class="token operator">></span> warningToken<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>passQps <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> count <span class="token operator">/</span> coldFactor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                newValue <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>oldValue <span class="token operator">+</span> <span class="token punctuation">(</span>currentTime <span class="token operator">-</span> lastFilledTime<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> count <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>newValue<span class="token punctuation">,</span> maxToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<ul>
<li>åŒ€é€Ÿå™¨ï¼š</li>
</ul>
<p>æ§åˆ¶è¯·æ±‚é€šè¿‡çš„é—´éš”æ—¶é—´ï¼Œè®©è¯·æ±‚ä»¥å‡åŒ€çš„é€Ÿåº¦é€šè¿‡ï¼Œæµé‡æ•´å½¢ï¼ŒåŒæ—¶å †ç§¯çš„è¯·æ±‚å°†ä¼šæ’é˜Ÿï¼Œè¶…è¿‡è¶…æ—¶æ—¶é•¿çš„è¯·æ±‚ç›´æ¥è¢«æ‹’ç»ã€‚</p>
<p>é€‚åˆå¤„ç†çªå‘æ€§æµé‡ï¼Œæ¼æ¡¶ç®—æ³•ã€‚</p>
<p>RateLimiterController#canPass</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">canPass</span><span class="token punctuation">(</span>Node node<span class="token punctuation">,</span> <span class="token keyword">int</span> acquireCount<span class="token punctuation">,</span> <span class="token keyword">boolean</span> prioritized<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">long</span> currentTime <span class="token operator">=</span> TimeUtil<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Calculate the interval between every two requests.</span>
        <span class="token comment" spellcheck="true">// è®¡ç®—è·å–éœ€è¦çš„æ—¶é—´ï¼Œè¦è·å–çš„ä»¤ç‰Œæ•°ç›® / é˜ˆå€¼</span>
        <span class="token keyword">long</span> costTime <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">*</span> <span class="token punctuation">(</span>acquireCount<span class="token punctuation">)</span> <span class="token operator">/</span> count <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// è®¡ç®—æœ¬æ¬¡è¯·æ±‚é€šè¿‡çš„æ—¶é—´ï¼Œè·å–ä»¤ç‰Œéœ€è¦çš„æ—¶é—´ + ä¸Šæ¬¡é€šè¿‡çš„æ—¶é—´</span>
        <span class="token keyword">long</span> expectedTime <span class="token operator">=</span> costTime <span class="token operator">+</span> latestPassedTime<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è¯´æ˜å¯ä»¥ç«‹å³è·å¾—ä»¤ç‰Œ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>expectedTime <span class="token operator">&lt;=</span> currentTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Contention may exist here, but it's okay.</span>
            latestPassedTime<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// è¦ç­‰å¾…</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è®¡ç®—éœ€è¦ç­‰å¾…çš„æ—¶é—´</span>
            <span class="token keyword">long</span> waitTime <span class="token operator">=</span> costTime <span class="token operator">+</span> latestPassedTime<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> TimeUtil<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// éœ€è¦ç­‰å¾…çš„æ—¶é—´è¿‡é•¿ï¼Œç›´æ¥é™æµ</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>waitTime <span class="token operator">></span> maxQueueingTimeMs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å…ˆæ›´æ–°é€šè¿‡æ—¶é—´</span>
                <span class="token keyword">long</span> oldTime <span class="token operator">=</span> latestPassedTime<span class="token punctuation">.</span><span class="token function">addAndGet</span><span class="token punctuation">(</span>costTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å†è®¡ç®—ä¸€æ¬¡ç­‰å¾…æ—¶é—´</span>
                    waitTime <span class="token operator">=</span> oldTime <span class="token operator">-</span> TimeUtil<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// åŒé‡æ£€æŸ¥ï¼Œå¦‚æœæœ‰çº¿ç¨‹ä¹Ÿè¿›åˆ°è¿™é‡Œäº†</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>waitTime <span class="token operator">></span> maxQueueingTimeMs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// è¿˜åŸé€šè¿‡æ—¶é—´</span>
                        latestPassedTime<span class="token punctuation">.</span><span class="token function">addAndGet</span><span class="token punctuation">(</span><span class="token operator">-</span>costTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// æœ‰äººæ·è¶³å…ˆç™»äº†</span>
                        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// in race condition waitTime may &lt;= 0</span>
                    <span class="token comment" spellcheck="true">// ç­‰å¾…ï¼Œä¸åˆ°æ—¶é—´ä¸ç»™èµ°</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>waitTime <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>waitTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>é™çº§é€»è¾‘ï¼š</p>
<p>DegradeRule#passCheck</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">passCheck</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> DefaultNode node<span class="token punctuation">,</span> <span class="token keyword">int</span> acquireCount<span class="token punctuation">,</span> Object<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// æ ‡è®°ä¸ºç†”æ–­ï¼Œç›´æ¥é™çº§</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cut<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// å¹³å‡å“åº”æ—¶é—´</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>grade <span class="token operator">==</span> RuleConstant<span class="token punctuation">.</span>DEGRADE_GRADE_RT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å¼‚å¸¸æ¯”ä¾‹</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>grade <span class="token operator">==</span> RuleConstant<span class="token punctuation">.</span>DEGRADE_GRADE_EXCEPTION_RATIO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å¼‚å¸¸æ•°é‡</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>grade <span class="token operator">==</span> RuleConstant<span class="token punctuation">.</span>DEGRADE_GRADE_EXCEPTION_COUNT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ä¸Šé¢çš„æ¡ä»¶è¶…å‡ºäº†é˜ˆå€¼åï¼Œåˆ™æ ‡è®°ä¸ºç†”æ–­çŠ¶æ€</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cut<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ResetTask resetTask <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResetTask</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æäº¤è®¡åˆ’ä»»åŠ¡ï¼Œåœ¨ä¸‹ä¸€ä¸ªçª—å£æ—¶é—´åï¼Œå°†ç†”æ–­æ ‡è®°å…³é—­ï¼Œé‡æ–°æ¥å—è¯·æ±‚</span>
            pool<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span>resetTask<span class="token punctuation">,</span> timeWindow<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// é™çº§</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>é™çº§é€šå¸¸æ˜¯å¿«é€Ÿå¤±è´¥ï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰é™çº§å¤„ç†ç»“æœï¼ˆFallbackï¼‰ã€‚</p>
<hr>
<p>å®˜æ–¹æ¨èé€šè¿‡æ§åˆ¶å°è®¾ç½®è§„åˆ™ï¼Œå°†è§„åˆ™æ¨é€åˆ°é…ç½®ä¸­å¿ƒï¼ŒSentinelç›‘å¬é…ç½®ä¸­å¿ƒçš„è§„åˆ™å˜åŒ–ï¼Œå®æ—¶è·å–å˜æ›´çš„è§„åˆ™ã€‚</p>
<p>DataSourceå¸¸è§æ‹“å±•æ–¹å¼æœ‰ï¼š</p>
<ul>
<li><p>æ‹‰æ¨¡å¼ï¼šå®¢æˆ·ç«¯ä¸»åŠ¨å‘é…ç½®ä¸­å¿ƒå®šæœŸè½®è¯¢æ‹‰å–è§„åˆ™ï¼Œå¯ä»¥æ˜¯SQLã€æ–‡ä»¶ã€‚ç®€å•ï¼Œä½†æ— æ³•åŠæ—¶è·å–å˜æ›´ï¼›</p>
</li>
<li><p>æ¨æ¨¡å¼ï¼šé…ç½®ä¸­å¿ƒç»Ÿä¸€æ¨é€ï¼Œå®¢æˆ·ç«¯é€šè¿‡æ³¨å†Œç›‘å¬å™¨çš„æ–¹å¼ç›‘å¬å˜åŒ–ã€‚æœ‰æ›´å¥½çš„å®æ—¶æ€§å’Œä¸€è‡´æ€§ä¿è¯ã€‚</p>
</li>
</ul>
<p>è¦ä½¿ç”¨é›†ç¾¤æµæ§åŠŸèƒ½ï¼Œéœ€è¦é…ç½®åŠ¨æ€è§„åˆ™æºã€‚</p>
<p>é›†ç¾¤é™æµå’Œå•æœºé™æµä¸€æ ·ï¼Œéƒ½éœ€è¦ç»Ÿè®¡QPSç­‰ï¼ŒåŒºåˆ«åœ¨äºå•æœºç‰ˆåœ¨æ¯ä¸ªå®ä¾‹ä¸­è¿›è¡Œç»Ÿè®¡ï¼Œè€Œé›†ç¾¤ç‰ˆæœ‰ä¸€ä¸ªä¸“é—¨çš„å®ä¾‹è¿›è¡Œç»Ÿè®¡ã€‚</p>
<p>è¿™ä¸ªä¸“é—¨çš„ç”¨æ¥ç»Ÿè®¡æ•°æ®çš„å®ä¾‹ç§°ä¸ºTokenServerï¼Œå…¶ä»–çš„å®ä¾‹ä½œä¸ºTokenClientå‘TokenServerè¯·æ±‚Tokenï¼Œè·å–æˆåŠŸåˆ™ä¸éœ€è¦é™æµã€‚</p>
<p>å•æœºæµæ§ä¸­æ¯ä¸ªSentinelå®ä¾‹éƒ½æ˜¯TokenServerã€‚</p>
<p>é›†ç¾¤é™æµä¸­çš„TokenServeræ˜¯å•ç‚¹çš„ï¼Œä¸€æ—¦TokenServeræŒ‚æ‰ï¼Œé‚£ä¹ˆé›†ç¾¤é™æµå°±ä¼šé€€åŒ–æˆå•æœºé™æµçš„æ¨¡å¼ã€‚</p>
<p>ç®€å•ç†è§£ä¸ºæ²¡æœ‰é€‰ä¸¾çš„ä¸»ä»ï¼Œå› ä¸ºè²Œä¼¼TokenServeræ²¡æœ‰è‡ªåŠ¨é€‰ä¸¾ã€‚</p>
<p>TokenServeræœ‰ä¸¤ç§éƒ¨ç½²æ–¹å¼ï¼š</p>
<ul>
<li>ç‹¬ç«‹éƒ¨ç½²ï¼ˆAloneï¼‰</li>
</ul>
<p>å•ç‹¬å¯åŠ¨ä¸€ä¸ªTokenServeræœåŠ¡å¤„ç†TokenClientçš„è¯·æ±‚ã€‚</p>
<p>éš”ç¦»æ€§å¥½ï¼Œå¦‚æœç‹¬ç«‹éƒ¨ç½²çš„TokenServeræœåŠ¡æŒ‚æ‰ï¼Œå…¶ä»–çš„TokenClientå°±ä¼šé€€åŒ–æˆæœ¬åœ°æµæ§çš„æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯å•æœºç‰ˆã€‚</p>
<ul>
<li>åµŒå…¥éƒ¨ç½²ï¼ˆEmbeddedï¼‰</li>
</ul>
<p>åœ¨å¤šä¸ªSentinelå®ä¾‹ä¸­é€‰æ‹©ä¸€ä¸ªè®¾ç½®ä¸ºTokenServerï¼Œéšç€åº”ç”¨ä¸€èµ·å¯åŠ¨ï¼Œå…¶ä»–çš„Sentinelå®ä¾‹éƒ½æ˜¯é›†ç¾¤ä¸­çš„TokenClientã€‚</p>
<p>é›†ç¾¤ä¸­å„ä¸ªå®ä¾‹éƒ½æ˜¯å¯¹ç­‰çš„ï¼ŒTokenServerå’ŒTokenClientå¯ä»¥éšæ—¶åˆ‡æ¢ï¼Œçµæ´»æ€§æ¯”è¾ƒå¥½ï¼Œä½†å¯èƒ½å½±å“åº”ç”¨æœ¬èº«ã€‚</p>
<p>é€‚åˆæŸä¸ªåº”ç”¨é›†ç¾¤å†…éƒ¨çš„æµæ§ã€‚</p>
<p>è¿˜æœ‰ä¸€ç§å¯èƒ½çš„é›†ç¾¤é™æµå®ç°ï¼Œå°±æ˜¯å¤šä¸ªSentinelå®ä¾‹å°†ç»Ÿè®¡æ•°æ®ç»Ÿä¸€å­˜å‚¨åœ¨ä¸€ä¸ªåˆ†å¸ƒå¼å­˜å‚¨ä¸­ï¼Œæ¯”å¦‚Redisï¼Œå†æ ¹æ®Redisçš„æ•°æ®è¿›è¡Œé™æµã€‚</p>
<p>ä¸è¿‡è²Œä¼¼ä¾µå…¥æ€§æ¯”è¾ƒå¤§ï¼Œåˆå¼•å…¥äº†ä¸€ä¸ªç¬¬ä¸‰æ–¹å­˜å‚¨ã€‚</p>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


        <footer>
             
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

        </footer>
    </div>
    <!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
    <script>
        var timeEnd = new Date();
        console.log('è€—æ—¶ï¼š' + (timeEnd - timeStart));
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre').forEach((block) => {
                block.classList.add("line-numbers");
            });
        });
    </script>
    <!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
    <!-- material design -->
    <!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
    <!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
    <!-- toc -->
    <!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
    <!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
    <!-- <script src="/js/main.js"></script> -->
    <script src="/js/prism.js"></script>
</body>
</html>
