<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
        <script>
            var timeStart = new Date();
        </script>
        
        <title>[ç¬”è®°]-SOFA-Tracer | ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜</title>
        
        <meta name="author" content="huangzhike">
        
        
        <meta name="description" content="ç‰ˆæœ¬2.4.7ã€‚
SOFATraceræ˜¯åŸºäºOpenTracingè§„èŒƒçš„åˆ†å¸ƒå¼é“¾è·¯è·Ÿè¸ªç³»ç»Ÿï¼Œæ ¸å¿ƒç†å¿µæ˜¯é€šè¿‡ä¸€ä¸ªå…¨å±€çš„TraceIdå°†åˆ†å¸ƒåœ¨å„ä¸ªæœåŠ¡èŠ‚ç‚¹ä¸Šçš„åŒä¸€æ¬¡è¯·æ±‚ä¸²è”èµ·æ¥ã€‚
é€šè¿‡ç»Ÿä¸€çš„TraceIdå°†è°ƒç”¨é“¾è·¯ä¸­çš„å„ç§ç½‘ç»œè°ƒç”¨æƒ…å†µä»¥æ—¥å¿—çš„æ–¹å¼è®°å½•ä¸‹æ¥ï¼ŒåŒæ—¶ä¹Ÿæä¾›è¿œç¨‹æ±‡æŠ¥åˆ°Zipkinè¿›è¡Œå¯è§†åŒ–å±•ç¤ºã€‚">
        
        
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        
        <meta property="og:title" content="[ç¬”è®°]-SOFA-Tracer"/>
        
        <meta property="og:site_name" content="ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜"/>
        
        
        <!-- favicon -->
        <link rel="icon" type="image/ico" href="/ok.ico" sizes="32x32">
        <meta name="msapplication-TileColor" content="#009688">
        <meta name="msapplication-TileImage" content="/mstile-144x144.ico">
        <meta name="theme-color" content="#009688">
        <!-- favicon end -->
        <!-- <link href="//ok.ico" rel="icon"> -->
        
        <!-- toc -->
        <!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
        <!-- material design -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
        <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
        
        <!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
        <!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
    <meta name="generator" content="Hexo 4.2.1"></head>

<body>
    <nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">èœå•</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" title="ä¸‹ä¸€å¥æ˜¯ï¼šå®¢æœ‰å¯äººæœŸä¸æ¥ã€‚å°æ—¶å€™ï¼Œå–œæ¬¢é åœ¨é˜³å°ä¸Šï¼Œä¸€è¾¹å¹é£ï¼Œä¸€è¾¹çœ‹ä¹¦ï¼Œå–œæ¬¢è¯»ä¹¦å—ï¼Œéªšå¹´ï¼Ÿ" href="/">ä¹¦å½“å¿«æ„è¯»æ˜“å°½</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" target="_blank" rel="noopener" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

    <div class="container" >
        <div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[ç¬”è®°]-SOFA-Tracer</h2>
				
				<div>
					<div class="post-time">2020-07-04</div>
				</div>
				
				<div class="article-content">
				<p>ç‰ˆæœ¬2.4.7ã€‚</p>
<p>SOFATraceræ˜¯åŸºäºOpenTracingè§„èŒƒçš„åˆ†å¸ƒå¼é“¾è·¯è·Ÿè¸ªç³»ç»Ÿï¼Œæ ¸å¿ƒç†å¿µæ˜¯é€šè¿‡ä¸€ä¸ªå…¨å±€çš„TraceIdå°†åˆ†å¸ƒåœ¨å„ä¸ªæœåŠ¡èŠ‚ç‚¹ä¸Šçš„åŒä¸€æ¬¡è¯·æ±‚ä¸²è”èµ·æ¥ã€‚</p>
<p>é€šè¿‡ç»Ÿä¸€çš„TraceIdå°†è°ƒç”¨é“¾è·¯ä¸­çš„å„ç§ç½‘ç»œè°ƒç”¨æƒ…å†µä»¥æ—¥å¿—çš„æ–¹å¼è®°å½•ä¸‹æ¥ï¼ŒåŒæ—¶ä¹Ÿæä¾›è¿œç¨‹æ±‡æŠ¥åˆ°Zipkinè¿›è¡Œå¯è§†åŒ–å±•ç¤ºã€‚</p>
<p>è¯¦æƒ…å‚è€ƒ<a href="https://www.sofastack.tech/projects/sofa-tracer/overview/" target="_blank" rel="noopener">SOFATracerå®˜æ–¹æ–‡æ¡£</a>ã€‚</p>
<hr>
<p>Dapperæ–¹æ¡ˆåˆ†ä¸ºæ•°æ®æ”¶é›†ã€å­˜å‚¨å’Œåˆ†æã€‚</p>
<p>è®°å½•ä¸€ä¸ªè¯·æ±‚ä¸­å„æ¨¡å—çš„è°ƒç”¨ä¿¡æ¯ï¼Œå¹¶é€šè¿‡ä¸€ä¸ªå¤„ç†é›†ç¾¤æŠŠæ‰€æœ‰æœºå™¨ä¸Šçš„æ—¥å¿—å¢é‡åœ°æ”¶é›†åˆ°é›†ç¾¤ä¸­ï¼Œå°†åŒä¸€ä¸ªè¯·æ±‚çš„æ—¥å¿—ä¸²è”ï¼Œå¯è§†åŒ–æ˜¾ç¤ºè°ƒç”¨æƒ…å†µã€‚</p>
<p>ä¸€ä¸ªè°ƒç”¨è¿‡ç¨‹æ„æˆä¸€æ£µè°ƒç”¨æ ‘ï¼ŒTraceræ ‘ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹è¡¨ç¤ºé“¾è·¯è°ƒç”¨ä¸­çš„ä¸€ä¸ªæ¨¡å—æˆ–ç³»ç»Ÿã€‚</p>
<p>é€šè¿‡ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„TraceIdæ¥æ ‡è¯†ä¸€ä¸ªè¯·æ±‚è°ƒç”¨é“¾ã€‚</p>
<p>TraceIdç”±é›†ç¾¤ä¸­ç¬¬ä¸€ä¸ªå¤„ç†è¯·æ±‚çš„ç³»ç»Ÿäº§ç”Ÿï¼Œå¹¶åœ¨åˆ†å¸ƒå¼è°ƒç”¨ä¸‹é€šè¿‡ç½‘ç»œä¼ é€’åˆ°ä¸‹ä¸€ä¸ªè¢«è¯·æ±‚ç³»ç»Ÿã€‚</p>
<p>TraceIdä¿è¯å…¨å±€å”¯ä¸€ï¼ŒSOFATracerçš„ç”Ÿæˆè§„åˆ™å‚è€ƒäº†æ·˜å®çš„é¹°çœ¼ï¼šæœåŠ¡å™¨IP + æ—¶é—´æˆ³ + è‡ªå¢åºåˆ— + å½“å‰è¿›ç¨‹å·ã€‚</p>
<p>Spanè¡¨ç¤ºä¸€ä¸ªç³»ç»ŸRPCçš„è°ƒç”¨ï¼ˆå­æ ‘ï¼‰ï¼ŒåŒ…å«ï¼š</p>
<ul>
<li><p>Startï¼šå‘èµ·è°ƒç”¨ï¼›</p>
</li>
<li><p>Cleint Send(cs)ï¼šå®¢æˆ·ç«¯å‘é€è¯·æ±‚ï¼›</p>
</li>
<li><p>Server Recv(sr)ï¼šæœåŠ¡ç«¯æ”¶åˆ°è¯·æ±‚ï¼›</p>
</li>
<li><p>Server Send(ss)ï¼šæœåŠ¡ç«¯å‘é€å“åº”ï¼›</p>
</li>
<li><p>Client Recv(cr)ï¼šå®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡ç«¯å“åº”ï¼›</p>
</li>
<li><p>Endï¼šæ•´ä¸ªé“¾è·¯å®Œæˆï¼›</p>
</li>
</ul>
<p>ä¸€æ¬¡RPCè°ƒç”¨ç§°ä¸ºSpanï¼Œå¹¶äº§ç”Ÿä¸€ä¸ªSpanIdï¼ŒClientSpançš„SpanIdå’ŒServerSpançš„SpanIdæ˜¯åŒä¸€ä¸ªï¼Œå› ä¸ºéƒ½åœ¨ä¸€ä¸ªRPCè°ƒç”¨ä¸­ã€‚</p>
<p>æ¯ä¸ªSpanåŒ…å«SpanIdï¼ˆå½“å‰æ¨¡å—çš„ï¼‰å’ŒParentSpanIdï¼ˆä¸Šä¸€ä¸ªè°ƒç”¨æ¨¡å—ï¼‰ï¼Œé€šè¿‡è¿™ä¸¤ä¸ªä¿¡æ¯å®šä½ä¸€ä¸ªSpanåœ¨è°ƒç”¨é“¾çš„ä½ç½®ã€‚</p>
<p>åœ¨SOFATracerä¸­åˆ†ä¸ºClientSpanå’ŒServerSpanã€‚</p>
<p>ClientSpanï¼šä»å®¢æˆ·ç«¯å‘é€è¯·æ±‚ç»™æœåŠ¡ç«¯ï¼Œåˆ°æ¥å—åˆ°æœåŠ¡ç«¯å“åº”çš„è¿‡ç¨‹ã€‚</p>
<p>ServerSpanï¼šæœåŠ¡ç«¯æ”¶åˆ°å®¢æˆ·ç«¯è¯·æ±‚åˆ°å‘é€å“åº”ç»™å®¢æˆ·ç«¯çš„è¿‡ç¨‹ã€‚</p>
<p>å¦‚æœAç³»ç»Ÿåœ¨å¤„ç†ä¸€ä¸ªè¯·æ±‚çš„è¿‡ç¨‹ä¸­ä¾æ¬¡è°ƒç”¨äº†Bï¼ŒCï¼ŒDä¸‰ä¸ªç³»ç»Ÿï¼Œè¿™ä¸‰æ¬¡è°ƒç”¨çš„çš„SpanIdåˆ†åˆ«æ˜¯ï¼š0.1ï¼Œ0.2ï¼Œ0.3ã€‚</p>
<p>å¦‚æœCç³»ç»Ÿç»§ç»­è°ƒç”¨äº†Eï¼ŒFä¸¤ä¸ªç³»ç»Ÿï¼Œé‚£ä¹ˆè¿™ä¸¤æ¬¡è°ƒç”¨çš„SpanIdåˆ†åˆ«æ˜¯ï¼š0.2.1ï¼Œ0.2.2ã€‚</p>
<p>åœ¨SOFATracerä¸­ï¼ŒSpanIdä¸­å·²ç»åŒ…å«äº†è°ƒç”¨é“¾ä¸Šä¸‹æ–‡å…³ç³»ï¼ŒåŒ…å«ParentSpanIdã€‚</p>
<hr>
<p>é‡‡æ ·ç‡ï¼š</p>
<p>å¦‚æœå°†æ¯æ¡åŸ‹ç‚¹æ•°æ®éƒ½åˆ·æ–°åˆ°ç£ç›˜ä¸Šï¼Œæ€§èƒ½ä¼šé™ä½ï¼›å¦‚æœé‡‡æ ·ç‡å¤ªä½ï¼Œå¯èƒ½ä¼šå¯¼è‡´ç»Ÿè®¡æ•°æ®ä¸å‡†ç¡®ã€‚</p>
<p>SOFATracerä½¿ç”¨RingBufferçš„æ•°æ®ç»“æ„ï¼Œè®¾ç½®ä¸€ä¸ª1024çš„æ§½ä½å­˜å‚¨æ¯ä¸ªé“¾è·¯è°ƒç”¨çš„åŸ‹ç‚¹æ•°æ®ã€‚</p>
<p>RingBufferå¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªåœ†å½¢æ•°ç»„ï¼Œä»æ§½ä½0å¼€å§‹ä¸€ç›´åˆ°1023ï¼Œç„¶åä»å¤´å¼€å§‹ï¼Œæ”¾åœ¨åŸæ¥æ§½ä½çš„æ•°æ®å°†è¢«è¦†ç›–ã€‚</p>
<p>å½“æ•°æ®å†™å…¥çš„é€Ÿåº¦è¿œè¿œå¤§äºæ¶ˆè´¹å¤„ç†é€Ÿåº¦ï¼Œç¯ä¸Šçš„æ•°æ®åœ¨æœªè¢«å¤„ç†æ—¶å°±è¢«è¦†ç›–ï¼Œè‡ªåŠ¨è°ƒæ•´é‡‡æ ·ç‡ï¼Œå¹¶å‘æ€§è¶Šé«˜ï¼Œé‡‡æ ·ç‡å°±è¶Šä½ã€‚</p>
<hr>
<p>å¼‚æ­¥æ—¥å¿—åˆ·ç›˜ï¼š</p>
<p>åŸºäºDisruptorï¼Œå¼‚æ­¥å°†RingBufferçš„æ•°æ®åˆ·æ–°åˆ°ç£ç›˜ã€‚</p>
<p>å½“RingBufferå†™å…¥æ–°æ•°æ®æ—¶ä¼šå”¤é†’å¤„ç†çº¿ç¨‹ï¼Œå¹¶å°†å½“å‰å­˜å…¥æ•°æ®çš„æ§½ä½è®¾ç½®ä¸ºå¯ç”¨æ§½ä½ã€‚</p>
<p>å¤„ç†çº¿ç¨‹ä»ç¡çœ ç‚¹é†’æ¥åï¼Œä»åŸæ¥å¤„ç†ä½ç½®å¾€ä¸‹è·å–æ•°æ®å¹¶å¤„ç†ï¼Œç›´åˆ°æ‰€å¤„ç†æ•°æ®æ§½ä½å¤§äºå¯ç”¨æ§½ä½ï¼Œåˆ™é˜»å¡ç­‰å¾…ã€‚</p>
<p>SOFATraceræä¾›æ—¥å¿—æ‰“å°ç±»å‹ï¼šå³æ‘˜è¦æ—¥å¿—å’Œç»Ÿè®¡æ—¥å¿—ã€‚</p>
<p>æ‘˜è¦æ—¥å¿—ï¼šæ¯ä¸€æ¬¡è°ƒç”¨å‡ä¼šè½åœ°ç£ç›˜çš„æ—¥å¿—ã€‚</p>
<p>ç»Ÿè®¡æ—¥å¿—ï¼šæ¯éš”ä¸€å®šæ—¶é—´é—´éš”è¿›è¡Œç»Ÿè®¡è¾“å‡ºçš„æ—¥å¿—ã€‚</p>
<hr>
<p>Four Golden Signalsï¼š</p>
<p>Googleé’ˆå¯¹å¤§é‡åˆ†å¸ƒå¼ç›‘æ§çš„ç»éªŒæ€»ç»“ï¼Œ4ä¸ªé»„é‡‘æŒ‡æ ‡å¯ä»¥åœ¨æœåŠ¡çº§åˆ«å¸®åŠ©è¡¡é‡ç”¨æˆ·ä½“éªŒã€æœåŠ¡ä¸­æ–­ã€ä¸šåŠ¡å½±å“ç­‰å±‚é¢çš„é—®é¢˜ã€‚</p>
<p>ä¸»è¦å…³æ³¨ä»¥ä¸‹å››ç§ç±»å‹çš„æŒ‡æ ‡ï¼šååé‡ï¼Œå“åº”æ—¶é—´ï¼Œé”™è¯¯ç‡ä»¥åŠé¥±å’Œåº¦ã€‚</p>
<p>å¯¹äºæœåŠ¡çº§åˆ«ï¼Œé€šå¸¸ä½¿ç”¨å‰ä¸‰ä¸ªæŒ‡æ ‡è¿›è¡Œåº¦é‡ã€‚</p>
<hr>
<p>åŸ‹ç‚¹æ•°æ®ä¼ é€ï¼š</p>
<p>å„æ¨¡å—éƒ¨ç½²åç‹¬ç«‹æ”¶é›†åŸ‹ç‚¹æ—¥å¿—ï¼Œè¿™äº›è°ƒç”¨é“¾æ—¥å¿—é€šè¿‡TraceIdä¸²è”åœ¨ä¸€èµ·ã€‚</p>
<p>åŸ‹ç‚¹æ•°æ®å¦‚TraceIdåŠSpanIdéœ€è¦é€ä¼ ç»™ä¸‹æ¸¸æ¨¡å—ã€‚</p>
<p>æ•°æ®ä¼ è¾“ä¸€èˆ¬æœ‰ä¸¤ç§ï¼š</p>
<ol>
<li><p>å¸¦å†…é€ä¼ ï¼šåœ¨åŸæ¥çš„RPCè°ƒç”¨è¯·æ±‚ä¸­åŠ å…¥åŸ‹ç‚¹æ•°æ®é€ä¼ ç»™ä¸‹æ¸¸ï¼›</p>
</li>
<li><p>å¸¦å¤–ä¼ æ’­ï¼šå•ç‹¬ä¼ æ’­ï¼Œä¸å½±å“åŸè°ƒç”¨æ•°æ®å’Œç½‘ç»œã€‚</p>
</li>
</ol>
<hr>
<p>å¼‚æ­¥åœºæ™¯ï¼š</p>
<p>ä¸€ä¸ªæœåŠ¡å¯èƒ½ä¼šèµ·å¤šä¸ªçº¿ç¨‹åŒæ—¶è°ƒç”¨å…¶ä»–ä¸åŒçš„æ¨¡å—ã€‚</p>
<p>SOFATraceræä¾›äº†SofaTracerCallableç±»ï¼Œè‡ªåŠ¨å°†é“¾è·¯è°ƒç”¨çš„ä¸Šä¸‹æ–‡ä¿¡æ¯é€ä¼ ç»™ SofaTracerCallableã€‚</p>
<p>å¼‚æ­¥RPCè°ƒç”¨ï¼Œæ¯æ¬¡è°ƒç”¨ä¸ç­‰è¿”å›å°±ç»§ç»­å‘èµ·ä¸‹ä¸€æ¬¡è°ƒç”¨ï¼Œæ­¤æ—¶å½“å‰çº¿ç¨‹ä¸­åº”è¯¥æå‰æ¸…ç†Contextï¼Œä¸ä¼šç­‰åˆ°Callbackä¹‹åï¼Œå¦åˆ™ä¼šæœ‰å†²çªã€‚</p>
<hr>
<table>
<thead>
<tr>
<th align="center">æ¡†æ¶</th>
<th align="center">åŸ‹ç‚¹æ–¹å¼</th>
<th align="center">æ”¶é›†å’Œå­˜å‚¨æ–¹å¼</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Dapper</td>
<td align="center">åœ¨å…¬å…±ç»„ä»¶åŸ‹ç‚¹</td>
<td align="center">åå°è¿›ç¨‹æ‹‰å–æ•°æ®</td>
</tr>
<tr>
<td align="center">é¹°çœ¼</td>
<td align="center">åœ¨å…¬å…±ç»„ä»¶åŸ‹ç‚¹</td>
<td align="center">Agentæ”¶é›†æ—¥å¿—</td>
</tr>
<tr>
<td align="center">CAT</td>
<td align="center">ä¸šåŠ¡ä»£ç åŸ‹ç‚¹</td>
<td align="center">Agentæ”¶é›†æ—¥å¿—</td>
</tr>
<tr>
<td align="center">Zipkin</td>
<td align="center">æ‹¦æˆªè¯·æ±‚</td>
<td align="center">HTTPå°†å‘é€æ•°æ®è‡³ZipkinæœåŠ¡</td>
</tr>
<tr>
<td align="center">Skywalking</td>
<td align="center">Javaæ¢é’ˆ</td>
<td align="center">Agentæ”¶é›†æ—¥å¿—</td>
</tr>
</tbody></table>
<hr>
<p>SOFATraceræ˜¯åŸºäºSpringbootè¿›è¡Œè‡ªåŠ¨é…ç½®çš„ã€‚</p>
<p>FlexibleTracerå¯¹åº”çš„æ˜¯æ‰‹åŠ¨è¿›è¡Œä»£ç åŸ‹ç‚¹å’Œä½¿ç”¨<code>@Tracer</code>æ³¨è§£åŸ‹ç‚¹çš„ç±»å‹ã€‚</p>
<p>SofaTracerMethodInvocationProcessor#proceedProxyMethodWithTracerAnnotation</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> Object <span class="token function">proceedProxyMethodWithTracerAnnotation</span><span class="token punctuation">(</span>MethodInvocation invocation<span class="token punctuation">,</span> Tracer tracerSpan<span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tracer <span class="token keyword">instanceof</span> <span class="token class-name">FlexibleTracer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                String operationName <span class="token operator">=</span> tracerSpan<span class="token punctuation">.</span><span class="token function">operateName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>operationName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    operationName <span class="token operator">=</span> invocation<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// æ‰§è¡Œå‰</span>
                SofaTracerSpan sofaTracerSpan <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>FlexibleTracer<span class="token punctuation">)</span> tracer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">beforeInvoke</span><span class="token punctuation">(</span>operationName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                sofaTracerSpan<span class="token punctuation">.</span><span class="token function">setTag</span><span class="token punctuation">(</span>CommonSpanTags<span class="token punctuation">.</span>METHOD<span class="token punctuation">,</span> invocation<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>invocation<span class="token punctuation">.</span><span class="token function">getArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> invocation<span class="token punctuation">.</span><span class="token function">getArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    StringBuilder stringBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span>Object obj <span class="token operator">:</span> invocation<span class="token punctuation">.</span><span class="token function">getArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        stringBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">";"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    sofaTracerSpan<span class="token punctuation">.</span><span class="token function">setTag</span><span class="token punctuation">(</span><span class="token string">"param.types"</span><span class="token punctuation">,</span> stringBuilder<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> stringBuilder<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// æ‰§è¡Œ</span>
                <span class="token keyword">return</span> invocation<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">(</span><span class="token punctuation">(</span>FlexibleTracer<span class="token punctuation">)</span> tracer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">afterInvoke</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> t<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æ‰§è¡Œå®Œ</span>
                <span class="token punctuation">(</span><span class="token punctuation">(</span>FlexibleTracer<span class="token punctuation">)</span> tracer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">afterInvoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> invocation<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>æ‰‹åŠ¨åŸ‹ç‚¹ç¤ºä¾‹ï¼š</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// æ³¨å…¥ tracer</span>
<span class="token annotation punctuation">@Autowired</span>
Tracer tracer<span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">testManual</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// beforeInvoke å¼€å§‹</span>
        SofaTracerSpan sofaTracerSpan <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>FlexibleTracer<span class="token punctuation">)</span> tracer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">beforeInvoke</span><span class="token punctuation">(</span><span class="token string">"testManual"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sofaTracerSpan<span class="token punctuation">.</span><span class="token function">setTag</span><span class="token punctuation">(</span><span class="token string">"manualKey"</span><span class="token punctuation">,</span> <span class="token string">"glmapper"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// do your biz</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// å¼‚å¸¸ç»“æŸ</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span>FlexibleTracer<span class="token punctuation">)</span> tracer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">afterInvoke</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// æ­£å¸¸ç»“æŸ</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span>FlexibleTracer<span class="token punctuation">)</span> tracer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">afterInvoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>@TraceråŸ‹ç‚¹ç¤ºä¾‹ï¼š</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// åœ¨ hello æ–¹æ³•ä¸Šä½¿ç”¨ @Tracer æ³¨è§£è¿›è¡ŒåŸ‹ç‚¹</span>
<span class="token annotation punctuation">@Tracer</span>
<span class="token keyword">public</span> String <span class="token function">hello</span><span class="token punctuation">(</span>String word<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// è‡ªå®šä¹‰ tag æ•°æ®</span>
    SpanTags<span class="token punctuation">.</span><span class="token function">putTags</span><span class="token punctuation">(</span><span class="token string">"author"</span><span class="token punctuation">,</span> <span class="token string">"glmapper"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// å¤±æ•ˆ</span>
    <span class="token function">helloInner</span><span class="token punctuation">(</span>word<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">"glmapper : hello "</span> <span class="token operator">+</span> word<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// åœ¨ hello æ–¹æ³•ä¸Šä½¿ç”¨ @Tracer æ³¨è§£è¿›è¡ŒåŸ‹ç‚¹</span>
<span class="token annotation punctuation">@Tracer</span>
<span class="token keyword">private</span> String <span class="token function">helloInner</span><span class="token punctuation">(</span>String word<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">"glmapper : hello "</span> <span class="token operator">+</span> word<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p><code>@Tracer</code>åŸºäºSpring Aopï¼Œä¸Šé¢<code>helloInner</code>æ–¹æ³•ä¸ä¼šä½¿ç”¨ä»£ç†å¯¹è±¡ï¼Œè€Œæ˜¯<code>this</code>ï¼Œä¼šå¯¼è‡´<code>helloInner</code>çš„æ³¨è§£åŸ‹ç‚¹å¤±æ•ˆã€‚</p>
<p>å¯ä»¥ä½¿ç”¨æ‰‹åŠ¨åŸ‹ç‚¹å¼¥è¡¥ã€‚</p>
<hr>
<p>OpenFeignåŸ‹ç‚¹æ¥å…¥ï¼š</p>
<p>SofaTracerHystrixConcurrencyStrategy#wrapCallable</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> Callable<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token function">wrapCallable</span><span class="token punctuation">(</span>Callable<span class="token operator">&lt;</span>T<span class="token operator">></span> callable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>callable <span class="token keyword">instanceof</span> <span class="token class-name">SofaTracerCallable</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> callable<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// åŒ…è£…Callableï¼Œä¼ é€’å¼‚æ­¥ä¸Šä¸‹æ–‡</span>
        Callable<span class="token operator">&lt;</span>T<span class="token operator">></span> wrappedCallable <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>delegate <span class="token operator">!=</span> null <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>delegate<span class="token punctuation">.</span><span class="token function">wrapCallable</span><span class="token punctuation">(</span>callable<span class="token punctuation">)</span> <span class="token operator">:</span> callable<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>wrappedCallable <span class="token keyword">instanceof</span> <span class="token class-name">SofaTracerCallable</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> wrappedCallable<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SofaTracerCallable</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>wrappedCallable<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>SofaTracerHystrixFeignBuilder#client</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">static</span> Client <span class="token function">client</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// è¿”å›åŒ…è£…ä»£ç†åçš„FeignClientå¯¹è±¡</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SofaTracerFeignClient</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Client<span class="token punctuation">.</span>Default</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>FeignTracerRequestInterceptor#apply</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">apply</span><span class="token punctuation">(</span>RequestTemplate template<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        SofaTracerSpan currentSpan <span class="token operator">=</span> SofaTraceContextHolder<span class="token punctuation">.</span><span class="token function">getSofaTraceContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCurrentSpan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentSpan <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            SofaTracerSpanContext spanContext <span class="token operator">=</span> currentSpan<span class="token punctuation">.</span><span class="token function">getSofaTracerSpanContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// é€šè¿‡è¯·æ±‚å¤´ä¼ é€’Tracing Context</span>
            template<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span>TRACE_ID_KEY_HEAD<span class="token punctuation">,</span> <span class="token function">encodedValue</span><span class="token punctuation">(</span>spanContext<span class="token punctuation">.</span><span class="token function">getTraceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            template<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span>SPAN_ID_KEY_HEAD<span class="token punctuation">,</span> <span class="token function">encodedValue</span><span class="token punctuation">(</span>spanContext<span class="token punctuation">.</span><span class="token function">getSpanId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            template<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span>PARENT_SPAN_ID_KEY_HEAD<span class="token punctuation">,</span> <span class="token function">encodedValue</span><span class="token punctuation">(</span>spanContext<span class="token punctuation">.</span><span class="token function">getParentId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            template<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span>SPAN_ID_KEY_HEAD<span class="token punctuation">,</span> <span class="token function">encodedValue</span><span class="token punctuation">(</span>spanContext<span class="token punctuation">.</span><span class="token function">getSpanId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            template<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span>SAMPLED_KEY_HEAD<span class="token punctuation">,</span> <span class="token function">encodedValue</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>spanContext<span class="token punctuation">.</span><span class="token function">isSampled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//System Baggage items</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>Map<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> entry <span class="token operator">:</span> spanContext<span class="token punctuation">.</span><span class="token function">getSysBaggage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">//Business Baggage items</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>Map<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> entry <span class="token operator">:</span> spanContext<span class="token punctuation">.</span><span class="token function">getBizBaggage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>SpringMVCåŸ‹ç‚¹æ¥å…¥ï¼š</p>
<p>SpringMvcSofaTracerFilter#doFilter</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span>ServletRequest servletRequest<span class="token punctuation">,</span> ServletResponse servletResponse<span class="token punctuation">,</span> FilterChain filterChain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        SofaTracerSpan springMvcSpan <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            HttpServletRequest request <span class="token operator">=</span> <span class="token punctuation">(</span>HttpServletRequest<span class="token punctuation">)</span> servletRequest<span class="token punctuation">;</span>
            HttpServletResponse response <span class="token operator">=</span> <span class="token punctuation">(</span>HttpServletResponse<span class="token punctuation">)</span> servletResponse<span class="token punctuation">;</span>
            SofaTracerSpanContext spanContext <span class="token operator">=</span> <span class="token function">getSpanContextFromRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// sr</span>
            springMvcSpan <span class="token operator">=</span> springMvcTracer<span class="token punctuation">.</span><span class="token function">serverReceive</span><span class="token punctuation">(</span>spanContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// wrapper</span>
            ResponseWrapper responseWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResponseWrapper</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// filter begin</span>
            filterChain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>servletRequest<span class="token punctuation">,</span> responseWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// filter end</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>springMvcSpan <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
                <span class="token comment" spellcheck="true">//ss</span>
                springMvcTracer<span class="token punctuation">.</span><span class="token function">serverSend</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>httpStatus<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>FlexibleTracer#beforeInvoke</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> SofaTracerSpan <span class="token function">beforeInvoke</span><span class="token punctuation">(</span>String operationName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        SofaTraceContext sofaTraceContext <span class="token operator">=</span> SofaTraceContextHolder<span class="token punctuation">.</span><span class="token function">getSofaTraceContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ä»çº¿ç¨‹æœ¬åœ°å˜é‡å–å‡ºTraceä¸Šä¸‹æ–‡ï¼Œæœ‰ç‚¹ç±»ä¼¼æ–¹æ³•çš„è°ƒç”¨æ ˆ</span>
        SofaTracerSpan serverSpan <span class="token operator">=</span> sofaTraceContext<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        SofaTracerSpan methodSpan <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æœ¬æ¬¡æ–¹æ³•è°ƒç”¨Spanæ˜¯ä¸Šä¸€çº§è°ƒç”¨Spançš„å­©å­ï¼Œå³CHILD_OFï¼Œè¿˜æœ‰ä¸€ç§æ˜¯FOLLOWS_FROMï¼Œè¯´æ˜æ˜¯å¹³çº§çš„è°ƒç”¨</span>
            methodSpan <span class="token operator">=</span> <span class="token punctuation">(</span>SofaTracerSpan<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildSpan</span><span class="token punctuation">(</span>operationName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asChildOf</span><span class="token punctuation">(</span>serverSpan<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ç¼“å­˜ä¸Šä¸€çº§Span</span>
            <span class="token comment" spellcheck="true">// Need to actively cache your own serverSpan, because: asChildOf is concerned about spanContext</span>
            methodSpan<span class="token punctuation">.</span><span class="token function">setParentSofaTracerSpan</span><span class="token punctuation">(</span>serverSpan<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>methodSpan <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// get appName</span>
                String appName <span class="token operator">=</span> SofaTracerConfiguration<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span>SofaTracerConfiguration<span class="token punctuation">.</span>TRACER_APPNAME_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
                methodSpan<span class="token punctuation">.</span><span class="token function">setTag</span><span class="token punctuation">(</span>CommonSpanTags<span class="token punctuation">.</span>LOCAL_APP<span class="token punctuation">,</span> appName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                methodSpan<span class="token punctuation">.</span><span class="token function">setTag</span><span class="token punctuation">(</span>CommonSpanTags<span class="token punctuation">.</span>METHOD<span class="token punctuation">,</span> operationName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// all as client</span>
                methodSpan<span class="token punctuation">.</span><span class="token function">setTag</span><span class="token punctuation">(</span>Tags<span class="token punctuation">.</span>SPAN_KIND<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Tags<span class="token punctuation">.</span>SPAN_KIND_CLIENT<span class="token punctuation">)</span><span class="token punctuation">;</span>
                methodSpan<span class="token punctuation">.</span><span class="token function">setTag</span><span class="token punctuation">(</span>CommonSpanTags<span class="token punctuation">.</span>CURRENT_THREAD_NAME<span class="token punctuation">,</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                methodSpan<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>LogData<span class="token punctuation">.</span>CLIENT_SEND_EVENT_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// è®¾ç½®çº¿ç¨‹ä¸Šä¸‹æ–‡</span>
                sofaTraceContext<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>methodSpan<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> methodSpan<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>SofaTracer$SofaTracerSpanBuilder#start</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> Span <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            SofaTracerSpanContext sofaTracerSpanContext<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è¯´æ˜æœ¬Spanä¸æ˜¯é¡¶çº§çš„Span</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>references <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>references<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">//Parent context exist</span>
                sofaTracerSpanContext <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createChildContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// Root Span</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">//Start with new root span context</span>
                sofaTracerSpanContext <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createRootSpanContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">long</span> begin <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>startTime <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>startTime <span class="token operator">:</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            SofaTracerSpan sofaTracerSpan <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SofaTracerSpan</span><span class="token punctuation">(</span>SofaTracer<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">,</span> begin<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>references<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>operationName<span class="token punctuation">,</span> sofaTracerSpanContext<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tags<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è®¡ç®—æœ¬æ®µSpanæ˜¯å¦é‡‡æ ·</span>
            <span class="token comment" spellcheck="true">// calculate isSampledï¼Œbut do not change parent's sampler behaviour</span>
            <span class="token keyword">boolean</span> isSampled <span class="token operator">=</span> <span class="token function">calculateSampler</span><span class="token punctuation">(</span>sofaTracerSpan<span class="token punctuation">)</span><span class="token punctuation">;</span>
            sofaTracerSpanContext<span class="token punctuation">.</span><span class="token function">setSampled</span><span class="token punctuation">(</span>isSampled<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> sofaTracerSpan<span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>SofaTracer$SofaTracerSpanBuilder#createChildContext</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">private</span> SofaTracerSpanContext <span class="token function">createChildContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            SofaTracerSpanContext preferredReference <span class="token operator">=</span> <span class="token function">preferredReference</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            SofaTracerSpanContext sofaTracerSpanContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SofaTracerSpanContext</span><span class="token punctuation">(</span>
                    <span class="token comment" spellcheck="true">// TraceId</span>
                    preferredReference<span class="token punctuation">.</span><span class="token function">getTraceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token comment" spellcheck="true">// ç”Ÿæˆæœ¬æ®µSpanï¼šParentSpanId + . + Increment</span>
                    preferredReference<span class="token punctuation">.</span><span class="token function">nextChildContextId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token comment" spellcheck="true">// ParentSpanId</span>
                    preferredReference<span class="token punctuation">.</span><span class="token function">getSpanId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token comment" spellcheck="true">// æ˜¯å¦é‡‡æ ·</span>
                    preferredReference<span class="token punctuation">.</span><span class="token function">isSampled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sofaTracerSpanContext<span class="token punctuation">.</span><span class="token function">addBizBaggage</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createChildBaggage</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sofaTracerSpanContext<span class="token punctuation">.</span><span class="token function">addSysBaggage</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createChildBaggage</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> sofaTracerSpanContext<span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>SofaTracer$SofaTracerSpanBuilder#createRootSpanContext</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">private</span> SofaTracerSpanContext <span class="token function">createRootSpanContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//generate traceId</span>
            String traceId <span class="token operator">=</span> TraceIdGenerator<span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SofaTracerSpanContext</span><span class="token punctuation">(</span>traceId<span class="token punctuation">,</span> ROOT_SPAN_ID<span class="token punctuation">,</span> StringUtils<span class="token punctuation">.</span>EMPTY_STRING<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>FlexibleTracer#afterInvoke</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterInvoke</span><span class="token punctuation">(</span>String error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        SofaTraceContext sofaTraceContext <span class="token operator">=</span> SofaTraceContextHolder<span class="token punctuation">.</span><span class="token function">getSofaTraceContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        SofaTracerSpan clientSpan <span class="token operator">=</span> sofaTraceContext<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// finish client span</span>
        clientSpan<span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// restore parent span</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>clientSpan<span class="token punctuation">.</span><span class="token function">getParentSofaTracerSpan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è°ƒç”¨å®Œåæ¢å¤çº¿ç¨‹ä¸Šä¸‹æ–‡ä¸ºä¸Šçº§Span</span>
            <span class="token comment" spellcheck="true">// æ¨¡æ‹Ÿæ–¹æ³•çš„è°ƒç”¨æ ˆï¼Œæ–¹æ³•è°ƒç”¨å…¥æ ˆï¼Œè°ƒç”¨å®Œå‡ºæ ˆï¼Œæœ€é‡Œçš„æ–¹æ³•æ˜¯æœ€å…ˆè°ƒç”¨å®Œçš„ï¼Œå¤„äºæ ˆé¡¶</span>
            sofaTraceContext<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>clientSpan<span class="token punctuation">.</span><span class="token function">getParentSofaTracerSpan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>SofaTracerSpan#finish</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">finish</span><span class="token punctuation">(</span><span class="token keyword">long</span> endTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setEndTime</span><span class="token punctuation">(</span>endTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//Key record:report span</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>sofaTracer<span class="token punctuation">.</span><span class="token function">reportSpan</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        SpanExtensionFactory<span class="token punctuation">.</span><span class="token function">logStoppedSpan</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>FlexibleTracer#reportSpan</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">reportSpan</span><span class="token punctuation">(</span>SofaTracerSpan span<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// é…ç½®äº†é‡‡æ ·å™¨ &amp;&amp; å½“å‰Spanæ˜¯æ ¹Span</span>
        <span class="token comment" spellcheck="true">// sampler is support &amp;  current span is root span</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSampler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> span<span class="token punctuation">.</span><span class="token function">getParentSofaTracerSpan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ç”±é‡‡æ ·å™¨å†³å®šæ˜¯å¦é‡‡æ ·ï¼Œå…¶å®æ˜¯å¯¹ä¸€ä¸ªéšæœºçš„ä½æ•°ç»„å–æ¨¡è½®è¯¢</span>
            span<span class="token punctuation">.</span><span class="token function">getSofaTracerSpanContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setSampled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSampler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sample</span><span class="token punctuation">(</span>span<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isSampled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// è§¦å‘å›è°ƒï¼Œè¿™é‡Œä¼šä¸ŠæŠ¥ç»™Zipkin</span>
        <span class="token comment" spellcheck="true">//invoke listener</span>
        <span class="token function">invokeReportListeners</span><span class="token punctuation">(</span>span<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reporter <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å†™å…¥æ—¥å¿—</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>reporter<span class="token punctuation">.</span><span class="token function">report</span><span class="token punctuation">(</span>span<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


        <footer>
             
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

        </footer>
    </div>
    <!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
    <script>
        var timeEnd = new Date();
        console.log('è€—æ—¶ï¼š' + (timeEnd - timeStart));
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre').forEach((block) => {
                block.classList.add("line-numbers");
            });
        });
    </script>
    <!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
    <!-- material design -->
    <!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
    <!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
    <!-- toc -->
    <!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
    <!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
    <!-- <script src="/js/main.js"></script> -->
    <script src="/js/prism.js"></script>
</body>
</html>
