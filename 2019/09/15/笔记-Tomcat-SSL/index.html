<!DOCTYPE HTML>
<html>

<head>
    <script>
        var timeStart = new Date();
    </script>
    <meta charset="utf-8">
    
    <title>[笔记]-Tomcat-SSL | 草木禾</title>
    
    <meta name="author" content="huangzhike">
    
    
    <meta name="description"
        content="NioEndpoint$SocketProcessor#doRun
        @Override
        protected void doRun() {
            // ...
            try {
                int handshak">
    
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta property="og:title" content="[笔记]-Tomcat-SSL" />
    
    <meta property="og:site_name" content="草木禾" />
    
    
    <!-- favicon -->
    <link rel="icon" type="image/ico" href="/logo.ico" sizes="32x32">
    <meta name="msapplication-TileColor" content="#009688">
    <meta name="msapplication-TileImage" content="/mstile-144x144.ico">
    <meta name="theme-color" content="#009688">
    <!-- favicon end -->
    <!-- <link href="//ok.ico" rel="icon"> -->
    

    <!-- <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.5.0/css/bootstrap.min.css" rel="stylesheet"> -->
    <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
    <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
    <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">

<meta name="generator" content="Hexo 4.2.1"></head>
<body>
    <nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">菜单</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" title="早く来い、クラウド" href="/">Reunion...</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" target="_blank" rel="noopener" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

    <div class="container" >
        <div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[笔记]-Tomcat-SSL</h2>
				
				<div>
					<div class="post-time">2019-09-15</div>
				</div>
				
				<div class="article-content">
				<p>NioEndpoint$SocketProcessor#doRun</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doRun</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> handshake <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// NioChannel默认握手完成，SecureNioChannel需要TLS握手</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>socket<span class="token punctuation">.</span><span class="token function">isHandshakeComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            handshake <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment" spellcheck="true">// 当做握手失败</span>
                        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token operator">==</span> SocketEvent<span class="token punctuation">.</span>STOP <span class="token operator">||</span> event <span class="token operator">==</span> SocketEvent<span class="token punctuation">.</span>DISCONNECT <span class="token operator">||</span> event <span class="token operator">==</span> SocketEvent<span class="token punctuation">.</span>ERROR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            handshake <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment" spellcheck="true">// 握手没完成</span>
                        <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// 执行握手，可读可写</span>
                            handshake <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">handshake</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">isReadable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">.</span><span class="token function">isWritable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// 握手完成时必须为SocketEvent.OPEN_READ</span>
                            <span class="token comment" spellcheck="true">// 因为只在握手完成时使用，这里设置也是可以的</span>
                            event <span class="token operator">=</span> SocketEvent<span class="token punctuation">.</span>OPEN_READ<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    handshake <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">CancelledKeyException</span> ckx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    handshake <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 握手完成</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>handshake <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// Socket打开状态</span>
                    SocketState state <span class="token operator">=</span> SocketState<span class="token punctuation">.</span>OPEN<span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// 默认处理请求</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ConnectionHandler，一个Endpoint关联一个Handler，存放了Socket和Processor的关联</span>
                        <span class="token comment" spellcheck="true">// Socket打开并且可读状态</span>
                        state <span class="token operator">=</span> <span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>socketWrapper<span class="token punctuation">,</span> SocketEvent<span class="token punctuation">.</span>OPEN_READ<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// 处理指定事件</span>
                    <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        state <span class="token operator">=</span> <span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>socketWrapper<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// 关闭Socket</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 取消之前关心的事件，并关闭Socket</span>
                        poller<span class="token punctuation">.</span><span class="token function">cancelledKey</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> socketWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 握手失败</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>handshake <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>socketWrapper<span class="token punctuation">,</span> SocketEvent<span class="token punctuation">.</span>CONNECT_FAIL<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    poller<span class="token punctuation">.</span><span class="token function">cancelledKey</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> socketWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 握手时没读完，重新关注可读事件</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>handshake <span class="token operator">==</span> SelectionKey<span class="token punctuation">.</span>OP_READ<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    socketWrapper<span class="token punctuation">.</span><span class="token function">registerReadInterest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 握手时没写完，重新关注可写事件</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>handshake <span class="token operator">==</span> SelectionKey<span class="token punctuation">.</span>OP_WRITE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    socketWrapper<span class="token punctuation">.</span><span class="token function">registerWriteInterest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">CancelledKeyException</span> cx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">VirtualMachineError</span> vme<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span></code></pre>
<p>SecureNioChannel#handshake</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">handshake</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> read<span class="token punctuation">,</span> <span class="token keyword">boolean</span> write<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>handshakeComplete<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 初始握手完成</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sniComplete<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 处理SNI，初始化SSLEngine，开始握手，SSLEngine封装了具体的握手细节</span>
            <span class="token keyword">int</span> sniResult <span class="token operator">=</span> <span class="token function">processSNI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sniResult <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 处理成功</span>
                sniComplete <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> sniResult<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 回复响应，如果写没完成</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">flush</span><span class="token punctuation">(</span>netOutBuffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 需要重新关注可读事件</span>
            <span class="token keyword">return</span> SelectionKey<span class="token punctuation">.</span>OP_WRITE<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//we still have data to write</span>
        <span class="token punctuation">}</span>
        SSLEngineResult handshake <span class="token operator">=</span> null<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/*
         * SSLEngine内部封装了SSL的细节实现，应用只需要根据它返回的状态SSLEngineResult.HandShakeStatus执行下一步操作
         * 四个缓冲，ApplicationInBuffer，ApplicationOutBuffer，NetInBuffer，NetOutBuffer
         * wrap，出栈，应用的缓冲通过SSLEngine发到网络的缓冲
         * unwrap，入栈，网络的缓冲通过SSLEngine发到应用的缓冲
         * 简单说就是负责入栈和出栈数据加密和解密以及加密解密算法的协商
         * 在双方成功握手之后，继续使用SSLEngine来发送数据，发送的数据就是加密过的了
         */</span>
        <span class="token comment" spellcheck="true">// 循环处理握手直到完成</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>handshakeComplete<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 握手状态</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>handshakeStatus<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 握手失败</span>
                <span class="token keyword">case</span> NOT_HANDSHAKING<span class="token operator">:</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span>sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"channel.nio.ssl.notHandshaking"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// 握手完成</span>
                <span class="token keyword">case</span> FINISHED<span class="token operator">:</span>
                    <span class="token comment" spellcheck="true">// 服务端可协商的协议</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>endpoint<span class="token punctuation">.</span><span class="token function">hasNegotiableProtocols</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>sslEngine <span class="token keyword">instanceof</span> <span class="token class-name">SSLUtil<span class="token punctuation">.</span>ProtocolInfo</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// 设置最终协商的协议</span>
                            socketWrapper<span class="token punctuation">.</span><span class="token function">setNegotiatedProtocol</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>SSLUtil<span class="token punctuation">.</span>ProtocolInfo<span class="token punctuation">)</span> sslEngine<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getNegotiatedProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>JreCompat<span class="token punctuation">.</span><span class="token function">isJre9Available</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            socketWrapper<span class="token punctuation">.</span><span class="token function">setNegotiatedProtocol</span><span class="token punctuation">(</span>JreCompat<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getApplicationProtocol</span><span class="token punctuation">(</span>sslEngine<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// 如果所有数据都已写完，握手完成</span>
                    handshakeComplete <span class="token operator">=</span> <span class="token operator">!</span>netOutBuffer<span class="token punctuation">.</span><span class="token function">hasRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// 如果已完成握手，返回0，否则还有数据要写</span>
                    <span class="token keyword">return</span> handshakeComplete <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> SelectionKey<span class="token punctuation">.</span>OP_WRITE<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 需要WRAP发送数据</span>
                <span class="token keyword">case</span> NEED_WRAP<span class="token operator">:</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        handshake <span class="token operator">=</span> <span class="token function">handshakeWrap</span><span class="token punctuation">(</span>write<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SSLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        handshake <span class="token operator">=</span> <span class="token function">handshakeWrap</span><span class="token punctuation">(</span>write<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>handshake<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> Status<span class="token punctuation">.</span>OK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>handshakeStatus <span class="token operator">==</span> HandshakeStatus<span class="token punctuation">.</span>NEED_TASK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            handshakeStatus <span class="token operator">=</span> <span class="token function">tasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>handshake<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> Status<span class="token punctuation">.</span>CLOSED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">flush</span><span class="token punctuation">(</span>netOutBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">//wrap should always work with our buffers</span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span>sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"channel.nio.ssl.unexpectedStatusDuringWrap"</span><span class="token punctuation">,</span> handshake<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>handshakeStatus <span class="token operator">!=</span> HandshakeStatus<span class="token punctuation">.</span>NEED_UNWRAP <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">flush</span><span class="token punctuation">(</span>netOutBuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">//should actually return OP_READ if we have NEED_UNWRAP</span>
                        <span class="token keyword">return</span> SelectionKey<span class="token punctuation">.</span>OP_WRITE<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// 需要UNWRAP接收数据</span>
                <span class="token keyword">case</span> NEED_UNWRAP<span class="token operator">:</span>
                    handshake <span class="token operator">=</span> <span class="token function">handshakeUnwrap</span><span class="token punctuation">(</span>read<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>handshake<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> Status<span class="token punctuation">.</span>OK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>handshakeStatus <span class="token operator">==</span> HandshakeStatus<span class="token punctuation">.</span>NEED_TASK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            handshakeStatus <span class="token operator">=</span> <span class="token function">tasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// BUFFER_OVERFLOW：目标缓冲区没有足够的字节空间可以容纳结果</span>
                    <span class="token comment" spellcheck="true">// BUFFER_UNDERFLOW：不能对传入的数据解包，因为没有足够的源字节可以用来生成一个完整的包</span>
                    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>handshake<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> Status<span class="token punctuation">.</span>BUFFER_UNDERFLOW<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">//read more data, reregister for OP_READ</span>
                        <span class="token keyword">return</span> SelectionKey<span class="token punctuation">.</span>OP_READ<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span>sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"channel.nio.ssl.unexpectedStatusDuringWrap"</span><span class="token punctuation">,</span> handshake<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 需要执行一些耗时操作，由SSLEngine委托</span>
                <span class="token keyword">case</span> NEED_TASK<span class="token operator">:</span>
                    handshakeStatus <span class="token operator">=</span> <span class="token function">tasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">default</span><span class="token operator">:</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"channel.nio.ssl.invalidStatus"</span><span class="token punctuation">,</span> handshakeStatus<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 到这里握手已经完成</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>SecureNioChannel#processSNI</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">processSNI</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 从JDK的SocketChannel读取数据到缓冲</span>
        <span class="token keyword">int</span> bytesRead <span class="token operator">=</span> sc<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>netInBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 没读到数据</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bytesRead <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">/*
         * Server Name Indication，SNI
         * TLS握手期间服务器需要发送证书给客户端，但是一个IP和端口可能配置了多个域名，SNI则指定了域名
         * 这里的域名不是HTTP请求头的Host，因为握手时HTTP交互还没开始（握手不是走HTTP协议的）
         */</span>
        <span class="token comment" spellcheck="true">// 这里会从缓冲解析ClientHello包</span>
        TLSClientHelloExtractor extractor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TLSClientHelloExtractor</span><span class="token punctuation">(</span>netInBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 循环解析</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>extractor<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> ExtractorResult<span class="token punctuation">.</span>UNDERFLOW <span class="token operator">&amp;&amp;</span> netInBuffer<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> endpoint<span class="token punctuation">.</span><span class="token function">getSniParseLimit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Extractor提取器需要更多数据去处理但是缓冲已经满了，所以需要扩展缓冲</span>
            <span class="token keyword">int</span> newLimit <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>netInBuffer<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> endpoint<span class="token punctuation">.</span><span class="token function">getSniParseLimit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"channel.nio.ssl.expandNetInBuffer"</span><span class="token punctuation">,</span> Integer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>newLimit<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 扩张</span>
            netInBuffer <span class="token operator">=</span> ByteBufferUtils<span class="token punctuation">.</span><span class="token function">expand</span><span class="token punctuation">(</span>netInBuffer<span class="token punctuation">,</span> newLimit<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 再次从JDK的SocketChannel读取数据到缓冲</span>
            sc<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>netInBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 再次解析</span>
            extractor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TLSClientHelloExtractor</span><span class="token punctuation">(</span>netInBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        String hostName <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 客户端请求的加密套件</span>
        List<span class="token operator">&lt;</span>Cipher<span class="token operator">></span> clientRequestedCiphers <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 客户端请求的应用协议</span>
        List<span class="token operator">&lt;</span>String<span class="token operator">></span> clientRequestedApplicationProtocols <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>extractor<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> COMPLETE<span class="token operator">:</span>
                hostName <span class="token operator">=</span> extractor<span class="token punctuation">.</span><span class="token function">getSNIValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                clientRequestedApplicationProtocols <span class="token operator">=</span> extractor<span class="token punctuation">.</span><span class="token function">getClientRequestedApplicationProtocols</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">//$FALL-THROUGH$ to set the client requested ciphers</span>
            <span class="token keyword">case</span> NOT_PRESENT<span class="token operator">:</span>
                clientRequestedCiphers <span class="token operator">=</span> extractor<span class="token punctuation">.</span><span class="token function">getClientRequestedCiphers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> NEED_READ<span class="token operator">:</span>
                <span class="token keyword">return</span> SelectionKey<span class="token punctuation">.</span>OP_READ<span class="token punctuation">;</span>
            <span class="token keyword">case</span> UNDERFLOW<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// Unable to buffer enough data to read SNI extension data</span>
                <span class="token comment" spellcheck="true">// ...</span>
                hostName <span class="token operator">=</span> endpoint<span class="token punctuation">.</span><span class="token function">getDefaultSSLHostConfigName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                clientRequestedCiphers <span class="token operator">=</span> Collections<span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> NON_SECURE<span class="token operator">:</span>
                netOutBuffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                netOutBuffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>TLSClientHelloExtractor<span class="token punctuation">.</span>USE_TLS_RESPONSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                netOutBuffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">flushOutbound</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span>sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"channel.nio.ssl.foundHttp"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// 根据主机名，加密套件，应用协议创建SSL引擎，SSLEngine内部封装了握手和会话的实现细节</span>
        sslEngine <span class="token operator">=</span> endpoint<span class="token punctuation">.</span><span class="token function">createSSLEngine</span><span class="token punctuation">(</span>hostName<span class="token punctuation">,</span> clientRequestedCiphers<span class="token punctuation">,</span> clientRequestedApplicationProtocols<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 确保之前创建的应用缓冲足够大</span>
        <span class="token function">getBufHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">expand</span><span class="token punctuation">(</span>sslEngine<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getApplicationBufferSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        netInBuffer <span class="token operator">=</span> ByteBufferUtils<span class="token punctuation">.</span><span class="token function">expand</span><span class="token punctuation">(</span>netInBuffer<span class="token punctuation">,</span> sslEngine<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPacketBufferSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        netOutBuffer <span class="token operator">=</span> ByteBufferUtils<span class="token punctuation">.</span><span class="token function">expand</span><span class="token punctuation">(</span>netOutBuffer<span class="token punctuation">,</span> sslEngine<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPacketBufferSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Set limit and position to expected values</span>
        netOutBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        netOutBuffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 初始化握手，OpenSSLEngine#beginHandshake</span>
        sslEngine<span class="token punctuation">.</span><span class="token function">beginHandshake</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 握手状态</span>
        handshakeStatus <span class="token operator">=</span> sslEngine<span class="token punctuation">.</span><span class="token function">getHandshakeStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>总结：</p>
<p>其实JDK已经把细节封装好了。</p>
<p>SSL（Socket Security Layer）和TLS（Transport Layer Security）应该没有太大区别？</p>
<p>HTTPS默认端口443，HTTP默认端口是80。</p>
<ul>
<li><p>SSL/TLS实现了传输的加密，解决了信息被第三方窃听（wiretap）的问题。</p>
</li>
<li><p>SSL/TLS实现了数据的签名及校验，解决了数据被第三方篡改（tampering）的问题。</p>
</li>
<li><p>SSL/TLS实现了数字证书认证机制，解决了身份被第三方冒充（pretending）的问题。</p>
</li>
</ul>
<p>SSL/TLS握手协商的信息：</p>
<ul>
<li><p>协议版本号；</p>
</li>
<li><p>加密算法，包括非对称加密算法、动态密钥算法；</p>
</li>
<li><p>数字证书，传输双方通过交换证书及签名校验对彼此鉴权；</p>
</li>
<li><p>动态密钥，传输数据使用该密钥进行对称加解密，该密钥通过非对称密钥进行加密传输。</p>
</li>
</ul>
<p>建议用Wireshark抓包，傻瓜式操作。</p>
<p>对SSL/TLS和对称/非对称加密感兴趣的可以看看我去年的一篇笔记（中间人）。</p>
<p>附送一张握手图：</p>
<p><img src="/imgs/SSL_handshake.png" alt="SSL握手"></p>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


        <footer>
             
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

        </footer>
    </div>
    <!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
    <script>
        var timeEnd = new Date();
        console.log('耗时：' + (timeEnd - timeStart));
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre').forEach((block) => {
                block.classList.add("line-numbers");
            });
        });
    </script>

    <script src="/js/prism.js"></script>
</body>
</html>
