<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
        <script>
            var timeStart = new Date();
        </script>
        
        <title>[笔记]-Tomcat-HTTP | 🌑🌒🌓🌔🌕🌖🌗🌘</title>
        
        <meta name="author" content="huangzhike">
        
        
        <meta name="description" content="先简单科普一下。
HTTP/1.1：现在最常用的版本，默认开启Connection：keep-alive，支持长连接（PersistentConnection），可以复用TCP连接，不用每次都重新握手，支持管道（Pipelining），排队串行处理，前面的请求阻塞没返回时，后面的请求也会阻塞，即线头">
        
        
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        
        <meta property="og:title" content="[笔记]-Tomcat-HTTP"/>
        
        <meta property="og:site_name" content="🌑🌒🌓🌔🌕🌖🌗🌘"/>
        
        
        <!-- favicon -->
        <link rel="icon" type="image/ico" href="/ok.ico" sizes="32x32">
        <meta name="msapplication-TileColor" content="#009688">
        <meta name="msapplication-TileImage" content="/mstile-144x144.ico">
        <meta name="theme-color" content="#009688">
        <!-- favicon end -->
        <!-- <link href="//ok.ico" rel="icon"> -->
        
        <!-- toc -->
        <!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
        <!-- material design -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
        <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
        
        <!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
        <!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
    <meta name="generator" content="Hexo 4.2.1"></head>

<body>
    <nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">菜单</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" title="下一句是：客有可人期不来。小时候，喜欢靠在阳台上，一边吹风，一边看书，喜欢读书吗，骚年？" href="/">书当快意读易尽</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" target="_blank" rel="noopener" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

    <div class="container" >
        <div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[笔记]-Tomcat-HTTP</h2>
				
				<div>
					<div class="post-time">2019-09-15</div>
				</div>
				
				<div class="article-content">
				<p>先简单科普一下。</p>
<p>HTTP/1.1：现在最常用的版本，默认开启Connection：keep-alive，支持长连接（PersistentConnection），可以复用TCP连接，不用每次都重新握手，支持管道（Pipelining），排队串行处理，前面的请求阻塞没返回时，后面的请求也会阻塞，即线头阻塞（Head-of-line blocking，HOL）。</p>
<p>HTTP/2.0：多路复用（Multiplexing），不会有阻塞的问题，还有一个流，我也没怎么了解😬。</p>
<hr>
<p>NioEndpoint$SocketProcessor#doRun</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doRun</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            NioChannel socket <span class="token operator">=</span> socketWrapper<span class="token punctuation">.</span><span class="token function">getSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 获取Socket注册到Selector的SelectionKey</span>
            SelectionKey key <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">getIOChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">keyFor</span><span class="token punctuation">(</span>socket<span class="token punctuation">.</span><span class="token function">getSocketWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPoller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Poller poller <span class="token operator">=</span> NioEndpoint<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>poller<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>poller <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                socketWrapper<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> handshake <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// NioChannel默认握手完成，SecureNioChannel需要TLS握手</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>socket<span class="token punctuation">.</span><span class="token function">isHandshakeComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            handshake <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment" spellcheck="true">// 当做握手失败</span>
                        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token operator">==</span> SocketEvent<span class="token punctuation">.</span>STOP <span class="token operator">||</span> event <span class="token operator">==</span> SocketEvent<span class="token punctuation">.</span>DISCONNECT <span class="token operator">||</span> event <span class="token operator">==</span> SocketEvent<span class="token punctuation">.</span>ERROR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            handshake <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment" spellcheck="true">// 握手没完成</span>
                        <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// 执行握手，可读可写</span>
                            handshake <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">handshake</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">isReadable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">.</span><span class="token function">isWritable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// 握手完成时必须为SocketEvent.OPEN_READ</span>
                            <span class="token comment" spellcheck="true">// 因为只在握手完成时使用，这里设置也是可以的</span>
                            event <span class="token operator">=</span> SocketEvent<span class="token punctuation">.</span>OPEN_READ<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">CancelledKeyException</span> ckx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 握手完成</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>handshake <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// Socket打开状态</span>
                    SocketState state <span class="token operator">=</span> SocketState<span class="token punctuation">.</span>OPEN<span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// 默认处理请求</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ConnectionHandler，一个Endpoint关联一个Handler，存放了Socket和Processor的关联</span>
                        <span class="token comment" spellcheck="true">// Socket打开并且可读状态</span>
                        state <span class="token operator">=</span> <span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>socketWrapper<span class="token punctuation">,</span> SocketEvent<span class="token punctuation">.</span>OPEN_READ<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// 处理指定事件</span>
                    <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        state <span class="token operator">=</span> <span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>socketWrapper<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// 关闭Socket</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 取消之前关心的事件，并关闭Socket</span>
                        poller<span class="token punctuation">.</span><span class="token function">cancelledKey</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> socketWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 握手失败</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>handshake <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>socketWrapper<span class="token punctuation">,</span> SocketEvent<span class="token punctuation">.</span>CONNECT_FAIL<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    poller<span class="token punctuation">.</span><span class="token function">cancelledKey</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> socketWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 握手时没读完，重新关注可读事件</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>handshake <span class="token operator">==</span> SelectionKey<span class="token punctuation">.</span>OP_READ<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    socketWrapper<span class="token punctuation">.</span><span class="token function">registerReadInterest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 握手时没写完，重新关注可写事件</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>handshake <span class="token operator">==</span> SelectionKey<span class="token punctuation">.</span>OP_WRITE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    socketWrapper<span class="token punctuation">.</span><span class="token function">registerWriteInterest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">CancelledKeyException</span> cx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">VirtualMachineError</span> vme<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 将SocketProcessor的SocketWrapper置空</span>
                socketWrapper <span class="token operator">=</span> null<span class="token punctuation">;</span>
                event <span class="token operator">=</span> null<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 最后将SocketProcessor放回对象池</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>running <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>paused <span class="token operator">&amp;&amp;</span> processorCache <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    processorCache<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 注意这个SocketProcessor和Http11Processor等Processor不是一个概念</span>
                <span class="token comment" spellcheck="true">// SocketProcessor用来包装Runnable任务，运行完回收</span>
                <span class="token comment" spellcheck="true">// Http11Processor等是关联Socket的，处理Socket的一个请求</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span></code></pre>
<p>AbstractProtocol$ConnectionHandler#process</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> SocketState <span class="token function">process</span><span class="token punctuation">(</span>SocketWrapperBase<span class="token operator">&lt;</span>S<span class="token operator">></span> wrapper<span class="token punctuation">,</span> SocketEvent status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>wrapper <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Nothing to do. Socket has been closed.</span>
                <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            S socket <span class="token operator">=</span> wrapper<span class="token punctuation">.</span><span class="token function">getSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// Socket关联一个Processor，Socket的一次请求没结束，比如数据分多次收到，触发了多次可读事件，都是同一个Processor处理</span>
            Processor processor <span class="token operator">=</span> connections<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// Timeouts are calculated on a dedicated thread and then dispatched.</span>
            <span class="token comment" spellcheck="true">// Because of delays in the dispatch process, the timeout may no longer be required.</span>
            <span class="token comment" spellcheck="true">// Check here and avoid unnecessary processing.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>SocketEvent<span class="token punctuation">.</span>TIMEOUT <span class="token operator">==</span> status <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>processor <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token operator">!</span>processor<span class="token punctuation">.</span><span class="token function">isAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>processor<span class="token punctuation">.</span><span class="token function">isUpgrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> processor<span class="token punctuation">.</span><span class="token function">isAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>processor<span class="token punctuation">.</span><span class="token function">checkAsyncTimeoutGeneration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// This is effectively a NO-OP</span>
                <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>OPEN<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>processor <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 确保不触发异步超时</span>
                <span class="token function">getProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeWaitingProcessor</span><span class="token punctuation">(</span>processor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> SocketEvent<span class="token punctuation">.</span>DISCONNECT <span class="token operator">||</span> status <span class="token operator">==</span> SocketEvent<span class="token punctuation">.</span>ERROR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 直接关闭</span>
                <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 设置ThreadLocal标志，用于判断异步状态</span>
            ContainerThreadMarker<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 第一次，没有关联</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>processor <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>processor <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 从回收的对象池拿</span>
                    processor <span class="token operator">=</span> recycledProcessors<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 还没有，可能是对象池用完了</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>processor <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 创建Processor，Http11Processor或AjpProcessor</span>
                    processor <span class="token operator">=</span> <span class="token function">getProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// JMX，忽略</span>
                    <span class="token function">register</span><span class="token punctuation">(</span>processor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 是否支持SSL</span>
                processor<span class="token punctuation">.</span><span class="token function">setSslSupport</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span><span class="token function">getSslSupport</span><span class="token punctuation">(</span><span class="token function">getProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClientCertProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 关联Socket和Processor</span>
                connections<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span> processor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                SocketState state <span class="token operator">=</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 循环处理直到完成协议升级</span>
                <span class="token keyword">do</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 处理HTTP/HTTPS/WS/WSS</span>
                    state <span class="token operator">=</span> processor<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>UPGRADING<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 升级协议阶段</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>UPGRADING<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment" spellcheck="true">// 等待，处理半包（没有读完）</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>LONG<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 如果不是异步请求，重新注册可读事件</span>
                    <span class="token function">longPoll</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">,</span> processor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// 如果是异步请求</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>processor<span class="token punctuation">.</span><span class="token function">isAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 等待，Socket关联的Processor不能移除，所以AsyncContext完成后还可以使用</span>
                        <span class="token function">getProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addWaitingProcessor</span><span class="token punctuation">(</span>processor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 保持Socket打开，一般是一个KeepAlive的HTTP请求处理完后的状态</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>OPEN<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 移除Socket关联的Processor</span>
                    connections<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">release</span><span class="token punctuation">(</span>processor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// 重新注册可读事件</span>
                    wrapper<span class="token punctuation">.</span><span class="token function">registerReadInterest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>SENDFILE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 已完成协议升级</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>UPGRADED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 在有非阻塞写的情况下，不能将Socket添加回Poller，否则Poller可能会触发多读事件，导致Connector内的线程饥饿</span>
                    <span class="token comment" spellcheck="true">// The write() method will add this socket to the poller if necessary.</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">!=</span> SocketEvent<span class="token punctuation">.</span>OPEN_WRITE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 如果不是异步请求，将Socket添加回Poller，重新注册可读事件</span>
                        <span class="token function">longPoll</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">,</span> processor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// 添加入超时等待</span>
                        <span class="token function">getProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addWaitingProcessor</span><span class="token punctuation">(</span>processor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>SUSPENDED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 不能将Socket添加回Poller</span>
                    <span class="token comment" spellcheck="true">// The resumeProcessing() method will add this socket to the poller.</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 需要关闭连接，可以回收Processor，UpgradeProcessor不会回收</span>
                    connections<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// UpgradeProcessor</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>processor<span class="token punctuation">.</span><span class="token function">isUpgrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// 其它直接回收</span>
                    <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token function">release</span><span class="token punctuation">(</span>processor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 返回状态，做对应处理</span>
                <span class="token keyword">return</span> state<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span>SocketException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ProtocolException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">OutOfMemoryError</span> oome<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                ContainerThreadMarker<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 确保有异常的情况下，最后要移除Socket和Processor的关联</span>
            connections<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 释放重置Processor</span>
            <span class="token function">release</span><span class="token punctuation">(</span>processor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 关闭连接</span>
            <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>AbstractProcessorLight#process</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> SocketState <span class="token function">process</span><span class="token punctuation">(</span>SocketWrapperBase<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> socketWrapper<span class="token punctuation">,</span> SocketEvent status<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 默认处理结果</span>
        SocketState state <span class="token operator">=</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 异步Servlet的Listener非阻塞读写，在ServletInputStream#setReadListener或ServletInputStream#setWriteListener时添加</span>
        Iterator<span class="token operator">&lt;</span>DispatchType<span class="token operator">></span> dispatches <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>dispatches <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                DispatchType nextDispatch <span class="token operator">=</span> dispatches<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 分发处理SocketEvent.OPEN_READ或SocketEvent.OPEN_WRITE</span>
                state <span class="token operator">=</span> <span class="token function">dispatch</span><span class="token punctuation">(</span>nextDispatch<span class="token punctuation">.</span><span class="token function">getSocketStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> SocketEvent<span class="token punctuation">.</span>DISCONNECT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Do nothing here, just wait for it to get recycled</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span><span class="token comment" spellcheck="true">/*已升级WebSocket/HTTP/2.0*/</span> <span class="token function">isUpgrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>ASYNC_END<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 以WebSocket为例，这里是调用UpgradeProcessorInternal#dispatch -> WsHttpUpgradeHandler#upgradeDispatch</span>
                state <span class="token operator">=</span> <span class="token function">dispatch</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// WebSocket升级完成后，每次收到消息返回的状态都是SocketState.UPGRADED</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>OPEN<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 可能这个Socket还有Pipeline排队的数据，如果现在不处理数据，会退出当前循环并调用释放回收Processor和缓冲，这样会删除所有的Pipeline排队的数据</span>
                    <span class="token comment" spellcheck="true">// 为了避免这种情况，现在处理它</span>
                    state <span class="token operator">=</span> <span class="token function">service</span><span class="token punctuation">(</span>socketWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> SocketEvent<span class="token punctuation">.</span>OPEN_WRITE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Extra write event likely after async, ignore</span>
                state <span class="token operator">=</span> SocketState<span class="token punctuation">.</span>LONG<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 一般的HTTP请求</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> SocketEvent<span class="token punctuation">.</span>OPEN_READ<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                state <span class="token operator">=</span> <span class="token function">service</span><span class="token punctuation">(</span>socketWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> SocketEvent<span class="token punctuation">.</span>CONNECT_FAIL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">logAccess</span><span class="token punctuation">(</span>socketWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Fallback</span>
                state <span class="token operator">=</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">!=</span> SocketState<span class="token punctuation">.</span>CLOSED <span class="token operator">&amp;&amp;</span> <span class="token function">isAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                state <span class="token operator">=</span> <span class="token function">asyncPostProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>dispatches <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token operator">!</span>dispatches<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Only returns non-null iterator if there are dispatches to process.</span>
                dispatches <span class="token operator">=</span> <span class="token function">getIteratorAndClearDispatches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>ASYNC_END <span class="token operator">||</span> dispatches <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> state <span class="token operator">!=</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<ul>
<li><p>org.apache.coyote.http2.StreamProcessor：处理HTTP/2.0协议。</p>
</li>
<li><p>org.apache.coyote.http11.Http11Processor：处理HTTP/1.1协议，或者别的低版本的。</p>
</li>
<li><p>org.apache.coyote.ajp.AjpProcessor：处理AJP协议。</p>
</li>
</ul>
<p>还有一些处理器如org.apache.coyote.http11.upgrade.UpgradeProcessorInternal处理别的升级的协议，比如WebSocket。</p>
<p>Http11Processor#service</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> SocketState <span class="token function">service</span><span class="token punctuation">(</span>SocketWrapperBase<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> socketWrapper<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 一个Processor一个Request，可复用</span>
        RequestInfo rp <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getRequestProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// 一个Processor一个InputBuffer和一个OutputBuffer，并为这个SocketWrapperBase关联读写缓冲</span>
        <span class="token function">setSocketWrapper</span><span class="token punctuation">(</span>socketWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 默认Flags</span>
        keepAlive <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        openSocket <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        readComplete <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> keptAlive <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        SendfileState sendfileState <span class="token operator">=</span> SendfileState<span class="token punctuation">.</span>DONE<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/*
         * Tomcat的NIO和Netty的Reactor模型不一样
         * HTTP/1.1，一个请求读完，处理响应，再继续读下一个请求，这是阻塞的
         * 如果想在HTTP/1.1协议上实现RPC连接复用，显然性能是不高的，因为HTTP/2.0非阻塞，所以猜测应该可以提高RPC性能？
         */</span>

        <span class="token comment" spellcheck="true">// 一直解析，循环处理一个连接的多个HTTP请求</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getErrorState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 没有错误</span>
                <span class="token operator">&amp;&amp;</span> keepAlive <span class="token comment" spellcheck="true">// 保持连接</span>
                <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 非异步</span>
                <span class="token operator">&amp;&amp;</span> upgradeToken <span class="token operator">==</span> null <span class="token comment" spellcheck="true">// 没有UpgradeToken</span>
                <span class="token operator">&amp;&amp;</span> sendfileState <span class="token operator">==</span> SendfileState<span class="token punctuation">.</span>DONE <span class="token comment" spellcheck="true">// 发送文件完成</span>
                <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>protocol<span class="token punctuation">.</span><span class="token function">isPaused</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 没被暂停</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">/*
             * HTTP协议格式
             * RequestLine 请求行 GET /xxx?callback=xxx&amp;xxx= HTTP/1.1
             * Headers 请求头 Host: www.baidu.com...
             * 空行
             * Body 请求体
             */</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>

                <span class="token comment" spellcheck="true">// 从InputBuffer缓冲解析请求行，如果没有读到完整的请求行</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inputBuffer<span class="token punctuation">.</span><span class="token function">parseRequestLine</span><span class="token punctuation">(</span>keptAlive<span class="token punctuation">,</span> protocol<span class="token punctuation">.</span><span class="token function">getConnectionTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> protocol<span class="token punctuation">.</span><span class="token function">getKeepAliveTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 表示要升级HTTP/2.0协议，"PRI * HTTP/2.0\r\n\r\nSM\r\n\r\n"</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>inputBuffer<span class="token punctuation">.</span><span class="token function">getParsingRequestLinePhase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>UPGRADING<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">/*
                     * 设置openSocket=true，保持Socket打开
                     *   如果已经开始读了请求行，设置readComplete=false，跳出循环后，返回SocketState.LONG，重新注册可读事件，一般是收到的数据不够
                     *   如果没读到数据，跳出循环后，返回SocketState.OPEN，重新注册可读事件，一般是处理完了所有请求，在这里退出循环
                     */</span>
                    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">handleIncompleteRequestLineRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 跳出循环</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>protocol<span class="token punctuation">.</span><span class="token function">isPaused</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 503...</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    keptAlive <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// 每次都设置，避免通过JMX被改变</span>
                    <span class="token comment" spellcheck="true">// 设置请求头的最大数量</span>
                    request<span class="token punctuation">.</span><span class="token function">getMimeHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setLimit</span><span class="token punctuation">(</span>protocol<span class="token punctuation">.</span><span class="token function">getMaxHeaderCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// 从缓冲解析请求头，如果没有读到完整的请求头</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inputBuffer<span class="token punctuation">.</span><span class="token function">parseHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 已经读了一部分请求，不要回收，应该将它关联Socket</span>
                        openSocket <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                        readComplete <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// 跳出循环后，返回SocketState.LONG，重新注册可读事件</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>protocol<span class="token punctuation">.</span><span class="token function">getDisableUploadTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        socketWrapper<span class="token punctuation">.</span><span class="token function">setReadTimeout</span><span class="token punctuation">(</span>protocol<span class="token punctuation">.</span><span class="token function">getConnectionUploadTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 400...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 略过升级HTTP/2.0</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getErrorState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isIoAllowed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 准备请求，根据请求行的协议版本和请求头的信息做一些配置</span>
                    <span class="token comment" spellcheck="true">// 根据请求头的transfer-encoding和content-length等确定InputFilter</span>
                    <span class="token comment" spellcheck="true">// InputFilter用于解析请求体，解析时机是第一次调用ServletRequest#getParameter或ServletRequest#getInputStream</span>
                    <span class="token function">prepareRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 500...</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 一个TCP连接允许的最大keepAlive请求数，默认100</span>
            <span class="token keyword">int</span> maxKeepAliveRequests <span class="token operator">=</span> protocol<span class="token punctuation">.</span><span class="token function">getMaxKeepAliveRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 只允许一个</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>maxKeepAliveRequests <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 那就没什么keepAlive了</span>
                keepAlive <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 这个TCP连接允许的请求数--，当用完允许的请求数之后</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>maxKeepAliveRequests <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> socketWrapper<span class="token punctuation">.</span><span class="token function">decrementKeepAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 关闭keepAlive</span>
                keepAlive <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// Process the request in the adapter</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getErrorState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isIoAllowed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token comment" spellcheck="true">// 处理解析好的请求，最后调用Servlet处理</span>
                    <span class="token function">getAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedIOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">HeadersTooLargeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 500...</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 500...</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// Finish the handling of the request</span>
            rp<span class="token punctuation">.</span><span class="token function">setStage</span><span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>coyote<span class="token punctuation">.</span>Constants<span class="token punctuation">.</span>STAGE_ENDINPUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 如果是不异步状态</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 直接结束请求，结束输入输出缓冲并提交（如果是异步请求，则完成时请求才结束，由AsyncContext调用endRequest）</span>
                <span class="token function">endRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// 非异步 || 有异常</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">getErrorState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 更新计数</span>
                request<span class="token punctuation">.</span><span class="token function">updateCounters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getErrorState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isIoAllowed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 重置回收</span>
                    inputBuffer<span class="token punctuation">.</span><span class="token function">nextRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    outputBuffer<span class="token punctuation">.</span><span class="token function">nextRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>protocol<span class="token punctuation">.</span><span class="token function">getDisableUploadTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// 文件传输，默认SendfileState.DONE，设置openSocket = keepAlive</span>
            <span class="token comment" spellcheck="true">// 所以一般请求结束后Socket还是打开的</span>
            sendfileState <span class="token operator">=</span> <span class="token function">processSendfile</span><span class="token punctuation">(</span>socketWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 已跳出while循环</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// 有异常 || 暂停</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getErrorState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> protocol<span class="token punctuation">.</span><span class="token function">isPaused</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 需要关闭</span>
            <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 异步状态</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>LONG<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 存在UpgradeToken</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUpgrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 正在升级协议</span>
            <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>UPGRADING<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 其它</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 文件传输中</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sendfileState <span class="token operator">==</span> SendfileState<span class="token punctuation">.</span>PENDING<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>SENDFILE<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 其它请求</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 保持Socket打开</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>openSocket<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 请求头读完</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>readComplete<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 表示需要保持连接打开，重新注册可读事件，接受下一个请求</span>
                        <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>OPEN<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// 还有数据没收到</span>
                    <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 需要等待，重新注册可读事件</span>
                        <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>LONG<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 需要关闭</span>
                    <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p><img src="/imgs/HTTP_protocol.png" alt="HTTP协议"></p>
<p>Http11InputBuffer#parseRequestLine</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">boolean</span> <span class="token function">parseRequestLine</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> keptAlive<span class="token punctuation">,</span> <span class="token keyword">int</span> connectionTimeout<span class="token punctuation">,</span> <span class="token keyword">int</span> keepAliveTimeout<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 检查状态</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>parsingRequestLine<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 假如请求行前面还有换行或回车，跳过空行</span>
        <span class="token comment" spellcheck="true">// parsingRequestLinePhase代表读取RequestLine到哪个阶段，初始为0，这时byteBuffer为空，position == limit = 0</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parsingRequestLinePhase <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">byte</span> chr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">do</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 如果需要，读取新的字节，position == limit，表示已读到尽头</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>keptAlive<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 还没读到任何请求数据，所以使用keepAliveTimeout</span>
                        wrapper<span class="token punctuation">.</span><span class="token function">setReadTimeout</span><span class="token punctuation">(</span>keepAliveTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// 执行fill重新填充数据，false代表非阻塞读，先从Socket关联的缓冲读取，再从系统读</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 读不到数据，parsingRequestLinePhase不再处于初始的状态</span>
                        parsingRequestLinePhase <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// 至少收到了一个字节，所以使用connectionTimeout</span>
                    wrapper<span class="token punctuation">.</span><span class="token function">setReadTimeout</span><span class="token punctuation">(</span>connectionTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 非keptAlive &amp;&amp; 还没读 &amp;&amp; 收到足够长的请求头"PRI * HTTP/2.0\r\n\r\nSM\r\n\r\n"</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>keptAlive <span class="token operator">&amp;&amp;</span> byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> byteBuffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> CLIENT_PREFACE_START<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">boolean</span> prefaceMatch <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// 请求行匹配"PRI * HTTP/2.0\r\n\r\nSM\r\n\r\n"</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> CLIENT_PREFACE_START<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> prefaceMatch<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>CLIENT_PREFACE_START<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            prefaceMatch <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>prefaceMatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 需要升级HTTP/2.0</span>
                        parsingRequestLinePhase <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 一旦开始读取数据，就设置开始时间，即使是跳过空行</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getStartTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    request<span class="token punctuation">.</span><span class="token function">setStartTime</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 获取下一个字节</span>
                chr <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>
                <span class="token comment" spellcheck="true">// Carriage Return 回车 \r</span>
                    <span class="token punctuation">(</span>chr <span class="token operator">==</span> Constants<span class="token punctuation">.</span>CR<span class="token punctuation">)</span> <span class="token operator">||</span>
                            <span class="token comment" spellcheck="true">// Linefeed 换行 \n</span>
                            <span class="token punctuation">(</span>chr <span class="token operator">==</span> Constants<span class="token punctuation">.</span>LF<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 现在已经确保请求行前已经没有换行或回车了</span>
            byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 定位请求头开始位置</span>
            parsingRequestLineStart <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 标记可以正式开始读请求行数据</span>
            parsingRequestLinePhase <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 读取请求方法名称，GET POST</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parsingRequestLinePhase <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">boolean</span> space <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 直到读到第一个空格</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>space<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 如果需要，填充新的字节</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// request line parsing</span>
                        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">int</span> pos <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 获取字节</span>
                <span class="token keyword">byte</span> chr <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// Space 空格 || Horizontal Tab \t</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>chr <span class="token operator">==</span> Constants<span class="token punctuation">.</span>SP <span class="token operator">||</span> chr <span class="token operator">==</span> Constants<span class="token punctuation">.</span>HT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    space <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// 请求方法长度确定，设置请求方法</span>
                    request<span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setBytes</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> parsingRequestLineStart<span class="token punctuation">,</span> pos <span class="token operator">-</span> parsingRequestLineStart<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>HttpParser<span class="token punctuation">.</span><span class="token function">isToken</span><span class="token punctuation">(</span>chr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 可以继续读取</span>
            parsingRequestLinePhase <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 读取空格</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parsingRequestLinePhase <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Spec says single SP but also be tolerant of multiple SP and/or HT</span>
            <span class="token keyword">boolean</span> space <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 直到读到第一个不是空格</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>space<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 如果需要，读取新的字节</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// request line parsing</span>
                        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 获取字符</span>
                <span class="token keyword">byte</span> chr <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 不是 Space 空格 || Horizontal Tab \t</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>chr <span class="token operator">==</span> Constants<span class="token punctuation">.</span>SP <span class="token operator">||</span> chr <span class="token operator">==</span> Constants<span class="token punctuation">.</span>HT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    space <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            parsingRequestLineStart <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 已跳过请求方法和URI之间的空格，下一步读取URI</span>
            parsingRequestLinePhase <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 读取URI</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parsingRequestLinePhase <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Mark the current buffer position</span>
            <span class="token keyword">int</span> end <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> space <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 直到读到第一个空格</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>space<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Read new bytes if needed</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// request line parsing</span>
                        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">int</span> pos <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">byte</span> chr <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>chr <span class="token operator">==</span> Constants<span class="token punctuation">.</span>SP <span class="token operator">||</span> chr <span class="token operator">==</span> Constants<span class="token punctuation">.</span>HT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    space <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    end <span class="token operator">=</span> pos<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>chr <span class="token operator">==</span> Constants<span class="token punctuation">.</span>CR <span class="token operator">||</span> chr <span class="token operator">==</span> Constants<span class="token punctuation">.</span>LF<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// HTTP/0.9 style request</span>
                    parsingRequestLineEol <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    space <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    end <span class="token operator">=</span> pos<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 包含?，即有查询参数QueryString</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>chr <span class="token operator">==</span> Constants<span class="token punctuation">.</span>QUESTION <span class="token operator">&amp;&amp;</span> parsingRequestLineQPos <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 设置查询参数的开始位置</span>
                    parsingRequestLineQPos <span class="token operator">=</span> pos<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>parsingRequestLineQPos <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>httpParser<span class="token punctuation">.</span><span class="token function">isQueryRelaxed</span><span class="token punctuation">(</span>chr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>httpParser<span class="token punctuation">.</span><span class="token function">isNotRequestTargetRelaxed</span><span class="token punctuation">(</span>chr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 有查询参数</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>parsingRequestLineQPos <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 设置查询参数</span>
                request<span class="token punctuation">.</span><span class="token function">queryString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setBytes</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> parsingRequestLineQPos <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> end <span class="token operator">-</span> parsingRequestLineQPos <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 设置URI</span>
                request<span class="token punctuation">.</span><span class="token function">requestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setBytes</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> parsingRequestLineStart<span class="token punctuation">,</span> parsingRequestLineQPos <span class="token operator">-</span> parsingRequestLineStart<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 没有查询参数</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 设置URI</span>
                request<span class="token punctuation">.</span><span class="token function">requestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setBytes</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> parsingRequestLineStart<span class="token punctuation">,</span> end <span class="token operator">-</span> parsingRequestLineStart<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 可以继续解析协议版本</span>
            parsingRequestLinePhase <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 跳过空格</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parsingRequestLinePhase <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Spec says single SP but also be tolerant of multiple and/or HT</span>
            <span class="token keyword">boolean</span> space <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>space<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Read new bytes if needed</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// request line parsing</span>
                        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">byte</span> chr <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>chr <span class="token operator">==</span> Constants<span class="token punctuation">.</span>SP <span class="token operator">||</span> chr <span class="token operator">==</span> Constants<span class="token punctuation">.</span>HT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    space <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            parsingRequestLineStart <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            parsingRequestLinePhase <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// Mark the current buffer position</span>
            end <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 解析协议版本，格式：HTTP/X.X</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parsingRequestLinePhase <span class="token operator">==</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>parsingRequestLineEol<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Read new bytes if needed</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// request line parsing</span>
                        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">int</span> pos <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">byte</span> chr <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 回车符CR</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>chr <span class="token operator">==</span> Constants<span class="token punctuation">.</span>CR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 标记协议版本读取结束</span>
                    end <span class="token operator">=</span> pos<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 换行符LF</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>chr <span class="token operator">==</span> Constants<span class="token punctuation">.</span>LF<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>end <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        end <span class="token operator">=</span> pos<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// 跳出</span>
                    parsingRequestLineEol <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>HttpParser<span class="token punctuation">.</span><span class="token function">isHttpProtocol</span><span class="token punctuation">(</span>chr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"iib.invalidHttpProtocol"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>end <span class="token operator">-</span> parsingRequestLineStart<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 设置协议版本</span>
                request<span class="token punctuation">.</span><span class="token function">protocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setBytes</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> parsingRequestLineStart<span class="token punctuation">,</span> end <span class="token operator">-</span> parsingRequestLineStart<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                request<span class="token punctuation">.</span><span class="token function">protocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 解析字节这里都没有反序列化，解析请求行请求头请求体，字节都是需要时才编码的</span>
            parsingRequestLine <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            parsingRequestLinePhase <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            parsingRequestLineEol <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            parsingRequestLineStart <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Invalid request line parse phase:"</span> <span class="token operator">+</span> parsingRequestLinePhase<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>Http11InputBuffer#fill</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">fill</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> block<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parsingHeader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> headerBufferSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>parsingRequestLine<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// Avoid unknown protocol triggering an additional error</span>
                    request<span class="token punctuation">.</span><span class="token function">protocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span>Constants<span class="token punctuation">.</span>HTTP_11<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"iib.requestheadertoolarge.error"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            byteBuffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>end<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span>end<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        byteBuffer<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> byteBuffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        byteBuffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        SocketWrapperBase<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> socketWrapper <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>wrapper<span class="token punctuation">;</span>
        <span class="token keyword">int</span> nRead <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>socketWrapper <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 读取</span>
            nRead <span class="token operator">=</span> socketWrapper<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>block<span class="token punctuation">,</span> byteBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CloseNowException</span><span class="token punctuation">(</span>sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"iib.eof.error"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        byteBuffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nRead <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>nRead <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">EOFException</span><span class="token punctuation">(</span>sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"iib.eof.error"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span></code></pre>
<p>NioEndpoint$NioSocketWrapper#read</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> block<span class="token punctuation">,</span> ByteBuffer to<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 如果有未读Buffer，先读取SocketBufferHandler的读缓冲到Processor的缓冲ByteBuffer</span>
            <span class="token keyword">int</span> nRead <span class="token operator">=</span> <span class="token function">populateReadBuffer</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>nRead <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 读成功，直接返回</span>
                <span class="token keyword">return</span> nRead<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// SocketBufferHandler的读缓冲已读完，准备从SocketChannel读</span>
            <span class="token comment" spellcheck="true">// The socket read buffer capacity is socket.appReadBufSize</span>
            <span class="token keyword">int</span> limit <span class="token operator">=</span> socketBufferHandler<span class="token punctuation">.</span><span class="token function">getReadBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 缓冲剩余部分大于限制，容量足够</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>to<span class="token punctuation">.</span><span class="token function">remaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> limit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 设置该次读取的最大值</span>
                to<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>to<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> limit<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 直接从SocketChannel读到Processor的缓冲ByteBuffer</span>
                nRead <span class="token operator">=</span> <span class="token function">fillReadBuffer</span><span class="token punctuation">(</span>block<span class="token punctuation">,</span> to<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 更新上次读取时间</span>
                <span class="token function">updateLastRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 先把数据读到SocketBufferHandler的读缓冲</span>
                nRead <span class="token operator">=</span> <span class="token function">fillReadBuffer</span><span class="token punctuation">(</span>block<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 更新上次读取时间</span>
                <span class="token function">updateLastRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 再读取SocketBufferHandler的读缓冲到Processor的缓冲ByteBuffer</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>nRead <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    nRead <span class="token operator">=</span> <span class="token function">populateReadBuffer</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> nRead<span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>SocketWrapperBase#populateReadBuffer</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">protected</span> <span class="token keyword">int</span> <span class="token function">populateReadBuffer</span><span class="token punctuation">(</span>ByteBuffer to<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Is there enough data in the read buffer to satisfy this request?</span>
        <span class="token comment" spellcheck="true">// Copy what data there is in the read buffer to the byte array</span>
        socketBufferHandler<span class="token punctuation">.</span><span class="token function">configureReadBufferForRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> nRead <span class="token operator">=</span> <span class="token function">transfer</span><span class="token punctuation">(</span>socketBufferHandler<span class="token punctuation">.</span><span class="token function">getReadBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> to<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> nRead<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>NioEndpoint$NioSocketWrapper#fillReadBuffer</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">fillReadBuffer</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> block<span class="token punctuation">,</span> ByteBuffer to<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
            <span class="token keyword">int</span> nRead<span class="token punctuation">;</span>
            NioChannel socket <span class="token operator">=</span> <span class="token function">getSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>socket <span class="token keyword">instanceof</span> <span class="token class-name">ClosedNioChannel</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ClosedChannelException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>block<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Selector selector <span class="token operator">=</span> null<span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    selector <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// Ignore</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    nRead <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> socket<span class="token punctuation">,</span> selector<span class="token punctuation">,</span> <span class="token function">getReadTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>selector <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        pool<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                nRead <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>nRead <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">EOFException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> nRead<span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>NioEndpoint$NioSocketWrapper#fillReadBuffer</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">fillReadBuffer</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> block<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
            socketBufferHandler<span class="token punctuation">.</span><span class="token function">configureReadBufferForWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">fillReadBuffer</span><span class="token punctuation">(</span>block<span class="token punctuation">,</span> socketBufferHandler<span class="token punctuation">.</span><span class="token function">getReadBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>注意这里的Selector是来自NioEndpoint绑定时初始化的SelectorPool，但是默认是共享的，也就是只有一个。</p>
<p>详细可以参考另一篇Response，写和读原理是一样的。</p>
<p>处理WebSocket也是类似。</p>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


        <footer>
             
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

        </footer>
    </div>
    <!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
    <script>
        var timeEnd = new Date();
        console.log('耗时：' + (timeEnd - timeStart));
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre').forEach((block) => {
                block.classList.add("line-numbers");
            });
        });
    </script>
    <!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
    <!-- material design -->
    <!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
    <!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
    <!-- toc -->
    <!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
    <!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
    <!-- <script src="/js/main.js"></script> -->
    <script src="/js/prism.js"></script>
</body>
</html>
