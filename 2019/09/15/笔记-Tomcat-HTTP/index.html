<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
        <script>
            var timeStart = new Date();
        </script>
        
        <title>[ç¬”è®°]-Tomcat-HTTP | ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜</title>
        
        <meta name="author" content="huangzhike">
        
        
        <meta name="description" content="å…ˆç®€å•ç§‘æ™®ä¸€ä¸‹ã€‚
HTTP/1.1ï¼šç°åœ¨æœ€å¸¸ç”¨çš„ç‰ˆæœ¬ï¼Œé»˜è®¤å¼€å¯Connectionï¼škeep-aliveï¼Œæ”¯æŒé•¿è¿æ¥ï¼ˆPersistentConnectionï¼‰ï¼Œå¯ä»¥å¤ç”¨TCPè¿æ¥ï¼Œä¸ç”¨æ¯æ¬¡éƒ½é‡æ–°æ¡æ‰‹ï¼Œæ”¯æŒç®¡é“ï¼ˆPipeliningï¼‰ï¼Œæ’é˜Ÿä¸²è¡Œå¤„ç†ï¼Œå‰é¢çš„è¯·æ±‚é˜»å¡æ²¡è¿”å›æ—¶ï¼Œåé¢çš„è¯·æ±‚ä¹Ÿä¼šé˜»å¡ï¼Œå³çº¿å¤´">
        
        
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        
        <meta property="og:title" content="[ç¬”è®°]-Tomcat-HTTP"/>
        
        <meta property="og:site_name" content="ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜"/>
        
        
        <!-- favicon -->
        <link rel="icon" type="image/ico" href="/ok.ico" sizes="32x32">
        <meta name="msapplication-TileColor" content="#009688">
        <meta name="msapplication-TileImage" content="/mstile-144x144.ico">
        <meta name="theme-color" content="#009688">
        <!-- favicon end -->
        <!-- <link href="//ok.ico" rel="icon"> -->
        
        <!-- toc -->
        <!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
        <!-- material design -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
        <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
        
        <!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
        <!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
    <meta name="generator" content="Hexo 4.2.1"></head>

<body>
    <nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">èœå•</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" title="ä¸‹ä¸€å¥æ˜¯ï¼šå®¢æœ‰å¯äººæœŸä¸æ¥ã€‚å°æ—¶å€™ï¼Œå–œæ¬¢é åœ¨é˜³å°ä¸Šï¼Œä¸€è¾¹å¹é£ï¼Œä¸€è¾¹çœ‹ä¹¦ï¼Œå–œæ¬¢è¯»ä¹¦å—ï¼Œéªšå¹´ï¼Ÿ" href="/">ä¹¦å½“å¿«æ„è¯»æ˜“å°½</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" target="_blank" rel="noopener" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

    <div class="container" >
        <div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[ç¬”è®°]-Tomcat-HTTP</h2>
				
				<div>
					<div class="post-time">2019-09-15</div>
				</div>
				
				<div class="article-content">
				<p>å…ˆç®€å•ç§‘æ™®ä¸€ä¸‹ã€‚</p>
<p>HTTP/1.1ï¼šç°åœ¨æœ€å¸¸ç”¨çš„ç‰ˆæœ¬ï¼Œé»˜è®¤å¼€å¯Connectionï¼škeep-aliveï¼Œæ”¯æŒé•¿è¿æ¥ï¼ˆPersistentConnectionï¼‰ï¼Œå¯ä»¥å¤ç”¨TCPè¿æ¥ï¼Œä¸ç”¨æ¯æ¬¡éƒ½é‡æ–°æ¡æ‰‹ï¼Œæ”¯æŒç®¡é“ï¼ˆPipeliningï¼‰ï¼Œæ’é˜Ÿä¸²è¡Œå¤„ç†ï¼Œå‰é¢çš„è¯·æ±‚é˜»å¡æ²¡è¿”å›æ—¶ï¼Œåé¢çš„è¯·æ±‚ä¹Ÿä¼šé˜»å¡ï¼Œå³çº¿å¤´é˜»å¡ï¼ˆHead-of-line blockingï¼ŒHOLï¼‰ã€‚</p>
<p>HTTP/2.0ï¼šå¤šè·¯å¤ç”¨ï¼ˆMultiplexingï¼‰ï¼Œä¸ä¼šæœ‰é˜»å¡çš„é—®é¢˜ï¼Œè¿˜æœ‰ä¸€ä¸ªæµï¼Œæˆ‘ä¹Ÿæ²¡æ€ä¹ˆäº†è§£ğŸ˜¬ã€‚</p>
<hr>
<p>NioEndpoint$SocketProcessor#doRun</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doRun</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            NioChannel socket <span class="token operator">=</span> socketWrapper<span class="token punctuation">.</span><span class="token function">getSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è·å–Socketæ³¨å†Œåˆ°Selectorçš„SelectionKey</span>
            SelectionKey key <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">getIOChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">keyFor</span><span class="token punctuation">(</span>socket<span class="token punctuation">.</span><span class="token function">getSocketWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPoller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Poller poller <span class="token operator">=</span> NioEndpoint<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>poller<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>poller <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                socketWrapper<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> handshake <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// NioChannelé»˜è®¤æ¡æ‰‹å®Œæˆï¼ŒSecureNioChanneléœ€è¦TLSæ¡æ‰‹</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>socket<span class="token punctuation">.</span><span class="token function">isHandshakeComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            handshake <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment" spellcheck="true">// å½“åšæ¡æ‰‹å¤±è´¥</span>
                        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token operator">==</span> SocketEvent<span class="token punctuation">.</span>STOP <span class="token operator">||</span> event <span class="token operator">==</span> SocketEvent<span class="token punctuation">.</span>DISCONNECT <span class="token operator">||</span> event <span class="token operator">==</span> SocketEvent<span class="token punctuation">.</span>ERROR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            handshake <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment" spellcheck="true">// æ¡æ‰‹æ²¡å®Œæˆ</span>
                        <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// æ‰§è¡Œæ¡æ‰‹ï¼Œå¯è¯»å¯å†™</span>
                            handshake <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">handshake</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">isReadable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">.</span><span class="token function">isWritable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// æ¡æ‰‹å®Œæˆæ—¶å¿…é¡»ä¸ºSocketEvent.OPEN_READ</span>
                            <span class="token comment" spellcheck="true">// å› ä¸ºåªåœ¨æ¡æ‰‹å®Œæˆæ—¶ä½¿ç”¨ï¼Œè¿™é‡Œè®¾ç½®ä¹Ÿæ˜¯å¯ä»¥çš„</span>
                            event <span class="token operator">=</span> SocketEvent<span class="token punctuation">.</span>OPEN_READ<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">CancelledKeyException</span> ckx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// æ¡æ‰‹å®Œæˆ</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>handshake <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// Socketæ‰“å¼€çŠ¶æ€</span>
                    SocketState state <span class="token operator">=</span> SocketState<span class="token punctuation">.</span>OPEN<span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// é»˜è®¤å¤„ç†è¯·æ±‚</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ConnectionHandlerï¼Œä¸€ä¸ªEndpointå…³è”ä¸€ä¸ªHandlerï¼Œå­˜æ”¾äº†Socketå’ŒProcessorçš„å…³è”</span>
                        <span class="token comment" spellcheck="true">// Socketæ‰“å¼€å¹¶ä¸”å¯è¯»çŠ¶æ€</span>
                        state <span class="token operator">=</span> <span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>socketWrapper<span class="token punctuation">,</span> SocketEvent<span class="token punctuation">.</span>OPEN_READ<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// å¤„ç†æŒ‡å®šäº‹ä»¶</span>
                    <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        state <span class="token operator">=</span> <span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>socketWrapper<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// å…³é—­Socket</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// å–æ¶ˆä¹‹å‰å…³å¿ƒçš„äº‹ä»¶ï¼Œå¹¶å…³é—­Socket</span>
                        poller<span class="token punctuation">.</span><span class="token function">cancelledKey</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> socketWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// æ¡æ‰‹å¤±è´¥</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>handshake <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>socketWrapper<span class="token punctuation">,</span> SocketEvent<span class="token punctuation">.</span>CONNECT_FAIL<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    poller<span class="token punctuation">.</span><span class="token function">cancelledKey</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> socketWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// æ¡æ‰‹æ—¶æ²¡è¯»å®Œï¼Œé‡æ–°å…³æ³¨å¯è¯»äº‹ä»¶</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>handshake <span class="token operator">==</span> SelectionKey<span class="token punctuation">.</span>OP_READ<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    socketWrapper<span class="token punctuation">.</span><span class="token function">registerReadInterest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// æ¡æ‰‹æ—¶æ²¡å†™å®Œï¼Œé‡æ–°å…³æ³¨å¯å†™äº‹ä»¶</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>handshake <span class="token operator">==</span> SelectionKey<span class="token punctuation">.</span>OP_WRITE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    socketWrapper<span class="token punctuation">.</span><span class="token function">registerWriteInterest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">CancelledKeyException</span> cx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">VirtualMachineError</span> vme<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å°†SocketProcessorçš„SocketWrapperç½®ç©º</span>
                socketWrapper <span class="token operator">=</span> null<span class="token punctuation">;</span>
                event <span class="token operator">=</span> null<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// æœ€åå°†SocketProcessoræ”¾å›å¯¹è±¡æ± </span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>running <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>paused <span class="token operator">&amp;&amp;</span> processorCache <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    processorCache<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// æ³¨æ„è¿™ä¸ªSocketProcessorå’ŒHttp11Processorç­‰Processorä¸æ˜¯ä¸€ä¸ªæ¦‚å¿µ</span>
                <span class="token comment" spellcheck="true">// SocketProcessorç”¨æ¥åŒ…è£…Runnableä»»åŠ¡ï¼Œè¿è¡Œå®Œå›æ”¶</span>
                <span class="token comment" spellcheck="true">// Http11Processorç­‰æ˜¯å…³è”Socketçš„ï¼Œå¤„ç†Socketçš„ä¸€ä¸ªè¯·æ±‚</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span></code></pre>
<p>AbstractProtocol$ConnectionHandler#process</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> SocketState <span class="token function">process</span><span class="token punctuation">(</span>SocketWrapperBase<span class="token operator">&lt;</span>S<span class="token operator">></span> wrapper<span class="token punctuation">,</span> SocketEvent status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>wrapper <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Nothing to do. Socket has been closed.</span>
                <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            S socket <span class="token operator">=</span> wrapper<span class="token punctuation">.</span><span class="token function">getSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// Socketå…³è”ä¸€ä¸ªProcessorï¼ŒSocketçš„ä¸€æ¬¡è¯·æ±‚æ²¡ç»“æŸï¼Œæ¯”å¦‚æ•°æ®åˆ†å¤šæ¬¡æ”¶åˆ°ï¼Œè§¦å‘äº†å¤šæ¬¡å¯è¯»äº‹ä»¶ï¼Œéƒ½æ˜¯åŒä¸€ä¸ªProcessorå¤„ç†</span>
            Processor processor <span class="token operator">=</span> connections<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// Timeouts are calculated on a dedicated thread and then dispatched.</span>
            <span class="token comment" spellcheck="true">// Because of delays in the dispatch process, the timeout may no longer be required.</span>
            <span class="token comment" spellcheck="true">// Check here and avoid unnecessary processing.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>SocketEvent<span class="token punctuation">.</span>TIMEOUT <span class="token operator">==</span> status <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>processor <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token operator">!</span>processor<span class="token punctuation">.</span><span class="token function">isAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>processor<span class="token punctuation">.</span><span class="token function">isUpgrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> processor<span class="token punctuation">.</span><span class="token function">isAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>processor<span class="token punctuation">.</span><span class="token function">checkAsyncTimeoutGeneration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// This is effectively a NO-OP</span>
                <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>OPEN<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>processor <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ç¡®ä¿ä¸è§¦å‘å¼‚æ­¥è¶…æ—¶</span>
                <span class="token function">getProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeWaitingProcessor</span><span class="token punctuation">(</span>processor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> SocketEvent<span class="token punctuation">.</span>DISCONNECT <span class="token operator">||</span> status <span class="token operator">==</span> SocketEvent<span class="token punctuation">.</span>ERROR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ç›´æ¥å…³é—­</span>
                <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// è®¾ç½®ThreadLocalæ ‡å¿—ï¼Œç”¨äºåˆ¤æ–­å¼‚æ­¥çŠ¶æ€</span>
            ContainerThreadMarker<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ç¬¬ä¸€æ¬¡ï¼Œæ²¡æœ‰å…³è”</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>processor <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>processor <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ä»å›æ”¶çš„å¯¹è±¡æ± æ‹¿</span>
                    processor <span class="token operator">=</span> recycledProcessors<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// è¿˜æ²¡æœ‰ï¼Œå¯èƒ½æ˜¯å¯¹è±¡æ± ç”¨å®Œäº†</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>processor <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// åˆ›å»ºProcessorï¼ŒHttp11Processoræˆ–AjpProcessor</span>
                    processor <span class="token operator">=</span> <span class="token function">getProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// JMXï¼Œå¿½ç•¥</span>
                    <span class="token function">register</span><span class="token punctuation">(</span>processor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// æ˜¯å¦æ”¯æŒSSL</span>
                processor<span class="token punctuation">.</span><span class="token function">setSslSupport</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">.</span><span class="token function">getSslSupport</span><span class="token punctuation">(</span><span class="token function">getProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClientCertProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å…³è”Socketå’ŒProcessor</span>
                connections<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span> processor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                SocketState state <span class="token operator">=</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å¾ªç¯å¤„ç†ç›´åˆ°å®Œæˆåè®®å‡çº§</span>
                <span class="token keyword">do</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å¤„ç†HTTP/HTTPS/WS/WSS</span>
                    state <span class="token operator">=</span> processor<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>UPGRADING<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// å‡çº§åè®®é˜¶æ®µ</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>UPGRADING<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment" spellcheck="true">// ç­‰å¾…ï¼Œå¤„ç†åŠåŒ…ï¼ˆæ²¡æœ‰è¯»å®Œï¼‰</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>LONG<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å¦‚æœä¸æ˜¯å¼‚æ­¥è¯·æ±‚ï¼Œé‡æ–°æ³¨å†Œå¯è¯»äº‹ä»¶</span>
                    <span class="token function">longPoll</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">,</span> processor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// å¦‚æœæ˜¯å¼‚æ­¥è¯·æ±‚</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>processor<span class="token punctuation">.</span><span class="token function">isAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ç­‰å¾…ï¼ŒSocketå…³è”çš„Processorä¸èƒ½ç§»é™¤ï¼Œæ‰€ä»¥AsyncContextå®Œæˆåè¿˜å¯ä»¥ä½¿ç”¨</span>
                        <span class="token function">getProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addWaitingProcessor</span><span class="token punctuation">(</span>processor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// ä¿æŒSocketæ‰“å¼€ï¼Œä¸€èˆ¬æ˜¯ä¸€ä¸ªKeepAliveçš„HTTPè¯·æ±‚å¤„ç†å®Œåçš„çŠ¶æ€</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>OPEN<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ç§»é™¤Socketå…³è”çš„Processor</span>
                    connections<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">release</span><span class="token punctuation">(</span>processor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// é‡æ–°æ³¨å†Œå¯è¯»äº‹ä»¶</span>
                    wrapper<span class="token punctuation">.</span><span class="token function">registerReadInterest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>SENDFILE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// å·²å®Œæˆåè®®å‡çº§</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>UPGRADED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// åœ¨æœ‰éé˜»å¡å†™çš„æƒ…å†µä¸‹ï¼Œä¸èƒ½å°†Socketæ·»åŠ å›Pollerï¼Œå¦åˆ™Pollerå¯èƒ½ä¼šè§¦å‘å¤šè¯»äº‹ä»¶ï¼Œå¯¼è‡´Connectorå†…çš„çº¿ç¨‹é¥¥é¥¿</span>
                    <span class="token comment" spellcheck="true">// The write() method will add this socket to the poller if necessary.</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">!=</span> SocketEvent<span class="token punctuation">.</span>OPEN_WRITE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// å¦‚æœä¸æ˜¯å¼‚æ­¥è¯·æ±‚ï¼Œå°†Socketæ·»åŠ å›Pollerï¼Œé‡æ–°æ³¨å†Œå¯è¯»äº‹ä»¶</span>
                        <span class="token function">longPoll</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">,</span> processor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// æ·»åŠ å…¥è¶…æ—¶ç­‰å¾…</span>
                        <span class="token function">getProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addWaitingProcessor</span><span class="token punctuation">(</span>processor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>SUSPENDED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ä¸èƒ½å°†Socketæ·»åŠ å›Poller</span>
                    <span class="token comment" spellcheck="true">// The resumeProcessing() method will add this socket to the poller.</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// éœ€è¦å…³é—­è¿æ¥ï¼Œå¯ä»¥å›æ”¶Processorï¼ŒUpgradeProcessorä¸ä¼šå›æ”¶</span>
                    connections<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// UpgradeProcessor</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>processor<span class="token punctuation">.</span><span class="token function">isUpgrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// å…¶å®ƒç›´æ¥å›æ”¶</span>
                    <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token function">release</span><span class="token punctuation">(</span>processor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// è¿”å›çŠ¶æ€ï¼Œåšå¯¹åº”å¤„ç†</span>
                <span class="token keyword">return</span> state<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span>SocketException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ProtocolException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">OutOfMemoryError</span> oome<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                ContainerThreadMarker<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ç¡®ä¿æœ‰å¼‚å¸¸çš„æƒ…å†µä¸‹ï¼Œæœ€åè¦ç§»é™¤Socketå’ŒProcessorçš„å…³è”</span>
            connections<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// é‡Šæ”¾é‡ç½®Processor</span>
            <span class="token function">release</span><span class="token punctuation">(</span>processor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å…³é—­è¿æ¥</span>
            <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>AbstractProcessorLight#process</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> SocketState <span class="token function">process</span><span class="token punctuation">(</span>SocketWrapperBase<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> socketWrapper<span class="token punctuation">,</span> SocketEvent status<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// é»˜è®¤å¤„ç†ç»“æœ</span>
        SocketState state <span class="token operator">=</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¼‚æ­¥Servletçš„Listeneréé˜»å¡è¯»å†™ï¼Œåœ¨ServletInputStream#setReadListeneræˆ–ServletInputStream#setWriteListeneræ—¶æ·»åŠ </span>
        Iterator<span class="token operator">&lt;</span>DispatchType<span class="token operator">></span> dispatches <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>dispatches <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                DispatchType nextDispatch <span class="token operator">=</span> dispatches<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// åˆ†å‘å¤„ç†SocketEvent.OPEN_READæˆ–SocketEvent.OPEN_WRITE</span>
                state <span class="token operator">=</span> <span class="token function">dispatch</span><span class="token punctuation">(</span>nextDispatch<span class="token punctuation">.</span><span class="token function">getSocketStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> SocketEvent<span class="token punctuation">.</span>DISCONNECT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Do nothing here, just wait for it to get recycled</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span><span class="token comment" spellcheck="true">/*å·²å‡çº§WebSocket/HTTP/2.0*/</span> <span class="token function">isUpgrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>ASYNC_END<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ä»¥WebSocketä¸ºä¾‹ï¼Œè¿™é‡Œæ˜¯è°ƒç”¨UpgradeProcessorInternal#dispatch -> WsHttpUpgradeHandler#upgradeDispatch</span>
                state <span class="token operator">=</span> <span class="token function">dispatch</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// WebSocketå‡çº§å®Œæˆåï¼Œæ¯æ¬¡æ”¶åˆ°æ¶ˆæ¯è¿”å›çš„çŠ¶æ€éƒ½æ˜¯SocketState.UPGRADED</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>OPEN<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å¯èƒ½è¿™ä¸ªSocketè¿˜æœ‰Pipelineæ’é˜Ÿçš„æ•°æ®ï¼Œå¦‚æœç°åœ¨ä¸å¤„ç†æ•°æ®ï¼Œä¼šé€€å‡ºå½“å‰å¾ªç¯å¹¶è°ƒç”¨é‡Šæ”¾å›æ”¶Processorå’Œç¼“å†²ï¼Œè¿™æ ·ä¼šåˆ é™¤æ‰€æœ‰çš„Pipelineæ’é˜Ÿçš„æ•°æ®</span>
                    <span class="token comment" spellcheck="true">// ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œç°åœ¨å¤„ç†å®ƒ</span>
                    state <span class="token operator">=</span> <span class="token function">service</span><span class="token punctuation">(</span>socketWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> SocketEvent<span class="token punctuation">.</span>OPEN_WRITE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Extra write event likely after async, ignore</span>
                state <span class="token operator">=</span> SocketState<span class="token punctuation">.</span>LONG<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ä¸€èˆ¬çš„HTTPè¯·æ±‚</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> SocketEvent<span class="token punctuation">.</span>OPEN_READ<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                state <span class="token operator">=</span> <span class="token function">service</span><span class="token punctuation">(</span>socketWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> SocketEvent<span class="token punctuation">.</span>CONNECT_FAIL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">logAccess</span><span class="token punctuation">(</span>socketWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Fallback</span>
                state <span class="token operator">=</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">!=</span> SocketState<span class="token punctuation">.</span>CLOSED <span class="token operator">&amp;&amp;</span> <span class="token function">isAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                state <span class="token operator">=</span> <span class="token function">asyncPostProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>dispatches <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token operator">!</span>dispatches<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Only returns non-null iterator if there are dispatches to process.</span>
                dispatches <span class="token operator">=</span> <span class="token function">getIteratorAndClearDispatches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>ASYNC_END <span class="token operator">||</span> dispatches <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> state <span class="token operator">!=</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<ul>
<li><p>org.apache.coyote.http2.StreamProcessorï¼šå¤„ç†HTTP/2.0åè®®ã€‚</p>
</li>
<li><p>org.apache.coyote.http11.Http11Processorï¼šå¤„ç†HTTP/1.1åè®®ï¼Œæˆ–è€…åˆ«çš„ä½ç‰ˆæœ¬çš„ã€‚</p>
</li>
<li><p>org.apache.coyote.ajp.AjpProcessorï¼šå¤„ç†AJPåè®®ã€‚</p>
</li>
</ul>
<p>è¿˜æœ‰ä¸€äº›å¤„ç†å™¨å¦‚org.apache.coyote.http11.upgrade.UpgradeProcessorInternalå¤„ç†åˆ«çš„å‡çº§çš„åè®®ï¼Œæ¯”å¦‚WebSocketã€‚</p>
<p>Http11Processor#service</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> SocketState <span class="token function">service</span><span class="token punctuation">(</span>SocketWrapperBase<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> socketWrapper<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ä¸€ä¸ªProcessorä¸€ä¸ªRequestï¼Œå¯å¤ç”¨</span>
        RequestInfo rp <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getRequestProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// ä¸€ä¸ªProcessorä¸€ä¸ªInputBufferå’Œä¸€ä¸ªOutputBufferï¼Œå¹¶ä¸ºè¿™ä¸ªSocketWrapperBaseå…³è”è¯»å†™ç¼“å†²</span>
        <span class="token function">setSocketWrapper</span><span class="token punctuation">(</span>socketWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// é»˜è®¤Flags</span>
        keepAlive <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        openSocket <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        readComplete <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> keptAlive <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        SendfileState sendfileState <span class="token operator">=</span> SendfileState<span class="token punctuation">.</span>DONE<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/*
         * Tomcatçš„NIOå’ŒNettyçš„Reactoræ¨¡å‹ä¸ä¸€æ ·
         * HTTP/1.1ï¼Œä¸€ä¸ªè¯·æ±‚è¯»å®Œï¼Œå¤„ç†å“åº”ï¼Œå†ç»§ç»­è¯»ä¸‹ä¸€ä¸ªè¯·æ±‚ï¼Œè¿™æ˜¯é˜»å¡çš„
         * å¦‚æœæƒ³åœ¨HTTP/1.1åè®®ä¸Šå®ç°RPCè¿æ¥å¤ç”¨ï¼Œæ˜¾ç„¶æ€§èƒ½æ˜¯ä¸é«˜çš„ï¼Œå› ä¸ºHTTP/2.0éé˜»å¡ï¼Œæ‰€ä»¥çŒœæµ‹åº”è¯¥å¯ä»¥æé«˜RPCæ€§èƒ½ï¼Ÿ
         */</span>

        <span class="token comment" spellcheck="true">// ä¸€ç›´è§£æï¼Œå¾ªç¯å¤„ç†ä¸€ä¸ªè¿æ¥çš„å¤šä¸ªHTTPè¯·æ±‚</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getErrorState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// æ²¡æœ‰é”™è¯¯</span>
                <span class="token operator">&amp;&amp;</span> keepAlive <span class="token comment" spellcheck="true">// ä¿æŒè¿æ¥</span>
                <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// éå¼‚æ­¥</span>
                <span class="token operator">&amp;&amp;</span> upgradeToken <span class="token operator">==</span> null <span class="token comment" spellcheck="true">// æ²¡æœ‰UpgradeToken</span>
                <span class="token operator">&amp;&amp;</span> sendfileState <span class="token operator">==</span> SendfileState<span class="token punctuation">.</span>DONE <span class="token comment" spellcheck="true">// å‘é€æ–‡ä»¶å®Œæˆ</span>
                <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>protocol<span class="token punctuation">.</span><span class="token function">isPaused</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// æ²¡è¢«æš‚åœ</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">/*
             * HTTPåè®®æ ¼å¼
             * RequestLine è¯·æ±‚è¡Œ GET /xxx?callback=xxx&amp;xxx= HTTP/1.1
             * Headers è¯·æ±‚å¤´ Host: www.baidu.com...
             * ç©ºè¡Œ
             * Body è¯·æ±‚ä½“
             */</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>

                <span class="token comment" spellcheck="true">// ä»InputBufferç¼“å†²è§£æè¯·æ±‚è¡Œï¼Œå¦‚æœæ²¡æœ‰è¯»åˆ°å®Œæ•´çš„è¯·æ±‚è¡Œ</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inputBuffer<span class="token punctuation">.</span><span class="token function">parseRequestLine</span><span class="token punctuation">(</span>keptAlive<span class="token punctuation">,</span> protocol<span class="token punctuation">.</span><span class="token function">getConnectionTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> protocol<span class="token punctuation">.</span><span class="token function">getKeepAliveTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// è¡¨ç¤ºè¦å‡çº§HTTP/2.0åè®®ï¼Œ"PRI * HTTP/2.0\r\n\r\nSM\r\n\r\n"</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>inputBuffer<span class="token punctuation">.</span><span class="token function">getParsingRequestLinePhase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>UPGRADING<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">/*
                     * è®¾ç½®openSocket=trueï¼Œä¿æŒSocketæ‰“å¼€
                     *   å¦‚æœå·²ç»å¼€å§‹è¯»äº†è¯·æ±‚è¡Œï¼Œè®¾ç½®readComplete=falseï¼Œè·³å‡ºå¾ªç¯åï¼Œè¿”å›SocketState.LONGï¼Œé‡æ–°æ³¨å†Œå¯è¯»äº‹ä»¶ï¼Œä¸€èˆ¬æ˜¯æ”¶åˆ°çš„æ•°æ®ä¸å¤Ÿ
                     *   å¦‚æœæ²¡è¯»åˆ°æ•°æ®ï¼Œè·³å‡ºå¾ªç¯åï¼Œè¿”å›SocketState.OPENï¼Œé‡æ–°æ³¨å†Œå¯è¯»äº‹ä»¶ï¼Œä¸€èˆ¬æ˜¯å¤„ç†å®Œäº†æ‰€æœ‰è¯·æ±‚ï¼Œåœ¨è¿™é‡Œé€€å‡ºå¾ªç¯
                     */</span>
                    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">handleIncompleteRequestLineRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// è·³å‡ºå¾ªç¯</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>protocol<span class="token punctuation">.</span><span class="token function">isPaused</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 503...</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    keptAlive <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// æ¯æ¬¡éƒ½è®¾ç½®ï¼Œé¿å…é€šè¿‡JMXè¢«æ”¹å˜</span>
                    <span class="token comment" spellcheck="true">// è®¾ç½®è¯·æ±‚å¤´çš„æœ€å¤§æ•°é‡</span>
                    request<span class="token punctuation">.</span><span class="token function">getMimeHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setLimit</span><span class="token punctuation">(</span>protocol<span class="token punctuation">.</span><span class="token function">getMaxHeaderCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// ä»ç¼“å†²è§£æè¯·æ±‚å¤´ï¼Œå¦‚æœæ²¡æœ‰è¯»åˆ°å®Œæ•´çš„è¯·æ±‚å¤´</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inputBuffer<span class="token punctuation">.</span><span class="token function">parseHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// å·²ç»è¯»äº†ä¸€éƒ¨åˆ†è¯·æ±‚ï¼Œä¸è¦å›æ”¶ï¼Œåº”è¯¥å°†å®ƒå…³è”Socket</span>
                        openSocket <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                        readComplete <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// è·³å‡ºå¾ªç¯åï¼Œè¿”å›SocketState.LONGï¼Œé‡æ–°æ³¨å†Œå¯è¯»äº‹ä»¶</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>protocol<span class="token punctuation">.</span><span class="token function">getDisableUploadTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        socketWrapper<span class="token punctuation">.</span><span class="token function">setReadTimeout</span><span class="token punctuation">(</span>protocol<span class="token punctuation">.</span><span class="token function">getConnectionUploadTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 400...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ç•¥è¿‡å‡çº§HTTP/2.0</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getErrorState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isIoAllowed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å‡†å¤‡è¯·æ±‚ï¼Œæ ¹æ®è¯·æ±‚è¡Œçš„åè®®ç‰ˆæœ¬å’Œè¯·æ±‚å¤´çš„ä¿¡æ¯åšä¸€äº›é…ç½®</span>
                    <span class="token comment" spellcheck="true">// æ ¹æ®è¯·æ±‚å¤´çš„transfer-encodingå’Œcontent-lengthç­‰ç¡®å®šInputFilter</span>
                    <span class="token comment" spellcheck="true">// InputFilterç”¨äºè§£æè¯·æ±‚ä½“ï¼Œè§£ææ—¶æœºæ˜¯ç¬¬ä¸€æ¬¡è°ƒç”¨ServletRequest#getParameteræˆ–ServletRequest#getInputStream</span>
                    <span class="token function">prepareRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 500...</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ä¸€ä¸ªTCPè¿æ¥å…è®¸çš„æœ€å¤§keepAliveè¯·æ±‚æ•°ï¼Œé»˜è®¤100</span>
            <span class="token keyword">int</span> maxKeepAliveRequests <span class="token operator">=</span> protocol<span class="token punctuation">.</span><span class="token function">getMaxKeepAliveRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// åªå…è®¸ä¸€ä¸ª</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>maxKeepAliveRequests <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// é‚£å°±æ²¡ä»€ä¹ˆkeepAliveäº†</span>
                keepAlive <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// è¿™ä¸ªTCPè¿æ¥å…è®¸çš„è¯·æ±‚æ•°--ï¼Œå½“ç”¨å®Œå…è®¸çš„è¯·æ±‚æ•°ä¹‹å</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>maxKeepAliveRequests <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> socketWrapper<span class="token punctuation">.</span><span class="token function">decrementKeepAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å…³é—­keepAlive</span>
                keepAlive <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// Process the request in the adapter</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getErrorState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isIoAllowed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token comment" spellcheck="true">// å¤„ç†è§£æå¥½çš„è¯·æ±‚ï¼Œæœ€åè°ƒç”¨Servletå¤„ç†</span>
                    <span class="token function">getAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedIOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">HeadersTooLargeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 500...</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 500...</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// Finish the handling of the request</span>
            rp<span class="token punctuation">.</span><span class="token function">setStage</span><span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>coyote<span class="token punctuation">.</span>Constants<span class="token punctuation">.</span>STAGE_ENDINPUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å¦‚æœæ˜¯ä¸å¼‚æ­¥çŠ¶æ€</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ç›´æ¥ç»“æŸè¯·æ±‚ï¼Œç»“æŸè¾“å…¥è¾“å‡ºç¼“å†²å¹¶æäº¤ï¼ˆå¦‚æœæ˜¯å¼‚æ­¥è¯·æ±‚ï¼Œåˆ™å®Œæˆæ—¶è¯·æ±‚æ‰ç»“æŸï¼Œç”±AsyncContextè°ƒç”¨endRequestï¼‰</span>
                <span class="token function">endRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// éå¼‚æ­¥ || æœ‰å¼‚å¸¸</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">getErrorState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æ›´æ–°è®¡æ•°</span>
                request<span class="token punctuation">.</span><span class="token function">updateCounters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getErrorState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isIoAllowed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// é‡ç½®å›æ”¶</span>
                    inputBuffer<span class="token punctuation">.</span><span class="token function">nextRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    outputBuffer<span class="token punctuation">.</span><span class="token function">nextRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>protocol<span class="token punctuation">.</span><span class="token function">getDisableUploadTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// æ–‡ä»¶ä¼ è¾“ï¼Œé»˜è®¤SendfileState.DONEï¼Œè®¾ç½®openSocket = keepAlive</span>
            <span class="token comment" spellcheck="true">// æ‰€ä»¥ä¸€èˆ¬è¯·æ±‚ç»“æŸåSocketè¿˜æ˜¯æ‰“å¼€çš„</span>
            sendfileState <span class="token operator">=</span> <span class="token function">processSendfile</span><span class="token punctuation">(</span>socketWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å·²è·³å‡ºwhileå¾ªç¯</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// æœ‰å¼‚å¸¸ || æš‚åœ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getErrorState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> protocol<span class="token punctuation">.</span><span class="token function">isPaused</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// éœ€è¦å…³é—­</span>
            <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å¼‚æ­¥çŠ¶æ€</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>LONG<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å­˜åœ¨UpgradeToken</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUpgrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ­£åœ¨å‡çº§åè®®</span>
            <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>UPGRADING<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å…¶å®ƒ</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ–‡ä»¶ä¼ è¾“ä¸­</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sendfileState <span class="token operator">==</span> SendfileState<span class="token punctuation">.</span>PENDING<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>SENDFILE<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å…¶å®ƒè¯·æ±‚</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ä¿æŒSocketæ‰“å¼€</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>openSocket<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// è¯·æ±‚å¤´è¯»å®Œ</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>readComplete<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// è¡¨ç¤ºéœ€è¦ä¿æŒè¿æ¥æ‰“å¼€ï¼Œé‡æ–°æ³¨å†Œå¯è¯»äº‹ä»¶ï¼Œæ¥å—ä¸‹ä¸€ä¸ªè¯·æ±‚</span>
                        <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>OPEN<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// è¿˜æœ‰æ•°æ®æ²¡æ”¶åˆ°</span>
                    <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// éœ€è¦ç­‰å¾…ï¼Œé‡æ–°æ³¨å†Œå¯è¯»äº‹ä»¶</span>
                        <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>LONG<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// éœ€è¦å…³é—­</span>
                    <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p><img src="/imgs/HTTP_protocol.png" alt="HTTPåè®®"></p>
<p>Http11InputBuffer#parseRequestLine</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">boolean</span> <span class="token function">parseRequestLine</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> keptAlive<span class="token punctuation">,</span> <span class="token keyword">int</span> connectionTimeout<span class="token punctuation">,</span> <span class="token keyword">int</span> keepAliveTimeout<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// æ£€æŸ¥çŠ¶æ€</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>parsingRequestLine<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å‡å¦‚è¯·æ±‚è¡Œå‰é¢è¿˜æœ‰æ¢è¡Œæˆ–å›è½¦ï¼Œè·³è¿‡ç©ºè¡Œ</span>
        <span class="token comment" spellcheck="true">// parsingRequestLinePhaseä»£è¡¨è¯»å–RequestLineåˆ°å“ªä¸ªé˜¶æ®µï¼Œåˆå§‹ä¸º0ï¼Œè¿™æ—¶byteBufferä¸ºç©ºï¼Œposition == limit = 0</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parsingRequestLinePhase <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">byte</span> chr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">do</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å¦‚æœéœ€è¦ï¼Œè¯»å–æ–°çš„å­—èŠ‚ï¼Œposition == limitï¼Œè¡¨ç¤ºå·²è¯»åˆ°å°½å¤´</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>keptAlive<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// è¿˜æ²¡è¯»åˆ°ä»»ä½•è¯·æ±‚æ•°æ®ï¼Œæ‰€ä»¥ä½¿ç”¨keepAliveTimeout</span>
                        wrapper<span class="token punctuation">.</span><span class="token function">setReadTimeout</span><span class="token punctuation">(</span>keepAliveTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// æ‰§è¡Œfillé‡æ–°å¡«å……æ•°æ®ï¼Œfalseä»£è¡¨éé˜»å¡è¯»ï¼Œå…ˆä»Socketå…³è”çš„ç¼“å†²è¯»å–ï¼Œå†ä»ç³»ç»Ÿè¯»</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// è¯»ä¸åˆ°æ•°æ®ï¼ŒparsingRequestLinePhaseä¸å†å¤„äºåˆå§‹çš„çŠ¶æ€</span>
                        parsingRequestLinePhase <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// è‡³å°‘æ”¶åˆ°äº†ä¸€ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥ä½¿ç”¨connectionTimeout</span>
                    wrapper<span class="token punctuation">.</span><span class="token function">setReadTimeout</span><span class="token punctuation">(</span>connectionTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// ékeptAlive &amp;&amp; è¿˜æ²¡è¯» &amp;&amp; æ”¶åˆ°è¶³å¤Ÿé•¿çš„è¯·æ±‚å¤´"PRI * HTTP/2.0\r\n\r\nSM\r\n\r\n"</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>keptAlive <span class="token operator">&amp;&amp;</span> byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> byteBuffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> CLIENT_PREFACE_START<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">boolean</span> prefaceMatch <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// è¯·æ±‚è¡ŒåŒ¹é…"PRI * HTTP/2.0\r\n\r\nSM\r\n\r\n"</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> CLIENT_PREFACE_START<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> prefaceMatch<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>CLIENT_PREFACE_START<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            prefaceMatch <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>prefaceMatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// éœ€è¦å‡çº§HTTP/2.0</span>
                        parsingRequestLinePhase <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// ä¸€æ—¦å¼€å§‹è¯»å–æ•°æ®ï¼Œå°±è®¾ç½®å¼€å§‹æ—¶é—´ï¼Œå³ä½¿æ˜¯è·³è¿‡ç©ºè¡Œ</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getStartTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    request<span class="token punctuation">.</span><span class="token function">setStartTime</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// è·å–ä¸‹ä¸€ä¸ªå­—èŠ‚</span>
                chr <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>
                <span class="token comment" spellcheck="true">// Carriage Return å›è½¦ \r</span>
                    <span class="token punctuation">(</span>chr <span class="token operator">==</span> Constants<span class="token punctuation">.</span>CR<span class="token punctuation">)</span> <span class="token operator">||</span>
                            <span class="token comment" spellcheck="true">// Linefeed æ¢è¡Œ \n</span>
                            <span class="token punctuation">(</span>chr <span class="token operator">==</span> Constants<span class="token punctuation">.</span>LF<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ç°åœ¨å·²ç»ç¡®ä¿è¯·æ±‚è¡Œå‰å·²ç»æ²¡æœ‰æ¢è¡Œæˆ–å›è½¦äº†</span>
            byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å®šä½è¯·æ±‚å¤´å¼€å§‹ä½ç½®</span>
            parsingRequestLineStart <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ ‡è®°å¯ä»¥æ­£å¼å¼€å§‹è¯»è¯·æ±‚è¡Œæ•°æ®</span>
            parsingRequestLinePhase <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// è¯»å–è¯·æ±‚æ–¹æ³•åç§°ï¼ŒGET POST</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parsingRequestLinePhase <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">boolean</span> space <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ç›´åˆ°è¯»åˆ°ç¬¬ä¸€ä¸ªç©ºæ ¼</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>space<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å¦‚æœéœ€è¦ï¼Œå¡«å……æ–°çš„å­—èŠ‚</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// request line parsing</span>
                        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">int</span> pos <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// è·å–å­—èŠ‚</span>
                <span class="token keyword">byte</span> chr <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// Space ç©ºæ ¼ || Horizontal Tab \t</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>chr <span class="token operator">==</span> Constants<span class="token punctuation">.</span>SP <span class="token operator">||</span> chr <span class="token operator">==</span> Constants<span class="token punctuation">.</span>HT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    space <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// è¯·æ±‚æ–¹æ³•é•¿åº¦ç¡®å®šï¼Œè®¾ç½®è¯·æ±‚æ–¹æ³•</span>
                    request<span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setBytes</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> parsingRequestLineStart<span class="token punctuation">,</span> pos <span class="token operator">-</span> parsingRequestLineStart<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>HttpParser<span class="token punctuation">.</span><span class="token function">isToken</span><span class="token punctuation">(</span>chr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å¯ä»¥ç»§ç»­è¯»å–</span>
            parsingRequestLinePhase <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// è¯»å–ç©ºæ ¼</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parsingRequestLinePhase <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Spec says single SP but also be tolerant of multiple SP and/or HT</span>
            <span class="token keyword">boolean</span> space <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ç›´åˆ°è¯»åˆ°ç¬¬ä¸€ä¸ªä¸æ˜¯ç©ºæ ¼</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>space<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å¦‚æœéœ€è¦ï¼Œè¯»å–æ–°çš„å­—èŠ‚</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// request line parsing</span>
                        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// è·å–å­—ç¬¦</span>
                <span class="token keyword">byte</span> chr <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ä¸æ˜¯ Space ç©ºæ ¼ || Horizontal Tab \t</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>chr <span class="token operator">==</span> Constants<span class="token punctuation">.</span>SP <span class="token operator">||</span> chr <span class="token operator">==</span> Constants<span class="token punctuation">.</span>HT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    space <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            parsingRequestLineStart <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å·²è·³è¿‡è¯·æ±‚æ–¹æ³•å’ŒURIä¹‹é—´çš„ç©ºæ ¼ï¼Œä¸‹ä¸€æ­¥è¯»å–URI</span>
            parsingRequestLinePhase <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// è¯»å–URI</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parsingRequestLinePhase <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Mark the current buffer position</span>
            <span class="token keyword">int</span> end <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> space <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ç›´åˆ°è¯»åˆ°ç¬¬ä¸€ä¸ªç©ºæ ¼</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>space<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Read new bytes if needed</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// request line parsing</span>
                        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">int</span> pos <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">byte</span> chr <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>chr <span class="token operator">==</span> Constants<span class="token punctuation">.</span>SP <span class="token operator">||</span> chr <span class="token operator">==</span> Constants<span class="token punctuation">.</span>HT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    space <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    end <span class="token operator">=</span> pos<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>chr <span class="token operator">==</span> Constants<span class="token punctuation">.</span>CR <span class="token operator">||</span> chr <span class="token operator">==</span> Constants<span class="token punctuation">.</span>LF<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// HTTP/0.9 style request</span>
                    parsingRequestLineEol <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    space <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    end <span class="token operator">=</span> pos<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// åŒ…å«?ï¼Œå³æœ‰æŸ¥è¯¢å‚æ•°QueryString</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>chr <span class="token operator">==</span> Constants<span class="token punctuation">.</span>QUESTION <span class="token operator">&amp;&amp;</span> parsingRequestLineQPos <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// è®¾ç½®æŸ¥è¯¢å‚æ•°çš„å¼€å§‹ä½ç½®</span>
                    parsingRequestLineQPos <span class="token operator">=</span> pos<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>parsingRequestLineQPos <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>httpParser<span class="token punctuation">.</span><span class="token function">isQueryRelaxed</span><span class="token punctuation">(</span>chr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>httpParser<span class="token punctuation">.</span><span class="token function">isNotRequestTargetRelaxed</span><span class="token punctuation">(</span>chr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// æœ‰æŸ¥è¯¢å‚æ•°</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>parsingRequestLineQPos <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// è®¾ç½®æŸ¥è¯¢å‚æ•°</span>
                request<span class="token punctuation">.</span><span class="token function">queryString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setBytes</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> parsingRequestLineQPos <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> end <span class="token operator">-</span> parsingRequestLineQPos <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// è®¾ç½®URI</span>
                request<span class="token punctuation">.</span><span class="token function">requestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setBytes</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> parsingRequestLineStart<span class="token punctuation">,</span> parsingRequestLineQPos <span class="token operator">-</span> parsingRequestLineStart<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// æ²¡æœ‰æŸ¥è¯¢å‚æ•°</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// è®¾ç½®URI</span>
                request<span class="token punctuation">.</span><span class="token function">requestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setBytes</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> parsingRequestLineStart<span class="token punctuation">,</span> end <span class="token operator">-</span> parsingRequestLineStart<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å¯ä»¥ç»§ç»­è§£æåè®®ç‰ˆæœ¬</span>
            parsingRequestLinePhase <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// è·³è¿‡ç©ºæ ¼</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parsingRequestLinePhase <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Spec says single SP but also be tolerant of multiple and/or HT</span>
            <span class="token keyword">boolean</span> space <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>space<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Read new bytes if needed</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// request line parsing</span>
                        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">byte</span> chr <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>chr <span class="token operator">==</span> Constants<span class="token punctuation">.</span>SP <span class="token operator">||</span> chr <span class="token operator">==</span> Constants<span class="token punctuation">.</span>HT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    space <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            parsingRequestLineStart <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            parsingRequestLinePhase <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// Mark the current buffer position</span>
            end <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// è§£æåè®®ç‰ˆæœ¬ï¼Œæ ¼å¼ï¼šHTTP/X.X</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parsingRequestLinePhase <span class="token operator">==</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>parsingRequestLineEol<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Read new bytes if needed</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// request line parsing</span>
                        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">int</span> pos <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">byte</span> chr <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å›è½¦ç¬¦CR</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>chr <span class="token operator">==</span> Constants<span class="token punctuation">.</span>CR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// æ ‡è®°åè®®ç‰ˆæœ¬è¯»å–ç»“æŸ</span>
                    end <span class="token operator">=</span> pos<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// æ¢è¡Œç¬¦LF</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>chr <span class="token operator">==</span> Constants<span class="token punctuation">.</span>LF<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>end <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        end <span class="token operator">=</span> pos<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// è·³å‡º</span>
                    parsingRequestLineEol <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>HttpParser<span class="token punctuation">.</span><span class="token function">isHttpProtocol</span><span class="token punctuation">(</span>chr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"iib.invalidHttpProtocol"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>end <span class="token operator">-</span> parsingRequestLineStart<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// è®¾ç½®åè®®ç‰ˆæœ¬</span>
                request<span class="token punctuation">.</span><span class="token function">protocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setBytes</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> parsingRequestLineStart<span class="token punctuation">,</span> end <span class="token operator">-</span> parsingRequestLineStart<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                request<span class="token punctuation">.</span><span class="token function">protocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// è§£æå­—èŠ‚è¿™é‡Œéƒ½æ²¡æœ‰ååºåˆ—åŒ–ï¼Œè§£æè¯·æ±‚è¡Œè¯·æ±‚å¤´è¯·æ±‚ä½“ï¼Œå­—èŠ‚éƒ½æ˜¯éœ€è¦æ—¶æ‰ç¼–ç çš„</span>
            parsingRequestLine <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            parsingRequestLinePhase <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            parsingRequestLineEol <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            parsingRequestLineStart <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Invalid request line parse phase:"</span> <span class="token operator">+</span> parsingRequestLinePhase<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>Http11InputBuffer#fill</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">fill</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> block<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parsingHeader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> headerBufferSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>parsingRequestLine<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// Avoid unknown protocol triggering an additional error</span>
                    request<span class="token punctuation">.</span><span class="token function">protocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setString</span><span class="token punctuation">(</span>Constants<span class="token punctuation">.</span>HTTP_11<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"iib.requestheadertoolarge.error"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            byteBuffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>end<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span>end<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        byteBuffer<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> byteBuffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        byteBuffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        SocketWrapperBase<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> socketWrapper <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>wrapper<span class="token punctuation">;</span>
        <span class="token keyword">int</span> nRead <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>socketWrapper <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è¯»å–</span>
            nRead <span class="token operator">=</span> socketWrapper<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>block<span class="token punctuation">,</span> byteBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CloseNowException</span><span class="token punctuation">(</span>sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"iib.eof.error"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        byteBuffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nRead <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>nRead <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">EOFException</span><span class="token punctuation">(</span>sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"iib.eof.error"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span></code></pre>
<p>NioEndpoint$NioSocketWrapper#read</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> block<span class="token punctuation">,</span> ByteBuffer to<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å¦‚æœæœ‰æœªè¯»Bufferï¼Œå…ˆè¯»å–SocketBufferHandlerçš„è¯»ç¼“å†²åˆ°Processorçš„ç¼“å†²ByteBuffer</span>
            <span class="token keyword">int</span> nRead <span class="token operator">=</span> <span class="token function">populateReadBuffer</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>nRead <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// è¯»æˆåŠŸï¼Œç›´æ¥è¿”å›</span>
                <span class="token keyword">return</span> nRead<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// SocketBufferHandlerçš„è¯»ç¼“å†²å·²è¯»å®Œï¼Œå‡†å¤‡ä»SocketChannelè¯»</span>
            <span class="token comment" spellcheck="true">// The socket read buffer capacity is socket.appReadBufSize</span>
            <span class="token keyword">int</span> limit <span class="token operator">=</span> socketBufferHandler<span class="token punctuation">.</span><span class="token function">getReadBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ç¼“å†²å‰©ä½™éƒ¨åˆ†å¤§äºé™åˆ¶ï¼Œå®¹é‡è¶³å¤Ÿ</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>to<span class="token punctuation">.</span><span class="token function">remaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> limit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// è®¾ç½®è¯¥æ¬¡è¯»å–çš„æœ€å¤§å€¼</span>
                to<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>to<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> limit<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ç›´æ¥ä»SocketChannelè¯»åˆ°Processorçš„ç¼“å†²ByteBuffer</span>
                nRead <span class="token operator">=</span> <span class="token function">fillReadBuffer</span><span class="token punctuation">(</span>block<span class="token punctuation">,</span> to<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// æ›´æ–°ä¸Šæ¬¡è¯»å–æ—¶é—´</span>
                <span class="token function">updateLastRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å…ˆæŠŠæ•°æ®è¯»åˆ°SocketBufferHandlerçš„è¯»ç¼“å†²</span>
                nRead <span class="token operator">=</span> <span class="token function">fillReadBuffer</span><span class="token punctuation">(</span>block<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// æ›´æ–°ä¸Šæ¬¡è¯»å–æ—¶é—´</span>
                <span class="token function">updateLastRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å†è¯»å–SocketBufferHandlerçš„è¯»ç¼“å†²åˆ°Processorçš„ç¼“å†²ByteBuffer</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>nRead <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    nRead <span class="token operator">=</span> <span class="token function">populateReadBuffer</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> nRead<span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>SocketWrapperBase#populateReadBuffer</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">protected</span> <span class="token keyword">int</span> <span class="token function">populateReadBuffer</span><span class="token punctuation">(</span>ByteBuffer to<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Is there enough data in the read buffer to satisfy this request?</span>
        <span class="token comment" spellcheck="true">// Copy what data there is in the read buffer to the byte array</span>
        socketBufferHandler<span class="token punctuation">.</span><span class="token function">configureReadBufferForRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> nRead <span class="token operator">=</span> <span class="token function">transfer</span><span class="token punctuation">(</span>socketBufferHandler<span class="token punctuation">.</span><span class="token function">getReadBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> to<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> nRead<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>NioEndpoint$NioSocketWrapper#fillReadBuffer</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">fillReadBuffer</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> block<span class="token punctuation">,</span> ByteBuffer to<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
            <span class="token keyword">int</span> nRead<span class="token punctuation">;</span>
            NioChannel socket <span class="token operator">=</span> <span class="token function">getSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>socket <span class="token keyword">instanceof</span> <span class="token class-name">ClosedNioChannel</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ClosedChannelException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>block<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Selector selector <span class="token operator">=</span> null<span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    selector <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// Ignore</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    nRead <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> socket<span class="token punctuation">,</span> selector<span class="token punctuation">,</span> <span class="token function">getReadTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>selector <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        pool<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                nRead <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>nRead <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">EOFException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> nRead<span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>NioEndpoint$NioSocketWrapper#fillReadBuffer</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">fillReadBuffer</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> block<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
            socketBufferHandler<span class="token punctuation">.</span><span class="token function">configureReadBufferForWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">fillReadBuffer</span><span class="token punctuation">(</span>block<span class="token punctuation">,</span> socketBufferHandler<span class="token punctuation">.</span><span class="token function">getReadBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>æ³¨æ„è¿™é‡Œçš„Selectoræ˜¯æ¥è‡ªNioEndpointç»‘å®šæ—¶åˆå§‹åŒ–çš„SelectorPoolï¼Œä½†æ˜¯é»˜è®¤æ˜¯å…±äº«çš„ï¼Œä¹Ÿå°±æ˜¯åªæœ‰ä¸€ä¸ªã€‚</p>
<p>è¯¦ç»†å¯ä»¥å‚è€ƒå¦ä¸€ç¯‡Responseï¼Œå†™å’Œè¯»åŸç†æ˜¯ä¸€æ ·çš„ã€‚</p>
<p>å¤„ç†WebSocketä¹Ÿæ˜¯ç±»ä¼¼ã€‚</p>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


        <footer>
             
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

        </footer>
    </div>
    <!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
    <script>
        var timeEnd = new Date();
        console.log('è€—æ—¶ï¼š' + (timeEnd - timeStart));
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre').forEach((block) => {
                block.classList.add("line-numbers");
            });
        });
    </script>
    <!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
    <!-- material design -->
    <!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
    <!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
    <!-- toc -->
    <!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
    <!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
    <!-- <script src="/js/main.js"></script> -->
    <script src="/js/prism.js"></script>
</body>
</html>
