<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
        <script>
            var timeStart = new Date();
        </script>
        
        <title>[ç¬”è®°]-Tomcat-WebSocket | ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜</title>
        
        <meta name="author" content="huangzhike">
        
        
        <meta name="description" content="ContextConfig#webConfig
    protected void webConfig() {
        // ...
        if (ok) {
            // é€šè¿‡ParallelWebappClassLoaderä»¥SPIæ–¹å¼åŠ è½½ServletCon">
        
        
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        
        <meta property="og:title" content="[ç¬”è®°]-Tomcat-WebSocket"/>
        
        <meta property="og:site_name" content="ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜"/>
        
        
        <!-- favicon -->
        <link rel="icon" type="image/ico" href="/ok.ico" sizes="32x32">
        <meta name="msapplication-TileColor" content="#009688">
        <meta name="msapplication-TileImage" content="/mstile-144x144.ico">
        <meta name="theme-color" content="#009688">
        <!-- favicon end -->
        <!-- <link href="//ok.ico" rel="icon"> -->
        
        <!-- toc -->
        <!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
        <!-- material design -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
        <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
        
        <!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
        <!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
    <meta name="generator" content="Hexo 4.2.1"></head>

<body>
    <nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">èœå•</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" title="ä¸‹ä¸€å¥æ˜¯ï¼šå®¢æœ‰å¯äººæœŸä¸æ¥ã€‚å°æ—¶å€™ï¼Œå–œæ¬¢é åœ¨é˜³å°ä¸Šï¼Œä¸€è¾¹å¹é£ï¼Œä¸€è¾¹çœ‹ä¹¦ï¼Œå–œæ¬¢è¯»ä¹¦å—ï¼Œéªšå¹´ï¼Ÿ" href="/">ä¹¦å½“å¿«æ„è¯»æ˜“å°½</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" target="_blank" rel="noopener" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

    <div class="container" >
        <div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[ç¬”è®°]-Tomcat-WebSocket</h2>
				
				<div>
					<div class="post-time">2019-09-15</div>
				</div>
				
				<div class="article-content">
				<p>ContextConfig#webConfig</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">webConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ok<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// é€šè¿‡ParallelWebappClassLoaderä»¥SPIæ–¹å¼åŠ è½½ServletContainerInitializerå®ç°SCIsï¼ŒåŒ…å«JaråŒ…</span>
            <span class="token function">processServletContainerInitializers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å¦‚æœä¸Šé¢åŠ è½½çš„SCIsæœ‰@HandlesTypesæ³¨è§£</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>webXml<span class="token punctuation">.</span><span class="token function">isMetadataComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> typeInitializerMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å¤„ç†/WEB-INF/classesä¸‹çš„.classå’Œ.jarï¼Œå¤„ç†å¯¹åº”çš„ç±»</span>
            <span class="token function">processClasses</span><span class="token punctuation">(</span>webXml<span class="token punctuation">,</span> orderedFragments<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// æŠŠæ‰€æœ‰ServletContainerInitializerçš„å®ç°ç±»æ·»åŠ åˆ°StandardContextçš„initializersé›†åˆ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ok<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>Map<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span>ServletContainerInitializer<span class="token punctuation">,</span> Set<span class="token operator">&lt;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>>></span> entry <span class="token operator">:</span> initializerClassMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    context<span class="token punctuation">.</span><span class="token function">addServletContainerInitializer</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    context<span class="token punctuation">.</span><span class="token function">addServletContainerInitializer</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>META-INF/services/javax.servlet.ServletContainerInitializer</p>
<pre><code>org.apache.tomcat.websocket.server.WsSci</code></pre><p>WsSci</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@HandlesTypes</span><span class="token punctuation">(</span><span class="token punctuation">{</span>ServerEndpoint<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> ServerApplicationConfig<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> Endpoint<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WsSci</span> <span class="token keyword">implements</span> <span class="token class-name">ServletContainerInitializer</span> <span class="token punctuation">{</span>

    <span class="token comment" spellcheck="true">/**
     * å®ç°Endpointçš„ä¸¤ç§æ–¹å¼ï¼š
     * ä½¿ç”¨@ServerEndpoint(value = "/xxx")æ³¨è§£å¤„ç†ç±»
     * å¤„ç†ç±»å®ç°Endpointæ¥å£ï¼Œå¹¶ä¸”è¦æœ‰ä¸€ä¸ªé…ç½®ç±»å®ç°ServerApplicationConfigæ¥å£ï¼Œå¹¶ç”Ÿæˆæ·»åŠ å¯¹åº”çš„ServerEndpointConfig
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onStartup</span><span class="token punctuation">(</span>Set<span class="token operator">&lt;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>></span> clazzes<span class="token punctuation">,</span> ServletContext ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> ServletException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ä¸ºè¯¥ServletContextæ·»åŠ WsFilterï¼Œå¤„ç†å‡çº§è¯·æ±‚</span>
        WsServerContainer sc <span class="token operator">=</span> <span class="token function">init</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ²¡æœ‰@ServerEndpointæ³¨è§£ï¼Œæˆ–å®ç°äº†Endpointæ¥å£ï¼Œå°±è¿”å›</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>clazzes <span class="token operator">==</span> null <span class="token operator">||</span> clazzes<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Group the discovered classes by type</span>
        Set<span class="token operator">&lt;</span>ServerApplicationConfig<span class="token operator">></span> serverApplicationConfigs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Set<span class="token operator">&lt;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Endpoint</span><span class="token operator">>></span> scannedEndpointClazzes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Set<span class="token operator">&lt;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>></span> scannedPojoEndpoints <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// wsPackage is "javax.websocket."</span>
            String wsPackage <span class="token operator">=</span> ContainerProvider<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            wsPackage <span class="token operator">=</span> wsPackage<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> wsPackage<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> clazz <span class="token operator">:</span> clazzes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> modifiers <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getModifiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Modifier<span class="token punctuation">.</span><span class="token function">isPublic</span><span class="token punctuation">(</span>modifiers<span class="token punctuation">)</span> <span class="token operator">||</span> Modifier<span class="token punctuation">.</span><span class="token function">isAbstract</span><span class="token punctuation">(</span>modifiers<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// Non-public or abstract - skip it.</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// Protect against scanning the WebSocket API JARs</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>clazz<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>wsPackage<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// å®ä¾‹åŒ–å®ç°äº†ServerApplicationConfigçš„ç±»</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ServerApplicationConfig<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    serverApplicationConfigs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ServerApplicationConfig<span class="token punctuation">)</span> clazz<span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// å®ç°äº†Endpointæ¥å£çš„Endpoint</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>Endpoint<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Endpoint</span><span class="token operator">></span> endpoint <span class="token operator">=</span> <span class="token punctuation">(</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Endpoint</span><span class="token operator">></span><span class="token punctuation">)</span> clazz<span class="token punctuation">;</span>
                    scannedEndpointClazzes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>endpoint<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// è¢«@ServerEndpoint("/xxx/xxx")æ³¨è§£çš„POJO</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>clazz<span class="token punctuation">.</span><span class="token function">isAnnotationPresent</span><span class="token punctuation">(</span>ServerEndpoint<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    scannedPojoEndpoints<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ReflectiveOperationException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServletException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// è¿‡æ»¤ç»“æœ</span>
        Set<span class="token operator">&lt;</span>ServerEndpointConfig<span class="token operator">></span> filteredEndpointConfigs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Set<span class="token operator">&lt;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>></span> filteredPojoEndpoints <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ²¡æœ‰å®ç°äº†ServerApplicationConfigçš„ç±»</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>serverApplicationConfigs<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ç›´æ¥åŠ å…¥è¢«@ServerEndpoint("/xxx/xxx")æ³¨è§£çš„ç±»</span>
            filteredPojoEndpoints<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>scannedPojoEndpoints<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// æœ‰</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// éå†</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>ServerApplicationConfig config <span class="token operator">:</span> serverApplicationConfigs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// è·å–æ·»åŠ çš„å®ç°äº†Endpointæ¥å£çš„ç±»çš„é…ç½®</span>
                Set<span class="token operator">&lt;</span>ServerEndpointConfig<span class="token operator">></span> configFilteredEndpoints <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">getEndpointConfigs</span><span class="token punctuation">(</span>scannedEndpointClazzes<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>configFilteredEndpoints <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å®ç°äº†Endpointæ¥å£çš„Endpointé…ç½®</span>
                    filteredEndpointConfigs<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>configFilteredEndpoints<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                Set<span class="token operator">&lt;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>></span> configFilteredPojos <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">getAnnotatedEndpointClasses</span><span class="token punctuation">(</span>scannedPojoEndpoints<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>configFilteredPojos <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// è¢«@ServerEndpointæ³¨è§£çš„POJO</span>
                    filteredPojoEndpoints<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>configFilteredPojos<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Deploy endpoints</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>ServerEndpointConfig config <span class="token operator">:</span> filteredEndpointConfigs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                sc<span class="token punctuation">.</span><span class="token function">addEndpoint</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// Deploy POJOs</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> clazz <span class="token operator">:</span> filteredPojoEndpoints<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                sc<span class="token punctuation">.</span><span class="token function">addEndpoint</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">DeploymentException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServletException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> WsServerContainer <span class="token function">init</span><span class="token punctuation">(</span>ServletContext servletContext<span class="token punctuation">,</span> <span class="token keyword">boolean</span> initBySciMechanism<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//</span>
        WsServerContainer sc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WsServerContainer</span><span class="token punctuation">(</span>servletContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
        servletContext<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>Constants<span class="token punctuation">.</span>SERVER_CONTAINER_SERVLET_CONTEXT_ATTRIBUTE<span class="token punctuation">,</span> sc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        servletContext<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WsSessionListener</span><span class="token punctuation">(</span>sc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Can't register the ContextListener again if the ContextListener is calling this method</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>initBySciMechanism<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            servletContext<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WsContextListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> sc<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span></code></pre>
<p>WsServerContainer</p>
<pre class=" language-java"><code class="language-java">    <span class="token function">WsServerContainer</span><span class="token punctuation">(</span>ServletContext servletContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>servletContext <span class="token operator">=</span> servletContext<span class="token punctuation">;</span>
        <span class="token function">setInstanceManager</span><span class="token punctuation">(</span><span class="token punctuation">(</span>InstanceManager<span class="token punctuation">)</span> servletContext<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span>InstanceManager<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Configure servlet context wide defaults</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// åŠ¨æ€æ³¨å†ŒFilter</span>
        FilterRegistration<span class="token punctuation">.</span>Dynamic fr <span class="token operator">=</span> servletContext<span class="token punctuation">.</span><span class="token function">addFilter</span><span class="token punctuation">(</span><span class="token string">"Tomcat WebSocket (JSR356) Filter"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">WsFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fr<span class="token punctuation">.</span><span class="token function">setAsyncSupported</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        EnumSet<span class="token operator">&lt;</span>DispatcherType<span class="token operator">></span> types <span class="token operator">=</span> EnumSet<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>DispatcherType<span class="token punctuation">.</span>REQUEST<span class="token punctuation">,</span> DispatcherType<span class="token punctuation">.</span>FORWARD<span class="token punctuation">)</span><span class="token punctuation">;</span>
        fr<span class="token punctuation">.</span><span class="token function">addMappingForUrlPatterns</span><span class="token punctuation">(</span>types<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">"/*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>HTTPåè®®å…è®¸å°†ä¸€ä¸ªå·²å»ºç«‹çš„è¿æ¥å‡çº§æˆæ–°çš„åè®®ï¼Œé€šå¸¸ç”±å®¢æˆ·ç«¯å‘èµ·ï¼Œä¹Ÿå¯ä»¥æœåŠ¡ç«¯å‘èµ·ã€‚</p>
<p>è¿æ¥ä»¥æ™®é€šåè®®å¯åŠ¨ï¼ˆå¦‚HTTP/1.1ï¼‰ï¼Œå†å‡çº§åˆ°HTTP/2.0æˆ–WebSocketã€‚</p>
<p>å¦‚æœæœåŠ¡å™¨å†³å®šå‡çº§è¿™æ¬¡è¿æ¥ï¼Œå°±ä¼šè¿”å›Switching Protocolså“åº”çŠ¶æ€ç 101ï¼Œå’Œä¸€ä¸ªè¦åˆ‡æ¢åˆ°çš„åè®®çš„å¤´éƒ¨å­—æ®µUpgradeã€‚</p>
<p>å¦‚æœæœåŠ¡å™¨æ²¡æœ‰ï¼ˆæˆ–è€…ä¸èƒ½ï¼‰å‡çº§è¿™æ¬¡è¿æ¥ï¼Œå®ƒä¼šå¿½ç•¥å®¢æˆ·ç«¯å‘é€çš„Upgradeå¤´éƒ¨å­—æ®µï¼Œè¿”å›ä¸€ä¸ªå¸¸è§„çš„å“åº”ï¼šä¾‹å¦‚OKå“åº”çŠ¶æ€ç 200ã€‚</p>
<p>æœåŠ¡åœ¨å‘é€101çŠ¶æ€ç ä¹‹åï¼Œå°±å¯ä»¥ä½¿ç”¨æ–°çš„åè®®ï¼Œå¹¶å¯ä»¥æ ¹æ®éœ€è¦æ‰§è¡Œä»»ä½•å…¶ä»–åè®®æŒ‡å®šçš„æ¡æ‰‹ã€‚</p>
<p>ä¸€æ—¦è¿™æ¬¡å‡çº§å®Œæˆäº†ï¼Œè¿æ¥å°±å˜æˆäº†åŒå‘ç®¡é“ã€‚</p>
<p>è¯¦æƒ…å‚è€ƒ<a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Protocol_upgrade_mechanism" target="_blank" rel="noopener">MDN</a>ã€‚</p>
<p>AbstractProtocol$ConnectionHandler#process</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> SocketState <span class="token function">process</span><span class="token punctuation">(</span>SocketWrapperBase<span class="token operator">&lt;</span>S<span class="token operator">></span> wrapper<span class="token punctuation">,</span> SocketEvent status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ç¬¬ä¸€æ¬¡ï¼Œæ²¡æœ‰å…³è”</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>processor <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>processor <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// è¿˜æ²¡æœ‰ï¼Œå¯èƒ½æ˜¯å¯¹è±¡æ± ç”¨å®Œäº†</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>processor <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// ...</span>
                <span class="token comment" spellcheck="true">// å…³è”Socketå’ŒProcessor</span>
                connections<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span> processor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                SocketState state <span class="token operator">=</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å¾ªç¯å¤„ç†ç›´åˆ°å®Œæˆåè®®å‡çº§</span>
                <span class="token keyword">do</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å¤„ç†HTTP/HTTPS/WS/WSS</span>
                    state <span class="token operator">=</span> processor<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>UPGRADING<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// å‡çº§åè®®é˜¶æ®µ</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>UPGRADING<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment" spellcheck="true">// ç­‰å¾…ï¼Œå¤„ç†åŠåŒ…ï¼ˆæ²¡æœ‰è¯»å®Œï¼‰</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>LONG<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// ä¿æŒSocketæ‰“å¼€ï¼Œä¸€èˆ¬æ˜¯ä¸€ä¸ªKeepAliveçš„HTTPè¯·æ±‚å¤„ç†å®Œåçš„çŠ¶æ€</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>OPEN<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>SENDFILE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// å·²å®Œæˆåè®®å‡çº§</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>UPGRADED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>SUSPENDED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// è¿”å›çŠ¶æ€ï¼Œåšå¯¹åº”å¤„ç†</span>
                <span class="token keyword">return</span> state<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span>SocketException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ProtocolException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">OutOfMemoryError</span> oome<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// å…³é—­è¿æ¥</span>
            <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>AbstractProcessorLight#process</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> SocketState <span class="token function">process</span><span class="token punctuation">(</span>SocketWrapperBase<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> socketWrapper<span class="token punctuation">,</span> SocketEvent status<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// é»˜è®¤å¤„ç†ç»“æœ</span>
        SocketState state <span class="token operator">=</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¼‚æ­¥Servletçš„Listeneréé˜»å¡è¯»å†™ï¼Œåœ¨ServletInputStream#setReadListeneræˆ–ServletInputStream#setWriteListeneræ—¶æ·»åŠ </span>
        Iterator<span class="token operator">&lt;</span>DispatchType<span class="token operator">></span> dispatches <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>dispatches <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> SocketEvent<span class="token punctuation">.</span>DISCONNECT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Do nothing here, just wait for it to get recycled</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span><span class="token comment" spellcheck="true">/*å·²å‡çº§WebSocket/HTTP/2.0*/</span> <span class="token function">isUpgrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>ASYNC_END<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> SocketEvent<span class="token punctuation">.</span>OPEN_WRITE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                state <span class="token operator">=</span> SocketState<span class="token punctuation">.</span>LONG<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ä¸€èˆ¬çš„HTTPè¯·æ±‚</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> SocketEvent<span class="token punctuation">.</span>OPEN_READ<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                state <span class="token operator">=</span> <span class="token function">service</span><span class="token punctuation">(</span>socketWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> SocketEvent<span class="token punctuation">.</span>CONNECT_FAIL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                state <span class="token operator">=</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">!=</span> SocketState<span class="token punctuation">.</span>CLOSED <span class="token operator">&amp;&amp;</span> <span class="token function">isAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>dispatches <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token operator">!</span>dispatches<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>ASYNC_END <span class="token operator">||</span> dispatches <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> state <span class="token operator">!=</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>Http11Processor#service</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> SocketState <span class="token function">service</span><span class="token punctuation">(</span>SocketWrapperBase<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> socketWrapper<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// ä¸€ç›´è§£æï¼Œå¾ªç¯å¤„ç†ä¸€ä¸ªè¿æ¥çš„å¤šä¸ªHTTPè¯·æ±‚</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getErrorState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// æ²¡æœ‰é”™è¯¯</span>
                <span class="token operator">&amp;&amp;</span> keepAlive <span class="token comment" spellcheck="true">// ä¿æŒè¿æ¥</span>
                <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// éå¼‚æ­¥</span>
                <span class="token operator">&amp;&amp;</span> upgradeToken <span class="token operator">==</span> null <span class="token comment" spellcheck="true">// æ²¡æœ‰UpgradeToken</span>
                <span class="token operator">&amp;&amp;</span> sendfileState <span class="token operator">==</span> SendfileState<span class="token punctuation">.</span>DONE <span class="token comment" spellcheck="true">// å‘é€æ–‡ä»¶å®Œæˆ</span>
                <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>protocol<span class="token punctuation">.</span><span class="token function">isPaused</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// æ²¡è¢«æš‚åœ</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getErrorState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isIoAllowed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token comment" spellcheck="true">// å¤„ç†è§£æå¥½çš„è¯·æ±‚ï¼Œæœ€åè°ƒç”¨Servletå¤„ç†</span>
                    <span class="token function">getAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedIOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">HeadersTooLargeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å·²è·³å‡ºwhileå¾ªç¯</span>
        rp<span class="token punctuation">.</span><span class="token function">setStage</span><span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>coyote<span class="token punctuation">.</span>Constants<span class="token punctuation">.</span>STAGE_ENDED<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æœ‰å¼‚å¸¸ || æš‚åœ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getErrorState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> protocol<span class="token punctuation">.</span><span class="token function">isPaused</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// éœ€è¦å…³é—­</span>
            <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å¼‚æ­¥çŠ¶æ€</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>LONG<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å­˜åœ¨UpgradeToken</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUpgrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ­£åœ¨å‡çº§åè®®</span>
            <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>UPGRADING<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å…¶å®ƒ</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ–‡ä»¶ä¼ è¾“ä¸­</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sendfileState <span class="token operator">==</span> SendfileState<span class="token punctuation">.</span>PENDING<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>SENDFILE<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å…¶å®ƒè¯·æ±‚</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ä¿æŒSocketæ‰“å¼€</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>openSocket<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// è¯·æ±‚å¤´è¯»å®Œ</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>readComplete<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// è¡¨ç¤ºéœ€è¦ä¿æŒè¿æ¥æ‰“å¼€ï¼Œé‡æ–°æ³¨å†Œå¯è¯»äº‹ä»¶ï¼Œæ¥å—ä¸‹ä¸€ä¸ªè¯·æ±‚</span>
                        <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>OPEN<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// è¿˜æœ‰æ•°æ®æ²¡æ”¶åˆ°</span>
                    <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// éœ€è¦ç­‰å¾…ï¼Œé‡æ–°æ³¨å†Œå¯è¯»äº‹ä»¶</span>
                        <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>LONG<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// éœ€è¦å…³é—­</span>
                    <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>æ³¨æ„Tomcatå‡çº§HTTP/2.0å’Œå‡çº§WebSocketçš„å¤„ç†æœ‰äº›ä¸ä¸€æ ·ï¼ŒHTTP/2.0çš„å‡çº§è¯·æ±‚åœ¨è¿™é‡ŒProcessorå¤„ç†ï¼Œè€ŒWebSocketçš„å‡çº§è¯·æ±‚è¦è¿›å…¥åˆ°Filteræ¥å¤„ç†ã€‚</p>
<p>CoyoteAdapter#service</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">service</span><span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>coyote<span class="token punctuation">.</span>Request req<span class="token punctuation">,</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>coyote<span class="token punctuation">.</span>Response res<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è§£æRequestï¼Œä¸»è¦æ˜¯URIè§£ç ï¼Œå¹¶ä¸”æ ¹æ®URIæ˜ å°„å¯¹åº”çš„è°ƒç”¨é“¾</span>
            postParseSuccess <span class="token operator">=</span> <span class="token function">postParseRequest</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> request<span class="token punctuation">,</span> res<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>postParseSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
                connector<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Ignore</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>WsFilter#doFilter</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span>ServletRequest request<span class="token punctuation">,</span> ServletResponse response<span class="token punctuation">,</span> FilterChain chain<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException<span class="token punctuation">,</span> ServletException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// æ²¡æœ‰@ServerEndpointæ³¨è§£çš„POJO || æ²¡æœ‰upgradeè¯·æ±‚å¤´çš„HTTPè¯·æ±‚</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sc<span class="token punctuation">.</span><span class="token function">areEndpointsRegistered</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>UpgradeUtil<span class="token punctuation">.</span><span class="token function">isWebSocketUpgradeRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è¿™ä¸ªFilteråªå¤„ç†WebSocketå‡çº§è¯·æ±‚ï¼Œç›´æ¥æ”¾è¡Œ</span>
            chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// æ£€æŸ¥æœ‰æ²¡æœ‰å¯¹åº”çš„è·¯å¾„æ˜ å°„</span>
        WsMappingResult mappingResult <span class="token operator">=</span> sc<span class="token punctuation">.</span><span class="token function">findMapping</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mappingResult <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ²¡æœ‰å°±æ”¾è¿‡</span>
            chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å¤„ç†å‡çº§ï¼Œä¼ å…¥å¯¹åº”è·¯å¾„çš„ServerEndpointConfig</span>
        UpgradeUtil<span class="token punctuation">.</span><span class="token function">doUpgrade</span><span class="token punctuation">(</span>sc<span class="token punctuation">,</span> req<span class="token punctuation">,</span> resp<span class="token punctuation">,</span> mappingResult<span class="token punctuation">.</span><span class="token function">getConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mappingResult<span class="token punctuation">.</span><span class="token function">getPathParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>UpgradeUtil#doUpgrade</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">doUpgrade</span><span class="token punctuation">(</span>WsServerContainer sc<span class="token punctuation">,</span> HttpServletRequest req<span class="token punctuation">,</span> HttpServletResponse resp<span class="token punctuation">,</span> ServerEndpointConfig sec<span class="token punctuation">,</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> pathParams<span class="token punctuation">)</span> <span class="token keyword">throws</span> ServletException<span class="token punctuation">,</span> IOException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">/*
         * GET ws://localhost:8080/examples/websocket/echoAnnotation HTTP/1.1
         * Host: localhost:8080
         * Upgrade: websocket
         * Connection: Upgrade
         * Sec-WebSocket-Key: 7GD6D4YKAoM/EOXZXgcg8Q==
         * Origin: http://localhost:8080
         * Sec-WebSocket-Version: 13
         * Sec-WebSocket-Extensions: permessage-deflate; client_max_window_bits
         */</span>
        <span class="token comment" spellcheck="true">// æ ¡éªŒå…¶å®ƒè¯·æ±‚å¤´</span>
        String key<span class="token punctuation">;</span>
        String subProtocol <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ²¡æœ‰è¯·æ±‚å¤´Connection: Upgrade</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">headerContainsToken</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> Constants<span class="token punctuation">.</span>CONNECTION_HEADER_NAME<span class="token punctuation">,</span> Constants<span class="token punctuation">.</span>CONNECTION_HEADER_VALUE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 400</span>
            resp<span class="token punctuation">.</span><span class="token function">sendError</span><span class="token punctuation">(</span>HttpServletResponse<span class="token punctuation">.</span>SC_BAD_REQUEST<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// æ²¡æœ‰è¯·æ±‚å¤´Sec-WebSocket-Version: 13</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">headerContainsToken</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> Constants<span class="token punctuation">.</span>WS_VERSION_HEADER_NAME<span class="token punctuation">,</span> Constants<span class="token punctuation">.</span>WS_VERSION_HEADER_VALUE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            resp<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">426</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ç‰ˆæœ¬åå•†Sec-WebSocket-Version: 13</span>
            resp<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span>Constants<span class="token punctuation">.</span>WS_VERSION_HEADER_NAME<span class="token punctuation">,</span> Constants<span class="token punctuation">.</span>WS_VERSION_HEADER_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Sec-WebSocket-Keyï¼ŒBase64ç¼–ç ï¼Œæµè§ˆå™¨éšæœºç”Ÿæˆ</span>
        key <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span>Constants<span class="token punctuation">.</span>WS_KEY_HEADER_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 400</span>
            resp<span class="token punctuation">.</span><span class="token function">sendError</span><span class="token punctuation">(</span>HttpServletResponse<span class="token punctuation">.</span>SC_BAD_REQUEST<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Origin</span>
        String origin <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span>Constants<span class="token punctuation">.</span>ORIGIN_HEADER_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ£€æŸ¥Origin</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sec<span class="token punctuation">.</span><span class="token function">getConfigurator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">checkOrigin</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 403</span>
            resp<span class="token punctuation">.</span><span class="token function">sendError</span><span class="token punctuation">(</span>HttpServletResponse<span class="token punctuation">.</span>SC_FORBIDDEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Sec-WebSocket-Protocolï¼Œå®¢æˆ·ç«¯è¯·æ±‚çš„å­åè®®</span>
        List<span class="token operator">&lt;</span>String<span class="token operator">></span> subProtocols <span class="token operator">=</span> <span class="token function">getTokensFromHeader</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> Constants<span class="token punctuation">.</span>WS_PROTOCOL_HEADER_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
        subProtocol <span class="token operator">=</span> sec<span class="token punctuation">.</span><span class="token function">getConfigurator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getNegotiatedSubprotocol</span><span class="token punctuation">(</span>sec<span class="token punctuation">.</span><span class="token function">getSubprotocols</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> subProtocols<span class="token punctuation">)</span><span class="token punctuation">;</span>
        List<span class="token operator">&lt;</span>Extension<span class="token operator">></span> extensionsRequested <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Sec-WebSocket-Extensions</span>
        Enumeration<span class="token operator">&lt;</span>String<span class="token operator">></span> extHeaders <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span>Constants<span class="token punctuation">.</span>WS_EXTENSIONS_HEADER_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>extHeaders<span class="token punctuation">.</span><span class="token function">hasMoreElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Util<span class="token punctuation">.</span><span class="token function">parseExtensionHeader</span><span class="token punctuation">(</span>extensionsRequested<span class="token punctuation">,</span> extHeaders<span class="token punctuation">.</span><span class="token function">nextElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Negotiation</span>
        <span class="token comment" spellcheck="true">// åå•†é˜¶æ®µä¸€ï¼Œé»˜è®¤åªè¿‡æ»¤æœåŠ¡å™¨ä¸æ”¯æŒçš„æ‰©å±•</span>
        List<span class="token operator">&lt;</span>Extension<span class="token operator">></span> installedExtensions <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sec<span class="token punctuation">.</span><span class="token function">getExtensions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            installedExtensions <span class="token operator">=</span> Constants<span class="token punctuation">.</span>INSTALLED_EXTENSIONS<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            installedExtensions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            installedExtensions<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>sec<span class="token punctuation">.</span><span class="token function">getExtensions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            installedExtensions<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>Constants<span class="token punctuation">.</span>INSTALLED_EXTENSIONS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        List<span class="token operator">&lt;</span>Extension<span class="token operator">></span> negotiatedExtensionsPhase1 <span class="token operator">=</span> sec<span class="token punctuation">.</span><span class="token function">getConfigurator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getNegotiatedExtensions</span><span class="token punctuation">(</span>installedExtensions<span class="token punctuation">,</span> extensionsRequested<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// åå•†é˜¶æ®µäºŒï¼Œåˆ›å»ºåº”ç”¨äºæ­¤è¿æ¥çš„Transformationsï¼Œæ³¨æ„æ‰©å±•ä¼šè¢«ä¸¢å¼ƒï¼Œå¦‚æœå®¢æˆ·ç«¯è¯·æ±‚ä¸€ä¸ªä¸æ”¯æŒçš„é…ç½®</span>
        List<span class="token operator">&lt;</span>Transformation<span class="token operator">></span> transformations <span class="token operator">=</span> <span class="token function">createTransformations</span><span class="token punctuation">(</span>negotiatedExtensionsPhase1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        List<span class="token operator">&lt;</span>Extension<span class="token operator">></span> negotiatedExtensionsPhase2<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>transformations<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            negotiatedExtensionsPhase2 <span class="token operator">=</span> Collections<span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            negotiatedExtensionsPhase2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>transformations<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>Transformation t <span class="token operator">:</span> transformations<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                negotiatedExtensionsPhase2<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">getExtensionResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// åˆ›å»ºTransformationçš„Pipeline</span>
        Transformation transformation <span class="token operator">=</span> null<span class="token punctuation">;</span>
        StringBuilder responseHeaderExtensions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> first <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>Transformation t <span class="token operator">:</span> transformations<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>first<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                first <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                responseHeaderExtensions<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">append</span><span class="token punctuation">(</span>responseHeaderExtensions<span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">getExtensionResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>transformation <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                transformation <span class="token operator">=</span> t<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                transformation<span class="token punctuation">.</span><span class="token function">setNext</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Now we have the full pipeline, validate the use of the RSV bits.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>transformation <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>transformation<span class="token punctuation">.</span><span class="token function">validateRsvBits</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServletException</span><span class="token punctuation">(</span>sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"upgradeUtil.incompatibleRsv"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">/*
         * HTTP/1.1 101 Switching Protocols
         * Upgrade: websocket
         * Connection: Upgrade
         * Sec-WebSocket-Accept: 8Vp4zz5QXzkDr+gYQ4wNuSiqVj4=
         * Sec-WebSocket-Extensions: permessage-deflate;client_max_window_bits=15
         */</span>
        <span class="token comment" spellcheck="true">// å¦‚æœåˆ°äº†è¿™é‡Œï¼Œæ¥å—è¿æ¥</span>
        <span class="token comment" spellcheck="true">// Upgrade: websocket</span>
        resp<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span>Constants<span class="token punctuation">.</span>UPGRADE_HEADER_NAME<span class="token punctuation">,</span> Constants<span class="token punctuation">.</span>UPGRADE_HEADER_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Connection: Upgrade</span>
        resp<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span>Constants<span class="token punctuation">.</span>CONNECTION_HEADER_NAME<span class="token punctuation">,</span> Constants<span class="token punctuation">.</span>CONNECTION_HEADER_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Sec-WebSocket-Acceptï¼Œæ ¹æ®å®¢æˆ·ç«¯è¯·æ±‚å¤´çš„Sec-WebSocket-KeyåŠ å¯†</span>
        resp<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span>HandshakeResponse<span class="token punctuation">.</span>SEC_WEBSOCKET_ACCEPT<span class="token punctuation">,</span> <span class="token function">getWebSocketAccept</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>subProtocol <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> subProtocol<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Sec-WebSocket-Protocolï¼Œæœ€ç»ˆä½¿ç”¨çš„åè®®</span>
            resp<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span>Constants<span class="token punctuation">.</span>WS_PROTOCOL_HEADER_NAME<span class="token punctuation">,</span> subProtocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>transformations<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Sec-WebSocket-Extensions</span>
            resp<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span>Constants<span class="token punctuation">.</span>WS_EXTENSIONS_HEADER_NAME<span class="token punctuation">,</span> responseHeaderExtensions<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// åŒ…å«äº†è¯·æ±‚çš„å‚æ•°ï¼Œpathï¼Œparameterç­‰ç­‰</span>
        WsHandshakeRequest wsRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WsHandshakeRequest</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> pathParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
        WsHandshakeResponse wsResponse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WsHandshakeResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        WsPerSessionServerEndpointConfig perSessionServerEndpointConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WsPerSessionServerEndpointConfig</span><span class="token punctuation">(</span>sec<span class="token punctuation">)</span><span class="token punctuation">;</span>
        sec<span class="token punctuation">.</span><span class="token function">getConfigurator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">modifyHandshake</span><span class="token punctuation">(</span>perSessionServerEndpointConfig<span class="token punctuation">,</span> wsRequest<span class="token punctuation">,</span> wsResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
        wsRequest<span class="token punctuation">.</span><span class="token function">finished</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Add any additional headers</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>Entry<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> List<span class="token operator">&lt;</span>String<span class="token operator">>></span> entry <span class="token operator">:</span> wsResponse<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>String headerValue <span class="token operator">:</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                resp<span class="token punctuation">.</span><span class="token function">addHeader</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> headerValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        Endpoint ep<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ServerEndpointConfig</span>
            Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> clazz <span class="token operator">=</span> sec<span class="token punctuation">.</span><span class="token function">getEndpointClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å®ç°äº†Endpointæ¥å£</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>Endpoint<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// DefaultServerEndpointConfigurator#getEndpointInstanceåå°„å®ä¾‹åŒ–</span>
                ep <span class="token operator">=</span> <span class="token punctuation">(</span>Endpoint<span class="token punctuation">)</span> sec<span class="token punctuation">.</span><span class="token function">getConfigurator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEndpointInstance</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// è¢«@ServerEndpointæ³¨è§£</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å†…éƒ¨å®ç°äº†onOpenæ–¹æ³•ï¼Œåœ¨onOpenæ—¶åå°„å®ä¾‹åŒ–POJO</span>
                ep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PojoEndpointServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// Need to make path params available to POJO</span>
                perSessionServerEndpointConfig<span class="token punctuation">.</span><span class="token function">getUserProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>tomcat<span class="token punctuation">.</span>websocket<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span>Constants<span class="token punctuation">.</span>POJO_PATH_PARAM_KEY<span class="token punctuation">,</span> pathParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InstantiationException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServletException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// org.apache.catalina.connector.Request#upgrade</span>
        WsHttpUpgradeHandler wsHandler <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">upgrade</span><span class="token punctuation">(</span>WsHttpUpgradeHandler<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// åˆå§‹åŒ–WsHttpUpgradeHandlerå®ä¾‹çš„ä¸€äº›å±æ€§ï¼Œå¦‚Endpointç­‰ç­‰</span>
        wsHandler<span class="token punctuation">.</span><span class="token function">preInit</span><span class="token punctuation">(</span>ep<span class="token punctuation">,</span> perSessionServerEndpointConfig<span class="token punctuation">,</span> sc<span class="token punctuation">,</span> wsRequest<span class="token punctuation">,</span> negotiatedExtensionsPhase2<span class="token punctuation">,</span> subProtocol<span class="token punctuation">,</span> transformation<span class="token punctuation">,</span> pathParams<span class="token punctuation">,</span> req<span class="token punctuation">.</span><span class="token function">isSecure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span></code></pre>
<p>org.apache.catalina.connector.Request#upgrade</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token operator">&lt;</span>T <span class="token keyword">extends</span> <span class="token class-name">HttpUpgradeHandler</span><span class="token operator">></span> T <span class="token function">upgrade</span><span class="token punctuation">(</span>Class<span class="token operator">&lt;</span>T<span class="token operator">></span> httpUpgradeHandlerClass<span class="token punctuation">)</span> <span class="token keyword">throws</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>IOException<span class="token punctuation">,</span> ServletException <span class="token punctuation">{</span>
        T handler<span class="token punctuation">;</span>
        InstanceManager instanceManager <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// åå°„å®ä¾‹åŒ–ï¼Œä¸éœ€è¦æ³¨å…¥</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>InternalHttpUpgradeHandler<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>httpUpgradeHandlerClass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                handler <span class="token operator">=</span> httpUpgradeHandlerClass<span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                instanceManager <span class="token operator">=</span> <span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInstanceManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                handler <span class="token operator">=</span> <span class="token punctuation">(</span>T<span class="token punctuation">)</span> instanceManager<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>httpUpgradeHandlerClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ReflectiveOperationException</span> <span class="token operator">|</span> NamingException <span class="token operator">|</span> IllegalArgumentException <span class="token operator">|</span> SecurityException e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServletException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ç”ŸæˆUpgradeTokenï¼ŒåŒ…å«äº†Handlerå®ä¾‹</span>
        UpgradeToken upgradeToken <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UpgradeToken</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> <span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> instanceManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Http11Processor#doHttpUpgradeï¼Œè®¾ç½®UpgradeToken</span>
        coyoteRequest<span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span>ActionCode<span class="token punctuation">.</span>UPGRADE<span class="token punctuation">,</span> upgradeToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 101 åˆ‡æ¢åè®®</span>
        response<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span>HttpServletResponse<span class="token punctuation">.</span>SC_SWITCHING_PROTOCOLS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> handler<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>Http11Processor#service</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> SocketState <span class="token function">service</span><span class="token punctuation">(</span>SocketWrapperBase<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> socketWrapper<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// ä¸€ç›´è§£æï¼Œå¾ªç¯å¤„ç†ä¸€ä¸ªè¿æ¥çš„å¤šä¸ªHTTPè¯·æ±‚</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getErrorState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// æ²¡æœ‰é”™è¯¯</span>
                <span class="token operator">&amp;&amp;</span> keepAlive <span class="token comment" spellcheck="true">// ä¿æŒè¿æ¥</span>
                <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// éå¼‚æ­¥</span>
                <span class="token operator">&amp;&amp;</span> upgradeToken <span class="token operator">==</span> null <span class="token comment" spellcheck="true">// æ²¡æœ‰UpgradeToken</span>
                <span class="token operator">&amp;&amp;</span> sendfileState <span class="token operator">==</span> SendfileState<span class="token punctuation">.</span>DONE <span class="token comment" spellcheck="true">// å‘é€æ–‡ä»¶å®Œæˆ</span>
                <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>protocol<span class="token punctuation">.</span><span class="token function">isPaused</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// æ²¡è¢«æš‚åœ</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å·²è·³å‡ºwhileå¾ªç¯</span>
        rp<span class="token punctuation">.</span><span class="token function">setStage</span><span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>coyote<span class="token punctuation">.</span>Constants<span class="token punctuation">.</span>STAGE_ENDED<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æœ‰å¼‚å¸¸ || æš‚åœ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getErrorState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> protocol<span class="token punctuation">.</span><span class="token function">isPaused</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// éœ€è¦å…³é—­</span>
            <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å¼‚æ­¥çŠ¶æ€</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>LONG<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å­˜åœ¨UpgradeToken</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUpgrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ­£åœ¨å‡çº§åè®®</span>
            <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>UPGRADING<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å…¶å®ƒ</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ–‡ä»¶ä¼ è¾“ä¸­</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sendfileState <span class="token operator">==</span> SendfileState<span class="token punctuation">.</span>PENDING<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>SENDFILE<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å…¶å®ƒè¯·æ±‚</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ä¿æŒSocketæ‰“å¼€</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>openSocket<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// è¯·æ±‚å¤´è¯»å®Œ</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>readComplete<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// è¡¨ç¤ºéœ€è¦ä¿æŒè¿æ¥æ‰“å¼€ï¼Œé‡æ–°æ³¨å†Œå¯è¯»äº‹ä»¶ï¼Œæ¥å—ä¸‹ä¸€ä¸ªè¯·æ±‚</span>
                        <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>OPEN<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// è¿˜æœ‰æ•°æ®æ²¡æ”¶åˆ°</span>
                    <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// éœ€è¦ç­‰å¾…ï¼Œé‡æ–°æ³¨å†Œå¯è¯»äº‹ä»¶</span>
                        <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>LONG<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// éœ€è¦å…³é—­</span>
                    <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>è¿™é‡Œä¼šè¿”å›çŠ¶æ€SocketState.UPGRADINGã€‚</p>
<p>AbstractProcessorLight#process</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> SocketState <span class="token function">process</span><span class="token punctuation">(</span>SocketWrapperBase<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> socketWrapper<span class="token punctuation">,</span> SocketEvent status<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>ASYNC_END <span class="token operator">||</span> dispatches <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> state <span class="token operator">!=</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>AbstractProtocol$ConnectionHandler#process</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> SocketState <span class="token function">process</span><span class="token punctuation">(</span>SocketWrapperBase<span class="token operator">&lt;</span>S<span class="token operator">></span> wrapper<span class="token punctuation">,</span> SocketEvent status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
                SocketState state <span class="token operator">=</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å¾ªç¯å¤„ç†ç›´åˆ°å®Œæˆåè®®å‡çº§</span>
                <span class="token keyword">do</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å¤„ç†HTTP/HTTPS/WS/WSS</span>
                    state <span class="token operator">=</span> processor<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>UPGRADING<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// è·å–ç”Ÿæˆçš„UpgradeToken</span>
                        UpgradeToken upgradeToken <span class="token operator">=</span> processor<span class="token punctuation">.</span><span class="token function">getUpgradeToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// ä»Http11Processorçš„Http11InputBufferå–å›æœªè¯»çš„ç¼“å†²</span>
                        ByteBuffer leftOverInput <span class="token operator">=</span> processor<span class="token punctuation">.</span><span class="token function">getLeftoverInput</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// å¦‚æœæ²¡æœ‰UpgradeTokenå¯¹è±¡</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>upgradeToken <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// ...</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment" spellcheck="true">// æœ‰UpgradeTokenå¯¹è±¡</span>
                        <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            HttpUpgradeHandler httpUpgradeHandler <span class="token operator">=</span> upgradeToken<span class="token punctuation">.</span><span class="token function">getHttpUpgradeHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// é‡Šæ”¾é‡ç½®æ—§çš„Processor</span>
                            <span class="token function">release</span><span class="token punctuation">(</span>processor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// åˆ›å»ºæ–°çš„æ›¿ä»£ï¼ŒWebSocketè¿”å›çš„æ˜¯UpgradeProcessorInternal</span>
                            processor <span class="token operator">=</span> <span class="token function">getProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createUpgradeProcessor</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">,</span> upgradeToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token function">getLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span>sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"abstractConnectionHandler.upgradeCreate"</span><span class="token punctuation">,</span> processor<span class="token punctuation">,</span> wrapper<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            <span class="token comment" spellcheck="true">// å°†æœªè¯»ç¼“å†²æ”¾å›Socketçš„è¯»ç¼“å†²</span>
                            wrapper<span class="token punctuation">.</span><span class="token function">unRead</span><span class="token punctuation">(</span>leftOverInput<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// æ ‡è®°è¿æ¥å·²å‡çº§</span>
                            wrapper<span class="token punctuation">.</span><span class="token function">setUpgraded</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// å…³è”Socketå’Œæ–°çš„Processor</span>
                            connections<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span> processor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// WebSocketèµ°è¿™è¾¹</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>upgradeToken<span class="token punctuation">.</span><span class="token function">getInstanceManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token comment" spellcheck="true">// WsHttpUpgradeHandler#init</span>
                                httpUpgradeHandler<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">(</span>WebConnection<span class="token punctuation">)</span> processor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                                ClassLoader oldCL <span class="token operator">=</span> upgradeToken<span class="token punctuation">.</span><span class="token function">getContextBind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                                    httpUpgradeHandler<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">(</span>WebConnection<span class="token punctuation">)</span> processor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                                    upgradeToken<span class="token punctuation">.</span><span class="token function">getContextBind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unbind</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> oldCL<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>httpUpgradeHandler <span class="token keyword">instanceof</span> <span class="token class-name">InternalHttpUpgradeHandler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token comment" spellcheck="true">// ...</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// å‡çº§åè®®é˜¶æ®µ</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>UPGRADING<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment" spellcheck="true">// ç­‰å¾…ï¼Œå¤„ç†åŠåŒ…ï¼ˆæ²¡æœ‰è¯»å®Œï¼‰</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>LONG<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// ä¿æŒSocketæ‰“å¼€ï¼Œä¸€èˆ¬æ˜¯ä¸€ä¸ªKeepAliveçš„HTTPè¯·æ±‚å¤„ç†å®Œåçš„çŠ¶æ€</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>OPEN<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>SENDFILE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// å·²å®Œæˆåè®®å‡çº§</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>UPGRADED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>SUSPENDED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// è¿”å›çŠ¶æ€ï¼Œåšå¯¹åº”å¤„ç†</span>
                <span class="token keyword">return</span> state<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span>SocketException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ProtocolException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">OutOfMemoryError</span> oome<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// å…³é—­è¿æ¥</span>
            <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>è¿™é‡Œä¼šç”¨æ–°çš„Processorï¼ŒUpgradeProcessorInternalå…³è”Socketï¼Œæ­¤æ—¶è¿˜æ²¡æœ‰å®Œæˆå‡çº§ã€‚</p>
<p>WsHttpUpgradeHandler#init</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span>WebConnection connection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ep <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"wsHttpUpgradeHandler.noPreInit"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        String httpSessionId <span class="token operator">=</span> null<span class="token punctuation">;</span>
        Object session <span class="token operator">=</span> handshakeRequest<span class="token punctuation">.</span><span class="token function">getHttpSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>session <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            httpSessionId <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>HttpSession<span class="token punctuation">)</span> session<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        Thread t <span class="token operator">=</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ClassLoader cl <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">getContextClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// applicationClassLoaderæ˜¯åå°„å®ä¾‹åŒ–WsHttpUpgradeHandlerçš„çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼Œå³Webappçš„ç±»åŠ è½½å™¨</span>
        t<span class="token punctuation">.</span><span class="token function">setContextClassLoader</span><span class="token punctuation">(</span>applicationClassLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            wsRemoteEndpointServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WsRemoteEndpointImplServer</span><span class="token punctuation">(</span>socketWrapper<span class="token punctuation">,</span> webSocketContainer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            wsSession <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WsSession</span><span class="token punctuation">(</span>ep<span class="token punctuation">,</span> wsRemoteEndpointServer<span class="token punctuation">,</span> webSocketContainer<span class="token punctuation">,</span> handshakeRequest<span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> handshakeRequest<span class="token punctuation">.</span><span class="token function">getParameterMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> handshakeRequest<span class="token punctuation">.</span><span class="token function">getQueryString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> handshakeRequest<span class="token punctuation">.</span><span class="token function">getUserPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> httpSessionId<span class="token punctuation">,</span> negotiatedExtensions<span class="token punctuation">,</span> subProtocol<span class="token punctuation">,</span> pathParameters<span class="token punctuation">,</span> secure<span class="token punctuation">,</span> serverEndpointConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
            wsFrame <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WsFrameServer</span><span class="token punctuation">(</span>socketWrapper<span class="token punctuation">,</span> wsSession<span class="token punctuation">,</span> transformation<span class="token punctuation">,</span> applicationClassLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
            wsRemoteEndpointServer<span class="token punctuation">.</span><span class="token function">setTransformation</span><span class="token punctuation">(</span>wsFrame<span class="token punctuation">.</span><span class="token function">getTransformation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è°ƒç”¨Endpoint#onOpenæ–¹æ³•ï¼Œæ³¨è§£æ–¹å¼æ˜¯PojoEndpointServeråŒ…è£¹è°ƒç”¨</span>
            ep<span class="token punctuation">.</span><span class="token function">onOpen</span><span class="token punctuation">(</span>wsSession<span class="token punctuation">,</span> serverEndpointConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ³¨å†ŒSession</span>
            webSocketContainer<span class="token punctuation">.</span><span class="token function">registerSession</span><span class="token punctuation">(</span>serverEndpointConfig<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> wsSession<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">DeploymentException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æœ€åè®¾å›å»</span>
            t<span class="token punctuation">.</span><span class="token function">setContextClassLoader</span><span class="token punctuation">(</span>cl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>å½“æœ‰æ–°çš„æ•°æ®åˆ°è¾¾æ—¶ï¼š</p>
<p>AbstractProcessorLight#process</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> SocketState <span class="token function">process</span><span class="token punctuation">(</span>SocketWrapperBase<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> socketWrapper<span class="token punctuation">,</span> SocketEvent status<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// é»˜è®¤å¤„ç†ç»“æœ</span>
        SocketState state <span class="token operator">=</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¼‚æ­¥Servletçš„Listeneréé˜»å¡è¯»å†™ï¼Œåœ¨ServletInputStream#setReadListeneræˆ–ServletInputStream#setWriteListeneræ—¶æ·»åŠ </span>
        Iterator<span class="token operator">&lt;</span>DispatchType<span class="token operator">></span> dispatches <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>dispatches <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> SocketEvent<span class="token punctuation">.</span>DISCONNECT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Do nothing here, just wait for it to get recycled</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span><span class="token comment" spellcheck="true">/*å·²å‡çº§WebSocket/HTTP/2.0*/</span> <span class="token function">isUpgrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>ASYNC_END<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ä»¥WebSocketä¸ºä¾‹ï¼Œè¿™é‡Œæ˜¯è°ƒç”¨UpgradeProcessorInternal#dispatch -> WsHttpUpgradeHandler#upgradeDispatch</span>
                state <span class="token operator">=</span> <span class="token function">dispatch</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// WebSocketå‡çº§å®Œæˆåï¼Œæ¯æ¬¡æ”¶åˆ°æ¶ˆæ¯è¿”å›çš„çŠ¶æ€éƒ½æ˜¯SocketState.UPGRADED</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>OPEN<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å¯èƒ½è¿™ä¸ªSocketè¿˜æœ‰Pipelineæ’é˜Ÿçš„æ•°æ®ï¼Œå¦‚æœç°åœ¨ä¸å¤„ç†æ•°æ®ï¼Œä¼šé€€å‡ºå½“å‰å¾ªç¯å¹¶è°ƒç”¨é‡Šæ”¾å›æ”¶Processorå’Œç¼“å†²ï¼Œè¿™æ ·ä¼šåˆ é™¤æ‰€æœ‰çš„Pipelineæ’é˜Ÿçš„æ•°æ®</span>
                    <span class="token comment" spellcheck="true">// ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œç°åœ¨å¤„ç†å®ƒ</span>
                    state <span class="token operator">=</span> <span class="token function">service</span><span class="token punctuation">(</span>socketWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> SocketEvent<span class="token punctuation">.</span>OPEN_WRITE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                state <span class="token operator">=</span> SocketState<span class="token punctuation">.</span>LONG<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> SocketEvent<span class="token punctuation">.</span>OPEN_READ<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> SocketEvent<span class="token punctuation">.</span>CONNECT_FAIL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                state <span class="token operator">=</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">!=</span> SocketState<span class="token punctuation">.</span>CLOSED <span class="token operator">&amp;&amp;</span> <span class="token function">isAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>dispatches <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token operator">!</span>dispatches<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>ASYNC_END <span class="token operator">||</span> dispatches <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> state <span class="token operator">!=</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>å¤„ç†å®Œè¿™æ¬¡è¯·æ±‚åï¼Œé‡æ–°æ³¨å†Œå¯è¯»äº‹ä»¶ï¼Œä¸‹æ¬¡å¯è¯»äº‹ä»¶åˆ°æ¥æ—¶åˆ†å‘ç»™å·¥ä½œçº¿ç¨‹ï¼Œå°±ç”±å‡çº§åçš„Processorç»§ç»­å¤„ç†ã€‚</p>
<p>AbstractProtocol$ConnectionHandler#process</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> SocketState <span class="token function">process</span><span class="token punctuation">(</span>SocketWrapperBase<span class="token operator">&lt;</span>S<span class="token operator">></span> wrapper<span class="token punctuation">,</span> SocketEvent status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
                SocketState state <span class="token operator">=</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å¾ªç¯å¤„ç†ç›´åˆ°å®Œæˆåè®®å‡çº§</span>
                <span class="token keyword">do</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å¤„ç†HTTP/HTTPS/WS/WSS</span>
                    state <span class="token operator">=</span> processor<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>UPGRADING<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// å‡çº§åè®®é˜¶æ®µ</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>UPGRADING<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment" spellcheck="true">// ç­‰å¾…ï¼Œå¤„ç†åŠåŒ…ï¼ˆæ²¡æœ‰è¯»å®Œï¼‰</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>LONG<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// ä¿æŒSocketæ‰“å¼€ï¼Œä¸€èˆ¬æ˜¯ä¸€ä¸ªKeepAliveçš„HTTPè¯·æ±‚å¤„ç†å®Œåçš„çŠ¶æ€</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>OPEN<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>SENDFILE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// å·²å®Œæˆåè®®å‡çº§</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>UPGRADED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// åœ¨æœ‰éé˜»å¡å†™çš„æƒ…å†µä¸‹ï¼Œä¸èƒ½å°†Socketæ·»åŠ å›Pollerï¼Œå¦åˆ™Pollerå¯èƒ½ä¼šè§¦å‘å¤šè¯»äº‹ä»¶ï¼Œå¯¼è‡´Connectorå†…çš„çº¿ç¨‹é¥¥é¥¿</span>
                    <span class="token comment" spellcheck="true">// The write() method will add this socket to the poller if necessary.</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">!=</span> SocketEvent<span class="token punctuation">.</span>OPEN_WRITE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// å¦‚æœä¸æ˜¯å¼‚æ­¥è¯·æ±‚ï¼Œå°†Socketæ·»åŠ å›Pollerï¼Œé‡æ–°æ³¨å†Œå¯è¯»äº‹ä»¶</span>
                        <span class="token function">longPoll</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">,</span> processor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// æ·»åŠ å…¥è¶…æ—¶ç­‰å¾…</span>
                        <span class="token function">getProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addWaitingProcessor</span><span class="token punctuation">(</span>processor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>SUSPENDED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// è¿”å›çŠ¶æ€ï¼Œåšå¯¹åº”å¤„ç†</span>
                <span class="token keyword">return</span> state<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span>SocketException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ProtocolException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">OutOfMemoryError</span> oome<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// å…³é—­è¿æ¥</span>
            <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


        <footer>
             
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

        </footer>
    </div>
    <!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
    <script>
        var timeEnd = new Date();
        console.log('è€—æ—¶ï¼š' + (timeEnd - timeStart));
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre').forEach((block) => {
                block.classList.add("line-numbers");
            });
        });
    </script>
    <!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
    <!-- material design -->
    <!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
    <!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
    <!-- toc -->
    <!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
    <!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
    <!-- <script src="/js/main.js"></script> -->
    <script src="/js/prism.js"></script>
</body>
</html>
