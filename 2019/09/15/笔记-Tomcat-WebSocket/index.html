<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
        <script>
            var timeStart = new Date();
        </script>
        
        <title>[笔记]-Tomcat-WebSocket | 🌑🌒🌓🌔🌕🌖🌗🌘</title>
        
        <meta name="author" content="huangzhike">
        
        
        <meta name="description" content="ContextConfig#webConfig
    protected void webConfig() {
        // ...
        if (ok) {
            // 通过ParallelWebappClassLoader以SPI方式加载ServletCon">
        
        
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        
        <meta property="og:title" content="[笔记]-Tomcat-WebSocket"/>
        
        <meta property="og:site_name" content="🌑🌒🌓🌔🌕🌖🌗🌘"/>
        
        
        <!-- favicon -->
        <link rel="icon" type="image/ico" href="/ok.ico" sizes="32x32">
        <meta name="msapplication-TileColor" content="#009688">
        <meta name="msapplication-TileImage" content="/mstile-144x144.ico">
        <meta name="theme-color" content="#009688">
        <!-- favicon end -->
        <!-- <link href="//ok.ico" rel="icon"> -->
        
        <!-- toc -->
        <!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
        <!-- material design -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
        <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
        
        <!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
        <!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
    <meta name="generator" content="Hexo 4.2.1"></head>

<body>
    <nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">菜单</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" title="下一句是：客有可人期不来。小时候，喜欢靠在阳台上，一边吹风，一边看书，喜欢读书吗，骚年？" href="/">书当快意读易尽</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" target="_blank" rel="noopener" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

    <div class="container" >
        <div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[笔记]-Tomcat-WebSocket</h2>
				
				<div>
					<div class="post-time">2019-09-15</div>
				</div>
				
				<div class="article-content">
				<p>ContextConfig#webConfig</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">webConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ok<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 通过ParallelWebappClassLoader以SPI方式加载ServletContainerInitializer实现SCIs，包含Jar包</span>
            <span class="token function">processServletContainerInitializers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 如果上面加载的SCIs有@HandlesTypes注解</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>webXml<span class="token punctuation">.</span><span class="token function">isMetadataComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> typeInitializerMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 处理/WEB-INF/classes下的.class和.jar，处理对应的类</span>
            <span class="token function">processClasses</span><span class="token punctuation">(</span>webXml<span class="token punctuation">,</span> orderedFragments<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// 把所有ServletContainerInitializer的实现类添加到StandardContext的initializers集合</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ok<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>Map<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span>ServletContainerInitializer<span class="token punctuation">,</span> Set<span class="token operator">&lt;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>>></span> entry <span class="token operator">:</span> initializerClassMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    context<span class="token punctuation">.</span><span class="token function">addServletContainerInitializer</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    context<span class="token punctuation">.</span><span class="token function">addServletContainerInitializer</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>META-INF/services/javax.servlet.ServletContainerInitializer</p>
<pre><code>org.apache.tomcat.websocket.server.WsSci</code></pre><p>WsSci</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@HandlesTypes</span><span class="token punctuation">(</span><span class="token punctuation">{</span>ServerEndpoint<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> ServerApplicationConfig<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> Endpoint<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WsSci</span> <span class="token keyword">implements</span> <span class="token class-name">ServletContainerInitializer</span> <span class="token punctuation">{</span>

    <span class="token comment" spellcheck="true">/**
     * 实现Endpoint的两种方式：
     * 使用@ServerEndpoint(value = "/xxx")注解处理类
     * 处理类实现Endpoint接口，并且要有一个配置类实现ServerApplicationConfig接口，并生成添加对应的ServerEndpointConfig
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onStartup</span><span class="token punctuation">(</span>Set<span class="token operator">&lt;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>></span> clazzes<span class="token punctuation">,</span> ServletContext ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> ServletException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 为该ServletContext添加WsFilter，处理升级请求</span>
        WsServerContainer sc <span class="token operator">=</span> <span class="token function">init</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 没有@ServerEndpoint注解，或实现了Endpoint接口，就返回</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>clazzes <span class="token operator">==</span> null <span class="token operator">||</span> clazzes<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Group the discovered classes by type</span>
        Set<span class="token operator">&lt;</span>ServerApplicationConfig<span class="token operator">></span> serverApplicationConfigs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Set<span class="token operator">&lt;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Endpoint</span><span class="token operator">>></span> scannedEndpointClazzes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Set<span class="token operator">&lt;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>></span> scannedPojoEndpoints <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// wsPackage is "javax.websocket."</span>
            String wsPackage <span class="token operator">=</span> ContainerProvider<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            wsPackage <span class="token operator">=</span> wsPackage<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> wsPackage<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> clazz <span class="token operator">:</span> clazzes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> modifiers <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getModifiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Modifier<span class="token punctuation">.</span><span class="token function">isPublic</span><span class="token punctuation">(</span>modifiers<span class="token punctuation">)</span> <span class="token operator">||</span> Modifier<span class="token punctuation">.</span><span class="token function">isAbstract</span><span class="token punctuation">(</span>modifiers<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// Non-public or abstract - skip it.</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// Protect against scanning the WebSocket API JARs</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>clazz<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>wsPackage<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 实例化实现了ServerApplicationConfig的类</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ServerApplicationConfig<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    serverApplicationConfigs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ServerApplicationConfig<span class="token punctuation">)</span> clazz<span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 实现了Endpoint接口的Endpoint</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>Endpoint<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Endpoint</span><span class="token operator">></span> endpoint <span class="token operator">=</span> <span class="token punctuation">(</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Endpoint</span><span class="token operator">></span><span class="token punctuation">)</span> clazz<span class="token punctuation">;</span>
                    scannedEndpointClazzes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>endpoint<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 被@ServerEndpoint("/xxx/xxx")注解的POJO</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>clazz<span class="token punctuation">.</span><span class="token function">isAnnotationPresent</span><span class="token punctuation">(</span>ServerEndpoint<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    scannedPojoEndpoints<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ReflectiveOperationException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServletException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 过滤结果</span>
        Set<span class="token operator">&lt;</span>ServerEndpointConfig<span class="token operator">></span> filteredEndpointConfigs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Set<span class="token operator">&lt;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>></span> filteredPojoEndpoints <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 没有实现了ServerApplicationConfig的类</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>serverApplicationConfigs<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 直接加入被@ServerEndpoint("/xxx/xxx")注解的类</span>
            filteredPojoEndpoints<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>scannedPojoEndpoints<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 有</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 遍历</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>ServerApplicationConfig config <span class="token operator">:</span> serverApplicationConfigs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 获取添加的实现了Endpoint接口的类的配置</span>
                Set<span class="token operator">&lt;</span>ServerEndpointConfig<span class="token operator">></span> configFilteredEndpoints <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">getEndpointConfigs</span><span class="token punctuation">(</span>scannedEndpointClazzes<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>configFilteredEndpoints <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 实现了Endpoint接口的Endpoint配置</span>
                    filteredEndpointConfigs<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>configFilteredEndpoints<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                Set<span class="token operator">&lt;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>></span> configFilteredPojos <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">getAnnotatedEndpointClasses</span><span class="token punctuation">(</span>scannedPojoEndpoints<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>configFilteredPojos <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 被@ServerEndpoint注解的POJO</span>
                    filteredPojoEndpoints<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>configFilteredPojos<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Deploy endpoints</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>ServerEndpointConfig config <span class="token operator">:</span> filteredEndpointConfigs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                sc<span class="token punctuation">.</span><span class="token function">addEndpoint</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// Deploy POJOs</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> clazz <span class="token operator">:</span> filteredPojoEndpoints<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                sc<span class="token punctuation">.</span><span class="token function">addEndpoint</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">DeploymentException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServletException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> WsServerContainer <span class="token function">init</span><span class="token punctuation">(</span>ServletContext servletContext<span class="token punctuation">,</span> <span class="token keyword">boolean</span> initBySciMechanism<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//</span>
        WsServerContainer sc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WsServerContainer</span><span class="token punctuation">(</span>servletContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
        servletContext<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>Constants<span class="token punctuation">.</span>SERVER_CONTAINER_SERVLET_CONTEXT_ATTRIBUTE<span class="token punctuation">,</span> sc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        servletContext<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WsSessionListener</span><span class="token punctuation">(</span>sc<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Can't register the ContextListener again if the ContextListener is calling this method</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>initBySciMechanism<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            servletContext<span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WsContextListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> sc<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span></code></pre>
<p>WsServerContainer</p>
<pre class=" language-java"><code class="language-java">    <span class="token function">WsServerContainer</span><span class="token punctuation">(</span>ServletContext servletContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>servletContext <span class="token operator">=</span> servletContext<span class="token punctuation">;</span>
        <span class="token function">setInstanceManager</span><span class="token punctuation">(</span><span class="token punctuation">(</span>InstanceManager<span class="token punctuation">)</span> servletContext<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span>InstanceManager<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Configure servlet context wide defaults</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// 动态注册Filter</span>
        FilterRegistration<span class="token punctuation">.</span>Dynamic fr <span class="token operator">=</span> servletContext<span class="token punctuation">.</span><span class="token function">addFilter</span><span class="token punctuation">(</span><span class="token string">"Tomcat WebSocket (JSR356) Filter"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">WsFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fr<span class="token punctuation">.</span><span class="token function">setAsyncSupported</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        EnumSet<span class="token operator">&lt;</span>DispatcherType<span class="token operator">></span> types <span class="token operator">=</span> EnumSet<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>DispatcherType<span class="token punctuation">.</span>REQUEST<span class="token punctuation">,</span> DispatcherType<span class="token punctuation">.</span>FORWARD<span class="token punctuation">)</span><span class="token punctuation">;</span>
        fr<span class="token punctuation">.</span><span class="token function">addMappingForUrlPatterns</span><span class="token punctuation">(</span>types<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">"/*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>HTTP协议允许将一个已建立的连接升级成新的协议，通常由客户端发起，也可以服务端发起。</p>
<p>连接以普通协议启动（如HTTP/1.1），再升级到HTTP/2.0或WebSocket。</p>
<p>如果服务器决定升级这次连接，就会返回Switching Protocols响应状态码101，和一个要切换到的协议的头部字段Upgrade。</p>
<p>如果服务器没有（或者不能）升级这次连接，它会忽略客户端发送的Upgrade头部字段，返回一个常规的响应：例如OK响应状态码200。</p>
<p>服务在发送101状态码之后，就可以使用新的协议，并可以根据需要执行任何其他协议指定的握手。</p>
<p>一旦这次升级完成了，连接就变成了双向管道。</p>
<p>详情参考<a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Protocol_upgrade_mechanism" target="_blank" rel="noopener">MDN</a>。</p>
<p>AbstractProtocol$ConnectionHandler#process</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> SocketState <span class="token function">process</span><span class="token punctuation">(</span>SocketWrapperBase<span class="token operator">&lt;</span>S<span class="token operator">></span> wrapper<span class="token punctuation">,</span> SocketEvent status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 第一次，没有关联</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>processor <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>processor <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 还没有，可能是对象池用完了</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>processor <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// ...</span>
                <span class="token comment" spellcheck="true">// 关联Socket和Processor</span>
                connections<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span> processor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                SocketState state <span class="token operator">=</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 循环处理直到完成协议升级</span>
                <span class="token keyword">do</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 处理HTTP/HTTPS/WS/WSS</span>
                    state <span class="token operator">=</span> processor<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>UPGRADING<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 升级协议阶段</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>UPGRADING<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment" spellcheck="true">// 等待，处理半包（没有读完）</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>LONG<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 保持Socket打开，一般是一个KeepAlive的HTTP请求处理完后的状态</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>OPEN<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>SENDFILE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 已完成协议升级</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>UPGRADED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>SUSPENDED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 返回状态，做对应处理</span>
                <span class="token keyword">return</span> state<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span>SocketException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ProtocolException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">OutOfMemoryError</span> oome<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// 关闭连接</span>
            <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>AbstractProcessorLight#process</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> SocketState <span class="token function">process</span><span class="token punctuation">(</span>SocketWrapperBase<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> socketWrapper<span class="token punctuation">,</span> SocketEvent status<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 默认处理结果</span>
        SocketState state <span class="token operator">=</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 异步Servlet的Listener非阻塞读写，在ServletInputStream#setReadListener或ServletInputStream#setWriteListener时添加</span>
        Iterator<span class="token operator">&lt;</span>DispatchType<span class="token operator">></span> dispatches <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>dispatches <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> SocketEvent<span class="token punctuation">.</span>DISCONNECT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Do nothing here, just wait for it to get recycled</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span><span class="token comment" spellcheck="true">/*已升级WebSocket/HTTP/2.0*/</span> <span class="token function">isUpgrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>ASYNC_END<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> SocketEvent<span class="token punctuation">.</span>OPEN_WRITE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                state <span class="token operator">=</span> SocketState<span class="token punctuation">.</span>LONG<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 一般的HTTP请求</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> SocketEvent<span class="token punctuation">.</span>OPEN_READ<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                state <span class="token operator">=</span> <span class="token function">service</span><span class="token punctuation">(</span>socketWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> SocketEvent<span class="token punctuation">.</span>CONNECT_FAIL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                state <span class="token operator">=</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">!=</span> SocketState<span class="token punctuation">.</span>CLOSED <span class="token operator">&amp;&amp;</span> <span class="token function">isAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>dispatches <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token operator">!</span>dispatches<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>ASYNC_END <span class="token operator">||</span> dispatches <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> state <span class="token operator">!=</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>Http11Processor#service</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> SocketState <span class="token function">service</span><span class="token punctuation">(</span>SocketWrapperBase<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> socketWrapper<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// 一直解析，循环处理一个连接的多个HTTP请求</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getErrorState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 没有错误</span>
                <span class="token operator">&amp;&amp;</span> keepAlive <span class="token comment" spellcheck="true">// 保持连接</span>
                <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 非异步</span>
                <span class="token operator">&amp;&amp;</span> upgradeToken <span class="token operator">==</span> null <span class="token comment" spellcheck="true">// 没有UpgradeToken</span>
                <span class="token operator">&amp;&amp;</span> sendfileState <span class="token operator">==</span> SendfileState<span class="token punctuation">.</span>DONE <span class="token comment" spellcheck="true">// 发送文件完成</span>
                <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>protocol<span class="token punctuation">.</span><span class="token function">isPaused</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 没被暂停</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getErrorState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isIoAllowed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token comment" spellcheck="true">// 处理解析好的请求，最后调用Servlet处理</span>
                    <span class="token function">getAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedIOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">HeadersTooLargeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 已跳出while循环</span>
        rp<span class="token punctuation">.</span><span class="token function">setStage</span><span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>coyote<span class="token punctuation">.</span>Constants<span class="token punctuation">.</span>STAGE_ENDED<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 有异常 || 暂停</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getErrorState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> protocol<span class="token punctuation">.</span><span class="token function">isPaused</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 需要关闭</span>
            <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 异步状态</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>LONG<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 存在UpgradeToken</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUpgrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 正在升级协议</span>
            <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>UPGRADING<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 其它</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 文件传输中</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sendfileState <span class="token operator">==</span> SendfileState<span class="token punctuation">.</span>PENDING<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>SENDFILE<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 其它请求</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 保持Socket打开</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>openSocket<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 请求头读完</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>readComplete<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 表示需要保持连接打开，重新注册可读事件，接受下一个请求</span>
                        <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>OPEN<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// 还有数据没收到</span>
                    <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 需要等待，重新注册可读事件</span>
                        <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>LONG<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 需要关闭</span>
                    <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>注意Tomcat升级HTTP/2.0和升级WebSocket的处理有些不一样，HTTP/2.0的升级请求在这里Processor处理，而WebSocket的升级请求要进入到Filter来处理。</p>
<p>CoyoteAdapter#service</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">service</span><span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>coyote<span class="token punctuation">.</span>Request req<span class="token punctuation">,</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>coyote<span class="token punctuation">.</span>Response res<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 解析Request，主要是URI解码，并且根据URI映射对应的调用链</span>
            postParseSuccess <span class="token operator">=</span> <span class="token function">postParseRequest</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> request<span class="token punctuation">,</span> res<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>postParseSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
                connector<span class="token punctuation">.</span><span class="token function">getService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Ignore</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>WsFilter#doFilter</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFilter</span><span class="token punctuation">(</span>ServletRequest request<span class="token punctuation">,</span> ServletResponse response<span class="token punctuation">,</span> FilterChain chain<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException<span class="token punctuation">,</span> ServletException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 没有@ServerEndpoint注解的POJO || 没有upgrade请求头的HTTP请求</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sc<span class="token punctuation">.</span><span class="token function">areEndpointsRegistered</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>UpgradeUtil<span class="token punctuation">.</span><span class="token function">isWebSocketUpgradeRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 这个Filter只处理WebSocket升级请求，直接放行</span>
            chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// 检查有没有对应的路径映射</span>
        WsMappingResult mappingResult <span class="token operator">=</span> sc<span class="token punctuation">.</span><span class="token function">findMapping</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mappingResult <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 没有就放过</span>
            chain<span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 处理升级，传入对应路径的ServerEndpointConfig</span>
        UpgradeUtil<span class="token punctuation">.</span><span class="token function">doUpgrade</span><span class="token punctuation">(</span>sc<span class="token punctuation">,</span> req<span class="token punctuation">,</span> resp<span class="token punctuation">,</span> mappingResult<span class="token punctuation">.</span><span class="token function">getConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mappingResult<span class="token punctuation">.</span><span class="token function">getPathParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>UpgradeUtil#doUpgrade</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">doUpgrade</span><span class="token punctuation">(</span>WsServerContainer sc<span class="token punctuation">,</span> HttpServletRequest req<span class="token punctuation">,</span> HttpServletResponse resp<span class="token punctuation">,</span> ServerEndpointConfig sec<span class="token punctuation">,</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> pathParams<span class="token punctuation">)</span> <span class="token keyword">throws</span> ServletException<span class="token punctuation">,</span> IOException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">/*
         * GET ws://localhost:8080/examples/websocket/echoAnnotation HTTP/1.1
         * Host: localhost:8080
         * Upgrade: websocket
         * Connection: Upgrade
         * Sec-WebSocket-Key: 7GD6D4YKAoM/EOXZXgcg8Q==
         * Origin: http://localhost:8080
         * Sec-WebSocket-Version: 13
         * Sec-WebSocket-Extensions: permessage-deflate; client_max_window_bits
         */</span>
        <span class="token comment" spellcheck="true">// 校验其它请求头</span>
        String key<span class="token punctuation">;</span>
        String subProtocol <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 没有请求头Connection: Upgrade</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">headerContainsToken</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> Constants<span class="token punctuation">.</span>CONNECTION_HEADER_NAME<span class="token punctuation">,</span> Constants<span class="token punctuation">.</span>CONNECTION_HEADER_VALUE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 400</span>
            resp<span class="token punctuation">.</span><span class="token function">sendError</span><span class="token punctuation">(</span>HttpServletResponse<span class="token punctuation">.</span>SC_BAD_REQUEST<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 没有请求头Sec-WebSocket-Version: 13</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">headerContainsToken</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> Constants<span class="token punctuation">.</span>WS_VERSION_HEADER_NAME<span class="token punctuation">,</span> Constants<span class="token punctuation">.</span>WS_VERSION_HEADER_VALUE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            resp<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">426</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 版本协商Sec-WebSocket-Version: 13</span>
            resp<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span>Constants<span class="token punctuation">.</span>WS_VERSION_HEADER_NAME<span class="token punctuation">,</span> Constants<span class="token punctuation">.</span>WS_VERSION_HEADER_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Sec-WebSocket-Key，Base64编码，浏览器随机生成</span>
        key <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span>Constants<span class="token punctuation">.</span>WS_KEY_HEADER_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 400</span>
            resp<span class="token punctuation">.</span><span class="token function">sendError</span><span class="token punctuation">(</span>HttpServletResponse<span class="token punctuation">.</span>SC_BAD_REQUEST<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Origin</span>
        String origin <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span>Constants<span class="token punctuation">.</span>ORIGIN_HEADER_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 检查Origin</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sec<span class="token punctuation">.</span><span class="token function">getConfigurator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">checkOrigin</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 403</span>
            resp<span class="token punctuation">.</span><span class="token function">sendError</span><span class="token punctuation">(</span>HttpServletResponse<span class="token punctuation">.</span>SC_FORBIDDEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Sec-WebSocket-Protocol，客户端请求的子协议</span>
        List<span class="token operator">&lt;</span>String<span class="token operator">></span> subProtocols <span class="token operator">=</span> <span class="token function">getTokensFromHeader</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> Constants<span class="token punctuation">.</span>WS_PROTOCOL_HEADER_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
        subProtocol <span class="token operator">=</span> sec<span class="token punctuation">.</span><span class="token function">getConfigurator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getNegotiatedSubprotocol</span><span class="token punctuation">(</span>sec<span class="token punctuation">.</span><span class="token function">getSubprotocols</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> subProtocols<span class="token punctuation">)</span><span class="token punctuation">;</span>
        List<span class="token operator">&lt;</span>Extension<span class="token operator">></span> extensionsRequested <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Sec-WebSocket-Extensions</span>
        Enumeration<span class="token operator">&lt;</span>String<span class="token operator">></span> extHeaders <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span>Constants<span class="token punctuation">.</span>WS_EXTENSIONS_HEADER_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>extHeaders<span class="token punctuation">.</span><span class="token function">hasMoreElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Util<span class="token punctuation">.</span><span class="token function">parseExtensionHeader</span><span class="token punctuation">(</span>extensionsRequested<span class="token punctuation">,</span> extHeaders<span class="token punctuation">.</span><span class="token function">nextElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Negotiation</span>
        <span class="token comment" spellcheck="true">// 协商阶段一，默认只过滤服务器不支持的扩展</span>
        List<span class="token operator">&lt;</span>Extension<span class="token operator">></span> installedExtensions <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sec<span class="token punctuation">.</span><span class="token function">getExtensions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            installedExtensions <span class="token operator">=</span> Constants<span class="token punctuation">.</span>INSTALLED_EXTENSIONS<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            installedExtensions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            installedExtensions<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>sec<span class="token punctuation">.</span><span class="token function">getExtensions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            installedExtensions<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>Constants<span class="token punctuation">.</span>INSTALLED_EXTENSIONS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        List<span class="token operator">&lt;</span>Extension<span class="token operator">></span> negotiatedExtensionsPhase1 <span class="token operator">=</span> sec<span class="token punctuation">.</span><span class="token function">getConfigurator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getNegotiatedExtensions</span><span class="token punctuation">(</span>installedExtensions<span class="token punctuation">,</span> extensionsRequested<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 协商阶段二，创建应用于此连接的Transformations，注意扩展会被丢弃，如果客户端请求一个不支持的配置</span>
        List<span class="token operator">&lt;</span>Transformation<span class="token operator">></span> transformations <span class="token operator">=</span> <span class="token function">createTransformations</span><span class="token punctuation">(</span>negotiatedExtensionsPhase1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        List<span class="token operator">&lt;</span>Extension<span class="token operator">></span> negotiatedExtensionsPhase2<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>transformations<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            negotiatedExtensionsPhase2 <span class="token operator">=</span> Collections<span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            negotiatedExtensionsPhase2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>transformations<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>Transformation t <span class="token operator">:</span> transformations<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                negotiatedExtensionsPhase2<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">getExtensionResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 创建Transformation的Pipeline</span>
        Transformation transformation <span class="token operator">=</span> null<span class="token punctuation">;</span>
        StringBuilder responseHeaderExtensions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> first <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>Transformation t <span class="token operator">:</span> transformations<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>first<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                first <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                responseHeaderExtensions<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">append</span><span class="token punctuation">(</span>responseHeaderExtensions<span class="token punctuation">,</span> t<span class="token punctuation">.</span><span class="token function">getExtensionResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>transformation <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                transformation <span class="token operator">=</span> t<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                transformation<span class="token punctuation">.</span><span class="token function">setNext</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Now we have the full pipeline, validate the use of the RSV bits.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>transformation <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>transformation<span class="token punctuation">.</span><span class="token function">validateRsvBits</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServletException</span><span class="token punctuation">(</span>sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"upgradeUtil.incompatibleRsv"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">/*
         * HTTP/1.1 101 Switching Protocols
         * Upgrade: websocket
         * Connection: Upgrade
         * Sec-WebSocket-Accept: 8Vp4zz5QXzkDr+gYQ4wNuSiqVj4=
         * Sec-WebSocket-Extensions: permessage-deflate;client_max_window_bits=15
         */</span>
        <span class="token comment" spellcheck="true">// 如果到了这里，接受连接</span>
        <span class="token comment" spellcheck="true">// Upgrade: websocket</span>
        resp<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span>Constants<span class="token punctuation">.</span>UPGRADE_HEADER_NAME<span class="token punctuation">,</span> Constants<span class="token punctuation">.</span>UPGRADE_HEADER_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Connection: Upgrade</span>
        resp<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span>Constants<span class="token punctuation">.</span>CONNECTION_HEADER_NAME<span class="token punctuation">,</span> Constants<span class="token punctuation">.</span>CONNECTION_HEADER_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Sec-WebSocket-Accept，根据客户端请求头的Sec-WebSocket-Key加密</span>
        resp<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span>HandshakeResponse<span class="token punctuation">.</span>SEC_WEBSOCKET_ACCEPT<span class="token punctuation">,</span> <span class="token function">getWebSocketAccept</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>subProtocol <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> subProtocol<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Sec-WebSocket-Protocol，最终使用的协议</span>
            resp<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span>Constants<span class="token punctuation">.</span>WS_PROTOCOL_HEADER_NAME<span class="token punctuation">,</span> subProtocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>transformations<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Sec-WebSocket-Extensions</span>
            resp<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span>Constants<span class="token punctuation">.</span>WS_EXTENSIONS_HEADER_NAME<span class="token punctuation">,</span> responseHeaderExtensions<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 包含了请求的参数，path，parameter等等</span>
        WsHandshakeRequest wsRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WsHandshakeRequest</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> pathParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
        WsHandshakeResponse wsResponse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WsHandshakeResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        WsPerSessionServerEndpointConfig perSessionServerEndpointConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WsPerSessionServerEndpointConfig</span><span class="token punctuation">(</span>sec<span class="token punctuation">)</span><span class="token punctuation">;</span>
        sec<span class="token punctuation">.</span><span class="token function">getConfigurator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">modifyHandshake</span><span class="token punctuation">(</span>perSessionServerEndpointConfig<span class="token punctuation">,</span> wsRequest<span class="token punctuation">,</span> wsResponse<span class="token punctuation">)</span><span class="token punctuation">;</span>
        wsRequest<span class="token punctuation">.</span><span class="token function">finished</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Add any additional headers</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>Entry<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> List<span class="token operator">&lt;</span>String<span class="token operator">>></span> entry <span class="token operator">:</span> wsResponse<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>String headerValue <span class="token operator">:</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                resp<span class="token punctuation">.</span><span class="token function">addHeader</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> headerValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        Endpoint ep<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ServerEndpointConfig</span>
            Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> clazz <span class="token operator">=</span> sec<span class="token punctuation">.</span><span class="token function">getEndpointClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 实现了Endpoint接口</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>Endpoint<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// DefaultServerEndpointConfigurator#getEndpointInstance反射实例化</span>
                ep <span class="token operator">=</span> <span class="token punctuation">(</span>Endpoint<span class="token punctuation">)</span> sec<span class="token punctuation">.</span><span class="token function">getConfigurator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEndpointInstance</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 被@ServerEndpoint注解</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 内部实现了onOpen方法，在onOpen时反射实例化POJO</span>
                ep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PojoEndpointServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// Need to make path params available to POJO</span>
                perSessionServerEndpointConfig<span class="token punctuation">.</span><span class="token function">getUserProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>tomcat<span class="token punctuation">.</span>websocket<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span>Constants<span class="token punctuation">.</span>POJO_PATH_PARAM_KEY<span class="token punctuation">,</span> pathParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InstantiationException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServletException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// org.apache.catalina.connector.Request#upgrade</span>
        WsHttpUpgradeHandler wsHandler <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">upgrade</span><span class="token punctuation">(</span>WsHttpUpgradeHandler<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 初始化WsHttpUpgradeHandler实例的一些属性，如Endpoint等等</span>
        wsHandler<span class="token punctuation">.</span><span class="token function">preInit</span><span class="token punctuation">(</span>ep<span class="token punctuation">,</span> perSessionServerEndpointConfig<span class="token punctuation">,</span> sc<span class="token punctuation">,</span> wsRequest<span class="token punctuation">,</span> negotiatedExtensionsPhase2<span class="token punctuation">,</span> subProtocol<span class="token punctuation">,</span> transformation<span class="token punctuation">,</span> pathParams<span class="token punctuation">,</span> req<span class="token punctuation">.</span><span class="token function">isSecure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span></code></pre>
<p>org.apache.catalina.connector.Request#upgrade</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token operator">&lt;</span>T <span class="token keyword">extends</span> <span class="token class-name">HttpUpgradeHandler</span><span class="token operator">></span> T <span class="token function">upgrade</span><span class="token punctuation">(</span>Class<span class="token operator">&lt;</span>T<span class="token operator">></span> httpUpgradeHandlerClass<span class="token punctuation">)</span> <span class="token keyword">throws</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>IOException<span class="token punctuation">,</span> ServletException <span class="token punctuation">{</span>
        T handler<span class="token punctuation">;</span>
        InstanceManager instanceManager <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 反射实例化，不需要注入</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>InternalHttpUpgradeHandler<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>httpUpgradeHandlerClass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                handler <span class="token operator">=</span> httpUpgradeHandlerClass<span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                instanceManager <span class="token operator">=</span> <span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInstanceManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                handler <span class="token operator">=</span> <span class="token punctuation">(</span>T<span class="token punctuation">)</span> instanceManager<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>httpUpgradeHandlerClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ReflectiveOperationException</span> <span class="token operator">|</span> NamingException <span class="token operator">|</span> IllegalArgumentException <span class="token operator">|</span> SecurityException e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServletException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 生成UpgradeToken，包含了Handler实例</span>
        UpgradeToken upgradeToken <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UpgradeToken</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> <span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> instanceManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Http11Processor#doHttpUpgrade，设置UpgradeToken</span>
        coyoteRequest<span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span>ActionCode<span class="token punctuation">.</span>UPGRADE<span class="token punctuation">,</span> upgradeToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 101 切换协议</span>
        response<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span>HttpServletResponse<span class="token punctuation">.</span>SC_SWITCHING_PROTOCOLS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> handler<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>Http11Processor#service</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> SocketState <span class="token function">service</span><span class="token punctuation">(</span>SocketWrapperBase<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> socketWrapper<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// 一直解析，循环处理一个连接的多个HTTP请求</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getErrorState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 没有错误</span>
                <span class="token operator">&amp;&amp;</span> keepAlive <span class="token comment" spellcheck="true">// 保持连接</span>
                <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 非异步</span>
                <span class="token operator">&amp;&amp;</span> upgradeToken <span class="token operator">==</span> null <span class="token comment" spellcheck="true">// 没有UpgradeToken</span>
                <span class="token operator">&amp;&amp;</span> sendfileState <span class="token operator">==</span> SendfileState<span class="token punctuation">.</span>DONE <span class="token comment" spellcheck="true">// 发送文件完成</span>
                <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>protocol<span class="token punctuation">.</span><span class="token function">isPaused</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 没被暂停</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 已跳出while循环</span>
        rp<span class="token punctuation">.</span><span class="token function">setStage</span><span class="token punctuation">(</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>coyote<span class="token punctuation">.</span>Constants<span class="token punctuation">.</span>STAGE_ENDED<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 有异常 || 暂停</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getErrorState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> protocol<span class="token punctuation">.</span><span class="token function">isPaused</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 需要关闭</span>
            <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 异步状态</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>LONG<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 存在UpgradeToken</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUpgrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 正在升级协议</span>
            <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>UPGRADING<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 其它</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 文件传输中</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sendfileState <span class="token operator">==</span> SendfileState<span class="token punctuation">.</span>PENDING<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>SENDFILE<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 其它请求</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 保持Socket打开</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>openSocket<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 请求头读完</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>readComplete<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 表示需要保持连接打开，重新注册可读事件，接受下一个请求</span>
                        <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>OPEN<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// 还有数据没收到</span>
                    <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 需要等待，重新注册可读事件</span>
                        <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>LONG<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 需要关闭</span>
                    <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>这里会返回状态SocketState.UPGRADING。</p>
<p>AbstractProcessorLight#process</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> SocketState <span class="token function">process</span><span class="token punctuation">(</span>SocketWrapperBase<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> socketWrapper<span class="token punctuation">,</span> SocketEvent status<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>ASYNC_END <span class="token operator">||</span> dispatches <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> state <span class="token operator">!=</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>AbstractProtocol$ConnectionHandler#process</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> SocketState <span class="token function">process</span><span class="token punctuation">(</span>SocketWrapperBase<span class="token operator">&lt;</span>S<span class="token operator">></span> wrapper<span class="token punctuation">,</span> SocketEvent status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
                SocketState state <span class="token operator">=</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 循环处理直到完成协议升级</span>
                <span class="token keyword">do</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 处理HTTP/HTTPS/WS/WSS</span>
                    state <span class="token operator">=</span> processor<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>UPGRADING<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 获取生成的UpgradeToken</span>
                        UpgradeToken upgradeToken <span class="token operator">=</span> processor<span class="token punctuation">.</span><span class="token function">getUpgradeToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// 从Http11Processor的Http11InputBuffer取回未读的缓冲</span>
                        ByteBuffer leftOverInput <span class="token operator">=</span> processor<span class="token punctuation">.</span><span class="token function">getLeftoverInput</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// 如果没有UpgradeToken对象</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>upgradeToken <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// ...</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment" spellcheck="true">// 有UpgradeToken对象</span>
                        <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            HttpUpgradeHandler httpUpgradeHandler <span class="token operator">=</span> upgradeToken<span class="token punctuation">.</span><span class="token function">getHttpUpgradeHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// 释放重置旧的Processor</span>
                            <span class="token function">release</span><span class="token punctuation">(</span>processor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// 创建新的替代，WebSocket返回的是UpgradeProcessorInternal</span>
                            processor <span class="token operator">=</span> <span class="token function">getProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createUpgradeProcessor</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">,</span> upgradeToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token function">getLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span>sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"abstractConnectionHandler.upgradeCreate"</span><span class="token punctuation">,</span> processor<span class="token punctuation">,</span> wrapper<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            <span class="token comment" spellcheck="true">// 将未读缓冲放回Socket的读缓冲</span>
                            wrapper<span class="token punctuation">.</span><span class="token function">unRead</span><span class="token punctuation">(</span>leftOverInput<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// 标记连接已升级</span>
                            wrapper<span class="token punctuation">.</span><span class="token function">setUpgraded</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// 关联Socket和新的Processor</span>
                            connections<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span> processor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// WebSocket走这边</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>upgradeToken<span class="token punctuation">.</span><span class="token function">getInstanceManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token comment" spellcheck="true">// WsHttpUpgradeHandler#init</span>
                                httpUpgradeHandler<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">(</span>WebConnection<span class="token punctuation">)</span> processor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                                ClassLoader oldCL <span class="token operator">=</span> upgradeToken<span class="token punctuation">.</span><span class="token function">getContextBind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                                    httpUpgradeHandler<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">(</span>WebConnection<span class="token punctuation">)</span> processor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                                    upgradeToken<span class="token punctuation">.</span><span class="token function">getContextBind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unbind</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> oldCL<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>httpUpgradeHandler <span class="token keyword">instanceof</span> <span class="token class-name">InternalHttpUpgradeHandler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token comment" spellcheck="true">// ...</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 升级协议阶段</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>UPGRADING<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment" spellcheck="true">// 等待，处理半包（没有读完）</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>LONG<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 保持Socket打开，一般是一个KeepAlive的HTTP请求处理完后的状态</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>OPEN<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>SENDFILE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 已完成协议升级</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>UPGRADED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>SUSPENDED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 返回状态，做对应处理</span>
                <span class="token keyword">return</span> state<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span>SocketException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ProtocolException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">OutOfMemoryError</span> oome<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// 关闭连接</span>
            <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>这里会用新的Processor，UpgradeProcessorInternal关联Socket，此时还没有完成升级。</p>
<p>WsHttpUpgradeHandler#init</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span>WebConnection connection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ep <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"wsHttpUpgradeHandler.noPreInit"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        String httpSessionId <span class="token operator">=</span> null<span class="token punctuation">;</span>
        Object session <span class="token operator">=</span> handshakeRequest<span class="token punctuation">.</span><span class="token function">getHttpSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>session <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            httpSessionId <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>HttpSession<span class="token punctuation">)</span> session<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        Thread t <span class="token operator">=</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ClassLoader cl <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">getContextClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// applicationClassLoader是反射实例化WsHttpUpgradeHandler的线程的上下文类加载器，即Webapp的类加载器</span>
        t<span class="token punctuation">.</span><span class="token function">setContextClassLoader</span><span class="token punctuation">(</span>applicationClassLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            wsRemoteEndpointServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WsRemoteEndpointImplServer</span><span class="token punctuation">(</span>socketWrapper<span class="token punctuation">,</span> webSocketContainer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            wsSession <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WsSession</span><span class="token punctuation">(</span>ep<span class="token punctuation">,</span> wsRemoteEndpointServer<span class="token punctuation">,</span> webSocketContainer<span class="token punctuation">,</span> handshakeRequest<span class="token punctuation">.</span><span class="token function">getRequestURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> handshakeRequest<span class="token punctuation">.</span><span class="token function">getParameterMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> handshakeRequest<span class="token punctuation">.</span><span class="token function">getQueryString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> handshakeRequest<span class="token punctuation">.</span><span class="token function">getUserPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> httpSessionId<span class="token punctuation">,</span> negotiatedExtensions<span class="token punctuation">,</span> subProtocol<span class="token punctuation">,</span> pathParameters<span class="token punctuation">,</span> secure<span class="token punctuation">,</span> serverEndpointConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
            wsFrame <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WsFrameServer</span><span class="token punctuation">(</span>socketWrapper<span class="token punctuation">,</span> wsSession<span class="token punctuation">,</span> transformation<span class="token punctuation">,</span> applicationClassLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
            wsRemoteEndpointServer<span class="token punctuation">.</span><span class="token function">setTransformation</span><span class="token punctuation">(</span>wsFrame<span class="token punctuation">.</span><span class="token function">getTransformation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 调用Endpoint#onOpen方法，注解方式是PojoEndpointServer包裹调用</span>
            ep<span class="token punctuation">.</span><span class="token function">onOpen</span><span class="token punctuation">(</span>wsSession<span class="token punctuation">,</span> serverEndpointConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 注册Session</span>
            webSocketContainer<span class="token punctuation">.</span><span class="token function">registerSession</span><span class="token punctuation">(</span>serverEndpointConfig<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> wsSession<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">DeploymentException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 最后设回去</span>
            t<span class="token punctuation">.</span><span class="token function">setContextClassLoader</span><span class="token punctuation">(</span>cl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>当有新的数据到达时：</p>
<p>AbstractProcessorLight#process</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> SocketState <span class="token function">process</span><span class="token punctuation">(</span>SocketWrapperBase<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> socketWrapper<span class="token punctuation">,</span> SocketEvent status<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 默认处理结果</span>
        SocketState state <span class="token operator">=</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 异步Servlet的Listener非阻塞读写，在ServletInputStream#setReadListener或ServletInputStream#setWriteListener时添加</span>
        Iterator<span class="token operator">&lt;</span>DispatchType<span class="token operator">></span> dispatches <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>dispatches <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> SocketEvent<span class="token punctuation">.</span>DISCONNECT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Do nothing here, just wait for it to get recycled</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span><span class="token comment" spellcheck="true">/*已升级WebSocket/HTTP/2.0*/</span> <span class="token function">isUpgrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>ASYNC_END<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 以WebSocket为例，这里是调用UpgradeProcessorInternal#dispatch -> WsHttpUpgradeHandler#upgradeDispatch</span>
                state <span class="token operator">=</span> <span class="token function">dispatch</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// WebSocket升级完成后，每次收到消息返回的状态都是SocketState.UPGRADED</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>OPEN<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 可能这个Socket还有Pipeline排队的数据，如果现在不处理数据，会退出当前循环并调用释放回收Processor和缓冲，这样会删除所有的Pipeline排队的数据</span>
                    <span class="token comment" spellcheck="true">// 为了避免这种情况，现在处理它</span>
                    state <span class="token operator">=</span> <span class="token function">service</span><span class="token punctuation">(</span>socketWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> SocketEvent<span class="token punctuation">.</span>OPEN_WRITE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                state <span class="token operator">=</span> SocketState<span class="token punctuation">.</span>LONG<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> SocketEvent<span class="token punctuation">.</span>OPEN_READ<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> SocketEvent<span class="token punctuation">.</span>CONNECT_FAIL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                state <span class="token operator">=</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">!=</span> SocketState<span class="token punctuation">.</span>CLOSED <span class="token operator">&amp;&amp;</span> <span class="token function">isAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>dispatches <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token operator">!</span>dispatches<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>ASYNC_END <span class="token operator">||</span> dispatches <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> state <span class="token operator">!=</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>处理完这次请求后，重新注册可读事件，下次可读事件到来时分发给工作线程，就由升级后的Processor继续处理。</p>
<p>AbstractProtocol$ConnectionHandler#process</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> SocketState <span class="token function">process</span><span class="token punctuation">(</span>SocketWrapperBase<span class="token operator">&lt;</span>S<span class="token operator">></span> wrapper<span class="token punctuation">,</span> SocketEvent status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
                SocketState state <span class="token operator">=</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 循环处理直到完成协议升级</span>
                <span class="token keyword">do</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 处理HTTP/HTTPS/WS/WSS</span>
                    state <span class="token operator">=</span> processor<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>UPGRADING<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 升级协议阶段</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>UPGRADING<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment" spellcheck="true">// 等待，处理半包（没有读完）</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>LONG<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 保持Socket打开，一般是一个KeepAlive的HTTP请求处理完后的状态</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>OPEN<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>SENDFILE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 已完成协议升级</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>UPGRADED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 在有非阻塞写的情况下，不能将Socket添加回Poller，否则Poller可能会触发多读事件，导致Connector内的线程饥饿</span>
                    <span class="token comment" spellcheck="true">// The write() method will add this socket to the poller if necessary.</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">!=</span> SocketEvent<span class="token punctuation">.</span>OPEN_WRITE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 如果不是异步请求，将Socket添加回Poller，重新注册可读事件</span>
                        <span class="token function">longPoll</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">,</span> processor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// 添加入超时等待</span>
                        <span class="token function">getProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addWaitingProcessor</span><span class="token punctuation">(</span>processor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> SocketState<span class="token punctuation">.</span>SUSPENDED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 返回状态，做对应处理</span>
                <span class="token keyword">return</span> state<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span>SocketException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ProtocolException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">OutOfMemoryError</span> oome<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// 关闭连接</span>
            <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


        <footer>
             
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

        </footer>
    </div>
    <!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
    <script>
        var timeEnd = new Date();
        console.log('耗时：' + (timeEnd - timeStart));
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre').forEach((block) => {
                block.classList.add("line-numbers");
            });
        });
    </script>
    <!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
    <!-- material design -->
    <!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
    <!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
    <!-- toc -->
    <!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
    <!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
    <!-- <script src="/js/main.js"></script> -->
    <script src="/js/prism.js"></script>
</body>
</html>
