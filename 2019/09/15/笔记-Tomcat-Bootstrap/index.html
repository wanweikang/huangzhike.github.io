<!DOCTYPE HTML>
<html>

<head>
    <script>
        var timeStart = new Date();
    </script>
    <meta charset="utf-8">
    
    <title>[ç¬”è®°]-Tomcat-Bootstrap | Reunion...</title>
    
    <meta name="author" content="huangzhike">
    
    
    <meta name="description"
        content="å…ˆæ¨èä¸€æœ¬ä¹¦ï¼šTomcatæ¶æ„è§£æï¼ˆåˆ˜å…‰ç‘ è‘—ï¼‰ï¼Œä¸æ˜¯ä»€ä¹ˆå¤§éƒ¨å¤´ï¼Œå¾ˆå¿«å°±ç¿»å®Œäº†ã€‚
ç¬¬ä¸€æ¬¡çœ‹Tomcatæºç çš„æ–°äººå¯ä»¥å‚è€ƒè¿™æœ¬ä¹¦ï¼Œä¸ç„¶Tomcatå¤æ‚çš„ç»“æ„å’Œé…ç½®ä¼šè®©ä½ æ»¡å¤´é—®å·ï¼Œå¯æƒœè¿™æœ¬ä¹¦åªæ˜¯çº¯æ–‡å­—è®²è§£ï¼Œä¸è¿‡å·²ç»æ˜¯éå¸¸æœ‰å¸®åŠ©äº†ã€‚
åˆšå¼€å§‹çœ‹çš„æ—¶å€™æ„Ÿè§‰ä¼¼ä¹æœ‰ç‚¹é¡ºåˆ©ï¼Ÿåæ¥çœ‹åˆ°åé¢åè®®å¤„ç†ï¼Œæ€ä¹ˆè¿™ä¹ˆå¤šå¾ªç¯çŠ¶æ€">
    
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta property="og:title" content="[ç¬”è®°]-Tomcat-Bootstrap" />
    
    <meta property="og:site_name" content="Reunion..." />
    
    
    <!-- favicon -->
    <link rel="icon" type="image/ico" href="/logo.ico" sizes="32x32">
    <meta name="msapplication-TileColor" content="#009688">
    <meta name="msapplication-TileImage" content="/mstile-144x144.ico">
    <meta name="theme-color" content="#009688">
    <!-- favicon end -->
    <!-- <link href="//ok.ico" rel="icon"> -->
    

    <!-- <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.5.0/css/bootstrap.min.css" rel="stylesheet"> -->
    <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
    <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
    <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">

<meta name="generator" content="Hexo 4.2.1"></head>
<body>
    <nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">èœå•</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" title="æ—©ãæ¥ã„ã€ã‚¯ãƒ©ã‚¦ãƒ‰" href="/">Reunion...</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" target="_blank" rel="noopener" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

    <div class="container" >
        <div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[ç¬”è®°]-Tomcat-Bootstrap</h2>
				
				<div>
					<div class="post-time">2019-09-15</div>
				</div>
				
				<div class="article-content">
				<p>å…ˆæ¨èä¸€æœ¬ä¹¦ï¼šTomcatæ¶æ„è§£æï¼ˆåˆ˜å…‰ç‘ è‘—ï¼‰ï¼Œä¸æ˜¯ä»€ä¹ˆå¤§éƒ¨å¤´ï¼Œå¾ˆå¿«å°±ç¿»å®Œäº†ã€‚</p>
<p>ç¬¬ä¸€æ¬¡çœ‹Tomcatæºç çš„æ–°äººå¯ä»¥å‚è€ƒè¿™æœ¬ä¹¦ï¼Œä¸ç„¶Tomcatå¤æ‚çš„ç»“æ„å’Œé…ç½®ä¼šè®©ä½ æ»¡å¤´é—®å·ï¼Œå¯æƒœè¿™æœ¬ä¹¦åªæ˜¯çº¯æ–‡å­—è®²è§£ï¼Œä¸è¿‡å·²ç»æ˜¯éå¸¸æœ‰å¸®åŠ©äº†ã€‚</p>
<p>åˆšå¼€å§‹çœ‹çš„æ—¶å€™æ„Ÿè§‰ä¼¼ä¹æœ‰ç‚¹<del>é¡ºåˆ©</del>ï¼Ÿåæ¥çœ‹åˆ°åé¢åè®®å¤„ç†ï¼Œæ€ä¹ˆè¿™ä¹ˆå¤šå¾ªç¯çŠ¶æ€è¿˜æœ‰ç¼“å†²ğŸ˜¬ï¼Ÿ</p>
<p>è¿˜å¥½ä¹‹å‰æœ‰ç‚¹åŸºç¡€ï¼ˆæ‰€ä»¥è¯´åŸºç¡€å¾ˆé‡è¦å•Šï¼‰ï¼Œå¥½æ­¹è¿˜æ˜¯åœ¨è¿›åº¦å†…çœ‹å®Œäº†ã€‚</p>
<p>è¯»æºç æœ€èˆ’æœçš„æ—¶å€™å°±æ˜¯çœ‹å®Œä¹‹åå°˜åŸƒè½å®šï¼Œç”»ä¸Šå¥å·çš„ä¸€åˆ»äº†ï¼Œè™½ç„¶è¿˜æœ‰å¾ˆå¤šåœ°æ–¹æ²¡çœ‹/æ²¡çœ‹æ‡‚ï¼ˆæ¯”å¦‚è½¬å‘å’Œå¼‚æ­¥ï¼‰ï¼Œä½†æ˜¯å·²ç»ä¸æƒ³å†çœ‹äº†ğŸ˜¬ã€‚</p>
<p>ä¸‹ä¸€ä¸ªæºç æ˜¯RocketMQã€‚</p>
<p>Tomcatç‰ˆæœ¬ï¼š9.0.24ï¼Œå› ä¸ºTomcatæºç æ¯”è¾ƒå¤æ‚ï¼Œä¸ºäº†æ–¹ä¾¿é˜…è¯»ï¼Œå¯èƒ½ä¼šçœç•¥ä¸€äº›ä»£ç ã€‚</p>
<hr>
<p>VM Option</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// -Dè®¾ç½®JVMçš„ç³»ç»Ÿå±æ€§ï¼ŒSystem#setPropertyï¼ŒSystem#getProperty</span>
<span class="token comment" spellcheck="true">// å¯ä»¥é€šè¿‡ä¿®æ”¹å¯åŠ¨å‚æ•°å®ç°éƒ¨ç½²å¤šå°é…ç½®ä¸åŒçš„Tomcatçš„Server</span>
<span class="token operator">-</span>Dcatalina<span class="token punctuation">.</span>home<span class="token operator">=</span>catalina<span class="token operator">-</span>home
<span class="token operator">-</span>Dcatalina<span class="token punctuation">.</span>base<span class="token operator">=</span>catalina<span class="token operator">-</span>home
<span class="token operator">-</span>Djava<span class="token punctuation">.</span>endorsed<span class="token punctuation">.</span>dirs<span class="token operator">=</span>catalina<span class="token operator">-</span>home<span class="token operator">/</span>endorsed
<span class="token operator">-</span>Djava<span class="token punctuation">.</span>io<span class="token punctuation">.</span>tmpdir<span class="token operator">=</span>catalina<span class="token operator">-</span>home<span class="token operator">/</span>temp
<span class="token operator">-</span>Duser<span class="token punctuation">.</span>country<span class="token operator">=</span>CN
<span class="token operator">-</span>Duser<span class="token punctuation">.</span>language<span class="token operator">=</span>cn
<span class="token operator">-</span>Djava<span class="token punctuation">.</span>util<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>manager<span class="token operator">=</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>juli<span class="token punctuation">.</span>ClassLoaderLogManager
<span class="token operator">-</span>Djava<span class="token punctuation">.</span>util<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>config<span class="token punctuation">.</span>file<span class="token operator">=</span>catalina<span class="token operator">-</span>home<span class="token operator">/</span>conf<span class="token operator">/</span>logging<span class="token punctuation">.</span>properties</code></pre>
<p>Bootstrap</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// å½“å‰é¡¹ç›®ç›®å½•</span>
        String userDir <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"user.dir"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// catalina.homeç›®å½•</span>
        String home <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span>Globals<span class="token punctuation">.</span>CATALINA_HOME_PROP<span class="token punctuation">)</span><span class="token punctuation">;</span>
        File homeFile <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>home <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            File f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>home<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                homeFile <span class="token operator">=</span> f<span class="token punctuation">.</span><span class="token function">getCanonicalFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ioe<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                homeFile <span class="token operator">=</span> f<span class="token punctuation">.</span><span class="token function">getAbsoluteFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// catalina.homeç›®å½•ä¸å­˜åœ¨</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>homeFile <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ç¬¬ä¸€ä¸ªFallbackï¼Œæ£€æŸ¥å½“å‰é¡¹ç›®ç›®å½•æ˜¯å¦æ˜¯binç›®å½•</span>
            File bootstrapJar <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>userDir<span class="token punctuation">,</span> <span class="token string">"bootstrap.jar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å¦‚æœæ˜¯çš„è¯åˆ™å°è¯•è·å–binçš„ä¸Šä¸€çº§ç›®å½•ä½œä¸ºhomeç›®å½•</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>bootstrapJar<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                File f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>userDir<span class="token punctuation">,</span> <span class="token string">".."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    homeFile <span class="token operator">=</span> f<span class="token punctuation">.</span><span class="token function">getCanonicalFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ioe<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    homeFile <span class="token operator">=</span> f<span class="token punctuation">.</span><span class="token function">getAbsoluteFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// è¿˜æ˜¯ä¸å­˜åœ¨</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>homeFile <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ç¬¬äºŒä¸ªFallbackï¼Œä½¿ç”¨å½“å‰ç›®å½•ä½œä¸ºhomeç›®å½•</span>
            File f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>userDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                homeFile <span class="token operator">=</span> f<span class="token punctuation">.</span><span class="token function">getCanonicalFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ioe<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                homeFile <span class="token operator">=</span> f<span class="token punctuation">.</span><span class="token function">getAbsoluteFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        catalinaHomeFile <span class="token operator">=</span> homeFile<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ›´æ–°è®¾ç½®catalina.homeï¼Œä¸»è¦æ˜¯å­˜æ”¾binå’Œlibï¼Œå…¬ç”¨</span>
        System<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span>Globals<span class="token punctuation">.</span>CATALINA_HOME_PROP<span class="token punctuation">,</span> catalinaHomeFile<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è·å–catalina.baseç›®å½•</span>
        String base <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span>Globals<span class="token punctuation">.</span>CATALINA_BASE_PROP<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>base <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ²¡æœ‰è®¾ç½®å°±ä½¿ç”¨catalina.home</span>
            catalinaBaseFile <span class="token operator">=</span> catalinaHomeFile<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            File baseFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                baseFile <span class="token operator">=</span> baseFile<span class="token punctuation">.</span><span class="token function">getCanonicalFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ioe<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                baseFile <span class="token operator">=</span> baseFile<span class="token punctuation">.</span><span class="token function">getAbsoluteFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            catalinaBaseFile <span class="token operator">=</span> baseFile<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// æ›´æ–°è®¾ç½®catalina.baseï¼Œä¸»è¦æ˜¯å­˜æ”¾é…ç½®åŠæ—¥å¿—ç›®å½•ï¼Œæ¯ä¸ªTomcatå®ä¾‹ä¸€ä¸ª</span>
        System<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span>Globals<span class="token punctuation">.</span>CATALINA_BASE_PROP<span class="token punctuation">,</span> catalinaBaseFile<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>Bootstrap#main</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String args<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>daemonLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>daemon <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Don't set daemon until init() has completed</span>
                Bootstrap bootstrap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// åˆå§‹åŒ–CommonLoaderã€CatalinaLoaderã€SharedLoaderï¼Œå®ä¾‹åŒ–Catalina</span>
                    bootstrap<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                daemon <span class="token operator">=</span> bootstrap<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            String command <span class="token operator">=</span> <span class="token string">"start"</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>command<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"startd"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>command<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"stopd"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>command<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"start"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// åå°„è°ƒç”¨ï¼Œè®¾ç½®ç­‰å¾…æ ‡å¿—ï¼Œç”¨äºæ ‡è®°é€€å‡º</span>
                daemon<span class="token punctuation">.</span><span class="token function">setAwait</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// åå°„è°ƒç”¨ï¼ŒCatalina#load</span>
                daemon<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// åå°„è°ƒç”¨ï¼ŒCatalina#start</span>
                daemon<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">==</span> daemon<span class="token punctuation">.</span><span class="token function">getServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    System<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>command<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"stop"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                daemon<span class="token punctuation">.</span><span class="token function">stopServer</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>command<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"configtest"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>Bootstrap#init</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// åˆå§‹åŒ–ä¸‰ä¸ªç±»åŠ è½½å™¨</span>
        <span class="token function">initClassLoaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è®¾ç½®çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ä¸ºcatalinaLoader</span>
        Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setContextClassLoader</span><span class="token punctuation">(</span>catalinaLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// é€šè¿‡catalinaLoaderæå‰åŠ è½½ä¸€äº›ç±»</span>
        SecurityClassLoad<span class="token punctuation">.</span><span class="token function">securityClassLoad</span><span class="token punctuation">(</span>catalinaLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Load our startup class and call its process() method</span>
        <span class="token comment" spellcheck="true">// æ‰“åŒ…å‘å¸ƒæ—¶ï¼ŒBootstrapåœ¨bin\bootstrap.jarï¼ŒCatalinaåœ¨lib\catalina.jar</span>
        <span class="token comment" spellcheck="true">// Bootstrapç”±AppClassLoaderåŠ è½½ï¼ŒCatalinaç”±CatalinaLoaderåŠ è½½</span>
        Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> startupClass <span class="token operator">=</span> catalinaLoader<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token string">"org.apache.catalina.startup.Catalina"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// åå°„å®ä¾‹åŒ–Catalina</span>
        Object startupInstance <span class="token operator">=</span> startupClass<span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Set the shared extensions class loader</span>
        <span class="token comment" spellcheck="true">// å‡†å¤‡è°ƒç”¨catalinaçš„setParentClassLoaderæ–¹æ³•ï¼Œå³è®¾ç½®sharedLoaderä¸ºcatalinaçš„parentClassLoader</span>
        String methodName <span class="token operator">=</span> <span class="token string">"setParentClassLoader"</span><span class="token punctuation">;</span>
        Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> paramTypes<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ç±»ï¼Œç”±BootstrapClassLoaderåŠ è½½</span>
        paramTypes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> Class<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"java.lang.ClassLoader"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Object paramValues<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å®ä¾‹ï¼ŒsharedLoader</span>
        paramValues<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> sharedLoader<span class="token punctuation">;</span>
        Method method <span class="token operator">=</span> startupInstance<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span>methodName<span class="token punctuation">,</span> paramTypes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// åå°„è°ƒç”¨Catalina#setParentClassLoaderï¼Œè®¾ç½®ä¸ºsharedLoader</span>
        <span class="token comment" spellcheck="true">// æ³¨æ„Catalinaä¸æ˜¯ClassLoaderç±»å‹</span>
        method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>startupInstance<span class="token punctuation">,</span> paramValues<span class="token punctuation">)</span><span class="token punctuation">;</span>
        catalinaDaemon <span class="token operator">=</span> startupInstance<span class="token punctuation">;</span>

    <span class="token punctuation">}</span></code></pre>
<p><img src="/imgs/Tomcat_ClassLoader.png" alt="Tomcat ClassLoader"></p>
<ul>
<li><p>catalina.propertiesä¸­server.loaderï¼Œshared.loaderé»˜è®¤ä¸ºç©ºï¼Œæ‰€ä»¥Commonã€Catalinaã€Sharedæ˜¯åŒä¸€ä¸ªç±»åŠ è½½å™¨</p>
</li>
<li><p>å¦‚æœéœ€è¦åˆ†å¼€ï¼Œå¯ä»¥é…ç½®server.loaderå’Œshared.loaderï¼š</p>
</li>
<li><p>Commonï¼šçˆ¶ç±»åŠ è½½å™¨ä¸ºAppClassLoaderï¼Œå…¨å±€ä½¿ç”¨</p>
</li>
<li><p>Catalinaï¼šçˆ¶ç±»åŠ è½½å™¨ä¸ºCommonClassLoaderï¼ŒåŠ è½½Tomcatåº”ç”¨</p>
</li>
<li><p>Sharedï¼šçˆ¶ç±»åŠ è½½å™¨ä¸ºCommonClassLoaderï¼Œæ‰€æœ‰Webåº”ç”¨çš„çˆ¶ç±»åŠ è½½å™¨</p>
</li>
<li><p>Webappï¼šçˆ¶ç±»åŠ è½½å™¨ä¸ºSharedClassLoaderï¼ŒåŠ è½½/WEB-INF/classes/ï¼Œ/WEB-INF/lib/ï¼Œåªå¯¹å½“å‰Webåº”ç”¨å¯è§</p>
</li>
<li><p>åŒä¸€ä¸ªWebå®¹å™¨ä¸Šä¸¤ä¸ªWebåº”ç”¨åº”è¯¥ç›¸äº’éš”ç¦»ï¼Œä¸èƒ½ç”¨ä¸€ä¸ªç±»åŠ è½½å™¨</p>
</li>
</ul>
<p>Bootstrap#initClassLoaders</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initClassLoaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// åˆ›å»ºcommonLoaderï¼Œé»˜è®¤çˆ¶ç±»åŠ è½½å™¨ä¸ºAppClassLoader</span>
            commonLoader <span class="token operator">=</span> <span class="token function">createClassLoader</span><span class="token punctuation">(</span><span class="token string">"common"</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>commonLoader <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Fallback AppClassLoader</span>
                commonLoader <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// åˆ›å»ºcatalinaLoader</span>
            <span class="token comment" spellcheck="true">// å¦‚æœé…ç½®äº†server.loaderï¼Œåˆ™åˆ›å»ºæ–°çš„ClassLoaderï¼Œçˆ¶ç±»åŠ è½½å™¨ä¸ºcommonLoaderï¼Œå¦åˆ™ç›´æ¥è¿”å›commonLoader</span>
            catalinaLoader <span class="token operator">=</span> <span class="token function">createClassLoader</span><span class="token punctuation">(</span><span class="token string">"server"</span><span class="token punctuation">,</span> commonLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// åˆ›å»ºsharedLoader</span>
            <span class="token comment" spellcheck="true">// å¦‚æœé…ç½®äº†shared.loaderï¼Œåˆ™åˆ›å»ºæ–°çš„ClassLoaderï¼Œçˆ¶ç±»åŠ è½½å™¨ä¸ºcommonLoaderï¼Œå¦åˆ™ç›´æ¥è¿”å›commonLoader</span>
            sharedLoader <span class="token operator">=</span> <span class="token function">createClassLoader</span><span class="token punctuation">(</span><span class="token string">"shared"</span><span class="token punctuation">,</span> commonLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>Bootstrap#createClassLoader</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> ClassLoader <span class="token function">createClassLoader</span><span class="token punctuation">(</span>String name<span class="token punctuation">,</span> ClassLoader parent<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// è§catalina.propertiesé…ç½®ï¼Œé»˜è®¤ä¸å­˜åœ¨ï¼Œç›´æ¥è¿”å›parent</span>
        String value <span class="token operator">=</span> CatalinaProperties<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span>name <span class="token operator">+</span> <span class="token string">".loader"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>value <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> parent<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å°†${catalina.home}å’Œ${catalina.base}æ›¿æ¢æˆçœŸæ­£çš„ä»“åº“è·¯å¾„</span>
        value <span class="token operator">=</span> <span class="token function">replace</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        List<span class="token operator">&lt;</span>Repository<span class="token operator">></span> repositories <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å°†valueåˆ‡åˆ†ä¸ºå¯¹åº”çš„repositoryPaths</span>
        String<span class="token punctuation">[</span><span class="token punctuation">]</span> repositoryPaths <span class="token operator">=</span> <span class="token function">getPaths</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>String repository <span class="token operator">:</span> repositoryPaths<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Check for a JAR URL repository</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unused"</span><span class="token punctuation">)</span> URL url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>repository<span class="token punctuation">)</span><span class="token punctuation">;</span>
                repositories<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Repository</span><span class="token punctuation">(</span>repository<span class="token punctuation">,</span> RepositoryType<span class="token punctuation">.</span>URL<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">MalformedURLException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Ignore</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// Local repository</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>repository<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">"*.jar"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                repository <span class="token operator">=</span> repository<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> repository<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token string">"*.jar"</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                repositories<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Repository</span><span class="token punctuation">(</span>repository<span class="token punctuation">,</span> RepositoryType<span class="token punctuation">.</span>GLOB<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>repository<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">".jar"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                repositories<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Repository</span><span class="token punctuation">(</span>repository<span class="token punctuation">,</span> RepositoryType<span class="token punctuation">.</span>JAR<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                repositories<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Repository</span><span class="token punctuation">(</span>repository<span class="token punctuation">,</span> RepositoryType<span class="token punctuation">.</span>DIR<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// åˆ›å»ºç±»åŠ è½½å™¨ï¼Œç”¨æ¥åŠ è½½Repository</span>
        <span class="token comment" spellcheck="true">// å¦‚æœæŒ‡å®šäº†çˆ¶ç±»åŠ è½½å™¨ï¼Œè®¾ç½®çˆ¶å­å…³ç³»ï¼Œå¦åˆ™è®¾ç½®ä¸ºAppClassLoader</span>
        <span class="token keyword">return</span> ClassLoaderFactory<span class="token punctuation">.</span><span class="token function">createClassLoader</span><span class="token punctuation">(</span>repositories<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>SpringBootæ˜¯é€šè¿‡org.apache.catalina.startup.Tomcatæ¥å¯åŠ¨åµŒå…¥å¼Tomcatçš„ï¼Œå¯åŠ¨Containerçš„æ—¶å€™ä¼šåˆ é™¤Connectorï¼Œé¿å…æå‰å¯åŠ¨ï¼Œæœ€åä¼šæŠŠConnectoråŠ å›å»å¹¶å¯åŠ¨ã€‚</p>
<p>æœ‰å…´è¶£çš„å¯ä»¥è‡ªå·±çœ‹æºç ã€‚</p>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


        <footer>
             
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

        </footer>
    </div>
    <!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
    <script>
        var timeEnd = new Date();
        console.log('è€—æ—¶ï¼š' + (timeEnd - timeStart));
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre').forEach((block) => {
                block.classList.add("line-numbers");
            });
        });
    </script>

    <script src="/js/prism.js"></script>
</body>
</html>
