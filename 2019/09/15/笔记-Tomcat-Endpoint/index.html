<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
        <script>
            var timeStart = new Date();
        </script>
        
        <title>[ç¬”è®°]-Tomcat-Endpoint | ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜</title>
        
        <meta name="author" content="huangzhike">
        
        
        <meta name="description" content="æ¥ä¸Šç¯‡ã€‚

Connector#startInternal
    @Override
    protected void startInternal() throws LifecycleException {
        // ...
        setState(LifecycleSt">
        
        
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        
        <meta property="og:title" content="[ç¬”è®°]-Tomcat-Endpoint"/>
        
        <meta property="og:site_name" content="ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜"/>
        
        
        <!-- favicon -->
        <link rel="icon" type="image/ico" href="/ok.ico" sizes="32x32">
        <meta name="msapplication-TileColor" content="#009688">
        <meta name="msapplication-TileImage" content="/mstile-144x144.ico">
        <meta name="theme-color" content="#009688">
        <!-- favicon end -->
        <!-- <link href="//ok.ico" rel="icon"> -->
        
        <!-- toc -->
        <!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
        <!-- material design -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
        <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
        
        <!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
        <!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
    <meta name="generator" content="Hexo 4.2.1"></head>

<body>
    <nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">èœå•</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" title="ä¸‹ä¸€å¥æ˜¯ï¼šå®¢æœ‰å¯äººæœŸä¸æ¥ã€‚å°æ—¶å€™ï¼Œå–œæ¬¢é åœ¨é˜³å°ä¸Šï¼Œä¸€è¾¹å¹é£ï¼Œä¸€è¾¹çœ‹ä¹¦ï¼Œå–œæ¬¢è¯»ä¹¦å—ï¼Œéªšå¹´ï¼Ÿ" href="/">ä¹¦å½“å¿«æ„è¯»æ˜“å°½</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" target="_blank" rel="noopener" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

    <div class="container" >
        <div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[ç¬”è®°]-Tomcat-Endpoint</h2>
				
				<div>
					<div class="post-time">2019-09-15</div>
				</div>
				
				<div class="article-content">
				<p>æ¥ä¸Šç¯‡ã€‚</p>
<hr>
<p>Connector#startInternal</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">startInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> LifecycleException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token function">setState</span><span class="token punctuation">(</span>LifecycleState<span class="token punctuation">.</span>STARTING<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å¯åŠ¨ProtocolHandler</span>
            protocolHandler<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>AbstractProtocol#start</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// å¯åŠ¨Endpoint</span>
        endpoint<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        monitorFuture <span class="token operator">=</span> <span class="token function">getUtilityExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">scheduleWithFixedDelay</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isPaused</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å¼‚æ­¥è¶…æ—¶</span>
                    <span class="token function">startAsyncTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ä¸€å…±æœ‰ä¸‰ä¸ªEndpointï¼š</p>
<ul>
<li><p>org.apache.tomcat.util.net.AprEndpoint</p>
</li>
<li><p>org.apache.tomcat.util.net.NioEndpoint</p>
</li>
<li><p>org.apache.tomcat.util.net.Nio2Endpoint</p>
</li>
</ul>
<p>NioEndpoint#startInternal</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">startInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>running<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            running <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            paused <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ä¸‰ä¸ªåŒæ­¥æ ˆSynchronizedStackï¼Œå¯¹è±¡æ± </span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>socketProperties<span class="token punctuation">.</span><span class="token function">getProcessorCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                processorCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SynchronizedStack</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>SynchronizedStack<span class="token punctuation">.</span>DEFAULT_SIZE<span class="token punctuation">,</span> socketProperties<span class="token punctuation">.</span><span class="token function">getProcessorCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>socketProperties<span class="token punctuation">.</span><span class="token function">getEventCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                eventCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SynchronizedStack</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>SynchronizedStack<span class="token punctuation">.</span>DEFAULT_SIZE<span class="token punctuation">,</span> socketProperties<span class="token punctuation">.</span><span class="token function">getEventCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>socketProperties<span class="token punctuation">.</span><span class="token function">getBufferPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                nioChannels <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SynchronizedStack</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>SynchronizedStack<span class="token punctuation">.</span>DEFAULT_SIZE<span class="token punctuation">,</span> socketProperties<span class="token punctuation">.</span><span class="token function">getBufferPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">/*
             * Workerçº¿ç¨‹æ± ã€Pollerçº¿ç¨‹ã€Acceptorçº¿ç¨‹
             */</span>

            <span class="token comment" spellcheck="true">// server.xmlæ˜¯å¦é…ç½®å…¬å…±Executor</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æ²¡æœ‰å°±åˆ›å»ºè‡ªå·±çš„Workerçº¿ç¨‹æ± ï¼Œæ‰§è¡Œè¯·æ±‚</span>
                <span class="token function">createExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// åˆå§‹åŒ–æœ€å¤§è¯·æ±‚æ•°LimitLatchï¼Œç±»ä¼¼ä¿¡å·é‡ï¼Œserver.xmlé…ç½®ï¼Œæ¥å—TCPè¿æ¥æ—¶è‡ªå¢ï¼Œå…³é—­TCPè¿æ¥æ—¶è‡ªå‡</span>
            <span class="token function">initializeConnectionLatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// åˆ›å»ºPollerï¼ŒPolleræ˜¯Runnableç±»å‹ï¼Œå†…éƒ¨æ‰“å¼€äº†ä¸€ä¸ªSelectorï¼Œè½®è¯¢äº‹ä»¶äº¤ç»™Workerçº¿ç¨‹æ± å¤„ç†</span>
            poller <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Poller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Thread pollerThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>poller<span class="token punctuation">,</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"-ClientPoller"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            pollerThread<span class="token punctuation">.</span><span class="token function">setPriority</span><span class="token punctuation">(</span>threadPriority<span class="token punctuation">)</span><span class="token punctuation">;</span>
            pollerThread<span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å¯åŠ¨Pollerçº¿ç¨‹</span>
            pollerThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å®ä¾‹åŒ–Acceptorå¯¹è±¡ï¼ŒAcceptoræ˜¯Runnableç±»å‹ï¼Œå°†Endpointå¯¹è±¡ä¼ å…¥</span>
            <span class="token comment" spellcheck="true">// å¯åŠ¨Acceptorçº¿ç¨‹ï¼ŒAcceptorå°†è¯·æ±‚Socketæ³¨å†Œåˆ°Pollerï¼Œç”±Pollerè½®è¯¢åç»­äº‹ä»¶</span>
            <span class="token function">startAcceptorThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>NioEndpoint$Poller</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Poller</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token function">Poller</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>selector <span class="token operator">=</span> Selector<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>AbstractEndpoint#startAcceptorThread</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">startAcceptorThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        acceptor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Acceptor</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String threadName <span class="token operator">=</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"-Acceptor"</span><span class="token punctuation">;</span>
        acceptor<span class="token punctuation">.</span><span class="token function">setThreadName</span><span class="token punctuation">(</span>threadName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Thread t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>acceptor<span class="token punctuation">,</span> threadName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        t<span class="token punctuation">.</span><span class="token function">setPriority</span><span class="token punctuation">(</span><span class="token function">getAcceptorThreadPriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t<span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token function">getDaemon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Acceptor</span><span class="token operator">&lt;</span>U<span class="token operator">></span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">Acceptor</span><span class="token punctuation">(</span>AbstractEndpoint<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span> U<span class="token operator">></span> endpoint<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>endpoint <span class="token operator">=</span> endpoint<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>Acceptor#run</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ç”¨äºå‘ç”Ÿå¼‚å¸¸æ—¶æŒ‚èµ·çº¿ç¨‹</span>
        <span class="token keyword">int</span> errorDelay <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¾ªç¯ç›´åˆ°æ¥æ”¶åˆ°å…³é—­å‘½ä»¤</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>endpoint<span class="token punctuation">.</span><span class="token function">isRunning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æš‚åœçŠ¶æ€</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>endpoint<span class="token punctuation">.</span><span class="token function">isPaused</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> endpoint<span class="token punctuation">.</span><span class="token function">isRunning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                state <span class="token operator">=</span> AcceptorState<span class="token punctuation">.</span>PAUSED<span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// é˜»å¡æŒ‚èµ·ï¼Œè½®è¯¢æ˜¯å¦ä»æš‚åœçŠ¶æ€æ¢å¤</span>
                    Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// Ignore</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// éè¿è¡ŒçŠ¶æ€ï¼Œé€€å‡º</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>endpoint<span class="token punctuation">.</span><span class="token function">isRunning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// è®¾ç½®çŠ¶æ€ä¸ºRunning</span>
            state <span class="token operator">=</span> AcceptorState<span class="token punctuation">.</span>RUNNING<span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Latchï¼Œå¦‚æœå·²ç»åˆ°è¾¾Connectionè¿æ¥æœ€å¤§å€¼ï¼Œç­‰å¾…</span>
                endpoint<span class="token punctuation">.</span><span class="token function">countUpOrAwaitConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å¦‚æœç­‰å¾…æœŸé—´è¢«æš‚åœäº†</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>endpoint<span class="token punctuation">.</span><span class="token function">isPaused</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                U socket <span class="token operator">=</span> null<span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// é˜»å¡è°ƒç”¨ServerSocketChannel#acceptï¼Œæ¥å—è¯·æ±‚ï¼Œè¿”å›SocketChannel</span>
                    socket <span class="token operator">=</span> endpoint<span class="token punctuation">.</span><span class="token function">serverSocketAccept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ioe<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// We didn't get a socket</span>
                    endpoint<span class="token punctuation">.</span><span class="token function">countDownConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>endpoint<span class="token punctuation">.</span><span class="token function">isRunning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// é‡åˆ°å¼‚å¸¸é˜»å¡æŒ‚èµ·è‡ªå·±errorDelayæ¯«ç§’</span>
                        errorDelay <span class="token operator">=</span> <span class="token function">handleExceptionWithDelay</span><span class="token punctuation">(</span>errorDelay<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// re-throw</span>
                        <span class="token keyword">throw</span> ioe<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// æ¥å—æˆåŠŸï¼Œé‡ç½®æ ‡è¯†</span>
                errorDelay <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>endpoint<span class="token punctuation">.</span><span class="token function">isRunning</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>endpoint<span class="token punctuation">.</span><span class="token function">isPaused</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// é…ç½®SocketChannelï¼Œå¹¶å°†SocketChanneläº¤ç»™Processor</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>endpoint<span class="token punctuation">.</span><span class="token function">setSocketOptions</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// å¤±è´¥äº†å°±å…³é—­SocketChannel</span>
                        endpoint<span class="token punctuation">.</span><span class="token function">closeSocket</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ç›´æ¥å…³é—­SocketChannel</span>
                    endpoint<span class="token punctuation">.</span><span class="token function">destroySocket</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Acceptorçº¿ç¨‹ç»“æŸ</span>
        state <span class="token operator">=</span> AcceptorState<span class="token punctuation">.</span>ENDED<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>NioEndpoint#setSocketOptions</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">boolean</span> <span class="token function">setSocketOptions</span><span class="token punctuation">(</span>SocketChannel socket<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Process the connection</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è®¾ç½®SocketChannelä¸ºéé˜»å¡</span>
            socket<span class="token punctuation">.</span><span class="token function">configureBlocking</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è¿”å›Socket</span>
            Socket sock <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è®¾ç½®Socketçš„å±æ€§ï¼Œå¦‚ç¼“å†²åŒºå¤§å°</span>
            socketProperties<span class="token punctuation">.</span><span class="token function">setProperties</span><span class="token punctuation">(</span>sock<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// Tomcatçš„Channelï¼ŒéJDK</span>
            NioChannel channel <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>nioChannels <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å…ˆä»åŒæ­¥æ ˆå¯¹è±¡æ± ä¸­è·å–Tomcatçš„é€šé“å¯¹è±¡</span>
                channel <span class="token operator">=</span> nioChannels<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// æ²¡æœ‰å°±åˆ›å»ºé€šé“</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>channel <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// åˆ›å»ºä¸€ä¸ªSocketBufferHandlerï¼Œå†…éƒ¨ç»´æŠ¤ä¸¤ä¸ªè¯»å†™çš„ç¼“å†²</span>
                SocketBufferHandler bufhandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SocketBufferHandler</span><span class="token punctuation">(</span>socketProperties<span class="token punctuation">.</span><span class="token function">getAppReadBufSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> socketProperties<span class="token punctuation">.</span><span class="token function">getAppWriteBufSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> socketProperties<span class="token punctuation">.</span><span class="token function">getDirectBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment" spellcheck="true">// é…ç½®äº†SSL</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSSLEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// SSLçš„å®‰å…¨é€šé“ï¼ŒselectorPoolæ˜¯ä¹‹å‰NioEndpoint#bindæ‰“å¼€çš„SelectorPool</span>
                    channel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SecureNioChannel</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span> bufhandler<span class="token punctuation">,</span> selectorPool<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// æ™®é€šé€šé“</span>
                    channel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioChannel</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span> bufhandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å¦‚æœå·²å­˜åœ¨</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// è®¾ç½®IOChannelï¼ŒåŒ…å«Socket</span>
                channel<span class="token punctuation">.</span><span class="token function">setIOChannel</span><span class="token punctuation">(</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// é‡ç½®ç¼“å†²</span>
                channel<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// æŠŠNioChannelå’ŒNioEndpointåŒ…è£…æˆNioSocketWrapper</span>
            <span class="token comment" spellcheck="true">// å°†ä¹‹å‰NioEndpoint#bindæ—¶æ‰“å¼€çš„SelectorPoolä¼ å…¥</span>
            <span class="token comment" spellcheck="true">// SelectorPoolç”¨äºç»™Socketæä¾›Selectorï¼Œæœ‰å…±äº«å’Œéå…±äº«ä¸¤ç§</span>
            <span class="token comment" spellcheck="true">// é»˜è®¤æ˜¯æ‰€æœ‰SocketChannelå…±äº«ä¸€ä¸ªSelectorï¼Œå¹¶ä¸”æ˜¯é˜»å¡æ¨¡å¼ï¼Œç”±NioBlockingSelectorå®Œæˆè¯»å†™</span>
            <span class="token comment" spellcheck="true">// NioBlockingSelectorç»´æŠ¤ä¸€ä¸ªè½®è¯¢çº¿ç¨‹BlockPollerï¼Œç¬¬ä¸€æ¬¡è¯»å†™ä¸æˆåŠŸæ—¶ï¼Œæ³¨å†Œåˆ°BlockPoller</span>
            <span class="token comment" spellcheck="true">// å½“é…ç½®ä¸ºéå…±äº«æ—¶ï¼Œä»å¯¹è±¡æ± è·å–ï¼Œè¿™æ ·å¯ä»¥å°†æ¯ä¸ªSocketChannelçš„äº‹ä»¶åˆ†æ•£åˆ°ä¸åŒSelectorä¸­ï¼Œé™ä½äº†å•ä¸ªçš„å‹åŠ›</span>
            NioSocketWrapper socketWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioSocketWrapper</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æŠŠNioSocketWrapperæ·»åŠ åˆ°NioChannel</span>
            channel<span class="token punctuation">.</span><span class="token function">setSocketWrapper</span><span class="token punctuation">(</span>socketWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
            socketWrapper<span class="token punctuation">.</span><span class="token function">setReadTimeout</span><span class="token punctuation">(</span><span class="token function">getConnectionTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            socketWrapper<span class="token punctuation">.</span><span class="token function">setWriteTimeout</span><span class="token punctuation">(</span><span class="token function">getConnectionTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            socketWrapper<span class="token punctuation">.</span><span class="token function">setKeepAliveLeft</span><span class="token punctuation">(</span>NioEndpoint<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getMaxKeepAliveRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            socketWrapper<span class="token punctuation">.</span><span class="token function">setSecure</span><span class="token punctuation">(</span><span class="token function">isSSLEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// TCPæ¡æ‰‹å®Œæˆï¼Œå°†è¯¥NioChannelæ³¨å†Œåˆ°Pollerï¼Œè½®è¯¢åç»­äº‹ä»¶</span>
            poller<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> socketWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Tell to close the socket</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>NioEndpoint$Poller#register</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token keyword">final</span> NioChannel socket<span class="token punctuation">,</span> <span class="token keyword">final</span> NioSocketWrapper socketWrapper<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å…³å¿ƒå¯è¯»äº‹ä»¶</span>
            socketWrapper<span class="token punctuation">.</span><span class="token function">interestOps</span><span class="token punctuation">(</span>SelectionKey<span class="token punctuation">.</span>OP_READ<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//this is what OP_REGISTER turns into.</span>
            PollerEvent r <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>eventCache <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å…ˆä»å¯¹è±¡æ± æ‹¿äº‹ä»¶å¯¹è±¡</span>
                r <span class="token operator">=</span> eventCache<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æ²¡æœ‰å°±æ–°å»ºä¸€ä¸ªï¼Œå¹¶è®¾ç½®ä¸ºOP_REGISTERäº‹ä»¶</span>
                r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PollerEvent</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span> OP_REGISTER<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// é‡ç½®ä¸ºOP_REGISTERäº‹ä»¶</span>
                r<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span> OP_REGISTER<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// åŠ å…¥Polleräº‹ä»¶é˜Ÿåˆ—ï¼Œç”±Pollerçº¿ç¨‹å¤„ç†</span>
            <span class="token function">addEvent</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>NioEndpoint$Poller#addEvent</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">addEvent</span><span class="token punctuation">(</span>PollerEvent event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å…¥é˜Ÿåˆ—</span>
            events<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å¦‚æœwakeupCounter=-1ï¼Œè¯´æ˜æ­£åœ¨selectä¸­ï¼Œè¿˜æ²¡ç»“æŸselect</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>wakeupCounter<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å”¤é†’Selector</span>
                selector<span class="token punctuation">.</span><span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span></code></pre>
<p>NioEndpoint$Poller#run</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Loop until destroy() is called</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">boolean</span> hasEvents <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å¦‚æœæœªå…³é—­Poller</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>close<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// éå†æ‰§è¡Œæ‰€æœ‰å·²æ³¨å†Œçš„äº‹ä»¶</span>
                        hasEvents <span class="token operator">=</span> <span class="token function">events</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// æœ‰äº‹ä»¶åŠ å…¥</span>
                        <span class="token comment" spellcheck="true">// CASï¼Œå…ˆgetåŸå€¼ï¼Œå†setä¸º-1ï¼Œå¦‚æœåŸå€¼å¤§äº0</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>wakeupCounter<span class="token punctuation">.</span><span class="token function">getAndSet</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// éé˜»å¡æŸ¥è¯¢å°±ç»ªäº‹ä»¶æ•°é‡</span>
                            keyCount <span class="token operator">=</span> selector<span class="token punctuation">.</span><span class="token function">selectNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// é˜»å¡æŸ¥è¯¢å°±ç»ªäº‹ä»¶æ•°é‡ï¼Œé»˜è®¤1s</span>
                            keyCount <span class="token operator">=</span> selector<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>selectorTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment" spellcheck="true">// selectå®Œæˆåæ¢å¤ä¸º0</span>
                        wakeupCounter<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// å¦‚æœå…³é—­Poller</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>close<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// å…³é—­å‰è¦å…¨éƒ¨æ‰§è¡Œå®Œ</span>
                        <span class="token function">events</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">timeout</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{</span>
                            selector<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ioe<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// ...</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// è¶…æ—¶æˆ–å”¤é†’ï¼Œå…ˆå¤„ç†events</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>keyCount <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    hasEvents <span class="token operator">=</span> <span class="token punctuation">(</span>hasEvents <span class="token operator">|</span> <span class="token function">events</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// è·å–å°±ç»ªäº‹ä»¶</span>
                Iterator<span class="token operator">&lt;</span>SelectionKey<span class="token operator">></span> iterator <span class="token operator">=</span> keyCount <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">?</span> selector<span class="token punctuation">.</span><span class="token function">selectedKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> null<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// éå†å°±ç»ªçš„keyï¼Œæ¯”å¦‚Socketå¯è¯»ç­‰</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>iterator <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    SelectionKey sk <span class="token operator">=</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    NioSocketWrapper socketWrapper <span class="token operator">=</span> <span class="token punctuation">(</span>NioSocketWrapper<span class="token punctuation">)</span> sk<span class="token punctuation">.</span><span class="token function">attachment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// å¦‚æœåˆ«çš„çº¿ç¨‹è°ƒç”¨äº†Poller#cancelledKeyå…³é—­è¿æ¥ï¼ŒAttachmentå¯èƒ½æ˜¯null</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>socketWrapper <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        iterator<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// å¤„ç†å‰è¦å…ˆç§»é™¤</span>
                        iterator<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// å¤„ç†å°±ç»ªçš„äº‹ä»¶ï¼Œç”ŸæˆSocketProcessoräº¤ç»™Workerçº¿ç¨‹æ± æ‰§è¡Œ</span>
                        <span class="token function">processKey</span><span class="token punctuation">(</span>sk<span class="token punctuation">,</span> socketWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// å›æ”¶åºŸå¼ƒçš„KeepAliveé•¿è¿æ¥ï¼Œæ¯æ‰§è¡Œä¸€éå®Œæ•´çš„è½®è¯¢ï¼Œå°±éå†æ‰€æœ‰å…³å¿ƒçš„é€‰æ‹©é”®ï¼ŒæŸ¥çœ‹é€šé“çš„ä¸Šæ¬¡è¯»å†™æ—¶é—´</span>
                <span class="token comment" spellcheck="true">// è¶…æ—¶å°±ç§»é™¤ä¹‹å‰æ³¨å†Œçš„äº‹ä»¶ï¼Œå¹¶å‘Workerçº¿ç¨‹æ± æäº¤SocketEvent.ERRORäº‹ä»¶ï¼Œæœ€ç»ˆå…³é—­è¿æ¥</span>
                <span class="token function">timeout</span><span class="token punctuation">(</span>keyCount<span class="token punctuation">,</span> hasEvents<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// whileå¾ªç¯ç»“æŸ</span>
            <span class="token comment" spellcheck="true">// ä¸å†æ‰§è¡Œï¼Œé‡Šæ”¾Poller</span>
            <span class="token function">getStopLatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>NioEndpoint$Poller#events</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">events</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            PollerEvent pe <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// éå†äº‹ä»¶ï¼Œå‡ºé˜Ÿåˆ—</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> size <span class="token operator">=</span> events<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>pe <span class="token operator">=</span> events<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                result <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ä¾æ¬¡æ‰§è¡Œï¼ŒPollerEvent#run</span>
                    pe<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// æ‰§è¡Œå®Œåé‡ç½®</span>
                    pe<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>running <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>paused <span class="token operator">&amp;&amp;</span> eventCache <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// æ”¾å›å¯¹è±¡æ± </span>
                        eventCache<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>pe<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>NioEndpoint$PollerEvent#run</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ³¨å†Œäº‹ä»¶</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>interestOps <span class="token operator">==</span> OP_REGISTER<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// æŠŠå®¢æˆ·ç«¯çš„æ–°è¿æ¥SocketChannelæ³¨å†Œåˆ°Pollerçš„Selector</span>
                    socket<span class="token punctuation">.</span><span class="token function">getIOChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>socket<span class="token punctuation">.</span><span class="token function">getSocketWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPoller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token comment" spellcheck="true">// å…³å¿ƒå¯è¯»äº‹ä»¶</span>
                            SelectionKey<span class="token punctuation">.</span>OP_READ<span class="token punctuation">,</span>
                            <span class="token comment" spellcheck="true">// è®¾ç½®Attachment</span>
                            socket<span class="token punctuation">.</span><span class="token function">getSocketWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å…¶å®ƒäº‹ä»¶</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// è·å–Socketæ³¨å†Œåˆ°Selectorçš„SelectionKey</span>
                <span class="token keyword">final</span> SelectionKey key <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">getIOChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">keyFor</span><span class="token punctuation">(</span>socket<span class="token punctuation">.</span><span class="token function">getSocketWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPoller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// é€‰æ‹©é”®è¢«å–æ¶ˆå’Œä»Selectorç§»é™¤ï¼Œæ¯”å¦‚ç”±äºSocketå…³é—­</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// å°†ConnectionLatchå€’æ•°ï¼Œå› ä¸ºSocketå…³é—­çš„æ—¶å€™æ²¡æœ‰å€’æ•°</span>
                            socket<span class="token punctuation">.</span>socketWrapper<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ignore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// keyä¸ä¸ºnull</span>
                    <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token keyword">final</span> NioSocketWrapper socketWrapper <span class="token operator">=</span> <span class="token punctuation">(</span>NioSocketWrapper<span class="token punctuation">)</span> key<span class="token punctuation">.</span><span class="token function">attachment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>socketWrapper <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// We are registering the key to start with, reset the fairness counter.</span>
                            <span class="token keyword">int</span> ops <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">interestOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">|</span> interestOps<span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// ä¿å­˜ä¸€ä»½</span>
                            socketWrapper<span class="token punctuation">.</span><span class="token function">interestOps</span><span class="token punctuation">(</span>ops<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// ä¿®æ”¹å…³å¿ƒçš„äº‹ä»¶</span>
                            key<span class="token punctuation">.</span><span class="token function">interestOps</span><span class="token punctuation">(</span>ops<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            socket<span class="token punctuation">.</span><span class="token function">getSocketWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPoller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cancelledKey</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> socket<span class="token punctuation">.</span><span class="token function">getSocketWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">CancelledKeyException</span> ckx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        socket<span class="token punctuation">.</span><span class="token function">getSocketWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPoller</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cancelledKey</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> socket<span class="token punctuation">.</span><span class="token function">getSocketWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ignore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span></code></pre>
<p>NioEndpoint$Poller#processKey</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">processKey</span><span class="token punctuation">(</span>SelectionKey sk<span class="token punctuation">,</span> NioSocketWrapper socketWrapper<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Pollerå…³é—­</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>close<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å–æ¶ˆ</span>
                    <span class="token function">cancelledKey</span><span class="token punctuation">(</span>sk<span class="token punctuation">,</span> socketWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// æ²¡å…³é—­ï¼Œæœ‰æ•ˆ</span>
                <span class="token comment" spellcheck="true">// SelectionKey#cancelæ–¹æ³•å–æ¶ˆé”®æ—¶ä¸ä¼šç«‹å³ä»Selectorç§»é™¤ï¼Œè€Œæ˜¯æ·»åŠ åˆ°cancelledKeysä¸­ï¼Œä¸‹ä¸€æ¬¡selectæ—¶ç§»é™¤ï¼Œæ‰€ä»¥è¦ç”¨isValidæ ¡éªŒ</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>sk<span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> socketWrapper <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å¯è¯»æˆ–å¯å†™</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>sk<span class="token punctuation">.</span><span class="token function">isReadable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> sk<span class="token punctuation">.</span><span class="token function">isWritable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// æ–‡ä»¶ä¼ è¾“ï¼ŒcompressionèŠ‚çœå¸¦å®½ï¼ŒsendfileèŠ‚çœCPU</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>socketWrapper<span class="token punctuation">.</span><span class="token function">getSendfileData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// ä½¿ç”¨NIOçš„MappedByteBuffer</span>
                            <span class="token function">processSendfile</span><span class="token punctuation">(</span>sk<span class="token punctuation">,</span> socketWrapper<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment" spellcheck="true">// å…¶å®ƒ</span>
                        <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// å¤„ç†ä¹‹å‰ï¼Œå–æ¶ˆæ³¨å†Œçš„äº‹ä»¶ï¼Œé˜²æ­¢å¤šçº¿ç¨‹åŒæ—¶è¯»ä¸€ä¸ªSocket</span>
                            <span class="token comment" spellcheck="true">// å‡å¦‚ä¸€ä¸ªHTTPè¯·æ±‚åªæ”¶åˆ°ä¸€éƒ¨åˆ†ï¼ŒSocketProcessoråœ¨ç­‰å¾…å¦ä¸€éƒ¨åˆ†ï¼Œå½“æ•°æ®åˆ°æ¥æ—¶ä¼šè§¦å‘å¯è¯»äº‹ä»¶ï¼Œå¦‚æœåˆé‡æ–°åˆ›å»ºäº†ä¸€ä¸ªSocketProcessï¼Œä¼šæœ‰å¹¶å‘å¤„ç†é—®é¢˜</span>
                            <span class="token function">unreg</span><span class="token punctuation">(</span>sk<span class="token punctuation">,</span> socketWrapper<span class="token punctuation">,</span> sk<span class="token punctuation">.</span><span class="token function">readyOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">boolean</span> closeSocket <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// å…ˆå¤„ç†å¯è¯»ï¼Œå¤„ç†è¯·æ±‚</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>sk<span class="token punctuation">.</span><span class="token function">isReadable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>socketWrapper<span class="token punctuation">.</span>readOperation <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>socketWrapper<span class="token punctuation">.</span>readOperation<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                        closeSocket <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                                    <span class="token punctuation">}</span>
                                <span class="token punctuation">}</span>
                                <span class="token comment" spellcheck="true">// å¤„ç†å¯è¯»äº‹ä»¶ï¼Œé€šè¿‡SocketProcessoråˆ†å‘åˆ°Workerçº¿ç¨‹æ± ï¼Œè¿”å›å¤„ç†ç»“æœæ ‡å¿—</span>
                                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">processSocket</span><span class="token punctuation">(</span>socketWrapper<span class="token punctuation">,</span> SocketEvent<span class="token punctuation">.</span>OPEN_READ<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    closeSocket <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span>
                            <span class="token comment" spellcheck="true">// å†å¤„ç†å¯å†™ï¼Œå“åº”å›å¤</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>closeSocket <span class="token operator">&amp;&amp;</span> sk<span class="token punctuation">.</span><span class="token function">isWritable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>socketWrapper<span class="token punctuation">.</span>writeOperation <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>socketWrapper<span class="token punctuation">.</span>writeOperation<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                        closeSocket <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                                    <span class="token punctuation">}</span>
                                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">processSocket</span><span class="token punctuation">(</span>socketWrapper<span class="token punctuation">,</span> SocketEvent<span class="token punctuation">.</span>OPEN_WRITE<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    closeSocket <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>closeSocket<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token function">cancelledKey</span><span class="token punctuation">(</span>sk<span class="token punctuation">,</span> socketWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// å…¶å®ƒï¼Œå–æ¶ˆæ— æ•ˆçš„key</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token function">cancelledKey</span><span class="token punctuation">(</span>sk<span class="token punctuation">,</span> socketWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">CancelledKeyException</span> ckx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span></code></pre>
<p>AbstractEndpoint#processSocket</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">processSocket</span><span class="token punctuation">(</span>SocketWrapperBase<span class="token operator">&lt;</span>S<span class="token operator">></span> socketWrapper<span class="token punctuation">,</span> SocketEvent event<span class="token punctuation">,</span> <span class="token keyword">boolean</span> dispatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>socketWrapper <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            SocketProcessorBase<span class="token operator">&lt;</span>S<span class="token operator">></span> sc <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>processorCache <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å…ˆä»å¯¹è±¡æ± è·å–SocketProcessor</span>
                sc <span class="token operator">=</span> processorCache<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sc <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æ²¡æœ‰å†æ–°å»ºï¼ŒåŒ…å«äº†SocketWrapperå’ŒSocketEvent</span>
                sc <span class="token operator">=</span> <span class="token function">createSocketProcessor</span><span class="token punctuation">(</span>socketWrapper<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æœ‰å°±é‡ç½®åå†ç”¨</span>
                sc<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span>socketWrapper<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// è·å–Workerçº¿ç¨‹æ± </span>
            Executor executor <span class="token operator">=</span> <span class="token function">getExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// åˆ†å‘åˆ°çº¿ç¨‹æ± æ‰§è¡Œ</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>dispatch <span class="token operator">&amp;&amp;</span> executor <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// SocketProcessor#doRun</span>
                executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>sc<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ç›´æ¥æ‰§è¡Œ</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                sc<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RejectedExecutionException</span> ree<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>NioEndpointçš„å…³é—­</p>
<p>NioEndpoint#stopInternal</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">stopInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>paused<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>running<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è®¾ç½®æ ‡è¯†ï¼Œé€šçŸ¥Acceptorçº¿ç¨‹è·³å‡ºrunå¾ªç¯</span>
            running <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>poller <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// é€šçŸ¥Pollerçº¿ç¨‹å…³é—­</span>
                poller<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                poller <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ç­‰å¾…Pollerçº¿ç¨‹ç»“æŸï¼ŒPoller#run -> Latch#countDown</span>
                <span class="token comment" spellcheck="true">// æœ‰é˜»å¡è¶…æ—¶</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getStopLatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span>selectorTimeout <span class="token operator">+</span> <span class="token number">100</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å…³é—­Workerçº¿ç¨‹æ± </span>
            <span class="token function">shutdownExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>eventCache <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                eventCache<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                eventCache <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>nioChannels <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                nioChannels<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                nioChannels <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>processorCache <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                processorCache<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                processorCache <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>æ€»ç»“ï¼š</p>
<p>Connectorå†…éƒ¨æœ‰ä¸€ä¸ªProtocolHandlerï¼Œç”¨æ¥å¤„ç†è¯·æ±‚ï¼ŒProtocolHandlerå†…éƒ¨åˆåŒ…å«äº†ï¼šEndpointã€Adapterã€‚</p>
<ul>
<li><p>Endpointå¤„ç†åº•å±‚Socketçš„ç½‘ç»œè¿æ¥ï¼ˆTCP/IPåè®®ç›¸å…³ï¼‰</p>
<ul>
<li><p>Endpointå†…éƒ¨æœ‰ä¸ªAcceptorï¼ŒAcceptoræœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œç”¨äºç›‘å¬ç«¯å£ï¼Œé˜»å¡åœ°æ¥æ”¶Socketè¿æ¥è¯·æ±‚ï¼Œå¹¶äº¤ç»™Pollerå¤„ç†åç»­çš„äº‹ä»¶ã€‚</p>
</li>
<li><p>Endpointå†…éƒ¨æœ‰ä¸ªPollerï¼ŒPolleræœ‰ä¸€ä¸ªSelectorå’Œçº¿ç¨‹ï¼Œè½®è¯¢å°±ç»ªçš„äº‹ä»¶ï¼Œå¹¶å°è£…Socketå’Œäº‹ä»¶æäº¤ç»™å·¥ä½œçº¿ç¨‹æ± å¤„ç†ã€‚</p>
</li>
<li><p>Endpointå†…éƒ¨æœ‰ä¸ªHandlerï¼Œä¸ºSocketå…³è”å¯¹åº”çš„Processorï¼Œç”±Processorå¤„ç†å¯¹åº”çš„äº‹ä»¶ã€‚</p>
<ul>
<li>Processorå°†ç¼“å†²çš„å­—èŠ‚è§£æä¸ºHTTPåè®®ï¼Œç”ŸæˆRequestå’ŒResponseï¼Œäº¤ç»™Adapterå¤„ç†ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><p>Adapteræ˜¯ä¸ªè½¬æ¥ï¼Œå°†Requestå’ŒResponseè½¬æ¢ä¸ºHttpServletRequestå’ŒHttpServletResponseï¼Œå†³å®šè¯·æ±‚çš„Pipelineï¼Œäº¤ç»™Containerè¿›è¡Œå…·ä½“çš„å¤„ç†ã€‚</p>
</li>
</ul>
<p>å…³äºPollerï¼ŒPolleråœ¨å°†SocketProcessoræäº¤åˆ°å·¥ä½œçº¿ç¨‹æ± å‰ï¼Œä¼šå‘Selectorå–æ¶ˆä¹‹å‰SocketChannelå…³æ³¨çš„äº‹ä»¶ï¼Œé¿å…å¤šçº¿ç¨‹é‡å¤å¤„ç†ã€‚</p>
<p>åç»­è¯¥Socketçš„è¯»å†™äº‹ä»¶æ˜¯ç”±NioSelectorPoolé‡Œçš„Selectorç»´æŠ¤çš„ï¼Œé»˜è®¤å…±äº«ï¼Œæ‰€æœ‰SocketChannelå…±ç”¨ä¸€ä¸ªã€‚</p>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


        <footer>
             
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

        </footer>
    </div>
    <!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
    <script>
        var timeEnd = new Date();
        console.log('è€—æ—¶ï¼š' + (timeEnd - timeStart));
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre').forEach((block) => {
                block.classList.add("line-numbers");
            });
        });
    </script>
    <!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
    <!-- material design -->
    <!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
    <!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
    <!-- toc -->
    <!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
    <!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
    <!-- <script src="/js/main.js"></script> -->
    <script src="/js/prism.js"></script>
</body>
</html>
