<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
        <script>
            var timeStart = new Date();
        </script>
        
        <title>[笔记]-Tomcat-WebSocket-Protocol | 🌑🌒🌓🌔🌕🌖🌗🌘</title>
        
        <meta name="author" content="huangzhike">
        
        
        <meta name="description" content="UpgradeProcessorInternal#dispatch
    @Override
    public SocketState dispatch(SocketEvent status) {
        return internalHttpUpgradeHandler.upgrad">
        
        
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        
        <meta property="og:title" content="[笔记]-Tomcat-WebSocket-Protocol"/>
        
        <meta property="og:site_name" content="🌑🌒🌓🌔🌕🌖🌗🌘"/>
        
        
        <!-- favicon -->
        <link rel="icon" type="image/ico" href="/ok.ico" sizes="32x32">
        <meta name="msapplication-TileColor" content="#009688">
        <meta name="msapplication-TileImage" content="/mstile-144x144.ico">
        <meta name="theme-color" content="#009688">
        <!-- favicon end -->
        <!-- <link href="//ok.ico" rel="icon"> -->
        
        <!-- toc -->
        <!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
        <!-- material design -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
        <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
        
        <!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
        <!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
    <meta name="generator" content="Hexo 4.2.1"></head>

<body>
    <nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">菜单</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" title="下一句是：客有可人期不来。小时候，喜欢靠在阳台上，一边吹风，一边看书，喜欢读书吗，骚年？" href="/">书当快意读易尽</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" target="_blank" rel="noopener" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

    <div class="container" >
        <div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[笔记]-Tomcat-WebSocket-Protocol</h2>
				
				<div>
					<div class="post-time">2019-09-15</div>
				</div>
				
				<div class="article-content">
				<p>UpgradeProcessorInternal#dispatch</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> SocketState <span class="token function">dispatch</span><span class="token punctuation">(</span>SocketEvent status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> internalHttpUpgradeHandler<span class="token punctuation">.</span><span class="token function">upgradeDispatch</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>WsHttpUpgradeHandler#upgradeDispatch</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> SocketState <span class="token function">upgradeDispatch</span><span class="token punctuation">(</span>SocketEvent status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 可读事件</span>
            <span class="token keyword">case</span> OPEN_READ<span class="token operator">:</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> wsFrame<span class="token punctuation">.</span><span class="token function">notifyDataAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">WsIOException</span> ws<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">close</span><span class="token punctuation">(</span>ws<span class="token punctuation">.</span><span class="token function">getCloseReason</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ioe<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">onError</span><span class="token punctuation">(</span>ioe<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    CloseReason cr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CloseReason</span><span class="token punctuation">(</span>CloseCodes<span class="token punctuation">.</span>CLOSED_ABNORMALLY<span class="token punctuation">,</span> ioe<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">close</span><span class="token punctuation">(</span>cr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 可写事件</span>
            <span class="token keyword">case</span> OPEN_WRITE<span class="token operator">:</span>
                wsRemoteEndpointServer<span class="token punctuation">.</span><span class="token function">onWritePossible</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> STOP<span class="token operator">:</span>
                CloseReason cr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CloseReason</span><span class="token punctuation">(</span>CloseCodes<span class="token punctuation">.</span>GOING_AWAY<span class="token punctuation">,</span> sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"wsHttpUpgradeHandler.serverStop"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    wsSession<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>cr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ioe<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">onError</span><span class="token punctuation">(</span>ioe<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    cr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CloseReason</span><span class="token punctuation">(</span>CloseCodes<span class="token punctuation">.</span>CLOSED_ABNORMALLY<span class="token punctuation">,</span> ioe<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">close</span><span class="token punctuation">(</span>cr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> ERROR<span class="token operator">:</span>
                String msg <span class="token operator">=</span> sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"wsHttpUpgradeHandler.closeOnError"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                wsSession<span class="token punctuation">.</span><span class="token function">doClose</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CloseReason</span><span class="token punctuation">(</span>CloseCodes<span class="token punctuation">.</span>GOING_AWAY<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">CloseReason</span><span class="token punctuation">(</span>CloseCodes<span class="token punctuation">.</span>CLOSED_ABNORMALLY<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">//$FALL-THROUGH$</span>
            <span class="token keyword">case</span> DISCONNECT<span class="token operator">:</span>
            <span class="token keyword">case</span> TIMEOUT<span class="token operator">:</span>
            <span class="token keyword">case</span> CONNECT_FAIL<span class="token operator">:</span>
                <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 只要是打开状态</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>wsFrame<span class="token punctuation">.</span><span class="token function">isOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>UPGRADED<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>WsFrameServer#notifyDataAvailable</p>
<pre class=" language-java"><code class="language-java">    SocketState <span class="token function">notifyDataAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 初始值</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">isOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token function">getReadState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 初始为ReadState.WAITING</span>
                <span class="token keyword">case</span> WAITING<span class="token operator">:</span>
                    <span class="token comment" spellcheck="true">// 尝试CAS将状态由ReadState.WAITING设为ReadState.PROCESSING</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">changeReadState</span><span class="token punctuation">(</span>ReadState<span class="token punctuation">.</span>WAITING<span class="token punctuation">,</span> ReadState<span class="token punctuation">.</span>PROCESSING<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 失败下次循环继续</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 收到消息，数据可用</span>
                        <span class="token keyword">return</span> <span class="token function">doOnDataAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">changeReadState</span><span class="token punctuation">(</span>ReadState<span class="token punctuation">.</span>CLOSING<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token keyword">case</span> SUSPENDING_WAIT<span class="token operator">:</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">changeReadState</span><span class="token punctuation">(</span>ReadState<span class="token punctuation">.</span>SUSPENDING_WAIT<span class="token punctuation">,</span> ReadState<span class="token punctuation">.</span>SUSPENDED<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>SUSPENDED<span class="token punctuation">;</span>
                <span class="token keyword">default</span><span class="token operator">:</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"wsFrameServer.illegalReadState"</span><span class="token punctuation">,</span> <span class="token function">getReadState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>WsFrameServer#doOnDataAvailable</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> SocketState <span class="token function">doOnDataAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 处理通知</span>
        <span class="token function">onDataAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">isOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token function">getReadState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> PROCESSING<span class="token operator">:</span>
                    <span class="token comment" spellcheck="true">// 尝试CAS将状态由ReadState.PROCESSING设回ReadState.WAITING</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">changeReadState</span><span class="token punctuation">(</span>ReadState<span class="token punctuation">.</span>PROCESSING<span class="token punctuation">,</span> ReadState<span class="token punctuation">.</span>WAITING<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 失败下个循环继续</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// 返回已升级</span>
                    <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>UPGRADED<span class="token punctuation">;</span>
                <span class="token keyword">case</span> SUSPENDING_PROCESS<span class="token operator">:</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">changeReadState</span><span class="token punctuation">(</span>ReadState<span class="token punctuation">.</span>SUSPENDING_PROCESS<span class="token punctuation">,</span> ReadState<span class="token punctuation">.</span>SUSPENDED<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>SUSPENDED<span class="token punctuation">;</span>
                <span class="token keyword">default</span><span class="token operator">:</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"wsFrameServer.illegalReadState"</span><span class="token punctuation">,</span> <span class="token function">getReadState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>WsFrameServer#onDataAvailable</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">onDataAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// 打开状态 &amp;&amp; 缓冲有未读数据 &amp;&amp; 未被中断</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> inputBuffer<span class="token punctuation">.</span><span class="token function">hasRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isSuspended</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 在从SocketChannel读取数据前，先从缓冲读</span>
            <span class="token function">processInputBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 直到没有数据可读</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">isOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isSuspended</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 先标记当前读索引</span>
            inputBuffer<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 把索引指向limit，limit指向capacity，为了尽可能读取更多的数据进缓冲</span>
            inputBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span>inputBuffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>inputBuffer<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 非阻塞地从SocketChannel读取数据到缓冲</span>
            <span class="token keyword">int</span> read <span class="token operator">=</span> socketWrapper<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> inputBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 把limit指向写索引，并恢复索引为mark</span>
            inputBuffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>inputBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>read <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">EOFException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 没有数据可读</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>read <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// 处理缓冲的数据</span>
            <span class="token function">processInputBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>NioEndpoint$NioSocketWrapper#read</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> block<span class="token punctuation">,</span> ByteBuffer to<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 如果有未读Buffer，先读取SocketBufferHandler的读缓冲到Processor的缓冲ByteBuffer</span>
            <span class="token keyword">int</span> nRead <span class="token operator">=</span> <span class="token function">populateReadBuffer</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>nRead <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 读成功，直接返回</span>
                <span class="token keyword">return</span> nRead<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// SocketBufferHandler的读缓冲已读完，准备从SocketChannel读</span>
            <span class="token comment" spellcheck="true">// The socket read buffer capacity is socket.appReadBufSize</span>
            <span class="token keyword">int</span> limit <span class="token operator">=</span> socketBufferHandler<span class="token punctuation">.</span><span class="token function">getReadBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 缓冲剩余部分大于限制，容量足够</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>to<span class="token punctuation">.</span><span class="token function">remaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> limit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 设置该次读取的最大值</span>
                to<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>to<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> limit<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 直接从SocketChannel读到Processor的缓冲ByteBuffer</span>
                nRead <span class="token operator">=</span> <span class="token function">fillReadBuffer</span><span class="token punctuation">(</span>block<span class="token punctuation">,</span> to<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 更新上次读取时间</span>
                <span class="token function">updateLastRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 先把数据读到SocketBufferHandler的读缓冲</span>
                nRead <span class="token operator">=</span> <span class="token function">fillReadBuffer</span><span class="token punctuation">(</span>block<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 更新上次读取时间</span>
                <span class="token function">updateLastRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 再读取SocketBufferHandler的读缓冲到Processor的缓冲ByteBuffer</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>nRead <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    nRead <span class="token operator">=</span> <span class="token function">populateReadBuffer</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> nRead<span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>SocketWrapperBase#populateReadBuffer</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">protected</span> <span class="token keyword">int</span> <span class="token function">populateReadBuffer</span><span class="token punctuation">(</span>ByteBuffer to<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Is there enough data in the read buffer to satisfy this request?</span>
        <span class="token comment" spellcheck="true">// Copy what data there is in the read buffer to the byte array</span>
        socketBufferHandler<span class="token punctuation">.</span><span class="token function">configureReadBufferForRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> nRead <span class="token operator">=</span> <span class="token function">transfer</span><span class="token punctuation">(</span>socketBufferHandler<span class="token punctuation">.</span><span class="token function">getReadBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> to<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> nRead<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>NioEndpoint$NioSocketWrapper#fillReadBuffer</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">fillReadBuffer</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> block<span class="token punctuation">,</span> ByteBuffer to<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
            <span class="token keyword">int</span> nRead<span class="token punctuation">;</span>
            NioChannel socket <span class="token operator">=</span> <span class="token function">getSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>socket <span class="token keyword">instanceof</span> <span class="token class-name">ClosedNioChannel</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ClosedChannelException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>block<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Selector selector <span class="token operator">=</span> null<span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    selector <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// Ignore</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    nRead <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> socket<span class="token punctuation">,</span> selector<span class="token punctuation">,</span> <span class="token function">getReadTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>selector <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        pool<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                nRead <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>nRead <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">EOFException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> nRead<span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>NioEndpoint$NioSocketWrapper#fillReadBuffer</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">fillReadBuffer</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> block<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
            socketBufferHandler<span class="token punctuation">.</span><span class="token function">configureReadBufferForWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">fillReadBuffer</span><span class="token punctuation">(</span>block<span class="token punctuation">,</span> socketBufferHandler<span class="token punctuation">.</span><span class="token function">getReadBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>注意这里的Selector是来自NioEndpoint绑定时初始化的SelectorPool，但是默认是共享的，也就是只有一个。</p>
<p>详细可以参考另一篇Response，写和读原理是一样的。</p>
<p>WsFrameBase#processInputBuffer</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">processInputBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isSuspended</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 更新时间</span>
            wsSession<span class="token punctuation">.</span><span class="token function">updateLastActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 初始状态</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> State<span class="token punctuation">.</span>NEW_FRAME<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 解析初始头部</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">processInitialHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 缓冲数据不足，跳出循环</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>open<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span>sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"wsFrame.closed"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 解析完了部分头部</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> State<span class="token punctuation">.</span>PARTIAL_HEADER<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 解析剩下的头部</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">processRemainingHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 缓冲数据不足，跳出循环</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 解析完了头部</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> State<span class="token punctuation">.</span>DATA<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 解析剩下的数据</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">processData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 缓冲数据不足，跳出循环</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>WebSocket协议可以参考<a href="https://tools.ietf.org/html/rfc6455" target="_blank" rel="noopener">RFC的文档</a>，我看的是<a href="https://github.com/HJava/myBlog/tree/master/WebSocket" target="_blank" rel="noopener">中文翻译</a>。</p>
<pre><code>  0                   1                   2                   3
  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-------+-+-------------+-------------------------------+
 |F|R|R|R| opcode|M| Payload len |    Extended payload length    |
 |I|S|S|S|  (4)  |A|     (7)     |             (16/64)           |
 |N|V|V|V|       |S|             |   (if payload len==126/127)   |
 | |1|2|3|       |K|             |                               |
 +-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +
 |     Extended payload length continued, if payload len == 127  |
 + - - - - - - - - - - - - - - - +-------------------------------+
 |                               |Masking-key, if MASK set to 1  |
 +-------------------------------+-------------------------------+
 | Masking-key (continued)       |          Payload Data         |
 +-------------------------------- - - - - - - - - - - - - - - - +
 :                     Payload Data continued ...                :
 + - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +
 |                     Payload Data continued ...                |
 +---------------------------------------------------------------+</code></pre><hr>
<p>WsFrameBase#processInitialHeader</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">processInitialHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 至少需要两字节</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>inputBuffer<span class="token punctuation">.</span><span class="token function">remaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 第一个字节</span>
        <span class="token keyword">int</span> b <span class="token operator">=</span> inputBuffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 描述消息是否结束，为1则该消息为消息尾部，为0则还有后续数据包</span>
        <span class="token comment" spellcheck="true">// 消息分片主要是在不必缓冲整个消息时，发送一个未知大小的消息，未分片的消息需要缓冲整个消息，以便获取消息大小</span>
        <span class="token comment" spellcheck="true">// 首个分片(fin = 0 &amp;&amp; opCode != 0x0)，跟随多个(fin = 0 &amp;&amp; opCode = 0x0)的分片，终止于(fin = 1 &amp;&amp; opCode = 0x0)的分片</span>
        <span class="token comment" spellcheck="true">// 不分片(fin = 1 &amp;&amp; opCode != 0x0)</span>
        <span class="token comment" spellcheck="true">// 消息分片必须在发送端按照顺序发送给接收端</span>
        <span class="token comment" spellcheck="true">// 控制帧不能被分片，但是控制帧可以被插入到分片传输，因为假如分片太长，心跳等控制帧也需要等待过长时间</span>
        fin <span class="token operator">=</span> <span class="token punctuation">(</span>b <span class="token operator">&amp;</span> <span class="token number">0x80</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// RSV1，RSV2，RSV3，用于扩展定义，如果没有扩展约定，必须为0</span>
        rsv <span class="token operator">=</span> <span class="token punctuation">(</span>b <span class="token operator">&amp;</span> <span class="token number">0x70</span><span class="token punctuation">)</span> <span class="token operator">>>></span> <span class="token number">4</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 表示消息接收类型，如果接收到未知的opCode，接收端必须关闭连接</span>
        opCode <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>b <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 校验RSV</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>transformation<span class="token punctuation">.</span><span class="token function">validateRsv</span><span class="token punctuation">(</span>rsv<span class="token punctuation">,</span> opCode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">WsIOException</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CloseReason</span><span class="token punctuation">(</span>CloseCodes<span class="token punctuation">.</span>PROTOCOL_ERROR<span class="token punctuation">,</span> sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"wsFrame.wrongRsv"</span><span class="token punctuation">,</span> Integer<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>rsv<span class="token punctuation">)</span><span class="token punctuation">,</span> Integer<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>opCode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">/*
         * 0x0 连续帧
         * 0x1 文本数据帧
         * 0x2 二进制数据帧
         * 0x3-7 为非控制帧保留
         * 0x8 连接关闭
         * 0x9 Ping
         * 0xA Pong
         * 0xB-F 为控制帧保留
         */</span>
        <span class="token comment" spellcheck="true">// 控制帧</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Util<span class="token punctuation">.</span><span class="token function">isControl</span><span class="token punctuation">(</span>opCode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 不是消息尾部</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">WsIOException</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CloseReason</span><span class="token punctuation">(</span>CloseCodes<span class="token punctuation">.</span>PROTOCOL_ERROR<span class="token punctuation">,</span> sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"wsFrame.controlFragmented"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 不是ping，pong，close</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>opCode <span class="token operator">!=</span> Constants<span class="token punctuation">.</span>OPCODE_PING <span class="token operator">&amp;&amp;</span> opCode <span class="token operator">!=</span> Constants<span class="token punctuation">.</span>OPCODE_PONG <span class="token operator">&amp;&amp;</span> opCode <span class="token operator">!=</span> Constants<span class="token punctuation">.</span>OPCODE_CLOSE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 无效的控制帧</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">WsIOException</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CloseReason</span><span class="token punctuation">(</span>CloseCodes<span class="token punctuation">.</span>PROTOCOL_ERROR<span class="token punctuation">,</span> sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"wsFrame.invalidOpCode"</span><span class="token punctuation">,</span> Integer<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>opCode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 非控制帧</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 默认false</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>continuationExpected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Util<span class="token punctuation">.</span><span class="token function">isContinuation</span><span class="token punctuation">(</span>opCode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">WsIOException</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CloseReason</span><span class="token punctuation">(</span>CloseCodes<span class="token punctuation">.</span>PROTOCOL_ERROR<span class="token punctuation">,</span> sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"wsFrame.noContinuation"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 消息是二进制数据</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>opCode <span class="token operator">==</span> Constants<span class="token punctuation">.</span>OPCODE_BINARY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 非文本</span>
                        textMessage <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                        <span class="token keyword">int</span> size <span class="token operator">=</span> wsSession<span class="token punctuation">.</span><span class="token function">getMaxBinaryMessageBufferSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">!=</span> messageBufferBinary<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            messageBufferBinary <span class="token operator">=</span> ByteBuffer<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment" spellcheck="true">// 使用二进制消息处理器</span>
                        binaryMsgHandler <span class="token operator">=</span> wsSession<span class="token punctuation">.</span><span class="token function">getBinaryMessageHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        textMsgHandler <span class="token operator">=</span> null<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// 消息是文本消息</span>
                    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>opCode <span class="token operator">==</span> Constants<span class="token punctuation">.</span>OPCODE_TEXT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 文本</span>
                        textMessage <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                        <span class="token keyword">int</span> size <span class="token operator">=</span> wsSession<span class="token punctuation">.</span><span class="token function">getMaxTextMessageBufferSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">!=</span> messageBufferText<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            messageBufferText <span class="token operator">=</span> CharBuffer<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        binaryMsgHandler <span class="token operator">=</span> null<span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// 使用文本消息处理器</span>
                        textMsgHandler <span class="token operator">=</span> wsSession<span class="token punctuation">.</span><span class="token function">getTextMessageHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// 无效</span>
                    <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">WsIOException</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CloseReason</span><span class="token punctuation">(</span>CloseCodes<span class="token punctuation">.</span>PROTOCOL_ERROR<span class="token punctuation">,</span> sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"wsFrame.invalidOpCode"</span><span class="token punctuation">,</span> Integer<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>opCode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalStateException</span> ise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// Thrown if the session is already closed</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">WsIOException</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CloseReason</span><span class="token punctuation">(</span>CloseCodes<span class="token punctuation">.</span>PROTOCOL_ERROR<span class="token punctuation">,</span> sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"wsFrame.sessionClosed"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            continuationExpected <span class="token operator">=</span> <span class="token operator">!</span>fin<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 第二个字节</span>
        b <span class="token operator">=</span> inputBuffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Mask标志，客户端发出的数据帧必须要掩码处理，数据需要解码，服务端发出的数据则不需要</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>b <span class="token operator">&amp;</span> <span class="token number">0x80</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isMasked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">WsIOException</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CloseReason</span><span class="token punctuation">(</span>CloseCodes<span class="token punctuation">.</span>PROTOCOL_ERROR<span class="token punctuation">,</span> sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"wsFrame.notMasked"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">/*
         * PayloadData的长度：7位，7+16位，7+64位
         * 如果值在0-125，则是payload的真实长度
         * 如果值是126，则后面2个字节的16位无符号整型数值才是payload的真实长度
         * 如果值是127，则后面8个字节的64位无符号整型数值才是payload的真实长度
         */</span>
        payloadLength <span class="token operator">=</span> b <span class="token operator">&amp;</span> <span class="token number">0x7F</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 已解析完部分头</span>
        state <span class="token operator">=</span> State<span class="token punctuation">.</span>PARTIAL_HEADER<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>WsFrameBase#processRemainingHeader</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">processRemainingHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 忽略已读的两个字节，4是掩码</span>
        <span class="token keyword">int</span> headerLength<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isMasked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            headerLength <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            headerLength <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 根据长度加上额外的字节</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>payloadLength <span class="token operator">==</span> <span class="token number">126</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            headerLength <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>payloadLength <span class="token operator">==</span> <span class="token number">127</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            headerLength <span class="token operator">+=</span> <span class="token number">8</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>inputBuffer<span class="token punctuation">.</span><span class="token function">remaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> headerLength<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 如果有必要，计算新的Payload长度</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>payloadLength <span class="token operator">==</span> <span class="token number">126</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            payloadLength <span class="token operator">=</span> <span class="token function">byteArrayToLong</span><span class="token punctuation">(</span>inputBuffer<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> inputBuffer<span class="token punctuation">.</span><span class="token function">arrayOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> inputBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            inputBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span>inputBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>payloadLength <span class="token operator">==</span> <span class="token number">127</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            payloadLength <span class="token operator">=</span> <span class="token function">byteArrayToLong</span><span class="token punctuation">(</span>inputBuffer<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> inputBuffer<span class="token punctuation">.</span><span class="token function">arrayOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> inputBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            inputBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span>inputBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Util<span class="token punctuation">.</span><span class="token function">isControl</span><span class="token punctuation">(</span>opCode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 控制帧的Payload长度不能大于125字节</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>payloadLength <span class="token operator">></span> <span class="token number">125</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">WsIOException</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CloseReason</span><span class="token punctuation">(</span>CloseCodes<span class="token punctuation">.</span>PROTOCOL_ERROR<span class="token punctuation">,</span> sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"wsFrame.controlPayloadTooBig"</span><span class="token punctuation">,</span> Long<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>payloadLength<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">WsIOException</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CloseReason</span><span class="token punctuation">(</span>CloseCodes<span class="token punctuation">.</span>PROTOCOL_ERROR<span class="token punctuation">,</span> sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"wsFrame.controlNoFin"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 服务端收到客户端的消息，需要掩码</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isMasked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 从缓冲获取掩码Masking-key，填入mask数组，四字节</span>
            inputBuffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>mask<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 下一步需要解析Payload</span>
        state <span class="token operator">=</span> State<span class="token punctuation">.</span>DATA<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>WsFrameBase#processData</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">processData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> result<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 控制帧</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Util<span class="token punctuation">.</span><span class="token function">isControl</span><span class="token punctuation">(</span>opCode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            result <span class="token operator">=</span> <span class="token function">processDataControl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 文本消息</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>textMessage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>textMsgHandler <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                result <span class="token operator">=</span> <span class="token function">swallowInput</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                result <span class="token operator">=</span> <span class="token function">processDataText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 二进制消息</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>binaryMsgHandler <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                result <span class="token operator">=</span> <span class="token function">swallowInput</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                result <span class="token operator">=</span> <span class="token function">processDataBinary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 检查缓冲的空间</span>
        <span class="token function">checkRoomPayload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>WsFrameBase#processDataText</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">processDataText</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 复制可用的数据到消息二进制缓冲</span>
        TransformationResult tr <span class="token operator">=</span> transformation<span class="token punctuation">.</span><span class="token function">getMoreData</span><span class="token punctuation">(</span>opCode<span class="token punctuation">,</span> fin<span class="token punctuation">,</span> rsv<span class="token punctuation">,</span> messageBufferBinary<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 帧不完整</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>TransformationResult<span class="token punctuation">.</span>END_OF_FRAME<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>tr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 重置索引，将消息二进制缓冲切换到读模式</span>
            messageBufferBinary<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 将消息二进制缓冲的字节解码为UTF-8的消息文本缓冲</span>
                CoderResult cr <span class="token operator">=</span> utf8DecoderMessage<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>messageBufferBinary<span class="token punctuation">,</span> messageBufferText<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 解码错误</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>cr<span class="token punctuation">.</span><span class="token function">isError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">WsIOException</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CloseReason</span><span class="token punctuation">(</span>CloseCodes<span class="token punctuation">.</span>NOT_CONSISTENT<span class="token punctuation">,</span> sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"wsFrame.invalidUtf8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 消息文本缓冲空间不够</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cr<span class="token punctuation">.</span><span class="token function">isOverflow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 使用消息分片</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">usePartial</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 重置索引，将消息文本缓冲切换到读模式</span>
                        messageBufferText<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// 反射调用EndPoint的onMessage方法，发送部分消息，发送完清空消息文本缓冲</span>
                        <span class="token function">sendMessageText</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// 这里再清空消息文本缓冲</span>
                        messageBufferText<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">WsIOException</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CloseReason</span><span class="token punctuation">(</span>CloseCodes<span class="token punctuation">.</span>TOO_BIG<span class="token punctuation">,</span> sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"wsFrame.textMessageTooBig"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 数据不足</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cr<span class="token punctuation">.</span><span class="token function">isUnderflow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 压缩消息二进制缓冲，腾出空间</span>
                    messageBufferBinary<span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// Need more input What did we run out of?</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>TransformationResult<span class="token punctuation">.</span>OVERFLOW<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>tr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 消息二进制缓冲已读完，退出内循环，填充更多数据到消息二进制缓冲</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// TransformationResult.UNDERFLOW</span>
                        <span class="token comment" spellcheck="true">// 退出，从Socket读取更多消息</span>
                        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// 内循环结束</span>
            <span class="token comment" spellcheck="true">// 填充更多数据到消息二进制缓冲</span>
            tr <span class="token operator">=</span> transformation<span class="token punctuation">.</span><span class="token function">getMoreData</span><span class="token punctuation">(</span>opCode<span class="token punctuation">,</span> fin<span class="token punctuation">,</span> rsv<span class="token punctuation">,</span> messageBufferBinary<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// 外循环结束</span>
        <span class="token comment" spellcheck="true">// 重置索引，将消息二进制缓冲切换到读模式</span>
        messageBufferBinary<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> last <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 已经收到完整的帧</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 将消息二进制缓冲的字节解码为UTF-8的消息文本缓冲</span>
            CoderResult cr <span class="token operator">=</span> utf8DecoderMessage<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>messageBufferBinary<span class="token punctuation">,</span> messageBufferText<span class="token punctuation">,</span> last<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 解码错误</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cr<span class="token punctuation">.</span><span class="token function">isError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">WsIOException</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CloseReason</span><span class="token punctuation">(</span>CloseCodes<span class="token punctuation">.</span>NOT_CONSISTENT<span class="token punctuation">,</span> sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"wsFrame.invalidUtf8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cr<span class="token punctuation">.</span><span class="token function">isOverflow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Ran out of space in text buffer - flush it</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">usePartial</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    messageBufferText<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">sendMessageText</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    messageBufferText<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">WsIOException</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CloseReason</span><span class="token punctuation">(</span>CloseCodes<span class="token punctuation">.</span>TOO_BIG<span class="token punctuation">,</span> sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"wsFrame.textMessageTooBig"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cr<span class="token punctuation">.</span><span class="token function">isUnderflow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>last<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// End of frame and possible message as well.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>continuationExpected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// If partial messages are supported, send what we have managed to decode</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">usePartial</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        messageBufferText<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">sendMessageText</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        messageBufferText<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    messageBufferBinary<span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">newFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// Process next frame</span>
                    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// Make sure coder has flushed all output</span>
                    last <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// End of message</span>
                messageBufferText<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 反射调用EndPoint的onMessage方法</span>
                <span class="token function">sendMessageText</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 重置缓冲和状态</span>
                <span class="token function">newMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 成功</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


        <footer>
             
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

        </footer>
    </div>
    <!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
    <script>
        var timeEnd = new Date();
        console.log('耗时：' + (timeEnd - timeStart));
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre').forEach((block) => {
                block.classList.add("line-numbers");
            });
        });
    </script>
    <!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
    <!-- material design -->
    <!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
    <!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
    <!-- toc -->
    <!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
    <!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
    <!-- <script src="/js/main.js"></script> -->
    <script src="/js/prism.js"></script>
</body>
</html>
