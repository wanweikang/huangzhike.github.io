<!DOCTYPE HTML>
<html>
	<head><meta name="generator" content="Hexo 3.9.0">
		<meta charset="utf-8">
		<script src="/js/highlight.js"></script>
				<script>hljs.initHighlightingOnLoad();var timeStart = new Date();</script>
		
		<title>[笔记]-Tomcat-WebSocket-Protocol | 学而时习之</title>
		
		<meta name="author" content="Huangzhike">
		
		
		<meta name="description" content="K.I.S.S">
		
		
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		
		<meta property="og:title" content="[笔记]-Tomcat-WebSocket-Protocol">
		
		<meta property="og:site_name" content="学而时习之">
		
		
		<!-- favicon -->
		<link rel="icon" type="image/ico" href="/ok.ico" sizes="32x32">
 


		<meta name="msapplication-TileColor" content="#009688">
		<meta name="msapplication-TileImage" content="/mstile-144x144.ico">
		<meta name="theme-color" content="#009688">

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Didact+Gothic"> 

		<!-- favicon end -->
		<!-- <link href="//ok.ico" rel="icon"> -->
		
		<!-- toc -->
		<!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
		<!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
		<!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
		<!-- material design -->
		<!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
		<!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
		<!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
		<!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
		<!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
		<link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
		 
		 
		<!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
		<!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
	</head>
</html>
<body>
	<nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">菜单</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" href="/">学而时习之</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

	<div class="container" >
		<div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[笔记]-Tomcat-WebSocket-Protocol</h2>
				
				<div>
					<div class="post-time">2019-09-15</div>
				</div>
				
				<div class="article-content">
				<p>UpgradeProcessorInternal#dispatch</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> SocketState <span class="title">dispatch</span><span class="params">(SocketEvent status)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> internalHttpUpgradeHandler.upgradeDispatch(status);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>WsHttpUpgradeHandler#upgradeDispatch</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> SocketState <span class="title">upgradeDispatch</span><span class="params">(SocketEvent status)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (status) &#123;</span><br><span class="line">        <span class="comment">// 可读事件</span></span><br><span class="line">        <span class="keyword">case</span> OPEN_READ:</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> wsFrame.notifyDataAvailable();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (WsIOException ws) &#123;</span><br><span class="line">                close(ws.getCloseReason());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">                onError(ioe);</span><br><span class="line">                CloseReason cr = <span class="keyword">new</span> CloseReason(CloseCodes.CLOSED_ABNORMALLY, ioe.getMessage());</span><br><span class="line">                close(cr);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> SocketState.CLOSED;</span><br><span class="line">        <span class="comment">// 可写事件</span></span><br><span class="line">        <span class="keyword">case</span> OPEN_WRITE:</span><br><span class="line">            wsRemoteEndpointServer.onWritePossible(<span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> STOP:</span><br><span class="line">            CloseReason cr = <span class="keyword">new</span> CloseReason(CloseCodes.GOING_AWAY, sm.getString(<span class="string">"wsHttpUpgradeHandler.serverStop"</span>));</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                wsSession.close(cr);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">                onError(ioe);</span><br><span class="line">                cr = <span class="keyword">new</span> CloseReason(CloseCodes.CLOSED_ABNORMALLY, ioe.getMessage());</span><br><span class="line">                close(cr);</span><br><span class="line">                <span class="keyword">return</span> SocketState.CLOSED;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ERROR:</span><br><span class="line">            String msg = sm.getString(<span class="string">"wsHttpUpgradeHandler.closeOnError"</span>);</span><br><span class="line">            wsSession.doClose(<span class="keyword">new</span> CloseReason(CloseCodes.GOING_AWAY, msg), <span class="keyword">new</span> CloseReason(CloseCodes.CLOSED_ABNORMALLY, msg));</span><br><span class="line">            <span class="comment">//$FALL-THROUGH$</span></span><br><span class="line">        <span class="keyword">case</span> DISCONNECT:</span><br><span class="line">        <span class="keyword">case</span> TIMEOUT:</span><br><span class="line">        <span class="keyword">case</span> CONNECT_FAIL:</span><br><span class="line">            <span class="keyword">return</span> SocketState.CLOSED;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 只要是打开状态</span></span><br><span class="line">    <span class="keyword">if</span> (wsFrame.isOpen()) &#123;</span><br><span class="line">        <span class="keyword">return</span> SocketState.UPGRADED;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> SocketState.CLOSED;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>WsFrameServer#notifyDataAvailable</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">SocketState <span class="title">notifyDataAvailable</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// 初始值</span></span><br><span class="line">    <span class="keyword">while</span> (isOpen()) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (getReadState()) &#123;</span><br><span class="line">            <span class="comment">// 初始为ReadState.WAITING</span></span><br><span class="line">            <span class="keyword">case</span> WAITING:</span><br><span class="line">                <span class="comment">// 尝试CAS将状态由ReadState.WAITING设为ReadState.PROCESSING</span></span><br><span class="line">                <span class="keyword">if</span> (!changeReadState(ReadState.WAITING, ReadState.PROCESSING)) &#123;</span><br><span class="line">                    <span class="comment">// 失败下次循环继续</span></span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 收到消息，数据可用</span></span><br><span class="line">                    <span class="keyword">return</span> doOnDataAvailable();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    changeReadState(ReadState.CLOSING);</span><br><span class="line">                    <span class="keyword">throw</span> e;</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="keyword">case</span> SUSPENDING_WAIT:</span><br><span class="line">                <span class="keyword">if</span> (!changeReadState(ReadState.SUSPENDING_WAIT, ReadState.SUSPENDED)) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> SocketState.SUSPENDED;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(sm.getString(<span class="string">"wsFrameServer.illegalReadState"</span>, getReadState()));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> SocketState.CLOSED;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>WsFrameServer#doOnDataAvailable</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> SocketState <span class="title">doOnDataAvailable</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// 处理通知</span></span><br><span class="line">    onDataAvailable();</span><br><span class="line">    <span class="keyword">while</span> (isOpen()) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (getReadState()) &#123;</span><br><span class="line">            <span class="keyword">case</span> PROCESSING:</span><br><span class="line">                <span class="comment">// 尝试CAS将状态由ReadState.PROCESSING设回ReadState.WAITING</span></span><br><span class="line">                <span class="keyword">if</span> (!changeReadState(ReadState.PROCESSING, ReadState.WAITING)) &#123;</span><br><span class="line">                    <span class="comment">// 失败下个循环继续</span></span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 返回已升级</span></span><br><span class="line">                <span class="keyword">return</span> SocketState.UPGRADED;</span><br><span class="line">            <span class="keyword">case</span> SUSPENDING_PROCESS:</span><br><span class="line">                <span class="keyword">if</span> (!changeReadState(ReadState.SUSPENDING_PROCESS, ReadState.SUSPENDED)) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> SocketState.SUSPENDED;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(sm.getString(<span class="string">"wsFrameServer.illegalReadState"</span>, getReadState()));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> SocketState.CLOSED;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>WsFrameServer#onDataAvailable</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onDataAvailable</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 打开状态 &amp;&amp; 缓冲有未读数据 &amp;&amp; 未被中断</span></span><br><span class="line">    <span class="keyword">if</span> (isOpen() &amp;&amp; inputBuffer.hasRemaining() &amp;&amp; !isSuspended()) &#123;</span><br><span class="line">        <span class="comment">// 在从SocketChannel读取数据前，先从缓冲读</span></span><br><span class="line">        processInputBuffer();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 直到没有数据可读</span></span><br><span class="line">    <span class="keyword">while</span> (isOpen() &amp;&amp; !isSuspended()) &#123;</span><br><span class="line">        <span class="comment">// 先标记当前读索引</span></span><br><span class="line">        inputBuffer.mark();</span><br><span class="line">        <span class="comment">// 把索引指向limit，limit指向capacity，为了尽可能读取更多的数据进缓冲</span></span><br><span class="line">        inputBuffer.position(inputBuffer.limit()).limit(inputBuffer.capacity());</span><br><span class="line">        <span class="comment">// 非阻塞地从SocketChannel读取数据到缓冲</span></span><br><span class="line">        <span class="keyword">int</span> read = socketWrapper.read(<span class="keyword">false</span>, inputBuffer);</span><br><span class="line">        <span class="comment">// 把limit指向写索引，并恢复索引为mark</span></span><br><span class="line">        inputBuffer.limit(inputBuffer.position()).reset();</span><br><span class="line">        <span class="keyword">if</span> (read &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> EOFException();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 没有数据可读</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (read == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="comment">// 处理缓冲的数据</span></span><br><span class="line">        processInputBuffer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>NioEndpoint$NioSocketWrapper#read</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">read</span><span class="params">(<span class="keyword">boolean</span> block, ByteBuffer to)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// 如果有未读Buffer，先读取SocketBufferHandler的读缓冲到Processor的缓冲ByteBuffer</span></span><br><span class="line">    <span class="keyword">int</span> nRead = populateReadBuffer(to);</span><br><span class="line">    <span class="keyword">if</span> (nRead &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 读成功，直接返回</span></span><br><span class="line">        <span class="keyword">return</span> nRead;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// SocketBufferHandler的读缓冲已读完，准备从SocketChannel读</span></span><br><span class="line">    <span class="comment">// The socket read buffer capacity is socket.appReadBufSize</span></span><br><span class="line">    <span class="keyword">int</span> limit = socketBufferHandler.getReadBuffer().capacity();</span><br><span class="line">    <span class="comment">// 缓冲剩余部分大于限制，容量足够</span></span><br><span class="line">    <span class="keyword">if</span> (to.remaining() &gt;= limit) &#123;</span><br><span class="line">        <span class="comment">// 设置该次读取的最大值</span></span><br><span class="line">        to.limit(to.position() + limit);</span><br><span class="line">        <span class="comment">// 直接从SocketChannel读到Processor的缓冲ByteBuffer</span></span><br><span class="line">        nRead = fillReadBuffer(block, to);</span><br><span class="line">        <span class="comment">// 更新上次读取时间</span></span><br><span class="line">        updateLastRead();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 先把数据读到SocketBufferHandler的读缓冲</span></span><br><span class="line">        nRead = fillReadBuffer(block);</span><br><span class="line">        <span class="comment">// 更新上次读取时间</span></span><br><span class="line">        updateLastRead();</span><br><span class="line">        <span class="comment">// 再读取SocketBufferHandler的读缓冲到Processor的缓冲ByteBuffer</span></span><br><span class="line">        <span class="keyword">if</span> (nRead &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            nRead = populateReadBuffer(to);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> nRead;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>SocketWrapperBase#populateReadBuffer</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">populateReadBuffer</span><span class="params">(ByteBuffer to)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Is there enough data in the read buffer to satisfy this request?</span></span><br><span class="line">    <span class="comment">// Copy what data there is in the read buffer to the byte array</span></span><br><span class="line">    socketBufferHandler.configureReadBufferForRead();</span><br><span class="line">    <span class="keyword">int</span> nRead = transfer(socketBufferHandler.getReadBuffer(), to);</span><br><span class="line">    <span class="keyword">return</span> nRead;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>NioEndpoint$NioSocketWrapper#fillReadBuffer</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">fillReadBuffer</span><span class="params">(<span class="keyword">boolean</span> block, ByteBuffer to)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> nRead;</span><br><span class="line">    NioChannel socket = getSocket();</span><br><span class="line">    <span class="keyword">if</span> (socket <span class="keyword">instanceof</span> ClosedNioChannel) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ClosedChannelException();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (block) &#123;</span><br><span class="line">        Selector selector = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            selector = pool.get();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException x) &#123;</span><br><span class="line">            <span class="comment">// Ignore</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            nRead = pool.read(to, socket, selector, getReadTimeout());</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (selector != <span class="keyword">null</span>) &#123;</span><br><span class="line">                pool.put(selector);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        nRead = socket.read(to);</span><br><span class="line">        <span class="keyword">if</span> (nRead == -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> EOFException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> nRead;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>NioEndpoint$NioSocketWrapper#fillReadBuffer</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">fillReadBuffer</span><span class="params">(<span class="keyword">boolean</span> block)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    socketBufferHandler.configureReadBufferForWrite();</span><br><span class="line">    <span class="keyword">return</span> fillReadBuffer(block, socketBufferHandler.getReadBuffer());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意这里的Selector是来自NioEndpoint绑定时初始化的SelectorPool，但是默认是共享的，也就是只有一个。</p>
<p>详细可以参考另一篇Response，写和读原理是一样的。</p>
<p>WsFrameBase#processInputBuffer</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">processInputBuffer</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (!isSuspended()) &#123;</span><br><span class="line">        <span class="comment">// 更新时间</span></span><br><span class="line">        wsSession.updateLastActive();</span><br><span class="line">        <span class="comment">// 初始状态</span></span><br><span class="line">        <span class="keyword">if</span> (state == State.NEW_FRAME) &#123;</span><br><span class="line">            <span class="comment">// 解析初始头部</span></span><br><span class="line">            <span class="keyword">if</span> (!processInitialHeader()) &#123;</span><br><span class="line">                <span class="comment">// 缓冲数据不足，跳出循环</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!open) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IOException(sm.getString(<span class="string">"wsFrame.closed"</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 解析完了部分头部</span></span><br><span class="line">        <span class="keyword">if</span> (state == State.PARTIAL_HEADER) &#123;</span><br><span class="line">            <span class="comment">// 解析剩下的头部</span></span><br><span class="line">            <span class="keyword">if</span> (!processRemainingHeader()) &#123;</span><br><span class="line">                <span class="comment">// 缓冲数据不足，跳出循环</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 解析完了头部</span></span><br><span class="line">        <span class="keyword">if</span> (state == State.DATA) &#123;</span><br><span class="line">            <span class="comment">// 解析剩下的数据</span></span><br><span class="line">            <span class="keyword">if</span> (!processData()) &#123;</span><br><span class="line">                <span class="comment">// 缓冲数据不足，跳出循环</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p>WebSocket协议可以参考<a href="https://tools.ietf.org/html/rfc6455" target="_blank" rel="noopener">RFC的文档</a>，我看的是<a href="https://github.com/HJava/myBlog/tree/master/WebSocket" target="_blank" rel="noopener">中文翻译</a>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> 0                   1                   2                   3</span><br><span class="line"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span><br><span class="line">+-+-+-+-+-------+-+-------------+-------------------------------+</span><br><span class="line">|F|R|R|R| opcode|M| Payload len |    Extended payload length    |</span><br><span class="line">|I|S|S|S|  (4)  |A|     (7)     |             (16/64)           |</span><br><span class="line">|N|V|V|V|       |S|             |   (if payload len==126/127)   |</span><br><span class="line">| |1|2|3|       |K|             |                               |</span><br><span class="line">+-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +</span><br><span class="line">|     Extended payload length continued, if payload len == 127  |</span><br><span class="line">+ - - - - - - - - - - - - - - - +-------------------------------+</span><br><span class="line">|                               |Masking-key, if MASK set to 1  |</span><br><span class="line">+-------------------------------+-------------------------------+</span><br><span class="line">| Masking-key (continued)       |          Payload Data         |</span><br><span class="line">+-------------------------------- - - - - - - - - - - - - - - - +</span><br><span class="line">:                     Payload Data continued ...                :</span><br><span class="line">+ - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +</span><br><span class="line">|                     Payload Data continued ...                |</span><br><span class="line">+---------------------------------------------------------------+</span><br></pre></td></tr></table></figure>
<hr>
<p>WsFrameBase#processInitialHeader</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">processInitialHeader</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// 至少需要两字节</span></span><br><span class="line">    <span class="keyword">if</span> (inputBuffer.remaining() &lt; <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 第一个字节</span></span><br><span class="line">    <span class="keyword">int</span> b = inputBuffer.get();</span><br><span class="line">    <span class="comment">// 描述消息是否结束，为1则该消息为消息尾部，为0则还有后续数据包</span></span><br><span class="line">    <span class="comment">// 消息分片主要是在不必缓冲整个消息时，发送一个未知大小的消息，未分片的消息需要缓冲整个消息，以便获取消息大小</span></span><br><span class="line">    <span class="comment">// 首个分片(fin = 0 &amp;&amp; opCode != 0x0)，跟随多个(fin = 0 &amp;&amp; opCode = 0x0)的分片，终止于(fin = 1 &amp;&amp; opCode = 0x0)的分片</span></span><br><span class="line">    <span class="comment">// 不分片(fin = 1 &amp;&amp; opCode != 0x0)</span></span><br><span class="line">    <span class="comment">// 消息分片必须在发送端按照顺序发送给接收端</span></span><br><span class="line">    <span class="comment">// 控制帧不能被分片，但是控制帧可以被插入到分片传输，因为假如分片太长，心跳等控制帧也需要等待过长时间</span></span><br><span class="line">    fin = (b &amp; <span class="number">0x80</span>) != <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// RSV1，RSV2，RSV3，用于扩展定义，如果没有扩展约定，必须为0</span></span><br><span class="line">    rsv = (b &amp; <span class="number">0x70</span>) &gt;&gt;&gt; <span class="number">4</span>;</span><br><span class="line">    <span class="comment">// 表示消息接收类型，如果接收到未知的opCode，接收端必须关闭连接</span></span><br><span class="line">    opCode = (<span class="keyword">byte</span>) (b &amp; <span class="number">0x0F</span>);</span><br><span class="line">    <span class="comment">// 校验RSV</span></span><br><span class="line">    <span class="keyword">if</span> (!transformation.validateRsv(rsv, opCode)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> WsIOException(<span class="keyword">new</span> CloseReason(CloseCodes.PROTOCOL_ERROR, sm.getString(<span class="string">"wsFrame.wrongRsv"</span>, Integer.valueOf(rsv), Integer.valueOf(opCode))));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 0x0 连续帧</span></span><br><span class="line"><span class="comment">     * 0x1 文本数据帧</span></span><br><span class="line"><span class="comment">     * 0x2 二进制数据帧</span></span><br><span class="line"><span class="comment">     * 0x3-7 为非控制帧保留</span></span><br><span class="line"><span class="comment">     * 0x8 连接关闭</span></span><br><span class="line"><span class="comment">     * 0x9 Ping</span></span><br><span class="line"><span class="comment">     * 0xA Pong</span></span><br><span class="line"><span class="comment">     * 0xB-F 为控制帧保留</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// 控制帧</span></span><br><span class="line">    <span class="keyword">if</span> (Util.isControl(opCode)) &#123;</span><br><span class="line">        <span class="comment">// 不是消息尾部</span></span><br><span class="line">        <span class="keyword">if</span> (!fin) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> WsIOException(<span class="keyword">new</span> CloseReason(CloseCodes.PROTOCOL_ERROR, sm.getString(<span class="string">"wsFrame.controlFragmented"</span>)));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 不是ping，pong，close</span></span><br><span class="line">        <span class="keyword">if</span> (opCode != Constants.OPCODE_PING &amp;&amp; opCode != Constants.OPCODE_PONG &amp;&amp; opCode != Constants.OPCODE_CLOSE) &#123;</span><br><span class="line">            <span class="comment">// 无效的控制帧</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> WsIOException(<span class="keyword">new</span> CloseReason(CloseCodes.PROTOCOL_ERROR, sm.getString(<span class="string">"wsFrame.invalidOpCode"</span>, Integer.valueOf(opCode))));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 非控制帧</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 默认false</span></span><br><span class="line">        <span class="keyword">if</span> (continuationExpected) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!Util.isContinuation(opCode)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> WsIOException(<span class="keyword">new</span> CloseReason(CloseCodes.PROTOCOL_ERROR, sm.getString(<span class="string">"wsFrame.noContinuation"</span>)));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 消息是二进制数据</span></span><br><span class="line">                <span class="keyword">if</span> (opCode == Constants.OPCODE_BINARY) &#123;</span><br><span class="line">                    <span class="comment">// 非文本</span></span><br><span class="line">                    textMessage = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">int</span> size = wsSession.getMaxBinaryMessageBufferSize();</span><br><span class="line">                    <span class="keyword">if</span> (size != messageBufferBinary.capacity()) &#123;</span><br><span class="line">                        messageBufferBinary = ByteBuffer.allocate(size);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 使用二进制消息处理器</span></span><br><span class="line">                    binaryMsgHandler = wsSession.getBinaryMessageHandler();</span><br><span class="line">                    textMsgHandler = <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 消息是文本消息</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (opCode == Constants.OPCODE_TEXT) &#123;</span><br><span class="line">                    <span class="comment">// 文本</span></span><br><span class="line">                    textMessage = <span class="keyword">true</span>;</span><br><span class="line">                    <span class="keyword">int</span> size = wsSession.getMaxTextMessageBufferSize();</span><br><span class="line">                    <span class="keyword">if</span> (size != messageBufferText.capacity()) &#123;</span><br><span class="line">                        messageBufferText = CharBuffer.allocate(size);</span><br><span class="line">                    &#125;</span><br><span class="line">                    binaryMsgHandler = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="comment">// 使用文本消息处理器</span></span><br><span class="line">                    textMsgHandler = wsSession.getTextMessageHandler();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 无效</span></span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> WsIOException(<span class="keyword">new</span> CloseReason(CloseCodes.PROTOCOL_ERROR, sm.getString(<span class="string">"wsFrame.invalidOpCode"</span>, Integer.valueOf(opCode))));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IllegalStateException ise) &#123;</span><br><span class="line">                <span class="comment">// Thrown if the session is already closed</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> WsIOException(<span class="keyword">new</span> CloseReason(CloseCodes.PROTOCOL_ERROR, sm.getString(<span class="string">"wsFrame.sessionClosed"</span>)));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        continuationExpected = !fin;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 第二个字节</span></span><br><span class="line">    b = inputBuffer.get();</span><br><span class="line">    <span class="comment">// Mask标志，客户端发出的数据帧必须要掩码处理，数据需要解码，服务端发出的数据则不需要</span></span><br><span class="line">    <span class="keyword">if</span> ((b &amp; <span class="number">0x80</span>) == <span class="number">0</span> &amp;&amp; isMasked()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> WsIOException(<span class="keyword">new</span> CloseReason(CloseCodes.PROTOCOL_ERROR, sm.getString(<span class="string">"wsFrame.notMasked"</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * PayloadData的长度：7位，7+16位，7+64位</span></span><br><span class="line"><span class="comment">     * 如果值在0-125，则是payload的真实长度</span></span><br><span class="line"><span class="comment">     * 如果值是126，则后面2个字节的16位无符号整型数值才是payload的真实长度</span></span><br><span class="line"><span class="comment">     * 如果值是127，则后面8个字节的64位无符号整型数值才是payload的真实长度</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    payloadLength = b &amp; <span class="number">0x7F</span>;</span><br><span class="line">    <span class="comment">// 已解析完部分头</span></span><br><span class="line">    state = State.PARTIAL_HEADER;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>WsFrameBase#processRemainingHeader</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">processRemainingHeader</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// 忽略已读的两个字节，4是掩码</span></span><br><span class="line">    <span class="keyword">int</span> headerLength;</span><br><span class="line">    <span class="keyword">if</span> (isMasked()) &#123;</span><br><span class="line">        headerLength = <span class="number">4</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        headerLength = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 根据长度加上额外的字节</span></span><br><span class="line">    <span class="keyword">if</span> (payloadLength == <span class="number">126</span>) &#123;</span><br><span class="line">        headerLength += <span class="number">2</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (payloadLength == <span class="number">127</span>) &#123;</span><br><span class="line">        headerLength += <span class="number">8</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (inputBuffer.remaining() &lt; headerLength) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果有必要，计算新的Payload长度</span></span><br><span class="line">    <span class="keyword">if</span> (payloadLength == <span class="number">126</span>) &#123;</span><br><span class="line">        payloadLength = byteArrayToLong(inputBuffer.array(), inputBuffer.arrayOffset() + inputBuffer.position(), <span class="number">2</span>);</span><br><span class="line">        inputBuffer.position(inputBuffer.position() + <span class="number">2</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (payloadLength == <span class="number">127</span>) &#123;</span><br><span class="line">        payloadLength = byteArrayToLong(inputBuffer.array(), inputBuffer.arrayOffset() + inputBuffer.position(), <span class="number">8</span>);</span><br><span class="line">        inputBuffer.position(inputBuffer.position() + <span class="number">8</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (Util.isControl(opCode)) &#123;</span><br><span class="line">        <span class="comment">// 控制帧的Payload长度不能大于125字节</span></span><br><span class="line">        <span class="keyword">if</span> (payloadLength &gt; <span class="number">125</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> WsIOException(<span class="keyword">new</span> CloseReason(CloseCodes.PROTOCOL_ERROR, sm.getString(<span class="string">"wsFrame.controlPayloadTooBig"</span>, Long.valueOf(payloadLength))));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!fin) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> WsIOException(<span class="keyword">new</span> CloseReason(CloseCodes.PROTOCOL_ERROR, sm.getString(<span class="string">"wsFrame.controlNoFin"</span>)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 服务端收到客户端的消息，需要掩码</span></span><br><span class="line">    <span class="keyword">if</span> (isMasked()) &#123;</span><br><span class="line">        <span class="comment">// 从缓冲获取掩码Masking-key，填入mask数组，四字节</span></span><br><span class="line">        inputBuffer.get(mask, <span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 下一步需要解析Payload</span></span><br><span class="line">    state = State.DATA;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>WsFrameBase#processData</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">processData</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> result;</span><br><span class="line">    <span class="comment">// 控制帧</span></span><br><span class="line">    <span class="keyword">if</span> (Util.isControl(opCode)) &#123;</span><br><span class="line">        result = processDataControl();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 文本消息</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (textMessage) &#123;</span><br><span class="line">        <span class="keyword">if</span> (textMsgHandler == <span class="keyword">null</span>) &#123;</span><br><span class="line">            result = swallowInput();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            result = processDataText();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 二进制消息</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (binaryMsgHandler == <span class="keyword">null</span>) &#123;</span><br><span class="line">            result = swallowInput();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            result = processDataBinary();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 检查缓冲的空间</span></span><br><span class="line">    checkRoomPayload();</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>WsFrameBase#processDataText</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">processDataText</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// 复制可用的数据到消息二进制缓冲</span></span><br><span class="line">    TransformationResult tr = transformation.getMoreData(opCode, fin, rsv, messageBufferBinary);</span><br><span class="line">    <span class="comment">// 帧不完整</span></span><br><span class="line">    <span class="keyword">while</span> (!TransformationResult.END_OF_FRAME.equals(tr)) &#123;</span><br><span class="line">        <span class="comment">// 重置索引，将消息二进制缓冲切换到读模式</span></span><br><span class="line">        messageBufferBinary.flip();</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="comment">// 将消息二进制缓冲的字节解码为UTF-8的消息文本缓冲</span></span><br><span class="line">            CoderResult cr = utf8DecoderMessage.decode(messageBufferBinary, messageBufferText, <span class="keyword">false</span>);</span><br><span class="line">            <span class="comment">// 解码错误</span></span><br><span class="line">            <span class="keyword">if</span> (cr.isError()) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> WsIOException(<span class="keyword">new</span> CloseReason(CloseCodes.NOT_CONSISTENT, sm.getString(<span class="string">"wsFrame.invalidUtf8"</span>)));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 消息文本缓冲空间不够</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (cr.isOverflow()) &#123;</span><br><span class="line">                <span class="comment">// 使用消息分片</span></span><br><span class="line">                <span class="keyword">if</span> (usePartial()) &#123;</span><br><span class="line">                    <span class="comment">// 重置索引，将消息文本缓冲切换到读模式</span></span><br><span class="line">                    messageBufferText.flip();</span><br><span class="line">                    <span class="comment">// 反射调用EndPoint的onMessage方法，发送部分消息，发送完清空消息文本缓冲</span></span><br><span class="line">                    sendMessageText(<span class="keyword">false</span>);</span><br><span class="line">                    <span class="comment">// 这里再清空消息文本缓冲</span></span><br><span class="line">                    messageBufferText.clear();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> WsIOException(<span class="keyword">new</span> CloseReason(CloseCodes.TOO_BIG, sm.getString(<span class="string">"wsFrame.textMessageTooBig"</span>)));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 数据不足</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (cr.isUnderflow()) &#123;</span><br><span class="line">                <span class="comment">// 压缩消息二进制缓冲，腾出空间</span></span><br><span class="line">                messageBufferBinary.compact();</span><br><span class="line">                <span class="comment">// Need more input What did we run out of?</span></span><br><span class="line">                <span class="keyword">if</span> (TransformationResult.OVERFLOW.equals(tr)) &#123;</span><br><span class="line">                    <span class="comment">// 消息二进制缓冲已读完，退出内循环，填充更多数据到消息二进制缓冲</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// TransformationResult.UNDERFLOW</span></span><br><span class="line">                    <span class="comment">// 退出，从Socket读取更多消息</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="comment">// 内循环结束</span></span><br><span class="line">        <span class="comment">// 填充更多数据到消息二进制缓冲</span></span><br><span class="line">        tr = transformation.getMoreData(opCode, fin, rsv, messageBufferBinary);</span><br><span class="line">    &#125; <span class="comment">// 外循环结束</span></span><br><span class="line">    <span class="comment">// 重置索引，将消息二进制缓冲切换到读模式</span></span><br><span class="line">    messageBufferBinary.flip();</span><br><span class="line">    <span class="keyword">boolean</span> last = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">// 已经收到完整的帧</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        <span class="comment">// 将消息二进制缓冲的字节解码为UTF-8的消息文本缓冲</span></span><br><span class="line">        CoderResult cr = utf8DecoderMessage.decode(messageBufferBinary, messageBufferText, last);</span><br><span class="line">        <span class="comment">// 解码错误</span></span><br><span class="line">        <span class="keyword">if</span> (cr.isError()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> WsIOException(<span class="keyword">new</span> CloseReason(CloseCodes.NOT_CONSISTENT, sm.getString(<span class="string">"wsFrame.invalidUtf8"</span>)));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cr.isOverflow()) &#123;</span><br><span class="line">            <span class="comment">// Ran out of space in text buffer - flush it</span></span><br><span class="line">            <span class="keyword">if</span> (usePartial()) &#123;</span><br><span class="line">                messageBufferText.flip();</span><br><span class="line">                sendMessageText(<span class="keyword">false</span>);</span><br><span class="line">                messageBufferText.clear();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> WsIOException(<span class="keyword">new</span> CloseReason(CloseCodes.TOO_BIG, sm.getString(<span class="string">"wsFrame.textMessageTooBig"</span>)));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cr.isUnderflow() &amp;&amp; !last) &#123;</span><br><span class="line">            <span class="comment">// End of frame and possible message as well.</span></span><br><span class="line">            <span class="keyword">if</span> (continuationExpected) &#123;</span><br><span class="line">                <span class="comment">// If partial messages are supported, send what we have managed to decode</span></span><br><span class="line">                <span class="keyword">if</span> (usePartial()) &#123;</span><br><span class="line">                    messageBufferText.flip();</span><br><span class="line">                    sendMessageText(<span class="keyword">false</span>);</span><br><span class="line">                    messageBufferText.clear();</span><br><span class="line">                &#125;</span><br><span class="line">                messageBufferBinary.compact();</span><br><span class="line">                newFrame();</span><br><span class="line">                <span class="comment">// Process next frame</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Make sure coder has flushed all output</span></span><br><span class="line">                last = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// End of message</span></span><br><span class="line">            messageBufferText.flip();</span><br><span class="line">            <span class="comment">// 反射调用EndPoint的onMessage方法</span></span><br><span class="line">            sendMessageText(<span class="keyword">true</span>);</span><br><span class="line">            <span class="comment">// 重置缓冲和状态</span></span><br><span class="line">            newMessage();</span><br><span class="line">            <span class="comment">// 成功</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


		<footer>
			 
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

		</footer>
	</div>
	<!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->

	<script>var timeEnd = new Date();console.log('耗时：' + (timeEnd - timeStart));</script>
	<!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
	<!-- material design -->
	<!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
	<!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
	<!-- toc -->
	<!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
	<!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
	<!-- <script src="/js/main.js"></script> -->
</body>
</html>
