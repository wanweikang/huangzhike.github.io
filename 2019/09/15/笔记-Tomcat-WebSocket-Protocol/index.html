<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
        <script>
            var timeStart = new Date();
        </script>
        
        <title>[ç¬”è®°]-Tomcat-WebSocket-Protocol | ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜</title>
        
        <meta name="author" content="huangzhike">
        
        
        <meta name="description" content="UpgradeProcessorInternal#dispatch
    @Override
    public SocketState dispatch(SocketEvent status) {
        return internalHttpUpgradeHandler.upgrad">
        
        
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        
        <meta property="og:title" content="[ç¬”è®°]-Tomcat-WebSocket-Protocol"/>
        
        <meta property="og:site_name" content="ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜"/>
        
        
        <!-- favicon -->
        <link rel="icon" type="image/ico" href="/ok.ico" sizes="32x32">
        <meta name="msapplication-TileColor" content="#009688">
        <meta name="msapplication-TileImage" content="/mstile-144x144.ico">
        <meta name="theme-color" content="#009688">
        <!-- favicon end -->
        <!-- <link href="//ok.ico" rel="icon"> -->
        
        <!-- toc -->
        <!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
        <!-- material design -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
        <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
        
        <!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
        <!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
    <meta name="generator" content="Hexo 4.2.1"></head>

<body>
    <nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">èœå•</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" title="ä¸‹ä¸€å¥æ˜¯ï¼šå®¢æœ‰å¯äººæœŸä¸æ¥ã€‚å°æ—¶å€™ï¼Œå–œæ¬¢é åœ¨é˜³å°ä¸Šï¼Œä¸€è¾¹å¹é£ï¼Œä¸€è¾¹çœ‹ä¹¦ï¼Œå–œæ¬¢è¯»ä¹¦å—ï¼Œéªšå¹´ï¼Ÿ" href="/">ä¹¦å½“å¿«æ„è¯»æ˜“å°½</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" target="_blank" rel="noopener" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

    <div class="container" >
        <div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[ç¬”è®°]-Tomcat-WebSocket-Protocol</h2>
				
				<div>
					<div class="post-time">2019-09-15</div>
				</div>
				
				<div class="article-content">
				<p>UpgradeProcessorInternal#dispatch</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> SocketState <span class="token function">dispatch</span><span class="token punctuation">(</span>SocketEvent status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> internalHttpUpgradeHandler<span class="token punctuation">.</span><span class="token function">upgradeDispatch</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>WsHttpUpgradeHandler#upgradeDispatch</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> SocketState <span class="token function">upgradeDispatch</span><span class="token punctuation">(</span>SocketEvent status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å¯è¯»äº‹ä»¶</span>
            <span class="token keyword">case</span> OPEN_READ<span class="token operator">:</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> wsFrame<span class="token punctuation">.</span><span class="token function">notifyDataAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">WsIOException</span> ws<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">close</span><span class="token punctuation">(</span>ws<span class="token punctuation">.</span><span class="token function">getCloseReason</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ioe<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">onError</span><span class="token punctuation">(</span>ioe<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    CloseReason cr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CloseReason</span><span class="token punctuation">(</span>CloseCodes<span class="token punctuation">.</span>CLOSED_ABNORMALLY<span class="token punctuation">,</span> ioe<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">close</span><span class="token punctuation">(</span>cr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å¯å†™äº‹ä»¶</span>
            <span class="token keyword">case</span> OPEN_WRITE<span class="token operator">:</span>
                wsRemoteEndpointServer<span class="token punctuation">.</span><span class="token function">onWritePossible</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> STOP<span class="token operator">:</span>
                CloseReason cr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CloseReason</span><span class="token punctuation">(</span>CloseCodes<span class="token punctuation">.</span>GOING_AWAY<span class="token punctuation">,</span> sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"wsHttpUpgradeHandler.serverStop"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    wsSession<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>cr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ioe<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">onError</span><span class="token punctuation">(</span>ioe<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    cr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CloseReason</span><span class="token punctuation">(</span>CloseCodes<span class="token punctuation">.</span>CLOSED_ABNORMALLY<span class="token punctuation">,</span> ioe<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">close</span><span class="token punctuation">(</span>cr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> ERROR<span class="token operator">:</span>
                String msg <span class="token operator">=</span> sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"wsHttpUpgradeHandler.closeOnError"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                wsSession<span class="token punctuation">.</span><span class="token function">doClose</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CloseReason</span><span class="token punctuation">(</span>CloseCodes<span class="token punctuation">.</span>GOING_AWAY<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">CloseReason</span><span class="token punctuation">(</span>CloseCodes<span class="token punctuation">.</span>CLOSED_ABNORMALLY<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">//$FALL-THROUGH$</span>
            <span class="token keyword">case</span> DISCONNECT<span class="token operator">:</span>
            <span class="token keyword">case</span> TIMEOUT<span class="token operator">:</span>
            <span class="token keyword">case</span> CONNECT_FAIL<span class="token operator">:</span>
                <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// åªè¦æ˜¯æ‰“å¼€çŠ¶æ€</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>wsFrame<span class="token punctuation">.</span><span class="token function">isOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>UPGRADED<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>WsFrameServer#notifyDataAvailable</p>
<pre class=" language-java"><code class="language-java">    SocketState <span class="token function">notifyDataAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// åˆå§‹å€¼</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">isOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token function">getReadState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// åˆå§‹ä¸ºReadState.WAITING</span>
                <span class="token keyword">case</span> WAITING<span class="token operator">:</span>
                    <span class="token comment" spellcheck="true">// å°è¯•CASå°†çŠ¶æ€ç”±ReadState.WAITINGè®¾ä¸ºReadState.PROCESSING</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">changeReadState</span><span class="token punctuation">(</span>ReadState<span class="token punctuation">.</span>WAITING<span class="token punctuation">,</span> ReadState<span class="token punctuation">.</span>PROCESSING<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// å¤±è´¥ä¸‹æ¬¡å¾ªç¯ç»§ç»­</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// æ”¶åˆ°æ¶ˆæ¯ï¼Œæ•°æ®å¯ç”¨</span>
                        <span class="token keyword">return</span> <span class="token function">doOnDataAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">changeReadState</span><span class="token punctuation">(</span>ReadState<span class="token punctuation">.</span>CLOSING<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token keyword">case</span> SUSPENDING_WAIT<span class="token operator">:</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">changeReadState</span><span class="token punctuation">(</span>ReadState<span class="token punctuation">.</span>SUSPENDING_WAIT<span class="token punctuation">,</span> ReadState<span class="token punctuation">.</span>SUSPENDED<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>SUSPENDED<span class="token punctuation">;</span>
                <span class="token keyword">default</span><span class="token operator">:</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"wsFrameServer.illegalReadState"</span><span class="token punctuation">,</span> <span class="token function">getReadState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>WsFrameServer#doOnDataAvailable</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> SocketState <span class="token function">doOnDataAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// å¤„ç†é€šçŸ¥</span>
        <span class="token function">onDataAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">isOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token function">getReadState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> PROCESSING<span class="token operator">:</span>
                    <span class="token comment" spellcheck="true">// å°è¯•CASå°†çŠ¶æ€ç”±ReadState.PROCESSINGè®¾å›ReadState.WAITING</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">changeReadState</span><span class="token punctuation">(</span>ReadState<span class="token punctuation">.</span>PROCESSING<span class="token punctuation">,</span> ReadState<span class="token punctuation">.</span>WAITING<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// å¤±è´¥ä¸‹ä¸ªå¾ªç¯ç»§ç»­</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// è¿”å›å·²å‡çº§</span>
                    <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>UPGRADED<span class="token punctuation">;</span>
                <span class="token keyword">case</span> SUSPENDING_PROCESS<span class="token operator">:</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">changeReadState</span><span class="token punctuation">(</span>ReadState<span class="token punctuation">.</span>SUSPENDING_PROCESS<span class="token punctuation">,</span> ReadState<span class="token punctuation">.</span>SUSPENDED<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>SUSPENDED<span class="token punctuation">;</span>
                <span class="token keyword">default</span><span class="token operator">:</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"wsFrameServer.illegalReadState"</span><span class="token punctuation">,</span> <span class="token function">getReadState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> SocketState<span class="token punctuation">.</span>CLOSED<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>WsFrameServer#onDataAvailable</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">onDataAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// æ‰“å¼€çŠ¶æ€ &amp;&amp; ç¼“å†²æœ‰æœªè¯»æ•°æ® &amp;&amp; æœªè¢«ä¸­æ–­</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> inputBuffer<span class="token punctuation">.</span><span class="token function">hasRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isSuspended</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// åœ¨ä»SocketChannelè¯»å–æ•°æ®å‰ï¼Œå…ˆä»ç¼“å†²è¯»</span>
            <span class="token function">processInputBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ç›´åˆ°æ²¡æœ‰æ•°æ®å¯è¯»</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">isOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isSuspended</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å…ˆæ ‡è®°å½“å‰è¯»ç´¢å¼•</span>
            inputBuffer<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æŠŠç´¢å¼•æŒ‡å‘limitï¼ŒlimitæŒ‡å‘capacityï¼Œä¸ºäº†å°½å¯èƒ½è¯»å–æ›´å¤šçš„æ•°æ®è¿›ç¼“å†²</span>
            inputBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span>inputBuffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>inputBuffer<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// éé˜»å¡åœ°ä»SocketChannelè¯»å–æ•°æ®åˆ°ç¼“å†²</span>
            <span class="token keyword">int</span> read <span class="token operator">=</span> socketWrapper<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> inputBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æŠŠlimitæŒ‡å‘å†™ç´¢å¼•ï¼Œå¹¶æ¢å¤ç´¢å¼•ä¸ºmark</span>
            inputBuffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>inputBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>read <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">EOFException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// æ²¡æœ‰æ•°æ®å¯è¯»</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>read <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// å¤„ç†ç¼“å†²çš„æ•°æ®</span>
            <span class="token function">processInputBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>NioEndpoint$NioSocketWrapper#read</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> block<span class="token punctuation">,</span> ByteBuffer to<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å¦‚æœæœ‰æœªè¯»Bufferï¼Œå…ˆè¯»å–SocketBufferHandlerçš„è¯»ç¼“å†²åˆ°Processorçš„ç¼“å†²ByteBuffer</span>
            <span class="token keyword">int</span> nRead <span class="token operator">=</span> <span class="token function">populateReadBuffer</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>nRead <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// è¯»æˆåŠŸï¼Œç›´æ¥è¿”å›</span>
                <span class="token keyword">return</span> nRead<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// SocketBufferHandlerçš„è¯»ç¼“å†²å·²è¯»å®Œï¼Œå‡†å¤‡ä»SocketChannelè¯»</span>
            <span class="token comment" spellcheck="true">// The socket read buffer capacity is socket.appReadBufSize</span>
            <span class="token keyword">int</span> limit <span class="token operator">=</span> socketBufferHandler<span class="token punctuation">.</span><span class="token function">getReadBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ç¼“å†²å‰©ä½™éƒ¨åˆ†å¤§äºé™åˆ¶ï¼Œå®¹é‡è¶³å¤Ÿ</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>to<span class="token punctuation">.</span><span class="token function">remaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> limit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// è®¾ç½®è¯¥æ¬¡è¯»å–çš„æœ€å¤§å€¼</span>
                to<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>to<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> limit<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ç›´æ¥ä»SocketChannelè¯»åˆ°Processorçš„ç¼“å†²ByteBuffer</span>
                nRead <span class="token operator">=</span> <span class="token function">fillReadBuffer</span><span class="token punctuation">(</span>block<span class="token punctuation">,</span> to<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// æ›´æ–°ä¸Šæ¬¡è¯»å–æ—¶é—´</span>
                <span class="token function">updateLastRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å…ˆæŠŠæ•°æ®è¯»åˆ°SocketBufferHandlerçš„è¯»ç¼“å†²</span>
                nRead <span class="token operator">=</span> <span class="token function">fillReadBuffer</span><span class="token punctuation">(</span>block<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// æ›´æ–°ä¸Šæ¬¡è¯»å–æ—¶é—´</span>
                <span class="token function">updateLastRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å†è¯»å–SocketBufferHandlerçš„è¯»ç¼“å†²åˆ°Processorçš„ç¼“å†²ByteBuffer</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>nRead <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    nRead <span class="token operator">=</span> <span class="token function">populateReadBuffer</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> nRead<span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>SocketWrapperBase#populateReadBuffer</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">protected</span> <span class="token keyword">int</span> <span class="token function">populateReadBuffer</span><span class="token punctuation">(</span>ByteBuffer to<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Is there enough data in the read buffer to satisfy this request?</span>
        <span class="token comment" spellcheck="true">// Copy what data there is in the read buffer to the byte array</span>
        socketBufferHandler<span class="token punctuation">.</span><span class="token function">configureReadBufferForRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> nRead <span class="token operator">=</span> <span class="token function">transfer</span><span class="token punctuation">(</span>socketBufferHandler<span class="token punctuation">.</span><span class="token function">getReadBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> to<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> nRead<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>NioEndpoint$NioSocketWrapper#fillReadBuffer</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">fillReadBuffer</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> block<span class="token punctuation">,</span> ByteBuffer to<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
            <span class="token keyword">int</span> nRead<span class="token punctuation">;</span>
            NioChannel socket <span class="token operator">=</span> <span class="token function">getSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>socket <span class="token keyword">instanceof</span> <span class="token class-name">ClosedNioChannel</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ClosedChannelException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>block<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Selector selector <span class="token operator">=</span> null<span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    selector <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// Ignore</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    nRead <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> socket<span class="token punctuation">,</span> selector<span class="token punctuation">,</span> <span class="token function">getReadTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>selector <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        pool<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                nRead <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>nRead <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">EOFException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> nRead<span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>NioEndpoint$NioSocketWrapper#fillReadBuffer</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">fillReadBuffer</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> block<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
            socketBufferHandler<span class="token punctuation">.</span><span class="token function">configureReadBufferForWrite</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">fillReadBuffer</span><span class="token punctuation">(</span>block<span class="token punctuation">,</span> socketBufferHandler<span class="token punctuation">.</span><span class="token function">getReadBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>æ³¨æ„è¿™é‡Œçš„Selectoræ˜¯æ¥è‡ªNioEndpointç»‘å®šæ—¶åˆå§‹åŒ–çš„SelectorPoolï¼Œä½†æ˜¯é»˜è®¤æ˜¯å…±äº«çš„ï¼Œä¹Ÿå°±æ˜¯åªæœ‰ä¸€ä¸ªã€‚</p>
<p>è¯¦ç»†å¯ä»¥å‚è€ƒå¦ä¸€ç¯‡Responseï¼Œå†™å’Œè¯»åŸç†æ˜¯ä¸€æ ·çš„ã€‚</p>
<p>WsFrameBase#processInputBuffer</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">processInputBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isSuspended</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ›´æ–°æ—¶é—´</span>
            wsSession<span class="token punctuation">.</span><span class="token function">updateLastActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// åˆå§‹çŠ¶æ€</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> State<span class="token punctuation">.</span>NEW_FRAME<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// è§£æåˆå§‹å¤´éƒ¨</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">processInitialHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ç¼“å†²æ•°æ®ä¸è¶³ï¼Œè·³å‡ºå¾ªç¯</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>open<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span>sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"wsFrame.closed"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// è§£æå®Œäº†éƒ¨åˆ†å¤´éƒ¨</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> State<span class="token punctuation">.</span>PARTIAL_HEADER<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// è§£æå‰©ä¸‹çš„å¤´éƒ¨</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">processRemainingHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ç¼“å†²æ•°æ®ä¸è¶³ï¼Œè·³å‡ºå¾ªç¯</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// è§£æå®Œäº†å¤´éƒ¨</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">==</span> State<span class="token punctuation">.</span>DATA<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// è§£æå‰©ä¸‹çš„æ•°æ®</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">processData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ç¼“å†²æ•°æ®ä¸è¶³ï¼Œè·³å‡ºå¾ªç¯</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>WebSocketåè®®å¯ä»¥å‚è€ƒ<a href="https://tools.ietf.org/html/rfc6455" target="_blank" rel="noopener">RFCçš„æ–‡æ¡£</a>ï¼Œæˆ‘çœ‹çš„æ˜¯<a href="https://github.com/HJava/myBlog/tree/master/WebSocket" target="_blank" rel="noopener">ä¸­æ–‡ç¿»è¯‘</a>ã€‚</p>
<pre><code>  0                   1                   2                   3
  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-------+-+-------------+-------------------------------+
 |F|R|R|R| opcode|M| Payload len |    Extended payload length    |
 |I|S|S|S|  (4)  |A|     (7)     |             (16/64)           |
 |N|V|V|V|       |S|             |   (if payload len==126/127)   |
 | |1|2|3|       |K|             |                               |
 +-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +
 |     Extended payload length continued, if payload len == 127  |
 + - - - - - - - - - - - - - - - +-------------------------------+
 |                               |Masking-key, if MASK set to 1  |
 +-------------------------------+-------------------------------+
 | Masking-key (continued)       |          Payload Data         |
 +-------------------------------- - - - - - - - - - - - - - - - +
 :                     Payload Data continued ...                :
 + - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +
 |                     Payload Data continued ...                |
 +---------------------------------------------------------------+</code></pre><hr>
<p>WsFrameBase#processInitialHeader</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">processInitialHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// è‡³å°‘éœ€è¦ä¸¤å­—èŠ‚</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>inputBuffer<span class="token punctuation">.</span><span class="token function">remaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ç¬¬ä¸€ä¸ªå­—èŠ‚</span>
        <span class="token keyword">int</span> b <span class="token operator">=</span> inputBuffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æè¿°æ¶ˆæ¯æ˜¯å¦ç»“æŸï¼Œä¸º1åˆ™è¯¥æ¶ˆæ¯ä¸ºæ¶ˆæ¯å°¾éƒ¨ï¼Œä¸º0åˆ™è¿˜æœ‰åç»­æ•°æ®åŒ…</span>
        <span class="token comment" spellcheck="true">// æ¶ˆæ¯åˆ†ç‰‡ä¸»è¦æ˜¯åœ¨ä¸å¿…ç¼“å†²æ•´ä¸ªæ¶ˆæ¯æ—¶ï¼Œå‘é€ä¸€ä¸ªæœªçŸ¥å¤§å°çš„æ¶ˆæ¯ï¼Œæœªåˆ†ç‰‡çš„æ¶ˆæ¯éœ€è¦ç¼“å†²æ•´ä¸ªæ¶ˆæ¯ï¼Œä»¥ä¾¿è·å–æ¶ˆæ¯å¤§å°</span>
        <span class="token comment" spellcheck="true">// é¦–ä¸ªåˆ†ç‰‡(fin = 0 &amp;&amp; opCode != 0x0)ï¼Œè·Ÿéšå¤šä¸ª(fin = 0 &amp;&amp; opCode = 0x0)çš„åˆ†ç‰‡ï¼Œç»ˆæ­¢äº(fin = 1 &amp;&amp; opCode = 0x0)çš„åˆ†ç‰‡</span>
        <span class="token comment" spellcheck="true">// ä¸åˆ†ç‰‡(fin = 1 &amp;&amp; opCode != 0x0)</span>
        <span class="token comment" spellcheck="true">// æ¶ˆæ¯åˆ†ç‰‡å¿…é¡»åœ¨å‘é€ç«¯æŒ‰ç…§é¡ºåºå‘é€ç»™æ¥æ”¶ç«¯</span>
        <span class="token comment" spellcheck="true">// æ§åˆ¶å¸§ä¸èƒ½è¢«åˆ†ç‰‡ï¼Œä½†æ˜¯æ§åˆ¶å¸§å¯ä»¥è¢«æ’å…¥åˆ°åˆ†ç‰‡ä¼ è¾“ï¼Œå› ä¸ºå‡å¦‚åˆ†ç‰‡å¤ªé•¿ï¼Œå¿ƒè·³ç­‰æ§åˆ¶å¸§ä¹Ÿéœ€è¦ç­‰å¾…è¿‡é•¿æ—¶é—´</span>
        fin <span class="token operator">=</span> <span class="token punctuation">(</span>b <span class="token operator">&amp;</span> <span class="token number">0x80</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// RSV1ï¼ŒRSV2ï¼ŒRSV3ï¼Œç”¨äºæ‰©å±•å®šä¹‰ï¼Œå¦‚æœæ²¡æœ‰æ‰©å±•çº¦å®šï¼Œå¿…é¡»ä¸º0</span>
        rsv <span class="token operator">=</span> <span class="token punctuation">(</span>b <span class="token operator">&amp;</span> <span class="token number">0x70</span><span class="token punctuation">)</span> <span class="token operator">>>></span> <span class="token number">4</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è¡¨ç¤ºæ¶ˆæ¯æ¥æ”¶ç±»å‹ï¼Œå¦‚æœæ¥æ”¶åˆ°æœªçŸ¥çš„opCodeï¼Œæ¥æ”¶ç«¯å¿…é¡»å…³é—­è¿æ¥</span>
        opCode <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>b <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ ¡éªŒRSV</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>transformation<span class="token punctuation">.</span><span class="token function">validateRsv</span><span class="token punctuation">(</span>rsv<span class="token punctuation">,</span> opCode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">WsIOException</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CloseReason</span><span class="token punctuation">(</span>CloseCodes<span class="token punctuation">.</span>PROTOCOL_ERROR<span class="token punctuation">,</span> sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"wsFrame.wrongRsv"</span><span class="token punctuation">,</span> Integer<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>rsv<span class="token punctuation">)</span><span class="token punctuation">,</span> Integer<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>opCode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">/*
         * 0x0 è¿ç»­å¸§
         * 0x1 æ–‡æœ¬æ•°æ®å¸§
         * 0x2 äºŒè¿›åˆ¶æ•°æ®å¸§
         * 0x3-7 ä¸ºéæ§åˆ¶å¸§ä¿ç•™
         * 0x8 è¿æ¥å…³é—­
         * 0x9 Ping
         * 0xA Pong
         * 0xB-F ä¸ºæ§åˆ¶å¸§ä¿ç•™
         */</span>
        <span class="token comment" spellcheck="true">// æ§åˆ¶å¸§</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Util<span class="token punctuation">.</span><span class="token function">isControl</span><span class="token punctuation">(</span>opCode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ä¸æ˜¯æ¶ˆæ¯å°¾éƒ¨</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">WsIOException</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CloseReason</span><span class="token punctuation">(</span>CloseCodes<span class="token punctuation">.</span>PROTOCOL_ERROR<span class="token punctuation">,</span> sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"wsFrame.controlFragmented"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ä¸æ˜¯pingï¼Œpongï¼Œclose</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>opCode <span class="token operator">!=</span> Constants<span class="token punctuation">.</span>OPCODE_PING <span class="token operator">&amp;&amp;</span> opCode <span class="token operator">!=</span> Constants<span class="token punctuation">.</span>OPCODE_PONG <span class="token operator">&amp;&amp;</span> opCode <span class="token operator">!=</span> Constants<span class="token punctuation">.</span>OPCODE_CLOSE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æ— æ•ˆçš„æ§åˆ¶å¸§</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">WsIOException</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CloseReason</span><span class="token punctuation">(</span>CloseCodes<span class="token punctuation">.</span>PROTOCOL_ERROR<span class="token punctuation">,</span> sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"wsFrame.invalidOpCode"</span><span class="token punctuation">,</span> Integer<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>opCode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// éæ§åˆ¶å¸§</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// é»˜è®¤false</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>continuationExpected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Util<span class="token punctuation">.</span><span class="token function">isContinuation</span><span class="token punctuation">(</span>opCode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">WsIOException</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CloseReason</span><span class="token punctuation">(</span>CloseCodes<span class="token punctuation">.</span>PROTOCOL_ERROR<span class="token punctuation">,</span> sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"wsFrame.noContinuation"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// æ¶ˆæ¯æ˜¯äºŒè¿›åˆ¶æ•°æ®</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>opCode <span class="token operator">==</span> Constants<span class="token punctuation">.</span>OPCODE_BINARY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// éæ–‡æœ¬</span>
                        textMessage <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                        <span class="token keyword">int</span> size <span class="token operator">=</span> wsSession<span class="token punctuation">.</span><span class="token function">getMaxBinaryMessageBufferSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">!=</span> messageBufferBinary<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            messageBufferBinary <span class="token operator">=</span> ByteBuffer<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment" spellcheck="true">// ä½¿ç”¨äºŒè¿›åˆ¶æ¶ˆæ¯å¤„ç†å™¨</span>
                        binaryMsgHandler <span class="token operator">=</span> wsSession<span class="token punctuation">.</span><span class="token function">getBinaryMessageHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        textMsgHandler <span class="token operator">=</span> null<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// æ¶ˆæ¯æ˜¯æ–‡æœ¬æ¶ˆæ¯</span>
                    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>opCode <span class="token operator">==</span> Constants<span class="token punctuation">.</span>OPCODE_TEXT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// æ–‡æœ¬</span>
                        textMessage <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                        <span class="token keyword">int</span> size <span class="token operator">=</span> wsSession<span class="token punctuation">.</span><span class="token function">getMaxTextMessageBufferSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">!=</span> messageBufferText<span class="token punctuation">.</span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            messageBufferText <span class="token operator">=</span> CharBuffer<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        binaryMsgHandler <span class="token operator">=</span> null<span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// ä½¿ç”¨æ–‡æœ¬æ¶ˆæ¯å¤„ç†å™¨</span>
                        textMsgHandler <span class="token operator">=</span> wsSession<span class="token punctuation">.</span><span class="token function">getTextMessageHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// æ— æ•ˆ</span>
                    <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">WsIOException</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CloseReason</span><span class="token punctuation">(</span>CloseCodes<span class="token punctuation">.</span>PROTOCOL_ERROR<span class="token punctuation">,</span> sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"wsFrame.invalidOpCode"</span><span class="token punctuation">,</span> Integer<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>opCode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalStateException</span> ise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// Thrown if the session is already closed</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">WsIOException</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CloseReason</span><span class="token punctuation">(</span>CloseCodes<span class="token punctuation">.</span>PROTOCOL_ERROR<span class="token punctuation">,</span> sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"wsFrame.sessionClosed"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            continuationExpected <span class="token operator">=</span> <span class="token operator">!</span>fin<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ç¬¬äºŒä¸ªå­—èŠ‚</span>
        b <span class="token operator">=</span> inputBuffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Maskæ ‡å¿—ï¼Œå®¢æˆ·ç«¯å‘å‡ºçš„æ•°æ®å¸§å¿…é¡»è¦æ©ç å¤„ç†ï¼Œæ•°æ®éœ€è¦è§£ç ï¼ŒæœåŠ¡ç«¯å‘å‡ºçš„æ•°æ®åˆ™ä¸éœ€è¦</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>b <span class="token operator">&amp;</span> <span class="token number">0x80</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isMasked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">WsIOException</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CloseReason</span><span class="token punctuation">(</span>CloseCodes<span class="token punctuation">.</span>PROTOCOL_ERROR<span class="token punctuation">,</span> sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"wsFrame.notMasked"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">/*
         * PayloadDataçš„é•¿åº¦ï¼š7ä½ï¼Œ7+16ä½ï¼Œ7+64ä½
         * å¦‚æœå€¼åœ¨0-125ï¼Œåˆ™æ˜¯payloadçš„çœŸå®é•¿åº¦
         * å¦‚æœå€¼æ˜¯126ï¼Œåˆ™åé¢2ä¸ªå­—èŠ‚çš„16ä½æ— ç¬¦å·æ•´å‹æ•°å€¼æ‰æ˜¯payloadçš„çœŸå®é•¿åº¦
         * å¦‚æœå€¼æ˜¯127ï¼Œåˆ™åé¢8ä¸ªå­—èŠ‚çš„64ä½æ— ç¬¦å·æ•´å‹æ•°å€¼æ‰æ˜¯payloadçš„çœŸå®é•¿åº¦
         */</span>
        payloadLength <span class="token operator">=</span> b <span class="token operator">&amp;</span> <span class="token number">0x7F</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å·²è§£æå®Œéƒ¨åˆ†å¤´</span>
        state <span class="token operator">=</span> State<span class="token punctuation">.</span>PARTIAL_HEADER<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>WsFrameBase#processRemainingHeader</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">processRemainingHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// å¿½ç•¥å·²è¯»çš„ä¸¤ä¸ªå­—èŠ‚ï¼Œ4æ˜¯æ©ç </span>
        <span class="token keyword">int</span> headerLength<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isMasked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            headerLength <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            headerLength <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// æ ¹æ®é•¿åº¦åŠ ä¸Šé¢å¤–çš„å­—èŠ‚</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>payloadLength <span class="token operator">==</span> <span class="token number">126</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            headerLength <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>payloadLength <span class="token operator">==</span> <span class="token number">127</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            headerLength <span class="token operator">+=</span> <span class="token number">8</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>inputBuffer<span class="token punctuation">.</span><span class="token function">remaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> headerLength<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å¦‚æœæœ‰å¿…è¦ï¼Œè®¡ç®—æ–°çš„Payloadé•¿åº¦</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>payloadLength <span class="token operator">==</span> <span class="token number">126</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            payloadLength <span class="token operator">=</span> <span class="token function">byteArrayToLong</span><span class="token punctuation">(</span>inputBuffer<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> inputBuffer<span class="token punctuation">.</span><span class="token function">arrayOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> inputBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            inputBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span>inputBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>payloadLength <span class="token operator">==</span> <span class="token number">127</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            payloadLength <span class="token operator">=</span> <span class="token function">byteArrayToLong</span><span class="token punctuation">(</span>inputBuffer<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> inputBuffer<span class="token punctuation">.</span><span class="token function">arrayOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> inputBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            inputBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span>inputBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Util<span class="token punctuation">.</span><span class="token function">isControl</span><span class="token punctuation">(</span>opCode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ§åˆ¶å¸§çš„Payloadé•¿åº¦ä¸èƒ½å¤§äº125å­—èŠ‚</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>payloadLength <span class="token operator">></span> <span class="token number">125</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">WsIOException</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CloseReason</span><span class="token punctuation">(</span>CloseCodes<span class="token punctuation">.</span>PROTOCOL_ERROR<span class="token punctuation">,</span> sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"wsFrame.controlPayloadTooBig"</span><span class="token punctuation">,</span> Long<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>payloadLength<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">WsIOException</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CloseReason</span><span class="token punctuation">(</span>CloseCodes<span class="token punctuation">.</span>PROTOCOL_ERROR<span class="token punctuation">,</span> sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"wsFrame.controlNoFin"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// æœåŠ¡ç«¯æ”¶åˆ°å®¢æˆ·ç«¯çš„æ¶ˆæ¯ï¼Œéœ€è¦æ©ç </span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isMasked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ä»ç¼“å†²è·å–æ©ç Masking-keyï¼Œå¡«å…¥maskæ•°ç»„ï¼Œå››å­—èŠ‚</span>
            inputBuffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>mask<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ä¸‹ä¸€æ­¥éœ€è¦è§£æPayload</span>
        state <span class="token operator">=</span> State<span class="token punctuation">.</span>DATA<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>WsFrameBase#processData</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">processData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> result<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ§åˆ¶å¸§</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Util<span class="token punctuation">.</span><span class="token function">isControl</span><span class="token punctuation">(</span>opCode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            result <span class="token operator">=</span> <span class="token function">processDataControl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// æ–‡æœ¬æ¶ˆæ¯</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>textMessage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>textMsgHandler <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                result <span class="token operator">=</span> <span class="token function">swallowInput</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                result <span class="token operator">=</span> <span class="token function">processDataText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// äºŒè¿›åˆ¶æ¶ˆæ¯</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>binaryMsgHandler <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                result <span class="token operator">=</span> <span class="token function">swallowInput</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                result <span class="token operator">=</span> <span class="token function">processDataBinary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// æ£€æŸ¥ç¼“å†²çš„ç©ºé—´</span>
        <span class="token function">checkRoomPayload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>WsFrameBase#processDataText</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">processDataText</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// å¤åˆ¶å¯ç”¨çš„æ•°æ®åˆ°æ¶ˆæ¯äºŒè¿›åˆ¶ç¼“å†²</span>
        TransformationResult tr <span class="token operator">=</span> transformation<span class="token punctuation">.</span><span class="token function">getMoreData</span><span class="token punctuation">(</span>opCode<span class="token punctuation">,</span> fin<span class="token punctuation">,</span> rsv<span class="token punctuation">,</span> messageBufferBinary<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¸§ä¸å®Œæ•´</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>TransformationResult<span class="token punctuation">.</span>END_OF_FRAME<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>tr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// é‡ç½®ç´¢å¼•ï¼Œå°†æ¶ˆæ¯äºŒè¿›åˆ¶ç¼“å†²åˆ‡æ¢åˆ°è¯»æ¨¡å¼</span>
            messageBufferBinary<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å°†æ¶ˆæ¯äºŒè¿›åˆ¶ç¼“å†²çš„å­—èŠ‚è§£ç ä¸ºUTF-8çš„æ¶ˆæ¯æ–‡æœ¬ç¼“å†²</span>
                CoderResult cr <span class="token operator">=</span> utf8DecoderMessage<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>messageBufferBinary<span class="token punctuation">,</span> messageBufferText<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// è§£ç é”™è¯¯</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>cr<span class="token punctuation">.</span><span class="token function">isError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">WsIOException</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CloseReason</span><span class="token punctuation">(</span>CloseCodes<span class="token punctuation">.</span>NOT_CONSISTENT<span class="token punctuation">,</span> sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"wsFrame.invalidUtf8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// æ¶ˆæ¯æ–‡æœ¬ç¼“å†²ç©ºé—´ä¸å¤Ÿ</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cr<span class="token punctuation">.</span><span class="token function">isOverflow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ä½¿ç”¨æ¶ˆæ¯åˆ†ç‰‡</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">usePartial</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// é‡ç½®ç´¢å¼•ï¼Œå°†æ¶ˆæ¯æ–‡æœ¬ç¼“å†²åˆ‡æ¢åˆ°è¯»æ¨¡å¼</span>
                        messageBufferText<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// åå°„è°ƒç”¨EndPointçš„onMessageæ–¹æ³•ï¼Œå‘é€éƒ¨åˆ†æ¶ˆæ¯ï¼Œå‘é€å®Œæ¸…ç©ºæ¶ˆæ¯æ–‡æœ¬ç¼“å†²</span>
                        <span class="token function">sendMessageText</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// è¿™é‡Œå†æ¸…ç©ºæ¶ˆæ¯æ–‡æœ¬ç¼“å†²</span>
                        messageBufferText<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">WsIOException</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CloseReason</span><span class="token punctuation">(</span>CloseCodes<span class="token punctuation">.</span>TOO_BIG<span class="token punctuation">,</span> sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"wsFrame.textMessageTooBig"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// æ•°æ®ä¸è¶³</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cr<span class="token punctuation">.</span><span class="token function">isUnderflow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å‹ç¼©æ¶ˆæ¯äºŒè¿›åˆ¶ç¼“å†²ï¼Œè…¾å‡ºç©ºé—´</span>
                    messageBufferBinary<span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// Need more input What did we run out of?</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>TransformationResult<span class="token punctuation">.</span>OVERFLOW<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>tr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// æ¶ˆæ¯äºŒè¿›åˆ¶ç¼“å†²å·²è¯»å®Œï¼Œé€€å‡ºå†…å¾ªç¯ï¼Œå¡«å……æ›´å¤šæ•°æ®åˆ°æ¶ˆæ¯äºŒè¿›åˆ¶ç¼“å†²</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// TransformationResult.UNDERFLOW</span>
                        <span class="token comment" spellcheck="true">// é€€å‡ºï¼Œä»Socketè¯»å–æ›´å¤šæ¶ˆæ¯</span>
                        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// å†…å¾ªç¯ç»“æŸ</span>
            <span class="token comment" spellcheck="true">// å¡«å……æ›´å¤šæ•°æ®åˆ°æ¶ˆæ¯äºŒè¿›åˆ¶ç¼“å†²</span>
            tr <span class="token operator">=</span> transformation<span class="token punctuation">.</span><span class="token function">getMoreData</span><span class="token punctuation">(</span>opCode<span class="token punctuation">,</span> fin<span class="token punctuation">,</span> rsv<span class="token punctuation">,</span> messageBufferBinary<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// å¤–å¾ªç¯ç»“æŸ</span>
        <span class="token comment" spellcheck="true">// é‡ç½®ç´¢å¼•ï¼Œå°†æ¶ˆæ¯äºŒè¿›åˆ¶ç¼“å†²åˆ‡æ¢åˆ°è¯»æ¨¡å¼</span>
        messageBufferBinary<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> last <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å·²ç»æ”¶åˆ°å®Œæ•´çš„å¸§</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å°†æ¶ˆæ¯äºŒè¿›åˆ¶ç¼“å†²çš„å­—èŠ‚è§£ç ä¸ºUTF-8çš„æ¶ˆæ¯æ–‡æœ¬ç¼“å†²</span>
            CoderResult cr <span class="token operator">=</span> utf8DecoderMessage<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>messageBufferBinary<span class="token punctuation">,</span> messageBufferText<span class="token punctuation">,</span> last<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è§£ç é”™è¯¯</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cr<span class="token punctuation">.</span><span class="token function">isError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">WsIOException</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CloseReason</span><span class="token punctuation">(</span>CloseCodes<span class="token punctuation">.</span>NOT_CONSISTENT<span class="token punctuation">,</span> sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"wsFrame.invalidUtf8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cr<span class="token punctuation">.</span><span class="token function">isOverflow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Ran out of space in text buffer - flush it</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">usePartial</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    messageBufferText<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">sendMessageText</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    messageBufferText<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">WsIOException</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CloseReason</span><span class="token punctuation">(</span>CloseCodes<span class="token punctuation">.</span>TOO_BIG<span class="token punctuation">,</span> sm<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"wsFrame.textMessageTooBig"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cr<span class="token punctuation">.</span><span class="token function">isUnderflow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>last<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// End of frame and possible message as well.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>continuationExpected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// If partial messages are supported, send what we have managed to decode</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">usePartial</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        messageBufferText<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">sendMessageText</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        messageBufferText<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    messageBufferBinary<span class="token punctuation">.</span><span class="token function">compact</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">newFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// Process next frame</span>
                    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// Make sure coder has flushed all output</span>
                    last <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// End of message</span>
                messageBufferText<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// åå°„è°ƒç”¨EndPointçš„onMessageæ–¹æ³•</span>
                <span class="token function">sendMessageText</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// é‡ç½®ç¼“å†²å’ŒçŠ¶æ€</span>
                <span class="token function">newMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// æˆåŠŸ</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


        <footer>
             
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

        </footer>
    </div>
    <!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
    <script>
        var timeEnd = new Date();
        console.log('è€—æ—¶ï¼š' + (timeEnd - timeStart));
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre').forEach((block) => {
                block.classList.add("line-numbers");
            });
        });
    </script>
    <!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
    <!-- material design -->
    <!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
    <!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
    <!-- toc -->
    <!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
    <!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
    <!-- <script src="/js/main.js"></script> -->
    <script src="/js/prism.js"></script>
</body>
</html>
