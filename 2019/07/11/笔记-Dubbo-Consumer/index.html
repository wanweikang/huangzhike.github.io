<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
        <script>
            var timeStart = new Date();
        </script>
        
        <title>[ç¬”è®°]-Dubbo-Consumer | ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜</title>
        
        <meta name="author" content="huangzhike">
        
        
        <meta name="description" content="å¼•ç”¨æœåŠ¡

æœ¬åœ°å¼•ç”¨ï¼šç•¥

è¿œç¨‹å¼•ç”¨ï¼š

å¤„ç†URL:

æŒ‡å®šäº†URLï¼šè‹¥URLæ ¼å¼ä¸ºregistry://ï¼Œè¯´æ˜æŒ‡å®šæ³¨å†Œä¸­å¿ƒï¼Œä¸ºURLç”Ÿæˆreferå‚æ•°ï¼Œæ·»åŠ åˆ°URLåˆ—è¡¨ï¼Œå¦åˆ™æ˜¯ç›´è¿ï¼Œå¤„ç†URLå¹¶åŠ åˆ°URLåˆ—è¡¨ã€‚

æœªæŒ‡å®šURLï¼šè¯´æ˜ä½¿ç”¨æ³¨å†Œä¸­å¿ƒï¼ŒåŠ è½½RegistryURLåˆ—è¡¨ï¼ˆURLæ ¼å¼ç±»ä¼¼re">
        
        
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        
        <meta property="og:title" content="[ç¬”è®°]-Dubbo-Consumer"/>
        
        <meta property="og:site_name" content="ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜"/>
        
        
        <!-- favicon -->
        <link rel="icon" type="image/ico" href="/ok.ico" sizes="32x32">
        <meta name="msapplication-TileColor" content="#009688">
        <meta name="msapplication-TileImage" content="/mstile-144x144.ico">
        <meta name="theme-color" content="#009688">
        <!-- favicon end -->
        <!-- <link href="//ok.ico" rel="icon"> -->
        
        <!-- toc -->
        <!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
        <!-- material design -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
        <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
        
        <!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
        <!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
    <meta name="generator" content="Hexo 4.2.1"></head>

<body>
    <nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">èœå•</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" title="ä¸‹ä¸€å¥æ˜¯ï¼šå®¢æœ‰å¯äººæœŸä¸æ¥ã€‚å°æ—¶å€™ï¼Œå–œæ¬¢é åœ¨é˜³å°ä¸Šï¼Œä¸€è¾¹å¹é£ï¼Œä¸€è¾¹çœ‹ä¹¦ï¼Œå–œæ¬¢è¯»ä¹¦å—ï¼Œéªšå¹´ï¼Ÿ" href="/">ä¹¦å½“å¿«æ„è¯»æ˜“å°½</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" target="_blank" rel="noopener" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

    <div class="container" >
        <div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[ç¬”è®°]-Dubbo-Consumer</h2>
				
				<div>
					<div class="post-time">2019-07-11</div>
				</div>
				
				<div class="article-content">
				<p>å¼•ç”¨æœåŠ¡</p>
<ul>
<li><p>æœ¬åœ°å¼•ç”¨ï¼šç•¥</p>
</li>
<li><p>è¿œç¨‹å¼•ç”¨ï¼š</p>
<ul>
<li><p>å¤„ç†URL:</p>
<ul>
<li><p>æŒ‡å®šäº†URLï¼šè‹¥URLæ ¼å¼ä¸º<code>registry://</code>ï¼Œè¯´æ˜æŒ‡å®šæ³¨å†Œä¸­å¿ƒï¼Œä¸ºURLç”Ÿæˆ<code>refer</code>å‚æ•°ï¼Œæ·»åŠ åˆ°URLåˆ—è¡¨ï¼Œå¦åˆ™æ˜¯ç›´è¿ï¼Œå¤„ç†URLå¹¶åŠ åˆ°URLåˆ—è¡¨ã€‚</p>
</li>
<li><p>æœªæŒ‡å®šURLï¼šè¯´æ˜ä½¿ç”¨æ³¨å†Œä¸­å¿ƒï¼ŒåŠ è½½RegistryURLåˆ—è¡¨ï¼ˆURLæ ¼å¼ç±»ä¼¼<code>registry://registry-host:registry-port/org.apache.dubbo.registry.RegistryService?registry=zookeeper</code>ï¼‰ï¼Œå¹¶ä¸ºRegistryURLç”Ÿæˆ<code>refer</code>å‚æ•°ï¼Œæ·»åŠ åˆ°URLåˆ—è¡¨ã€‚</p>
</li>
</ul>
</li>
<li><p>ç”ŸæˆInvokerï¼š</p>
<ul>
<li><p>å¦‚æœURLåˆ—è¡¨åªæœ‰ä¸€ä¸ªURLï¼Œè¯´æ˜æ˜¯å•ä¸ªæ³¨å†Œä¸­å¿ƒæˆ–æœåŠ¡æä¾›è€…ï¼Œæ ¹æ®åè®®å¤´è°ƒç”¨Protocol$Adaptive#referç”ŸæˆInvokerï¼Œä»¥<code>registry://</code>ä¸ºä¾‹ï¼Œè°ƒç”¨çš„æ˜¯RegistryProtocol#referã€‚</p>
</li>
<li><p>å¦‚æœæœ‰å¤šä¸ªURLï¼Œè¯´æ˜æ˜¯å¤šä¸ªæ³¨å†Œä¸­å¿ƒæˆ–å¤šä¸ªæœåŠ¡æä¾›è€…ï¼Œæˆ–è€…ä¸¤è€…æ··åˆï¼š</p>
<ul>
<li><p>éå†è°ƒç”¨Protocol$Adaptive#referç”ŸæˆInvokerï¼Œå¹¶æ·»åŠ åˆ°Invokeråˆ—è¡¨ã€‚</p>
<ul>
<li><p>å–URLçš„registryå‚æ•°å€¼ï¼Œå¹¶å°†å…¶è®¾ç½®ä¸ºåè®®å¤´ï¼šå¦‚<code>registry://127.0.0.1:2181/org.apache.dubbo.registry.RegistryService?refer=xxx&amp;registry=zookeeper</code>æ”¹ä¸º<code>zookeeper://127.0.0.1:2181/org.apache.dubbo.registry.RegistryService?refer=xxx</code>ã€‚</p>
</li>
<li><p>é€šè¿‡URLè·å–è·å–æ³¨å†Œä¸­å¿ƒå®ä¾‹ï¼Œè¿™é‡Œæ˜¯ZookeeperRegistryã€‚</p>
</li>
<li><p>åˆ›å»ºRegistryDirectoryæ³¨å†Œç›®å½•å®ä¾‹ã€‚</p>
</li>
<li><p>ç”ŸæˆæœåŠ¡æ¶ˆè´¹è€…URLï¼Œæ ¼å¼ä¸º<code>consumer://consumer-host/service-interface-full-class-name:version?</code>ã€‚</p>
</li>
<li><p>æ³¨å†ŒæœåŠ¡æ¶ˆè´¹è€…ã€‚</p>
</li>
<li><p>æ ¹æ®æœåŠ¡æ¶ˆè´¹è€…URLä¸ºRegistryDirectoryå®ä¾‹ç”ŸæˆRouterChainã€‚</p>
</li>
<li><p>RegistryDirectoryè®¢é˜…providersã€configuratorsã€routersç­‰èŠ‚ç‚¹æ•°æ®ã€‚</p>
</li>
<li><p>é€šè¿‡Cluster$Adaptive#joinåŒ…è£…RegistryDirectoryï¼Œè¿”å›å•ä¸ªAbstractClusterInvokerï¼ˆä¸€ä¸ªRegistryå¯èƒ½æœ‰å¤šä¸ªProviderï¼Œæ‰€ä»¥åˆå¹¶ä¸ºä¸€ä¸ªï¼‰ã€‚</p>
</li>
</ul>
</li>
<li><p>å°†Invokeråˆ—è¡¨é€šè¿‡æ„é€ å‡½æ•°ä¼ å…¥StaticDirectoryå®ä¾‹ã€‚</p>
</li>
<li><p>é€šè¿‡Cluster$Adaptive#joinåŒ…è£…StaticDirectoryï¼Œå°†å¤šä¸ªæœåŠ¡æä¾›è€…åŒ…è£…æˆå•ä¸ªAbstractClusterInvokerè¿”å›ã€‚</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>ç”ŸæˆProxyï¼š</p>
<ul>
<li>ProxyFactory$Adaptive#getProxyä¸ºInvokerç”Ÿæˆä»£ç†ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>æ‹¦æˆªæœåŠ¡</p>
<ul>
<li><p>ProtocolFilterWrapper -&gt; ProtocolListenerWrapper -&gt; RegistryProtocol -&gt; â€¦</p>
<ul>
<li><p>é™æ€å˜é‡REF_PROTOCOLåœ¨ç±»åˆå§‹åŒ–æ—¶ï¼Œè·å–Protocolæ‰©å±•ç‚¹ï¼Œé€šè¿‡Wrapperç±»çš„æ„é€ å‡½æ•°è‡ªåŠ¨åŒ…è£¹å…¥Wrapperç±»ã€‚</p>
</li>
<li><p>ProtocolFilterWrapperï¼šå°†Filterç»„è£…æˆInvokerChainï¼Œåœ¨é“¾çš„æœ€åè°ƒç”¨çœŸæ­£çš„Invokerã€‚</p>
</li>
<li><p>ProtocolListenerWrapperï¼šInvokerListenerå’ŒExporterListenerï¼Œåœ¨æš´éœ²å’Œå¼•ç”¨å‰åå›è°ƒã€‚</p>
</li>
</ul>
</li>
<li><p>MockClusterWrapper -&gt; Cluster</p>
<ul>
<li><p>é™æ€å˜é‡CLUSTERåœ¨ç±»åˆå§‹åŒ–æ—¶ï¼Œè·å–CLUSTERæ‰©å±•ç‚¹ï¼Œé€šè¿‡Wrapperç±»çš„æ„é€ å‡½æ•°è‡ªåŠ¨åŒ…è£¹å…¥Wrapperç±»ã€‚</p>
</li>
<li><p>MockClusterWrapperï¼šMocké€»è¾‘ç›¸å…³ã€‚</p>
</li>
</ul>
</li>
</ul>
<hr>
<p>ReferenceConfig#createProxy</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"unchecked"</span><span class="token punctuation">,</span> <span class="token string">"rawtypes"</span><span class="token punctuation">,</span> <span class="token string">"deprecation"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> T <span class="token function">createProxy</span><span class="token punctuation">(</span>Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> map<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// æœ¬åœ°å¼•ç”¨</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldJvmRefer</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ç”Ÿæˆæœ¬åœ°å¼•ç”¨URLï¼Œåè®®ä¸ºinjvm</span>
            URL url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span>LOCAL_PROTOCOL<span class="token punctuation">,</span> LOCALHOST_VALUE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> interfaceClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addParameters</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è°ƒç”¨referæ–¹æ³•æ„å»ºInjvmInvokerå®ä¾‹</span>
            invoker <span class="token operator">=</span> REF_PROTOCOL<span class="token punctuation">.</span><span class="token function">refer</span><span class="token punctuation">(</span>interfaceClass<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// è¿œç¨‹å¼•ç”¨</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// urlä¸ä¸ºç©ºï¼Œè¡¨æ˜ç”¨æˆ·å¯èƒ½æƒ³æŒ‡å®šç‚¹å¯¹ç‚¹è°ƒç”¨</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>url <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> url<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
                    <span class="token keyword">for</span> <span class="token punctuation">(</span>String u <span class="token operator">:</span> us<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        URL url <span class="token operator">=</span> URL<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// è®¾ç½®æ¥å£å…¨é™å®šåä¸ºurlè·¯å¾„</span>
                            url <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">setPath</span><span class="token punctuation">(</span>interfaceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment" spellcheck="true">// è‹¥urlåè®®ä¸ºregistryï¼Œè¡¨æ˜ç”¨æˆ·æƒ³ä½¿ç”¨æŒ‡å®šçš„æ³¨å†Œä¸­å¿ƒ</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>REGISTRY_PROTOCOL<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">getProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// å°†mapè½¬æ¢ä¸ºæŸ¥è¯¢å­—ç¬¦ä¸²ï¼Œå¹¶ä½œä¸ºreferå‚æ•°çš„å€¼æ·»åŠ åˆ°urlä¸­</span>
                            urls<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">addParameterAndEncoded</span><span class="token punctuation">(</span>REFER_KEY<span class="token punctuation">,</span> StringUtils<span class="token punctuation">.</span><span class="token function">toQueryString</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// æ³¨å†Œä¸­å¿ƒ</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span> 
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>LOCAL_PROTOCOL<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span><span class="token function">getProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// åŠ è½½æ³¨å†Œä¸­å¿ƒurl</span>
                    List<span class="token operator">&lt;</span>URL<span class="token operator">></span> us <span class="token operator">=</span> <span class="token function">loadRegistries</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>CollectionUtils<span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>us<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span>URL u <span class="token operator">:</span> us<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// æ·»åŠ referå‚æ•°åˆ°urlä¸­ï¼Œå¹¶å°†urlæ·»åŠ åˆ°urlsä¸­</span>
                            urls<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>u<span class="token punctuation">.</span><span class="token function">addParameterAndEncoded</span><span class="token punctuation">(</span>REFER_KEY<span class="token punctuation">,</span> StringUtils<span class="token punctuation">.</span><span class="token function">toQueryString</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å•ä¸ªæ³¨å†Œä¸­å¿ƒæˆ–æœåŠ¡æä¾›è€…(æœåŠ¡ç›´è¿)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>urls<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æ ¹æ®urlåè®®å¤´ï¼Œè°ƒç”¨RegistryProtocolçš„referæ„å»ºInvokerå®ä¾‹</span>
                invoker <span class="token operator">=</span> REF_PROTOCOL<span class="token punctuation">.</span><span class="token function">refer</span><span class="token punctuation">(</span>interfaceClass<span class="token punctuation">,</span> urls<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å¤šä¸ªæ³¨å†Œä¸­å¿ƒæˆ–å¤šä¸ªæœåŠ¡æä¾›è€…ï¼Œæˆ–è€…ä¸¤è€…æ··åˆ</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                List<span class="token operator">&lt;</span>Invoker<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>></span> invokers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>Invoker<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                URL registryURL <span class="token operator">=</span> null<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// è·å–æ‰€æœ‰çš„Invoker</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>URL url <span class="token operator">:</span> urls<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// æ„å»ºInvoker</span>
                    invokers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>REF_PROTOCOL<span class="token punctuation">.</span><span class="token function">refer</span><span class="token punctuation">(</span>interfaceClass<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>registryURL <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
                    <span class="token comment" spellcheck="true">// å¦‚æœæ³¨å†Œä¸­å¿ƒé“¾æ¥ä¸ä¸ºç©ºï¼Œåˆ™å°†ä½¿ç”¨RegistryAwareCluster</span>
                    URL u <span class="token operator">=</span> registryURL<span class="token punctuation">.</span><span class="token function">addParameter</span><span class="token punctuation">(</span>CLUSTER_KEY<span class="token punctuation">,</span> RegistryAwareCluster<span class="token punctuation">.</span>NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// åˆ›å»ºStaticDirectoryå®ä¾‹ï¼Œå¹¶ç”±Clusterå¯¹å¤šä¸ªInvokerè¿›è¡Œåˆå¹¶</span>
                    invoker <span class="token operator">=</span> CLUSTER<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StaticDirectory</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> invokers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// æ²¡æœ‰æ³¨å†Œä¸­å¿ƒï¼Œæ˜¯ç›´æ¥å¼•ç”¨</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// not a registry url, must be direct invoke.</span>
                    invoker <span class="token operator">=</span> CLUSTER<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StaticDirectory</span><span class="token punctuation">(</span>invokers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ç”Ÿæˆä»£ç†ç±»</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>T<span class="token punctuation">)</span> PROXY_FACTORY<span class="token punctuation">.</span><span class="token function">getProxy</span><span class="token punctuation">(</span>invoker<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>JavassistProxyFactory#getProxy</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> T <span class="token function">getProxy</span><span class="token punctuation">(</span>Invoker<span class="token operator">&lt;</span>T<span class="token operator">></span> invoker<span class="token punctuation">,</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> interfaces<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ç”ŸæˆæŠ½è±¡ç±»Proxyå­ç±»ï¼Œå¹¶è°ƒç”¨Proxyå­ç±»çš„newInstanceæ–¹æ³•åˆ›å»ºProxyå®ä¾‹</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>T<span class="token punctuation">)</span> Proxy<span class="token punctuation">.</span><span class="token function">getProxy</span><span class="token punctuation">(</span>interfaces<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InvokerInvocationHandler</span><span class="token punctuation">(</span>invoker<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ä»¥DemoServiceä¸ºä¾‹ï¼Œç”Ÿæˆçš„ä»£ç†ç±»ä¸ºï¼š</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Proxy0</span> <span class="token keyword">extends</span> <span class="token class-name">Proxy</span> <span class="token keyword">implements</span> <span class="token class-name">DC</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> Object <span class="token function">newInstance</span><span class="token punctuation">(</span>InvocationHandler var1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">proxy0</span><span class="token punctuation">(</span>var1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">Proxy0</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span></code></pre>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">proxy0</span> <span class="token keyword">implements</span> <span class="token class-name">DC</span><span class="token punctuation">,</span> EchoService<span class="token punctuation">,</span> DemoService <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> Method<span class="token punctuation">[</span><span class="token punctuation">]</span> methods<span class="token punctuation">;</span>

    <span class="token keyword">private</span> InvocationHandler handler<span class="token punctuation">;</span>

    <span class="token keyword">public</span> String <span class="token function">sayHello</span><span class="token punctuation">(</span>String var1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Object<span class="token punctuation">[</span><span class="token punctuation">]</span> var2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>var1<span class="token punctuation">}</span><span class="token punctuation">;</span>
        Object var3 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handler<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> methods<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> var2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>String<span class="token punctuation">)</span> var3<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> Object $<span class="token function">echo</span><span class="token punctuation">(</span>Object var1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Object<span class="token punctuation">[</span><span class="token punctuation">]</span> var2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>var1<span class="token punctuation">}</span><span class="token punctuation">;</span>
        Object var3 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handler<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> methods<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> var2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>Object<span class="token punctuation">)</span> var3<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">proxy0</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">proxy0</span><span class="token punctuation">(</span>InvocationHandler var1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>handler <span class="token operator">=</span> var1<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span></code></pre>
<p>è®¢é˜…å›è°ƒ</p>
<p>æ”¶åˆ°æ³¨å†Œä¸­å¿ƒçš„æœåŠ¡æä¾›è€…é€šçŸ¥åï¼Œå°†æä¾›è€…URLè½¬ä¸ºInvokerã€‚</p>
<ul>
<li><p>URLæ ¼å¼ç±»ä¼¼ï¼š<code>dubbo://service-host:service-port/service-interface-full-class-name?version=xxx?interface=&amp;methods=</code>ã€‚</p>
</li>
<li><p>é€šè¿‡URLçš„<code>dubbo://</code>åè®®å¤´ï¼Œè¯†åˆ«æ‰©å±•ç‚¹ï¼Œè°ƒç”¨DubboProtocol#referï¼Œè¿”å›Providerå¼•ç”¨ã€‚</p>
</li>
</ul>
<p>RegistryDirectory#toInvokers</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Invoker<span class="token operator">&lt;</span>T<span class="token operator">>></span> <span class="token function">toInvokers</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>URL<span class="token operator">></span> urls<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// è·å–æœåŠ¡æ¶ˆè´¹ç«¯é…ç½®çš„åè®®</span>
        String queryProtocols <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>queryMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>PROTOCOL_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>URL providerUrl <span class="token operator">:</span> urls<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è·å–ä¸urlå¯¹åº”çš„Invoker</span>
            Invoker<span class="token operator">&lt;</span>T<span class="token operator">></span> invoker <span class="token operator">=</span> localUrlInvokerMap <span class="token operator">==</span> null <span class="token operator">?</span> null <span class="token operator">:</span> localUrlInvokerMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ç¼“å­˜æœªå‘½ä¸­</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>invoker <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>enabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// è°ƒç”¨referè·å–Invoker</span>
                        invoker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InvokerDelegate</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>protocol<span class="token punctuation">.</span><span class="token function">refer</span><span class="token punctuation">(</span>serviceType<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> providerUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> 
                <span class="token keyword">if</span> <span class="token punctuation">(</span>invoker <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ç¼“å­˜Invokerå®ä¾‹</span>
                    newUrlInvokerMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> invoker<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ç¼“å­˜å‘½ä¸­</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å°†invokerå­˜å‚¨åˆ°newUrlInvokerMapä¸­</span>
                newUrlInvokerMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> invoker<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        keys<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> newUrlInvokerMap<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ProtocolFilterWrapper#refer</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> Invoker<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token function">refer</span><span class="token punctuation">(</span>Class<span class="token operator">&lt;</span>T<span class="token operator">></span> type<span class="token punctuation">,</span> URL url<span class="token punctuation">)</span> <span class="token keyword">throws</span> RpcException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// registryç›´æ¥è°ƒç”¨</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>REGISTRY_PROTOCOL<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">getProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> protocol<span class="token punctuation">.</span><span class="token function">refer</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// åŒ…è£¹è¿‡æ»¤é“¾</span>
        <span class="token keyword">return</span> <span class="token function">buildInvokerChain</span><span class="token punctuation">(</span>protocol<span class="token punctuation">.</span><span class="token function">refer</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">,</span> REFERENCE_FILTER_KEY<span class="token punctuation">,</span> CommonConstants<span class="token punctuation">.</span>CONSUMER<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ProtocolListenerWrapper#refer</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> Invoker<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token function">refer</span><span class="token punctuation">(</span>Class<span class="token operator">&lt;</span>T<span class="token operator">></span> type<span class="token punctuation">,</span> URL url<span class="token punctuation">)</span> <span class="token keyword">throws</span> RpcException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// registryç›´æ¥è°ƒç”¨</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>REGISTRY_PROTOCOL<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">getProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> protocol<span class="token punctuation">.</span><span class="token function">refer</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ListenerInvokerWrapper</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">(</span>protocol<span class="token punctuation">.</span><span class="token function">refer</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">,</span> Collections<span class="token punctuation">.</span><span class="token function">unmodifiableList</span><span class="token punctuation">(</span>ExtensionLoader<span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span>InvokerListener<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getActivateExtension</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> INVOKER_LISTENER_KEY<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>DubboProtocol#refer</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> Invoker<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token function">refer</span><span class="token punctuation">(</span>Class<span class="token operator">&lt;</span>T<span class="token operator">></span> serviceType<span class="token punctuation">,</span> URL url<span class="token punctuation">)</span> <span class="token keyword">throws</span> RpcException <span class="token punctuation">{</span>
        <span class="token function">optimizeSerialization</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// åˆ›å»ºDubboInvoker</span>
        DubboInvoker<span class="token operator">&lt;</span>T<span class="token operator">></span> invoker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DubboInvoker</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">(</span>serviceType<span class="token punctuation">,</span> url<span class="token punctuation">,</span> <span class="token function">getClients</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">,</span> invokers<span class="token punctuation">)</span><span class="token punctuation">;</span>
        invokers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>invoker<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> invoker<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>è¿æ¥æœåŠ¡</p>
<p>DubboProtocol#initClient</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> ExchangeClient <span class="token function">initClient</span><span class="token punctuation">(</span>URL url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// client=netty</span>
        String str <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>RemotingConstants<span class="token punctuation">.</span>CLIENT_KEY<span class="token punctuation">,</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>RemotingConstants<span class="token punctuation">.</span>SERVER_KEY<span class="token punctuation">,</span> RemotingConstants<span class="token punctuation">.</span>DEFAULT_REMOTING_CLIENT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// codec=dubbo</span>
        url <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">addParameter</span><span class="token punctuation">(</span>RemotingConstants<span class="token punctuation">.</span>CODEC_KEY<span class="token punctuation">,</span> DubboCodec<span class="token punctuation">.</span>NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// heartbeat=</span>
        url <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">addParameterIfAbsent</span><span class="token punctuation">(</span>RemotingConstants<span class="token punctuation">.</span>HEARTBEAT_KEY<span class="token punctuation">,</span> String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>RemotingConstants<span class="token punctuation">.</span>DEFAULT_HEARTBEAT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ExchangeClient client<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// lazyé…ç½®</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>LAZY_CONNECT_KEY<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æ‡’åŠ è½½ExchangeClient</span>
                client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LazyConnectExchangeClient</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> requestHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æ™®é€šExchangeClient</span>
                client <span class="token operator">=</span> Exchangers<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> requestHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> client<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>Exchangers#getExchanger</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> Exchanger <span class="token function">getExchanger</span><span class="token punctuation">(</span>String type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> ExtensionLoader<span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span>Exchanger<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getExtension</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>HeaderExchanger#connect</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> ExchangeClient <span class="token function">connect</span><span class="token punctuation">(</span>URL url<span class="token punctuation">,</span> ExchangeHandler handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> RemotingException <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HeaderExchangeClient</span><span class="token punctuation">(</span>Transporters<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DecodeHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HeaderExchangeHandler</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>Transporters#getTransporter</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> Transporter <span class="token function">getTransporter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> ExtensionLoader<span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span>Transporter<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAdaptiveExtension</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>NettyTransporter#connect</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> Client <span class="token function">connect</span><span class="token punctuation">(</span>URL url<span class="token punctuation">,</span> ChannelHandler listener<span class="token punctuation">)</span> <span class="token keyword">throws</span> RemotingException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// åˆ›å»ºNettyClientå¯¹è±¡</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">NettyClient</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ChannelHandlers#wrapInternal</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">protected</span> ChannelHandler <span class="token function">wrapInternal</span><span class="token punctuation">(</span>ChannelHandler handler<span class="token punctuation">,</span> URL url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// é»˜è®¤AllDispatcher</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MultiMessageHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HeartbeatHandler</span><span class="token punctuation">(</span>ExtensionLoader<span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span>Dispatcher<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAdaptiveExtension</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>çº¿ç¨‹è½¬å‘å¤„ç†å™¨</p>
<p>AllDispatcher#dispatch</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AllDispatcher</span> <span class="token keyword">implements</span> <span class="token class-name">Dispatcher</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String NAME <span class="token operator">=</span> <span class="token string">"all"</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> ChannelHandler <span class="token function">dispatch</span><span class="token punctuation">(</span>ChannelHandler handler<span class="token punctuation">,</span> URL url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AllChannelHandler</span><span class="token punctuation">(</span>handler<span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span></code></pre>
<p>WrappedChannelHandler</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token function">WrappedChannelHandler</span><span class="token punctuation">(</span>ChannelHandler handler<span class="token punctuation">,</span> URL url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>handler <span class="token operator">=</span> handler<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>url <span class="token operator">=</span> url<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// é»˜è®¤fixed</span>
        executor <span class="token operator">=</span> <span class="token punctuation">(</span>ExecutorService<span class="token punctuation">)</span> ExtensionLoader<span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span>ThreadPool<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAdaptiveExtension</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getExecutor</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        String componentKey <span class="token operator">=</span> RemotingConstants<span class="token punctuation">.</span>EXECUTOR_SERVICE_COMPONENT_KEY<span class="token punctuation">;</span>

        DataStore dataStore <span class="token operator">=</span> ExtensionLoader<span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span>DataStore<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDefaultExtension</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ–¹ä¾¿å–å‡º</span>
        dataStore<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>componentKey<span class="token punctuation">,</span> Integer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> executor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>AbstractClient</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token function">AbstractClient</span><span class="token punctuation">(</span>URL url<span class="token punctuation">,</span> ChannelHandler handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> RemotingException <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">doOpen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> 
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        executor <span class="token operator">=</span> <span class="token punctuation">(</span>ExecutorService<span class="token punctuation">)</span> ExtensionLoader<span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span>DataStore<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDefaultExtension</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>CONSUMER_SIDE<span class="token punctuation">,</span> Integer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ExtensionLoader<span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span>DataStore<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDefaultExtension</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>CONSUMER_SIDE<span class="token punctuation">,</span> Integer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>AbstractEndpoint</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token function">AbstractEndpoint</span><span class="token punctuation">(</span>URL url<span class="token punctuation">,</span> ChannelHandler handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ChannelCodec</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>codec <span class="token operator">=</span> <span class="token function">getChannelCodec</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>timeout <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getPositiveParameter</span><span class="token punctuation">(</span>TIMEOUT_KEY<span class="token punctuation">,</span> DEFAULT_TIMEOUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>connectTimeout <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getPositiveParameter</span><span class="token punctuation">(</span>RemotingConstants<span class="token punctuation">.</span>CONNECT_TIMEOUT_KEY<span class="token punctuation">,</span> RemotingConstants<span class="token punctuation">.</span>DEFAULT_CONNECT_TIMEOUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>AbstractEndpoint#getChannelCodec</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">protected</span> <span class="token keyword">static</span> Codec2 <span class="token function">getChannelCodec</span><span class="token punctuation">(</span>URL url<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        String codecName <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>RemotingConstants<span class="token punctuation">.</span>CODEC_KEY<span class="token punctuation">,</span> <span class="token string">"telnet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ExtensionLoader<span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span>Codec2<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasExtension</span><span class="token punctuation">(</span>codecName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// é»˜è®¤ä½¿ç”¨DubboCountCodec</span>
            <span class="token keyword">return</span> ExtensionLoader<span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span>Codec2<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getExtension</span><span class="token punctuation">(</span>codecName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å¦‚æœä¸æ˜¯Codec2çš„å®ç°ï¼ŒæŸ¥æ‰¾Codecçš„å®ç°ï¼Œç„¶åç”¨CodecAdapteré€‚é…å™¨ç±»æ¥è½¬æ¢æˆCodec2</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CodecAdapter</span><span class="token punctuation">(</span>ExtensionLoader<span class="token punctuation">.</span><span class="token function">getExtensionLoader</span><span class="token punctuation">(</span>Codec<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getExtension</span><span class="token punctuation">(</span>codecName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>è°ƒç”¨æœåŠ¡</p>
<p>å¦‚æœæ˜¯å¤šä¸ªæ³¨å†Œä¸­å¿ƒçš„è¯ï¼Œå…¶å®æ˜¯åŒ…äº†ä¸¤å±‚Clusterçš„ï¼Œç¬¬ä¸€å±‚æ˜¯é™æ€çš„StaticDirectoryï¼Œç¬¬äºŒå±‚æ˜¯åŠ¨æ€çš„RegistryDirectoryã€‚</p>
<p>AbstractClusterInvoker#invoke</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> Result <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">final</span> Invocation invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> RpcException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// åˆ—ä¸¾Invoker</span>
        List<span class="token operator">&lt;</span>Invoker<span class="token operator">&lt;</span>T<span class="token operator">>></span> invokers <span class="token operator">=</span> <span class="token function">list</span><span class="token punctuation">(</span>invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// åŠ è½½LoadBalance</span>
        LoadBalance loadbalance <span class="token operator">=</span> <span class="token function">initLoadBalance</span><span class="token punctuation">(</span>invokers<span class="token punctuation">,</span> invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è°ƒç”¨doInvoke</span>
        <span class="token keyword">return</span> <span class="token function">doInvoke</span><span class="token punctuation">(</span>invocation<span class="token punctuation">,</span> invokers<span class="token punctuation">,</span> loadbalance<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>RegistryDirectory#doList</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> List<span class="token operator">&lt;</span>Invoker<span class="token operator">&lt;</span>T<span class="token operator">>></span> <span class="token function">doList</span><span class="token punctuation">(</span>Invocation invocation<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        List<span class="token operator">&lt;</span>Invoker<span class="token operator">&lt;</span>T<span class="token operator">>></span> invokers <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            invokers <span class="token operator">=</span> routerChain<span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token function">getConsumerUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> invokers <span class="token operator">==</span> null <span class="token operator">?</span> Collections<span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> invokers<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>FailoverClusterInvoker#doInvoke</p>
<pre class=" language-java"><code class="language-java">        <span class="token comment" spellcheck="true">// å¾ªç¯è°ƒç”¨ï¼Œå¤±è´¥é‡è¯•</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// é‡è¯•å‰é‡æ–°åˆ—ä¸¾Invokerï¼Œå¥½å¤„æ˜¯ï¼Œå¦‚æœæŸä¸ªæœåŠ¡æŒ‚äº†ï¼Œé€šè¿‡è°ƒç”¨listå¯å¾—åˆ°æœ€æ–°å¯ç”¨çš„Invokeråˆ—è¡¨</span>
                copyInvokers <span class="token operator">=</span> <span class="token function">list</span><span class="token punctuation">(</span>invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// é€šè¿‡è´Ÿè½½å‡è¡¡é€‰æ‹©Invoker</span>
            Invoker<span class="token operator">&lt;</span>T<span class="token operator">></span> invoker <span class="token operator">=</span> <span class="token function">select</span><span class="token punctuation">(</span>loadbalance<span class="token punctuation">,</span> invocation<span class="token punctuation">,</span> copyInvokers<span class="token punctuation">,</span> invoked<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ·»åŠ åˆ°invokeråˆ°invokedåˆ—è¡¨ä¸­</span>
            invoked<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>invoker<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è®¾ç½®invokedåˆ°RPCä¸Šä¸‹æ–‡ä¸­</span>
            RpcContext<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setInvokers</span><span class="token punctuation">(</span><span class="token punctuation">(</span>List<span class="token punctuation">)</span> invoked<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// è°ƒç”¨ç›®æ ‡Invokerçš„invokeæ–¹æ³•</span>
                Result result <span class="token operator">=</span> invoker<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> result<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                providers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>invoker<span class="token punctuation">.</span><span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span></code></pre>
<p>AbstractClusterInvoker#doSelect</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> Invoker<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token function">doSelect</span><span class="token punctuation">(</span>LoadBalance loadbalance<span class="token punctuation">,</span> Invocation invocation<span class="token punctuation">,</span> List<span class="token operator">&lt;</span>Invoker<span class="token operator">&lt;</span>T<span class="token operator">>></span> invokers<span class="token punctuation">,</span> List<span class="token operator">&lt;</span>Invoker<span class="token operator">&lt;</span>T<span class="token operator">>></span> selected<span class="token punctuation">)</span> <span class="token keyword">throws</span> RpcException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// é€šè¿‡è´Ÿè½½å‡è¡¡ç»„ä»¶é€‰æ‹©Invoker</span>
        Invoker<span class="token operator">&lt;</span>T<span class="token operator">></span> invoker <span class="token operator">=</span> loadbalance<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>invokers<span class="token punctuation">,</span> <span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> invoker<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>Filter#invoke</p>
<p>è¿‡æ»¤é“¾è°ƒç”¨ï¼šç•¥</p>
<p>DubboInvoker#doInvoke</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> Result <span class="token function">doInvoke</span><span class="token punctuation">(</span><span class="token keyword">final</span> Invocation invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 1 å¼‚æ­¥æ— è¿”å›å€¼</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isOneway<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">boolean</span> isSent <span class="token operator">=</span> <span class="token function">getUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethodParameter</span><span class="token punctuation">(</span>methodName<span class="token punctuation">,</span> RemotingConstants<span class="token punctuation">.</span>SENT_KEY<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å‘é€è¯·æ±‚</span>
                currentClient<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>inv<span class="token punctuation">,</span> isSent<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// è®¾ç½®ä¸Šä¸‹æ–‡ä¸­çš„futureå­—æ®µä¸ºnull</span>
                RpcContext<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFuture</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// è¿”å›ä¸€ä¸ªç©ºçš„RpcResult</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RpcResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 2 å¼‚æ­¥æœ‰è¿”å›å€¼</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>isAsync<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å‘é€è¯·æ±‚ï¼Œå¹¶å¾—åˆ°ä¸€ä¸ªResponseFutureå®ä¾‹</span>
                ResponseFuture future <span class="token operator">=</span> currentClient<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>inv<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// è®¾ç½®futureåˆ°ä¸Šä¸‹æ–‡ä¸­</span>
                FutureAdapter<span class="token operator">&lt;</span>Object<span class="token operator">></span> futureAdapter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FutureAdapter</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>future<span class="token punctuation">)</span><span class="token punctuation">;</span>
                RpcContext<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFuture</span><span class="token punctuation">(</span>futureAdapter<span class="token punctuation">)</span><span class="token punctuation">;</span>
                Result result<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>isAsyncFuture<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncRpcResult</span><span class="token punctuation">(</span>futureAdapter<span class="token punctuation">,</span> futureAdapter<span class="token punctuation">.</span><span class="token function">getResultFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleAsyncRpcResult</span><span class="token punctuation">(</span>futureAdapter<span class="token punctuation">,</span> futureAdapter<span class="token punctuation">.</span><span class="token function">getResultFuture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// æš‚æ—¶è¿”å›ä¸€ä¸ªç©ºç»“æœ</span>
                <span class="token keyword">return</span> result<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 3 åŒæ­¥è°ƒç”¨</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                RpcContext<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFuture</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å‘é€è¯·æ±‚ï¼Œå¾—åˆ°ä¸€ä¸ªResponseFutureå®ä¾‹ï¼Œå¹¶è°ƒç”¨è¯¥å®ä¾‹çš„getæ–¹æ³•è¿›è¡Œç­‰å¾…ï¼Œå¼‚æ­¥è½¬åŒæ­¥</span>
                <span class="token keyword">return</span> <span class="token punctuation">(</span>Result<span class="token punctuation">)</span> currentClient<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span>inv<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>å‘é€è¯·æ±‚</p>
<p>HeaderExchangeClient#request</p>
<p>HeaderExchangeChannel#request</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> ResponseFuture <span class="token function">request</span><span class="token punctuation">(</span>Object request<span class="token punctuation">,</span> <span class="token keyword">int</span> timeout<span class="token punctuation">)</span> <span class="token keyword">throws</span> RemotingException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// åˆ›å»ºRequestå¯¹è±¡</span>
        Request req <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        req<span class="token punctuation">.</span><span class="token function">setVersion</span><span class="token punctuation">(</span>Version<span class="token punctuation">.</span><span class="token function">getProtocolVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è®¾ç½®åŒå‘é€šä¿¡æ ‡å¿—ä¸ºtrue</span>
        req<span class="token punctuation">.</span><span class="token function">setTwoWay</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è¿™é‡Œçš„requestå˜é‡ç±»å‹ä¸ºRpcInvocation</span>
        req<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// åˆ›å»ºDefaultFutureå¯¹è±¡</span>
        DefaultFuture future <span class="token operator">=</span> DefaultFuture<span class="token punctuation">.</span><span class="token function">newFuture</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> req<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è°ƒç”¨NettyClientçš„sendæ–¹æ³•å‘é€è¯·æ±‚</span>
            channel<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemotingException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            future<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// è¿”å›DefaultFutureå¯¹è±¡</span>
        <span class="token keyword">return</span> future<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>AbstractPeer#send</p>
<p>AbstractClient#send</p>
<p>NettyChannel#send</p>
<p>Channel#send</p>
<p>ç¼–ç è¯·æ±‚</p>
<p>DubboCountCodec#encode</p>
<p>DubboCodec#encode</p>
<p>ExchangeCodec#encode</p>
<p>ExchangeCodec#encodeRequest</p>
<p>æ”¶åˆ°å“åº”</p>
<p>è§£ç å“åº”</p>
<p>DubboCountCodec#decode</p>
<p>DubboCodec#decode</p>
<p>DubboCodec#decodeBody</p>
<p>å¤„ç†å“åº”</p>
<p>NettyClientHandler#channelRead</p>
<p>AbstractPeer#received</p>
<p>MultiMessageHandler#received</p>
<p>HeartbeatHandler#received</p>
<p>AllChannelHandler#received</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">received</span><span class="token punctuation">(</span>Channel channel<span class="token punctuation">,</span> Object message<span class="token punctuation">)</span> <span class="token keyword">throws</span> RemotingException <span class="token punctuation">{</span>
        ExecutorService executor <span class="token operator">=</span> <span class="token function">getExecutorService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å°†æ¶ˆæ¯å°è£…åˆ°Runnableå¯¹è±¡ä¸­ï¼Œå¹¶æ”¾å…¥çº¿ç¨‹æ± æ‰§è¡Œ</span>
            executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelEventRunnable</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> ChannelState<span class="token punctuation">.</span>RECEIVED<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>ChannelEventRunnable#run</p>
<p>DecodeHandler#received</p>
<p>DecodeHandler#decode</p>
<p>HeaderExchangeHandler</p>
<p>HeaderExchangeHandler#received</p>
<p>HeaderExchangeHandler#handleResponse</p>
<p>æ€»ç»“ï¼š</p>
<ul>
<li><p>ä»£ç†</p>
<ul>
<li><p>JavassistProxyFactory#getProxy </p>
</li>
<li><p>InvocationHandler#invoke</p>
</li>
</ul>
</li>
<li><p>é›†ç¾¤</p>
<ul>
<li><p>AbstractClusterInvoker#invoke</p>
</li>
<li><p>RegistryProtocol#refer</p>
</li>
<li><p>Cluster#joinï¼šåˆ›å»ºé›†ç¾¤Invoker</p>
</li>
<li><p>Directory#listï¼šè·å–è¯·æ±‚è·¯å¾„å¯¹åº”çš„Invokeråˆ—è¡¨ï¼ˆç”¨äºå®¹é”™ï¼‰</p>
</li>
<li><p>LoadBalance#selectï¼šè´Ÿè½½å‡è¡¡ç®—æ³•</p>
</li>
</ul>
</li>
<li><p>è¿‡æ»¤ç›‘å¬</p>
</li>
<li><p>åè®®è°ƒç”¨</p>
<ul>
<li><p>AbstractInvoker#invoke</p>
</li>
<li><p>DubboProtocol#refer</p>
</li>
<li><p>DubboInvoker</p>
</li>
</ul>
</li>
<li><p>ä¿¡æ¯äº¤æ¢</p>
<ul>
<li><p>ExchangeClient#request</p>
</li>
<li><p>ResponseFuture#getï¼šè¯·æ±‚å“åº”ï¼ˆRequestã€Responseã€ResponseFutureï¼‰</p>
</li>
</ul>
</li>
<li><p>ç½‘ç»œä¼ è¾“</p>
<ul>
<li>Transporter</li>
</ul>
</li>
</ul>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


        <footer>
             
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

        </footer>
    </div>
    <!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
    <script>
        var timeEnd = new Date();
        console.log('è€—æ—¶ï¼š' + (timeEnd - timeStart));
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre').forEach((block) => {
                block.classList.add("line-numbers");
            });
        });
    </script>
    <!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
    <!-- material design -->
    <!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
    <!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
    <!-- toc -->
    <!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
    <!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
    <!-- <script src="/js/main.js"></script> -->
    <script src="/js/prism.js"></script>
</body>
</html>
