<!DOCTYPE HTML>
<html>
	<head><meta name="generator" content="Hexo 3.9.0">
		<meta charset="utf-8">
		<script src="/js/highlight.js"></script>
				<script>hljs.initHighlightingOnLoad();var timeStart = new Date();</script>
		
		<title>[笔记]-SOFA-JRaft-Node-Election | 学而时习之</title>
		
		<meta name="author" content="Huangzhike">
		
		
		<meta name="description" content="K.I.S.S">
		
		
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		
		<meta property="og:title" content="[笔记]-SOFA-JRaft-Node-Election">
		
		<meta property="og:site_name" content="学而时习之">
		
		
		<!-- favicon -->
		<link rel="icon" type="image/ico" href="/ok.ico" sizes="32x32">
 


		<meta name="msapplication-TileColor" content="#009688">
		<meta name="msapplication-TileImage" content="/mstile-144x144.ico">
		<meta name="theme-color" content="#009688">

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Didact+Gothic"> 

		<!-- favicon end -->
		<!-- <link href="//ok.ico" rel="icon"> -->
		
		<!-- toc -->
		<!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
		<!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
		<!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
		<!-- material design -->
		<!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
		<!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
		<!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
		<!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
		<!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
		<link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
		 
		 
		<!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
		<!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
	</head>
</html>
<body>
	<nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">菜单</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" href="/">学而时习之</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

	<div class="container" >
		<div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[笔记]-SOFA-JRaft-Node-Election</h2>
				
				<div>
					<div class="post-time">2019-11-19</div>
				</div>
				
				<div class="article-content">
				<p>JRaft版本：1.2.6</p>
<p>在注释里面有时会发现类似<code>we is ...</code>之类的错误，不吐槽了，意思对就好。</p>
<hr>
<p>节点初始化</p>
<p>NodeImpl#init</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">init</span><span class="params">(<span class="keyword">final</span> NodeOptions opts)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//  ...</span></span><br><span class="line">    <span class="comment">// 投票定时器，HashedWheelTimer</span></span><br><span class="line">    <span class="keyword">this</span>.voteTimer = <span class="keyword">new</span> RepeatedTimer(<span class="string">"JRaft-VoteTimer"</span>, <span class="keyword">this</span>.options.getElectionTimeoutMs()) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onTrigger</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 处理投票后超时，投票结果确定后所有节点的状态应该为Leader或Follower，如果仍为Candidate，则是未决</span></span><br><span class="line">            handleVoteTimeout();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">adjustTimeout</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> timeoutMs)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> randomTimeout(timeoutMs);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 选举定时器，HashedWheelTimer</span></span><br><span class="line">    <span class="keyword">this</span>.electionTimer = <span class="keyword">new</span> RepeatedTimer(<span class="string">"JRaft-ElectionTimer"</span>, <span class="keyword">this</span>.options.getElectionTimeoutMs()) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onTrigger</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 选举超时：Follower超时未收到Leader的心跳，则转为Candidate，尝试发起投票请求，要求成为Leader</span></span><br><span class="line">            handleElectionTimeout();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">adjustTimeout</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> timeoutMs)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 返回随机超时，否则Follower节点可能同时发出请求，然后瓜分选票，不断循环</span></span><br><span class="line">            <span class="keyword">return</span> randomTimeout(timeoutMs);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 退位计时器，HashedWheelTimer，时间为ElectionTimeout/2</span></span><br><span class="line">    <span class="keyword">this</span>.stepDownTimer = <span class="keyword">new</span> RepeatedTimer(<span class="string">"JRaft-StepDownTimer"</span>, <span class="keyword">this</span>.options.getElectionTimeoutMs() &gt;&gt; <span class="number">1</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onTrigger</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 下台倒计时：当前节点状态为Leader时，根据是否得到过半节点的响应确定当前Leader是否有效，不能确定那就先下台</span></span><br><span class="line">            handleStepDownTimeout();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 快照定时器，HashedWheelTimer，默认一小时</span></span><br><span class="line">    <span class="keyword">this</span>.snapshotTimer = <span class="keyword">new</span> RepeatedTimer(<span class="string">"JRaft-SnapshotTimer"</span>, <span class="keyword">this</span>.options.getSnapshotIntervalSecs() * <span class="number">1000</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onTrigger</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 生成快照</span></span><br><span class="line">            handleSnapshotTimeout();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 管理ConfigurationEntry列表和ConfigurationEntry的快照</span></span><br><span class="line">    <span class="keyword">this</span>.configManager = <span class="keyword">new</span> ConfigurationManager();</span><br><span class="line">    <span class="comment">// Disruptor，MPSC模型，多生产者单消费者</span></span><br><span class="line">    <span class="keyword">this</span>.applyDisruptor = DisruptorBuilder.&lt;LogEntryAndClosure&gt;newInstance() <span class="comment">//</span></span><br><span class="line">            .setRingBufferSize(<span class="keyword">this</span>.raftOptions.getDisruptorBufferSize()) <span class="comment">// 环形队列大小，RingBuffer是生产者和消费者之间的缓冲，存放事件</span></span><br><span class="line">            .setEventFactory(<span class="keyword">new</span> LogEntryAndClosureFactory()) <span class="comment">// 事件工厂，用于创建事件，事件就是被消费的对象</span></span><br><span class="line">            .setThreadFactory(<span class="keyword">new</span> NamedThreadFactory(<span class="string">"JRaft-NodeImpl-Disruptor-"</span>, <span class="keyword">true</span>)) <span class="comment">// 生产者线程工厂</span></span><br><span class="line">            .setProducerType(ProducerType.MULTI) <span class="comment">// 多生产者模式</span></span><br><span class="line">            .setWaitStrategy(<span class="keyword">new</span> BlockingWaitStrategy()) <span class="comment">//  消费者等待策略，阻塞</span></span><br><span class="line">            .build();</span><br><span class="line">    <span class="comment">// 事件处理器，即消费者，处理发布的Log</span></span><br><span class="line">    <span class="keyword">this</span>.applyDisruptor.handleEventsWith(<span class="keyword">new</span> LogEntryAndClosureHandler());</span><br><span class="line">    <span class="comment">// 异常处理器</span></span><br><span class="line">    <span class="keyword">this</span>.applyDisruptor.setDefaultExceptionHandler(<span class="keyword">new</span> LogExceptionHandler&lt;Object&gt;(getClass().getSimpleName()));</span><br><span class="line">    <span class="comment">// 启动Disruptor，返回RingBuffer</span></span><br><span class="line">    <span class="keyword">this</span>.applyQueue = <span class="keyword">this</span>.applyDisruptor.start();</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 状态机Caller</span></span><br><span class="line">    <span class="keyword">this</span>.fsmCaller = <span class="keyword">new</span> FSMCallerImpl();</span><br><span class="line">    <span class="comment">// 实例化并初始化LogManager，默认存储实现是RocksDB，尝试从本地加载LogEntry</span></span><br><span class="line">    <span class="keyword">if</span> (!initLogStorage()) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 实例化并初始化RaftMetaStorage，尝试从本地文件加载CurrTerm和VotedId</span></span><br><span class="line">    <span class="keyword">if</span> (!initMetaStorage()) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 初始化FSMCaller，初始的Log的Index和Term都是0</span></span><br><span class="line">    <span class="keyword">if</span> (!initFSMCaller(<span class="keyword">new</span> LogId(<span class="number">0</span>, <span class="number">0</span>))) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 投票箱</span></span><br><span class="line">    <span class="keyword">this</span>.ballotBox = <span class="keyword">new</span> BallotBox();</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 初始化投票箱</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.ballotBox.init(ballotBoxOpts)) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 初始化SnapshotStorage，尝试从本地文件加载Snapshot的元数据</span></span><br><span class="line">    <span class="keyword">if</span> (!initSnapshotStorage()) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 检查日志一致性</span></span><br><span class="line">    <span class="keyword">final</span> Status st = <span class="keyword">this</span>.logManager.checkConsistency();</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// ConfigurationEntry</span></span><br><span class="line">    <span class="keyword">this</span>.conf = <span class="keyword">new</span> ConfigurationEntry();</span><br><span class="line">    <span class="keyword">this</span>.conf.setId(<span class="keyword">new</span> LogId());</span><br><span class="line">    <span class="comment">// 如果本地LogStorage有有效的LastLogIndex</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.logManager.getLastLogIndex() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 使用有效的ConfigurationEntry</span></span><br><span class="line">        <span class="keyword">this</span>.conf = <span class="keyword">this</span>.logManager.checkAndSetConfiguration(<span class="keyword">this</span>.conf);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ConfigurationEntry使用启动时配置的Configuration</span></span><br><span class="line">        <span class="keyword">this</span>.conf.setConf(<span class="keyword">this</span>.options.getInitialConf());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.replicatorGroup = <span class="keyword">new</span> ReplicatorGroupImpl();</span><br><span class="line">    <span class="comment">// RPC客户端服务</span></span><br><span class="line">    <span class="keyword">this</span>.rpcService = <span class="keyword">new</span> BoltRaftClientService(<span class="keyword">this</span>.replicatorGroup);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 初始化RPC服务</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.rpcService.init(<span class="keyword">this</span>.options)) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 初始化ReplicatorGroup</span></span><br><span class="line">    <span class="keyword">this</span>.replicatorGroup.init(<span class="keyword">new</span> NodeId(<span class="keyword">this</span>.groupId, <span class="keyword">this</span>.serverId), rgOpts);</span><br><span class="line">    <span class="comment">// 一致性读</span></span><br><span class="line">    <span class="keyword">this</span>.readOnlyService = <span class="keyword">new</span> ReadOnlyServiceImpl();</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.readOnlyService.init(rosOpts)) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 初始状态下所有节点都是Follower</span></span><br><span class="line">    <span class="keyword">this</span>.state = State.STATE_FOLLOWER;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.snapshotExecutor != <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.options.getSnapshotIntervalSecs() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 启动Snapshot计时器</span></span><br><span class="line">        <span class="keyword">this</span>.snapshotTimer.start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果Configuration的PeerId列表不为空</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.conf.isEmpty()) &#123;</span><br><span class="line">        <span class="comment">// 先下台，更新任期，启动选举计时器</span></span><br><span class="line">        stepDown(<span class="keyword">this</span>.currTerm, <span class="keyword">false</span>, <span class="keyword">new</span> Status());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将当前节点Node加入</span></span><br><span class="line">    <span class="keyword">if</span> (!NodeManager.getInstance().add(<span class="keyword">this</span>)) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Node已启动，获取写锁，避免竞争</span></span><br><span class="line">    <span class="keyword">this</span>.writeLock.lock();</span><br><span class="line">    <span class="comment">// 如果Group内只有一个Server节点并且就是当前节点，那么当前节点一定是Leader</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.conf.isStable() &amp;&amp; <span class="keyword">this</span>.conf.getConf().size() == <span class="number">1</span> &amp;&amp; <span class="keyword">this</span>.conf.getConf().contains(<span class="keyword">this</span>.serverId)) &#123;</span><br><span class="line">        <span class="comment">// 触发VoteTimer，成为Leader</span></span><br><span class="line">        electSelf();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.writeLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>触发选举超时</p>
<p>NodeImpl#handleElectionTimeout</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleElectionTimeout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> doUnlock = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">this</span>.writeLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 只有节点处于Follower状态才有Leader超时</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.state != State.STATE_FOLLOWER) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 超时没收到Leader心跳，选举超时，才能继续</span></span><br><span class="line">        <span class="keyword">if</span> (isCurrentLeaderValid()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 认为Leader已死，重置LeaderId</span></span><br><span class="line">        resetLeaderId(PeerId.emptyPeer(), <span class="keyword">new</span> Status(RaftError.ERAFTTIMEDOUT, <span class="string">"Lost connection from leader %s."</span>, <span class="keyword">this</span>.leaderId));</span><br><span class="line">        doUnlock = <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">// 发起预投票，达标后会发起正式投票</span></span><br><span class="line">        preVote();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (doUnlock) &#123;</span><br><span class="line">            <span class="keyword">this</span>.writeLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>NodeImpl#resetLeaderId</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">resetLeaderId</span><span class="params">(<span class="keyword">final</span> PeerId newLeaderId, <span class="keyword">final</span> Status status)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 如果是用空的PeerId重置</span></span><br><span class="line">    <span class="keyword">if</span> (newLeaderId.isEmpty()) &#123;</span><br><span class="line">        <span class="comment">// 原本已经存在Leader &amp;&amp; 当前节点不是Leader</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.leaderId.isEmpty() &amp;&amp; <span class="keyword">this</span>.state.compareTo(State.STATE_TRANSFERRING) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 发布停止跟随原本Leader的事件到RingBuffer，具体回调内容由状态机实现决定，默认啥也不干</span></span><br><span class="line">            <span class="keyword">this</span>.fsmCaller.onStopFollowing(<span class="keyword">new</span> LeaderChangeContext(<span class="keyword">this</span>.leaderId.copy(), <span class="keyword">this</span>.currTerm, status));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 置空</span></span><br><span class="line">        <span class="keyword">this</span>.leaderId = PeerId.emptyPeer();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果是用新的PeerId重置</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 如果当前不存在Leader</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.leaderId == <span class="keyword">null</span> || <span class="keyword">this</span>.leaderId.isEmpty()) &#123;</span><br><span class="line">            <span class="comment">// 发布开始跟随新Leader的事件到RingBuffer，具体回调内容由状态机实现决定，默认啥也不干</span></span><br><span class="line">            <span class="keyword">this</span>.fsmCaller.onStartFollowing(<span class="keyword">new</span> LeaderChangeContext(newLeaderId, <span class="keyword">this</span>.currTerm, status));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 更新Leader</span></span><br><span class="line">        <span class="keyword">this</span>.leaderId = newLeaderId.copy();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>预投票：</p>
<p>假如有某个Follower节点因为网络分区收不到Leader节点的心跳，那么它就会自动试图竞选为Leader，但因为别的Follower节点和Leader通信正常，所以一直无法当选，然后不断发起选举。</p>
<p>而选举请求会一直抬高全局节点的任期Term，最终使原本正常的Leader节点StepDown退位为Follower。</p>
<p>为了避免这种情况，候选者在发起投票之前，要先发起预投票，如果没有得到半数以上节点的承认，则不能正式发起选举。</p>
<p>上面的情况是对称网络分区的，还有一种情况是非对称网络分区。</p>
<p>假如有三个节点A，B，C，分别为Leader，Follower，Follower，假设某个时刻LeaderA和FollowerB之间出现了网络分区，而其它连接正常。</p>
<p>B会因为超时收不到LeaderA的心跳而自动转为候选人，发起预投票和正式投票，假设通过并成为了Leader（B和C两票），这样全局任期就会上升，然后原LeaderA自动退位为Follower。</p>
<p>显然因为分区的原因，A也会收不到LeaderB的心跳，然后试图发起选举，如此反复。</p>
<p>根据JRaft官方文档，这种情况的处理方式是在选举超时后，Follower才接受预投票请求，NodeImpl#handlePreVoteRequest。</p>
<p>应该是让C成为Leader才是最好的？</p>
<p>发起预投票</p>
<p>NodeImpl#preVote</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">preVote</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> oldTerm;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 安装Snapshot的时候不能预选举，因为配置可能已过时</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.snapshotExecutor != <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.snapshotExecutor.isInstallingSnapshot()) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 没加入配置的节点不能发起预选举</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.conf.contains(<span class="keyword">this</span>.serverId)) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 保存当前任期</span></span><br><span class="line">        oldTerm = <span class="keyword">this</span>.currTerm;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.writeLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取最后一条Log</span></span><br><span class="line">    <span class="keyword">final</span> LogId lastLogId = <span class="keyword">this</span>.logManager.getLastLogId(<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">boolean</span> doUnlock = <span class="keyword">true</span>;</span><br><span class="line">    <span class="comment">// 再次获取写锁</span></span><br><span class="line">    <span class="keyword">this</span>.writeLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 再次获取写锁期间任期发生了变化，不继续</span></span><br><span class="line">        <span class="keyword">if</span> (oldTerm != <span class="keyword">this</span>.currTerm) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 初始化Ballot，投票箱，代表这次投票</span></span><br><span class="line">        <span class="keyword">this</span>.prevVoteCtx.init(<span class="keyword">this</span>.conf.getConf(), <span class="keyword">this</span>.conf.isStable() ? <span class="keyword">null</span> : <span class="keyword">this</span>.conf.getOldConf());</span><br><span class="line">        <span class="comment">// 遍历同辈节点</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> PeerId peer : <span class="keyword">this</span>.conf.listPeers()) &#123;</span><br><span class="line">            <span class="comment">// 跳过自身</span></span><br><span class="line">            <span class="keyword">if</span> (peer.equals(<span class="keyword">this</span>.serverId)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果已经连接则返回true，否则发送PingRequest同步请求，连接并发送成功后返回结果，跳过无法连接的同辈节点</span></span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">this</span>.rpcService.connect(peer.getEndpoint())) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 预选举请求响应的回调</span></span><br><span class="line">            <span class="keyword">final</span> OnPreVoteRpcDone done = <span class="keyword">new</span> OnPreVoteRpcDone(peer, <span class="keyword">this</span>.currTerm);</span><br><span class="line">            <span class="comment">// 创建预选举请求，Protobuf</span></span><br><span class="line">            done.request = RequestVoteRequest.newBuilder() <span class="comment">//</span></span><br><span class="line">                    .setPreVote(<span class="keyword">true</span>) <span class="comment">// 标明是个预选举请求</span></span><br><span class="line">                    .setGroupId(<span class="keyword">this</span>.groupId) <span class="comment">//</span></span><br><span class="line">                    .setServerId(<span class="keyword">this</span>.serverId.toString()) <span class="comment">//</span></span><br><span class="line">                    .setPeerId(peer.toString()) <span class="comment">//</span></span><br><span class="line">                    .setTerm(<span class="keyword">this</span>.currTerm + <span class="number">1</span>) <span class="comment">// 表示竞选下一个任期，预选只是请求的任期加一，本地的任期不变，正式选举时本地任期才加一</span></span><br><span class="line">                    .setLastLogIndex(lastLogId.getIndex()) <span class="comment">// 最后一条Log的索引</span></span><br><span class="line">                    .setLastLogTerm(lastLogId.getTerm()) <span class="comment">// 最后一条Log所属的任期</span></span><br><span class="line">                    .build();</span><br><span class="line">            <span class="comment">// 向该同辈节点发送预选举异步请求，收到响应后执行回调</span></span><br><span class="line">            <span class="keyword">this</span>.rpcService.preVote(peer.getEndpoint(), done.request, done);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Ballot，自己的一票也要算上</span></span><br><span class="line">        <span class="keyword">this</span>.prevVoteCtx.grant(<span class="keyword">this</span>.serverId);</span><br><span class="line">        <span class="comment">// 只有获取半数以上的预选</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.prevVoteCtx.isGranted()) &#123;</span><br><span class="line">            doUnlock = <span class="keyword">false</span>;</span><br><span class="line">            <span class="comment">// 才能正式选举自己</span></span><br><span class="line">            electSelf();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (doUnlock) &#123;</span><br><span class="line">            <span class="keyword">this</span>.writeLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对端节点收到并处理预投票请求</p>
<p>NodeImpl#handlePreVoteRequest</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Message <span class="title">handlePreVoteRequest</span><span class="params">(<span class="keyword">final</span> RequestVoteRequest request)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> doUnlock = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">this</span>.writeLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 当前节点未激活，不处理预投票请求</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.state.isActive()) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> PeerId candidateId = <span class="keyword">new</span> PeerId();</span><br><span class="line">        <span class="comment">// 解析候选人节点的Id为PeerId，其实预选举对端应该还是Follower</span></span><br><span class="line">        <span class="keyword">if</span> (!candidateId.parse(request.getServerId())) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 默认不允许对端的预投票请求</span></span><br><span class="line">        <span class="keyword">boolean</span> granted = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="comment">// 当前节点已有Leader，并且未超过选举超时，则当前的Leader是有效的，不允许预投票</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.leaderId != <span class="keyword">null</span> &amp;&amp; !<span class="keyword">this</span>.leaderId.isEmpty() &amp;&amp; isCurrentLeaderValid()) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 对端竞选的任期小于节点所处的任期，即对端所处的任期比当前节点的任期小了2或以上，不允许预投票</span></span><br><span class="line">            <span class="keyword">if</span> (request.getTerm() &lt; <span class="keyword">this</span>.currTerm) &#123;</span><br><span class="line">                <span class="comment">// 可能是日志复制有问题，导致Follower任期落后太多</span></span><br><span class="line">                <span class="comment">// 如果当前节点是Leader，检查之前是不是为该节点分配Replicator失败，如果是，则再次尝试分配一次Replicator</span></span><br><span class="line">                <span class="comment">// Replicator是节点成为Leader时给其他节点分配的，因为只尝试一次，所以可能失败</span></span><br><span class="line">                checkReplicator(candidateId);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 对端所处的任期和当前节点的任期一致，但是还是发起了预投票，可能也是网络或者心跳有问题？</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (request.getTerm() == <span class="keyword">this</span>.currTerm + <span class="number">1</span>) &#123;</span><br><span class="line">                checkReplicator(candidateId);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 也就是说，即使对端的任期比自己的任期小一，仍然会比较LogId，但是这种情况即使返回准许投票，对端收到响应后判断任期比自己大，投票还是会无效，所以比较LogId的意义是？</span></span><br><span class="line">            doUnlock = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">this</span>.writeLock.unlock();</span><br><span class="line">            <span class="comment">// 获取本地最后一条Log的LogId，包含Log的任期和索引</span></span><br><span class="line">            <span class="keyword">final</span> LogId lastLogId = <span class="keyword">this</span>.logManager.getLastLogId(<span class="keyword">true</span>);</span><br><span class="line">            doUnlock = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">this</span>.writeLock.lock();</span><br><span class="line">            <span class="comment">// 发出预投票请求的节点的最后一条Log的LogId，包含Log的任期和索引</span></span><br><span class="line">            <span class="keyword">final</span> LogId requestLastLogId = <span class="keyword">new</span> LogId(request.getLastLogIndex(), request.getLastLogTerm());</span><br><span class="line">            <span class="comment">// 如果对端的最后一个LogId比自己的大，那么认为对方的Log比自己的要完整和更新，准许对端成为Leader</span></span><br><span class="line">            <span class="comment">// 先比较任期Term，再比较索引Index</span></span><br><span class="line">            granted = requestLastLogId.compareTo(lastLogId) &gt;= <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">while</span> (<span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">return</span> RequestVoteResponse.newBuilder() <span class="comment">//</span></span><br><span class="line">                .setTerm(<span class="keyword">this</span>.currTerm) <span class="comment">// 当前节点所处的任期</span></span><br><span class="line">                .setGranted(granted) <span class="comment">// 是否准许预投票</span></span><br><span class="line">                .build(); <span class="comment">// 生成响应</span></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (doUnlock) &#123;</span><br><span class="line">            <span class="keyword">this</span>.writeLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>回调处理预投票请求的响应</p>
<p>NodeImpl#handlePreVoteResponse</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handlePreVoteResponse</span><span class="params">(<span class="keyword">final</span> PeerId peerId, <span class="keyword">final</span> <span class="keyword">long</span> term, <span class="keyword">final</span> RequestVoteResponse response)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> doUnlock = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">this</span>.writeLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 节点仍处于Follower状态时才处理预投票请求的响应，因为Candidate和Leader不发出预投票请求</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.state != State.STATE_FOLLOWER) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 发出预选举请求后到收到响应的这段时间内，节点的任期发生了变化，则响应无效</span></span><br><span class="line">        <span class="keyword">if</span> (term != <span class="keyword">this</span>.currTerm) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 响应预投票请求的对端节点的任期大于当前节点的任期，则投票被拒绝</span></span><br><span class="line">        <span class="keyword">if</span> (response.getTerm() &gt; <span class="keyword">this</span>.currTerm) &#123;</span><br><span class="line">            <span class="comment">// 总之当前节点先退位为Follower，并同步任期，启动选举计时器</span></span><br><span class="line">            stepDown(response.getTerm(), <span class="keyword">false</span>, <span class="keyword">new</span> Status(RaftError.EHIGHERTERMRESPONSE, <span class="string">"Raft node receives higher term pre_vote_response."</span>));</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果对端准许了预投票请求</span></span><br><span class="line">        <span class="keyword">if</span> (response.getGranted()) &#123;</span><br><span class="line">            <span class="comment">// Ballot，如果获得了对端的一票</span></span><br><span class="line">            <span class="keyword">this</span>.prevVoteCtx.grant(peerId);</span><br><span class="line">            <span class="comment">// 如果达到了合法人数</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.prevVoteCtx.isGranted()) &#123;</span><br><span class="line">                <span class="comment">// 暂时不释放写锁，大概是避免再次获取锁时失败，读写锁默认是公平锁还是非公平？忘了</span></span><br><span class="line">                doUnlock = <span class="keyword">false</span>;</span><br><span class="line">                <span class="comment">// 可以开始正式投票给自己了</span></span><br><span class="line">                electSelf();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (doUnlock) &#123;</span><br><span class="line">            <span class="keyword">this</span>.writeLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>NodeImpl#stepDown</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">stepDown</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> term, <span class="keyword">final</span> <span class="keyword">boolean</span> wakeupCandidate, <span class="keyword">final</span> Status status)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 非激活状态的节点</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.state.isActive()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果当前节点状态为Candidate</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.state == State.STATE_CANDIDATE) &#123;</span><br><span class="line">        <span class="comment">// 取消候选人的投票超时计时器</span></span><br><span class="line">        stopVoteTimer();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果当前节点状态为Leader或转移领导权中</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.state.compareTo(State.STATE_TRANSFERRING) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 取消退位计时器</span></span><br><span class="line">        stopStepDownTimer();</span><br><span class="line">        <span class="keyword">this</span>.ballotBox.clearPendingTasks();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.state == State.STATE_LEADER) &#123;</span><br><span class="line">            <span class="comment">// 发布Leader下台事件到状态机的RingBuffer，具体处理由状态机的实现决定</span></span><br><span class="line">            onLeaderStop(status);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 重置LeaderId为空</span></span><br><span class="line">    resetLeaderId(PeerId.emptyPeer(), status);</span><br><span class="line">    <span class="comment">// 重置状态为Follower</span></span><br><span class="line">    <span class="keyword">this</span>.state = State.STATE_FOLLOWER;</span><br><span class="line">    <span class="keyword">this</span>.confCtx.reset();</span><br><span class="line">    updateLastLeaderTimestamp(Utils.monotonicMs());</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.snapshotExecutor != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 取消Snapshot下载</span></span><br><span class="line">        <span class="keyword">this</span>.snapshotExecutor.interruptDownloadingSnapshots(term);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (term &gt; <span class="keyword">this</span>.currTerm) &#123;</span><br><span class="line">        <span class="comment">// 更新任期，取大的</span></span><br><span class="line">        <span class="keyword">this</span>.currTerm = term;</span><br><span class="line">        <span class="keyword">this</span>.votedId = PeerId.emptyPeer();</span><br><span class="line">        <span class="keyword">this</span>.metaStorage.setTermAndVotedFor(term, <span class="keyword">this</span>.votedId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (wakeupCandidate) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 取消所有Replicator</span></span><br><span class="line">        <span class="keyword">this</span>.replicatorGroup.stopAll();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.stopTransferArg != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 启动选举计时器</span></span><br><span class="line">    <span class="keyword">this</span>.electionTimer.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>正式发起投票</p>
<p>NodeImpl#electSelf</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">electSelf</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> oldTerm;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 不在配置中的节点不能选举自己</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.conf.contains(<span class="keyword">this</span>.serverId)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果当前节点的状态是Follower，先停止选举计时器</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.state == State.STATE_FOLLOWER) &#123;</span><br><span class="line">            <span class="keyword">this</span>.electionTimer.stop();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 重置LeaderId</span></span><br><span class="line">        resetLeaderId(PeerId.emptyPeer(), <span class="keyword">new</span> Status(RaftError.ERAFTTIMEDOUT, <span class="string">"A follower's leader_id is reset to NULL as it begins to request_vote."</span>));</span><br><span class="line">        <span class="comment">// 切换节点的状态为Candidate</span></span><br><span class="line">        <span class="keyword">this</span>.state = State.STATE_CANDIDATE;</span><br><span class="line">        <span class="comment">// 本地任期自增</span></span><br><span class="line">        <span class="keyword">this</span>.currTerm++;</span><br><span class="line">        <span class="comment">// 要求投给自己</span></span><br><span class="line">        <span class="keyword">this</span>.votedId = <span class="keyword">this</span>.serverId.copy();</span><br><span class="line">        <span class="comment">// 启动投票计时器</span></span><br><span class="line">        <span class="keyword">this</span>.voteTimer.start();</span><br><span class="line">        <span class="comment">// 初始化Ballot投票箱</span></span><br><span class="line">        <span class="keyword">this</span>.voteCtx.init(<span class="keyword">this</span>.conf.getConf(), <span class="keyword">this</span>.conf.isStable() ? <span class="keyword">null</span> : <span class="keyword">this</span>.conf.getOldConf());</span><br><span class="line">        <span class="comment">// 暂存投票前的任期</span></span><br><span class="line">        oldTerm = <span class="keyword">this</span>.currTerm;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.writeLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取本地最后一条Log</span></span><br><span class="line">    <span class="keyword">final</span> LogId lastLogId = <span class="keyword">this</span>.logManager.getLastLogId(<span class="keyword">true</span>);</span><br><span class="line">    <span class="comment">// 获取写锁</span></span><br><span class="line">    <span class="keyword">this</span>.writeLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 再次获取写锁期间本地任期发生了变化，不再继续</span></span><br><span class="line">        <span class="keyword">if</span> (oldTerm != <span class="keyword">this</span>.currTerm) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 遍历同辈节点</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> PeerId peer : <span class="keyword">this</span>.conf.listPeers()) &#123;</span><br><span class="line">            <span class="comment">// 跳过自身</span></span><br><span class="line">            <span class="keyword">if</span> (peer.equals(<span class="keyword">this</span>.serverId)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果已经连接则返回true，否则发送PingRequest同步请求，连接并发送成功后返回结果，跳过无法连接的同辈节点</span></span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">this</span>.rpcService.connect(peer.getEndpoint())) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 选举请求的回调</span></span><br><span class="line">            <span class="keyword">final</span> OnRequestVoteRpcDone done = <span class="keyword">new</span> OnRequestVoteRpcDone(peer, <span class="keyword">this</span>.currTerm, <span class="keyword">this</span>);</span><br><span class="line">            <span class="comment">// 创建选举请求</span></span><br><span class="line">            done.request = RequestVoteRequest.newBuilder() <span class="comment">//</span></span><br><span class="line">                    .setPreVote(<span class="keyword">false</span>) <span class="comment">// 标明是个正式选举请求</span></span><br><span class="line">                    .setGroupId(<span class="keyword">this</span>.groupId) <span class="comment">//</span></span><br><span class="line">                    .setServerId(<span class="keyword">this</span>.serverId.toString()) <span class="comment">//</span></span><br><span class="line">                    .setPeerId(peer.toString()) <span class="comment">//</span></span><br><span class="line">                    .setTerm(<span class="keyword">this</span>.currTerm) <span class="comment">// 竞选的任期，已自增</span></span><br><span class="line">                    .setLastLogIndex(lastLogId.getIndex()) <span class="comment">//</span></span><br><span class="line">                    .setLastLogTerm(lastLogId.getTerm()) <span class="comment">//</span></span><br><span class="line">                    .build();</span><br><span class="line">            <span class="comment">// 向同辈节点发送选举异步请求，收到响应后执行回调</span></span><br><span class="line">            <span class="keyword">this</span>.rpcService.requestVote(peer.getEndpoint(), done.request, done);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.metaStorage.setTermAndVotedFor(<span class="keyword">this</span>.currTerm, <span class="keyword">this</span>.serverId);</span><br><span class="line">        <span class="comment">// 自己也要投给自己一票</span></span><br><span class="line">        <span class="keyword">this</span>.voteCtx.grant(<span class="keyword">this</span>.serverId);</span><br><span class="line">        <span class="comment">// 只有获取半数以上的选票</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.voteCtx.isGranted()) &#123;</span><br><span class="line">            <span class="comment">// 才能成为Leader</span></span><br><span class="line">            becomeLeader();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.writeLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对端节点收到并处理正式投票请求</p>
<p>NodeImpl#handleRequestVoteRequest</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Message <span class="title">handleRequestVoteRequest</span><span class="params">(<span class="keyword">final</span> RequestVoteRequest request)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> doUnlock = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">this</span>.writeLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 节点必须激活才能处理正式投票请求</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.state.isActive()) &#123;</span><br><span class="line">            <span class="keyword">return</span> RpcResponseFactory.newResponse(RaftError.EINVAL, <span class="string">"Node %s is not in active state, state %s."</span>, getNodeId(), <span class="keyword">this</span>.state.name());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 发起正式投票请求的候选人Id</span></span><br><span class="line">        <span class="keyword">final</span> PeerId candidateId = <span class="keyword">new</span> PeerId();</span><br><span class="line">        <span class="comment">// 解析候选人的Id为PeerId</span></span><br><span class="line">        <span class="keyword">if</span> (!candidateId.parse(request.getServerId())) &#123;</span><br><span class="line">            <span class="keyword">return</span> RpcResponseFactory.newResponse(RaftError.EINVAL, <span class="string">"Parse candidateId failed: %s."</span>, request.getServerId());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 成为Leader的要求：该节点保存的Log最新最完整</span></span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="comment">// 先比较任期</span></span><br><span class="line">            <span class="keyword">if</span> (request.getTerm() &gt;= <span class="keyword">this</span>.currTerm) &#123;</span><br><span class="line">                <span class="comment">// 如果对方正式竞选的任期大于自己当前的任期，那么需要更新自己的任期，这样全局节点的任期也会更新</span></span><br><span class="line">                <span class="keyword">if</span> (request.getTerm() &gt; <span class="keyword">this</span>.currTerm) &#123;</span><br><span class="line">                    <span class="comment">// 退位为Follower，同步任期，启动选举计时器</span></span><br><span class="line">                    stepDown(request.getTerm(), <span class="keyword">false</span>, <span class="keyword">new</span> Status(RaftError.EHIGHERTERMRESPONSE, <span class="string">"Raft node receives higher term RequestVoteRequest."</span>));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果请求竞选的任期要比自己当前任期小，说明日志比自己残缺，不能投票给它</span></span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            doUnlock = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">this</span>.writeLock.unlock();</span><br><span class="line">            <span class="comment">// 获取本地最后一条Log的LogId</span></span><br><span class="line">            <span class="keyword">final</span> LogId lastLogId = <span class="keyword">this</span>.logManager.getLastLogId(<span class="keyword">true</span>);</span><br><span class="line">            doUnlock = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">this</span>.writeLock.lock();</span><br><span class="line">            <span class="comment">// vote need ABA check after unlock&amp;writeLock</span></span><br><span class="line">            <span class="comment">// 释放写锁后任期发生了变化，不能继续</span></span><br><span class="line">            <span class="keyword">if</span> (request.getTerm() != <span class="keyword">this</span>.currTerm) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Log由Leader同步过来，LogIndex单调递增，如果对端的最后一条Log所属的Term或Index比自己的小，说明日志比自身残缺，不能投票给它</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> logIsOk = <span class="keyword">new</span> LogId(request.getLastLogIndex(), request.getLastLogTerm()).compareTo(lastLogId) &gt;= <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// 可能收到多个节点的投票请求，但是票只有一个</span></span><br><span class="line">            <span class="keyword">if</span> (logIsOk &amp;&amp; (<span class="keyword">this</span>.votedId == <span class="keyword">null</span> || <span class="keyword">this</span>.votedId.isEmpty())) &#123;</span><br><span class="line">                <span class="comment">// 更新自己的任期</span></span><br><span class="line">                stepDown(request.getTerm(), <span class="keyword">false</span>, <span class="keyword">new</span> Status(RaftError.EVOTEFORCANDIDATE, <span class="string">"Raft node votes for some candidate, step down to restart election_timer."</span>));</span><br><span class="line">                <span class="keyword">this</span>.votedId = candidateId.copy();</span><br><span class="line">                <span class="keyword">this</span>.metaStorage.setVotedFor(candidateId);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">while</span> (<span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">return</span> RequestVoteResponse.newBuilder() <span class="comment">//</span></span><br><span class="line">                .setTerm(<span class="keyword">this</span>.currTerm) <span class="comment">//</span></span><br><span class="line">                .setGranted(request.getTerm() == <span class="keyword">this</span>.currTerm &amp;&amp; candidateId.equals(<span class="keyword">this</span>.votedId)) <span class="comment">// 是否同意该票</span></span><br><span class="line">                .build();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (doUnlock) &#123;</span><br><span class="line">            <span class="keyword">this</span>.writeLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Candidate节点回调处理正式投票请求的响应</p>
<p>NodeImpl#handleRequestVoteResponse</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleRequestVoteResponse</span><span class="params">(<span class="keyword">final</span> PeerId peerId, <span class="keyword">final</span> <span class="keyword">long</span> term, <span class="keyword">final</span> RequestVoteResponse response)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.writeLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 只有节点处于Candidate状态时才能处理正式投票的响应</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.state != State.STATE_CANDIDATE) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 发出投票请求后本地任期发生了变化，投票无效</span></span><br><span class="line">        <span class="keyword">if</span> (term != <span class="keyword">this</span>.currTerm) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 响应投票请求的对端节点的任期大于当前节点的任期，投票无效</span></span><br><span class="line">        <span class="keyword">if</span> (response.getTerm() &gt; <span class="keyword">this</span>.currTerm) &#123;</span><br><span class="line">            <span class="comment">// 当前节点先下台为Follower，更新任期，启动选举计时器</span></span><br><span class="line">            stepDown(response.getTerm(), <span class="keyword">false</span>, <span class="keyword">new</span> Status(RaftError.EHIGHERTERMRESPONSE, <span class="string">"Raft node receives higher term request_vote_response."</span>));</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果对端准许了投票请求</span></span><br><span class="line">        <span class="keyword">if</span> (response.getGranted()) &#123;</span><br><span class="line">            <span class="comment">// Ballot，获得了对端的一票</span></span><br><span class="line">            <span class="keyword">this</span>.voteCtx.grant(peerId);</span><br><span class="line">            <span class="comment">// 如果达到了合法人数</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.voteCtx.isGranted()) &#123;</span><br><span class="line">                <span class="comment">// 那就可以成为Leader了</span></span><br><span class="line">                becomeLeader();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.writeLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Candidate变成Leader</p>
<p>NodeImpl#becomeLeader</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">becomeLeader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//  ...</span></span><br><span class="line">    <span class="comment">// 取消Candidate的投票计时器，因为已经变成Leader了</span></span><br><span class="line">    stopVoteTimer();</span><br><span class="line">    <span class="comment">// 将节点自身的状态改为Leader</span></span><br><span class="line">    <span class="keyword">this</span>.state = State.STATE_LEADER;</span><br><span class="line">    <span class="keyword">this</span>.leaderId = <span class="keyword">this</span>.serverId.copy();</span><br><span class="line">    <span class="comment">// 更新ReplicatorGroup的任期</span></span><br><span class="line">    <span class="keyword">this</span>.replicatorGroup.resetTerm(<span class="keyword">this</span>.currTerm);</span><br><span class="line">    <span class="comment">// 遍历同辈节点</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">final</span> PeerId peer : <span class="keyword">this</span>.conf.listPeers()) &#123;</span><br><span class="line">        <span class="comment">// 跳过自身</span></span><br><span class="line">        <span class="keyword">if</span> (peer.equals(<span class="keyword">this</span>.serverId)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 一个Follower分配一个Replicator，用于并发复制Log给不同节点，分配失败不重试</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.replicatorGroup.addReplicator(peer)) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 根据Raft算法，新Leader上台后，上一个任期的日志不能直接提交，需要通过提交当前任期的日志的方式间接提交</span></span><br><span class="line">    <span class="comment">// 这里是通过设置一个PendingIndex为自己的LastLogIndex的后一条索引的方式，即期待的索引，小于的话是不能提交的</span></span><br><span class="line">    <span class="comment">// 某些说法是新Leader应该提交一个空白的日志，但是JRaft没这么做，我觉得也不要提交什么空白日志最好</span></span><br><span class="line">    <span class="keyword">this</span>.ballotBox.resetPendingIndex(<span class="keyword">this</span>.logManager.getLastLogIndex() + <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 启动退位计时器，超时没收到大多数Follower节点的响应则自动下台</span></span><br><span class="line">    <span class="keyword">this</span>.stepDownTimer.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为Follower节点分配日志复制器</p>
<p>ReplicatorGroupImpl#addReplicator</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">addReplicator</span><span class="params">(<span class="keyword">final</span> PeerId peer)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 如果该PeerId已存在对应的ThreadId</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.replicatorMap.containsKey(peer)) &#123;</span><br><span class="line">        <span class="comment">// 从分配失败集合移除</span></span><br><span class="line">        <span class="keyword">this</span>.failureReplicators.remove(peer);</span><br><span class="line">        <span class="comment">// 该节点已分配</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> ReplicatorOptions opts = <span class="keyword">this</span>.commonOptions == <span class="keyword">null</span> ? <span class="keyword">new</span> ReplicatorOptions() : <span class="keyword">this</span>.commonOptions.copy();</span><br><span class="line">    opts.setPeerId(peer);</span><br><span class="line">    <span class="comment">// 尝试为该PeerId启动对应的ThreadId，启动心跳计时器，发送一个Probe请求，结束选举</span></span><br><span class="line">    <span class="keyword">final</span> ThreadId rid = Replicator.start(opts, <span class="keyword">this</span>.raftOptions);</span><br><span class="line">    <span class="comment">// 分配失败</span></span><br><span class="line">    <span class="keyword">if</span> (rid == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 添加到启动失败的集合</span></span><br><span class="line">        <span class="keyword">this</span>.failureReplicators.add(peer);</span><br><span class="line">        <span class="comment">// 返回失败</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 返回添加是否成功</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.replicatorMap.put(peer, rid) == <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>启动日志复制</p>
<p>Replicator#start</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ThreadId <span class="title">start</span><span class="params">(<span class="keyword">final</span> ReplicatorOptions opts, <span class="keyword">final</span> RaftOptions raftOptions)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 实例化Replicator，初始化NextIndex为LastLogIndex+1</span></span><br><span class="line">    <span class="keyword">final</span> Replicator r = <span class="keyword">new</span> Replicator(opts, raftOptions);</span><br><span class="line">    <span class="comment">// 尝试连接对端Peer</span></span><br><span class="line">    <span class="keyword">if</span> (!r.rpcService.connect(opts.getPeerId().getEndpoint())) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Metric监控相关</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 该Replicator对应的ThreadId，超时的回调为Replicator，非常隐蔽</span></span><br><span class="line">    r.id = <span class="keyword">new</span> ThreadId(r, r);</span><br><span class="line">    r.id.lock();</span><br><span class="line">    <span class="comment">// 触发事件通知，如果有监听器的话</span></span><br><span class="line">    notifyReplicatorStatusListener(r, ReplicatorEvent.CREATED);</span><br><span class="line">    r.catchUpClosure = <span class="keyword">null</span>;</span><br><span class="line">    r.lastRpcSendTimestamp = Utils.monotonicMs();</span><br><span class="line">    <span class="comment">// 启动心跳计时器，超时则提交给回调线程池，发送心跳</span></span><br><span class="line">    r.startHeartbeatTimer(Utils.nowMs());</span><br><span class="line">    <span class="comment">// 给对端发送空的条目，Probe请求</span></span><br><span class="line">    r.sendEmptyEntries(<span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">return</span> r.id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下台倒计时</p>
<p>NodeImpl#handleStepDownTimeout</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleStepDownTimeout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.writeLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 处于Candidate或Follower状态的节点不需要退位</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.state.compareTo(State.STATE_TRANSFERRING) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> monotonicNowMs = Utils.monotonicMs();</span><br><span class="line">        <span class="comment">// 通过检查大多数节点是否有效，判断当前Leader是否有效，如果无法确定那就先下台</span></span><br><span class="line">        checkDeadNodes(<span class="keyword">this</span>.conf.getConf(), monotonicNowMs);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.conf.getOldConf().isEmpty()) &#123;</span><br><span class="line">            checkDeadNodes(<span class="keyword">this</span>.conf.getOldConf(), monotonicNowMs);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.writeLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>NodeImpl#checkDeadNodes</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkDeadNodes</span><span class="params">(<span class="keyword">final</span> Configuration conf, <span class="keyword">final</span> <span class="keyword">long</span> monotonicNowMs)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> List&lt;PeerId&gt; peers = conf.listPeers();</span><br><span class="line">    <span class="keyword">final</span> Configuration deadNodes = <span class="keyword">new</span> Configuration();</span><br><span class="line">    <span class="comment">// 通过和节点的最后一次通讯时间是否超时，判断大多数节点是否存活</span></span><br><span class="line">    <span class="keyword">if</span> (checkDeadNodes0(peers, monotonicNowMs, <span class="keyword">true</span>, deadNodes)) &#123;</span><br><span class="line">        <span class="comment">// 如果大多数节点仍存活，可以认为当前Leader仍是有效的，不需要退位</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> Status status = <span class="keyword">new</span> Status();</span><br><span class="line">    status.setError(RaftError.ERAFTTIMEDOUT, <span class="string">"Majority of the group dies: %d/%d"</span>, deadNodes.size(), peers.size());</span><br><span class="line">    <span class="comment">// 无法确认自己是否仍是有效的Leader，自己先下台吧</span></span><br><span class="line">    stepDown(<span class="keyword">this</span>.currTerm, <span class="keyword">false</span>, status);</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 当时中央已经研究决定了，就由我来当Leader，我说另请高明吧，我实在也不是谦虚，我一个Follower怎么就成了Candidate了呢</span></span><br><span class="line"><span class="comment">     * 但是，Leader同志讲，“大家已经研究决定了”</span></span><br><span class="line"><span class="comment">     * 后来我就念了两句林则徐的《赴戍登程口占示家人二首》，“苟利国家生死以，岂因祸福避趋之”，所以我就成了Leader</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>NodeImpl#checkDeadNodes0</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">checkDeadNodes0</span><span class="params">(<span class="keyword">final</span> List&lt;PeerId&gt; peers, <span class="keyword">final</span> <span class="keyword">long</span> monotonicNowMs, <span class="keyword">final</span> <span class="keyword">boolean</span> checkReplicator, <span class="keyword">final</span> Configuration deadNodes)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Leader的租约超时</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> leaderLeaseTimeoutMs = <span class="keyword">this</span>.options.getLeaderLeaseTimeoutMs();</span><br><span class="line">    <span class="keyword">int</span> aliveCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">long</span> startLease = Long.MAX_VALUE;</span><br><span class="line">    <span class="comment">// 遍历节点</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">final</span> PeerId peer : peers) &#123;</span><br><span class="line">        <span class="comment">// 跳过自身</span></span><br><span class="line">        <span class="keyword">if</span> (peer.equals(<span class="keyword">this</span>.serverId)) &#123;</span><br><span class="line">            aliveCount++;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (checkReplicator) &#123;</span><br><span class="line">            <span class="comment">// 如果当前节点的状态是Leader，检查之前是不是为该节点分配Replicator失败，如果是，则再次尝试分配一次Replicator</span></span><br><span class="line">            checkReplicator(peer);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 该节点上次通讯时间</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> lastRpcSendTimestamp = <span class="keyword">this</span>.replicatorGroup.getLastRpcSendTimestamp(peer);</span><br><span class="line">        <span class="comment">// 没有超过Leader的租约超时</span></span><br><span class="line">        <span class="keyword">if</span> (monotonicNowMs - lastRpcSendTimestamp &lt;= leaderLeaseTimeoutMs) &#123;</span><br><span class="line">            <span class="comment">// 可以认为该节点是存活的</span></span><br><span class="line">            aliveCount++;</span><br><span class="line">            <span class="keyword">if</span> (startLease &gt; lastRpcSendTimestamp) &#123;</span><br><span class="line">                <span class="comment">// 所有节点中最后通讯的时间</span></span><br><span class="line">                startLease = lastRpcSendTimestamp;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 跳过该节点</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (deadNodes != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 否则认为节点已死亡</span></span><br><span class="line">            deadNodes.addPeer(peer);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="comment">// 遍历检查结束</span></span><br><span class="line">    <span class="comment">// 存活的节点数大于节点总数，认为是有效的</span></span><br><span class="line">    <span class="keyword">if</span> (aliveCount &gt;= peers.size() / <span class="number">2</span> + <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// 更新自己作为Leader的最新时间</span></span><br><span class="line">        updateLastLeaderTimestamp(startLease);</span><br><span class="line">        <span class="comment">// 自己当前Leader仍有效</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Leader已无效</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p>投票超时处理</p>
<p>NodeImpl#handleVoteTimeout</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleVoteTimeout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.writeLock.lock();</span><br><span class="line">    <span class="comment">// 如果当前节点仍处于Candidate状态，说明Leader仍然未知</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.state == State.STATE_CANDIDATE) &#123;</span><br><span class="line">        <span class="comment">// 再次尝试选举自己</span></span><br><span class="line">        electSelf();</span><br><span class="line">        <span class="comment">// 写锁会在完成后释放</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.writeLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


		<footer>
			 
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

		</footer>
	</div>
	<!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->

	<script>var timeEnd = new Date();console.log('耗时：' + (timeEnd - timeStart));</script>
	<!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
	<!-- material design -->
	<!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
	<!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
	<!-- toc -->
	<!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
	<!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
	<!-- <script src="/js/main.js"></script> -->
</body>
</html>
