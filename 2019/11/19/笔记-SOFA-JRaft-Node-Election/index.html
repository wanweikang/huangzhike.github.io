<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
        <script>
            var timeStart = new Date();
        </script>
        
        <title>[ç¬”è®°]-SOFA-JRaft-Node-Election | ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜</title>
        
        <meta name="author" content="huangzhike">
        
        
        <meta name="description" content="JRaftç‰ˆæœ¬ï¼š1.2.6
åœ¨æ³¨é‡Šé‡Œé¢æœ‰æ—¶ä¼šå‘ç°ç±»ä¼¼we is ...ä¹‹ç±»çš„é”™è¯¯ï¼Œä¸åæ§½äº†ï¼Œæ„æ€å¯¹å°±å¥½ã€‚

èŠ‚ç‚¹åˆå§‹åŒ–
NodeImpl#init
    @Override
    public boolean init(final NodeOptions opts) {
        //  ">
        
        
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        
        <meta property="og:title" content="[ç¬”è®°]-SOFA-JRaft-Node-Election"/>
        
        <meta property="og:site_name" content="ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜"/>
        
        
        <!-- favicon -->
        <link rel="icon" type="image/ico" href="/ok.ico" sizes="32x32">
        <meta name="msapplication-TileColor" content="#009688">
        <meta name="msapplication-TileImage" content="/mstile-144x144.ico">
        <meta name="theme-color" content="#009688">
        <!-- favicon end -->
        <!-- <link href="//ok.ico" rel="icon"> -->
        
        <!-- toc -->
        <!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
        <!-- material design -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
        <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
        
        <!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
        <!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
    <meta name="generator" content="Hexo 4.2.1"></head>

<body>
    <nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">èœå•</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" title="ä¸‹ä¸€å¥æ˜¯ï¼šå®¢æœ‰å¯äººæœŸä¸æ¥ã€‚å°æ—¶å€™ï¼Œå–œæ¬¢é åœ¨é˜³å°ä¸Šï¼Œä¸€è¾¹å¹é£ï¼Œä¸€è¾¹çœ‹ä¹¦ï¼Œå–œæ¬¢è¯»ä¹¦å—ï¼Œéªšå¹´ï¼Ÿ" href="/">ä¹¦å½“å¿«æ„è¯»æ˜“å°½</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" target="_blank" rel="noopener" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

    <div class="container" >
        <div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[ç¬”è®°]-SOFA-JRaft-Node-Election</h2>
				
				<div>
					<div class="post-time">2019-11-19</div>
				</div>
				
				<div class="article-content">
				<p>JRaftç‰ˆæœ¬ï¼š1.2.6</p>
<p>åœ¨æ³¨é‡Šé‡Œé¢æœ‰æ—¶ä¼šå‘ç°ç±»ä¼¼<code>we is ...</code>ä¹‹ç±»çš„é”™è¯¯ï¼Œä¸åæ§½äº†ï¼Œæ„æ€å¯¹å°±å¥½ã€‚</p>
<hr>
<p>èŠ‚ç‚¹åˆå§‹åŒ–</p>
<p>NodeImpl#init</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">final</span> NodeOptions opts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//  ...</span>
        <span class="token comment" spellcheck="true">// æŠ•ç¥¨å®šæ—¶å™¨ï¼ŒHashedWheelTimer</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>voteTimer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RepeatedTimer</span><span class="token punctuation">(</span><span class="token string">"JRaft-VoteTimer"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getElectionTimeoutMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onTrigger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å¤„ç†æŠ•ç¥¨åè¶…æ—¶ï¼ŒæŠ•ç¥¨ç»“æœç¡®å®šåæ‰€æœ‰èŠ‚ç‚¹çš„çŠ¶æ€åº”è¯¥ä¸ºLeaderæˆ–Followerï¼Œå¦‚æœä»ä¸ºCandidateï¼Œåˆ™æ˜¯æœªå†³</span>
                <span class="token function">handleVoteTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">protected</span> <span class="token keyword">int</span> <span class="token function">adjustTimeout</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span> timeoutMs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token function">randomTimeout</span><span class="token punctuation">(</span>timeoutMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// é€‰ä¸¾å®šæ—¶å™¨ï¼ŒHashedWheelTimer</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>electionTimer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RepeatedTimer</span><span class="token punctuation">(</span><span class="token string">"JRaft-ElectionTimer"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getElectionTimeoutMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onTrigger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// é€‰ä¸¾è¶…æ—¶ï¼šFollowerè¶…æ—¶æœªæ”¶åˆ°Leaderçš„å¿ƒè·³ï¼Œåˆ™è½¬ä¸ºCandidateï¼Œå°è¯•å‘èµ·æŠ•ç¥¨è¯·æ±‚ï¼Œè¦æ±‚æˆä¸ºLeader</span>
                <span class="token function">handleElectionTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">protected</span> <span class="token keyword">int</span> <span class="token function">adjustTimeout</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span> timeoutMs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// è¿”å›éšæœºè¶…æ—¶ï¼Œå¦åˆ™FollowerèŠ‚ç‚¹å¯èƒ½åŒæ—¶å‘å‡ºè¯·æ±‚ï¼Œç„¶åç“œåˆ†é€‰ç¥¨ï¼Œä¸æ–­å¾ªç¯</span>
                <span class="token keyword">return</span> <span class="token function">randomTimeout</span><span class="token punctuation">(</span>timeoutMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// é€€ä½è®¡æ—¶å™¨ï¼ŒHashedWheelTimerï¼Œæ—¶é—´ä¸ºElectionTimeout/2</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>stepDownTimer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RepeatedTimer</span><span class="token punctuation">(</span><span class="token string">"JRaft-StepDownTimer"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getElectionTimeoutMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onTrigger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ä¸‹å°å€’è®¡æ—¶ï¼šå½“å‰èŠ‚ç‚¹çŠ¶æ€ä¸ºLeaderæ—¶ï¼Œæ ¹æ®æ˜¯å¦å¾—åˆ°è¿‡åŠèŠ‚ç‚¹çš„å“åº”ç¡®å®šå½“å‰Leaderæ˜¯å¦æœ‰æ•ˆï¼Œä¸èƒ½ç¡®å®šé‚£å°±å…ˆä¸‹å°</span>
                <span class="token function">handleStepDownTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¿«ç…§å®šæ—¶å™¨ï¼ŒHashedWheelTimerï¼Œé»˜è®¤ä¸€å°æ—¶</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>snapshotTimer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RepeatedTimer</span><span class="token punctuation">(</span><span class="token string">"JRaft-SnapshotTimer"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getSnapshotIntervalSecs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onTrigger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ç”Ÿæˆå¿«ç…§</span>
                <span class="token function">handleSnapshotTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ç®¡ç†ConfigurationEntryåˆ—è¡¨å’ŒConfigurationEntryçš„å¿«ç…§</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>configManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConfigurationManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Disruptorï¼ŒMPSCæ¨¡å‹ï¼Œå¤šç”Ÿäº§è€…å•æ¶ˆè´¹è€…</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>applyDisruptor <span class="token operator">=</span> DisruptorBuilder<span class="token punctuation">.</span>&lt;LogEntryAndClosure<span class="token operator">></span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//</span>
                <span class="token punctuation">.</span><span class="token function">setRingBufferSize</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>raftOptions<span class="token punctuation">.</span><span class="token function">getDisruptorBufferSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// ç¯å½¢é˜Ÿåˆ—å¤§å°ï¼ŒRingBufferæ˜¯ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´çš„ç¼“å†²ï¼Œå­˜æ”¾äº‹ä»¶</span>
                <span class="token punctuation">.</span><span class="token function">setEventFactory</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LogEntryAndClosureFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// äº‹ä»¶å·¥å‚ï¼Œç”¨äºåˆ›å»ºäº‹ä»¶ï¼Œäº‹ä»¶å°±æ˜¯è¢«æ¶ˆè´¹çš„å¯¹è±¡</span>
                <span class="token punctuation">.</span><span class="token function">setThreadFactory</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NamedThreadFactory</span><span class="token punctuation">(</span><span class="token string">"JRaft-NodeImpl-Disruptor-"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// ç”Ÿäº§è€…çº¿ç¨‹å·¥å‚</span>
                <span class="token punctuation">.</span><span class="token function">setProducerType</span><span class="token punctuation">(</span>ProducerType<span class="token punctuation">.</span>MULTI<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// å¤šç”Ÿäº§è€…æ¨¡å¼</span>
                <span class="token punctuation">.</span><span class="token function">setWaitStrategy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BlockingWaitStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//  æ¶ˆè´¹è€…ç­‰å¾…ç­–ç•¥ï¼Œé˜»å¡</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// äº‹ä»¶å¤„ç†å™¨ï¼Œå³æ¶ˆè´¹è€…ï¼Œå¤„ç†å‘å¸ƒçš„Log</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>applyDisruptor<span class="token punctuation">.</span><span class="token function">handleEventsWith</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LogEntryAndClosureHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¼‚å¸¸å¤„ç†å™¨</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>applyDisruptor<span class="token punctuation">.</span><span class="token function">setDefaultExceptionHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LogExceptionHandler</span><span class="token operator">&lt;</span>Object<span class="token operator">></span><span class="token punctuation">(</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¯åŠ¨Disruptorï¼Œè¿”å›RingBuffer</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>applyQueue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>applyDisruptor<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// çŠ¶æ€æœºCaller</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fsmCaller <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FSMCallerImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å®ä¾‹åŒ–å¹¶åˆå§‹åŒ–LogManagerï¼Œé»˜è®¤å­˜å‚¨å®ç°æ˜¯RocksDBï¼Œå°è¯•ä»æœ¬åœ°åŠ è½½LogEntry</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">initLogStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å®ä¾‹åŒ–å¹¶åˆå§‹åŒ–RaftMetaStorageï¼Œå°è¯•ä»æœ¬åœ°æ–‡ä»¶åŠ è½½CurrTermå’ŒVotedId</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">initMetaStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// åˆå§‹åŒ–FSMCallerï¼Œåˆå§‹çš„Logçš„Indexå’ŒTerméƒ½æ˜¯0</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">initFSMCaller</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LogId</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// æŠ•ç¥¨ç®±</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ballotBox <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BallotBox</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// åˆå§‹åŒ–æŠ•ç¥¨ç®±</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>ballotBox<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>ballotBoxOpts<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// åˆå§‹åŒ–SnapshotStorageï¼Œå°è¯•ä»æœ¬åœ°æ–‡ä»¶åŠ è½½Snapshotçš„å…ƒæ•°æ®</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">initSnapshotStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// æ£€æŸ¥æ—¥å¿—ä¸€è‡´æ€§</span>
        <span class="token keyword">final</span> Status st <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>logManager<span class="token punctuation">.</span><span class="token function">checkConsistency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// ConfigurationEntry</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>conf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConfigurationEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>conf<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LogId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¦‚æœæœ¬åœ°LogStorageæœ‰æœ‰æ•ˆçš„LastLogIndex</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logManager<span class="token punctuation">.</span><span class="token function">getLastLogIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ä½¿ç”¨æœ‰æ•ˆçš„ConfigurationEntry</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>conf <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>logManager<span class="token punctuation">.</span><span class="token function">checkAndSetConfiguration</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ConfigurationEntryä½¿ç”¨å¯åŠ¨æ—¶é…ç½®çš„Configuration</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>conf<span class="token punctuation">.</span><span class="token function">setConf</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getInitialConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>replicatorGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReplicatorGroupImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// RPCå®¢æˆ·ç«¯æœåŠ¡</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>rpcService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BoltRaftClientService</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>replicatorGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// åˆå§‹åŒ–RPCæœåŠ¡</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>rpcService<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// åˆå§‹åŒ–ReplicatorGroup</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>replicatorGroup<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NodeId</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>groupId<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>serverId<span class="token punctuation">)</span><span class="token punctuation">,</span> rgOpts<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ä¸€è‡´æ€§è¯»</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>readOnlyService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReadOnlyServiceImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">//</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>readOnlyService<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>rosOpts<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// åˆå§‹çŠ¶æ€ä¸‹æ‰€æœ‰èŠ‚ç‚¹éƒ½æ˜¯Follower</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> State<span class="token punctuation">.</span>STATE_FOLLOWER<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>snapshotExecutor <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getSnapshotIntervalSecs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å¯åŠ¨Snapshotè®¡æ—¶å™¨</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>snapshotTimer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å¦‚æœConfigurationçš„PeerIdåˆ—è¡¨ä¸ä¸ºç©º</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>conf<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å…ˆä¸‹å°ï¼Œæ›´æ–°ä»»æœŸï¼Œå¯åŠ¨é€‰ä¸¾è®¡æ—¶å™¨</span>
            <span class="token function">stepDown</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å°†å½“å‰èŠ‚ç‚¹NodeåŠ å…¥</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>NodeManager<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Nodeå·²å¯åŠ¨ï¼Œè·å–å†™é”ï¼Œé¿å…ç«äº‰</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¦‚æœGroupå†…åªæœ‰ä¸€ä¸ªServerèŠ‚ç‚¹å¹¶ä¸”å°±æ˜¯å½“å‰èŠ‚ç‚¹ï¼Œé‚£ä¹ˆå½“å‰èŠ‚ç‚¹ä¸€å®šæ˜¯Leader</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>conf<span class="token punctuation">.</span><span class="token function">isStable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>conf<span class="token punctuation">.</span><span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>conf<span class="token punctuation">.</span><span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>serverId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è§¦å‘VoteTimerï¼Œæˆä¸ºLeader</span>
            <span class="token function">electSelf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>è§¦å‘é€‰ä¸¾è¶…æ—¶</p>
<p>NodeImpl#handleElectionTimeout</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleElectionTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> doUnlock <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// åªæœ‰èŠ‚ç‚¹å¤„äºFollowerçŠ¶æ€æ‰æœ‰Leaderè¶…æ—¶</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">!=</span> State<span class="token punctuation">.</span>STATE_FOLLOWER<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// è¶…æ—¶æ²¡æ”¶åˆ°Leaderå¿ƒè·³ï¼Œé€‰ä¸¾è¶…æ—¶ï¼Œæ‰èƒ½ç»§ç»­</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isCurrentLeaderValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// è®¤ä¸ºLeaderå·²æ­»ï¼Œé‡ç½®LeaderId</span>
            <span class="token function">resetLeaderId</span><span class="token punctuation">(</span>PeerId<span class="token punctuation">.</span><span class="token function">emptyPeer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Status</span><span class="token punctuation">(</span>RaftError<span class="token punctuation">.</span>ERAFTTIMEDOUT<span class="token punctuation">,</span> <span class="token string">"Lost connection from leader %s."</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>leaderId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            doUnlock <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å‘èµ·é¢„æŠ•ç¥¨ï¼Œè¾¾æ ‡åä¼šå‘èµ·æ­£å¼æŠ•ç¥¨</span>
            <span class="token function">preVote</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>doUnlock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>NodeImpl#resetLeaderId</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">resetLeaderId</span><span class="token punctuation">(</span><span class="token keyword">final</span> PeerId newLeaderId<span class="token punctuation">,</span> <span class="token keyword">final</span> Status status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// å¦‚æœæ˜¯ç”¨ç©ºçš„PeerIdé‡ç½®</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>newLeaderId<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// åŸæœ¬å·²ç»å­˜åœ¨Leader &amp;&amp; å½“å‰èŠ‚ç‚¹ä¸æ˜¯Leader</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>leaderId<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>State<span class="token punctuation">.</span>STATE_TRANSFERRING<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å‘å¸ƒåœæ­¢è·ŸéšåŸæœ¬Leaderçš„äº‹ä»¶åˆ°RingBufferï¼Œå…·ä½“å›è°ƒå†…å®¹ç”±çŠ¶æ€æœºå®ç°å†³å®šï¼Œé»˜è®¤å•¥ä¹Ÿä¸å¹²</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>fsmCaller<span class="token punctuation">.</span><span class="token function">onStopFollowing</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LeaderChangeContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>leaderId<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ç½®ç©º</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>leaderId <span class="token operator">=</span> PeerId<span class="token punctuation">.</span><span class="token function">emptyPeer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å¦‚æœæ˜¯ç”¨æ–°çš„PeerIdé‡ç½®</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å¦‚æœå½“å‰ä¸å­˜åœ¨Leader</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>leaderId <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>leaderId<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å‘å¸ƒå¼€å§‹è·Ÿéšæ–°Leaderçš„äº‹ä»¶åˆ°RingBufferï¼Œå…·ä½“å›è°ƒå†…å®¹ç”±çŠ¶æ€æœºå®ç°å†³å®šï¼Œé»˜è®¤å•¥ä¹Ÿä¸å¹²</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>fsmCaller<span class="token punctuation">.</span><span class="token function">onStartFollowing</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LeaderChangeContext</span><span class="token punctuation">(</span>newLeaderId<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// æ›´æ–°Leader</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>leaderId <span class="token operator">=</span> newLeaderId<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>é¢„æŠ•ç¥¨ï¼š</p>
<p>å‡å¦‚æœ‰æŸä¸ªFollowerèŠ‚ç‚¹å› ä¸ºç½‘ç»œåˆ†åŒºæ”¶ä¸åˆ°LeaderèŠ‚ç‚¹çš„å¿ƒè·³ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šè‡ªåŠ¨è¯•å›¾ç«é€‰ä¸ºLeaderï¼Œä½†å› ä¸ºåˆ«çš„FollowerèŠ‚ç‚¹å’ŒLeaderé€šä¿¡æ­£å¸¸ï¼Œæ‰€ä»¥ä¸€ç›´æ— æ³•å½“é€‰ï¼Œç„¶åä¸æ–­å‘èµ·é€‰ä¸¾ã€‚</p>
<p>è€Œé€‰ä¸¾è¯·æ±‚ä¼šä¸€ç›´æŠ¬é«˜å…¨å±€èŠ‚ç‚¹çš„ä»»æœŸTermï¼Œæœ€ç»ˆä½¿åŸæœ¬æ­£å¸¸çš„LeaderèŠ‚ç‚¹StepDowné€€ä½ä¸ºFollowerã€‚</p>
<p>ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œå€™é€‰è€…åœ¨å‘èµ·æŠ•ç¥¨ä¹‹å‰ï¼Œè¦å…ˆå‘èµ·é¢„æŠ•ç¥¨ï¼Œå¦‚æœæ²¡æœ‰å¾—åˆ°åŠæ•°ä»¥ä¸ŠèŠ‚ç‚¹çš„æ‰¿è®¤ï¼Œåˆ™ä¸èƒ½æ­£å¼å‘èµ·é€‰ä¸¾ã€‚</p>
<p>ä¸Šé¢çš„æƒ…å†µæ˜¯å¯¹ç§°ç½‘ç»œåˆ†åŒºçš„ï¼Œè¿˜æœ‰ä¸€ç§æƒ…å†µæ˜¯éå¯¹ç§°ç½‘ç»œåˆ†åŒºã€‚</p>
<p>å‡å¦‚æœ‰ä¸‰ä¸ªèŠ‚ç‚¹Aï¼ŒBï¼ŒCï¼Œåˆ†åˆ«ä¸ºLeaderï¼ŒFollowerï¼ŒFollowerï¼Œå‡è®¾æŸä¸ªæ—¶åˆ»LeaderAå’ŒFollowerBä¹‹é—´å‡ºç°äº†ç½‘ç»œåˆ†åŒºï¼Œè€Œå…¶å®ƒè¿æ¥æ­£å¸¸ã€‚</p>
<p>Bä¼šå› ä¸ºè¶…æ—¶æ”¶ä¸åˆ°LeaderAçš„å¿ƒè·³è€Œè‡ªåŠ¨è½¬ä¸ºå€™é€‰äººï¼Œå‘èµ·é¢„æŠ•ç¥¨å’Œæ­£å¼æŠ•ç¥¨ï¼Œå‡è®¾é€šè¿‡å¹¶æˆä¸ºäº†Leaderï¼ˆBå’ŒCä¸¤ç¥¨ï¼‰ï¼Œè¿™æ ·å…¨å±€ä»»æœŸå°±ä¼šä¸Šå‡ï¼Œç„¶ååŸLeaderAè‡ªåŠ¨é€€ä½ä¸ºFollowerã€‚</p>
<p>æ˜¾ç„¶å› ä¸ºåˆ†åŒºçš„åŸå› ï¼ŒAä¹Ÿä¼šæ”¶ä¸åˆ°LeaderBçš„å¿ƒè·³ï¼Œç„¶åè¯•å›¾å‘èµ·é€‰ä¸¾ï¼Œå¦‚æ­¤åå¤ã€‚</p>
<p>æ ¹æ®JRaftå®˜æ–¹æ–‡æ¡£ï¼Œè¿™ç§æƒ…å†µçš„å¤„ç†æ–¹å¼æ˜¯åœ¨é€‰ä¸¾è¶…æ—¶åï¼ŒFolloweræ‰æ¥å—é¢„æŠ•ç¥¨è¯·æ±‚ï¼ŒNodeImpl#handlePreVoteRequestã€‚</p>
<p>åº”è¯¥æ˜¯è®©Cæˆä¸ºLeaderæ‰æ˜¯æœ€å¥½çš„ï¼Ÿ</p>
<p>å‘èµ·é¢„æŠ•ç¥¨</p>
<p>NodeImpl#preVote</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">preVote</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> oldTerm<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å®‰è£…Snapshotçš„æ—¶å€™ä¸èƒ½é¢„é€‰ä¸¾ï¼Œå› ä¸ºé…ç½®å¯èƒ½å·²è¿‡æ—¶</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>snapshotExecutor <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>snapshotExecutor<span class="token punctuation">.</span><span class="token function">isInstallingSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// æ²¡åŠ å…¥é…ç½®çš„èŠ‚ç‚¹ä¸èƒ½å‘èµ·é¢„é€‰ä¸¾</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>conf<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>serverId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ä¿å­˜å½“å‰ä»»æœŸ</span>
            oldTerm <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// è·å–æœ€åä¸€æ¡Log</span>
        <span class="token keyword">final</span> LogId lastLogId <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>logManager<span class="token punctuation">.</span><span class="token function">getLastLogId</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> doUnlock <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å†æ¬¡è·å–å†™é”</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å†æ¬¡è·å–å†™é”æœŸé—´ä»»æœŸå‘ç”Ÿäº†å˜åŒ–ï¼Œä¸ç»§ç»­</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>oldTerm <span class="token operator">!=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// åˆå§‹åŒ–Ballotï¼ŒæŠ•ç¥¨ç®±ï¼Œä»£è¡¨è¿™æ¬¡æŠ•ç¥¨</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>prevVoteCtx<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>conf<span class="token punctuation">.</span><span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>conf<span class="token punctuation">.</span><span class="token function">isStable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> null <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>conf<span class="token punctuation">.</span><span class="token function">getOldConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// éå†åŒè¾ˆèŠ‚ç‚¹</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> PeerId peer <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>conf<span class="token punctuation">.</span><span class="token function">listPeers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// è·³è¿‡è‡ªèº«</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>peer<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>serverId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// å¦‚æœå·²ç»è¿æ¥åˆ™è¿”å›trueï¼Œå¦åˆ™å‘é€PingRequeståŒæ­¥è¯·æ±‚ï¼Œè¿æ¥å¹¶å‘é€æˆåŠŸåè¿”å›ç»“æœï¼Œè·³è¿‡æ— æ³•è¿æ¥çš„åŒè¾ˆèŠ‚ç‚¹</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>rpcService<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>peer<span class="token punctuation">.</span><span class="token function">getEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// é¢„é€‰ä¸¾è¯·æ±‚å“åº”çš„å›è°ƒ</span>
                <span class="token keyword">final</span> OnPreVoteRpcDone done <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OnPreVoteRpcDone</span><span class="token punctuation">(</span>peer<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// åˆ›å»ºé¢„é€‰ä¸¾è¯·æ±‚ï¼ŒProtobuf</span>
                done<span class="token punctuation">.</span>request <span class="token operator">=</span> RequestVoteRequest<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//</span>
                        <span class="token punctuation">.</span><span class="token function">setPreVote</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// æ ‡æ˜æ˜¯ä¸ªé¢„é€‰ä¸¾è¯·æ±‚</span>
                        <span class="token punctuation">.</span><span class="token function">setGroupId</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>groupId<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//</span>
                        <span class="token punctuation">.</span><span class="token function">setServerId</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>serverId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//</span>
                        <span class="token punctuation">.</span><span class="token function">setPeerId</span><span class="token punctuation">(</span>peer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//</span>
                        <span class="token punctuation">.</span><span class="token function">setTerm</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currTerm <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// è¡¨ç¤ºç«é€‰ä¸‹ä¸€ä¸ªä»»æœŸï¼Œé¢„é€‰åªæ˜¯è¯·æ±‚çš„ä»»æœŸåŠ ä¸€ï¼Œæœ¬åœ°çš„ä»»æœŸä¸å˜ï¼Œæ­£å¼é€‰ä¸¾æ—¶æœ¬åœ°ä»»æœŸæ‰åŠ ä¸€</span>
                        <span class="token punctuation">.</span><span class="token function">setLastLogIndex</span><span class="token punctuation">(</span>lastLogId<span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// æœ€åä¸€æ¡Logçš„ç´¢å¼•</span>
                        <span class="token punctuation">.</span><span class="token function">setLastLogTerm</span><span class="token punctuation">(</span>lastLogId<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// æœ€åä¸€æ¡Logæ‰€å±çš„ä»»æœŸ</span>
                        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å‘è¯¥åŒè¾ˆèŠ‚ç‚¹å‘é€é¢„é€‰ä¸¾å¼‚æ­¥è¯·æ±‚ï¼Œæ”¶åˆ°å“åº”åæ‰§è¡Œå›è°ƒ</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>rpcService<span class="token punctuation">.</span><span class="token function">preVote</span><span class="token punctuation">(</span>peer<span class="token punctuation">.</span><span class="token function">getEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> done<span class="token punctuation">.</span>request<span class="token punctuation">,</span> done<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// Ballotï¼Œè‡ªå·±çš„ä¸€ç¥¨ä¹Ÿè¦ç®—ä¸Š</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>prevVoteCtx<span class="token punctuation">.</span><span class="token function">grant</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>serverId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// åªæœ‰è·å–åŠæ•°ä»¥ä¸Šçš„é¢„é€‰</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>prevVoteCtx<span class="token punctuation">.</span><span class="token function">isGranted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                doUnlock <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// æ‰èƒ½æ­£å¼é€‰ä¸¾è‡ªå·±</span>
                <span class="token function">electSelf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>doUnlock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>å¯¹ç«¯èŠ‚ç‚¹æ”¶åˆ°å¹¶å¤„ç†é¢„æŠ•ç¥¨è¯·æ±‚</p>
<p>NodeImpl#handlePreVoteRequest</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> Message <span class="token function">handlePreVoteRequest</span><span class="token punctuation">(</span><span class="token keyword">final</span> RequestVoteRequest request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> doUnlock <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å½“å‰èŠ‚ç‚¹æœªæ¿€æ´»ï¼Œä¸å¤„ç†é¢„æŠ•ç¥¨è¯·æ±‚</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">isActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">final</span> PeerId candidateId <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PeerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è§£æå€™é€‰äººèŠ‚ç‚¹çš„Idä¸ºPeerIdï¼Œå…¶å®é¢„é€‰ä¸¾å¯¹ç«¯åº”è¯¥è¿˜æ˜¯Follower</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>candidateId<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getServerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// é»˜è®¤ä¸å…è®¸å¯¹ç«¯çš„é¢„æŠ•ç¥¨è¯·æ±‚</span>
            <span class="token keyword">boolean</span> granted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">do</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å½“å‰èŠ‚ç‚¹å·²æœ‰Leaderï¼Œå¹¶ä¸”æœªè¶…è¿‡é€‰ä¸¾è¶…æ—¶ï¼Œåˆ™å½“å‰çš„Leaderæ˜¯æœ‰æ•ˆçš„ï¼Œä¸å…è®¸é¢„æŠ•ç¥¨</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>leaderId <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>leaderId<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isCurrentLeaderValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// å¯¹ç«¯ç«é€‰çš„ä»»æœŸå°äºèŠ‚ç‚¹æ‰€å¤„çš„ä»»æœŸï¼Œå³å¯¹ç«¯æ‰€å¤„çš„ä»»æœŸæ¯”å½“å‰èŠ‚ç‚¹çš„ä»»æœŸå°äº†2æˆ–ä»¥ä¸Šï¼Œä¸å…è®¸é¢„æŠ•ç¥¨</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å¯èƒ½æ˜¯æ—¥å¿—å¤åˆ¶æœ‰é—®é¢˜ï¼Œå¯¼è‡´Followerä»»æœŸè½åå¤ªå¤š</span>
                    <span class="token comment" spellcheck="true">// å¦‚æœå½“å‰èŠ‚ç‚¹æ˜¯Leaderï¼Œæ£€æŸ¥ä¹‹å‰æ˜¯ä¸æ˜¯ä¸ºè¯¥èŠ‚ç‚¹åˆ†é…Replicatorå¤±è´¥ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™å†æ¬¡å°è¯•åˆ†é…ä¸€æ¬¡Replicator</span>
                    <span class="token comment" spellcheck="true">// Replicatoræ˜¯èŠ‚ç‚¹æˆä¸ºLeaderæ—¶ç»™å…¶ä»–èŠ‚ç‚¹åˆ†é…çš„ï¼Œå› ä¸ºåªå°è¯•ä¸€æ¬¡ï¼Œæ‰€ä»¥å¯èƒ½å¤±è´¥</span>
                    <span class="token function">checkReplicator</span><span class="token punctuation">(</span>candidateId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// å¯¹ç«¯æ‰€å¤„çš„ä»»æœŸå’Œå½“å‰èŠ‚ç‚¹çš„ä»»æœŸä¸€è‡´ï¼Œä½†æ˜¯è¿˜æ˜¯å‘èµ·äº†é¢„æŠ•ç¥¨ï¼Œå¯èƒ½ä¹Ÿæ˜¯ç½‘ç»œæˆ–è€…å¿ƒè·³æœ‰é—®é¢˜ï¼Ÿ</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currTerm <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">checkReplicator</span><span class="token punctuation">(</span>candidateId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// ä¹Ÿå°±æ˜¯è¯´ï¼Œå³ä½¿å¯¹ç«¯çš„ä»»æœŸæ¯”è‡ªå·±çš„ä»»æœŸå°ä¸€ï¼Œä»ç„¶ä¼šæ¯”è¾ƒLogIdï¼Œä½†æ˜¯è¿™ç§æƒ…å†µå³ä½¿è¿”å›å‡†è®¸æŠ•ç¥¨ï¼Œå¯¹ç«¯æ”¶åˆ°å“åº”ååˆ¤æ–­ä»»æœŸæ¯”è‡ªå·±å¤§ï¼ŒæŠ•ç¥¨è¿˜æ˜¯ä¼šæ— æ•ˆï¼Œæ‰€ä»¥æ¯”è¾ƒLogIdçš„æ„ä¹‰æ˜¯ï¼Ÿ</span>
                doUnlock <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// è·å–æœ¬åœ°æœ€åä¸€æ¡Logçš„LogIdï¼ŒåŒ…å«Logçš„ä»»æœŸå’Œç´¢å¼•</span>
                <span class="token keyword">final</span> LogId lastLogId <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>logManager<span class="token punctuation">.</span><span class="token function">getLastLogId</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                doUnlock <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å‘å‡ºé¢„æŠ•ç¥¨è¯·æ±‚çš„èŠ‚ç‚¹çš„æœ€åä¸€æ¡Logçš„LogIdï¼ŒåŒ…å«Logçš„ä»»æœŸå’Œç´¢å¼•</span>
                <span class="token keyword">final</span> LogId requestLastLogId <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LogId</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getLastLogIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getLastLogTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å¦‚æœå¯¹ç«¯çš„æœ€åä¸€ä¸ªLogIdæ¯”è‡ªå·±çš„å¤§ï¼Œé‚£ä¹ˆè®¤ä¸ºå¯¹æ–¹çš„Logæ¯”è‡ªå·±çš„è¦å®Œæ•´å’Œæ›´æ–°ï¼Œå‡†è®¸å¯¹ç«¯æˆä¸ºLeader</span>
                <span class="token comment" spellcheck="true">// å…ˆæ¯”è¾ƒä»»æœŸTermï¼Œå†æ¯”è¾ƒç´¢å¼•Index</span>
                granted <span class="token operator">=</span> requestLastLogId<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>lastLogId<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> RequestVoteResponse<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//</span>
                    <span class="token punctuation">.</span><span class="token function">setTerm</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// å½“å‰èŠ‚ç‚¹æ‰€å¤„çš„ä»»æœŸ</span>
                    <span class="token punctuation">.</span><span class="token function">setGranted</span><span class="token punctuation">(</span>granted<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// æ˜¯å¦å‡†è®¸é¢„æŠ•ç¥¨</span>
                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ç”Ÿæˆå“åº”</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>doUnlock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>å›è°ƒå¤„ç†é¢„æŠ•ç¥¨è¯·æ±‚çš„å“åº”</p>
<p>NodeImpl#handlePreVoteResponse</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handlePreVoteResponse</span><span class="token punctuation">(</span><span class="token keyword">final</span> PeerId peerId<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> term<span class="token punctuation">,</span> <span class="token keyword">final</span> RequestVoteResponse response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> doUnlock <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// èŠ‚ç‚¹ä»å¤„äºFollowerçŠ¶æ€æ—¶æ‰å¤„ç†é¢„æŠ•ç¥¨è¯·æ±‚çš„å“åº”ï¼Œå› ä¸ºCandidateå’ŒLeaderä¸å‘å‡ºé¢„æŠ•ç¥¨è¯·æ±‚</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">!=</span> State<span class="token punctuation">.</span>STATE_FOLLOWER<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å‘å‡ºé¢„é€‰ä¸¾è¯·æ±‚ååˆ°æ”¶åˆ°å“åº”çš„è¿™æ®µæ—¶é—´å†…ï¼ŒèŠ‚ç‚¹çš„ä»»æœŸå‘ç”Ÿäº†å˜åŒ–ï¼Œåˆ™å“åº”æ— æ•ˆ</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>term <span class="token operator">!=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å“åº”é¢„æŠ•ç¥¨è¯·æ±‚çš„å¯¹ç«¯èŠ‚ç‚¹çš„ä»»æœŸå¤§äºå½“å‰èŠ‚ç‚¹çš„ä»»æœŸï¼Œåˆ™æŠ•ç¥¨è¢«æ‹’ç»</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æ€»ä¹‹å½“å‰èŠ‚ç‚¹å…ˆé€€ä½ä¸ºFollowerï¼Œå¹¶åŒæ­¥ä»»æœŸï¼Œå¯åŠ¨é€‰ä¸¾è®¡æ—¶å™¨</span>
                <span class="token function">stepDown</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Status</span><span class="token punctuation">(</span>RaftError<span class="token punctuation">.</span>EHIGHERTERMRESPONSE<span class="token punctuation">,</span> <span class="token string">"Raft node receives higher term pre_vote_response."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å¦‚æœå¯¹ç«¯å‡†è®¸äº†é¢„æŠ•ç¥¨è¯·æ±‚</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getGranted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Ballotï¼Œå¦‚æœè·å¾—äº†å¯¹ç«¯çš„ä¸€ç¥¨</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>prevVoteCtx<span class="token punctuation">.</span><span class="token function">grant</span><span class="token punctuation">(</span>peerId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å¦‚æœè¾¾åˆ°äº†åˆæ³•äººæ•°</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>prevVoteCtx<span class="token punctuation">.</span><span class="token function">isGranted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// æš‚æ—¶ä¸é‡Šæ”¾å†™é”ï¼Œå¤§æ¦‚æ˜¯é¿å…å†æ¬¡è·å–é”æ—¶å¤±è´¥ï¼Œè¯»å†™é”é»˜è®¤æ˜¯å…¬å¹³é”è¿˜æ˜¯éå…¬å¹³ï¼Ÿå¿˜äº†</span>
                    doUnlock <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// å¯ä»¥å¼€å§‹æ­£å¼æŠ•ç¥¨ç»™è‡ªå·±äº†</span>
                    <span class="token function">electSelf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>doUnlock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>NodeImpl#stepDown</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">stepDown</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">long</span> term<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> wakeupCandidate<span class="token punctuation">,</span> <span class="token keyword">final</span> Status status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// éæ¿€æ´»çŠ¶æ€çš„èŠ‚ç‚¹</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">isActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å¦‚æœå½“å‰èŠ‚ç‚¹çŠ¶æ€ä¸ºCandidate</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">==</span> State<span class="token punctuation">.</span>STATE_CANDIDATE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å–æ¶ˆå€™é€‰äººçš„æŠ•ç¥¨è¶…æ—¶è®¡æ—¶å™¨</span>
            <span class="token function">stopVoteTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å¦‚æœå½“å‰èŠ‚ç‚¹çŠ¶æ€ä¸ºLeaderæˆ–è½¬ç§»é¢†å¯¼æƒä¸­</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>State<span class="token punctuation">.</span>STATE_TRANSFERRING<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å–æ¶ˆé€€ä½è®¡æ—¶å™¨</span>
            <span class="token function">stopStepDownTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>ballotBox<span class="token punctuation">.</span><span class="token function">clearPendingTasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">==</span> State<span class="token punctuation">.</span>STATE_LEADER<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å‘å¸ƒLeaderä¸‹å°äº‹ä»¶åˆ°çŠ¶æ€æœºçš„RingBufferï¼Œå…·ä½“å¤„ç†ç”±çŠ¶æ€æœºçš„å®ç°å†³å®š</span>
                <span class="token function">onLeaderStop</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// é‡ç½®LeaderIdä¸ºç©º</span>
        <span class="token function">resetLeaderId</span><span class="token punctuation">(</span>PeerId<span class="token punctuation">.</span><span class="token function">emptyPeer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// é‡ç½®çŠ¶æ€ä¸ºFollower</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> State<span class="token punctuation">.</span>STATE_FOLLOWER<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>confCtx<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">updateLastLeaderTimestamp</span><span class="token punctuation">(</span>Utils<span class="token punctuation">.</span><span class="token function">monotonicMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>snapshotExecutor <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å–æ¶ˆSnapshotä¸‹è½½</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>snapshotExecutor<span class="token punctuation">.</span><span class="token function">interruptDownloadingSnapshots</span><span class="token punctuation">(</span>term<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>term <span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ›´æ–°ä»»æœŸï¼Œå–å¤§çš„</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>currTerm <span class="token operator">=</span> term<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>votedId <span class="token operator">=</span> PeerId<span class="token punctuation">.</span><span class="token function">emptyPeer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>metaStorage<span class="token punctuation">.</span><span class="token function">setTermAndVotedFor</span><span class="token punctuation">(</span>term<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>votedId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>wakeupCandidate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å–æ¶ˆæ‰€æœ‰Replicator</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>replicatorGroup<span class="token punctuation">.</span><span class="token function">stopAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>stopTransferArg <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å¯åŠ¨é€‰ä¸¾è®¡æ—¶å™¨</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>electionTimer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>æ­£å¼å‘èµ·æŠ•ç¥¨</p>
<p>NodeImpl#electSelf</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">electSelf</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> oldTerm<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ä¸åœ¨é…ç½®ä¸­çš„èŠ‚ç‚¹ä¸èƒ½é€‰ä¸¾è‡ªå·±</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>conf<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>serverId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å¦‚æœå½“å‰èŠ‚ç‚¹çš„çŠ¶æ€æ˜¯Followerï¼Œå…ˆåœæ­¢é€‰ä¸¾è®¡æ—¶å™¨</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">==</span> State<span class="token punctuation">.</span>STATE_FOLLOWER<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>electionTimer<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// é‡ç½®LeaderId</span>
            <span class="token function">resetLeaderId</span><span class="token punctuation">(</span>PeerId<span class="token punctuation">.</span><span class="token function">emptyPeer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Status</span><span class="token punctuation">(</span>RaftError<span class="token punctuation">.</span>ERAFTTIMEDOUT<span class="token punctuation">,</span> <span class="token string">"A follower's leader_id is reset to NULL as it begins to request_vote."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// åˆ‡æ¢èŠ‚ç‚¹çš„çŠ¶æ€ä¸ºCandidate</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> State<span class="token punctuation">.</span>STATE_CANDIDATE<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æœ¬åœ°ä»»æœŸè‡ªå¢</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è¦æ±‚æŠ•ç»™è‡ªå·±</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>votedId <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>serverId<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å¯åŠ¨æŠ•ç¥¨è®¡æ—¶å™¨</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>voteTimer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// åˆå§‹åŒ–BallotæŠ•ç¥¨ç®±</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>voteCtx<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>conf<span class="token punctuation">.</span><span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>conf<span class="token punctuation">.</span><span class="token function">isStable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> null <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>conf<span class="token punctuation">.</span><span class="token function">getOldConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æš‚å­˜æŠ•ç¥¨å‰çš„ä»»æœŸ</span>
            oldTerm <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// è·å–æœ¬åœ°æœ€åä¸€æ¡Log</span>
        <span class="token keyword">final</span> LogId lastLogId <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>logManager<span class="token punctuation">.</span><span class="token function">getLastLogId</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è·å–å†™é”</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å†æ¬¡è·å–å†™é”æœŸé—´æœ¬åœ°ä»»æœŸå‘ç”Ÿäº†å˜åŒ–ï¼Œä¸å†ç»§ç»­</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>oldTerm <span class="token operator">!=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// éå†åŒè¾ˆèŠ‚ç‚¹</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> PeerId peer <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>conf<span class="token punctuation">.</span><span class="token function">listPeers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// è·³è¿‡è‡ªèº«</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>peer<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>serverId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// å¦‚æœå·²ç»è¿æ¥åˆ™è¿”å›trueï¼Œå¦åˆ™å‘é€PingRequeståŒæ­¥è¯·æ±‚ï¼Œè¿æ¥å¹¶å‘é€æˆåŠŸåè¿”å›ç»“æœï¼Œè·³è¿‡æ— æ³•è¿æ¥çš„åŒè¾ˆèŠ‚ç‚¹</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>rpcService<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>peer<span class="token punctuation">.</span><span class="token function">getEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// é€‰ä¸¾è¯·æ±‚çš„å›è°ƒ</span>
                <span class="token keyword">final</span> OnRequestVoteRpcDone done <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OnRequestVoteRpcDone</span><span class="token punctuation">(</span>peer<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// åˆ›å»ºé€‰ä¸¾è¯·æ±‚</span>
                done<span class="token punctuation">.</span>request <span class="token operator">=</span> RequestVoteRequest<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//</span>
                        <span class="token punctuation">.</span><span class="token function">setPreVote</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// æ ‡æ˜æ˜¯ä¸ªæ­£å¼é€‰ä¸¾è¯·æ±‚</span>
                        <span class="token punctuation">.</span><span class="token function">setGroupId</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>groupId<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//</span>
                        <span class="token punctuation">.</span><span class="token function">setServerId</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>serverId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//</span>
                        <span class="token punctuation">.</span><span class="token function">setPeerId</span><span class="token punctuation">(</span>peer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//</span>
                        <span class="token punctuation">.</span><span class="token function">setTerm</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// ç«é€‰çš„ä»»æœŸï¼Œå·²è‡ªå¢</span>
                        <span class="token punctuation">.</span><span class="token function">setLastLogIndex</span><span class="token punctuation">(</span>lastLogId<span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//</span>
                        <span class="token punctuation">.</span><span class="token function">setLastLogTerm</span><span class="token punctuation">(</span>lastLogId<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//</span>
                        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å‘åŒè¾ˆèŠ‚ç‚¹å‘é€é€‰ä¸¾å¼‚æ­¥è¯·æ±‚ï¼Œæ”¶åˆ°å“åº”åæ‰§è¡Œå›è°ƒ</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>rpcService<span class="token punctuation">.</span><span class="token function">requestVote</span><span class="token punctuation">(</span>peer<span class="token punctuation">.</span><span class="token function">getEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> done<span class="token punctuation">.</span>request<span class="token punctuation">,</span> done<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>metaStorage<span class="token punctuation">.</span><span class="token function">setTermAndVotedFor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>serverId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è‡ªå·±ä¹Ÿè¦æŠ•ç»™è‡ªå·±ä¸€ç¥¨</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>voteCtx<span class="token punctuation">.</span><span class="token function">grant</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>serverId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// åªæœ‰è·å–åŠæ•°ä»¥ä¸Šçš„é€‰ç¥¨</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>voteCtx<span class="token punctuation">.</span><span class="token function">isGranted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æ‰èƒ½æˆä¸ºLeader</span>
                <span class="token function">becomeLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>å¯¹ç«¯èŠ‚ç‚¹æ”¶åˆ°å¹¶å¤„ç†æ­£å¼æŠ•ç¥¨è¯·æ±‚</p>
<p>NodeImpl#handleRequestVoteRequest</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> Message <span class="token function">handleRequestVoteRequest</span><span class="token punctuation">(</span><span class="token keyword">final</span> RequestVoteRequest request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> doUnlock <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// èŠ‚ç‚¹å¿…é¡»æ¿€æ´»æ‰èƒ½å¤„ç†æ­£å¼æŠ•ç¥¨è¯·æ±‚</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">isActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> RpcResponseFactory<span class="token punctuation">.</span><span class="token function">newResponse</span><span class="token punctuation">(</span>RaftError<span class="token punctuation">.</span>EINVAL<span class="token punctuation">,</span> <span class="token string">"Node %s is not in active state, state %s."</span><span class="token punctuation">,</span> <span class="token function">getNodeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å‘èµ·æ­£å¼æŠ•ç¥¨è¯·æ±‚çš„å€™é€‰äººId</span>
            <span class="token keyword">final</span> PeerId candidateId <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PeerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è§£æå€™é€‰äººçš„Idä¸ºPeerId</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>candidateId<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getServerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> RpcResponseFactory<span class="token punctuation">.</span><span class="token function">newResponse</span><span class="token punctuation">(</span>RaftError<span class="token punctuation">.</span>EINVAL<span class="token punctuation">,</span> <span class="token string">"Parse candidateId failed: %s."</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getServerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// æˆä¸ºLeaderçš„è¦æ±‚ï¼šè¯¥èŠ‚ç‚¹ä¿å­˜çš„Logæœ€æ–°æœ€å®Œæ•´</span>
            <span class="token keyword">do</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å…ˆæ¯”è¾ƒä»»æœŸ</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å¦‚æœå¯¹æ–¹æ­£å¼ç«é€‰çš„ä»»æœŸå¤§äºè‡ªå·±å½“å‰çš„ä»»æœŸï¼Œé‚£ä¹ˆéœ€è¦æ›´æ–°è‡ªå·±çš„ä»»æœŸï¼Œè¿™æ ·å…¨å±€èŠ‚ç‚¹çš„ä»»æœŸä¹Ÿä¼šæ›´æ–°</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// é€€ä½ä¸ºFollowerï¼ŒåŒæ­¥ä»»æœŸï¼Œå¯åŠ¨é€‰ä¸¾è®¡æ—¶å™¨</span>
                        <span class="token function">stepDown</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Status</span><span class="token punctuation">(</span>RaftError<span class="token punctuation">.</span>EHIGHERTERMRESPONSE<span class="token punctuation">,</span> <span class="token string">"Raft node receives higher term RequestVoteRequest."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// å¦‚æœè¯·æ±‚ç«é€‰çš„ä»»æœŸè¦æ¯”è‡ªå·±å½“å‰ä»»æœŸå°ï¼Œè¯´æ˜æ—¥å¿—æ¯”è‡ªå·±æ®‹ç¼ºï¼Œä¸èƒ½æŠ•ç¥¨ç»™å®ƒ</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                doUnlock <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// è·å–æœ¬åœ°æœ€åä¸€æ¡Logçš„LogId</span>
                <span class="token keyword">final</span> LogId lastLogId <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>logManager<span class="token punctuation">.</span><span class="token function">getLastLogId</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                doUnlock <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// vote need ABA check after unlock&amp;writeLock</span>
                <span class="token comment" spellcheck="true">// é‡Šæ”¾å†™é”åä»»æœŸå‘ç”Ÿäº†å˜åŒ–ï¼Œä¸èƒ½ç»§ç»­</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// Logç”±LeaderåŒæ­¥è¿‡æ¥ï¼ŒLogIndexå•è°ƒé€’å¢ï¼Œå¦‚æœå¯¹ç«¯çš„æœ€åä¸€æ¡Logæ‰€å±çš„Termæˆ–Indexæ¯”è‡ªå·±çš„å°ï¼Œè¯´æ˜æ—¥å¿—æ¯”è‡ªèº«æ®‹ç¼ºï¼Œä¸èƒ½æŠ•ç¥¨ç»™å®ƒ</span>
                <span class="token keyword">final</span> <span class="token keyword">boolean</span> logIsOk <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LogId</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getLastLogIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getLastLogTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>lastLogId<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å¯èƒ½æ”¶åˆ°å¤šä¸ªèŠ‚ç‚¹çš„æŠ•ç¥¨è¯·æ±‚ï¼Œä½†æ˜¯ç¥¨åªæœ‰ä¸€ä¸ª</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>logIsOk <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>votedId <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>votedId<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// æ›´æ–°è‡ªå·±çš„ä»»æœŸ</span>
                    <span class="token function">stepDown</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Status</span><span class="token punctuation">(</span>RaftError<span class="token punctuation">.</span>EVOTEFORCANDIDATE<span class="token punctuation">,</span> <span class="token string">"Raft node votes for some candidate, step down to restart election_timer."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>votedId <span class="token operator">=</span> candidateId<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>metaStorage<span class="token punctuation">.</span><span class="token function">setVotedFor</span><span class="token punctuation">(</span>candidateId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> RequestVoteResponse<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//</span>
                    <span class="token punctuation">.</span><span class="token function">setTerm</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//</span>
                    <span class="token punctuation">.</span><span class="token function">setGranted</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currTerm <span class="token operator">&amp;&amp;</span> candidateId<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>votedId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// æ˜¯å¦åŒæ„è¯¥ç¥¨</span>
                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>doUnlock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>CandidateèŠ‚ç‚¹å›è°ƒå¤„ç†æ­£å¼æŠ•ç¥¨è¯·æ±‚çš„å“åº”</p>
<p>NodeImpl#handleRequestVoteResponse</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleRequestVoteResponse</span><span class="token punctuation">(</span><span class="token keyword">final</span> PeerId peerId<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> term<span class="token punctuation">,</span> <span class="token keyword">final</span> RequestVoteResponse response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// åªæœ‰èŠ‚ç‚¹å¤„äºCandidateçŠ¶æ€æ—¶æ‰èƒ½å¤„ç†æ­£å¼æŠ•ç¥¨çš„å“åº”</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">!=</span> State<span class="token punctuation">.</span>STATE_CANDIDATE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å‘å‡ºæŠ•ç¥¨è¯·æ±‚åæœ¬åœ°ä»»æœŸå‘ç”Ÿäº†å˜åŒ–ï¼ŒæŠ•ç¥¨æ— æ•ˆ</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>term <span class="token operator">!=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å“åº”æŠ•ç¥¨è¯·æ±‚çš„å¯¹ç«¯èŠ‚ç‚¹çš„ä»»æœŸå¤§äºå½“å‰èŠ‚ç‚¹çš„ä»»æœŸï¼ŒæŠ•ç¥¨æ— æ•ˆ</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å½“å‰èŠ‚ç‚¹å…ˆä¸‹å°ä¸ºFollowerï¼Œæ›´æ–°ä»»æœŸï¼Œå¯åŠ¨é€‰ä¸¾è®¡æ—¶å™¨</span>
                <span class="token function">stepDown</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Status</span><span class="token punctuation">(</span>RaftError<span class="token punctuation">.</span>EHIGHERTERMRESPONSE<span class="token punctuation">,</span> <span class="token string">"Raft node receives higher term request_vote_response."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å¦‚æœå¯¹ç«¯å‡†è®¸äº†æŠ•ç¥¨è¯·æ±‚</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getGranted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Ballotï¼Œè·å¾—äº†å¯¹ç«¯çš„ä¸€ç¥¨</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>voteCtx<span class="token punctuation">.</span><span class="token function">grant</span><span class="token punctuation">(</span>peerId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å¦‚æœè¾¾åˆ°äº†åˆæ³•äººæ•°</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>voteCtx<span class="token punctuation">.</span><span class="token function">isGranted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// é‚£å°±å¯ä»¥æˆä¸ºLeaderäº†</span>
                    <span class="token function">becomeLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>Candidateå˜æˆLeader</p>
<p>NodeImpl#becomeLeader</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">becomeLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//  ...</span>
        <span class="token comment" spellcheck="true">// å–æ¶ˆCandidateçš„æŠ•ç¥¨è®¡æ—¶å™¨ï¼Œå› ä¸ºå·²ç»å˜æˆLeaderäº†</span>
        <span class="token function">stopVoteTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å°†èŠ‚ç‚¹è‡ªèº«çš„çŠ¶æ€æ”¹ä¸ºLeader</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> State<span class="token punctuation">.</span>STATE_LEADER<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>leaderId <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>serverId<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ›´æ–°ReplicatorGroupçš„ä»»æœŸ</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>replicatorGroup<span class="token punctuation">.</span><span class="token function">resetTerm</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// éå†åŒè¾ˆèŠ‚ç‚¹</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> PeerId peer <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>conf<span class="token punctuation">.</span><span class="token function">listPeers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è·³è¿‡è‡ªèº«</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>peer<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>serverId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ä¸€ä¸ªFolloweråˆ†é…ä¸€ä¸ªReplicatorï¼Œç”¨äºå¹¶å‘å¤åˆ¶Logç»™ä¸åŒèŠ‚ç‚¹ï¼Œåˆ†é…å¤±è´¥ä¸é‡è¯•</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>replicatorGroup<span class="token punctuation">.</span><span class="token function">addReplicator</span><span class="token punctuation">(</span>peer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// æ ¹æ®Raftç®—æ³•ï¼Œæ–°Leaderä¸Šå°åï¼Œä¸Šä¸€ä¸ªä»»æœŸçš„æ—¥å¿—ä¸èƒ½ç›´æ¥æäº¤ï¼Œéœ€è¦é€šè¿‡æäº¤å½“å‰ä»»æœŸçš„æ—¥å¿—çš„æ–¹å¼é—´æ¥æäº¤</span>
        <span class="token comment" spellcheck="true">// è¿™é‡Œæ˜¯é€šè¿‡è®¾ç½®ä¸€ä¸ªPendingIndexä¸ºè‡ªå·±çš„LastLogIndexçš„åä¸€æ¡ç´¢å¼•çš„æ–¹å¼ï¼Œå³æœŸå¾…çš„ç´¢å¼•ï¼Œå°äºçš„è¯æ˜¯ä¸èƒ½æäº¤çš„</span>
        <span class="token comment" spellcheck="true">// æŸäº›è¯´æ³•æ˜¯æ–°Leaderåº”è¯¥æäº¤ä¸€ä¸ªç©ºç™½çš„æ—¥å¿—ï¼Œä½†æ˜¯JRaftæ²¡è¿™ä¹ˆåšï¼Œæˆ‘è§‰å¾—ä¹Ÿä¸è¦æäº¤ä»€ä¹ˆç©ºç™½æ—¥å¿—æœ€å¥½</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ballotBox<span class="token punctuation">.</span><span class="token function">resetPendingIndex</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logManager<span class="token punctuation">.</span><span class="token function">getLastLogIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// å¯åŠ¨é€€ä½è®¡æ—¶å™¨ï¼Œè¶…æ—¶æ²¡æ”¶åˆ°å¤§å¤šæ•°FollowerèŠ‚ç‚¹çš„å“åº”åˆ™è‡ªåŠ¨ä¸‹å°</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>stepDownTimer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ä¸ºFollowerèŠ‚ç‚¹åˆ†é…æ—¥å¿—å¤åˆ¶å™¨</p>
<p>ReplicatorGroupImpl#addReplicator</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">addReplicator</span><span class="token punctuation">(</span><span class="token keyword">final</span> PeerId peer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// å¦‚æœè¯¥PeerIdå·²å­˜åœ¨å¯¹åº”çš„ThreadId</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>replicatorMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>peer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ä»åˆ†é…å¤±è´¥é›†åˆç§»é™¤</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>failureReplicators<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>peer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è¯¥èŠ‚ç‚¹å·²åˆ†é…</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">final</span> ReplicatorOptions opts <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>commonOptions <span class="token operator">==</span> null <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">ReplicatorOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>commonOptions<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        opts<span class="token punctuation">.</span><span class="token function">setPeerId</span><span class="token punctuation">(</span>peer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å°è¯•ä¸ºè¯¥PeerIdå¯åŠ¨å¯¹åº”çš„ThreadIdï¼Œå¯åŠ¨å¿ƒè·³è®¡æ—¶å™¨ï¼Œå‘é€ä¸€ä¸ªProbeè¯·æ±‚ï¼Œç»“æŸé€‰ä¸¾</span>
        <span class="token keyword">final</span> ThreadId rid <span class="token operator">=</span> Replicator<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>opts<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>raftOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// åˆ†é…å¤±è´¥</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rid <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ·»åŠ åˆ°å¯åŠ¨å¤±è´¥çš„é›†åˆ</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>failureReplicators<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>peer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è¿”å›å¤±è´¥</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// è¿”å›æ·»åŠ æ˜¯å¦æˆåŠŸ</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>replicatorMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>peer<span class="token punctuation">,</span> rid<span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>å¯åŠ¨æ—¥å¿—å¤åˆ¶</p>
<p>Replicator#start</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> ThreadId <span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">final</span> ReplicatorOptions opts<span class="token punctuation">,</span> <span class="token keyword">final</span> RaftOptions raftOptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// å®ä¾‹åŒ–Replicatorï¼Œåˆå§‹åŒ–NextIndexä¸ºLastLogIndex+1</span>
        <span class="token keyword">final</span> Replicator r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Replicator</span><span class="token punctuation">(</span>opts<span class="token punctuation">,</span> raftOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å°è¯•è¿æ¥å¯¹ç«¯Peer</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>r<span class="token punctuation">.</span>rpcService<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span><span class="token function">getPeerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Metricç›‘æ§ç›¸å…³</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// è¯¥Replicatorå¯¹åº”çš„ThreadIdï¼Œè¶…æ—¶çš„å›è°ƒä¸ºReplicatorï¼Œéå¸¸éšè”½</span>
        r<span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadId</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>id<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è§¦å‘äº‹ä»¶é€šçŸ¥ï¼Œå¦‚æœæœ‰ç›‘å¬å™¨çš„è¯</span>
        <span class="token function">notifyReplicatorStatusListener</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> ReplicatorEvent<span class="token punctuation">.</span>CREATED<span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>catchUpClosure <span class="token operator">=</span> null<span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>lastRpcSendTimestamp <span class="token operator">=</span> Utils<span class="token punctuation">.</span><span class="token function">monotonicMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¯åŠ¨å¿ƒè·³è®¡æ—¶å™¨ï¼Œè¶…æ—¶åˆ™æäº¤ç»™å›è°ƒçº¿ç¨‹æ± ï¼Œå‘é€å¿ƒè·³</span>
        r<span class="token punctuation">.</span><span class="token function">startHeartbeatTimer</span><span class="token punctuation">(</span>Utils<span class="token punctuation">.</span><span class="token function">nowMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ç»™å¯¹ç«¯å‘é€ç©ºçš„æ¡ç›®ï¼ŒProbeè¯·æ±‚</span>
        r<span class="token punctuation">.</span><span class="token function">sendEmptyEntries</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> r<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ä¸‹å°å€’è®¡æ—¶</p>
<p>NodeImpl#handleStepDownTimeout</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleStepDownTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å¤„äºCandidateæˆ–FollowerçŠ¶æ€çš„èŠ‚ç‚¹ä¸éœ€è¦é€€ä½</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>State<span class="token punctuation">.</span>STATE_TRANSFERRING<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> monotonicNowMs <span class="token operator">=</span> Utils<span class="token punctuation">.</span><span class="token function">monotonicMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// é€šè¿‡æ£€æŸ¥å¤§å¤šæ•°èŠ‚ç‚¹æ˜¯å¦æœ‰æ•ˆï¼Œåˆ¤æ–­å½“å‰Leaderæ˜¯å¦æœ‰æ•ˆï¼Œå¦‚æœæ— æ³•ç¡®å®šé‚£å°±å…ˆä¸‹å°</span>
            <span class="token function">checkDeadNodes</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>conf<span class="token punctuation">.</span><span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> monotonicNowMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>conf<span class="token punctuation">.</span><span class="token function">getOldConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">checkDeadNodes</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>conf<span class="token punctuation">.</span><span class="token function">getOldConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> monotonicNowMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>NodeImpl#checkDeadNodes</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">checkDeadNodes</span><span class="token punctuation">(</span><span class="token keyword">final</span> Configuration conf<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> monotonicNowMs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> List<span class="token operator">&lt;</span>PeerId<span class="token operator">></span> peers <span class="token operator">=</span> conf<span class="token punctuation">.</span><span class="token function">listPeers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> Configuration deadNodes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// é€šè¿‡å’ŒèŠ‚ç‚¹çš„æœ€åä¸€æ¬¡é€šè®¯æ—¶é—´æ˜¯å¦è¶…æ—¶ï¼Œåˆ¤æ–­å¤§å¤šæ•°èŠ‚ç‚¹æ˜¯å¦å­˜æ´»</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkDeadNodes0</span><span class="token punctuation">(</span>peers<span class="token punctuation">,</span> monotonicNowMs<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> deadNodes<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å¦‚æœå¤§å¤šæ•°èŠ‚ç‚¹ä»å­˜æ´»ï¼Œå¯ä»¥è®¤ä¸ºå½“å‰Leaderä»æ˜¯æœ‰æ•ˆçš„ï¼Œä¸éœ€è¦é€€ä½</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">final</span> Status status <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        status<span class="token punctuation">.</span><span class="token function">setError</span><span class="token punctuation">(</span>RaftError<span class="token punctuation">.</span>ERAFTTIMEDOUT<span class="token punctuation">,</span> <span class="token string">"Majority of the group dies: %d/%d"</span><span class="token punctuation">,</span> deadNodes<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> peers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ— æ³•ç¡®è®¤è‡ªå·±æ˜¯å¦ä»æ˜¯æœ‰æ•ˆçš„Leaderï¼Œè‡ªå·±å…ˆä¸‹å°å§</span>
        <span class="token function">stepDown</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">/*
         * å½“æ—¶ä¸­å¤®å·²ç»ç ”ç©¶å†³å®šäº†ï¼Œå°±ç”±æˆ‘æ¥å½“Leaderï¼Œæˆ‘è¯´å¦è¯·é«˜æ˜å§ï¼Œæˆ‘å®åœ¨ä¹Ÿä¸æ˜¯è°¦è™šï¼Œæˆ‘ä¸€ä¸ªFolloweræ€ä¹ˆå°±æˆäº†Candidateäº†å‘¢
         * ä½†æ˜¯ï¼ŒLeaderåŒå¿—è®²ï¼Œâ€œå¤§å®¶å·²ç»ç ”ç©¶å†³å®šäº†â€
         * åæ¥æˆ‘å°±å¿µäº†ä¸¤å¥æ—åˆ™å¾çš„ã€Šèµ´æˆç™»ç¨‹å£å ç¤ºå®¶äººäºŒé¦–ã€‹ï¼Œâ€œè‹Ÿåˆ©å›½å®¶ç”Ÿæ­»ä»¥ï¼Œå²‚å› ç¥¸ç¦é¿è¶‹ä¹‹â€ï¼Œæ‰€ä»¥æˆ‘å°±æˆäº†Leader
         */</span>
    <span class="token punctuation">}</span></code></pre>
<p>NodeImpl#checkDeadNodes0</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">checkDeadNodes0</span><span class="token punctuation">(</span><span class="token keyword">final</span> List<span class="token operator">&lt;</span>PeerId<span class="token operator">></span> peers<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> monotonicNowMs<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> checkReplicator<span class="token punctuation">,</span> <span class="token keyword">final</span> Configuration deadNodes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Leaderçš„ç§Ÿçº¦è¶…æ—¶</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> leaderLeaseTimeoutMs <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getLeaderLeaseTimeoutMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> aliveCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> startLease <span class="token operator">=</span> Long<span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// éå†èŠ‚ç‚¹</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> PeerId peer <span class="token operator">:</span> peers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è·³è¿‡è‡ªèº«</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>peer<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>serverId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                aliveCount<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>checkReplicator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å¦‚æœå½“å‰èŠ‚ç‚¹çš„çŠ¶æ€æ˜¯Leaderï¼Œæ£€æŸ¥ä¹‹å‰æ˜¯ä¸æ˜¯ä¸ºè¯¥èŠ‚ç‚¹åˆ†é…Replicatorå¤±è´¥ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™å†æ¬¡å°è¯•åˆ†é…ä¸€æ¬¡Replicator</span>
                <span class="token function">checkReplicator</span><span class="token punctuation">(</span>peer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// è¯¥èŠ‚ç‚¹ä¸Šæ¬¡é€šè®¯æ—¶é—´</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> lastRpcSendTimestamp <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>replicatorGroup<span class="token punctuation">.</span><span class="token function">getLastRpcSendTimestamp</span><span class="token punctuation">(</span>peer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ²¡æœ‰è¶…è¿‡Leaderçš„ç§Ÿçº¦è¶…æ—¶</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>monotonicNowMs <span class="token operator">-</span> lastRpcSendTimestamp <span class="token operator">&lt;=</span> leaderLeaseTimeoutMs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å¯ä»¥è®¤ä¸ºè¯¥èŠ‚ç‚¹æ˜¯å­˜æ´»çš„</span>
                aliveCount<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>startLease <span class="token operator">></span> lastRpcSendTimestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// æ‰€æœ‰èŠ‚ç‚¹ä¸­æœ€åé€šè®¯çš„æ—¶é—´</span>
                    startLease <span class="token operator">=</span> lastRpcSendTimestamp<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// è·³è¿‡è¯¥èŠ‚ç‚¹</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>deadNodes <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å¦åˆ™è®¤ä¸ºèŠ‚ç‚¹å·²æ­»äº¡</span>
                deadNodes<span class="token punctuation">.</span><span class="token function">addPeer</span><span class="token punctuation">(</span>peer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// éå†æ£€æŸ¥ç»“æŸ</span>
        <span class="token comment" spellcheck="true">// å­˜æ´»çš„èŠ‚ç‚¹æ•°å¤§äºèŠ‚ç‚¹æ€»æ•°ï¼Œè®¤ä¸ºæ˜¯æœ‰æ•ˆçš„</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>aliveCount <span class="token operator">>=</span> peers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ›´æ–°è‡ªå·±ä½œä¸ºLeaderçš„æœ€æ–°æ—¶é—´</span>
            <span class="token function">updateLastLeaderTimestamp</span><span class="token punctuation">(</span>startLease<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è‡ªå·±å½“å‰Leaderä»æœ‰æ•ˆ</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Leaderå·²æ— æ•ˆ</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>æŠ•ç¥¨è¶…æ—¶å¤„ç†</p>
<p>NodeImpl#handleVoteTimeout</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleVoteTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¦‚æœå½“å‰èŠ‚ç‚¹ä»å¤„äºCandidateçŠ¶æ€ï¼Œè¯´æ˜Leaderä»ç„¶æœªçŸ¥</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">==</span> State<span class="token punctuation">.</span>STATE_CANDIDATE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å†æ¬¡å°è¯•é€‰ä¸¾è‡ªå·±</span>
            <span class="token function">electSelf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å†™é”ä¼šåœ¨å®Œæˆåé‡Šæ”¾</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


        <footer>
             
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

        </footer>
    </div>
    <!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
    <script>
        var timeEnd = new Date();
        console.log('è€—æ—¶ï¼š' + (timeEnd - timeStart));
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre').forEach((block) => {
                block.classList.add("line-numbers");
            });
        });
    </script>
    <!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
    <!-- material design -->
    <!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
    <!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
    <!-- toc -->
    <!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
    <!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
    <!-- <script src="/js/main.js"></script> -->
    <script src="/js/prism.js"></script>
</body>
</html>
