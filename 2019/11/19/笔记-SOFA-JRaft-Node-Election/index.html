<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
        <script>
            var timeStart = new Date();
        </script>
        
        <title>[笔记]-SOFA-JRaft-Node-Election | 学而时习之</title>
        
        <meta name="author" content="Huangzhike">
        
        
        <meta name="description" content="K.I.S.S">
        
        
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        
        <meta property="og:title" content="[笔记]-SOFA-JRaft-Node-Election"/>
        
        <meta property="og:site_name" content="学而时习之"/>
        
        
        <!-- favicon -->
        <link rel="icon" type="image/ico" href="/ok.ico" sizes="32x32">
        <meta name="msapplication-TileColor" content="#009688">
        <meta name="msapplication-TileImage" content="/mstile-144x144.ico">
        <meta name="theme-color" content="#009688">
        <!-- favicon end -->
        <!-- <link href="//ok.ico" rel="icon"> -->
        
        <!-- toc -->
        <!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
        <!-- material design -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
        <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
        
        <!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
        <!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
    <meta name="generator" content="Hexo 4.2.1"></head>

<body>
    <nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">菜单</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" href="/">学而时习之</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" target="_blank" rel="noopener" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

    <div class="container" >
        <div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[笔记]-SOFA-JRaft-Node-Election</h2>
				
				<div>
					<div class="post-time">2019-11-19</div>
				</div>
				
				<div class="article-content">
				<p>JRaft版本：1.2.6</p>
<p>在注释里面有时会发现类似<code>we is ...</code>之类的错误，不吐槽了，意思对就好。</p>
<hr>
<p>节点初始化</p>
<p>NodeImpl#init</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">final</span> NodeOptions opts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//  ...</span>
        <span class="token comment" spellcheck="true">// 投票定时器，HashedWheelTimer</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>voteTimer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RepeatedTimer</span><span class="token punctuation">(</span><span class="token string">"JRaft-VoteTimer"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getElectionTimeoutMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onTrigger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 处理投票后超时，投票结果确定后所有节点的状态应该为Leader或Follower，如果仍为Candidate，则是未决</span>
                <span class="token function">handleVoteTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">protected</span> <span class="token keyword">int</span> <span class="token function">adjustTimeout</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span> timeoutMs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token function">randomTimeout</span><span class="token punctuation">(</span>timeoutMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 选举定时器，HashedWheelTimer</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>electionTimer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RepeatedTimer</span><span class="token punctuation">(</span><span class="token string">"JRaft-ElectionTimer"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getElectionTimeoutMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onTrigger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 选举超时：Follower超时未收到Leader的心跳，则转为Candidate，尝试发起投票请求，要求成为Leader</span>
                <span class="token function">handleElectionTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">protected</span> <span class="token keyword">int</span> <span class="token function">adjustTimeout</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span> timeoutMs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 返回随机超时，否则Follower节点可能同时发出请求，然后瓜分选票，不断循环</span>
                <span class="token keyword">return</span> <span class="token function">randomTimeout</span><span class="token punctuation">(</span>timeoutMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 退位计时器，HashedWheelTimer，时间为ElectionTimeout/2</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>stepDownTimer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RepeatedTimer</span><span class="token punctuation">(</span><span class="token string">"JRaft-StepDownTimer"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getElectionTimeoutMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onTrigger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 下台倒计时：当前节点状态为Leader时，根据是否得到过半节点的响应确定当前Leader是否有效，不能确定那就先下台</span>
                <span class="token function">handleStepDownTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 快照定时器，HashedWheelTimer，默认一小时</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>snapshotTimer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RepeatedTimer</span><span class="token punctuation">(</span><span class="token string">"JRaft-SnapshotTimer"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getSnapshotIntervalSecs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onTrigger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 生成快照</span>
                <span class="token function">handleSnapshotTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 管理ConfigurationEntry列表和ConfigurationEntry的快照</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>configManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConfigurationManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Disruptor，MPSC模型，多生产者单消费者</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>applyDisruptor <span class="token operator">=</span> DisruptorBuilder<span class="token punctuation">.</span>&lt;LogEntryAndClosure<span class="token operator">></span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//</span>
                <span class="token punctuation">.</span><span class="token function">setRingBufferSize</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>raftOptions<span class="token punctuation">.</span><span class="token function">getDisruptorBufferSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 环形队列大小，RingBuffer是生产者和消费者之间的缓冲，存放事件</span>
                <span class="token punctuation">.</span><span class="token function">setEventFactory</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LogEntryAndClosureFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 事件工厂，用于创建事件，事件就是被消费的对象</span>
                <span class="token punctuation">.</span><span class="token function">setThreadFactory</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NamedThreadFactory</span><span class="token punctuation">(</span><span class="token string">"JRaft-NodeImpl-Disruptor-"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 生产者线程工厂</span>
                <span class="token punctuation">.</span><span class="token function">setProducerType</span><span class="token punctuation">(</span>ProducerType<span class="token punctuation">.</span>MULTI<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 多生产者模式</span>
                <span class="token punctuation">.</span><span class="token function">setWaitStrategy</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BlockingWaitStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//  消费者等待策略，阻塞</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 事件处理器，即消费者，处理发布的Log</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>applyDisruptor<span class="token punctuation">.</span><span class="token function">handleEventsWith</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LogEntryAndClosureHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 异常处理器</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>applyDisruptor<span class="token punctuation">.</span><span class="token function">setDefaultExceptionHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LogExceptionHandler</span><span class="token operator">&lt;</span>Object<span class="token operator">></span><span class="token punctuation">(</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 启动Disruptor，返回RingBuffer</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>applyQueue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>applyDisruptor<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// 状态机Caller</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fsmCaller <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FSMCallerImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 实例化并初始化LogManager，默认存储实现是RocksDB，尝试从本地加载LogEntry</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">initLogStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 实例化并初始化RaftMetaStorage，尝试从本地文件加载CurrTerm和VotedId</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">initMetaStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 初始化FSMCaller，初始的Log的Index和Term都是0</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">initFSMCaller</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LogId</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 投票箱</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ballotBox <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BallotBox</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// 初始化投票箱</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>ballotBox<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>ballotBoxOpts<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 初始化SnapshotStorage，尝试从本地文件加载Snapshot的元数据</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">initSnapshotStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 检查日志一致性</span>
        <span class="token keyword">final</span> Status st <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>logManager<span class="token punctuation">.</span><span class="token function">checkConsistency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// ConfigurationEntry</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>conf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConfigurationEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>conf<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LogId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 如果本地LogStorage有有效的LastLogIndex</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logManager<span class="token punctuation">.</span><span class="token function">getLastLogIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 使用有效的ConfigurationEntry</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>conf <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>logManager<span class="token punctuation">.</span><span class="token function">checkAndSetConfiguration</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ConfigurationEntry使用启动时配置的Configuration</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>conf<span class="token punctuation">.</span><span class="token function">setConf</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getInitialConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>replicatorGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReplicatorGroupImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// RPC客户端服务</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>rpcService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BoltRaftClientService</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>replicatorGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// 初始化RPC服务</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>rpcService<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 初始化ReplicatorGroup</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>replicatorGroup<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NodeId</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>groupId<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>serverId<span class="token punctuation">)</span><span class="token punctuation">,</span> rgOpts<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 一致性读</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>readOnlyService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReadOnlyServiceImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">//</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>readOnlyService<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>rosOpts<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 初始状态下所有节点都是Follower</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> State<span class="token punctuation">.</span>STATE_FOLLOWER<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>snapshotExecutor <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getSnapshotIntervalSecs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 启动Snapshot计时器</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>snapshotTimer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 如果Configuration的PeerId列表不为空</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>conf<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 先下台，更新任期，启动选举计时器</span>
            <span class="token function">stepDown</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 将当前节点Node加入</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>NodeManager<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Node已启动，获取写锁，避免竞争</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 如果Group内只有一个Server节点并且就是当前节点，那么当前节点一定是Leader</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>conf<span class="token punctuation">.</span><span class="token function">isStable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>conf<span class="token punctuation">.</span><span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>conf<span class="token punctuation">.</span><span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>serverId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 触发VoteTimer，成为Leader</span>
            <span class="token function">electSelf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>触发选举超时</p>
<p>NodeImpl#handleElectionTimeout</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleElectionTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> doUnlock <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 只有节点处于Follower状态才有Leader超时</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">!=</span> State<span class="token punctuation">.</span>STATE_FOLLOWER<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 超时没收到Leader心跳，选举超时，才能继续</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isCurrentLeaderValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 认为Leader已死，重置LeaderId</span>
            <span class="token function">resetLeaderId</span><span class="token punctuation">(</span>PeerId<span class="token punctuation">.</span><span class="token function">emptyPeer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Status</span><span class="token punctuation">(</span>RaftError<span class="token punctuation">.</span>ERAFTTIMEDOUT<span class="token punctuation">,</span> <span class="token string">"Lost connection from leader %s."</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>leaderId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            doUnlock <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 发起预投票，达标后会发起正式投票</span>
            <span class="token function">preVote</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>doUnlock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>NodeImpl#resetLeaderId</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">resetLeaderId</span><span class="token punctuation">(</span><span class="token keyword">final</span> PeerId newLeaderId<span class="token punctuation">,</span> <span class="token keyword">final</span> Status status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 如果是用空的PeerId重置</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>newLeaderId<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 原本已经存在Leader &amp;&amp; 当前节点不是Leader</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>leaderId<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>State<span class="token punctuation">.</span>STATE_TRANSFERRING<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 发布停止跟随原本Leader的事件到RingBuffer，具体回调内容由状态机实现决定，默认啥也不干</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>fsmCaller<span class="token punctuation">.</span><span class="token function">onStopFollowing</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LeaderChangeContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>leaderId<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 置空</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>leaderId <span class="token operator">=</span> PeerId<span class="token punctuation">.</span><span class="token function">emptyPeer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 如果是用新的PeerId重置</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 如果当前不存在Leader</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>leaderId <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>leaderId<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 发布开始跟随新Leader的事件到RingBuffer，具体回调内容由状态机实现决定，默认啥也不干</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>fsmCaller<span class="token punctuation">.</span><span class="token function">onStartFollowing</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LeaderChangeContext</span><span class="token punctuation">(</span>newLeaderId<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 更新Leader</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>leaderId <span class="token operator">=</span> newLeaderId<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>预投票：</p>
<p>假如有某个Follower节点因为网络分区收不到Leader节点的心跳，那么它就会自动试图竞选为Leader，但因为别的Follower节点和Leader通信正常，所以一直无法当选，然后不断发起选举。</p>
<p>而选举请求会一直抬高全局节点的任期Term，最终使原本正常的Leader节点StepDown退位为Follower。</p>
<p>为了避免这种情况，候选者在发起投票之前，要先发起预投票，如果没有得到半数以上节点的承认，则不能正式发起选举。</p>
<p>上面的情况是对称网络分区的，还有一种情况是非对称网络分区。</p>
<p>假如有三个节点A，B，C，分别为Leader，Follower，Follower，假设某个时刻LeaderA和FollowerB之间出现了网络分区，而其它连接正常。</p>
<p>B会因为超时收不到LeaderA的心跳而自动转为候选人，发起预投票和正式投票，假设通过并成为了Leader（B和C两票），这样全局任期就会上升，然后原LeaderA自动退位为Follower。</p>
<p>显然因为分区的原因，A也会收不到LeaderB的心跳，然后试图发起选举，如此反复。</p>
<p>根据JRaft官方文档，这种情况的处理方式是在选举超时后，Follower才接受预投票请求，NodeImpl#handlePreVoteRequest。</p>
<p>应该是让C成为Leader才是最好的？</p>
<p>发起预投票</p>
<p>NodeImpl#preVote</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">preVote</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> oldTerm<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 安装Snapshot的时候不能预选举，因为配置可能已过时</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>snapshotExecutor <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>snapshotExecutor<span class="token punctuation">.</span><span class="token function">isInstallingSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 没加入配置的节点不能发起预选举</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>conf<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>serverId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 保存当前任期</span>
            oldTerm <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 获取最后一条Log</span>
        <span class="token keyword">final</span> LogId lastLogId <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>logManager<span class="token punctuation">.</span><span class="token function">getLastLogId</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> doUnlock <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 再次获取写锁</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 再次获取写锁期间任期发生了变化，不继续</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>oldTerm <span class="token operator">!=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 初始化Ballot，投票箱，代表这次投票</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>prevVoteCtx<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>conf<span class="token punctuation">.</span><span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>conf<span class="token punctuation">.</span><span class="token function">isStable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> null <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>conf<span class="token punctuation">.</span><span class="token function">getOldConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 遍历同辈节点</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> PeerId peer <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>conf<span class="token punctuation">.</span><span class="token function">listPeers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 跳过自身</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>peer<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>serverId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 如果已经连接则返回true，否则发送PingRequest同步请求，连接并发送成功后返回结果，跳过无法连接的同辈节点</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>rpcService<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>peer<span class="token punctuation">.</span><span class="token function">getEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 预选举请求响应的回调</span>
                <span class="token keyword">final</span> OnPreVoteRpcDone done <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OnPreVoteRpcDone</span><span class="token punctuation">(</span>peer<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 创建预选举请求，Protobuf</span>
                done<span class="token punctuation">.</span>request <span class="token operator">=</span> RequestVoteRequest<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//</span>
                        <span class="token punctuation">.</span><span class="token function">setPreVote</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 标明是个预选举请求</span>
                        <span class="token punctuation">.</span><span class="token function">setGroupId</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>groupId<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//</span>
                        <span class="token punctuation">.</span><span class="token function">setServerId</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>serverId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//</span>
                        <span class="token punctuation">.</span><span class="token function">setPeerId</span><span class="token punctuation">(</span>peer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//</span>
                        <span class="token punctuation">.</span><span class="token function">setTerm</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currTerm <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 表示竞选下一个任期，预选只是请求的任期加一，本地的任期不变，正式选举时本地任期才加一</span>
                        <span class="token punctuation">.</span><span class="token function">setLastLogIndex</span><span class="token punctuation">(</span>lastLogId<span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 最后一条Log的索引</span>
                        <span class="token punctuation">.</span><span class="token function">setLastLogTerm</span><span class="token punctuation">(</span>lastLogId<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 最后一条Log所属的任期</span>
                        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 向该同辈节点发送预选举异步请求，收到响应后执行回调</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>rpcService<span class="token punctuation">.</span><span class="token function">preVote</span><span class="token punctuation">(</span>peer<span class="token punctuation">.</span><span class="token function">getEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> done<span class="token punctuation">.</span>request<span class="token punctuation">,</span> done<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// Ballot，自己的一票也要算上</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>prevVoteCtx<span class="token punctuation">.</span><span class="token function">grant</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>serverId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 只有获取半数以上的预选</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>prevVoteCtx<span class="token punctuation">.</span><span class="token function">isGranted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                doUnlock <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 才能正式选举自己</span>
                <span class="token function">electSelf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>doUnlock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>对端节点收到并处理预投票请求</p>
<p>NodeImpl#handlePreVoteRequest</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> Message <span class="token function">handlePreVoteRequest</span><span class="token punctuation">(</span><span class="token keyword">final</span> RequestVoteRequest request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> doUnlock <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 当前节点未激活，不处理预投票请求</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">isActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">final</span> PeerId candidateId <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PeerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 解析候选人节点的Id为PeerId，其实预选举对端应该还是Follower</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>candidateId<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getServerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 默认不允许对端的预投票请求</span>
            <span class="token keyword">boolean</span> granted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">do</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 当前节点已有Leader，并且未超过选举超时，则当前的Leader是有效的，不允许预投票</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>leaderId <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>leaderId<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isCurrentLeaderValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 对端竞选的任期小于节点所处的任期，即对端所处的任期比当前节点的任期小了2或以上，不允许预投票</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 可能是日志复制有问题，导致Follower任期落后太多</span>
                    <span class="token comment" spellcheck="true">// 如果当前节点是Leader，检查之前是不是为该节点分配Replicator失败，如果是，则再次尝试分配一次Replicator</span>
                    <span class="token comment" spellcheck="true">// Replicator是节点成为Leader时给其他节点分配的，因为只尝试一次，所以可能失败</span>
                    <span class="token function">checkReplicator</span><span class="token punctuation">(</span>candidateId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 对端所处的任期和当前节点的任期一致，但是还是发起了预投票，可能也是网络或者心跳有问题？</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currTerm <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">checkReplicator</span><span class="token punctuation">(</span>candidateId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 也就是说，即使对端的任期比自己的任期小一，仍然会比较LogId，但是这种情况即使返回准许投票，对端收到响应后判断任期比自己大，投票还是会无效，所以比较LogId的意义是？</span>
                doUnlock <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 获取本地最后一条Log的LogId，包含Log的任期和索引</span>
                <span class="token keyword">final</span> LogId lastLogId <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>logManager<span class="token punctuation">.</span><span class="token function">getLastLogId</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                doUnlock <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 发出预投票请求的节点的最后一条Log的LogId，包含Log的任期和索引</span>
                <span class="token keyword">final</span> LogId requestLastLogId <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LogId</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getLastLogIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getLastLogTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 如果对端的最后一个LogId比自己的大，那么认为对方的Log比自己的要完整和更新，准许对端成为Leader</span>
                <span class="token comment" spellcheck="true">// 先比较任期Term，再比较索引Index</span>
                granted <span class="token operator">=</span> requestLastLogId<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>lastLogId<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> RequestVoteResponse<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//</span>
                    <span class="token punctuation">.</span><span class="token function">setTerm</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 当前节点所处的任期</span>
                    <span class="token punctuation">.</span><span class="token function">setGranted</span><span class="token punctuation">(</span>granted<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 是否准许预投票</span>
                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 生成响应</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>doUnlock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>回调处理预投票请求的响应</p>
<p>NodeImpl#handlePreVoteResponse</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handlePreVoteResponse</span><span class="token punctuation">(</span><span class="token keyword">final</span> PeerId peerId<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> term<span class="token punctuation">,</span> <span class="token keyword">final</span> RequestVoteResponse response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> doUnlock <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 节点仍处于Follower状态时才处理预投票请求的响应，因为Candidate和Leader不发出预投票请求</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">!=</span> State<span class="token punctuation">.</span>STATE_FOLLOWER<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 发出预选举请求后到收到响应的这段时间内，节点的任期发生了变化，则响应无效</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>term <span class="token operator">!=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 响应预投票请求的对端节点的任期大于当前节点的任期，则投票被拒绝</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 总之当前节点先退位为Follower，并同步任期，启动选举计时器</span>
                <span class="token function">stepDown</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Status</span><span class="token punctuation">(</span>RaftError<span class="token punctuation">.</span>EHIGHERTERMRESPONSE<span class="token punctuation">,</span> <span class="token string">"Raft node receives higher term pre_vote_response."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 如果对端准许了预投票请求</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getGranted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Ballot，如果获得了对端的一票</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>prevVoteCtx<span class="token punctuation">.</span><span class="token function">grant</span><span class="token punctuation">(</span>peerId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 如果达到了合法人数</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>prevVoteCtx<span class="token punctuation">.</span><span class="token function">isGranted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 暂时不释放写锁，大概是避免再次获取锁时失败，读写锁默认是公平锁还是非公平？忘了</span>
                    doUnlock <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// 可以开始正式投票给自己了</span>
                    <span class="token function">electSelf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>doUnlock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>NodeImpl#stepDown</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">stepDown</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">long</span> term<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> wakeupCandidate<span class="token punctuation">,</span> <span class="token keyword">final</span> Status status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 非激活状态的节点</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">isActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 如果当前节点状态为Candidate</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">==</span> State<span class="token punctuation">.</span>STATE_CANDIDATE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 取消候选人的投票超时计时器</span>
            <span class="token function">stopVoteTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 如果当前节点状态为Leader或转移领导权中</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>State<span class="token punctuation">.</span>STATE_TRANSFERRING<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 取消退位计时器</span>
            <span class="token function">stopStepDownTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>ballotBox<span class="token punctuation">.</span><span class="token function">clearPendingTasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">==</span> State<span class="token punctuation">.</span>STATE_LEADER<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 发布Leader下台事件到状态机的RingBuffer，具体处理由状态机的实现决定</span>
                <span class="token function">onLeaderStop</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 重置LeaderId为空</span>
        <span class="token function">resetLeaderId</span><span class="token punctuation">(</span>PeerId<span class="token punctuation">.</span><span class="token function">emptyPeer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 重置状态为Follower</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> State<span class="token punctuation">.</span>STATE_FOLLOWER<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>confCtx<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">updateLastLeaderTimestamp</span><span class="token punctuation">(</span>Utils<span class="token punctuation">.</span><span class="token function">monotonicMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>snapshotExecutor <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 取消Snapshot下载</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>snapshotExecutor<span class="token punctuation">.</span><span class="token function">interruptDownloadingSnapshots</span><span class="token punctuation">(</span>term<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>term <span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 更新任期，取大的</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>currTerm <span class="token operator">=</span> term<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>votedId <span class="token operator">=</span> PeerId<span class="token punctuation">.</span><span class="token function">emptyPeer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>metaStorage<span class="token punctuation">.</span><span class="token function">setTermAndVotedFor</span><span class="token punctuation">(</span>term<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>votedId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>wakeupCandidate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 取消所有Replicator</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>replicatorGroup<span class="token punctuation">.</span><span class="token function">stopAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>stopTransferArg <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 启动选举计时器</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>electionTimer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>正式发起投票</p>
<p>NodeImpl#electSelf</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">electSelf</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> oldTerm<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 不在配置中的节点不能选举自己</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>conf<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>serverId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 如果当前节点的状态是Follower，先停止选举计时器</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">==</span> State<span class="token punctuation">.</span>STATE_FOLLOWER<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>electionTimer<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 重置LeaderId</span>
            <span class="token function">resetLeaderId</span><span class="token punctuation">(</span>PeerId<span class="token punctuation">.</span><span class="token function">emptyPeer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Status</span><span class="token punctuation">(</span>RaftError<span class="token punctuation">.</span>ERAFTTIMEDOUT<span class="token punctuation">,</span> <span class="token string">"A follower's leader_id is reset to NULL as it begins to request_vote."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 切换节点的状态为Candidate</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> State<span class="token punctuation">.</span>STATE_CANDIDATE<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 本地任期自增</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 要求投给自己</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>votedId <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>serverId<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 启动投票计时器</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>voteTimer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 初始化Ballot投票箱</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>voteCtx<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>conf<span class="token punctuation">.</span><span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>conf<span class="token punctuation">.</span><span class="token function">isStable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> null <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>conf<span class="token punctuation">.</span><span class="token function">getOldConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 暂存投票前的任期</span>
            oldTerm <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 获取本地最后一条Log</span>
        <span class="token keyword">final</span> LogId lastLogId <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>logManager<span class="token punctuation">.</span><span class="token function">getLastLogId</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 获取写锁</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 再次获取写锁期间本地任期发生了变化，不再继续</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>oldTerm <span class="token operator">!=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 遍历同辈节点</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> PeerId peer <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>conf<span class="token punctuation">.</span><span class="token function">listPeers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 跳过自身</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>peer<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>serverId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 如果已经连接则返回true，否则发送PingRequest同步请求，连接并发送成功后返回结果，跳过无法连接的同辈节点</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>rpcService<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>peer<span class="token punctuation">.</span><span class="token function">getEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 选举请求的回调</span>
                <span class="token keyword">final</span> OnRequestVoteRpcDone done <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OnRequestVoteRpcDone</span><span class="token punctuation">(</span>peer<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 创建选举请求</span>
                done<span class="token punctuation">.</span>request <span class="token operator">=</span> RequestVoteRequest<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//</span>
                        <span class="token punctuation">.</span><span class="token function">setPreVote</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 标明是个正式选举请求</span>
                        <span class="token punctuation">.</span><span class="token function">setGroupId</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>groupId<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//</span>
                        <span class="token punctuation">.</span><span class="token function">setServerId</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>serverId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//</span>
                        <span class="token punctuation">.</span><span class="token function">setPeerId</span><span class="token punctuation">(</span>peer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//</span>
                        <span class="token punctuation">.</span><span class="token function">setTerm</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 竞选的任期，已自增</span>
                        <span class="token punctuation">.</span><span class="token function">setLastLogIndex</span><span class="token punctuation">(</span>lastLogId<span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//</span>
                        <span class="token punctuation">.</span><span class="token function">setLastLogTerm</span><span class="token punctuation">(</span>lastLogId<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//</span>
                        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 向同辈节点发送选举异步请求，收到响应后执行回调</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>rpcService<span class="token punctuation">.</span><span class="token function">requestVote</span><span class="token punctuation">(</span>peer<span class="token punctuation">.</span><span class="token function">getEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> done<span class="token punctuation">.</span>request<span class="token punctuation">,</span> done<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>metaStorage<span class="token punctuation">.</span><span class="token function">setTermAndVotedFor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>serverId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 自己也要投给自己一票</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>voteCtx<span class="token punctuation">.</span><span class="token function">grant</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>serverId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 只有获取半数以上的选票</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>voteCtx<span class="token punctuation">.</span><span class="token function">isGranted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 才能成为Leader</span>
                <span class="token function">becomeLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>对端节点收到并处理正式投票请求</p>
<p>NodeImpl#handleRequestVoteRequest</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> Message <span class="token function">handleRequestVoteRequest</span><span class="token punctuation">(</span><span class="token keyword">final</span> RequestVoteRequest request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> doUnlock <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 节点必须激活才能处理正式投票请求</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">isActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> RpcResponseFactory<span class="token punctuation">.</span><span class="token function">newResponse</span><span class="token punctuation">(</span>RaftError<span class="token punctuation">.</span>EINVAL<span class="token punctuation">,</span> <span class="token string">"Node %s is not in active state, state %s."</span><span class="token punctuation">,</span> <span class="token function">getNodeId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 发起正式投票请求的候选人Id</span>
            <span class="token keyword">final</span> PeerId candidateId <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PeerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 解析候选人的Id为PeerId</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>candidateId<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getServerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> RpcResponseFactory<span class="token punctuation">.</span><span class="token function">newResponse</span><span class="token punctuation">(</span>RaftError<span class="token punctuation">.</span>EINVAL<span class="token punctuation">,</span> <span class="token string">"Parse candidateId failed: %s."</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getServerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 成为Leader的要求：该节点保存的Log最新最完整</span>
            <span class="token keyword">do</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 先比较任期</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 如果对方正式竞选的任期大于自己当前的任期，那么需要更新自己的任期，这样全局节点的任期也会更新</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 退位为Follower，同步任期，启动选举计时器</span>
                        <span class="token function">stepDown</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Status</span><span class="token punctuation">(</span>RaftError<span class="token punctuation">.</span>EHIGHERTERMRESPONSE<span class="token punctuation">,</span> <span class="token string">"Raft node receives higher term RequestVoteRequest."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 如果请求竞选的任期要比自己当前任期小，说明日志比自己残缺，不能投票给它</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                doUnlock <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 获取本地最后一条Log的LogId</span>
                <span class="token keyword">final</span> LogId lastLogId <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>logManager<span class="token punctuation">.</span><span class="token function">getLastLogId</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                doUnlock <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// vote need ABA check after unlock&amp;writeLock</span>
                <span class="token comment" spellcheck="true">// 释放写锁后任期发生了变化，不能继续</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// Log由Leader同步过来，LogIndex单调递增，如果对端的最后一条Log所属的Term或Index比自己的小，说明日志比自身残缺，不能投票给它</span>
                <span class="token keyword">final</span> <span class="token keyword">boolean</span> logIsOk <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LogId</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getLastLogIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getLastLogTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>lastLogId<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 可能收到多个节点的投票请求，但是票只有一个</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>logIsOk <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>votedId <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>votedId<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 更新自己的任期</span>
                    <span class="token function">stepDown</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Status</span><span class="token punctuation">(</span>RaftError<span class="token punctuation">.</span>EVOTEFORCANDIDATE<span class="token punctuation">,</span> <span class="token string">"Raft node votes for some candidate, step down to restart election_timer."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>votedId <span class="token operator">=</span> candidateId<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>metaStorage<span class="token punctuation">.</span><span class="token function">setVotedFor</span><span class="token punctuation">(</span>candidateId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> RequestVoteResponse<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//</span>
                    <span class="token punctuation">.</span><span class="token function">setTerm</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//</span>
                    <span class="token punctuation">.</span><span class="token function">setGranted</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currTerm <span class="token operator">&amp;&amp;</span> candidateId<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>votedId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 是否同意该票</span>
                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>doUnlock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>Candidate节点回调处理正式投票请求的响应</p>
<p>NodeImpl#handleRequestVoteResponse</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleRequestVoteResponse</span><span class="token punctuation">(</span><span class="token keyword">final</span> PeerId peerId<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> term<span class="token punctuation">,</span> <span class="token keyword">final</span> RequestVoteResponse response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 只有节点处于Candidate状态时才能处理正式投票的响应</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">!=</span> State<span class="token punctuation">.</span>STATE_CANDIDATE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 发出投票请求后本地任期发生了变化，投票无效</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>term <span class="token operator">!=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 响应投票请求的对端节点的任期大于当前节点的任期，投票无效</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 当前节点先下台为Follower，更新任期，启动选举计时器</span>
                <span class="token function">stepDown</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Status</span><span class="token punctuation">(</span>RaftError<span class="token punctuation">.</span>EHIGHERTERMRESPONSE<span class="token punctuation">,</span> <span class="token string">"Raft node receives higher term request_vote_response."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 如果对端准许了投票请求</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getGranted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Ballot，获得了对端的一票</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>voteCtx<span class="token punctuation">.</span><span class="token function">grant</span><span class="token punctuation">(</span>peerId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 如果达到了合法人数</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>voteCtx<span class="token punctuation">.</span><span class="token function">isGranted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 那就可以成为Leader了</span>
                    <span class="token function">becomeLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>Candidate变成Leader</p>
<p>NodeImpl#becomeLeader</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">becomeLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//  ...</span>
        <span class="token comment" spellcheck="true">// 取消Candidate的投票计时器，因为已经变成Leader了</span>
        <span class="token function">stopVoteTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 将节点自身的状态改为Leader</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> State<span class="token punctuation">.</span>STATE_LEADER<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>leaderId <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>serverId<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 更新ReplicatorGroup的任期</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>replicatorGroup<span class="token punctuation">.</span><span class="token function">resetTerm</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 遍历同辈节点</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> PeerId peer <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>conf<span class="token punctuation">.</span><span class="token function">listPeers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 跳过自身</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>peer<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>serverId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 一个Follower分配一个Replicator，用于并发复制Log给不同节点，分配失败不重试</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>replicatorGroup<span class="token punctuation">.</span><span class="token function">addReplicator</span><span class="token punctuation">(</span>peer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 根据Raft算法，新Leader上台后，上一个任期的日志不能直接提交，需要通过提交当前任期的日志的方式间接提交</span>
        <span class="token comment" spellcheck="true">// 这里是通过设置一个PendingIndex为自己的LastLogIndex的后一条索引的方式，即期待的索引，小于的话是不能提交的</span>
        <span class="token comment" spellcheck="true">// 某些说法是新Leader应该提交一个空白的日志，但是JRaft没这么做，我觉得也不要提交什么空白日志最好</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>ballotBox<span class="token punctuation">.</span><span class="token function">resetPendingIndex</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logManager<span class="token punctuation">.</span><span class="token function">getLastLogIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// 启动退位计时器，超时没收到大多数Follower节点的响应则自动下台</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>stepDownTimer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>为Follower节点分配日志复制器</p>
<p>ReplicatorGroupImpl#addReplicator</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">addReplicator</span><span class="token punctuation">(</span><span class="token keyword">final</span> PeerId peer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// 如果该PeerId已存在对应的ThreadId</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>replicatorMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>peer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 从分配失败集合移除</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>failureReplicators<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>peer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 该节点已分配</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">final</span> ReplicatorOptions opts <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>commonOptions <span class="token operator">==</span> null <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">ReplicatorOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>commonOptions<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        opts<span class="token punctuation">.</span><span class="token function">setPeerId</span><span class="token punctuation">(</span>peer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 尝试为该PeerId启动对应的ThreadId，启动心跳计时器，发送一个Probe请求，结束选举</span>
        <span class="token keyword">final</span> ThreadId rid <span class="token operator">=</span> Replicator<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>opts<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>raftOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 分配失败</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rid <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 添加到启动失败的集合</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>failureReplicators<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>peer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 返回失败</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 返回添加是否成功</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>replicatorMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>peer<span class="token punctuation">,</span> rid<span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>启动日志复制</p>
<p>Replicator#start</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> ThreadId <span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">final</span> ReplicatorOptions opts<span class="token punctuation">,</span> <span class="token keyword">final</span> RaftOptions raftOptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// 实例化Replicator，初始化NextIndex为LastLogIndex+1</span>
        <span class="token keyword">final</span> Replicator r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Replicator</span><span class="token punctuation">(</span>opts<span class="token punctuation">,</span> raftOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 尝试连接对端Peer</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>r<span class="token punctuation">.</span>rpcService<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span><span class="token function">getPeerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Metric监控相关</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// 该Replicator对应的ThreadId，超时的回调为Replicator，非常隐蔽</span>
        r<span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadId</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>id<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 触发事件通知，如果有监听器的话</span>
        <span class="token function">notifyReplicatorStatusListener</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> ReplicatorEvent<span class="token punctuation">.</span>CREATED<span class="token punctuation">)</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>catchUpClosure <span class="token operator">=</span> null<span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>lastRpcSendTimestamp <span class="token operator">=</span> Utils<span class="token punctuation">.</span><span class="token function">monotonicMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 启动心跳计时器，超时则提交给回调线程池，发送心跳</span>
        r<span class="token punctuation">.</span><span class="token function">startHeartbeatTimer</span><span class="token punctuation">(</span>Utils<span class="token punctuation">.</span><span class="token function">nowMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 给对端发送空的条目，Probe请求</span>
        r<span class="token punctuation">.</span><span class="token function">sendEmptyEntries</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> r<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>下台倒计时</p>
<p>NodeImpl#handleStepDownTimeout</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleStepDownTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 处于Candidate或Follower状态的节点不需要退位</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>State<span class="token punctuation">.</span>STATE_TRANSFERRING<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> monotonicNowMs <span class="token operator">=</span> Utils<span class="token punctuation">.</span><span class="token function">monotonicMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 通过检查大多数节点是否有效，判断当前Leader是否有效，如果无法确定那就先下台</span>
            <span class="token function">checkDeadNodes</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>conf<span class="token punctuation">.</span><span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> monotonicNowMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>conf<span class="token punctuation">.</span><span class="token function">getOldConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">checkDeadNodes</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>conf<span class="token punctuation">.</span><span class="token function">getOldConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> monotonicNowMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>NodeImpl#checkDeadNodes</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">checkDeadNodes</span><span class="token punctuation">(</span><span class="token keyword">final</span> Configuration conf<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> monotonicNowMs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> List<span class="token operator">&lt;</span>PeerId<span class="token operator">></span> peers <span class="token operator">=</span> conf<span class="token punctuation">.</span><span class="token function">listPeers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> Configuration deadNodes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 通过和节点的最后一次通讯时间是否超时，判断大多数节点是否存活</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkDeadNodes0</span><span class="token punctuation">(</span>peers<span class="token punctuation">,</span> monotonicNowMs<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> deadNodes<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 如果大多数节点仍存活，可以认为当前Leader仍是有效的，不需要退位</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">final</span> Status status <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        status<span class="token punctuation">.</span><span class="token function">setError</span><span class="token punctuation">(</span>RaftError<span class="token punctuation">.</span>ERAFTTIMEDOUT<span class="token punctuation">,</span> <span class="token string">"Majority of the group dies: %d/%d"</span><span class="token punctuation">,</span> deadNodes<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> peers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 无法确认自己是否仍是有效的Leader，自己先下台吧</span>
        <span class="token function">stepDown</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">/*
         * 当时中央已经研究决定了，就由我来当Leader，我说另请高明吧，我实在也不是谦虚，我一个Follower怎么就成了Candidate了呢
         * 但是，Leader同志讲，“大家已经研究决定了”
         * 后来我就念了两句林则徐的《赴戍登程口占示家人二首》，“苟利国家生死以，岂因祸福避趋之”，所以我就成了Leader
         */</span>
    <span class="token punctuation">}</span></code></pre>
<p>NodeImpl#checkDeadNodes0</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">checkDeadNodes0</span><span class="token punctuation">(</span><span class="token keyword">final</span> List<span class="token operator">&lt;</span>PeerId<span class="token operator">></span> peers<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> monotonicNowMs<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> checkReplicator<span class="token punctuation">,</span> <span class="token keyword">final</span> Configuration deadNodes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Leader的租约超时</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> leaderLeaseTimeoutMs <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getLeaderLeaseTimeoutMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> aliveCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> startLease <span class="token operator">=</span> Long<span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 遍历节点</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> PeerId peer <span class="token operator">:</span> peers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 跳过自身</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>peer<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>serverId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                aliveCount<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>checkReplicator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 如果当前节点的状态是Leader，检查之前是不是为该节点分配Replicator失败，如果是，则再次尝试分配一次Replicator</span>
                <span class="token function">checkReplicator</span><span class="token punctuation">(</span>peer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 该节点上次通讯时间</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> lastRpcSendTimestamp <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>replicatorGroup<span class="token punctuation">.</span><span class="token function">getLastRpcSendTimestamp</span><span class="token punctuation">(</span>peer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 没有超过Leader的租约超时</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>monotonicNowMs <span class="token operator">-</span> lastRpcSendTimestamp <span class="token operator">&lt;=</span> leaderLeaseTimeoutMs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 可以认为该节点是存活的</span>
                aliveCount<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>startLease <span class="token operator">></span> lastRpcSendTimestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 所有节点中最后通讯的时间</span>
                    startLease <span class="token operator">=</span> lastRpcSendTimestamp<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 跳过该节点</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>deadNodes <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 否则认为节点已死亡</span>
                deadNodes<span class="token punctuation">.</span><span class="token function">addPeer</span><span class="token punctuation">(</span>peer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// 遍历检查结束</span>
        <span class="token comment" spellcheck="true">// 存活的节点数大于节点总数，认为是有效的</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>aliveCount <span class="token operator">>=</span> peers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 更新自己作为Leader的最新时间</span>
            <span class="token function">updateLastLeaderTimestamp</span><span class="token punctuation">(</span>startLease<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 自己当前Leader仍有效</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Leader已无效</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>投票超时处理</p>
<p>NodeImpl#handleVoteTimeout</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleVoteTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 如果当前节点仍处于Candidate状态，说明Leader仍然未知</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">==</span> State<span class="token punctuation">.</span>STATE_CANDIDATE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 再次尝试选举自己</span>
            <span class="token function">electSelf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 写锁会在完成后释放</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


        <footer>
             
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

        </footer>
    </div>
    <!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
    <script>
        var timeEnd = new Date();
        console.log('耗时：' + (timeEnd - timeStart));
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre').forEach((block) => {
                block.classList.add("line-numbers");
            });
        });
    </script>
    <!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
    <!-- material design -->
    <!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
    <!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
    <!-- toc -->
    <!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
    <!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
    <!-- <script src="/js/main.js"></script> -->
    <script src="/js/prism.js"></script>
</body>
</html>
