<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
        <script>
            var timeStart = new Date();
        </script>
        
        <title>[ç¬”è®°]-SOFA-JRaft-RheaKV | ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜</title>
        
        <meta name="author" content="huangzhike">
        
        
        <meta name="description" content="MultiRaftGroupï¼šå¤šä¸ªRaftGroupï¼Œå¯¹äºRheaKVï¼Œæ¯ä¸ªåˆ†ç»„ï¼ˆRegionï¼‰éƒ½æœ‰ä¸€ä¸ªç‹¬ç«‹çš„Leaderå’Œå¤šä¸ªFollowerã€‚
PlacementDriverï¼šç®¡ç†æ•´ä¸ªé›†ç¾¤ï¼Œç”ŸæˆRegionIdï¼Œæ ¹æ®Regionçš„å¿ƒè·³æ›´æ–°è·¯ç”±è¡¨ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨Fakeçš„å›ºå®šé…ç½®ã€‚
Storeï¼šReg">
        
        
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        
        <meta property="og:title" content="[ç¬”è®°]-SOFA-JRaft-RheaKV"/>
        
        <meta property="og:site_name" content="ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜"/>
        
        
        <!-- favicon -->
        <link rel="icon" type="image/ico" href="/ok.ico" sizes="32x32">
        <meta name="msapplication-TileColor" content="#009688">
        <meta name="msapplication-TileImage" content="/mstile-144x144.ico">
        <meta name="theme-color" content="#009688">
        <!-- favicon end -->
        <!-- <link href="//ok.ico" rel="icon"> -->
        
        <!-- toc -->
        <!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
        <!-- material design -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
        <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
        
        <!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
        <!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
    <meta name="generator" content="Hexo 4.2.1"></head>

<body>
    <nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">èœå•</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" title="ä¸‹ä¸€å¥æ˜¯ï¼šå®¢æœ‰å¯äººæœŸä¸æ¥ã€‚å°æ—¶å€™ï¼Œå–œæ¬¢é åœ¨é˜³å°ä¸Šï¼Œä¸€è¾¹å¹é£ï¼Œä¸€è¾¹çœ‹ä¹¦ï¼Œå–œæ¬¢è¯»ä¹¦å—ï¼Œéªšå¹´ï¼Ÿ" href="/">ä¹¦å½“å¿«æ„è¯»æ˜“å°½</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" target="_blank" rel="noopener" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

    <div class="container" >
        <div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[ç¬”è®°]-SOFA-JRaft-RheaKV</h2>
				
				<div>
					<div class="post-time">2019-11-19</div>
				</div>
				
				<div class="article-content">
				<p>MultiRaftGroupï¼šå¤šä¸ªRaftGroupï¼Œå¯¹äºRheaKVï¼Œæ¯ä¸ªåˆ†ç»„ï¼ˆRegionï¼‰éƒ½æœ‰ä¸€ä¸ªç‹¬ç«‹çš„Leaderå’Œå¤šä¸ªFollowerã€‚</p>
<p>PlacementDriverï¼šç®¡ç†æ•´ä¸ªé›†ç¾¤ï¼Œç”ŸæˆRegionIdï¼Œæ ¹æ®Regionçš„å¿ƒè·³æ›´æ–°è·¯ç”±è¡¨ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨Fakeçš„å›ºå®šé…ç½®ã€‚</p>
<p>Storeï¼šRegionçš„å®¹å™¨ï¼ŒåŒ…å«å¤šä¸ªåˆ†ç‰‡ï¼ŒStoreå‘PDä¸»åŠ¨ä¸ŠæŠ¥å¿ƒè·³ï¼ŒåŒ…å«è¯¥Storeçš„åŸºæœ¬ä¿¡æ¯ï¼Œå¦‚ï¼ŒåŒ…å«å¤šå°‘Regionï¼Œæœ‰å“ªäº›Regionçš„Leaderåœ¨è¯¥Storeç­‰ã€‚</p>
<p>Regionï¼šæ•°æ®å­˜å‚¨çš„å•å…ƒï¼Œä¹ŸåŒ…å«äº†ä¸€ä¸ªé€‰ä¸¾å•å…ƒï¼Œå¯¹åº”Storeé‡ŒæŸä¸ªæ•°æ®åŒºé—´ï¼Œæ¯ä¸ªRegionæœ‰å¤šä¸ªå‰¯æœ¬ï¼Œæ¯ä¸ªå‰¯æœ¬å­˜å‚¨åœ¨ä¸åŒçš„Storeï¼Œä¸€èµ·ç»„æˆä¸€ä¸ªRaftGroupã€‚Regionçš„Leaderä¼šå‘PDä¸»åŠ¨ä¸ŠæŠ¥å¿ƒè·³ï¼ŒPDé€šè¿‡Regionçš„Epochæ„ŸçŸ¥Regionæ˜¯å¦æœ‰å˜åŒ–ã€‚</p>
<p>æ•°æ®åˆ†åŒºæˆ–åˆ†ç‰‡ç®—æ³•é€šå¸¸æ˜¯Rangeå’ŒHashï¼ŒRheaKVé€šè¿‡Rangeè¿›è¡Œæ•°æ®åˆ†ç‰‡ï¼Œåˆ†æˆä¸€ä¸ªä¸ªRaftGroupï¼Œä¹Ÿç§°ä¸ºRegionã€‚</p>
<p>å› ä¸ºRangeåˆ‡åˆ†æ˜¯å¯¹Keyè¿›è¡Œå­—èŠ‚æ’åºåå†åˆ‡åˆ†ï¼Œåƒç±»ä¼¼Scanç­‰æ“ä½œå¯¹ç›¸è¿‘Keyçš„æŸ¥è¯¢ä¼šå°½å¯èƒ½é›†ä¸­åœ¨æŸä¸ªRegionï¼Œè¿™ä¸ªHashæ— æ³•æ”¯æŒã€‚</p>
<p>æ‹†åˆ†å•ä¸ªRegionä¹Ÿæ›´å¥½å¤„ç†ï¼Œåªç”¨ä¿®æ”¹éƒ¨åˆ†å…ƒæ•°æ®ï¼Œä¸ä¼šæ¶‰åŠåˆ°å¤§èŒƒå›´çš„æ•°æ®æŒªåŠ¨ã€‚</p>
<p>Rangeæœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œå¯èƒ½æŸä¸ªRegionè¢«é¢‘ç¹æ“ä½œæˆä¸ºçƒ­ç‚¹Regionï¼Œå¯ä»¥é€šè¿‡PDè°ƒåº¦çƒ­ç‚¹Regionåˆ°æ›´ç©ºé—²çš„æœºå™¨ä¸Šï¼Œæˆ–è€…æä¾›Followeråˆ†æ‹…è¯»çš„å‹åŠ›ç­‰ã€‚</p>
<hr>
<p>Clientå’ŒServerçš„åˆå§‹åŒ–</p>
<p>DefaultRheaKVStore#init</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">boolean</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">final</span> RheaKVStoreOptions opts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>opts <span class="token operator">=</span> opts<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// init placement driver</span>
        <span class="token keyword">final</span> PlacementDriverOptions pdOpts <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">getPlacementDriverOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> String clusterName <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">getClusterName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// æ ¹æ®PlacementDriverClienté€‰é¡¹å®ä¾‹åŒ–PlacementDriverClient</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pdOpts<span class="token punctuation">.</span><span class="token function">isFake</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>pdClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FakePlacementDriverClient</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span><span class="token function">getClusterId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> clusterName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ClusterIdï¼šPlacementDriverServeræ ¹æ®ClusterIdéš”ç¦»ä¸åŒçš„Clusterï¼ŒFakeæ¨¡å¼ä¸éœ€è¦</span>
            <span class="token comment" spellcheck="true">// ClusterNameï¼šæ¯ä¸ªStoreèŠ‚ç‚¹åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªRaftGroupï¼ŒRaftGroupæ ¹æ®ClusterName-RegionIdå‘½å</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>pdClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RemotePlacementDriverClient</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span><span class="token function">getClusterId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> clusterName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// åˆå§‹åŒ–PDClient</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>pdClient<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>pdOpts<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å­˜å‚¨å¼•æ“é€‰é¡¹ï¼Œä¸€èˆ¬æ˜¯ServerèŠ‚ç‚¹æ‰æœ‰é…ç½®</span>
        <span class="token keyword">final</span> StoreEngineOptions stOpts <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">getStoreEngineOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>stOpts <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ServerèŠ‚ç‚¹åœ°å€åˆ—è¡¨</span>
            stOpts<span class="token punctuation">.</span><span class="token function">setInitialServerList</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span><span class="token function">getInitialServerList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ ¹æ®å­˜å‚¨å¼•æ“é€‰é¡¹å®ä¾‹åŒ–å­˜å‚¨å¼•æ“å¹¶åˆå§‹åŒ–</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>storeEngine <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StoreEngine</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pdClient<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>stateListenerContainer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>storeEngine<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>stOpts<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å½“å‰å­˜å‚¨èŠ‚ç‚¹è‡ªèº«çš„IPå’Œç«¯å£å·</span>
        <span class="token keyword">final</span> Endpoint selfEndpoint <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>storeEngine <span class="token operator">==</span> null <span class="token operator">?</span> null <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>storeEngine<span class="token punctuation">.</span><span class="token function">getSelfEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> RpcOptions rpcOpts <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">getRpcOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// å®ä¾‹åŒ–RpcService</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>rheaKVRpcService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultRheaKVRpcService</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pdClient<span class="token punctuation">,</span> selfEndpoint<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// é‡å†™äº†getLeaderæ–¹æ³•</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> Endpoint <span class="token function">getLeader</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">long</span> regionId<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> forceRefresh<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> timeoutMillis<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å…ˆæ ¹æ®RegionIdæŸ¥æ‰¾Leader</span>
                <span class="token keyword">final</span> Endpoint leader <span class="token operator">=</span> <span class="token function">getLeaderByRegionEngine</span><span class="token punctuation">(</span>regionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>leader <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> leader<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// æ‰¾ä¸åˆ°å†è°ƒç”¨çˆ¶ç±»çš„æ–¹æ³•</span>
                <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getLeader</span><span class="token punctuation">(</span>regionId<span class="token punctuation">,</span> forceRefresh<span class="token punctuation">,</span> timeoutMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// åˆå§‹åŒ–RpcService</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>rheaKVRpcService<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>rpcOpts<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// é‡è¯•æ¬¡æ•°ï¼Œé»˜è®¤2</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>failoverRetries <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">getFailoverRetries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ç­‰å¾…è¶…æ—¶ï¼Œé»˜è®¤5000æ¯«ç§’</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>futureTimeoutMillis <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">getFutureTimeoutMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ˜¯å¦åªä»Leaderè¯»ï¼Œé»˜è®¤æ˜¯</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>onlyLeaderRead <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">isOnlyLeaderRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// é»˜è®¤ä½¿ç”¨å¹¶è¡Œå¤„ç†å™¨ï¼Œå¯ä»¥ç†è§£ä¸ºæäº¤ç»™çº¿ç¨‹æ± å¹¶å‘æ‰§è¡Œ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span><span class="token function">isUseParallelKVExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> numWorkers <span class="token operator">=</span> Utils<span class="token punctuation">.</span><span class="token function">cpus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å·¦ç§»4ä½ï¼Œç­‰äºä¹˜ä»¥2^4</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> bufSize <span class="token operator">=</span> numWorkers <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> String name <span class="token operator">=</span> <span class="token string">"parallel-kv-executor"</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> ThreadFactory threadFactory <span class="token operator">=</span> Constants<span class="token punctuation">.</span>THREAD_AFFINITY_ENABLED <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">AffinityNamedThreadFactory</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">NamedThreadFactory</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å¯åŠ¨Disruptor</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>kvDispatcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TaskDispatcher</span><span class="token punctuation">(</span>bufSize<span class="token punctuation">,</span> numWorkers<span class="token punctuation">,</span> WaitStrategyType<span class="token punctuation">.</span>LITE_BLOCKING_WAIT<span class="token punctuation">,</span> threadFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>batchingOpts <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">getBatchingOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// é»˜è®¤å…è®¸æ‰¹å¤„ç†</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>batchingOpts<span class="token punctuation">.</span><span class="token function">isAllowBatching</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ‰¹é‡Getå¤„ç†å™¨</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>getBatching <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetBatching</span><span class="token punctuation">(</span>KeyEvent<span class="token operator">:</span><span class="token operator">:</span><span class="token keyword">new</span><span class="token punctuation">,</span> <span class="token string">"get_batching"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">GetBatchingHandler</span><span class="token punctuation">(</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ä¸€è‡´æ€§è¯»çš„æ‰¹é‡Getå¤„ç†å™¨</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>getBatchingOnlySafe <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetBatching</span><span class="token punctuation">(</span>KeyEvent<span class="token operator">:</span><span class="token operator">:</span><span class="token keyword">new</span><span class="token punctuation">,</span> <span class="token string">"get_batching_only_safe"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">GetBatchingHandler</span><span class="token punctuation">(</span><span class="token string">"get_only_safe"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ‰¹é‡Putå¤„ç†å™¨ï¼ŒPutBatchingHandler</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>putBatching <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PutBatching</span><span class="token punctuation">(</span>KVEvent<span class="token operator">:</span><span class="token operator">:</span><span class="token keyword">new</span><span class="token punctuation">,</span> <span class="token string">"put_batching"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">PutBatchingHandler</span><span class="token punctuation">(</span><span class="token string">"put"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>started <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>åˆå§‹åŒ–PlacementDriverClient</p>
<p>AbstractPlacementDriverClient#init</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">boolean</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">final</span> PlacementDriverOptions opts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// åˆå§‹åŒ–RpcClientï¼Œè¿æ¥ServerèŠ‚ç‚¹ï¼Œåˆå§‹åŒ–CliServiceï¼Œç”¨äºé›†ç¾¤èŠ‚ç‚¹çš„å¢åˆ æ”¹æŸ¥ç­‰ç®¡ç†æ“ä½œ</span>
        <span class="token function">initCli</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span><span class="token function">getCliOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// RPCçš„å›è°ƒç›¸å…³</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>pdRpcService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultPlacementDriverRpcService</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        RpcOptions rpcOpts <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">getPdRpcOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>pdRpcService<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>rpcOpts<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ä¸€ä¸ªRegionå¯¹åº”ä¸€ä¸ªRegionRouteTableOptionsï¼Œå­˜æ”¾é”®åŒºé—´ç­‰é…ç½®</span>
        <span class="token keyword">final</span> List<span class="token operator">&lt;</span>RegionRouteTableOptions<span class="token operator">></span> regionRouteTableOptionsList <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">getRegionRouteTableOptionsList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>regionRouteTableOptionsList <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> String initialServerList <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">getInitialServerList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> RegionRouteTableOptions regionRouteTableOpts <span class="token operator">:</span> regionRouteTableOptionsList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
                <span class="token comment" spellcheck="true">// åˆå§‹åŒ–Regionçš„è·¯ç”±è¡¨</span>
                <span class="token function">initRouteTableByRegion</span><span class="token punctuation">(</span>regionRouteTableOpts<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>AbstractPlacementDriverClient#initRouteTableByRegion</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initRouteTableByRegion</span><span class="token punctuation">(</span><span class="token keyword">final</span> RegionRouteTableOptions opts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> regionId <span class="token operator">=</span> Requires<span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span><span class="token function">getRegionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"opts.regionId"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> startKey <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">getStartKeyBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> endKey <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">getEndKeyBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> String initialServerList <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">getInitialServerList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Region</span>
        <span class="token keyword">final</span> Region region <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Region</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Regionçš„èŠ‚ç‚¹é…ç½®</span>
        <span class="token keyword">final</span> Configuration conf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// RegionId</span>
        region<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>regionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å·¦ç«¯ç‚¹</span>
        region<span class="token punctuation">.</span><span class="token function">setStartKey</span><span class="token punctuation">(</span>startKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å³ç«¯ç‚¹</span>
        region<span class="token punctuation">.</span><span class="token function">setEndKey</span><span class="token punctuation">(</span>endKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ç‰ˆæœ¬å·</span>
        region<span class="token punctuation">.</span><span class="token function">setRegionEpoch</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RegionEpoch</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// peers</span>
        <span class="token comment" spellcheck="true">// ...</span>
        conf<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>initialServerList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Regionçš„åŒè¾ˆèŠ‚ç‚¹</span>
        region<span class="token punctuation">.</span><span class="token function">setPeers</span><span class="token punctuation">(</span>JRaftHelper<span class="token punctuation">.</span><span class="token function">toPeerList</span><span class="token punctuation">(</span>conf<span class="token punctuation">.</span><span class="token function">listPeers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ›´æ–°è¯¥Region/RaftGroupçš„Configuration</span>
        RouteTable<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">updateConfiguration</span><span class="token punctuation">(</span>JRaftHelper<span class="token punctuation">.</span><span class="token function">getJRaftGroupId</span><span class="token punctuation">(</span>clusterName<span class="token punctuation">,</span> regionId<span class="token punctuation">)</span><span class="token punctuation">,</span> conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ›´æ–°åŒºé—´æ˜ å°„</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>regionRouteTable<span class="token punctuation">.</span><span class="token function">addOrUpdateRegion</span><span class="token punctuation">(</span>region<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>RouteTable#updateConfiguration</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">updateConfiguration</span><span class="token punctuation">(</span><span class="token keyword">final</span> String groupId<span class="token punctuation">,</span> <span class="token keyword">final</span> Configuration conf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// è¯¥é›†ç¾¤çš„GroupConf</span>
        <span class="token keyword">final</span> GroupConf gc <span class="token operator">=</span> <span class="token function">getOrCreateGroupConf</span><span class="token punctuation">(</span>groupId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ¯”ReentrantReadWriteLockæ¶ˆè€—å°‘ï¼Œä½†æ˜¯ä¸å¯é‡å…¥</span>
        <span class="token keyword">final</span> StampedLock stampedLock <span class="token operator">=</span> gc<span class="token punctuation">.</span>stampedLock<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è·å–å†™é”ï¼Œè¿”å›Stampï¼Œ0è¡¨ç¤ºæ²¡æœ‰å†™é”</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> stamp <span class="token operator">=</span> stampedLock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ›´æ–°é›†ç¾¤çš„é…ç½®</span>
            gc<span class="token punctuation">.</span>conf <span class="token operator">=</span> conf<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>gc<span class="token punctuation">.</span>leader <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>gc<span class="token punctuation">.</span>conf<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>gc<span class="token punctuation">.</span>leader<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                gc<span class="token punctuation">.</span>leader <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            stampedLock<span class="token punctuation">.</span><span class="token function">unlockWrite</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>RegionRouteTable#addOrUpdateRegion</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addOrUpdateRegion</span><span class="token punctuation">(</span><span class="token keyword">final</span> Region region<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> regionId <span class="token operator">=</span> region<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> startKey <span class="token operator">=</span> BytesUtil<span class="token punctuation">.</span><span class="token function">nullToEmpty</span><span class="token punctuation">(</span>region<span class="token punctuation">.</span><span class="token function">getStartKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> StampedLock stampedLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>stampedLock<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> stamp <span class="token operator">=</span> stampedLock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// RegionIdï¼ŒRegion</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>regionTable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>regionId<span class="token punctuation">,</span> region<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// TreeMapï¼Œå·¦ç«¯ç‚¹ï¼ŒRegionId</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>rangeTable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>startKey<span class="token punctuation">,</span> regionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            stampedLock<span class="token punctuation">.</span><span class="token function">unlockWrite</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>StoreEngine#init</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">boolean</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">final</span> StoreEngineOptions opts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>storeOpts <span class="token operator">=</span> Requires<span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>opts<span class="token punctuation">,</span> <span class="token string">"opts"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Endpoint serverAddress <span class="token operator">=</span> Requires<span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span><span class="token function">getServerAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"opts.serverAddress"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> port <span class="token operator">=</span> serverAddress<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> String ip <span class="token operator">=</span> serverAddress<span class="token punctuation">.</span><span class="token function">getIp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ²¡æœ‰è®¾ç½®å°±ä½¿ç”¨å½“å‰ä¸»æœºçš„åœ°å€</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ip <span class="token operator">==</span> null <span class="token operator">||</span> Utils<span class="token punctuation">.</span>IP_ANY<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ...</span>
        List<span class="token operator">&lt;</span>RegionEngineOptions<span class="token operator">></span> rOptsList <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">getRegionEngineOptionsList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¦‚æœRegionEngineé€‰é¡¹ä¸ºç©ºï¼Œåˆå§‹åŒ–ä¸€ä¸ªé»˜è®¤çš„RegionEngine</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rOptsList <span class="token operator">==</span> null <span class="token operator">||</span> rOptsList<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// é›†ç¾¤å</span>
        <span class="token keyword">final</span> String clusterName <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pdClient<span class="token punctuation">.</span><span class="token function">getClusterName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// éå†æ‰€æœ‰RegionEngineé€‰é¡¹ï¼Œè®¾ç½®å‚æ•°</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> RegionEngineOptions rOpts <span class="token operator">:</span> rOptsList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// RaftGroup</span>
            rOpts<span class="token punctuation">.</span><span class="token function">setRaftGroupId</span><span class="token punctuation">(</span>JRaftHelper<span class="token punctuation">.</span><span class="token function">getJRaftGroupId</span><span class="token punctuation">(</span>clusterName<span class="token punctuation">,</span> rOpts<span class="token punctuation">.</span><span class="token function">getRegionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å½“å‰ServerèŠ‚ç‚¹çš„åœ°å€</span>
            rOpts<span class="token punctuation">.</span><span class="token function">setServerAddress</span><span class="token punctuation">(</span>serverAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ‰€æœ‰åŒè¾ˆèŠ‚ç‚¹çš„åœ°å€åˆ—è¡¨</span>
            rOpts<span class="token punctuation">.</span><span class="token function">setInitialServerList</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span><span class="token function">getInitialServerList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// åˆå§‹åŒ–Storeå’Œè¯¥Storeä¸‹é¢çš„Regionåˆ—è¡¨</span>
        <span class="token keyword">final</span> Store store <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pdClient<span class="token punctuation">.</span><span class="token function">getStoreMetadata</span><span class="token punctuation">(</span>opts<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>storeId <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// åˆå§‹åŒ–æ‰§è¡Œå™¨</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>readIndexExecutor <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>raftStateTrigger <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>snapshotExecutor <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> useSharedRpcExecutor <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">isUseSharedRpcExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¦‚æœä¸å…±ç”¨RPCçº¿ç¨‹æ± ï¼Œåˆ™åˆå§‹åŒ–å„è‡ªçš„çº¿ç¨‹æ± </span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>useSharedRpcExecutor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// æ€§èƒ½ç›‘æ§</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// åˆå§‹åŒ–RPCæœåŠ¡å™¨</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>rpcServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RpcServer</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ·»åŠ Raftç›¸å…³çš„è¯·æ±‚å¤„ç†å™¨</span>
        RaftRpcServerFactory<span class="token punctuation">.</span><span class="token function">addRaftRequestProcessors</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>rpcServer<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>raftRpcExecutor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cliRpcExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ·»åŠ é”®å€¼å­˜å‚¨ç›¸å…³çš„è¯·æ±‚å¤„ç†å™¨ï¼ŒKVCommandProcessor</span>
        StoreEngineHelper<span class="token punctuation">.</span><span class="token function">addKvStoreRequestProcessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>rpcServer<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¯åŠ¨RPCæœåŠ¡å™¨</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>rpcServer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// æ ¹æ®ç±»å‹åˆå§‹åŒ–RawKVStoreæ•°æ®åº“ï¼ŒRocksDBæˆ–ConcurrentSkipListMap</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">initRawKVStore</span><span class="token punctuation">(</span>opts<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// ä¸ºè¯¥Storeä¸‹çš„æ‰€æœ‰Regionåˆå§‹åŒ–RegionEngine</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">initAllRegionEngine</span><span class="token punctuation">(</span>opts<span class="token punctuation">,</span> store<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å¦‚æœå¯ç”¨äº†è‡ªç®¡ç†çš„é›†ç¾¤ï¼Œéœ€è¦åˆå§‹åŒ–ä¸€ä¸ªHeartbeatSender</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pdClient <span class="token keyword">instanceof</span> <span class="token class-name">RemotePlacementDriverClient</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>started <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>FakePlacementDriverClient#getStoreMetadata</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> Store <span class="token function">getStoreMetadata</span><span class="token punctuation">(</span><span class="token keyword">final</span> StoreEngineOptions opts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> Store store <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Store</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> List<span class="token operator">&lt;</span>RegionEngineOptions<span class="token operator">></span> rOptsList <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">getRegionEngineOptionsList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> List<span class="token operator">&lt;</span>Region<span class="token operator">></span> regionList <span class="token operator">=</span> Lists<span class="token punctuation">.</span><span class="token function">newArrayListWithCapacity</span><span class="token punctuation">(</span>rOptsList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¯¹äºFakeæ¥è¯´ï¼ŒStoreä¸éœ€è¦Id</span>
        store<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        store<span class="token punctuation">.</span><span class="token function">setEndpoint</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span><span class="token function">getServerAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> RegionEngineOptions rOpts <span class="token operator">:</span> rOptsList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ ¹æ®RegionEngineOptionsæ›´æ–°è·¯ç”±</span>
            regionList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">getLocalRegionMetadata</span><span class="token punctuation">(</span>rOpts<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// è®¾ç½®è¯¥Storeä¸‹çš„Regionåˆ—è¡¨</span>
        store<span class="token punctuation">.</span><span class="token function">setRegions</span><span class="token punctuation">(</span>regionList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> store<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>StoreEngine#initAllRegionEngine</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">initAllRegionEngine</span><span class="token punctuation">(</span><span class="token keyword">final</span> StoreEngineOptions opts<span class="token punctuation">,</span> <span class="token keyword">final</span> Store store<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        String baseRaftDataPath <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">getRaftDataPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Strings<span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>baseRaftDataPath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">final</span> Endpoint serverAddress <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">getServerAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> List<span class="token operator">&lt;</span>RegionEngineOptions<span class="token operator">></span> rOptsList <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">getRegionEngineOptionsList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> List<span class="token operator">&lt;</span>Region<span class="token operator">></span> regionList <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token function">getRegions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å…ˆæ ¡éªŒRegionEngineOptionså’ŒRegionæ•°é‡æ˜¯å¦ä¸€è‡´</span>
        Requires<span class="token punctuation">.</span><span class="token function">requireTrue</span><span class="token punctuation">(</span>rOptsList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> regionList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> rOptsList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å¯¹åº”çš„RegionEngineOptions</span>
            <span class="token keyword">final</span> RegionEngineOptions rOpts <span class="token operator">=</span> rOptsList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å¯¹åº”çš„Region</span>
            <span class="token keyword">final</span> Region region <span class="token operator">=</span> regionList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è·¯å¾„ä¸ºç©ºçš„å°±è®¾ç½®ä¸€ä¸ªé»˜è®¤å€¼</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>Strings<span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>rOpts<span class="token punctuation">.</span><span class="token function">getRaftDataPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// åˆå§‹åŒ–è¯¥Regionçš„RegionEngine</span>
            <span class="token keyword">final</span> RegionEngine engine <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegionEngine</span><span class="token punctuation">(</span>region<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>engine<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>rOpts<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ä¸€ä¸ªRegionEngineä¸€ä¸ªRegionKVService</span>
                <span class="token keyword">final</span> RegionKVService regionKVService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultRegionKVService</span><span class="token punctuation">(</span>engine<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å…³è”RegionIdå’ŒRegionKVService</span>
                <span class="token function">registerRegionKVService</span><span class="token punctuation">(</span>regionKVService<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å…³è”RegionIdå’ŒRegionEngine</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>regionEngineTable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>region<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> engine<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>RegionEngine#init</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">boolean</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">final</span> RegionEngineOptions opts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>regionOpts <span class="token operator">=</span> Requires<span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>opts<span class="token punctuation">,</span> <span class="token string">"opts"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å®ä¾‹åŒ–çŠ¶æ€æœº</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fsm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KVStoreStateMachine</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>region<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>storeEngine<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// node options</span>
        NodeOptions nodeOpts <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">getNodeOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        nodeOpts<span class="token punctuation">.</span><span class="token function">setInitialConf</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span>JRaftHelper<span class="token punctuation">.</span><span class="token function">toJRaftPeerIdList</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>region<span class="token punctuation">.</span><span class="token function">getPeers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        nodeOpts<span class="token punctuation">.</span><span class="token function">setFsm</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fsm<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> String raftDataPath <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">getRaftDataPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å„ç§è·¯å¾„</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">final</span> Endpoint serverAddress <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">getServerAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> PeerId serverId <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PeerId</span><span class="token punctuation">(</span>serverAddress<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> RpcServer rpcServer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>storeEngine<span class="token punctuation">.</span><span class="token function">getRpcServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>raftGroupService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RaftGroupService</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span><span class="token function">getRaftGroupId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> serverId<span class="token punctuation">,</span> nodeOpts<span class="token punctuation">,</span> rpcServer<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// åˆå§‹åŒ–å¹¶å¯åŠ¨JRaftèŠ‚ç‚¹</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>node <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>raftGroupService<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        RouteTable<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">updateConfiguration</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>raftGroupService<span class="token punctuation">.</span><span class="token function">getGroupId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nodeOpts<span class="token punctuation">.</span><span class="token function">getInitialConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>node <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> RawKVStore rawKVStore <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>storeEngine<span class="token punctuation">.</span><span class="token function">getRawKVStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> Executor readIndexExecutor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>storeEngine<span class="token punctuation">.</span><span class="token function">getReadIndexExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// é‡ç‚¹</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>raftRawKVStore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RaftRawKVStore</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>node<span class="token punctuation">,</span> rawKVStore<span class="token punctuation">,</span> readIndexExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>metricsRawKVStore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MetricsRawKVStore</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>region<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>raftRawKVStore<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ä¸€äº›ç›‘æ§é…ç½®</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>started <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>started<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>DefaultRheaKVStore#put</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> CompletableFuture<span class="token operator">&lt;</span>Boolean<span class="token operator">></span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> value<span class="token punctuation">,</span> <span class="token keyword">final</span> CompletableFuture<span class="token operator">&lt;</span>Boolean<span class="token operator">></span> future<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> tryBatching<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">checkState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å°è¯•æ‰¹é‡æ“ä½œ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tryBatching<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> PutBatching putBatching <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>putBatching<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å‘å¸ƒåˆ°PutBatchingå®ä¾‹çš„RingBuffer</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>putBatching <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> putBatching<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">KVEntry</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">,</span> future<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> future<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ç›´æ¥åŠ å…¥</span>
        <span class="token function">internalPut</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> future<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>failoverRetries<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> future<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>DefaultRheaKVStore$PutBatchingHandler#onEvent</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onEvent</span><span class="token punctuation">(</span><span class="token keyword">final</span> KVEvent event<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> sequence<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> endOfBatch<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å…ˆæŠŠPutè¯·æ±‚åŠ å…¥äº‹ä»¶åˆ—è¡¨</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ç´¯è®¡é”®å’Œå€¼çš„é•¿åº¦</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>cachedBytes <span class="token operator">+=</span> event<span class="token punctuation">.</span>kvEntry<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ˜¯å¦æ‰§è¡Œæ‰¹å¤„ç†</span>
            <span class="token comment" spellcheck="true">// æ²¡æœ‰æ‰¹å¤„ç†æ ‡è®° &amp;&amp; æ²¡è¾¾åˆ°æ‰¹å¤„ç†ç´¯è®¡æ•°é‡ &amp;&amp; ç´¯è®¡çš„é”®å€¼é•¿åº¦ä¸å¤Ÿå¤š</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>endOfBatch <span class="token operator">&amp;&amp;</span> size <span class="token operator">&lt;</span> batchingOpts<span class="token punctuation">.</span><span class="token function">getBatchSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cachedBytes <span class="token operator">&lt;</span> batchingOpts<span class="token punctuation">.</span><span class="token function">getMaxWriteBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// åªæœ‰ä¸€æ¡</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å…ˆé‡ç½®æ¸…ç©ºäº‹ä»¶åˆ—è¡¨å’Œç´¯è®¡çš„é”®å€¼é•¿åº¦</span>
                <span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å½“å‰äº‹ä»¶</span>
                <span class="token keyword">final</span> KVEntry kv <span class="token operator">=</span> event<span class="token punctuation">.</span>kvEntry<span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å†æ¬¡æ‰§è¡ŒPutï¼Œæ³¨æ„è¿™é‡Œä¸ä¼šå°è¯•Batchingï¼Œè€Œæ˜¯è¿›å…¥DefaultRheaKVStore#internalPut</span>
                    <span class="token function">put</span><span class="token punctuation">(</span>kv<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>future<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">final</span> Throwable t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å¼‚å¸¸å›è°ƒ</span>
                    <span class="token function">exceptionally</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> event<span class="token punctuation">.</span>future<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ç´¯ç§¯æœ‰å¤šæ¡</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> List<span class="token operator">&lt;</span>KVEntry<span class="token operator">></span> entries <span class="token operator">=</span> Lists<span class="token punctuation">.</span><span class="token function">newArrayListWithCapacity</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> CompletableFuture<span class="token operator">&lt;</span>Boolean<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> futures <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">[</span>size<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> KVEvent e <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    entries<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>kvEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// ä¸€ä¸ªäº‹ä»¶ä¸€ä¸ªFuture</span>
                    futures<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">.</span>future<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// é‡ç½®</span>
                <span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// æ‰¹é‡æ‰§è¡Œ</span>
                    <span class="token function">put</span><span class="token punctuation">(</span>entries<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">whenComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> throwable<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// æˆåŠŸ</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>throwable <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> futures<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token comment" spellcheck="true">// å›è°ƒ</span>
                                futures<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            <span class="token keyword">return</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment" spellcheck="true">// å¼‚å¸¸å›è°ƒ</span>
                        <span class="token function">exceptionally</span><span class="token punctuation">(</span>throwable<span class="token punctuation">,</span> futures<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">final</span> Throwable t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å¼‚å¸¸å›è°ƒ</span>
                    <span class="token function">exceptionally</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> futures<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span></code></pre>
<p>DefaultRheaKVStore#internalPut</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">internalPut</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> value<span class="token punctuation">,</span> <span class="token keyword">final</span> CompletableFuture<span class="token operator">&lt;</span>Boolean<span class="token operator">></span> future<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> retriesLeft<span class="token punctuation">,</span> <span class="token keyword">final</span> Errors lastCause<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// æ ¹æ®KeyæŸ¥è¯¢Region</span>
        <span class="token keyword">final</span> Region region <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pdClient<span class="token punctuation">.</span><span class="token function">findRegionByKey</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> ErrorsHelper<span class="token punctuation">.</span><span class="token function">isInvalidEpoch</span><span class="token punctuation">(</span>lastCause<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è·å–è¯¥Regionçš„RegionEngineï¼Œå¦‚æœä¸æ˜¯Leaderï¼Œè¿”å›null</span>
        <span class="token keyword">final</span> RegionEngine regionEngine <span class="token operator">=</span> <span class="token function">getRegionEngine</span><span class="token punctuation">(</span>region<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¤±è´¥é‡è¯•å‡½æ•°</span>
        <span class="token keyword">final</span> RetryRunner retryRunner <span class="token operator">=</span> retryCause <span class="token operator">-</span><span class="token operator">></span> <span class="token function">internalPut</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> future<span class="token punctuation">,</span> retriesLeft <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> retryCause<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¤±è´¥å›è°ƒ</span>
        <span class="token keyword">final</span> FailoverClosure<span class="token operator">&lt;</span>Boolean<span class="token operator">></span> closure <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FailoverClosureImpl</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>future<span class="token punctuation">,</span> retriesLeft<span class="token punctuation">,</span> retryRunner<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è·¯ç”±ç¼“å­˜çš„èŠ‚ç‚¹æ˜¯Leader</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>regionEngine <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ç¡®ä¿Regionå’ŒRegionEngineçš„Epochä¸€è‡´</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ensureOnValidEpoch</span><span class="token punctuation">(</span>region<span class="token punctuation">,</span> regionEngine<span class="token punctuation">,</span> closure<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ç›´æ¥æ‰§è¡Œï¼ŒRawKVStore#Put</span>
                <span class="token function">getRawKVStore</span><span class="token punctuation">(</span>regionEngine<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> closure<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// è·¯ç”±ç¼“å­˜çš„èŠ‚ç‚¹ä¸æ˜¯Leader</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> PutRequest request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PutRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            request<span class="token punctuation">.</span><span class="token function">setKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            request<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            request<span class="token punctuation">.</span><span class="token function">setRegionId</span><span class="token punctuation">(</span>region<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            request<span class="token punctuation">.</span><span class="token function">setRegionEpoch</span><span class="token punctuation">(</span>region<span class="token punctuation">.</span><span class="token function">getRegionEpoch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// RPCäº¤ç»™Leaderæ‰§è¡Œ</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>rheaKVRpcService<span class="token punctuation">.</span><span class="token function">callAsyncWithRpc</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> closure<span class="token punctuation">,</span> lastCause<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>AbstractPlacementDriverClient#findRegionByKey</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> Region <span class="token function">findRegionByKey</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> forceRefresh<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>forceRefresh<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ¨¡æ¿æ–¹æ³•ï¼Œæ›´æ–°è·¯ç”±è¡¨ï¼ŒFakePlacementDriverClientçš„å®ç°ä¸ºç©ºï¼ŒNO-OPï¼Œå› ä¸ºæ˜¯å›ºå®šçš„</span>
            <span class="token function">refreshRouteTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ä»è·¯ç”±è¡¨æŸ¥</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>regionRouteTable<span class="token punctuation">.</span><span class="token function">findRegionByKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>RegionRouteTable#findRegionByKey</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> Region <span class="token function">findRegionByKey</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">final</span> StampedLock stampedLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>stampedLock<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> stamp <span class="token operator">=</span> stampedLock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">findRegionByKeyWithoutLock</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            stampedLock<span class="token punctuation">.</span><span class="token function">unlockRead</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>RegionRouteTable#findRegionByKeyWithoutLock</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> Region <span class="token function">findRegionByKeyWithoutLock</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// èŒƒå›´è¡¨æ˜¯ä¸€ä¸ªTreeMapï¼Œä¿å­˜äº†Regionçš„StartKeyå’ŒRegionIdçš„æ˜ å°„</span>
        <span class="token comment" spellcheck="true">// è¿”å›çš„æ˜¯StartKeyå°äºç­‰äºKeyçš„ç¬¬ä¸€ä¸ªRegionId</span>
        <span class="token keyword">final</span> Map<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> Long<span class="token operator">></span> entry <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rangeTable<span class="token punctuation">.</span><span class="token function">floorEntry</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>entry <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// æ ¹æ®RegionIdæŸ¥æ‰¾Region</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>regionTable<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>DefaultRheaKVRpcService#callAsyncWithRpc</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token operator">&lt;</span>V<span class="token operator">></span> CompletableFuture<span class="token operator">&lt;</span>V<span class="token operator">></span> <span class="token function">callAsyncWithRpc</span><span class="token punctuation">(</span><span class="token keyword">final</span> BaseRequest request<span class="token punctuation">,</span> <span class="token keyword">final</span> FailoverClosure<span class="token operator">&lt;</span>V<span class="token operator">></span> closure<span class="token punctuation">,</span> <span class="token keyword">final</span> Errors lastCause<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> requireLeader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> forceRefresh <span class="token operator">=</span> ErrorsHelper<span class="token punctuation">.</span><span class="token function">isInvalidPeer</span><span class="token punctuation">(</span>lastCause<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ ¹æ®RegionIdå’Œæ˜¯å¦éœ€è¦Leaderè¿”å›ç«¯ç‚¹</span>
        <span class="token keyword">final</span> Endpoint endpoint <span class="token operator">=</span> <span class="token function">getRpcEndpoint</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getRegionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> forceRefresh<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rpcTimeoutMillis<span class="token punctuation">,</span> requireLeader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ‰§è¡ŒRPC</span>
        <span class="token function">internalCallAsyncWithRpc</span><span class="token punctuation">(</span>endpoint<span class="token punctuation">,</span> request<span class="token punctuation">,</span> closure<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> closure<span class="token punctuation">.</span><span class="token function">future</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>DefaultRheaKVRpcService#getRpcEndpoint</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> Endpoint <span class="token function">getRpcEndpoint</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">long</span> regionId<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> forceRefresh<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> timeoutMillis<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> requireLeader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>requireLeader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è·å–Leader</span>
            <span class="token keyword">return</span> <span class="token function">getLeader</span><span class="token punctuation">(</span>regionId<span class="token punctuation">,</span> forceRefresh<span class="token punctuation">,</span> timeoutMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è¿”å›ä¸€ä¸ªä¸æ˜¯è‡ªå·±çš„èŠ‚ç‚¹</span>
            <span class="token keyword">return</span> <span class="token function">getLuckyPeer</span><span class="token punctuation">(</span>regionId<span class="token punctuation">,</span> forceRefresh<span class="token punctuation">,</span> timeoutMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>DefaultRheaKVStore$DefaultRheaKVRpcService#getLeader</p>
<pre class=" language-java"><code class="language-java">            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> Endpoint <span class="token function">getLeader</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">long</span> regionId<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> forceRefresh<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> timeoutMillis<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å…ˆæ ¹æ®RegionIdæŸ¥æ‰¾Leader</span>
                <span class="token keyword">final</span> Endpoint leader <span class="token operator">=</span> <span class="token function">getLeaderByRegionEngine</span><span class="token punctuation">(</span>regionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>leader <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> leader<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// æ‰¾ä¸åˆ°å†è°ƒç”¨çˆ¶ç±»çš„æ–¹æ³•</span>
                <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getLeader</span><span class="token punctuation">(</span>regionId<span class="token punctuation">,</span> forceRefresh<span class="token punctuation">,</span> timeoutMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span></code></pre>
<p>DefaultRheaKVStore#getLeaderByRegionEngine</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> Endpoint <span class="token function">getLeaderByRegionEngine</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">long</span> regionId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Clientæ²¡æœ‰åˆå§‹åŒ–RegionEngine</span>
        <span class="token keyword">final</span> RegionEngine regionEngine <span class="token operator">=</span> <span class="token function">getRegionEngine</span><span class="token punctuation">(</span>regionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Serveræœ‰é…ç½®</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>regionEngine <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> PeerId leader <span class="token operator">=</span> regionEngine<span class="token punctuation">.</span><span class="token function">getLeaderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>leader <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> String raftGroupId <span class="token operator">=</span> JRaftHelper<span class="token punctuation">.</span><span class="token function">getJRaftGroupId</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pdClient<span class="token punctuation">.</span><span class="token function">getClusterName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> regionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                RouteTable<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">updateLeader</span><span class="token punctuation">(</span>raftGroupId<span class="token punctuation">,</span> leader<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> leader<span class="token punctuation">.</span><span class="token function">getEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>AbstractPlacementDriverClient#getLeader</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> Endpoint <span class="token function">getLeader</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">long</span> regionId<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> forceRefresh<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> timeoutMillis<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// RaftGroupIdï¼Œç”±ClusterNameå’ŒRegionIdæ‹¼æ¥å¾—</span>
        <span class="token keyword">final</span> String raftGroupId <span class="token operator">=</span> JRaftHelper<span class="token punctuation">.</span><span class="token function">getJRaftGroupId</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>clusterName<span class="token punctuation">,</span> regionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å…ˆä»ç¼“å­˜æ‰¾</span>
        PeerId leader <span class="token operator">=</span> <span class="token function">getLeader</span><span class="token punctuation">(</span>raftGroupId<span class="token punctuation">,</span> forceRefresh<span class="token punctuation">,</span> timeoutMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ç¼“å­˜æ²¡æ‰¾åˆ°ï¼Œä¹‹å‰ä¹Ÿæ²¡æœ‰åˆ·æ–°ç¼“å­˜</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>leader <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>forceRefresh<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// åˆ·æ–°ç¼“å­˜å†æ‰¾</span>
            leader <span class="token operator">=</span> <span class="token function">getLeader</span><span class="token punctuation">(</span>raftGroupId<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> timeoutMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>leader <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> leader<span class="token punctuation">.</span><span class="token function">getEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>AbstractPlacementDriverClient#getLeader</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">protected</span> PeerId <span class="token function">getLeader</span><span class="token punctuation">(</span><span class="token keyword">final</span> String raftGroupId<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> forceRefresh<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> timeoutMillis<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> RouteTable routeTable <span class="token operator">=</span> RouteTable<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¦‚æœè¦å¼ºåˆ¶åˆ·æ–°ç¼“å­˜</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>forceRefresh<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> deadline <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> timeoutMillis<span class="token punctuation">;</span>
            <span class="token keyword">final</span> StringBuilder error <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Throwable lastCause <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// é˜»å¡åˆ·æ–°è‡³è¶…æ—¶æˆ–å”¤é†’</span>
                    <span class="token keyword">final</span> Status st <span class="token operator">=</span> routeTable<span class="token punctuation">.</span><span class="token function">refreshLeader</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cliClientService<span class="token punctuation">,</span> raftGroupId<span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">final</span> InterruptedException e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">final</span> Throwable t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// å¦‚æœæ²¡åˆ°æˆªæ­¢æ—¶é—´ï¼Œè¿˜å¯ä»¥ç»§ç»­åˆ·æ–°</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> deadline<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// è¶…æ—¶æŠ›å¼‚å¸¸</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ä»ç¼“å­˜è·å–è¿”å›</span>
        <span class="token keyword">return</span> routeTable<span class="token punctuation">.</span><span class="token function">selectLeader</span><span class="token punctuation">(</span>raftGroupId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>RouteTable#refreshLeader</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> Status <span class="token function">refreshLeader</span><span class="token punctuation">(</span><span class="token keyword">final</span> CliClientService cliClientService<span class="token punctuation">,</span> <span class="token keyword">final</span> String groupId<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> timeoutMs<span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException<span class="token punctuation">,</span> TimeoutException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">final</span> Configuration conf <span class="token operator">=</span> <span class="token function">getConfiguration</span><span class="token punctuation">(</span>groupId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">final</span> Status st <span class="token operator">=</span> Status<span class="token punctuation">.</span><span class="token function">OK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Protobuf</span>
        <span class="token keyword">final</span> CliRequests<span class="token punctuation">.</span>GetLeaderRequest<span class="token punctuation">.</span>Builder rb <span class="token operator">=</span> CliRequests<span class="token punctuation">.</span>GetLeaderRequest<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rb<span class="token punctuation">.</span><span class="token function">setGroupId</span><span class="token punctuation">(</span>groupId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// åˆ›å»ºä¸€ä¸ªè·å–Leaderçš„è¯·æ±‚</span>
        <span class="token keyword">final</span> CliRequests<span class="token punctuation">.</span>GetLeaderRequest request <span class="token operator">=</span> rb<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        TimeoutException timeoutException <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// éå†æ‰€æœ‰é…ç½®çš„èŠ‚ç‚¹</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> PeerId peer <span class="token operator">:</span> conf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å°è¯•è¿æ¥</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cliClientService<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>peer<span class="token punctuation">.</span><span class="token function">getEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
                <span class="token comment" spellcheck="true">// è·³è¿‡æ²¡æœ‰è¿æ¥çš„èŠ‚ç‚¹</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å‘é€è·å–Leaderè¯·æ±‚</span>
            <span class="token keyword">final</span> Future<span class="token operator">&lt;</span>Message<span class="token operator">></span> result <span class="token operator">=</span> cliClientService<span class="token punctuation">.</span><span class="token function">getLeader</span><span class="token punctuation">(</span>peer<span class="token punctuation">.</span><span class="token function">getEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> Message msg <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>timeoutMs<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token keyword">instanceof</span> <span class="token class-name">RpcRequests<span class="token punctuation">.</span>ErrorResponse</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> CliRequests<span class="token punctuation">.</span>GetLeaderResponse response <span class="token operator">=</span> <span class="token punctuation">(</span>CliRequests<span class="token punctuation">.</span>GetLeaderResponse<span class="token punctuation">)</span> msg<span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// æ›´æ–°Leaderä¿¡æ¯</span>
                    <span class="token function">updateLeader</span><span class="token punctuation">(</span>groupId<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">getLeaderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// åªè¦æœ‰ä¸€ä¸ªèŠ‚ç‚¹è¿”å›Leaderä¿¡æ¯å°±å¥½</span>
                    <span class="token keyword">return</span> Status<span class="token punctuation">.</span><span class="token function">OK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">final</span> TimeoutException e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">final</span> ExecutionException e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>timeoutException <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> timeoutException<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> st<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>RouteTable#selectLeader</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> PeerId <span class="token function">selectLeader</span><span class="token punctuation">(</span><span class="token keyword">final</span> String groupId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">final</span> GroupConf gc <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>groupConfTable<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>groupId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">final</span> StampedLock stampedLock <span class="token operator">=</span> gc<span class="token punctuation">.</span>stampedLock<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è¯»é”åˆ†æ‚²è§‚æ¨¡å¼å’Œä¹è§‚æ¨¡å¼ï¼Œè¿™é‡Œæ˜¯è·å–ä¹è§‚è¯»é”</span>
        <span class="token keyword">long</span> stamp <span class="token operator">=</span> stampedLock<span class="token punctuation">.</span><span class="token function">tryOptimisticRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        PeerId leader <span class="token operator">=</span> gc<span class="token punctuation">.</span>leader<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¦‚æœè·å–ä¹è§‚è¯»é”åå‘ç”Ÿäº†å†™é”</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>stampedLock<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å‡çº§ä¸ºæ‚²è§‚è¯»é”</span>
            stamp <span class="token operator">=</span> stampedLock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// é‡æ–°å†è·å–ä¸€æ¬¡å˜é‡</span>
                leader <span class="token operator">=</span> gc<span class="token punctuation">.</span>leader<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                stampedLock<span class="token punctuation">.</span><span class="token function">unlockRead</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> leader<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>å¯¹äºæ‰¹é‡Putï¼Œä¹Ÿæ˜¯ç±»ä¼¼ï¼Œä½†æ˜¯é»˜è®¤æ˜¯å‘å¸ƒåˆ°Disruptorï¼Œç”±çº¿ç¨‹æ± å¼‚æ­¥æ¶ˆè´¹ã€‚</p>
<p>å¦å¤–ï¼Œå¦‚æœå¤šä¸ªé”®è·¨äº†å¤šä¸ªRegionï¼Œä¸ä¿è¯äº‹åŠ¡ã€‚</p>
<p>RaftRawKVStore#put</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> value<span class="token punctuation">,</span> <span class="token keyword">final</span> KVStoreClosure closure<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// åŒ…è£…ä¸€ä¸ªOperationï¼Œå¹¶åº”ç”¨</span>
        <span class="token function">applyOperation</span><span class="token punctuation">(</span>KVOperation<span class="token punctuation">.</span><span class="token function">createPut</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">,</span> closure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>RaftRawKVStore#applyOperation</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">applyOperation</span><span class="token punctuation">(</span><span class="token keyword">final</span> KVOperation op<span class="token punctuation">,</span> <span class="token keyword">final</span> KVStoreClosure closure<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// å¿…é¡»ä¿è¯å½“å‰æ“ä½œçš„èŠ‚ç‚¹æ˜¯Leader</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// åˆ›å»ºä»»åŠ¡</span>
        <span class="token keyword">final</span> Task task <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        task<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>ByteBuffer<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>Serializers<span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        task<span class="token punctuation">.</span><span class="token function">setDone</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">KVClosureAdapter</span><span class="token punctuation">(</span>closure<span class="token punctuation">,</span> op<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å‘å¸ƒæ—¥å¿—</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>node<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>DefaultRheaKVStore#get</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> CompletableFuture<span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> readOnlySafe<span class="token punctuation">,</span> <span class="token keyword">final</span> CompletableFuture<span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> future<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> tryBatching<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// å°è¯•æ‰¹é‡</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tryBatching<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ˜¯å¦ä½¿ç”¨ä¸€è‡´æ€§è¯»</span>
            <span class="token keyword">final</span> GetBatching getBatching <span class="token operator">=</span> readOnlySafe <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>getBatchingOnlySafe <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>getBatching<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å‘å¸ƒåˆ°RingBuffer</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>getBatching <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> getBatching<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> future<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> future<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ç›´æ¥è·å–</span>
        <span class="token function">internalGet</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> readOnlySafe<span class="token punctuation">,</span> future<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>failoverRetries<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onlyLeaderRead<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> future<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>DefaultRheaKVStore$GetBatchingHandler#onEvent</p>
<p>GetåŸºæœ¬å’ŒPutä¸€è‡´ï¼Œä¸åŠ æ³¨é‡Šäº†</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onEvent</span><span class="token punctuation">(</span><span class="token keyword">final</span> KeyEvent event<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> sequence<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> endOfBatch<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>cachedBytes <span class="token operator">+=</span> event<span class="token punctuation">.</span>key<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>endOfBatch <span class="token operator">&amp;&amp;</span> size <span class="token operator">&lt;</span> batchingOpts<span class="token punctuation">.</span><span class="token function">getBatchSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cachedBytes <span class="token operator">&lt;</span> batchingOpts<span class="token punctuation">.</span><span class="token function">getMaxReadBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token function">get</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>key<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>readOnlySafe<span class="token punctuation">,</span> event<span class="token punctuation">.</span>future<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">final</span> Throwable t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">exceptionally</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> event<span class="token punctuation">.</span>future<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> List<span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> keys <span class="token operator">=</span> Lists<span class="token punctuation">.</span><span class="token function">newArrayListWithCapacity</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> CompletableFuture<span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> futures <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">[</span>size<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> KeyEvent e <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    keys<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    futures<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">.</span>future<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token function">multiGet</span><span class="token punctuation">(</span>keys<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>readOnlySafe<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">whenComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> throwable<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>throwable <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> futures<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">final</span> ByteArray realKey <span class="token operator">=</span> ByteArray<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>keys<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                futures<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>realKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            <span class="token keyword">return</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token function">exceptionally</span><span class="token punctuation">(</span>throwable<span class="token punctuation">,</span> futures<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">final</span> Throwable t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">exceptionally</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> futures<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span></code></pre>
<p>å‰©ä¸‹åŸºæœ¬å’ŒPutä¸€æ ·ï¼Œä¸è´´äº†ã€‚</p>
<p>RaftRawKVStore#get</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> readOnlySafe<span class="token punctuation">,</span> <span class="token keyword">final</span> KVStoreClosure closure<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// å¦‚æœä¸éœ€è¦ä¸€è‡´æ€§è¯»ï¼Œé‚£å°±ç›´æ¥è¯»æœ¬åœ°æ•°æ®</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>readOnlySafe<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>kvStore<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> closure<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Raftä¸€è‡´æ€§è¯»</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>node<span class="token punctuation">.</span><span class="token function">readIndex</span><span class="token punctuation">(</span>BytesUtil<span class="token punctuation">.</span>EMPTY_BYTES<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ReadIndexClosure</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">final</span> Status status<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> index<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> reqCtx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ç¡®è®¤åº”ç”¨äº†æ‰èƒ½è¯»æœ¬åœ°æ•°æ®</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    RaftRawKVStore<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>kvStore<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> closure<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// å¤±è´¥çš„æƒ…å†µ</span>
                RaftRawKVStore<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>readIndexExecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å¦‚æœå½“å‰èŠ‚ç‚¹æ˜¯Leaderï¼Œå¯èƒ½æ˜¯æ²¡æ”¶åˆ°è¶³å¤ŸFollowerçš„å“åº”ï¼Œå› æ­¤ä¸èƒ½åº”ç”¨åˆ°çŠ¶æ€æœº</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// å†å‘å¸ƒä¸€ä¸ªGETçš„æ—¥å¿—ï¼Œå°è¯•åº”ç”¨åˆ°çŠ¶æ€æœº</span>
                        <span class="token function">applyOperation</span><span class="token punctuation">(</span>KVOperation<span class="token punctuation">.</span><span class="token function">createGet</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> closure<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> 
                    <span class="token comment" spellcheck="true">// å½“å‰èŠ‚ç‚¹æ˜¯Follower</span>
                    <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// Clientæ‰§è¡Œå¤±è´¥å›è°ƒï¼Œé‡è¯•</span>
                        <span class="token keyword">new</span> <span class="token class-name">KVClosureAdapter</span><span class="token punctuation">(</span>closure<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


        <footer>
             
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

        </footer>
    </div>
    <!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
    <script>
        var timeEnd = new Date();
        console.log('è€—æ—¶ï¼š' + (timeEnd - timeStart));
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre').forEach((block) => {
                block.classList.add("line-numbers");
            });
        });
    </script>
    <!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
    <!-- material design -->
    <!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
    <!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
    <!-- toc -->
    <!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
    <!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
    <!-- <script src="/js/main.js"></script> -->
    <script src="/js/prism.js"></script>
</body>
</html>
