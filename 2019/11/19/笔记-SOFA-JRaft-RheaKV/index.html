<!DOCTYPE HTML>
<html>

<head>
    <script>
        var timeStart = new Date();
    </script>
    <meta charset="utf-8">
    
    <title>[笔记]-SOFA-JRaft-RheaKV | Reunion...</title>
    
    <meta name="author" content="huangzhike">
    
    
    <meta name="description"
        content="MultiRaftGroup：多个RaftGroup，对于RheaKV，每个分组（Region）都有一个独立的Leader和多个Follower。
PlacementDriver：管理整个集群，生成RegionId，根据Region的心跳更新路由表，也可以使用Fake的固定配置。
Store：Reg">
    
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta property="og:title" content="[笔记]-SOFA-JRaft-RheaKV" />
    
    <meta property="og:site_name" content="Reunion..." />
    
    
    <!-- favicon -->
    <link rel="icon" type="image/ico" href="/logo.ico" sizes="32x32">
    <meta name="msapplication-TileColor" content="#009688">
    <meta name="msapplication-TileImage" content="/mstile-144x144.ico">
    <meta name="theme-color" content="#009688">
    <!-- favicon end -->
    <!-- <link href="//ok.ico" rel="icon"> -->
    

    <!-- <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.5.0/css/bootstrap.min.css" rel="stylesheet"> -->
    <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
    <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
    <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">

<meta name="generator" content="Hexo 4.2.1"></head>
<body>
    <nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">菜单</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" title="早く来い、クラウド" href="/">Reunion...</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" target="_blank" rel="noopener" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

    <div class="container" >
        <div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[笔记]-SOFA-JRaft-RheaKV</h2>
				
				<div>
					<div class="post-time">2019-11-19</div>
				</div>
				
				<div class="article-content">
				<p>MultiRaftGroup：多个RaftGroup，对于RheaKV，每个分组（Region）都有一个独立的Leader和多个Follower。</p>
<p>PlacementDriver：管理整个集群，生成RegionId，根据Region的心跳更新路由表，也可以使用Fake的固定配置。</p>
<p>Store：Region的容器，包含多个分片，Store向PD主动上报心跳，包含该Store的基本信息，如，包含多少Region，有哪些Region的Leader在该Store等。</p>
<p>Region：数据存储的单元，也包含了一个选举单元，对应Store里某个数据区间，每个Region有多个副本，每个副本存储在不同的Store，一起组成一个RaftGroup。Region的Leader会向PD主动上报心跳，PD通过Region的Epoch感知Region是否有变化。</p>
<p>数据分区或分片算法通常是Range和Hash，RheaKV通过Range进行数据分片，分成一个个RaftGroup，也称为Region。</p>
<p>因为Range切分是对Key进行字节排序后再切分，像类似Scan等操作对相近Key的查询会尽可能集中在某个Region，这个Hash无法支持。</p>
<p>拆分单个Region也更好处理，只用修改部分元数据，不会涉及到大范围的数据挪动。</p>
<p>Range有一个问题就是，可能某个Region被频繁操作成为热点Region，可以通过PD调度热点Region到更空闲的机器上，或者提供Follower分担读的压力等。</p>
<hr>
<p>Client和Server的初始化</p>
<p>DefaultRheaKVStore#init</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">boolean</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">final</span> RheaKVStoreOptions opts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>opts <span class="token operator">=</span> opts<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// init placement driver</span>
        <span class="token keyword">final</span> PlacementDriverOptions pdOpts <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">getPlacementDriverOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> String clusterName <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">getClusterName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// 根据PlacementDriverClient选项实例化PlacementDriverClient</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pdOpts<span class="token punctuation">.</span><span class="token function">isFake</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>pdClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FakePlacementDriverClient</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span><span class="token function">getClusterId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> clusterName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ClusterId：PlacementDriverServer根据ClusterId隔离不同的Cluster，Fake模式不需要</span>
            <span class="token comment" spellcheck="true">// ClusterName：每个Store节点包含一个或多个RaftGroup，RaftGroup根据ClusterName-RegionId命名</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>pdClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RemotePlacementDriverClient</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span><span class="token function">getClusterId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> clusterName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 初始化PDClient</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>pdClient<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>pdOpts<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 存储引擎选项，一般是Server节点才有配置</span>
        <span class="token keyword">final</span> StoreEngineOptions stOpts <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">getStoreEngineOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>stOpts <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Server节点地址列表</span>
            stOpts<span class="token punctuation">.</span><span class="token function">setInitialServerList</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span><span class="token function">getInitialServerList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 根据存储引擎选项实例化存储引擎并初始化</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>storeEngine <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StoreEngine</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pdClient<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>stateListenerContainer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>storeEngine<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>stOpts<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 当前存储节点自身的IP和端口号</span>
        <span class="token keyword">final</span> Endpoint selfEndpoint <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>storeEngine <span class="token operator">==</span> null <span class="token operator">?</span> null <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>storeEngine<span class="token punctuation">.</span><span class="token function">getSelfEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> RpcOptions rpcOpts <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">getRpcOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// 实例化RpcService</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>rheaKVRpcService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultRheaKVRpcService</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pdClient<span class="token punctuation">,</span> selfEndpoint<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 重写了getLeader方法</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> Endpoint <span class="token function">getLeader</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">long</span> regionId<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> forceRefresh<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> timeoutMillis<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 先根据RegionId查找Leader</span>
                <span class="token keyword">final</span> Endpoint leader <span class="token operator">=</span> <span class="token function">getLeaderByRegionEngine</span><span class="token punctuation">(</span>regionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>leader <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> leader<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 找不到再调用父类的方法</span>
                <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getLeader</span><span class="token punctuation">(</span>regionId<span class="token punctuation">,</span> forceRefresh<span class="token punctuation">,</span> timeoutMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 初始化RpcService</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>rheaKVRpcService<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>rpcOpts<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 重试次数，默认2</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>failoverRetries <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">getFailoverRetries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 等待超时，默认5000毫秒</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>futureTimeoutMillis <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">getFutureTimeoutMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 是否只从Leader读，默认是</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>onlyLeaderRead <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">isOnlyLeaderRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 默认使用并行处理器，可以理解为提交给线程池并发执行</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span><span class="token function">isUseParallelKVExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> numWorkers <span class="token operator">=</span> Utils<span class="token punctuation">.</span><span class="token function">cpus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 左移4位，等于乘以2^4</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> bufSize <span class="token operator">=</span> numWorkers <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> String name <span class="token operator">=</span> <span class="token string">"parallel-kv-executor"</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> ThreadFactory threadFactory <span class="token operator">=</span> Constants<span class="token punctuation">.</span>THREAD_AFFINITY_ENABLED <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">AffinityNamedThreadFactory</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">NamedThreadFactory</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 启动Disruptor</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>kvDispatcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TaskDispatcher</span><span class="token punctuation">(</span>bufSize<span class="token punctuation">,</span> numWorkers<span class="token punctuation">,</span> WaitStrategyType<span class="token punctuation">.</span>LITE_BLOCKING_WAIT<span class="token punctuation">,</span> threadFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>batchingOpts <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">getBatchingOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 默认允许批处理</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>batchingOpts<span class="token punctuation">.</span><span class="token function">isAllowBatching</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 批量Get处理器</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>getBatching <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetBatching</span><span class="token punctuation">(</span>KeyEvent<span class="token operator">:</span><span class="token operator">:</span><span class="token keyword">new</span><span class="token punctuation">,</span> <span class="token string">"get_batching"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">GetBatchingHandler</span><span class="token punctuation">(</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 一致性读的批量Get处理器</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>getBatchingOnlySafe <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GetBatching</span><span class="token punctuation">(</span>KeyEvent<span class="token operator">:</span><span class="token operator">:</span><span class="token keyword">new</span><span class="token punctuation">,</span> <span class="token string">"get_batching_only_safe"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">GetBatchingHandler</span><span class="token punctuation">(</span><span class="token string">"get_only_safe"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 批量Put处理器，PutBatchingHandler</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>putBatching <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PutBatching</span><span class="token punctuation">(</span>KVEvent<span class="token operator">:</span><span class="token operator">:</span><span class="token keyword">new</span><span class="token punctuation">,</span> <span class="token string">"put_batching"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">PutBatchingHandler</span><span class="token punctuation">(</span><span class="token string">"put"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>started <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>初始化PlacementDriverClient</p>
<p>AbstractPlacementDriverClient#init</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">boolean</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">final</span> PlacementDriverOptions opts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 初始化RpcClient，连接Server节点，初始化CliService，用于集群节点的增删改查等管理操作</span>
        <span class="token function">initCli</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span><span class="token function">getCliOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// RPC的回调相关</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>pdRpcService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultPlacementDriverRpcService</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        RpcOptions rpcOpts <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">getPdRpcOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>pdRpcService<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>rpcOpts<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 一个Region对应一个RegionRouteTableOptions，存放键区间等配置</span>
        <span class="token keyword">final</span> List<span class="token operator">&lt;</span>RegionRouteTableOptions<span class="token operator">></span> regionRouteTableOptionsList <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">getRegionRouteTableOptionsList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>regionRouteTableOptionsList <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> String initialServerList <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">getInitialServerList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> RegionRouteTableOptions regionRouteTableOpts <span class="token operator">:</span> regionRouteTableOptionsList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
                <span class="token comment" spellcheck="true">// 初始化Region的路由表</span>
                <span class="token function">initRouteTableByRegion</span><span class="token punctuation">(</span>regionRouteTableOpts<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>AbstractPlacementDriverClient#initRouteTableByRegion</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initRouteTableByRegion</span><span class="token punctuation">(</span><span class="token keyword">final</span> RegionRouteTableOptions opts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> regionId <span class="token operator">=</span> Requires<span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span><span class="token function">getRegionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"opts.regionId"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> startKey <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">getStartKeyBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> endKey <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">getEndKeyBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> String initialServerList <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">getInitialServerList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Region</span>
        <span class="token keyword">final</span> Region region <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Region</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Region的节点配置</span>
        <span class="token keyword">final</span> Configuration conf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// RegionId</span>
        region<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>regionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 左端点</span>
        region<span class="token punctuation">.</span><span class="token function">setStartKey</span><span class="token punctuation">(</span>startKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 右端点</span>
        region<span class="token punctuation">.</span><span class="token function">setEndKey</span><span class="token punctuation">(</span>endKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 版本号</span>
        region<span class="token punctuation">.</span><span class="token function">setRegionEpoch</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RegionEpoch</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// peers</span>
        <span class="token comment" spellcheck="true">// ...</span>
        conf<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>initialServerList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Region的同辈节点</span>
        region<span class="token punctuation">.</span><span class="token function">setPeers</span><span class="token punctuation">(</span>JRaftHelper<span class="token punctuation">.</span><span class="token function">toPeerList</span><span class="token punctuation">(</span>conf<span class="token punctuation">.</span><span class="token function">listPeers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 更新该Region/RaftGroup的Configuration</span>
        RouteTable<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">updateConfiguration</span><span class="token punctuation">(</span>JRaftHelper<span class="token punctuation">.</span><span class="token function">getJRaftGroupId</span><span class="token punctuation">(</span>clusterName<span class="token punctuation">,</span> regionId<span class="token punctuation">)</span><span class="token punctuation">,</span> conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 更新区间映射</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>regionRouteTable<span class="token punctuation">.</span><span class="token function">addOrUpdateRegion</span><span class="token punctuation">(</span>region<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>RouteTable#updateConfiguration</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">updateConfiguration</span><span class="token punctuation">(</span><span class="token keyword">final</span> String groupId<span class="token punctuation">,</span> <span class="token keyword">final</span> Configuration conf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// 该集群的GroupConf</span>
        <span class="token keyword">final</span> GroupConf gc <span class="token operator">=</span> <span class="token function">getOrCreateGroupConf</span><span class="token punctuation">(</span>groupId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 比ReentrantReadWriteLock消耗少，但是不可重入</span>
        <span class="token keyword">final</span> StampedLock stampedLock <span class="token operator">=</span> gc<span class="token punctuation">.</span>stampedLock<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 获取写锁，返回Stamp，0表示没有写锁</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> stamp <span class="token operator">=</span> stampedLock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 更新集群的配置</span>
            gc<span class="token punctuation">.</span>conf <span class="token operator">=</span> conf<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>gc<span class="token punctuation">.</span>leader <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>gc<span class="token punctuation">.</span>conf<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>gc<span class="token punctuation">.</span>leader<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                gc<span class="token punctuation">.</span>leader <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            stampedLock<span class="token punctuation">.</span><span class="token function">unlockWrite</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>RegionRouteTable#addOrUpdateRegion</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addOrUpdateRegion</span><span class="token punctuation">(</span><span class="token keyword">final</span> Region region<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> regionId <span class="token operator">=</span> region<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> startKey <span class="token operator">=</span> BytesUtil<span class="token punctuation">.</span><span class="token function">nullToEmpty</span><span class="token punctuation">(</span>region<span class="token punctuation">.</span><span class="token function">getStartKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> StampedLock stampedLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>stampedLock<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> stamp <span class="token operator">=</span> stampedLock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// RegionId，Region</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>regionTable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>regionId<span class="token punctuation">,</span> region<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// TreeMap，左端点，RegionId</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>rangeTable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>startKey<span class="token punctuation">,</span> regionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            stampedLock<span class="token punctuation">.</span><span class="token function">unlockWrite</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>StoreEngine#init</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">boolean</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">final</span> StoreEngineOptions opts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>storeOpts <span class="token operator">=</span> Requires<span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>opts<span class="token punctuation">,</span> <span class="token string">"opts"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Endpoint serverAddress <span class="token operator">=</span> Requires<span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span><span class="token function">getServerAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"opts.serverAddress"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> port <span class="token operator">=</span> serverAddress<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> String ip <span class="token operator">=</span> serverAddress<span class="token punctuation">.</span><span class="token function">getIp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 没有设置就使用当前主机的地址</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ip <span class="token operator">==</span> null <span class="token operator">||</span> Utils<span class="token punctuation">.</span>IP_ANY<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ...</span>
        List<span class="token operator">&lt;</span>RegionEngineOptions<span class="token operator">></span> rOptsList <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">getRegionEngineOptionsList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 如果RegionEngine选项为空，初始化一个默认的RegionEngine</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rOptsList <span class="token operator">==</span> null <span class="token operator">||</span> rOptsList<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 集群名</span>
        <span class="token keyword">final</span> String clusterName <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pdClient<span class="token punctuation">.</span><span class="token function">getClusterName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 遍历所有RegionEngine选项，设置参数</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> RegionEngineOptions rOpts <span class="token operator">:</span> rOptsList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// RaftGroup</span>
            rOpts<span class="token punctuation">.</span><span class="token function">setRaftGroupId</span><span class="token punctuation">(</span>JRaftHelper<span class="token punctuation">.</span><span class="token function">getJRaftGroupId</span><span class="token punctuation">(</span>clusterName<span class="token punctuation">,</span> rOpts<span class="token punctuation">.</span><span class="token function">getRegionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 当前Server节点的地址</span>
            rOpts<span class="token punctuation">.</span><span class="token function">setServerAddress</span><span class="token punctuation">(</span>serverAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 所有同辈节点的地址列表</span>
            rOpts<span class="token punctuation">.</span><span class="token function">setInitialServerList</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span><span class="token function">getInitialServerList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 初始化Store和该Store下面的Region列表</span>
        <span class="token keyword">final</span> Store store <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pdClient<span class="token punctuation">.</span><span class="token function">getStoreMetadata</span><span class="token punctuation">(</span>opts<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>storeId <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 初始化执行器</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>readIndexExecutor <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>raftStateTrigger <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>snapshotExecutor <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> useSharedRpcExecutor <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">isUseSharedRpcExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 如果不共用RPC线程池，则初始化各自的线程池</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>useSharedRpcExecutor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 性能监控</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// 初始化RPC服务器</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>rpcServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RpcServer</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 添加Raft相关的请求处理器</span>
        RaftRpcServerFactory<span class="token punctuation">.</span><span class="token function">addRaftRequestProcessors</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>rpcServer<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>raftRpcExecutor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cliRpcExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 添加键值存储相关的请求处理器，KVCommandProcessor</span>
        StoreEngineHelper<span class="token punctuation">.</span><span class="token function">addKvStoreRequestProcessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>rpcServer<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 启动RPC服务器</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>rpcServer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 根据类型初始化RawKVStore数据库，RocksDB或ConcurrentSkipListMap</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">initRawKVStore</span><span class="token punctuation">(</span>opts<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// 为该Store下的所有Region初始化RegionEngine</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">initAllRegionEngine</span><span class="token punctuation">(</span>opts<span class="token punctuation">,</span> store<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 如果启用了自管理的集群，需要初始化一个HeartbeatSender</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pdClient <span class="token keyword">instanceof</span> <span class="token class-name">RemotePlacementDriverClient</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>started <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>FakePlacementDriverClient#getStoreMetadata</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> Store <span class="token function">getStoreMetadata</span><span class="token punctuation">(</span><span class="token keyword">final</span> StoreEngineOptions opts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> Store store <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Store</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> List<span class="token operator">&lt;</span>RegionEngineOptions<span class="token operator">></span> rOptsList <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">getRegionEngineOptionsList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> List<span class="token operator">&lt;</span>Region<span class="token operator">></span> regionList <span class="token operator">=</span> Lists<span class="token punctuation">.</span><span class="token function">newArrayListWithCapacity</span><span class="token punctuation">(</span>rOptsList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 对于Fake来说，Store不需要Id</span>
        store<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        store<span class="token punctuation">.</span><span class="token function">setEndpoint</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span><span class="token function">getServerAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> RegionEngineOptions rOpts <span class="token operator">:</span> rOptsList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 根据RegionEngineOptions更新路由</span>
            regionList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">getLocalRegionMetadata</span><span class="token punctuation">(</span>rOpts<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 设置该Store下的Region列表</span>
        store<span class="token punctuation">.</span><span class="token function">setRegions</span><span class="token punctuation">(</span>regionList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> store<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>StoreEngine#initAllRegionEngine</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">initAllRegionEngine</span><span class="token punctuation">(</span><span class="token keyword">final</span> StoreEngineOptions opts<span class="token punctuation">,</span> <span class="token keyword">final</span> Store store<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        String baseRaftDataPath <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">getRaftDataPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Strings<span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>baseRaftDataPath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">final</span> Endpoint serverAddress <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">getServerAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> List<span class="token operator">&lt;</span>RegionEngineOptions<span class="token operator">></span> rOptsList <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">getRegionEngineOptionsList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> List<span class="token operator">&lt;</span>Region<span class="token operator">></span> regionList <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token function">getRegions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 先校验RegionEngineOptions和Region数量是否一致</span>
        Requires<span class="token punctuation">.</span><span class="token function">requireTrue</span><span class="token punctuation">(</span>rOptsList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> regionList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> rOptsList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 对应的RegionEngineOptions</span>
            <span class="token keyword">final</span> RegionEngineOptions rOpts <span class="token operator">=</span> rOptsList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 对应的Region</span>
            <span class="token keyword">final</span> Region region <span class="token operator">=</span> regionList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 路径为空的就设置一个默认值</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>Strings<span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>rOpts<span class="token punctuation">.</span><span class="token function">getRaftDataPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// 初始化该Region的RegionEngine</span>
            <span class="token keyword">final</span> RegionEngine engine <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegionEngine</span><span class="token punctuation">(</span>region<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>engine<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>rOpts<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 一个RegionEngine一个RegionKVService</span>
                <span class="token keyword">final</span> RegionKVService regionKVService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultRegionKVService</span><span class="token punctuation">(</span>engine<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 关联RegionId和RegionKVService</span>
                <span class="token function">registerRegionKVService</span><span class="token punctuation">(</span>regionKVService<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 关联RegionId和RegionEngine</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>regionEngineTable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>region<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> engine<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>RegionEngine#init</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">boolean</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">final</span> RegionEngineOptions opts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>regionOpts <span class="token operator">=</span> Requires<span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>opts<span class="token punctuation">,</span> <span class="token string">"opts"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 实例化状态机</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fsm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KVStoreStateMachine</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>region<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>storeEngine<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// node options</span>
        NodeOptions nodeOpts <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">getNodeOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        nodeOpts<span class="token punctuation">.</span><span class="token function">setInitialConf</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span>JRaftHelper<span class="token punctuation">.</span><span class="token function">toJRaftPeerIdList</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>region<span class="token punctuation">.</span><span class="token function">getPeers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        nodeOpts<span class="token punctuation">.</span><span class="token function">setFsm</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fsm<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> String raftDataPath <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">getRaftDataPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 各种路径</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">final</span> Endpoint serverAddress <span class="token operator">=</span> opts<span class="token punctuation">.</span><span class="token function">getServerAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> PeerId serverId <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PeerId</span><span class="token punctuation">(</span>serverAddress<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> RpcServer rpcServer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>storeEngine<span class="token punctuation">.</span><span class="token function">getRpcServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>raftGroupService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RaftGroupService</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span><span class="token function">getRaftGroupId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> serverId<span class="token punctuation">,</span> nodeOpts<span class="token punctuation">,</span> rpcServer<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 初始化并启动JRaft节点</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>node <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>raftGroupService<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        RouteTable<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">updateConfiguration</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>raftGroupService<span class="token punctuation">.</span><span class="token function">getGroupId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nodeOpts<span class="token punctuation">.</span><span class="token function">getInitialConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>node <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> RawKVStore rawKVStore <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>storeEngine<span class="token punctuation">.</span><span class="token function">getRawKVStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> Executor readIndexExecutor <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>storeEngine<span class="token punctuation">.</span><span class="token function">getReadIndexExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 重点</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>raftRawKVStore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RaftRawKVStore</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>node<span class="token punctuation">,</span> rawKVStore<span class="token punctuation">,</span> readIndexExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>metricsRawKVStore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MetricsRawKVStore</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>region<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>raftRawKVStore<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 一些监控配置</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>started <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>started<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>DefaultRheaKVStore#put</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> CompletableFuture<span class="token operator">&lt;</span>Boolean<span class="token operator">></span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> value<span class="token punctuation">,</span> <span class="token keyword">final</span> CompletableFuture<span class="token operator">&lt;</span>Boolean<span class="token operator">></span> future<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> tryBatching<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">checkState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 尝试批量操作</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tryBatching<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> PutBatching putBatching <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>putBatching<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 发布到PutBatching实例的RingBuffer</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>putBatching <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> putBatching<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">KVEntry</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">,</span> future<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> future<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 直接加入</span>
        <span class="token function">internalPut</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> future<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>failoverRetries<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> future<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>DefaultRheaKVStore$PutBatchingHandler#onEvent</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onEvent</span><span class="token punctuation">(</span><span class="token keyword">final</span> KVEvent event<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> sequence<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> endOfBatch<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 先把Put请求加入事件列表</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 累计键和值的长度</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>cachedBytes <span class="token operator">+=</span> event<span class="token punctuation">.</span>kvEntry<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 是否执行批处理</span>
            <span class="token comment" spellcheck="true">// 没有批处理标记 &amp;&amp; 没达到批处理累计数量 &amp;&amp; 累计的键值长度不够多</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>endOfBatch <span class="token operator">&amp;&amp;</span> size <span class="token operator">&lt;</span> batchingOpts<span class="token punctuation">.</span><span class="token function">getBatchSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cachedBytes <span class="token operator">&lt;</span> batchingOpts<span class="token punctuation">.</span><span class="token function">getMaxWriteBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 只有一条</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 先重置清空事件列表和累计的键值长度</span>
                <span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 当前事件</span>
                <span class="token keyword">final</span> KVEntry kv <span class="token operator">=</span> event<span class="token punctuation">.</span>kvEntry<span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 再次执行Put，注意这里不会尝试Batching，而是进入DefaultRheaKVStore#internalPut</span>
                    <span class="token function">put</span><span class="token punctuation">(</span>kv<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kv<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>future<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">final</span> Throwable t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 异常回调</span>
                    <span class="token function">exceptionally</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> event<span class="token punctuation">.</span>future<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 累积有多条</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> List<span class="token operator">&lt;</span>KVEntry<span class="token operator">></span> entries <span class="token operator">=</span> Lists<span class="token punctuation">.</span><span class="token function">newArrayListWithCapacity</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> CompletableFuture<span class="token operator">&lt;</span>Boolean<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> futures <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">[</span>size<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> KVEvent e <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    entries<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>kvEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// 一个事件一个Future</span>
                    futures<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">.</span>future<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 重置</span>
                <span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 批量执行</span>
                    <span class="token function">put</span><span class="token punctuation">(</span>entries<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">whenComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> throwable<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 成功</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>throwable <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> futures<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token comment" spellcheck="true">// 回调</span>
                                futures<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            <span class="token keyword">return</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment" spellcheck="true">// 异常回调</span>
                        <span class="token function">exceptionally</span><span class="token punctuation">(</span>throwable<span class="token punctuation">,</span> futures<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">final</span> Throwable t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 异常回调</span>
                    <span class="token function">exceptionally</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> futures<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span></code></pre>
<p>DefaultRheaKVStore#internalPut</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">internalPut</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> value<span class="token punctuation">,</span> <span class="token keyword">final</span> CompletableFuture<span class="token operator">&lt;</span>Boolean<span class="token operator">></span> future<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> retriesLeft<span class="token punctuation">,</span> <span class="token keyword">final</span> Errors lastCause<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 根据Key查询Region</span>
        <span class="token keyword">final</span> Region region <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pdClient<span class="token punctuation">.</span><span class="token function">findRegionByKey</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> ErrorsHelper<span class="token punctuation">.</span><span class="token function">isInvalidEpoch</span><span class="token punctuation">(</span>lastCause<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 获取该Region的RegionEngine，如果不是Leader，返回null</span>
        <span class="token keyword">final</span> RegionEngine regionEngine <span class="token operator">=</span> <span class="token function">getRegionEngine</span><span class="token punctuation">(</span>region<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 失败重试函数</span>
        <span class="token keyword">final</span> RetryRunner retryRunner <span class="token operator">=</span> retryCause <span class="token operator">-</span><span class="token operator">></span> <span class="token function">internalPut</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> future<span class="token punctuation">,</span> retriesLeft <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> retryCause<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 失败回调</span>
        <span class="token keyword">final</span> FailoverClosure<span class="token operator">&lt;</span>Boolean<span class="token operator">></span> closure <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FailoverClosureImpl</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>future<span class="token punctuation">,</span> retriesLeft<span class="token punctuation">,</span> retryRunner<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 路由缓存的节点是Leader</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>regionEngine <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 确保Region和RegionEngine的Epoch一致</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ensureOnValidEpoch</span><span class="token punctuation">(</span>region<span class="token punctuation">,</span> regionEngine<span class="token punctuation">,</span> closure<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 直接执行，RawKVStore#Put</span>
                <span class="token function">getRawKVStore</span><span class="token punctuation">(</span>regionEngine<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> closure<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 路由缓存的节点不是Leader</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> PutRequest request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PutRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            request<span class="token punctuation">.</span><span class="token function">setKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            request<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            request<span class="token punctuation">.</span><span class="token function">setRegionId</span><span class="token punctuation">(</span>region<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            request<span class="token punctuation">.</span><span class="token function">setRegionEpoch</span><span class="token punctuation">(</span>region<span class="token punctuation">.</span><span class="token function">getRegionEpoch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// RPC交给Leader执行</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>rheaKVRpcService<span class="token punctuation">.</span><span class="token function">callAsyncWithRpc</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> closure<span class="token punctuation">,</span> lastCause<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>AbstractPlacementDriverClient#findRegionByKey</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> Region <span class="token function">findRegionByKey</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> forceRefresh<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>forceRefresh<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 模板方法，更新路由表，FakePlacementDriverClient的实现为空，NO-OP，因为是固定的</span>
            <span class="token function">refreshRouteTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 从路由表查</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>regionRouteTable<span class="token punctuation">.</span><span class="token function">findRegionByKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>RegionRouteTable#findRegionByKey</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> Region <span class="token function">findRegionByKey</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">final</span> StampedLock stampedLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>stampedLock<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> stamp <span class="token operator">=</span> stampedLock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">findRegionByKeyWithoutLock</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            stampedLock<span class="token punctuation">.</span><span class="token function">unlockRead</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>RegionRouteTable#findRegionByKeyWithoutLock</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> Region <span class="token function">findRegionByKeyWithoutLock</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 范围表是一个TreeMap，保存了Region的StartKey和RegionId的映射</span>
        <span class="token comment" spellcheck="true">// 返回的是StartKey小于等于Key的第一个RegionId</span>
        <span class="token keyword">final</span> Map<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> Long<span class="token operator">></span> entry <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rangeTable<span class="token punctuation">.</span><span class="token function">floorEntry</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>entry <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 根据RegionId查找Region</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>regionTable<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>DefaultRheaKVRpcService#callAsyncWithRpc</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token operator">&lt;</span>V<span class="token operator">></span> CompletableFuture<span class="token operator">&lt;</span>V<span class="token operator">></span> <span class="token function">callAsyncWithRpc</span><span class="token punctuation">(</span><span class="token keyword">final</span> BaseRequest request<span class="token punctuation">,</span> <span class="token keyword">final</span> FailoverClosure<span class="token operator">&lt;</span>V<span class="token operator">></span> closure<span class="token punctuation">,</span> <span class="token keyword">final</span> Errors lastCause<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> requireLeader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> forceRefresh <span class="token operator">=</span> ErrorsHelper<span class="token punctuation">.</span><span class="token function">isInvalidPeer</span><span class="token punctuation">(</span>lastCause<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 根据RegionId和是否需要Leader返回端点</span>
        <span class="token keyword">final</span> Endpoint endpoint <span class="token operator">=</span> <span class="token function">getRpcEndpoint</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getRegionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> forceRefresh<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rpcTimeoutMillis<span class="token punctuation">,</span> requireLeader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 执行RPC</span>
        <span class="token function">internalCallAsyncWithRpc</span><span class="token punctuation">(</span>endpoint<span class="token punctuation">,</span> request<span class="token punctuation">,</span> closure<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> closure<span class="token punctuation">.</span><span class="token function">future</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>DefaultRheaKVRpcService#getRpcEndpoint</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> Endpoint <span class="token function">getRpcEndpoint</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">long</span> regionId<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> forceRefresh<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> timeoutMillis<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> requireLeader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>requireLeader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 获取Leader</span>
            <span class="token keyword">return</span> <span class="token function">getLeader</span><span class="token punctuation">(</span>regionId<span class="token punctuation">,</span> forceRefresh<span class="token punctuation">,</span> timeoutMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 返回一个不是自己的节点</span>
            <span class="token keyword">return</span> <span class="token function">getLuckyPeer</span><span class="token punctuation">(</span>regionId<span class="token punctuation">,</span> forceRefresh<span class="token punctuation">,</span> timeoutMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>DefaultRheaKVStore$DefaultRheaKVRpcService#getLeader</p>
<pre class=" language-java"><code class="language-java">            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> Endpoint <span class="token function">getLeader</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">long</span> regionId<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> forceRefresh<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> timeoutMillis<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 先根据RegionId查找Leader</span>
                <span class="token keyword">final</span> Endpoint leader <span class="token operator">=</span> <span class="token function">getLeaderByRegionEngine</span><span class="token punctuation">(</span>regionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>leader <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> leader<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 找不到再调用父类的方法</span>
                <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getLeader</span><span class="token punctuation">(</span>regionId<span class="token punctuation">,</span> forceRefresh<span class="token punctuation">,</span> timeoutMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span></code></pre>
<p>DefaultRheaKVStore#getLeaderByRegionEngine</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> Endpoint <span class="token function">getLeaderByRegionEngine</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">long</span> regionId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Client没有初始化RegionEngine</span>
        <span class="token keyword">final</span> RegionEngine regionEngine <span class="token operator">=</span> <span class="token function">getRegionEngine</span><span class="token punctuation">(</span>regionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Server有配置</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>regionEngine <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> PeerId leader <span class="token operator">=</span> regionEngine<span class="token punctuation">.</span><span class="token function">getLeaderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>leader <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> String raftGroupId <span class="token operator">=</span> JRaftHelper<span class="token punctuation">.</span><span class="token function">getJRaftGroupId</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pdClient<span class="token punctuation">.</span><span class="token function">getClusterName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> regionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                RouteTable<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">updateLeader</span><span class="token punctuation">(</span>raftGroupId<span class="token punctuation">,</span> leader<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> leader<span class="token punctuation">.</span><span class="token function">getEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>AbstractPlacementDriverClient#getLeader</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> Endpoint <span class="token function">getLeader</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">long</span> regionId<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> forceRefresh<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> timeoutMillis<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// RaftGroupId，由ClusterName和RegionId拼接得</span>
        <span class="token keyword">final</span> String raftGroupId <span class="token operator">=</span> JRaftHelper<span class="token punctuation">.</span><span class="token function">getJRaftGroupId</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>clusterName<span class="token punctuation">,</span> regionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 先从缓存找</span>
        PeerId leader <span class="token operator">=</span> <span class="token function">getLeader</span><span class="token punctuation">(</span>raftGroupId<span class="token punctuation">,</span> forceRefresh<span class="token punctuation">,</span> timeoutMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 缓存没找到，之前也没有刷新缓存</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>leader <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>forceRefresh<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 刷新缓存再找</span>
            leader <span class="token operator">=</span> <span class="token function">getLeader</span><span class="token punctuation">(</span>raftGroupId<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> timeoutMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>leader <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> leader<span class="token punctuation">.</span><span class="token function">getEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>AbstractPlacementDriverClient#getLeader</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">protected</span> PeerId <span class="token function">getLeader</span><span class="token punctuation">(</span><span class="token keyword">final</span> String raftGroupId<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> forceRefresh<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> timeoutMillis<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> RouteTable routeTable <span class="token operator">=</span> RouteTable<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 如果要强制刷新缓存</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>forceRefresh<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> deadline <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> timeoutMillis<span class="token punctuation">;</span>
            <span class="token keyword">final</span> StringBuilder error <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Throwable lastCause <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 阻塞刷新至超时或唤醒</span>
                    <span class="token keyword">final</span> Status st <span class="token operator">=</span> routeTable<span class="token punctuation">.</span><span class="token function">refreshLeader</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cliClientService<span class="token punctuation">,</span> raftGroupId<span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>st<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">final</span> InterruptedException e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">final</span> Throwable t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 如果没到截止时间，还可以继续刷新</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> deadline<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 超时抛异常</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 从缓存获取返回</span>
        <span class="token keyword">return</span> routeTable<span class="token punctuation">.</span><span class="token function">selectLeader</span><span class="token punctuation">(</span>raftGroupId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>RouteTable#refreshLeader</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> Status <span class="token function">refreshLeader</span><span class="token punctuation">(</span><span class="token keyword">final</span> CliClientService cliClientService<span class="token punctuation">,</span> <span class="token keyword">final</span> String groupId<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> timeoutMs<span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException<span class="token punctuation">,</span> TimeoutException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">final</span> Configuration conf <span class="token operator">=</span> <span class="token function">getConfiguration</span><span class="token punctuation">(</span>groupId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">final</span> Status st <span class="token operator">=</span> Status<span class="token punctuation">.</span><span class="token function">OK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Protobuf</span>
        <span class="token keyword">final</span> CliRequests<span class="token punctuation">.</span>GetLeaderRequest<span class="token punctuation">.</span>Builder rb <span class="token operator">=</span> CliRequests<span class="token punctuation">.</span>GetLeaderRequest<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rb<span class="token punctuation">.</span><span class="token function">setGroupId</span><span class="token punctuation">(</span>groupId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 创建一个获取Leader的请求</span>
        <span class="token keyword">final</span> CliRequests<span class="token punctuation">.</span>GetLeaderRequest request <span class="token operator">=</span> rb<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        TimeoutException timeoutException <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 遍历所有配置的节点</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> PeerId peer <span class="token operator">:</span> conf<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 尝试连接</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cliClientService<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>peer<span class="token punctuation">.</span><span class="token function">getEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
                <span class="token comment" spellcheck="true">// 跳过没有连接的节点</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 发送获取Leader请求</span>
            <span class="token keyword">final</span> Future<span class="token operator">&lt;</span>Message<span class="token operator">></span> result <span class="token operator">=</span> cliClientService<span class="token punctuation">.</span><span class="token function">getLeader</span><span class="token punctuation">(</span>peer<span class="token punctuation">.</span><span class="token function">getEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> Message msg <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>timeoutMs<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>msg <span class="token keyword">instanceof</span> <span class="token class-name">RpcRequests<span class="token punctuation">.</span>ErrorResponse</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> CliRequests<span class="token punctuation">.</span>GetLeaderResponse response <span class="token operator">=</span> <span class="token punctuation">(</span>CliRequests<span class="token punctuation">.</span>GetLeaderResponse<span class="token punctuation">)</span> msg<span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// 更新Leader信息</span>
                    <span class="token function">updateLeader</span><span class="token punctuation">(</span>groupId<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">getLeaderId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// 只要有一个节点返回Leader信息就好</span>
                    <span class="token keyword">return</span> Status<span class="token punctuation">.</span><span class="token function">OK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">final</span> TimeoutException e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">final</span> ExecutionException e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>timeoutException <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> timeoutException<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> st<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>RouteTable#selectLeader</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> PeerId <span class="token function">selectLeader</span><span class="token punctuation">(</span><span class="token keyword">final</span> String groupId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">final</span> GroupConf gc <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>groupConfTable<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>groupId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">final</span> StampedLock stampedLock <span class="token operator">=</span> gc<span class="token punctuation">.</span>stampedLock<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 读锁分悲观模式和乐观模式，这里是获取乐观读锁</span>
        <span class="token keyword">long</span> stamp <span class="token operator">=</span> stampedLock<span class="token punctuation">.</span><span class="token function">tryOptimisticRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        PeerId leader <span class="token operator">=</span> gc<span class="token punctuation">.</span>leader<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 如果获取乐观读锁后发生了写锁</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>stampedLock<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 升级为悲观读锁</span>
            stamp <span class="token operator">=</span> stampedLock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 重新再获取一次变量</span>
                leader <span class="token operator">=</span> gc<span class="token punctuation">.</span>leader<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                stampedLock<span class="token punctuation">.</span><span class="token function">unlockRead</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> leader<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>对于批量Put，也是类似，但是默认是发布到Disruptor，由线程池异步消费。</p>
<p>另外，如果多个键跨了多个Region，不保证事务。</p>
<p>RaftRawKVStore#put</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> value<span class="token punctuation">,</span> <span class="token keyword">final</span> KVStoreClosure closure<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 包装一个Operation，并应用</span>
        <span class="token function">applyOperation</span><span class="token punctuation">(</span>KVOperation<span class="token punctuation">.</span><span class="token function">createPut</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">,</span> closure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>RaftRawKVStore#applyOperation</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">applyOperation</span><span class="token punctuation">(</span><span class="token keyword">final</span> KVOperation op<span class="token punctuation">,</span> <span class="token keyword">final</span> KVStoreClosure closure<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 必须保证当前操作的节点是Leader</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 创建任务</span>
        <span class="token keyword">final</span> Task task <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        task<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>ByteBuffer<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>Serializers<span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        task<span class="token punctuation">.</span><span class="token function">setDone</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">KVClosureAdapter</span><span class="token punctuation">(</span>closure<span class="token punctuation">,</span> op<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 发布日志</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>node<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>DefaultRheaKVStore#get</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> CompletableFuture<span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> readOnlySafe<span class="token punctuation">,</span> <span class="token keyword">final</span> CompletableFuture<span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> future<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> tryBatching<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// 尝试批量</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tryBatching<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 是否使用一致性读</span>
            <span class="token keyword">final</span> GetBatching getBatching <span class="token operator">=</span> readOnlySafe <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>getBatchingOnlySafe <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>getBatching<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 发布到RingBuffer</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>getBatching <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> getBatching<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> future<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> future<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 直接获取</span>
        <span class="token function">internalGet</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> readOnlySafe<span class="token punctuation">,</span> future<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>failoverRetries<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onlyLeaderRead<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> future<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>DefaultRheaKVStore$GetBatchingHandler#onEvent</p>
<p>Get基本和Put一致，不加注释了</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onEvent</span><span class="token punctuation">(</span><span class="token keyword">final</span> KeyEvent event<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> sequence<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> endOfBatch<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>cachedBytes <span class="token operator">+=</span> event<span class="token punctuation">.</span>key<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>endOfBatch <span class="token operator">&amp;&amp;</span> size <span class="token operator">&lt;</span> batchingOpts<span class="token punctuation">.</span><span class="token function">getBatchSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cachedBytes <span class="token operator">&lt;</span> batchingOpts<span class="token punctuation">.</span><span class="token function">getMaxReadBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token function">get</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>key<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>readOnlySafe<span class="token punctuation">,</span> event<span class="token punctuation">.</span>future<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">final</span> Throwable t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">exceptionally</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> event<span class="token punctuation">.</span>future<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> List<span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> keys <span class="token operator">=</span> Lists<span class="token punctuation">.</span><span class="token function">newArrayListWithCapacity</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> CompletableFuture<span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> futures <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CompletableFuture</span><span class="token punctuation">[</span>size<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> KeyEvent e <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>events<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    keys<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    futures<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">.</span>future<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token function">multiGet</span><span class="token punctuation">(</span>keys<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>readOnlySafe<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">whenComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> throwable<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>throwable <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> futures<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">final</span> ByteArray realKey <span class="token operator">=</span> ByteArray<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>keys<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                futures<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>realKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            <span class="token keyword">return</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token function">exceptionally</span><span class="token punctuation">(</span>throwable<span class="token punctuation">,</span> futures<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">final</span> Throwable t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">exceptionally</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> futures<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span></code></pre>
<p>剩下基本和Put一样，不贴了。</p>
<p>RaftRawKVStore#get</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> readOnlySafe<span class="token punctuation">,</span> <span class="token keyword">final</span> KVStoreClosure closure<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 如果不需要一致性读，那就直接读本地数据</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>readOnlySafe<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>kvStore<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> closure<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Raft一致性读</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>node<span class="token punctuation">.</span><span class="token function">readIndex</span><span class="token punctuation">(</span>BytesUtil<span class="token punctuation">.</span>EMPTY_BYTES<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ReadIndexClosure</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">final</span> Status status<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> index<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> reqCtx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 确认应用了才能读本地数据</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    RaftRawKVStore<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>kvStore<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> closure<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 失败的情况</span>
                RaftRawKVStore<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>readIndexExecutor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 如果当前节点是Leader，可能是没收到足够Follower的响应，因此不能应用到状态机</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 再发布一个GET的日志，尝试应用到状态机</span>
                        <span class="token function">applyOperation</span><span class="token punctuation">(</span>KVOperation<span class="token punctuation">.</span><span class="token function">createGet</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> closure<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> 
                    <span class="token comment" spellcheck="true">// 当前节点是Follower</span>
                    <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// Client执行失败回调，重试</span>
                        <span class="token keyword">new</span> <span class="token class-name">KVClosureAdapter</span><span class="token punctuation">(</span>closure<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


        <footer>
             
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

        </footer>
    </div>
    <!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
    <script>
        var timeEnd = new Date();
        console.log('耗时：' + (timeEnd - timeStart));
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre').forEach((block) => {
                block.classList.add("line-numbers");
            });
        });
    </script>

    <script src="/js/prism.js"></script>
</body>
</html>
