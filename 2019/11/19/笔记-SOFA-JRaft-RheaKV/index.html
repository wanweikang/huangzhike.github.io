<!DOCTYPE HTML>
<html>
	<head><meta name="generator" content="Hexo 3.9.0">
		<meta charset="utf-8">
		<script src="/js/highlight.js"></script>
				<script>hljs.initHighlightingOnLoad();var timeStart = new Date();</script>
		
		<title>[笔记]-SOFA-JRaft-RheaKV | 学而时习之</title>
		
		<meta name="author" content="Huangzhike">
		
		
		<meta name="description" content="K.I.S.S">
		
		
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		
		<meta property="og:title" content="[笔记]-SOFA-JRaft-RheaKV">
		
		<meta property="og:site_name" content="学而时习之">
		
		
		<!-- favicon -->
		<link rel="icon" type="image/ico" href="/ok.ico" sizes="32x32">
 


		<meta name="msapplication-TileColor" content="#009688">
		<meta name="msapplication-TileImage" content="/mstile-144x144.ico">
		<meta name="theme-color" content="#009688">

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Didact+Gothic"> 

		<!-- favicon end -->
		<!-- <link href="//ok.ico" rel="icon"> -->
		
		<!-- toc -->
		<!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
		<!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
		<!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
		<!-- material design -->
		<!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
		<!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
		<!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
		<!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
		<!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
		<link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
		 
		 
		<!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
		<!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
	</head>
</html>
<body>
	<nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">菜单</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" href="/">学而时习之</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

	<div class="container" >
		<div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[笔记]-SOFA-JRaft-RheaKV</h2>
				
				<div>
					<div class="post-time">2019-11-19</div>
				</div>
				
				<div class="article-content">
				<p>MultiRaftGroup：多个RaftGroup，对于RheaKV，每个分组（Region）都有一个独立的Leader和多个Follower。</p>
<p>PlacementDriver：管理整个集群，生成RegionId，根据Region的心跳更新路由表，也可以使用Fake的固定配置。</p>
<p>Store：Region的容器，包含多个分片，Store向PD主动上报心跳，包含该Store的基本信息，如，包含多少Region，有哪些Region的Leader在该Store等。</p>
<p>Region：数据存储的单元，也包含了一个选举单元，对应Store里某个数据区间，每个Region有多个副本，每个副本存储在不同的Store，一起组成一个RaftGroup。Region的Leader会向PD主动上报心跳，PD通过Region的Epoch感知Region是否有变化。</p>
<p>数据分区或分片算法通常是Range和Hash，RheaKV通过Range进行数据分片，分成一个个RaftGroup，也称为Region。</p>
<p>因为Range切分是对Key进行字节排序后再切分，像类似Scan等操作对相近Key的查询会尽可能集中在某个Region，这个Hash无法支持。</p>
<p>拆分单个Region也更好处理，只用修改部分元数据，不会涉及到大范围的数据挪动。</p>
<p>Range有一个问题就是，可能某个Region被频繁操作成为热点Region，可以通过PD调度热点Region到更空闲的机器上，或者提供Follower分担读的压力等。</p>
<hr>
<p>Client和Server的初始化</p>
<p>DefaultRheaKVStore#init</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">boolean</span> <span class="title">init</span><span class="params">(<span class="keyword">final</span> RheaKVStoreOptions opts)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">this</span>.opts = opts;</span><br><span class="line">    <span class="comment">// init placement driver</span></span><br><span class="line">    <span class="keyword">final</span> PlacementDriverOptions pdOpts = opts.getPlacementDriverOptions();</span><br><span class="line">    <span class="keyword">final</span> String clusterName = opts.getClusterName();</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 根据PlacementDriverClient选项实例化PlacementDriverClient</span></span><br><span class="line">    <span class="keyword">if</span> (pdOpts.isFake()) &#123;</span><br><span class="line">        <span class="keyword">this</span>.pdClient = <span class="keyword">new</span> FakePlacementDriverClient(opts.getClusterId(), clusterName);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ClusterId：PlacementDriverServer根据ClusterId隔离不同的Cluster，Fake模式不需要</span></span><br><span class="line">        <span class="comment">// ClusterName：每个Store节点包含一个或多个RaftGroup，RaftGroup根据ClusterName-RegionId命名</span></span><br><span class="line">        <span class="keyword">this</span>.pdClient = <span class="keyword">new</span> RemotePlacementDriverClient(opts.getClusterId(), clusterName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 初始化PDClient</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.pdClient.init(pdOpts)) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 存储引擎选项，一般是Server节点才有配置</span></span><br><span class="line">    <span class="keyword">final</span> StoreEngineOptions stOpts = opts.getStoreEngineOptions();</span><br><span class="line">    <span class="keyword">if</span> (stOpts != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Server节点地址列表</span></span><br><span class="line">        stOpts.setInitialServerList(opts.getInitialServerList());</span><br><span class="line">        <span class="comment">// 根据存储引擎选项实例化存储引擎并初始化</span></span><br><span class="line">        <span class="keyword">this</span>.storeEngine = <span class="keyword">new</span> StoreEngine(<span class="keyword">this</span>.pdClient, <span class="keyword">this</span>.stateListenerContainer);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.storeEngine.init(stOpts)) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 当前存储节点自身的IP和端口号</span></span><br><span class="line">    <span class="keyword">final</span> Endpoint selfEndpoint = <span class="keyword">this</span>.storeEngine == <span class="keyword">null</span> ? <span class="keyword">null</span> : <span class="keyword">this</span>.storeEngine.getSelfEndpoint();</span><br><span class="line">    <span class="keyword">final</span> RpcOptions rpcOpts = opts.getRpcOptions();</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 实例化RpcService</span></span><br><span class="line">    <span class="keyword">this</span>.rheaKVRpcService = <span class="keyword">new</span> DefaultRheaKVRpcService(<span class="keyword">this</span>.pdClient, selfEndpoint) &#123;</span><br><span class="line">        <span class="comment">// 重写了getLeader方法</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Endpoint <span class="title">getLeader</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> regionId, <span class="keyword">final</span> <span class="keyword">boolean</span> forceRefresh, <span class="keyword">final</span> <span class="keyword">long</span> timeoutMillis)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 先根据RegionId查找Leader</span></span><br><span class="line">            <span class="keyword">final</span> Endpoint leader = getLeaderByRegionEngine(regionId);</span><br><span class="line">            <span class="keyword">if</span> (leader != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> leader;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 找不到再调用父类的方法</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.getLeader(regionId, forceRefresh, timeoutMillis);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 初始化RpcService</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.rheaKVRpcService.init(rpcOpts)) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 重试次数，默认2</span></span><br><span class="line">    <span class="keyword">this</span>.failoverRetries = opts.getFailoverRetries();</span><br><span class="line">    <span class="comment">// 等待超时，默认5000毫秒</span></span><br><span class="line">    <span class="keyword">this</span>.futureTimeoutMillis = opts.getFutureTimeoutMillis();</span><br><span class="line">    <span class="comment">// 是否只从Leader读，默认是</span></span><br><span class="line">    <span class="keyword">this</span>.onlyLeaderRead = opts.isOnlyLeaderRead();</span><br><span class="line">    <span class="comment">// 默认使用并行处理器，可以理解为提交给线程池并发执行</span></span><br><span class="line">    <span class="keyword">if</span> (opts.isUseParallelKVExecutor()) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> numWorkers = Utils.cpus();</span><br><span class="line">        <span class="comment">// 左移4位，等于乘以2^4</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> bufSize = numWorkers &lt;&lt; <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">final</span> String name = <span class="string">"parallel-kv-executor"</span>;</span><br><span class="line">        <span class="keyword">final</span> ThreadFactory threadFactory = Constants.THREAD_AFFINITY_ENABLED ? <span class="keyword">new</span> AffinityNamedThreadFactory(name, <span class="keyword">true</span>) : <span class="keyword">new</span> NamedThreadFactory(name, <span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">// 启动Disruptor</span></span><br><span class="line">        <span class="keyword">this</span>.kvDispatcher = <span class="keyword">new</span> TaskDispatcher(bufSize, numWorkers, WaitStrategyType.LITE_BLOCKING_WAIT, threadFactory);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.batchingOpts = opts.getBatchingOptions();</span><br><span class="line">    <span class="comment">// 默认允许批处理</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.batchingOpts.isAllowBatching()) &#123;</span><br><span class="line">        <span class="comment">// 批量Get处理器</span></span><br><span class="line">        <span class="keyword">this</span>.getBatching = <span class="keyword">new</span> GetBatching(KeyEvent::<span class="keyword">new</span>, <span class="string">"get_batching"</span>, <span class="keyword">new</span> GetBatchingHandler(<span class="string">"get"</span>, <span class="keyword">false</span>));</span><br><span class="line">        <span class="comment">// 一致性读的批量Get处理器</span></span><br><span class="line">        <span class="keyword">this</span>.getBatchingOnlySafe = <span class="keyword">new</span> GetBatching(KeyEvent::<span class="keyword">new</span>, <span class="string">"get_batching_only_safe"</span>, <span class="keyword">new</span> GetBatchingHandler(<span class="string">"get_only_safe"</span>, <span class="keyword">true</span>));</span><br><span class="line">        <span class="comment">// 批量Put处理器，PutBatchingHandler</span></span><br><span class="line">        <span class="keyword">this</span>.putBatching = <span class="keyword">new</span> PutBatching(KVEvent::<span class="keyword">new</span>, <span class="string">"put_batching"</span>, <span class="keyword">new</span> PutBatchingHandler(<span class="string">"put"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.started = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>初始化PlacementDriverClient</p>
<p>AbstractPlacementDriverClient#init</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">boolean</span> <span class="title">init</span><span class="params">(<span class="keyword">final</span> PlacementDriverOptions opts)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 初始化RpcClient，连接Server节点，初始化CliService，用于集群节点的增删改查等管理操作</span></span><br><span class="line">    initCli(opts.getCliOptions());</span><br><span class="line">    <span class="comment">// RPC的回调相关</span></span><br><span class="line">    <span class="keyword">this</span>.pdRpcService = <span class="keyword">new</span> DefaultPlacementDriverRpcService(<span class="keyword">this</span>);</span><br><span class="line">    RpcOptions rpcOpts = opts.getPdRpcOptions();</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.pdRpcService.init(rpcOpts)) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 一个Region对应一个RegionRouteTableOptions，存放键区间等配置</span></span><br><span class="line">    <span class="keyword">final</span> List&lt;RegionRouteTableOptions&gt; regionRouteTableOptionsList = opts.getRegionRouteTableOptionsList();</span><br><span class="line">    <span class="keyword">if</span> (regionRouteTableOptionsList != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> String initialServerList = opts.getInitialServerList();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> RegionRouteTableOptions regionRouteTableOpts : regionRouteTableOptionsList) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">            <span class="comment">// 初始化Region的路由表</span></span><br><span class="line">            initRouteTableByRegion(regionRouteTableOpts);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>AbstractPlacementDriverClient#initRouteTableByRegion</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initRouteTableByRegion</span><span class="params">(<span class="keyword">final</span> RegionRouteTableOptions opts)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> regionId = Requires.requireNonNull(opts.getRegionId(), <span class="string">"opts.regionId"</span>);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">byte</span>[] startKey = opts.getStartKeyBytes();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">byte</span>[] endKey = opts.getEndKeyBytes();</span><br><span class="line">    <span class="keyword">final</span> String initialServerList = opts.getInitialServerList();</span><br><span class="line">    <span class="comment">// Region</span></span><br><span class="line">    <span class="keyword">final</span> Region region = <span class="keyword">new</span> Region();</span><br><span class="line">    <span class="comment">// Region的节点配置</span></span><br><span class="line">    <span class="keyword">final</span> Configuration conf = <span class="keyword">new</span> Configuration();</span><br><span class="line">    <span class="comment">// RegionId</span></span><br><span class="line">    region.setId(regionId);</span><br><span class="line">    <span class="comment">// 左端点</span></span><br><span class="line">    region.setStartKey(startKey);</span><br><span class="line">    <span class="comment">// 右端点</span></span><br><span class="line">    region.setEndKey(endKey);</span><br><span class="line">    <span class="comment">// 版本号</span></span><br><span class="line">    region.setRegionEpoch(<span class="keyword">new</span> RegionEpoch(-<span class="number">1</span>, -<span class="number">1</span>));</span><br><span class="line">    <span class="comment">// peers</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    conf.parse(initialServerList);</span><br><span class="line">    <span class="comment">// Region的同辈节点</span></span><br><span class="line">    region.setPeers(JRaftHelper.toPeerList(conf.listPeers()));</span><br><span class="line">    <span class="comment">// 更新该Region/RaftGroup的Configuration</span></span><br><span class="line">    RouteTable.getInstance().updateConfiguration(JRaftHelper.getJRaftGroupId(clusterName, regionId), conf);</span><br><span class="line">    <span class="comment">// 更新区间映射</span></span><br><span class="line">    <span class="keyword">this</span>.regionRouteTable.addOrUpdateRegion(region);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>RouteTable#updateConfiguration</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">updateConfiguration</span><span class="params">(<span class="keyword">final</span> String groupId, <span class="keyword">final</span> Configuration conf)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 该集群的GroupConf</span></span><br><span class="line">    <span class="keyword">final</span> GroupConf gc = getOrCreateGroupConf(groupId);</span><br><span class="line">    <span class="comment">// 比ReentrantReadWriteLock消耗少，但是不可重入</span></span><br><span class="line">    <span class="keyword">final</span> StampedLock stampedLock = gc.stampedLock;</span><br><span class="line">    <span class="comment">// 获取写锁，返回Stamp，0表示没有写锁</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> stamp = stampedLock.writeLock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 更新集群的配置</span></span><br><span class="line">        gc.conf = conf;</span><br><span class="line">        <span class="keyword">if</span> (gc.leader != <span class="keyword">null</span> &amp;&amp; !gc.conf.contains(gc.leader)) &#123;</span><br><span class="line">            gc.leader = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        stampedLock.unlockWrite(stamp);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>RegionRouteTable#addOrUpdateRegion</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addOrUpdateRegion</span><span class="params">(<span class="keyword">final</span> Region region)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> regionId = region.getId();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">byte</span>[] startKey = BytesUtil.nullToEmpty(region.getStartKey());</span><br><span class="line">    <span class="keyword">final</span> StampedLock stampedLock = <span class="keyword">this</span>.stampedLock;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> stamp = stampedLock.writeLock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// RegionId，Region</span></span><br><span class="line">        <span class="keyword">this</span>.regionTable.put(regionId, region.copy());</span><br><span class="line">        <span class="comment">// TreeMap，左端点，RegionId</span></span><br><span class="line">        <span class="keyword">this</span>.rangeTable.put(startKey, regionId);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        stampedLock.unlockWrite(stamp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>StoreEngine#init</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">boolean</span> <span class="title">init</span><span class="params">(<span class="keyword">final</span> StoreEngineOptions opts)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">this</span>.storeOpts = Requires.requireNonNull(opts, <span class="string">"opts"</span>);</span><br><span class="line">    Endpoint serverAddress = Requires.requireNonNull(opts.getServerAddress(), <span class="string">"opts.serverAddress"</span>);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> port = serverAddress.getPort();</span><br><span class="line">    <span class="keyword">final</span> String ip = serverAddress.getIp();</span><br><span class="line">    <span class="comment">// 没有设置就使用当前主机的地址</span></span><br><span class="line">    <span class="keyword">if</span> (ip == <span class="keyword">null</span> || Utils.IP_ANY.equals(ip)) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    List&lt;RegionEngineOptions&gt; rOptsList = opts.getRegionEngineOptionsList();</span><br><span class="line">    <span class="comment">// 如果RegionEngine选项为空，初始化一个默认的RegionEngine</span></span><br><span class="line">    <span class="keyword">if</span> (rOptsList == <span class="keyword">null</span> || rOptsList.isEmpty()) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 集群名</span></span><br><span class="line">    <span class="keyword">final</span> String clusterName = <span class="keyword">this</span>.pdClient.getClusterName();</span><br><span class="line">    <span class="comment">// 遍历所有RegionEngine选项，设置参数</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">final</span> RegionEngineOptions rOpts : rOptsList) &#123;</span><br><span class="line">        <span class="comment">// RaftGroup</span></span><br><span class="line">        rOpts.setRaftGroupId(JRaftHelper.getJRaftGroupId(clusterName, rOpts.getRegionId()));</span><br><span class="line">        <span class="comment">// 当前Server节点的地址</span></span><br><span class="line">        rOpts.setServerAddress(serverAddress);</span><br><span class="line">        <span class="comment">// 所有同辈节点的地址列表</span></span><br><span class="line">        rOpts.setInitialServerList(opts.getInitialServerList());</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 初始化Store和该Store下面的Region列表</span></span><br><span class="line">    <span class="keyword">final</span> Store store = <span class="keyword">this</span>.pdClient.getStoreMetadata(opts);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">this</span>.storeId = store.getId();</span><br><span class="line">    <span class="comment">// 初始化执行器</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.readIndexExecutor == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.raftStateTrigger == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.snapshotExecutor == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> useSharedRpcExecutor = opts.isUseSharedRpcExecutor();</span><br><span class="line">    <span class="comment">// 如果不共用RPC线程池，则初始化各自的线程池</span></span><br><span class="line">    <span class="keyword">if</span> (!useSharedRpcExecutor) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 性能监控</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 初始化RPC服务器</span></span><br><span class="line">    <span class="keyword">this</span>.rpcServer = <span class="keyword">new</span> RpcServer(port, <span class="keyword">true</span>, <span class="keyword">true</span>);</span><br><span class="line">    <span class="comment">// 添加Raft相关的请求处理器</span></span><br><span class="line">    RaftRpcServerFactory.addRaftRequestProcessors(<span class="keyword">this</span>.rpcServer, <span class="keyword">this</span>.raftRpcExecutor, <span class="keyword">this</span>.cliRpcExecutor);</span><br><span class="line">    <span class="comment">// 添加键值存储相关的请求处理器，KVCommandProcessor</span></span><br><span class="line">    StoreEngineHelper.addKvStoreRequestProcessor(<span class="keyword">this</span>.rpcServer, <span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">// 启动RPC服务器</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.rpcServer.start()) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 根据类型初始化RawKVStore数据库，RocksDB或ConcurrentSkipListMap</span></span><br><span class="line">    <span class="keyword">if</span> (!initRawKVStore(opts)) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 为该Store下的所有Region初始化RegionEngine</span></span><br><span class="line">    <span class="keyword">if</span> (!initAllRegionEngine(opts, store)) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果启用了自管理的集群，需要初始化一个HeartbeatSender</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.pdClient <span class="keyword">instanceof</span> RemotePlacementDriverClient) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.started = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>FakePlacementDriverClient#getStoreMetadata</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Store <span class="title">getStoreMetadata</span><span class="params">(<span class="keyword">final</span> StoreEngineOptions opts)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Store store = <span class="keyword">new</span> Store();</span><br><span class="line">    <span class="keyword">final</span> List&lt;RegionEngineOptions&gt; rOptsList = opts.getRegionEngineOptionsList();</span><br><span class="line">    <span class="keyword">final</span> List&lt;Region&gt; regionList = Lists.newArrayListWithCapacity(rOptsList.size());</span><br><span class="line">    <span class="comment">// 对于Fake来说，Store不需要Id</span></span><br><span class="line">    store.setId(-<span class="number">1</span>);</span><br><span class="line">    store.setEndpoint(opts.getServerAddress());</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">final</span> RegionEngineOptions rOpts : rOptsList) &#123;</span><br><span class="line">        <span class="comment">// 根据RegionEngineOptions更新路由</span></span><br><span class="line">        regionList.add(getLocalRegionMetadata(rOpts));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置该Store下的Region列表</span></span><br><span class="line">    store.setRegions(regionList);</span><br><span class="line">    <span class="keyword">return</span> store;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>StoreEngine#initAllRegionEngine</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">initAllRegionEngine</span><span class="params">(<span class="keyword">final</span> StoreEngineOptions opts, <span class="keyword">final</span> Store store)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    String baseRaftDataPath = opts.getRaftDataPath();</span><br><span class="line">    <span class="keyword">if</span> (Strings.isNotBlank(baseRaftDataPath)) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> Endpoint serverAddress = opts.getServerAddress();</span><br><span class="line">    <span class="keyword">final</span> List&lt;RegionEngineOptions&gt; rOptsList = opts.getRegionEngineOptionsList();</span><br><span class="line">    <span class="keyword">final</span> List&lt;Region&gt; regionList = store.getRegions();</span><br><span class="line">    <span class="comment">// 先校验RegionEngineOptions和Region数量是否一致</span></span><br><span class="line">    Requires.requireTrue(rOptsList.size() == regionList.size());</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; rOptsList.size(); i++) &#123;</span><br><span class="line">        <span class="comment">// 对应的RegionEngineOptions</span></span><br><span class="line">        <span class="keyword">final</span> RegionEngineOptions rOpts = rOptsList.get(i);</span><br><span class="line">        <span class="comment">// 对应的Region</span></span><br><span class="line">        <span class="keyword">final</span> Region region = regionList.get(i);</span><br><span class="line">        <span class="comment">// 路径为空的就设置一个默认值</span></span><br><span class="line">        <span class="keyword">if</span> (Strings.isBlank(rOpts.getRaftDataPath())) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="comment">// 初始化该Region的RegionEngine</span></span><br><span class="line">        <span class="keyword">final</span> RegionEngine engine = <span class="keyword">new</span> RegionEngine(region, <span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">if</span> (engine.init(rOpts)) &#123;</span><br><span class="line">            <span class="comment">// 一个RegionEngine一个RegionKVService</span></span><br><span class="line">            <span class="keyword">final</span> RegionKVService regionKVService = <span class="keyword">new</span> DefaultRegionKVService(engine);</span><br><span class="line">            <span class="comment">// 关联RegionId和RegionKVService</span></span><br><span class="line">            registerRegionKVService(regionKVService);</span><br><span class="line">            <span class="comment">// 关联RegionId和RegionEngine</span></span><br><span class="line">            <span class="keyword">this</span>.regionEngineTable.put(region.getId(), engine);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>RegionEngine#init</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">boolean</span> <span class="title">init</span><span class="params">(<span class="keyword">final</span> RegionEngineOptions opts)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">this</span>.regionOpts = Requires.requireNonNull(opts, <span class="string">"opts"</span>);</span><br><span class="line">    <span class="comment">// 实例化状态机</span></span><br><span class="line">    <span class="keyword">this</span>.fsm = <span class="keyword">new</span> KVStoreStateMachine(<span class="keyword">this</span>.region, <span class="keyword">this</span>.storeEngine);</span><br><span class="line">    <span class="comment">// node options</span></span><br><span class="line">    NodeOptions nodeOpts = opts.getNodeOptions();</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    nodeOpts.setInitialConf(<span class="keyword">new</span> Configuration(JRaftHelper.toJRaftPeerIdList(<span class="keyword">this</span>.region.getPeers())));</span><br><span class="line">    nodeOpts.setFsm(<span class="keyword">this</span>.fsm);</span><br><span class="line">    <span class="keyword">final</span> String raftDataPath = opts.getRaftDataPath();</span><br><span class="line">    <span class="comment">// 各种路径</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">final</span> Endpoint serverAddress = opts.getServerAddress();</span><br><span class="line">    <span class="keyword">final</span> PeerId serverId = <span class="keyword">new</span> PeerId(serverAddress, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">final</span> RpcServer rpcServer = <span class="keyword">this</span>.storeEngine.getRpcServer();</span><br><span class="line">    <span class="keyword">this</span>.raftGroupService = <span class="keyword">new</span> RaftGroupService(opts.getRaftGroupId(), serverId, nodeOpts, rpcServer, <span class="keyword">true</span>);</span><br><span class="line">    <span class="comment">// 初始化并启动JRaft节点</span></span><br><span class="line">    <span class="keyword">this</span>.node = <span class="keyword">this</span>.raftGroupService.start(<span class="keyword">false</span>);</span><br><span class="line">    RouteTable.getInstance().updateConfiguration(<span class="keyword">this</span>.raftGroupService.getGroupId(), nodeOpts.getInitialConf());</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.node != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> RawKVStore rawKVStore = <span class="keyword">this</span>.storeEngine.getRawKVStore();</span><br><span class="line">        <span class="keyword">final</span> Executor readIndexExecutor = <span class="keyword">this</span>.storeEngine.getReadIndexExecutor();</span><br><span class="line">        <span class="comment">// 重点</span></span><br><span class="line">        <span class="keyword">this</span>.raftRawKVStore = <span class="keyword">new</span> RaftRawKVStore(<span class="keyword">this</span>.node, rawKVStore, readIndexExecutor);</span><br><span class="line">        <span class="keyword">this</span>.metricsRawKVStore = <span class="keyword">new</span> MetricsRawKVStore(<span class="keyword">this</span>.region.getId(), <span class="keyword">this</span>.raftRawKVStore);</span><br><span class="line">        <span class="comment">// 一些监控配置</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">this</span>.started = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.started;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p>DefaultRheaKVStore#put</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> CompletableFuture&lt;Boolean&gt; <span class="title">put</span><span class="params">(<span class="keyword">final</span> <span class="keyword">byte</span>[] key, <span class="keyword">final</span> <span class="keyword">byte</span>[] value, <span class="keyword">final</span> CompletableFuture&lt;Boolean&gt; future, <span class="keyword">final</span> <span class="keyword">boolean</span> tryBatching)</span> </span>&#123;</span><br><span class="line">    checkState();</span><br><span class="line">    <span class="comment">// 尝试批量操作</span></span><br><span class="line">    <span class="keyword">if</span> (tryBatching) &#123;</span><br><span class="line">        <span class="keyword">final</span> PutBatching putBatching = <span class="keyword">this</span>.putBatching;</span><br><span class="line">        <span class="comment">// 发布到PutBatching实例的RingBuffer</span></span><br><span class="line">        <span class="keyword">if</span> (putBatching != <span class="keyword">null</span> &amp;&amp; putBatching.apply(<span class="keyword">new</span> KVEntry(key, value), future)) &#123;</span><br><span class="line">            <span class="keyword">return</span> future;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 直接加入</span></span><br><span class="line">    internalPut(key, value, future, <span class="keyword">this</span>.failoverRetries, <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">return</span> future;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>DefaultRheaKVStore$PutBatchingHandler#onEvent</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEvent</span><span class="params">(<span class="keyword">final</span> KVEvent event, <span class="keyword">final</span> <span class="keyword">long</span> sequence, <span class="keyword">final</span> <span class="keyword">boolean</span> endOfBatch)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// 先把Put请求加入事件列表</span></span><br><span class="line">    <span class="keyword">this</span>.events.add(event);</span><br><span class="line">    <span class="comment">// 累计键和值的长度</span></span><br><span class="line">    <span class="keyword">this</span>.cachedBytes += event.kvEntry.length();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> size = <span class="keyword">this</span>.events.size();</span><br><span class="line">    <span class="comment">// 是否执行批处理</span></span><br><span class="line">    <span class="comment">// 没有批处理标记 &amp;&amp; 没达到批处理累计数量 &amp;&amp; 累计的键值长度不够多</span></span><br><span class="line">    <span class="keyword">if</span> (!endOfBatch &amp;&amp; size &lt; batchingOpts.getBatchSize() &amp;&amp; <span class="keyword">this</span>.cachedBytes &lt; batchingOpts.getMaxWriteBytes()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 只有一条</span></span><br><span class="line">    <span class="keyword">if</span> (size == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// 先重置清空事件列表和累计的键值长度</span></span><br><span class="line">        reset();</span><br><span class="line">        <span class="comment">// 当前事件</span></span><br><span class="line">        <span class="keyword">final</span> KVEntry kv = event.kvEntry;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 再次执行Put，注意这里不会尝试Batching，而是进入DefaultRheaKVStore#internalPut</span></span><br><span class="line">            put(kv.getKey(), kv.getValue(), event.future, <span class="keyword">false</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Throwable t) &#123;</span><br><span class="line">            <span class="comment">// 异常回调</span></span><br><span class="line">            exceptionally(t, event.future);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 累积有多条</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> List&lt;KVEntry&gt; entries = Lists.newArrayListWithCapacity(size);</span><br><span class="line">        <span class="keyword">final</span> CompletableFuture&lt;Boolean&gt;[] futures = <span class="keyword">new</span> CompletableFuture[size];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> KVEvent e = <span class="keyword">this</span>.events.get(i);</span><br><span class="line">            entries.add(e.kvEntry);</span><br><span class="line">            <span class="comment">// 一个事件一个Future</span></span><br><span class="line">            futures[i] = e.future;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 重置</span></span><br><span class="line">        reset();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 批量执行</span></span><br><span class="line">            put(entries).whenComplete((result, throwable) -&gt; &#123;</span><br><span class="line">                <span class="comment">// 成功</span></span><br><span class="line">                <span class="keyword">if</span> (throwable == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; futures.length; i++) &#123;</span><br><span class="line">                        <span class="comment">// 回调</span></span><br><span class="line">                        futures[i].complete(result);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 异常回调</span></span><br><span class="line">                exceptionally(throwable, futures);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Throwable t) &#123;</span><br><span class="line">            <span class="comment">// 异常回调</span></span><br><span class="line">            exceptionally(t, futures);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>DefaultRheaKVStore#internalPut</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">internalPut</span><span class="params">(<span class="keyword">final</span> <span class="keyword">byte</span>[] key, <span class="keyword">final</span> <span class="keyword">byte</span>[] value, <span class="keyword">final</span> CompletableFuture&lt;Boolean&gt; future, <span class="keyword">final</span> <span class="keyword">int</span> retriesLeft, <span class="keyword">final</span> Errors lastCause)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 根据Key查询Region</span></span><br><span class="line">    <span class="keyword">final</span> Region region = <span class="keyword">this</span>.pdClient.findRegionByKey(key, ErrorsHelper.isInvalidEpoch(lastCause));</span><br><span class="line">    <span class="comment">// 获取该Region的RegionEngine，如果不是Leader，返回null</span></span><br><span class="line">    <span class="keyword">final</span> RegionEngine regionEngine = getRegionEngine(region.getId(), <span class="keyword">true</span>);</span><br><span class="line">    <span class="comment">// 失败重试函数</span></span><br><span class="line">    <span class="keyword">final</span> RetryRunner retryRunner = retryCause -&gt; internalPut(key, value, future, retriesLeft - <span class="number">1</span>, retryCause);</span><br><span class="line">    <span class="comment">// 失败回调</span></span><br><span class="line">    <span class="keyword">final</span> FailoverClosure&lt;Boolean&gt; closure = <span class="keyword">new</span> FailoverClosureImpl&lt;&gt;(future, retriesLeft, retryRunner);</span><br><span class="line">    <span class="comment">// 路由缓存的节点是Leader</span></span><br><span class="line">    <span class="keyword">if</span> (regionEngine != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 确保Region和RegionEngine的Epoch一致</span></span><br><span class="line">        <span class="keyword">if</span> (ensureOnValidEpoch(region, regionEngine, closure)) &#123;</span><br><span class="line">            <span class="comment">// 直接执行，RawKVStore#Put</span></span><br><span class="line">            getRawKVStore(regionEngine).put(key, value, closure);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 路由缓存的节点不是Leader</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> PutRequest request = <span class="keyword">new</span> PutRequest();</span><br><span class="line">        request.setKey(key);</span><br><span class="line">        request.setValue(value);</span><br><span class="line">        request.setRegionId(region.getId());</span><br><span class="line">        request.setRegionEpoch(region.getRegionEpoch());</span><br><span class="line">        <span class="comment">// RPC交给Leader执行</span></span><br><span class="line">        <span class="keyword">this</span>.rheaKVRpcService.callAsyncWithRpc(request, closure, lastCause);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>AbstractPlacementDriverClient#findRegionByKey</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Region <span class="title">findRegionByKey</span><span class="params">(<span class="keyword">final</span> <span class="keyword">byte</span>[] key, <span class="keyword">final</span> <span class="keyword">boolean</span> forceRefresh)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (forceRefresh) &#123;</span><br><span class="line">        <span class="comment">// 模板方法，更新路由表，FakePlacementDriverClient的实现为空，NO-OP，因为是固定的</span></span><br><span class="line">        refreshRouteTable();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 从路由表查</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.regionRouteTable.findRegionByKey(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>RegionRouteTable#findRegionByKey</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Region <span class="title">findRegionByKey</span><span class="params">(<span class="keyword">final</span> <span class="keyword">byte</span>[] key)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">final</span> StampedLock stampedLock = <span class="keyword">this</span>.stampedLock;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> stamp = stampedLock.readLock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> findRegionByKeyWithoutLock(key);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        stampedLock.unlockRead(stamp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>RegionRouteTable#findRegionByKeyWithoutLock</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Region <span class="title">findRegionByKeyWithoutLock</span><span class="params">(<span class="keyword">final</span> <span class="keyword">byte</span>[] key)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 范围表是一个TreeMap，保存了Region的StartKey和RegionId的映射</span></span><br><span class="line">    <span class="comment">// 返回的是StartKey小于等于Key的第一个RegionId</span></span><br><span class="line">    <span class="keyword">final</span> Map.Entry&lt;<span class="keyword">byte</span>[], Long&gt; entry = <span class="keyword">this</span>.rangeTable.floorEntry(key);</span><br><span class="line">    <span class="keyword">if</span> (entry == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 根据RegionId查找Region</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.regionTable.get(entry.getValue());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>DefaultRheaKVRpcService#callAsyncWithRpc</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;V&gt; <span class="function">CompletableFuture&lt;V&gt; <span class="title">callAsyncWithRpc</span><span class="params">(<span class="keyword">final</span> BaseRequest request, <span class="keyword">final</span> FailoverClosure&lt;V&gt; closure, <span class="keyword">final</span> Errors lastCause, <span class="keyword">final</span> <span class="keyword">boolean</span> requireLeader)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> forceRefresh = ErrorsHelper.isInvalidPeer(lastCause);</span><br><span class="line">    <span class="comment">// 根据RegionId和是否需要Leader返回端点</span></span><br><span class="line">    <span class="keyword">final</span> Endpoint endpoint = getRpcEndpoint(request.getRegionId(), forceRefresh, <span class="keyword">this</span>.rpcTimeoutMillis, requireLeader);</span><br><span class="line">    <span class="comment">// 执行RPC</span></span><br><span class="line">    internalCallAsyncWithRpc(endpoint, request, closure);</span><br><span class="line">    <span class="keyword">return</span> closure.future();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>DefaultRheaKVRpcService#getRpcEndpoint</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Endpoint <span class="title">getRpcEndpoint</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> regionId, <span class="keyword">final</span> <span class="keyword">boolean</span> forceRefresh, <span class="keyword">final</span> <span class="keyword">long</span> timeoutMillis, <span class="keyword">final</span> <span class="keyword">boolean</span> requireLeader)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (requireLeader) &#123;</span><br><span class="line">        <span class="comment">// 获取Leader</span></span><br><span class="line">        <span class="keyword">return</span> getLeader(regionId, forceRefresh, timeoutMillis);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 返回一个不是自己的节点</span></span><br><span class="line">        <span class="keyword">return</span> getLuckyPeer(regionId, forceRefresh, timeoutMillis);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>DefaultRheaKVStore$DefaultRheaKVRpcService#getLeader</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Endpoint <span class="title">getLeader</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> regionId, <span class="keyword">final</span> <span class="keyword">boolean</span> forceRefresh, <span class="keyword">final</span> <span class="keyword">long</span> timeoutMillis)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 先根据RegionId查找Leader</span></span><br><span class="line">    <span class="keyword">final</span> Endpoint leader = getLeaderByRegionEngine(regionId);</span><br><span class="line">    <span class="keyword">if</span> (leader != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> leader;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 找不到再调用父类的方法</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.getLeader(regionId, forceRefresh, timeoutMillis);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>DefaultRheaKVStore#getLeaderByRegionEngine</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Endpoint <span class="title">getLeaderByRegionEngine</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> regionId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Client没有初始化RegionEngine</span></span><br><span class="line">    <span class="keyword">final</span> RegionEngine regionEngine = getRegionEngine(regionId);</span><br><span class="line">    <span class="comment">// Server有配置</span></span><br><span class="line">    <span class="keyword">if</span> (regionEngine != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> PeerId leader = regionEngine.getLeaderId();</span><br><span class="line">        <span class="keyword">if</span> (leader != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> String raftGroupId = JRaftHelper.getJRaftGroupId(<span class="keyword">this</span>.pdClient.getClusterName(), regionId);</span><br><span class="line">            RouteTable.getInstance().updateLeader(raftGroupId, leader);</span><br><span class="line">            <span class="keyword">return</span> leader.getEndpoint();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>AbstractPlacementDriverClient#getLeader</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Endpoint <span class="title">getLeader</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> regionId, <span class="keyword">final</span> <span class="keyword">boolean</span> forceRefresh, <span class="keyword">final</span> <span class="keyword">long</span> timeoutMillis)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// RaftGroupId，由ClusterName和RegionId拼接得</span></span><br><span class="line">    <span class="keyword">final</span> String raftGroupId = JRaftHelper.getJRaftGroupId(<span class="keyword">this</span>.clusterName, regionId);</span><br><span class="line">    <span class="comment">// 先从缓存找</span></span><br><span class="line">    PeerId leader = getLeader(raftGroupId, forceRefresh, timeoutMillis);</span><br><span class="line">    <span class="comment">// 缓存没找到，之前也没有刷新缓存</span></span><br><span class="line">    <span class="keyword">if</span> (leader == <span class="keyword">null</span> &amp;&amp; !forceRefresh) &#123;</span><br><span class="line">        <span class="comment">// 刷新缓存再找</span></span><br><span class="line">        leader = getLeader(raftGroupId, <span class="keyword">true</span>, timeoutMillis);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (leader == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> leader.getEndpoint();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>AbstractPlacementDriverClient#getLeader</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> PeerId <span class="title">getLeader</span><span class="params">(<span class="keyword">final</span> String raftGroupId, <span class="keyword">final</span> <span class="keyword">boolean</span> forceRefresh, <span class="keyword">final</span> <span class="keyword">long</span> timeoutMillis)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> RouteTable routeTable = RouteTable.getInstance();</span><br><span class="line">    <span class="comment">// 如果要强制刷新缓存</span></span><br><span class="line">    <span class="keyword">if</span> (forceRefresh) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> deadline = System.currentTimeMillis() + timeoutMillis;</span><br><span class="line">        <span class="keyword">final</span> StringBuilder error = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        Throwable lastCause = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (; ; ) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 阻塞刷新至超时或唤醒</span></span><br><span class="line">                <span class="keyword">final</span> Status st = routeTable.refreshLeader(<span class="keyword">this</span>.cliClientService, raftGroupId, <span class="number">2000</span>);</span><br><span class="line">                <span class="keyword">if</span> (st.isOk()) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// ...</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> InterruptedException e) &#123;</span><br><span class="line">                <span class="comment">// ...</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Throwable t) &#123;</span><br><span class="line">                <span class="comment">// ...</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果没到截止时间，还可以继续刷新</span></span><br><span class="line">            <span class="keyword">if</span> (System.currentTimeMillis() &lt; deadline) &#123;</span><br><span class="line">                <span class="comment">// ...</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 超时抛异常</span></span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// ...</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 从缓存获取返回</span></span><br><span class="line">    <span class="keyword">return</span> routeTable.selectLeader(raftGroupId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>RouteTable#refreshLeader</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Status <span class="title">refreshLeader</span><span class="params">(<span class="keyword">final</span> CliClientService cliClientService, <span class="keyword">final</span> String groupId, <span class="keyword">final</span> <span class="keyword">int</span> timeoutMs)</span> <span class="keyword">throws</span> InterruptedException, TimeoutException </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">final</span> Configuration conf = getConfiguration(groupId);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">final</span> Status st = Status.OK();</span><br><span class="line">    <span class="comment">// Protobuf</span></span><br><span class="line">    <span class="keyword">final</span> CliRequests.GetLeaderRequest.Builder rb = CliRequests.GetLeaderRequest.newBuilder();</span><br><span class="line">    rb.setGroupId(groupId);</span><br><span class="line">    <span class="comment">// 创建一个获取Leader的请求</span></span><br><span class="line">    <span class="keyword">final</span> CliRequests.GetLeaderRequest request = rb.build();</span><br><span class="line">    TimeoutException timeoutException = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// 遍历所有配置的节点</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">final</span> PeerId peer : conf) &#123;</span><br><span class="line">        <span class="comment">// 尝试连接</span></span><br><span class="line">        <span class="keyword">if</span> (!cliClientService.connect(peer.getEndpoint())) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">            <span class="comment">// 跳过没有连接的节点</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 发送获取Leader请求</span></span><br><span class="line">        <span class="keyword">final</span> Future&lt;Message&gt; result = cliClientService.getLeader(peer.getEndpoint(), request, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> Message msg = result.get(timeoutMs, TimeUnit.MILLISECONDS);</span><br><span class="line">            <span class="keyword">if</span> (msg <span class="keyword">instanceof</span> RpcRequests.ErrorResponse) &#123;</span><br><span class="line">                <span class="comment">// ...</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">final</span> CliRequests.GetLeaderResponse response = (CliRequests.GetLeaderResponse) msg;</span><br><span class="line">                <span class="comment">// 更新Leader信息</span></span><br><span class="line">                updateLeader(groupId, response.getLeaderId());</span><br><span class="line">                <span class="comment">// 只要有一个节点返回Leader信息就好</span></span><br><span class="line">                <span class="keyword">return</span> Status.OK();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> TimeoutException e) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> ExecutionException e) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (timeoutException != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> timeoutException;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> st;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>RouteTable#selectLeader</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> PeerId <span class="title">selectLeader</span><span class="params">(<span class="keyword">final</span> String groupId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">final</span> GroupConf gc = <span class="keyword">this</span>.groupConfTable.get(groupId);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">final</span> StampedLock stampedLock = gc.stampedLock;</span><br><span class="line">    <span class="comment">// 读锁分悲观模式和乐观模式，这里是获取乐观读锁</span></span><br><span class="line">    <span class="keyword">long</span> stamp = stampedLock.tryOptimisticRead();</span><br><span class="line">    PeerId leader = gc.leader;</span><br><span class="line">    <span class="comment">// 如果获取乐观读锁后发生了写锁</span></span><br><span class="line">    <span class="keyword">if</span> (!stampedLock.validate(stamp)) &#123;</span><br><span class="line">        <span class="comment">// 升级为悲观读锁</span></span><br><span class="line">        stamp = stampedLock.readLock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 重新再获取一次变量</span></span><br><span class="line">            leader = gc.leader;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            stampedLock.unlockRead(stamp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> leader;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于批量Put，也是类似，但是默认是发布到Disruptor，由线程池异步消费。</p>
<p>另外，如果多个键跨了多个Region，不保证事务。</p>
<p>RaftRawKVStore#put</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(<span class="keyword">final</span> <span class="keyword">byte</span>[] key, <span class="keyword">final</span> <span class="keyword">byte</span>[] value, <span class="keyword">final</span> KVStoreClosure closure)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 包装一个Operation，并应用</span></span><br><span class="line">    applyOperation(KVOperation.createPut(key, value), closure);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>RaftRawKVStore#applyOperation</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">applyOperation</span><span class="params">(<span class="keyword">final</span> KVOperation op, <span class="keyword">final</span> KVStoreClosure closure)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 必须保证当前操作的节点是Leader</span></span><br><span class="line">    <span class="keyword">if</span> (!isLeader()) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 创建任务</span></span><br><span class="line">    <span class="keyword">final</span> Task task = <span class="keyword">new</span> Task();</span><br><span class="line">    task.setData(ByteBuffer.wrap(Serializers.getDefault().writeObject(op)));</span><br><span class="line">    task.setDone(<span class="keyword">new</span> KVClosureAdapter(closure, op));</span><br><span class="line">    <span class="comment">// 发布日志</span></span><br><span class="line">    <span class="keyword">this</span>.node.apply(task);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p>DefaultRheaKVStore#get</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> CompletableFuture&lt;<span class="keyword">byte</span>[]&gt; get(<span class="keyword">final</span> <span class="keyword">byte</span>[] key, <span class="keyword">final</span> <span class="keyword">boolean</span> readOnlySafe, <span class="keyword">final</span> CompletableFuture&lt;<span class="keyword">byte</span>[]&gt; future, <span class="keyword">final</span> <span class="keyword">boolean</span> tryBatching) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 尝试批量</span></span><br><span class="line">    <span class="keyword">if</span> (tryBatching) &#123;</span><br><span class="line">        <span class="comment">// 是否使用一致性读</span></span><br><span class="line">        <span class="keyword">final</span> GetBatching getBatching = readOnlySafe ? <span class="keyword">this</span>.getBatchingOnlySafe : <span class="keyword">this</span>.getBatching;</span><br><span class="line">        <span class="comment">// 发布到RingBuffer</span></span><br><span class="line">        <span class="keyword">if</span> (getBatching != <span class="keyword">null</span> &amp;&amp; getBatching.apply(key, future)) &#123;</span><br><span class="line">            <span class="keyword">return</span> future;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 直接获取</span></span><br><span class="line">    internalGet(key, readOnlySafe, future, <span class="keyword">this</span>.failoverRetries, <span class="keyword">null</span>, <span class="keyword">this</span>.onlyLeaderRead);</span><br><span class="line">    <span class="keyword">return</span> future;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>DefaultRheaKVStore$GetBatchingHandler#onEvent</p>
<p>Get基本和Put一致，不加注释了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEvent</span><span class="params">(<span class="keyword">final</span> KeyEvent event, <span class="keyword">final</span> <span class="keyword">long</span> sequence, <span class="keyword">final</span> <span class="keyword">boolean</span> endOfBatch)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.events.add(event);</span><br><span class="line">    <span class="keyword">this</span>.cachedBytes += event.key.length;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> size = <span class="keyword">this</span>.events.size();</span><br><span class="line">    <span class="keyword">if</span> (!endOfBatch &amp;&amp; size &lt; batchingOpts.getBatchSize() &amp;&amp; <span class="keyword">this</span>.cachedBytes &lt; batchingOpts.getMaxReadBytes()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (size == <span class="number">1</span>) &#123;</span><br><span class="line">        reset();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            get(event.key, <span class="keyword">this</span>.readOnlySafe, event.future, <span class="keyword">false</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Throwable t) &#123;</span><br><span class="line">            exceptionally(t, event.future);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> List&lt;<span class="keyword">byte</span>[]&gt; keys = Lists.newArrayListWithCapacity(size);</span><br><span class="line">        <span class="keyword">final</span> CompletableFuture&lt;<span class="keyword">byte</span>[]&gt;[] futures = <span class="keyword">new</span> CompletableFuture[size];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> KeyEvent e = <span class="keyword">this</span>.events.get(i);</span><br><span class="line">            keys.add(e.key);</span><br><span class="line">            futures[i] = e.future;</span><br><span class="line">        &#125;</span><br><span class="line">        reset();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            multiGet(keys, <span class="keyword">this</span>.readOnlySafe).whenComplete((result, throwable) -&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> (throwable == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; futures.length; i++) &#123;</span><br><span class="line">                        <span class="keyword">final</span> ByteArray realKey = ByteArray.wrap(keys.get(i));</span><br><span class="line">                        futures[i].complete(result.get(realKey));</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                exceptionally(throwable, futures);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Throwable t) &#123;</span><br><span class="line">            exceptionally(t, futures);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>剩下基本和Put一样，不贴了。</p>
<p>RaftRawKVStore#get</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">get</span><span class="params">(<span class="keyword">final</span> <span class="keyword">byte</span>[] key, <span class="keyword">final</span> <span class="keyword">boolean</span> readOnlySafe, <span class="keyword">final</span> KVStoreClosure closure)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 如果不需要一致性读，那就直接读本地数据</span></span><br><span class="line">    <span class="keyword">if</span> (!readOnlySafe) &#123;</span><br><span class="line">        <span class="keyword">this</span>.kvStore.get(key, <span class="keyword">false</span>, closure);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Raft一致性读</span></span><br><span class="line">    <span class="keyword">this</span>.node.readIndex(BytesUtil.EMPTY_BYTES, <span class="keyword">new</span> ReadIndexClosure() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(<span class="keyword">final</span> Status status, <span class="keyword">final</span> <span class="keyword">long</span> index, <span class="keyword">final</span> <span class="keyword">byte</span>[] reqCtx)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 确认应用了才能读本地数据</span></span><br><span class="line">            <span class="keyword">if</span> (status.isOk()) &#123;</span><br><span class="line">                RaftRawKVStore.<span class="keyword">this</span>.kvStore.get(key, <span class="keyword">true</span>, closure);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 失败的情况</span></span><br><span class="line">            RaftRawKVStore.<span class="keyword">this</span>.readIndexExecutor.execute(() -&gt; &#123;</span><br><span class="line">                <span class="comment">// 如果当前节点是Leader，可能是没收到足够Follower的响应，因此不能应用到状态机</span></span><br><span class="line">                <span class="keyword">if</span> (isLeader()) &#123;</span><br><span class="line">                    <span class="comment">// 再发布一个GET的日志，尝试应用到状态机</span></span><br><span class="line">                    applyOperation(KVOperation.createGet(key), closure);</span><br><span class="line">                &#125; </span><br><span class="line">                <span class="comment">// 当前节点是Follower</span></span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// Client执行失败回调，重试</span></span><br><span class="line">                    <span class="keyword">new</span> KVClosureAdapter(closure, <span class="keyword">null</span>).run(status);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


		<footer>
			 
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

		</footer>
	</div>
	<!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->

	<script>var timeEnd = new Date();console.log('耗时：' + (timeEnd - timeStart));</script>
	<!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
	<!-- material design -->
	<!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
	<!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
	<!-- toc -->
	<!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
	<!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
	<!-- <script src="/js/main.js"></script> -->
</body>
</html>
