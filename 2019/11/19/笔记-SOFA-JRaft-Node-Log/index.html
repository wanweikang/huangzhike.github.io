<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
        <script>
            var timeStart = new Date();
        </script>
        
        <title>[ç¬”è®°]-SOFA-JRaft-Node-Log | ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜</title>
        
        <meta name="author" content="huangzhike">
        
        
        <meta name="description" content="Snapshotå’ŒConfigurationéƒ¨åˆ†æš‚æ—¶æ²¡æœ‰å…³æ³¨ã€‚

ä»¥Counterä¸ºä¾‹ï¼Œç•¥è¿‡CounterClientå’ŒCounterServerçš„å®ç°
Leaderæ”¶åˆ°å†™è¯·æ±‚
IncrementAndGetRequestProcessor#handleRequest
    @Override
 ">
        
        
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        
        <meta property="og:title" content="[ç¬”è®°]-SOFA-JRaft-Node-Log"/>
        
        <meta property="og:site_name" content="ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜"/>
        
        
        <!-- favicon -->
        <link rel="icon" type="image/ico" href="/ok.ico" sizes="32x32">
        <meta name="msapplication-TileColor" content="#009688">
        <meta name="msapplication-TileImage" content="/mstile-144x144.ico">
        <meta name="theme-color" content="#009688">
        <!-- favicon end -->
        <!-- <link href="//ok.ico" rel="icon"> -->
        
        <!-- toc -->
        <!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
        <!-- material design -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
        <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
        
        <!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
        <!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
    <meta name="generator" content="Hexo 4.2.1"></head>

<body>
    <nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">èœå•</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" title="ä¸‹ä¸€å¥æ˜¯ï¼šå®¢æœ‰å¯äººæœŸä¸æ¥ã€‚å°æ—¶å€™ï¼Œå–œæ¬¢é åœ¨é˜³å°ä¸Šï¼Œä¸€è¾¹å¹é£ï¼Œä¸€è¾¹çœ‹ä¹¦ï¼Œå–œæ¬¢è¯»ä¹¦å—ï¼Œéªšå¹´ï¼Ÿ" href="/">ä¹¦å½“å¿«æ„è¯»æ˜“å°½</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" target="_blank" rel="noopener" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

    <div class="container" >
        <div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[ç¬”è®°]-SOFA-JRaft-Node-Log</h2>
				
				<div>
					<div class="post-time">2019-11-19</div>
				</div>
				
				<div class="article-content">
				<p>Snapshotå’ŒConfigurationéƒ¨åˆ†æš‚æ—¶æ²¡æœ‰å…³æ³¨ã€‚</p>
<hr>
<p>ä»¥Counterä¸ºä¾‹ï¼Œç•¥è¿‡CounterClientå’ŒCounterServerçš„å®ç°</p>
<p>Leaderæ”¶åˆ°å†™è¯·æ±‚</p>
<p>IncrementAndGetRequestProcessor#handleRequest</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleRequest</span><span class="token punctuation">(</span><span class="token keyword">final</span> BizContext bizCtx<span class="token punctuation">,</span> <span class="token keyword">final</span> AsyncContext asyncCtx<span class="token punctuation">,</span> <span class="token keyword">final</span> IncrementAndGetRequest request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// å¦‚æœå½“å‰Serverä¸æ˜¯Leader</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>counterServer<span class="token punctuation">.</span><span class="token function">getFsm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è¿”å›é‡å®šå‘å“åº”ï¼ŒåŒ…å«äº†Leaderçš„PeerId</span>
            asyncCtx<span class="token punctuation">.</span><span class="token function">sendResponse</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>counterServer<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å½“å‰Serveræ˜¯Leaderï¼Œå¤„ç†å†™è¯·æ±‚</span>
        <span class="token keyword">final</span> ValueResponse response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ValueResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// åˆ›å»ºå›è°ƒ</span>
        <span class="token keyword">final</span> IncrementAndAddClosure closure <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IncrementAndAddClosure</span><span class="token punctuation">(</span>counterServer<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> status <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å¤±è´¥</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>status<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// è¿”å›é”™è¯¯ä¿¡æ¯</span>
                response<span class="token punctuation">.</span><span class="token function">setErrorMsg</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">getErrorMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                response<span class="token punctuation">.</span><span class="token function">setSuccess</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">/*
             * åº”ç”¨åˆ°çŠ¶æ€æœºæˆåŠŸï¼Œè¿”å›åº”ç­”
             * è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼Œå¦‚æœLeaderåœ¨åº”ç”¨æ—¥å¿—åå´©æºƒï¼Œå“åº”å®¢æˆ·ç«¯å¤±è´¥ï¼Œç„¶åClienté‡è¯•æ–°çš„Leaderï¼Œåˆ™ä¼šå¯¼è‡´é‡å¤æ—¥å¿—å’Œæ‰§è¡Œ
             * ä¸ºäº†å®ç°å¹‚ç­‰ï¼Œè¯·æ±‚åº”è¯¥æºå¸¦ä¸€ä¸ªå”¯ä¸€æ ‡è¯†ï¼ŒServeræ‰§è¡Œå‰å…ˆæ ¡éªŒ
             */</span>
            asyncCtx<span class="token punctuation">.</span><span class="token function">sendResponse</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// åˆ›å»ºä»»åŠ¡</span>
            <span class="token keyword">final</span> Task task <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è®¾ç½®å›è°ƒ</span>
            task<span class="token punctuation">.</span><span class="token function">setDone</span><span class="token punctuation">(</span>closure<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å¡«å……è¯·æ±‚æ•°æ®</span>
            task<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>ByteBuffer<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>SerializerManager<span class="token punctuation">.</span><span class="token function">getSerializer</span><span class="token punctuation">(</span>SerializerManager<span class="token punctuation">.</span>Hessian2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å°è¯•å‘å¸ƒæ—¥å¿—ï¼Œç­‰å¾…åº”ç”¨</span>
            counterServer<span class="token punctuation">.</span><span class="token function">getNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">final</span> CodecException e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>NodeImpl#apply</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">final</span> Task task<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// èŠ‚ç‚¹æ­£åœ¨å…³é—­</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>shutdownLatch <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æäº¤ç»™å›è°ƒçº¿ç¨‹æ± ï¼Œæ‰§è¡Œå¤±è´¥å›è°ƒ</span>
            Utils<span class="token punctuation">.</span><span class="token function">runClosureInThread</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Status</span><span class="token punctuation">(</span>RaftError<span class="token punctuation">.</span>ENODESHUTDOWN<span class="token punctuation">,</span> <span class="token string">"Node is shutting down."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Node is shutting down"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        Requires<span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> <span class="token string">"Null task"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// åˆ›å»ºä¸€ä¸ªLogæ¡ç›®</span>
        <span class="token keyword">final</span> LogEntry entry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LogEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        entry<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> retryTimes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//</span>
            <span class="token keyword">final</span> EventTranslator<span class="token operator">&lt;</span>LogEntryAndClosure<span class="token operator">></span> translator <span class="token operator">=</span> <span class="token punctuation">(</span>event<span class="token punctuation">,</span> sequence<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
                event<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                event<span class="token punctuation">.</span>done <span class="token operator">=</span> task<span class="token punctuation">.</span><span class="token function">getDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                event<span class="token punctuation">.</span>entry <span class="token operator">=</span> entry<span class="token punctuation">;</span>
                event<span class="token punctuation">.</span>expectedTerm <span class="token operator">=</span> task<span class="token punctuation">.</span><span class="token function">getExpectedTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// é‡è¯•å‘å¸ƒäº‹ä»¶</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å‘å¸ƒåˆ°RingBufferæˆåŠŸ</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>applyQueue<span class="token punctuation">.</span><span class="token function">tryPublishEvent</span><span class="token punctuation">(</span>translator<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    retryTimes<span class="token operator">++</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// è¶…å‡ºé‡è¯•æ¬¡æ•°</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>retryTimes <span class="token operator">></span> MAX_APPLY_RETRY_TIMES<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// æäº¤ç»™å›è°ƒçº¿ç¨‹æ± ï¼Œæ‰§è¡Œå¤±è´¥å›è°ƒ</span>
                        Utils<span class="token punctuation">.</span><span class="token function">runClosureInThread</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Status</span><span class="token punctuation">(</span>RaftError<span class="token punctuation">.</span>EBUSY<span class="token punctuation">,</span> <span class="token string">"Node is busy, has too many tasks."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// Thread#yield</span>
                    ThreadHelper<span class="token punctuation">.</span><span class="token function">onSpinWait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">final</span> Exception e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æäº¤ç»™å›è°ƒçº¿ç¨‹æ± ï¼Œæ‰§è¡Œå¤±è´¥å›è°ƒ</span>
            Utils<span class="token punctuation">.</span><span class="token function">runClosureInThread</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Status</span><span class="token punctuation">(</span>RaftError<span class="token punctuation">.</span>EPERM<span class="token punctuation">,</span> <span class="token string">"Node is down."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>Leaderå¤„ç†æ—¥å¿—äº‹ä»¶</p>
<p>NodeImpl$LogEntryAndClosureHandler#onEvent</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onEvent</span><span class="token punctuation">(</span><span class="token keyword">final</span> LogEntryAndClosure event<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> sequence<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> endOfBatch<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å¦‚æœåœ¨å…³é—­</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>shutdownLatch <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// äº‹ä»¶åˆ—è¡¨ä¸ä¸ºç©º</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// æ‰¹é‡æ‰§è¡Œä»»åŠ¡</span>
                    <span class="token function">executeApplyingTasks</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">final</span> <span class="token keyword">int</span> num <span class="token operator">=</span> GLOBAL_NUM_NODES<span class="token punctuation">.</span><span class="token function">decrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ...</span>
                event<span class="token punctuation">.</span>shutdownLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// æ­£å¸¸æƒ…å†µï¼Œå…ˆå°†äº‹ä»¶åŠ å…¥ä»»åŠ¡åˆ—è¡¨</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å¦‚æœäº‹ä»¶æ•°é‡å¤§äºæ‰¹é‡æ‰§è¡Œçš„æ•°é‡ï¼Œé»˜è®¤32 || æœ‰æ‰¹é‡ç»“æŸçš„æ ‡è®°</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> NodeImpl<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>raftOptions<span class="token punctuation">.</span><span class="token function">getApplyBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> endOfBatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æ‰¹é‡æ‰§è¡Œä»»åŠ¡</span>
                <span class="token function">executeApplyingTasks</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// æ‰§è¡Œå®Œå°±æ¸…ç©ºä»»åŠ¡</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span></code></pre>
<p>NodeImpl#executeApplyingTasks</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">executeApplyingTasks</span><span class="token punctuation">(</span><span class="token keyword">final</span> List<span class="token operator">&lt;</span>LogEntryAndClosure<span class="token operator">></span> tasks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// å…¶å®Disruptorè¿™é‡Œæ˜¯MPSCçš„ï¼Œå³å•çº¿ç¨‹æ¶ˆè´¹ï¼Œæ‰€ä»¥ç†è®ºä¸Šè¿™é‡Œä¸ä¼šæœ‰å¹¶å‘å†™çš„é—®é¢˜</span>
        <span class="token comment" spellcheck="true">// çŒœæµ‹è¿™é‡ŒåŠ å†™é”æ˜¯ä¸ºäº†å¤„ç†å¯è§æ€§çš„é—®é¢˜ï¼Œé¿å…æ²¡å†™å®Œæˆå°±è¢«è¯»åˆ°</span>
        <span class="token comment" spellcheck="true">// å¦‚æœæ•°æ®ä¸æ˜¯å¾ˆå¤§å¹¶ä¸”å®æ—¶è¦æ±‚ä¸é«˜çš„è¯ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨CopyOnWriteï¼Œè¯»çš„æ—¶å€™æ˜¯æ— é”çš„</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> size <span class="token operator">=</span> tasks<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// Leaderæ‰èƒ½æ‰§è¡Œ</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">!=</span> State<span class="token punctuation">.</span>STATE_LEADER<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å›è°ƒï¼Œç•¥</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">final</span> List<span class="token operator">&lt;</span>LogEntry<span class="token operator">></span> entries <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// éå†äº‹ä»¶</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> LogEntryAndClosure task <span class="token operator">=</span> tasks<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å¦‚æœLeaderå‘å¸ƒäº‹ä»¶æ—¶çš„ä»»æœŸå’Œç°åœ¨çš„å½“å‰ä»»æœŸä¸ä¸€è‡´</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">.</span>expectedTerm <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> task<span class="token punctuation">.</span>expectedTerm <span class="token operator">!=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å›è°ƒï¼Œç•¥</span>
                    <span class="token comment" spellcheck="true">// è·³è¿‡</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// å°†ä»»åŠ¡è¿½åŠ åˆ°æŠ•ç¥¨ç®±çš„é˜Ÿåˆ—ï¼ŒLeaderæ”¶åˆ°å¤§å¤šæ•°Followerçš„æ—¥å¿—å“åº”åä¼šè°ƒç”¨BallotBox#commitAtå–å‡ºä»»åŠ¡æäº¤å¹¶æ‰§è¡ŒçŠ¶æ€æœº</span>
                <span class="token comment" spellcheck="true">// å¦‚æœå¤±è´¥</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>ballotBox<span class="token punctuation">.</span><span class="token function">appendPendingTask</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>conf<span class="token punctuation">.</span><span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>conf<span class="token punctuation">.</span><span class="token function">isStable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> null <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>conf<span class="token punctuation">.</span><span class="token function">getOldConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> task<span class="token punctuation">.</span>done<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// æäº¤ç»™å›è°ƒçº¿ç¨‹æ± ï¼Œæ‰§è¡Œå¯¹åº”çš„å¤±è´¥å›è°ƒ</span>
                    Utils<span class="token punctuation">.</span><span class="token function">runClosureInThread</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>done<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Status</span><span class="token punctuation">(</span>RaftError<span class="token punctuation">.</span>EINTERNAL<span class="token punctuation">,</span> <span class="token string">"Fail to append task."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// è·³è¿‡</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                task<span class="token punctuation">.</span>entry<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setTerm</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">)</span><span class="token punctuation">;</span>
                task<span class="token punctuation">.</span>entry<span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span>EnumOutter<span class="token punctuation">.</span>EntryType<span class="token punctuation">.</span>ENTRY_TYPE_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// æš‚å­˜æ—¥å¿—äº‹ä»¶</span>
                entries<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å°†æ—¥å¿—åŠ å…¥LogManagerï¼ŒåŒ…å«äº†å›è°ƒLeaderStableClosure</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>logManager<span class="token punctuation">.</span><span class="token function">appendEntries</span><span class="token punctuation">(</span>entries<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">LeaderStableClosure</span><span class="token punctuation">(</span>entries<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// update conf.first</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>conf <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>logManager<span class="token punctuation">.</span><span class="token function">checkAndSetConfiguration</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>LogManagerImpl#appendEntriesè¿½åŠ æ—¥å¿—æŒä¹…åŒ–è§åé¢ï¼Œè¿™é‡Œç•¥</p>
<hr>
<p>Leaderå‘é€ç©ºç™½æ¡ç›®ï¼ŒHeartBeatæˆ–Probe</p>
<p>Replicator#sendEmptyEntries</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">sendEmptyEntries</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">boolean</span> isHeartbeat<span class="token punctuation">,</span> <span class="token keyword">final</span> RpcResponseClosure<span class="token operator">&lt;</span>AppendEntriesResponse<span class="token operator">></span> heartBeatClosure<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> AppendEntriesRequest<span class="token punctuation">.</span>Builder rb <span class="token operator">=</span> AppendEntriesRequest<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Leaderä¸ºæ¯ä¸ªFollowerç»´æŠ¤äº†ä¸€ä¸ªNextIndexï¼Œè¡¨ç¤ºä¸‹ä¸€ä¸ªéœ€è¦å‘é€çš„Logçš„Indexï¼ŒLeaderä¸Šå°ååˆå§‹åŒ–ä¸ºæœ¬åœ°æ—¥å¿—LastLogIndex+1</span>
        <span class="token comment" spellcheck="true">// å…ˆå°è¯•å¡«å……å¸¸ç”¨çš„å­—æ®µï¼šTermï¼ŒGroupIdï¼ŒServerIdï¼ŒPeerIdï¼ŒPrevLogIndexï¼ŒPrevLogTermï¼ŒCommittedIndex</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">fillCommonFields</span><span class="token punctuation">(</span>rb<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>nextIndex <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> isHeartbeat<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> monotonicSendTimeMs <span class="token operator">=</span> Utils<span class="token punctuation">.</span><span class="token function">monotonicMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// åˆ›å»ºç©ºçš„æ·»åŠ æ¡ç›®è¯·æ±‚</span>
            <span class="token keyword">final</span> AppendEntriesRequest request <span class="token operator">=</span> rb<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å¦‚æœæ˜¯å¿ƒè·³</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isHeartbeat<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å¿ƒè·³è®¡æ•°</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>heartbeatCounter<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å¿ƒè·³åº”ç­”çš„å›è°ƒ</span>
                RpcResponseClosure<span class="token operator">&lt;</span>AppendEntriesResponse<span class="token operator">></span> heartbeatDone<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>heartBeatClosure <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    heartbeatDone <span class="token operator">=</span> heartBeatClosure<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    heartbeatDone <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RpcResponseClosureAdapter</span><span class="token operator">&lt;</span>AppendEntriesResponse<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                        <span class="token annotation punctuation">@Override</span>
                        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">final</span> Status status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// å¿ƒè·³å“åº”å›è°ƒ</span>
                            <span class="token function">onHeartbeatReturned</span><span class="token punctuation">(</span>Replicator<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token punctuation">,</span> status<span class="token punctuation">,</span> request<span class="token punctuation">,</span> <span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> monotonicSendTimeMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// RPCå‘é€å¿ƒè·³ï¼Œè¿”å›Future</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>heartbeatInFly <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rpcService<span class="token punctuation">.</span><span class="token function">appendEntries</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getPeerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getElectionTimeoutMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> heartbeatDone<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å¦‚æœæ˜¯Probeè¯·æ±‚ï¼Œå› ä¸ºLeaderéœ€è¦çŸ¥é“Followerå½“å‰çš„Logä½ç½®ï¼Œæ–¹ä¾¿åŒæ­¥</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æ—¥å¿—è¾“å‡ºç”¨</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>statInfo<span class="token punctuation">.</span>runningState <span class="token operator">=</span> RunningState<span class="token punctuation">.</span>APPENDING_ENTRIES<span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>statInfo<span class="token punctuation">.</span>firstLogIndex <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>nextIndex<span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>statInfo<span class="token punctuation">.</span>lastLogIndex <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>nextIndex <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>appendEntriesCounter<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> State<span class="token punctuation">.</span>Probe<span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token keyword">int</span> stateVersion <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>version<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å…ˆè¿”å›å…¨å±€åºåˆ—å·ï¼Œå†è‡ªå¢</span>
                <span class="token keyword">final</span> <span class="token keyword">int</span> seq <span class="token operator">=</span> <span class="token function">getAndIncrementReqSeq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// RPCå‘é€Probeï¼Œè¿”å›Future</span>
                <span class="token keyword">final</span> Future<span class="token operator">&lt;</span>Message<span class="token operator">></span> rpcFuture <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rpcService<span class="token punctuation">.</span><span class="token function">appendEntries</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getPeerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">RpcResponseClosureAdapter</span><span class="token operator">&lt;</span>AppendEntriesResponse<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">final</span> Status status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// Probeå“åº”å›è°ƒ</span>
                        <span class="token function">onRpcReturned</span><span class="token punctuation">(</span>Replicator<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token punctuation">,</span> RequestType<span class="token punctuation">.</span>AppendEntries<span class="token punctuation">,</span> status<span class="token punctuation">,</span> request<span class="token punctuation">,</span> <span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> seq<span class="token punctuation">,</span> stateVersion<span class="token punctuation">,</span> monotonicSendTimeMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å‘é€åæ·»åŠ ä¸€ä¸ªInflightå…¥é˜Ÿåˆ—</span>
                <span class="token function">addInflight</span><span class="token punctuation">(</span>RequestType<span class="token punctuation">.</span>AppendEntries<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>nextIndex<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> seq<span class="token punctuation">,</span> rpcFuture<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// é‡Šæ”¾Replicatorçš„é”</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>Replicator#fillCommonFields</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">fillCommonFields</span><span class="token punctuation">(</span><span class="token keyword">final</span> AppendEntriesRequest<span class="token punctuation">.</span>Builder rb<span class="token punctuation">,</span> <span class="token keyword">long</span> prevLogIndex<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> isHeartbeat<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// è·å–è¯¥Indexçš„Logå¯¹åº”çš„Term</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> prevLogTerm <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getLogManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span>prevLogIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>prevLogTerm <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> prevLogIndex <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        rb<span class="token punctuation">.</span><span class="token function">setTerm</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Leaderçš„ä»»æœŸ</span>
        rb<span class="token punctuation">.</span><span class="token function">setGroupId</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getGroupId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// é›†ç¾¤åç§°</span>
        rb<span class="token punctuation">.</span><span class="token function">setServerId</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getServerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Leaderçš„ServerId</span>
        rb<span class="token punctuation">.</span><span class="token function">setPeerId</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getPeerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// å¯¹ç«¯Followerçš„PeerId</span>
        rb<span class="token punctuation">.</span><span class="token function">setPrevLogIndex</span><span class="token punctuation">(</span>prevLogIndex<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ä¸Šæ¬¡å‘é€çš„Logçš„Index</span>
        rb<span class="token punctuation">.</span><span class="token function">setPrevLogTerm</span><span class="token punctuation">(</span>prevLogTerm<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ä¸Šæ¬¡å‘é€çš„Logçš„Term</span>
        rb<span class="token punctuation">.</span><span class="token function">setCommittedIndex</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getBallotBox</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLastCommittedIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Leaderçš„Logçš„æäº¤ä½ç½®</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>Followeræ”¶åˆ°Heartbeatæˆ–Probeæˆ–è¿½åŠ æ—¥å¿—è¯·æ±‚</p>
<p>NodeImpl#handleAppendEntriesRequest</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> Message <span class="token function">handleAppendEntriesRequest</span><span class="token punctuation">(</span><span class="token keyword">final</span> AppendEntriesRequest request<span class="token punctuation">,</span> <span class="token keyword">final</span> RpcRequestClosure done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> entriesCount <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getEntriesCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// èŠ‚ç‚¹æœªæ¿€æ´»ï¼Œå“åº”å¼‚å¸¸</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">isActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">final</span> PeerId serverId <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PeerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è§£æå¯¹ç«¯ServerIdå¼‚å¸¸ï¼Œå“åº”å¼‚å¸¸</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>serverId<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getServerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å¯¹ç«¯çš„ä»»æœŸæ¯”è‡ªå·±å½“å‰çš„ä»»æœŸå°ï¼Œä¸æ¥å—æ—¥å¿—</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> AppendEntriesResponse<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//</span>
                        <span class="token punctuation">.</span><span class="token function">setSuccess</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//</span>
                        <span class="token punctuation">.</span><span class="token function">setTerm</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// é€šçŸ¥å¯¹æ–¹Leaderä¸‹å°</span>
                        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// æ­¤æ—¶å¯¹ç«¯Leaderçš„ä»»æœŸè‚¯å®šæ˜¯å¤§äºç­‰äºè‡ªèº«ä»»æœŸçš„ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°ä»»æœŸ</span>
            <span class="token function">checkStepDown</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> serverId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å¯¹ç«¯Leaderä¸æ˜¯å½“å‰èŠ‚ç‚¹çš„Leader</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>serverId<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>leaderId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æå‡æœ¬åœ°ä»»æœŸï¼Œå½“å‰Leaderä¸‹æ¬¡å¿ƒè·³åå°±ä¼šä¸‹å°ï¼Œå‡å°‘åˆ†è„‘çš„å½±å“</span>
                <span class="token function">stepDown</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Status</span><span class="token punctuation">(</span>RaftError<span class="token punctuation">.</span>ELEADERCONFLICT<span class="token punctuation">,</span> <span class="token string">"More than one leader in the same term."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> AppendEntriesResponse<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//</span>
                        <span class="token punctuation">.</span><span class="token function">setSuccess</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//</span>
                        <span class="token punctuation">.</span><span class="token function">setTerm</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// è®©å¯¹ç«¯Leaderä¹Ÿä¸‹å°ï¼Œé‡æ–°é€‰ä¸¾</span>
                        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ä¸€åˆ‡æ­£å¸¸ï¼Œæ›´æ–°Leaderé€šä¿¡æ—¶é—´æˆ³</span>
            <span class="token function">updateLastLeaderTimestamp</span><span class="token punctuation">(</span>Utils<span class="token punctuation">.</span><span class="token function">monotonicMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// èŠ‚ç‚¹å®‰è£…Snapshotçš„æ—¶å€™ä¸æ¥å—æ—¥å¿—</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>entriesCount <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>snapshotExecutor <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>snapshotExecutor<span class="token punctuation">.</span><span class="token function">isInstallingSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// Leaderä¸Šæ¬¡åŒæ­¥çš„Logçš„Index</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> prevLogIndex <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getPrevLogIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// Leaderä¸Šæ¬¡åŒæ­¥çš„Logçš„Term</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> prevLogTerm <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getPrevLogTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">final</span> <span class="token keyword">long</span> localPrevLogTerm <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>logManager<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span>prevLogIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ä¸€è‡´æ€§æ£€æŸ¥ï¼ŒåŒä¸€ä¸ªIndexçš„Logï¼Œä½†Termä¸ä¸€è‡´ï¼Œä¸æ¥å—æ—¥å¿—</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>localPrevLogTerm <span class="token operator">!=</span> prevLogTerm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æœ¬åœ°çš„æœ€åä¸€æ¡Logçš„ç´¢å¼•</span>
                <span class="token keyword">final</span> <span class="token keyword">long</span> lastLogIndex <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>logManager<span class="token punctuation">.</span><span class="token function">getLastLogIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> AppendEntriesResponse<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//</span>
                        <span class="token punctuation">.</span><span class="token function">setSuccess</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//</span>
                        <span class="token punctuation">.</span><span class="token function">setTerm</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// è‡ªå·±å½“å‰çš„ä»»æœŸ</span>
                        <span class="token punctuation">.</span><span class="token function">setLastLogIndex</span><span class="token punctuation">(</span>lastLogIndex<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// é€šçŸ¥å¯¹æ–¹Leaderå‘é€Logçš„èµ·ç‚¹</span>
                        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ç©ºçš„è¯´æ˜æ˜¯Heartbeatæˆ–Probe</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>entriesCount <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å¿ƒè·³å“åº”åŒ…å«è‡ªå·±çš„ä»»æœŸï¼Œæ–¹ä¾¿å¯¹æ–¹æ£€æŸ¥</span>
                <span class="token keyword">final</span> AppendEntriesResponse<span class="token punctuation">.</span>Builder respBuilder <span class="token operator">=</span> AppendEntriesResponse<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//</span>
                        <span class="token punctuation">.</span><span class="token function">setSuccess</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//</span>
                        <span class="token punctuation">.</span><span class="token function">setTerm</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// è‡ªå·±å½“å‰çš„ä»»æœŸ</span>
                        <span class="token punctuation">.</span><span class="token function">setLastLogIndex</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logManager<span class="token punctuation">.</span><span class="token function">getLastLogIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Followerè‡ªå·±æœ¬åœ°æœ€åä¸€æ¡Logçš„Index</span>
                doUnlock <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// åŒæ­¥Leaderçš„Logæäº¤ä½ç½®ï¼ŒåŒæ—¶ä¹Ÿä¼šæäº¤ä»»åŠ¡ï¼Œåº”ç”¨åˆ°è‡ªå·±çš„çŠ¶æ€æœºï¼Œæ‰€ä»¥Followerçš„çŠ¶æ€æœºè‡³å°‘æ¯”Leaderè½åä¸€ä¸ªå¿ƒè·³</span>
                <span class="token comment" spellcheck="true">// å–æœ€å°çš„ä¸€ä¸ªï¼Œå› ä¸ºFolloweræ—¥å¿—å¯èƒ½è½å</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>ballotBox<span class="token punctuation">.</span><span class="token function">setLastCommittedIndex</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getCommittedIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> prevLogIndex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// è¿”å›å¿ƒè·³å“åº”</span>
                <span class="token keyword">return</span> respBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// éç©ºç™½çš„Logæ¡ç›®ï¼Œè¿½åŠ æ—¥å¿—</span>
            <span class="token keyword">long</span> index <span class="token operator">=</span> prevLogIndex<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æš‚å­˜è¦æ·»åŠ åˆ°æœ¬åœ°çš„LogEntryåˆ—è¡¨</span>
            <span class="token keyword">final</span> List<span class="token operator">&lt;</span>LogEntry<span class="token operator">></span> entries <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>entriesCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ByteBuffer allData <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">hasData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                allData <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asReadOnlyByteBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">final</span> List<span class="token operator">&lt;</span>RaftOutter<span class="token punctuation">.</span>EntryMeta<span class="token operator">></span> entriesList <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getEntriesList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// éå†å‘é€è¿‡æ¥çš„æ—¥å¿—æ¡ç›®</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> entriesCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Logæ•°æ®</span>
                <span class="token keyword">final</span> RaftOutter<span class="token punctuation">.</span>EntryMeta entry <span class="token operator">=</span> entriesList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                index<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> EnumOutter<span class="token punctuation">.</span>EntryType<span class="token punctuation">.</span>ENTRY_TYPE_UNKNOWN<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// åˆ›å»ºLogEntry</span>
                    <span class="token keyword">final</span> LogEntry logEntry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LogEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// LogIndex LogTerm</span>
                    logEntry<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LogId</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> entry<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    logEntry<span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">hasChecksum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">final</span> <span class="token keyword">long</span> dataLen <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getDataLen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>dataLen <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// å¦‚æœLogEntryåŒ…å«äº†Peeræ•°æ®</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getPeersCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> EnumOutter<span class="token punctuation">.</span>EntryType<span class="token punctuation">.</span>ENTRY_TYPE_CONFIGURATION<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// Validate checksum</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>raftOptions<span class="token punctuation">.</span><span class="token function">isEnableLogEntryChecksum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> logEntry<span class="token punctuation">.</span><span class="token function">isCorrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// æ·»åŠ LogEntry</span>
                    entries<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>logEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">final</span> FollowerStableClosure closure <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FollowerStableClosure</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> AppendEntriesResponse<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setTerm</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> done<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å°†æ¥è‡ªLeaderçš„æ•°æ®å†™å…¥æ—¥å¿—ï¼Œä¼ å…¥äº†å›è°ƒFollowerStableClosure</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>logManager<span class="token punctuation">.</span><span class="token function">appendEntries</span><span class="token punctuation">(</span>entries<span class="token punctuation">,</span> closure<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>conf <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>logManager<span class="token punctuation">.</span><span class="token function">checkAndSetConfiguration</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>Followeræ£€æŸ¥ä»»æœŸ</p>
<p>NodeImpl#checkStepDown</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">checkStepDown</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">long</span> requestTerm<span class="token punctuation">,</span> <span class="token keyword">final</span> PeerId serverId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> Status status <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ­£å¸¸æƒ…å†µä¸‹ä»»æœŸåº”è¯¥æ˜¯ä¸€è‡´çš„ï¼Œå¤§äºçš„è¯å°±è¦æ›´æ–°ä»»æœŸï¼ŒLeaderçš„è¯è¿˜è¦è½¬ä¸ºFollower</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>requestTerm <span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            status<span class="token punctuation">.</span><span class="token function">setError</span><span class="token punctuation">(</span>RaftError<span class="token punctuation">.</span>ENEWLEADER<span class="token punctuation">,</span> <span class="token string">"Raft node receives message from new leader with higher term."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">stepDown</span><span class="token punctuation">(</span>requestTerm<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ä»»æœŸä¸€è‡´ï¼Œä½†æ˜¯å½“å‰èŠ‚ç‚¹æ˜¯Candidateï¼Œé‚£ä¹ˆå¾—è½¬ä¸ºFollower</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">!=</span> State<span class="token punctuation">.</span>STATE_FOLLOWER<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            status<span class="token punctuation">.</span><span class="token function">setError</span><span class="token punctuation">(</span>RaftError<span class="token punctuation">.</span>ENEWLEADER<span class="token punctuation">,</span> <span class="token string">"Candidate receives message from new leader with the same term."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">stepDown</span><span class="token punctuation">(</span>requestTerm<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Followeræ”¶åˆ°äº†ä¸€ä¸ªä»»æœŸä¸€è‡´çš„æ–°Leader</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>leaderId<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            status<span class="token punctuation">.</span><span class="token function">setError</span><span class="token punctuation">(</span>RaftError<span class="token punctuation">.</span>ENEWLEADER<span class="token punctuation">,</span> <span class="token string">"Follower receives message from new leader with the same term."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">stepDown</span><span class="token punctuation">(</span>requestTerm<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ä¿å­˜å½“å‰Leader</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>leaderId <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>leaderId<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">resetLeaderId</span><span class="token punctuation">(</span>serverId<span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>Followerè®¾ç½®æ—¥å¿—æäº¤ä½ç½®</p>
<p>BallotBox#setLastCommittedIndex</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">setLastCommittedIndex</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">long</span> lastCommittedIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> doUnlock <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> stamp <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>stampedLock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// åˆå§‹çŠ¶æ€ä¸‹PendingIndex==0ï¼ŒPendingMetaQueueä¸ºç©ºï¼Œå¦åˆ™è¯´æ˜èŠ‚ç‚¹å˜æˆäº†Leader</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pendingIndex <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>pendingMetaQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ä¸éœ€è¦æäº¤</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>lastCommittedIndex <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lastCommittedIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>lastCommittedIndex <span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>lastCommittedIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æ›´æ–°ä½ç½®</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>lastCommittedIndex <span class="token operator">=</span> lastCommittedIndex<span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>stampedLock<span class="token punctuation">.</span><span class="token function">unlockWrite</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                doUnlock <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// æäº¤åˆ°çŠ¶æ€æœº</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>waiter<span class="token punctuation">.</span><span class="token function">onCommitted</span><span class="token punctuation">(</span>lastCommittedIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>doUnlock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>stampedLock<span class="token punctuation">.</span><span class="token function">unlockWrite</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>FSMCallerImpl#onCommitted</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onCommitted</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">long</span> committedIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ç”ŸæˆCommittedäº‹ä»¶ï¼Œå‘å¸ƒåˆ°çŠ¶æ€æœºçš„RingBuffer</span>
        <span class="token keyword">return</span> <span class="token function">enqueueTask</span><span class="token punctuation">(</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> sequence<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ä»»åŠ¡ç±»å‹ä¸ºCOMMITTED</span>
            task<span class="token punctuation">.</span>type <span class="token operator">=</span> TaskType<span class="token punctuation">.</span>COMMITTED<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æäº¤çš„ä½ç½®</span>
            task<span class="token punctuation">.</span>committedIndex <span class="token operator">=</span> committedIndex<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>FSMCallerImpl#runApplyTask</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"ConstantConditions"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> <span class="token function">runApplyTask</span><span class="token punctuation">(</span><span class="token keyword">final</span> ApplyTask task<span class="token punctuation">,</span> <span class="token keyword">long</span> maxCommittedIndex<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> endOfBatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        CountDownLatch shutdown <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æäº¤æ—¥å¿—</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">.</span>type <span class="token operator">==</span> TaskType<span class="token punctuation">.</span>COMMITTED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">.</span>committedIndex <span class="token operator">></span> maxCommittedIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                maxCommittedIndex <span class="token operator">=</span> task<span class="token punctuation">.</span>committedIndex<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>endOfBatch <span class="token operator">&amp;&amp;</span> maxCommittedIndex <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>currTask <span class="token operator">=</span> TaskType<span class="token punctuation">.</span>COMMITTED<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// æ‰§è¡Œæäº¤</span>
                <span class="token function">doCommitted</span><span class="token punctuation">(</span>maxCommittedIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                maxCommittedIndex <span class="token operator">=</span> <span class="token operator">-</span>1L<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// reset maxCommittedIndex</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>currTask <span class="token operator">=</span> TaskType<span class="token punctuation">.</span>IDLE<span class="token punctuation">;</span>
            <span class="token keyword">return</span> maxCommittedIndex<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>FSMCallerImpl#doCommitted</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doCommitted</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">long</span> committedIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>error<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">//</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> lastAppliedIndex <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lastAppliedIndex<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¿½ç•¥ä¹±åº</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lastAppliedIndex <span class="token operator">>=</span> committedIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> startMs <span class="token operator">=</span> Utils<span class="token punctuation">.</span><span class="token function">monotonicMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> List<span class="token operator">&lt;</span>Closure<span class="token operator">></span> closures <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> List<span class="token operator">&lt;</span>TaskClosure<span class="token operator">></span> taskClosures <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// Closureç”±Leaderæ”¶åˆ°Clientæ¶ˆæ¯ååˆ›å»ºå¹¶åŠ å…¥é˜Ÿåˆ—ï¼Œåœ¨è¿™é‡Œæ‰¹é‡å–å‡ºå¹¶å¡«å……åˆ°TaskClosureåˆ—è¡¨å’ŒClosureåˆ—è¡¨ï¼Œè¿”å›ç¬¬ä¸€ä¸ªæ—¥å¿—å›è°ƒçš„ç´¢å¼•</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> firstClosureIndex <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>closureQueue<span class="token punctuation">.</span><span class="token function">popClosureUntil</span><span class="token punctuation">(</span>committedIndex<span class="token punctuation">,</span> closures<span class="token punctuation">,</span> taskClosures<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// éå†TaskClosureåˆ—è¡¨ï¼Œè°ƒç”¨TaskClosure#onCommittedæ–¹æ³•ï¼Œå…·ä½“å®ç°ç”±å®¢æˆ·è‡ªå®šä¹‰ï¼Œè¿™é‡Œé»˜è®¤å•¥ä¹Ÿæ²¡å¹²</span>
            <span class="token function">onTaskCommitted</span><span class="token punctuation">(</span>taskClosures<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Requires<span class="token punctuation">.</span><span class="token function">requireTrue</span><span class="token punctuation">(</span>firstClosureIndex <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"Invalid firstClosureIndex"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è¿­ä»£å™¨</span>
            <span class="token keyword">final</span> IteratorImpl iterImpl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IteratorImpl</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fsm<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>logManager<span class="token punctuation">,</span> closures<span class="token punctuation">,</span> firstClosureIndex<span class="token punctuation">,</span> lastAppliedIndex<span class="token punctuation">,</span> committedIndex<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>applyingIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ç›´åˆ°åº”ç”¨å®Œ</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>iterImpl<span class="token punctuation">.</span><span class="token function">isGood</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> LogEntry logEntry <span class="token operator">=</span> iterImpl<span class="token punctuation">.</span><span class="token function">entry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// éæ•°æ®å‹çš„æ¡ç›®</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>logEntry<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> EnumOutter<span class="token punctuation">.</span>EntryType<span class="token punctuation">.</span>ENTRY_TYPE_DATA<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// é…ç½®ç›¸å…³ï¼Œç•¥</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// æ‰§è¡Œä»»åŠ¡ï¼Œåº”ç”¨åˆ°çŠ¶æ€æœº</span>
                <span class="token function">doApplyTasks</span><span class="token punctuation">(</span>iterImpl<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>iterImpl<span class="token punctuation">.</span><span class="token function">hasError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// åˆ°è¿™é‡ŒçŠ¶æ€æœºå·²åº”ç”¨å®Œæˆ</span>
            <span class="token comment" spellcheck="true">// æœ¬æ‰¹æœ€åä¸€ä¸ªåº”ç”¨çš„æ¡ç›®çš„ä¸Šä¸€ä¸ªä½ç½®ï¼Œæš‚æ—¶ä¸çŸ¥é“ä¸ºä»€ä¹ˆä¸¤ä¸ªAppliedIdä¸ä¸€æ ·</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> lastIndex <span class="token operator">=</span> iterImpl<span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> lastTerm <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>logManager<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span>lastIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> LogId lastAppliedId <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LogId</span><span class="token punctuation">(</span>lastIndex<span class="token punctuation">,</span> lastTerm<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ›´æ–°çŠ¶æ€æœºçš„LastAppliedIndex</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>lastAppliedIndex<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>committedIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>lastAppliedTerm <span class="token operator">=</span> lastTerm<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ›´æ–°LogManagerçš„AppliedIdï¼Œæ˜¯ä¸€ä¸ªLogId</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>logManager<span class="token punctuation">.</span><span class="token function">setAppliedId</span><span class="token punctuation">(</span>lastAppliedId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å›è°ƒé€šçŸ¥</span>
            <span class="token function">notifyLastAppliedIndexUpdated</span><span class="token punctuation">(</span>committedIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>IteratorImpl</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token function">IteratorImpl</span><span class="token punctuation">(</span><span class="token keyword">final</span> StateMachine fsm<span class="token punctuation">,</span> <span class="token keyword">final</span> LogManager logManager<span class="token punctuation">,</span> <span class="token keyword">final</span> List<span class="token operator">&lt;</span>Closure<span class="token operator">></span> closures<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> firstClosureIndex<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> lastAppliedIndex<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> committedIndex<span class="token punctuation">,</span> <span class="token keyword">final</span> AtomicLong applyingIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fsm <span class="token operator">=</span> fsm<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>logManager <span class="token operator">=</span> logManager<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>closures <span class="token operator">=</span> closures<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>firstClosureIndex <span class="token operator">=</span> firstClosureIndex<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>currentIndex <span class="token operator">=</span> lastAppliedIndex<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>committedIndex <span class="token operator">=</span> committedIndex<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>applyingIndex <span class="token operator">=</span> applyingIndex<span class="token punctuation">;</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>IteratorImpl#next</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// å…ˆé‡Šæ”¾å½“å‰æ¡ç›®</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>currEntry <span class="token operator">=</span> null<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//release current entry</span>
        <span class="token comment" spellcheck="true">// CurrentIndexåˆå§‹ä¸ºä¸Šæ‰¹åº”ç”¨åˆ°çš„ç´¢å¼•LastAppliedIndexï¼ŒCommittedIndexä¸ºæœ¬æ‰¹è¦åº”ç”¨åˆ°çš„æ—¥å¿—ç´¢å¼•</span>
        <span class="token comment" spellcheck="true">// å¦‚æœç¦»ç›®æ ‡åº”ç”¨ç´¢å¼•è¿˜æœ‰è·ç¦»</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currentIndex <span class="token operator">&lt;=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>committedIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token operator">++</span><span class="token keyword">this</span><span class="token punctuation">.</span>currentIndex<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å¥½å§</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currentIndex <span class="token operator">&lt;=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>committedIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å½“å‰è¦åº”ç”¨çš„æ¡ç›®</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>currEntry <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>logManager<span class="token punctuation">.</span><span class="token function">getEntry</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currentIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currEntry <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">final</span> LogEntryCorruptedException e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// å½“å‰è¦åº”ç”¨çš„æ¡ç›®çš„ç´¢å¼•</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>applyingIndex<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currentIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>FSMCallerImpl#doApplyTasks</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doApplyTasks</span><span class="token punctuation">(</span><span class="token keyword">final</span> IteratorImpl iterImpl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> IteratorWrapper iter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IteratorWrapper</span><span class="token punctuation">(</span>iterImpl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è°ƒç”¨çŠ¶æ€æœºçš„å®ç°</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>fsm<span class="token punctuation">.</span><span class="token function">onApply</span><span class="token punctuation">(</span>iter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ä¸€èˆ¬ä¸Šé¢çŠ¶æ€æœºåº”è¯¥å·²ç»åº”ç”¨å®Œï¼Œä¸åº”è¯¥è¿˜æœ‰æ¡ç›®å‰©ä¸‹</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å¦‚æœæœ¬æ‰¹æ—¥å¿—è¿˜æ²¡åº”ç”¨å®Œï¼Œåç§»æŒ‡é’ˆåˆ°ä¸‹ä¸€ä¸ªæ¡ç›®ï¼Œé¿å…ä¸‹æ¬¡åº”ç”¨æ—¶æ¡ç›®è¢«é‡å¤åº”ç”¨</span>
        <span class="token comment" spellcheck="true">// ä¸Šé¢æ˜¯åŸæ³¨é‡Šçš„ç¿»è¯‘ï¼Œä¸è¿‡è¿™ä¸ªIteratoræ˜¯å±€éƒ¨å˜é‡ï¼Œçº¿ç¨‹è¿”å›åå°±æ²¡äº†ï¼Œæ‰€ä»¥è¿™ä¸ªå€’éœ‰ç©æ„ä¼°è®¡æ˜¯ç»™LogManagerè®¾ç½®AppliedIdçš„</span>
        iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ä»¥Counterçš„çŠ¶æ€æœºå®ç°ä¸ºä¾‹</p>
<p>CounterStateMachine#onApply</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onApply</span><span class="token punctuation">(</span><span class="token keyword">final</span> Iterator iter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// éå†æ—¥å¿—</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">long</span> delta <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            IncrementAndAddClosure closure <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è¯´æ˜å½“å‰æ˜¯Leaderï¼Œå› ä¸ºClosureçš„å›è°ƒä¸ä¼šè¢«å¤åˆ¶åˆ°Follower</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å½“å‰æ˜¯Leaderï¼Œå¯ä»¥ç›´æ¥ä»IncrementAndAddClosureä¸­è·å–deltaï¼Œé¿å…ååºåˆ—åŒ–</span>
                closure <span class="token operator">=</span> <span class="token punctuation">(</span>IncrementAndAddClosure<span class="token punctuation">)</span> iter<span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                delta <span class="token operator">=</span> closure<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDelta</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å…¶å®ƒèŠ‚ç‚¹</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// éœ€è¦ååºåˆ—åŒ–</span>
                <span class="token keyword">final</span> ByteBuffer data <span class="token operator">=</span> iter<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> IncrementAndGetRequest request <span class="token operator">=</span> SerializerManager<span class="token punctuation">.</span><span class="token function">getSerializer</span><span class="token punctuation">(</span>SerializerManager<span class="token punctuation">.</span>Hessian2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> IncrementAndGetRequest<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    delta <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getDelta</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">final</span> CodecException e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> prev <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ›´æ–°çŠ¶æ€æœºçš„å€¼</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> updated <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">addAndGet</span><span class="token punctuation">(</span>delta<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ›´æ–°åï¼Œè¿”å›å“åº”</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>closure <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                closure<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>updated<span class="token punctuation">)</span><span class="token punctuation">;</span>
                closure<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setSuccess</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                closure<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>Status<span class="token punctuation">.</span><span class="token function">OK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ä¸‹ä¸€ä¸ª</span>
            iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>Followeræ·»åŠ æ—¥å¿—</p>
<p>LogManagerImpl#appendEntries</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">appendEntries</span><span class="token punctuation">(</span><span class="token keyword">final</span> List<span class="token operator">&lt;</span>LogEntry<span class="token operator">></span> entries<span class="token punctuation">,</span> <span class="token keyword">final</span> StableClosure done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// å¦‚æœLogManagerå‘ç”Ÿäº†é”™è¯¯</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>hasError<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ¸…ç©ºLogEntry</span>
            entries<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æäº¤ç»™å›è°ƒçº¿ç¨‹æ± ï¼Œæ‰§è¡Œå¯¹åº”å›è°ƒ</span>
            Utils<span class="token punctuation">.</span><span class="token function">runClosureInThread</span><span class="token punctuation">(</span>done<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Status</span><span class="token punctuation">(</span>RaftError<span class="token punctuation">.</span>EIO<span class="token punctuation">,</span> <span class="token string">"Corrupted LogStorage"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">boolean</span> doUnlock <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// LogEntryåˆ—è¡¨ä¸ä¸ºç©º &amp;&amp; æ£€æŸ¥å’Œè§£å†³å†²çªå¤±è´¥</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>entries<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">checkAndResolveConflict</span><span class="token punctuation">(</span>entries<span class="token punctuation">,</span> done<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æ¸…ç©ºLogEntry</span>
                entries<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// æäº¤ç»™å›è°ƒçº¿ç¨‹æ± ï¼Œæ‰§è¡Œå¯¹åº”å›è°ƒ</span>
                Utils<span class="token punctuation">.</span><span class="token function">runClosureInThread</span><span class="token punctuation">(</span>done<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Status</span><span class="token punctuation">(</span>RaftError<span class="token punctuation">.</span>EINTERNAL<span class="token punctuation">,</span> <span class="token string">"Fail to checkAndResolveConflict."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// éå†LogEntry</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> entries<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> LogEntry entry <span class="token operator">=</span> entries<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// Set checksum after checkAndResolveConflict</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>raftOptions<span class="token punctuation">.</span><span class="token function">isEnableLogEntryChecksum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    entry<span class="token punctuation">.</span><span class="token function">setChecksum</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">checksum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// å¦‚æœæ˜¯é…ç½®å‹çš„æ¡ç›®</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> EntryType<span class="token punctuation">.</span>ENTRY_TYPE_CONFIGURATION<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token comment" spellcheck="true">// æ›´æ–°é…ç½®</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>entries<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// è®¾ç½®å›è°ƒï¼Œæœ¬æ‰¹æ—¥å¿—çš„ç¬¬ä¸€ä¸ªæ—¥å¿—çš„Index</span>
                done<span class="token punctuation">.</span><span class="token function">setFirstLogIndex</span><span class="token punctuation">(</span>entries<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å…ˆæ·»åŠ åˆ°ç¼“å­˜</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>logsInMemory<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>entries<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// è®¾ç½®å›è°ƒï¼Œæ—¥å¿—åˆ—è¡¨</span>
            done<span class="token punctuation">.</span><span class="token function">setEntries</span><span class="token punctuation">(</span>entries<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> retryTimes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// åŒ…è£…</span>
            <span class="token keyword">final</span> EventTranslator<span class="token operator">&lt;</span>StableClosureEvent<span class="token operator">></span> translator <span class="token operator">=</span> <span class="token punctuation">(</span>event<span class="token punctuation">,</span> sequence<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
                event<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                event<span class="token punctuation">.</span>type <span class="token operator">=</span> EventType<span class="token punctuation">.</span>OTHER<span class="token punctuation">;</span>
                event<span class="token punctuation">.</span>done <span class="token operator">=</span> done<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// é‡è¯•å‘å¸ƒ</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å‘å¸ƒåˆ°LogManagerçš„RingBufferæˆåŠŸ</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tryOfferEvent</span><span class="token punctuation">(</span>done<span class="token punctuation">,</span> translator<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    retryTimes<span class="token operator">++</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// è¶…è¿‡é‡è¯•æ¬¡æ•°</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>retryTimes <span class="token operator">></span> APPEND_LOG_RETRY_TIMES<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// å‘å¸ƒåˆ°çŠ¶æ€æœºçš„RingBufferï¼Œè°ƒç”¨çŠ¶æ€æœºçš„onErroræ–¹æ³•</span>
                        <span class="token function">reportError</span><span class="token punctuation">(</span>RaftError<span class="token punctuation">.</span>EBUSY<span class="token punctuation">.</span><span class="token function">getNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"LogManager is busy, disk queue overload."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// Thread#yield</span>
                    ThreadHelper<span class="token punctuation">.</span><span class="token function">onSpinWait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            doUnlock <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">/*
             * æ·»åŠ äº†æ–°æ—¥å¿—ï¼Œè¿™é‡Œæ˜¯å¼‚æ­¥çš„ï¼ŒLeaderçš„Logå¯èƒ½æ²¡æœ‰æŒä¹…åŒ–æˆåŠŸï¼Œå°±å¼€å§‹å‘Followerå‘é€Logäº†
             * å¯¹äºLeaderæ¥è¯´ï¼Œéœ€è¦é€šçŸ¥Followerï¼Œå‡å¦‚Leaderåœ¨Replicator#sendEntrieså‘é€æ—¥å¿—æ—¶æ²¡æœ‰æ–°çš„æ—¥å¿—ï¼Œå°±ä¼šåŠ å…¥ä¸€ä¸ªæœŸå¾…ä½ç½®ï¼Œæ–°æ—¥å¿—åˆ°è¾¾æ—¶å›è°ƒï¼Œç»§ç»­å‘é€æ—¥å¿—
             * å¯¹äºFolloweræ¥è¯´ï¼Œå•¥ä¹Ÿä¸ç”¨å¹²
             */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">wakeupAllWaiter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ç›‘å¬å™¨å‘å¸ƒé€šçŸ¥ï¼Œé»˜è®¤æ²¡æœ‰ç›‘å¬å™¨ï¼Œéœ€è¦è‡ªå®šä¹‰</span>
                <span class="token function">notifyLastLogIndexListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>doUnlock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>Followerè§£å†³æ—¥å¿—å†²çª</p>
<p>LogManagerImpl#checkAndResolveConflict</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"NonAtomicOperationOnVolatileField"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">checkAndResolveConflict</span><span class="token punctuation">(</span><span class="token keyword">final</span> List<span class="token operator">&lt;</span>LogEntry<span class="token operator">></span> entries<span class="token punctuation">,</span> <span class="token keyword">final</span> StableClosure done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// è·å–LogEntryåˆ—è¡¨çš„ç¬¬ä¸€ä¸ªLogEntry</span>
        <span class="token keyword">final</span> LogEntry firstLogEntry <span class="token operator">=</span> ArrayDeque<span class="token punctuation">.</span><span class="token function">peekFirst</span><span class="token punctuation">(</span>entries<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// èŠ‚ç‚¹å½“å‰æ˜¯Leaderï¼Œå¹¶ä¸”æ—¥å¿—æ¥è‡ªç”¨æˆ·ï¼Œä¸çŸ¥é“Logåº”è¯¥åˆ†é…çš„Index</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>firstLogEntry<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> entries<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// åˆ†é…æ­£ç¡®çš„LogIndexï¼Œç”±Followeræœ¬åœ°çš„æœ€åä¸€ä¸ªæ—¥å¿—Indexå¼€å§‹ï¼Œå…ˆåŠ å†ç”¨</span>
                entries<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIndex</span><span class="token punctuation">(</span><span class="token operator">++</span><span class="token keyword">this</span><span class="token punctuation">.</span>lastLogIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// æˆåŠŸ</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// èŠ‚ç‚¹å½“å‰æ˜¯Followerï¼Œå¹¶ä¸”æ—¥å¿—æ¥è‡ªLeaderï¼Œéœ€è¦æ£€æŸ¥å’Œæœ¬åœ°çš„æ—¥å¿—å†²çª</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è¦æ·»åŠ çš„ç¬¬ä¸€ä¸ªæ—¥å¿—çš„Indexå’Œæœ¬åœ°æœ€åä¸€æ¡æ—¥å¿—çš„Indexç›¸å·®1ä»¥ä¸Šï¼Œè¯´æ˜å­˜åœ¨æ—¥å¿—ç©ºæ´ï¼Œæ‹’ç»</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>firstLogEntry<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>lastLogIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æäº¤åˆ°å›è°ƒçº¿ç¨‹æ‰§è¡Œå¯¹åº”å›è°ƒ</span>
                Utils<span class="token punctuation">.</span><span class="token function">runClosureInThread</span><span class="token punctuation">(</span>done<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Status</span><span class="token punctuation">(</span>RaftError<span class="token punctuation">.</span>EINVAL<span class="token punctuation">,</span> <span class="token string">"There's gap between first_index=%d and last_log_index=%d"</span><span class="token punctuation">,</span> firstLogEntry<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lastLogIndex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// åº”ç”¨åˆ°çŠ¶æ€æœºçš„æ—¥å¿—ç´¢å¼•</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> appliedIndex <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>appliedId<span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è¦æ·»åŠ çš„æœ€åä¸€æ¡æ—¥å¿—</span>
            <span class="token keyword">final</span> LogEntry lastLogEntry <span class="token operator">=</span> ArrayDeque<span class="token punctuation">.</span><span class="token function">peekLast</span><span class="token punctuation">(</span>entries<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è¦æ·»åŠ çš„æœ€åä¸€æ¡æ—¥å¿—çš„Indexæ¯”å·²åº”ç”¨åˆ°çŠ¶æ€æœºçš„Indexè¿˜å°ï¼Œæ‹’ç»</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>lastLogEntry<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> appliedIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// è¦æ·»åŠ çš„ç¬¬ä¸€æ¡æ—¥å¿—åˆšå¥½æ¥ä¸Šäº†æœ¬åœ°æ—¥å¿—</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>firstLogEntry<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lastLogIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// fast path</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>lastLogIndex <span class="token operator">=</span> lastLogEntry<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å­˜åœ¨åå·®ï¼Œéœ€è¦è§£å†³å†²çª</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> conflictingIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// éå†LogEntryåˆ—è¡¨</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> conflictingIndex <span class="token operator">&lt;</span> entries<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> conflictingIndex<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å…ˆå°è¯•ä»ç¼“å­˜ä¸­è·å–ï¼Œä¸è¡Œå†ä»æŒä¹…åŒ–æ–‡ä»¶è·å–</span>
                    <span class="token comment" spellcheck="true">// å¦‚æœè¯¥Indexå¯¹åº”çš„Logï¼ŒFolloweræœ¬åœ°çš„Termå’ŒLeaderçš„Termä¸ä¸€è‡´</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unsafeGetTerm</span><span class="token punctuation">(</span>entries<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>conflictingIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> entries<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>conflictingIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ä¸ç”¨æ£€æµ‹åé¢çš„äº†</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// è¯´æ˜Followeræœ¬åœ°çš„Logå’ŒLeaderçš„Logæœ‰å†²çª</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>conflictingIndex <span class="token operator">!=</span> entries<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å†²çªçš„æ—¥å¿—åœ¨åˆ—è¡¨çš„èµ·å§‹ä½ç½®</span>
                    <span class="token comment" spellcheck="true">// å†²çªçš„èµ·å§‹æ—¥å¿—çš„Indexæ¯”æœ¬åœ°æœ€åä¸€æ¡æ—¥å¿—å°æˆ–ç­‰äº</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>entries<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>conflictingIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lastLogIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// åˆ é™¤æœ¬åœ°ä¹‹åçš„æ—¥å¿—ï¼Œä»¥Leaderçš„ä¸ºå‡†ï¼Œè¿™é‡Œæ˜¯å…ˆæ›´æ–°LastLogIndexï¼Œå†å‘å¸ƒåˆ°LogManagerçš„RingBufferï¼Œå¼‚æ­¥åˆ é™¤</span>
                        <span class="token function">unsafeTruncateSuffix</span><span class="token punctuation">(</span>entries<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>conflictingIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>lastLogIndex <span class="token operator">=</span> lastLogEntry<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// else this is a duplicated AppendEntriesRequest, we have nothing to do besides releasing all the entries</span>
                <span class="token comment" spellcheck="true">// åˆ é™¤æ²¡æœ‰å†²çªçš„é‡å¤Logæ¡ç›®ï¼Œä¸éœ€è¦é‡å¤æ·»åŠ </span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>conflictingIndex <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// Remove duplication</span>
                    entries<span class="token punctuation">.</span><span class="token function">subList</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> conflictingIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>Followerä»RingBufferä¸­æ¶ˆè´¹äº‹ä»¶ï¼Œæ—¥å¿—æŒä¹…åŒ–åˆ·ç›˜</p>
<p>LogManagerImpl$StableClosureEventHandler#onEvent</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onEvent</span><span class="token punctuation">(</span><span class="token keyword">final</span> StableClosureEvent event<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> sequence<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> endOfBatch<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å¦‚æœLogManagerè¦å…³é—­</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>type <span class="token operator">==</span> EventType<span class="token punctuation">.</span>SHUTDOWN<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å…ˆåˆ·ç›˜</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>lastId <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ab<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">setDiskId</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>lastId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                LogManagerImpl<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>shutDownLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">final</span> StableClosure done <span class="token operator">=</span> event<span class="token punctuation">.</span>done<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å›è°ƒåŒ…å«Logæ¡ç›®</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>done<span class="token punctuation">.</span><span class="token function">getEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>done<span class="token punctuation">.</span><span class="token function">getEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æ‰¹é‡å†™å…¥Logï¼Œåœ¨åˆ·ç›˜åä¼šæ‰§è¡Œå¯¹åº”çš„å›è°ƒ</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>ab<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>done<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>lastId <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ab<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">boolean</span> ret <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token keyword">switch</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">case</span> LAST_LOG_ID<span class="token operator">:</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token keyword">case</span> TRUNCATE_PREFIX<span class="token operator">:</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token keyword">case</span> TRUNCATE_SUFFIX<span class="token operator">:</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token keyword">case</span> RESET<span class="token operator">:</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token keyword">default</span><span class="token operator">:</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">reportError</span><span class="token punctuation">(</span>RaftError<span class="token punctuation">.</span>EIO<span class="token punctuation">.</span><span class="token function">getNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Failed operation in LogStorage"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    done<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>Status<span class="token punctuation">.</span><span class="token function">OK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>endOfBatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>lastId <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ab<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">setDiskId</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>lastId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span></code></pre>
<p>LogManagerImpl$AppendBatcher#append</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">void</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token keyword">final</span> StableClosure done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>size <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cap <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>bufferSize <span class="token operator">>=</span> LogManagerImpl<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>raftOptions<span class="token punctuation">.</span><span class="token function">getMaxAppendBufferSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å…ˆæŠŠåŸæ¥çš„Logåˆ·ç›˜ï¼Œæ‰§è¡Œå›è°ƒ</span>
                <span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å†æŠŠæœ¬æ¬¡ä»»åŠ¡çš„åŠ å…¥ç¼“å­˜</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>storage<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>done<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>size<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>toAppend<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>done<span class="token punctuation">.</span><span class="token function">getEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> LogEntry entry <span class="token operator">:</span> done<span class="token punctuation">.</span><span class="token function">getEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>bufferSize <span class="token operator">+=</span> entry<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null <span class="token operator">?</span> entry<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span></code></pre>
<p>LogManagerImpl$AppendBatcher#flush</p>
<pre class=" language-java"><code class="language-java">        LogId <span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>size <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æŠŠLogåˆ—è¡¨æŒä¹…åŒ–</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>lastId <span class="token operator">=</span> <span class="token function">appendToStorage</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>toAppend<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// éå†æ¯æ‰¹çš„Logåˆ—è¡¨</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// æ¸…æ‰</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>storage<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// æœ‰å¼‚å¸¸å°±æ‰§è¡Œå¼‚å¸¸å¯¹åº”çš„å›è°ƒ</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>LogManagerImpl<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>hasError<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// æ­£å¸¸æƒ…å†µ</span>
                    <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// æ‰§è¡Œåˆ·ç›˜å›è°ƒ</span>
                        <span class="token comment" spellcheck="true">// å¯¹äºFollowerï¼Œæ˜¯FollowerStableClosureï¼Œæäº¤LeaderåŒæ­¥è¿‡æ¥çš„CommittedIndexï¼Œå¹¶å“åº”Leader</span>
                        <span class="token comment" spellcheck="true">// å¯¹äºLeaderï¼Œæ˜¯LeaderStableClosureï¼Œå°è¯•æäº¤CommitIndexï¼Œå…¶å®æ‰§è¡Œçš„æ–¹æ³•å’Œæ”¶åˆ°Followerå“åº”æ—¶æ˜¯ä¸€æ ·çš„ï¼Œåªæœ‰æ”¶åˆ°å¤§å¤šæ•°èŠ‚ç‚¹å“åº”æ—¶æ‰ä¼šçœŸæ­£æäº¤</span>
                        <span class="token comment" spellcheck="true">// è‡³äºä¸ºä»€ä¹ˆLeaderè¿™é‡ŒæŒä¹…åŒ–æ—¥å¿—åä¹Ÿä¼šå°è¯•æäº¤ï¼Œå› ä¸ºLeaderä¹Ÿæ˜¯èŠ‚ç‚¹ï¼Œå³è‡ªå·±å“åº”è‡ªå·±ï¼Œå’ŒæŠ•ç¥¨æ˜¯åŒä¸€ä¸ªé“ç†</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>storage<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>Status<span class="token punctuation">.</span><span class="token function">OK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// é‡ç½®</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>toAppend<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>storage<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// é‡ç½®</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>bufferSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lastId<span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>Followeræ—¥å¿—æŒä¹…åŒ–åæ‰§è¡Œå›è°ƒï¼Œæ›´æ–°æ—¥å¿—æäº¤ä½ç½®</p>
<p>NodeImpl$FollowerStableClosure</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">public</span> <span class="token function">FollowerStableClosure</span><span class="token punctuation">(</span><span class="token keyword">final</span> AppendEntriesRequest request<span class="token punctuation">,</span> <span class="token keyword">final</span> AppendEntriesResponse<span class="token punctuation">.</span>Builder responseBuilder<span class="token punctuation">,</span> <span class="token keyword">final</span> NodeImpl node<span class="token punctuation">,</span> <span class="token keyword">final</span> RpcRequestClosure done<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> term<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">super</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>committedIndex <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>
                    <span class="token comment" spellcheck="true">// committed index is likely less than the lastLogIndex</span>
                    request<span class="token punctuation">.</span><span class="token function">getCommittedIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token comment" spellcheck="true">// The logs after the appended entries can not be trust, so we can't commit them even if their indexes are less than request's committed index.</span>
                    request<span class="token punctuation">.</span><span class="token function">getPrevLogIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> request<span class="token punctuation">.</span><span class="token function">getEntriesCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>responseBuilder <span class="token operator">=</span> responseBuilder<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>node <span class="token operator">=</span> node<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>done <span class="token operator">=</span> done<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>term <span class="token operator">=</span> term<span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>NodeImpl$FollowerStableClosure#run</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">final</span> Status status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>status<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>node<span class="token punctuation">.</span>readLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æ¥æ”¶æ—¥å¿—æ—¶çš„ä»»æœŸå’Œå½“å‰çš„ä»»æœŸä¸ä¸€è‡´ï¼Œè¯´æ˜æŒä¹…åŒ–è¿‡ç¨‹ä¸­ä»»æœŸå‘ç”Ÿäº†å˜åŒ–</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>term <span class="token operator">!=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>node<span class="token punctuation">.</span>currTerm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ä¸èƒ½å“åº”æ—§çš„LeaderæˆåŠŸï¼Œå› ä¸ºä¸ç¡®å®šè¿™äº›æ—¥å¿—æ˜¯å¦ä¼šè¢«æ–°Leaderçš„æ—¥å¿—è¦†ç›–</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>responseBuilder<span class="token punctuation">.</span><span class="token function">setSuccess</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setTerm</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>node<span class="token punctuation">.</span>currTerm<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">sendResponse</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>responseBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>node<span class="token punctuation">.</span>readLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>responseBuilder<span class="token punctuation">.</span><span class="token function">setSuccess</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setTerm</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>term<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ›´æ–°æ—¥å¿—æäº¤ä½ç½®</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>node<span class="token punctuation">.</span>ballotBox<span class="token punctuation">.</span><span class="token function">setLastCommittedIndex</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>committedIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">sendResponse</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>responseBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<hr>
<p>Leaderæ”¶åˆ°å“åº”ï¼Œä¸¤ç§æƒ…å†µ</p>
<p>å¤„ç†å¿ƒè·³å“åº”</p>
<p>Replicator#onHeartbeatReturned</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">onHeartbeatReturned</span><span class="token punctuation">(</span><span class="token keyword">final</span> ThreadId id<span class="token punctuation">,</span> <span class="token keyword">final</span> Status status<span class="token punctuation">,</span> <span class="token keyword">final</span> AppendEntriesRequest request<span class="token punctuation">,</span> <span class="token keyword">final</span> AppendEntriesResponse response<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> rpcSendTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// replicator already was destroyed.</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> startTimeMs <span class="token operator">=</span> Utils<span class="token punctuation">.</span><span class="token function">nowMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Replicator r<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>r <span class="token operator">=</span> <span class="token punctuation">(</span>Replicator<span class="token punctuation">)</span> id<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">boolean</span> doUnlock <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// å¿ƒè·³å‘é€ä¸æˆåŠŸ</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>status<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
                r<span class="token punctuation">.</span>state <span class="token operator">=</span> State<span class="token punctuation">.</span>Probe<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å›è°ƒé€šçŸ¥</span>
                <span class="token function">notifyReplicatorStatusListener</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> ReplicatorEvent<span class="token punctuation">.</span>ERROR<span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ...</span>
                <span class="token comment" spellcheck="true">// ä¸‹ä¸€æ¬¡å¿ƒè·³è¶…æ—¶</span>
                r<span class="token punctuation">.</span><span class="token function">startHeartbeatTimer</span><span class="token punctuation">(</span>startTimeMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å¿ƒè·³å‘é€æˆåŠŸ</span>
            r<span class="token punctuation">.</span>consecutiveErrorTimes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å¦‚æœå¯¹æ–¹çš„ä»»æœŸæ¯”å½“å‰Leaderï¼Œå³æ¯”è‡ªå·±çš„ä»»æœŸè¿˜å¤§ï¼Œè¯´æ˜å¯èƒ½å‘ç”Ÿäº†ç½‘ç»œåˆ†åŒº</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> r<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
                <span class="token keyword">final</span> NodeImpl node <span class="token operator">=</span> r<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// é€šçŸ¥å›è°ƒï¼ŒFollowerå·²è¿½ä¸Š</span>
                r<span class="token punctuation">.</span><span class="token function">notifyOnCaughtUp</span><span class="token punctuation">(</span>RaftError<span class="token punctuation">.</span>EPERM<span class="token punctuation">.</span><span class="token function">getNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// é”€æ¯å½“å‰Replicator</span>
                r<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// Leaderé€€ä½ä¸ºFollowerï¼Œå¹¶æ›´æ–°ä»»æœŸï¼Œé‡æ–°å¯åŠ¨é€‰ä¸¾è®¡æ—¶</span>
                node<span class="token punctuation">.</span><span class="token function">increaseTermTo</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Status</span><span class="token punctuation">(</span>RaftError<span class="token punctuation">.</span>EHIGHERTERMRESPONSE<span class="token punctuation">,</span> <span class="token string">"Leader receives higher term heartbeat_response from peer:%s"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getPeerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å¯¹ç«¯å“åº”å¼‚å¸¸ &amp;&amp; å¯¹ç«¯è¿”å›çš„å“åº”åŒ…å«LastLogIndex</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>response<span class="token punctuation">.</span><span class="token function">getSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> response<span class="token punctuation">.</span><span class="token function">hasLastLogIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
                doUnlock <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å†æ¬¡å‘é€ä¸€æ¬¡Probeè¯·æ±‚ï¼Œæ¢æŸ¥å¯¹ç«¯Logçš„ä½ç½®</span>
                r<span class="token punctuation">.</span><span class="token function">sendEmptyEntries</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ä¸‹ä¸€æ¬¡å¿ƒè·³è¶…æ—¶</span>
                r<span class="token punctuation">.</span><span class="token function">startHeartbeatTimer</span><span class="token punctuation">(</span>startTimeMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// ä¸€åˆ‡æ­£å¸¸</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>rpcSendTime <span class="token operator">></span> r<span class="token punctuation">.</span>lastRpcSendTimestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æ›´æ–°é€šè®¯æ—¶é—´æˆ³</span>
                r<span class="token punctuation">.</span>lastRpcSendTimestamp <span class="token operator">=</span> rpcSendTime<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ä¸‹ä¸€æ¬¡å¿ƒè·³è¶…æ—¶</span>
            r<span class="token punctuation">.</span><span class="token function">startHeartbeatTimer</span><span class="token punctuation">(</span>startTimeMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>doUnlock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                id<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>å¤„ç†Probeå’Œè¿½åŠ æ—¥å¿—è¯·æ±‚çš„å“åº”</p>
<p>Replicator#onRpcReturned</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">onRpcReturned</span><span class="token punctuation">(</span><span class="token keyword">final</span> ThreadId id<span class="token punctuation">,</span> <span class="token keyword">final</span> RequestType reqType<span class="token punctuation">,</span> <span class="token keyword">final</span> Status status<span class="token punctuation">,</span> <span class="token keyword">final</span> Message request<span class="token punctuation">,</span> <span class="token keyword">final</span> Message response<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> seq<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> stateVersion<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> rpcSendTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> startTimeMs <span class="token operator">=</span> Utils<span class="token punctuation">.</span><span class="token function">nowMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Replicator r<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>r <span class="token operator">=</span> <span class="token punctuation">(</span>Replicator<span class="token punctuation">)</span> id<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>stateVersion <span class="token operator">!=</span> r<span class="token punctuation">.</span>version<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
            id<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// AppendEntrieså“åº”çš„ä¼˜å…ˆé˜Ÿåˆ—ï¼Œæ ¹æ®å‘é€æ—¶çš„åºå·æ’åˆ—</span>
        <span class="token keyword">final</span> PriorityQueue<span class="token operator">&lt;</span>RpcResponse<span class="token operator">></span> holdingQueue <span class="token operator">=</span> r<span class="token punctuation">.</span>pendingResponses<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å…ˆå°†å“åº”ç»“æœæ·»åŠ åˆ°ä¼˜å…ˆé˜Ÿåˆ—</span>
        holdingQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RpcResponse</span><span class="token punctuation">(</span>reqType<span class="token punctuation">,</span> seq<span class="token punctuation">,</span> status<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> rpcSendTime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å“åº”é˜Ÿåˆ—å †ç§¯è¶…è¿‡256</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>holdingQueue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> r<span class="token punctuation">.</span>raftOptions<span class="token punctuation">.</span><span class="token function">getMaxReplicatorInflightMsgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// é‡ç½®æ—§çš„å“åº”æ•°æ®</span>
            r<span class="token punctuation">.</span><span class="token function">resetInflights</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>state <span class="token operator">=</span> State<span class="token punctuation">.</span>Probe<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// é‡æ–°å‘é€Probeè¯·æ±‚</span>
            r<span class="token punctuation">.</span><span class="token function">sendEmptyEntries</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">boolean</span> continueSendEntries <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> processed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å¤„ç†é˜Ÿåˆ—ä¸­å †ç§¯çš„å“åº”ç»“æœ</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>holdingQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// è·å–é˜Ÿåˆ—å¤´çš„å“åº”ç»“æœï¼Œè¿™é‡Œæ˜¯ä»å°åˆ°å¤§æ’åˆ—ï¼Œå¯¹åº”æœ€æ—©çš„è¯·æ±‚çš„å“åº”</span>
                <span class="token keyword">final</span> RpcResponse queuedPipelinedResponse <span class="token operator">=</span> holdingQueue<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// åˆå§‹éƒ½ä¸º0ï¼Œç›¸ç­‰</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>queuedPipelinedResponse<span class="token punctuation">.</span>seq <span class="token operator">!=</span> r<span class="token punctuation">.</span>requiredNextSeq<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å¤„ç†ä¸­å‡ºç°äº†å¼‚å¸¸ï¼Œè·³è¿‡åé¢çš„</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>processed <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// è¿˜æ²¡æœ‰å¤„ç†çš„è¯ï¼Œä¸å†å¤„ç†</span>
                    <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        continueSendEntries <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                        id<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// å…ˆç§»é™¤å“åº”ç»“æœ</span>
                holdingQueue<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                processed<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å‘é€è¯·æ±‚åä¼šæ·»åŠ ä¸€ä¸ªInflightå…¥é˜Ÿåˆ—å°¾ï¼Œå¤„ç†æ—¶ä»é˜Ÿåˆ—å¤´å–å‡ºï¼ŒFIFO</span>
                <span class="token keyword">final</span> Inflight inflight <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">pollInflight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>inflight <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// è¯·æ±‚çš„åºåˆ—å·å’Œå–å‡ºçš„å“åº”çš„åºåˆ—å·ä¸ä¸€è‡´</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>inflight<span class="token punctuation">.</span>seq <span class="token operator">!=</span> queuedPipelinedResponse<span class="token punctuation">.</span>seq<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token comment" spellcheck="true">// é‡ç½®è¯·æ±‚çš„Inflighté˜Ÿåˆ—å’Œè¯·æ±‚çš„å“åº”é˜Ÿåˆ—</span>
                    r<span class="token punctuation">.</span><span class="token function">resetInflights</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    r<span class="token punctuation">.</span>state <span class="token operator">=</span> State<span class="token punctuation">.</span>Probe<span class="token punctuation">;</span>
                    continueSendEntries <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    r<span class="token punctuation">.</span><span class="token function">block</span><span class="token punctuation">(</span>Utils<span class="token punctuation">.</span><span class="token function">nowMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> RaftError<span class="token punctuation">.</span>EREQUEST<span class="token punctuation">.</span><span class="token function">getNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">switch</span> <span class="token punctuation">(</span>queuedPipelinedResponse<span class="token punctuation">.</span>requestType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">case</span> AppendEntries<span class="token operator">:</span>
                            <span class="token comment" spellcheck="true">// å¤„ç†å“åº”</span>
                            continueSendEntries <span class="token operator">=</span> <span class="token function">onAppendEntriesReturned</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> inflight<span class="token punctuation">,</span> queuedPipelinedResponse<span class="token punctuation">.</span>status<span class="token punctuation">,</span> <span class="token punctuation">(</span>AppendEntriesRequest<span class="token punctuation">)</span> queuedPipelinedResponse<span class="token punctuation">.</span>request<span class="token punctuation">,</span> <span class="token punctuation">(</span>AppendEntriesResponse<span class="token punctuation">)</span> queuedPipelinedResponse<span class="token punctuation">.</span>response<span class="token punctuation">,</span> rpcSendTime<span class="token punctuation">,</span> startTimeMs<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token keyword">case</span> Snapshot<span class="token operator">:</span>
                            <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>continueSendEntries<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// æˆåŠŸï¼Œå¢åŠ requiredNextSeq</span>
                        r<span class="token punctuation">.</span><span class="token function">getAndIncrementRequiredNextSeq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// å“åº”é˜Ÿåˆ—å¤„ç†ç»“æŸ</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// ç»§ç»­å‘é€æ—¥å¿—</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>continueSendEntries<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                r<span class="token punctuation">.</span><span class="token function">sendEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>Leaderå¤„ç†å“åº”</p>
<p>Replicator#onAppendEntriesReturned</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">onAppendEntriesReturned</span><span class="token punctuation">(</span><span class="token keyword">final</span> ThreadId id<span class="token punctuation">,</span> <span class="token keyword">final</span> Inflight inflight<span class="token punctuation">,</span> <span class="token keyword">final</span> Status status<span class="token punctuation">,</span> <span class="token keyword">final</span> AppendEntriesRequest request<span class="token punctuation">,</span> <span class="token keyword">final</span> AppendEntriesResponse response<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> rpcSendTime<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> startTimeMs<span class="token punctuation">,</span> <span class="token keyword">final</span> Replicator r<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ä¸€èˆ¬ä¸ä¼šå‘ç”Ÿ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>inflight<span class="token punctuation">.</span>startIndex <span class="token operator">!=</span> request<span class="token punctuation">.</span><span class="token function">getPrevLogIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span><span class="token function">resetInflights</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>state <span class="token operator">=</span> State<span class="token punctuation">.</span>Probe<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// unlock id in sendEmptyEntries</span>
            r<span class="token punctuation">.</span><span class="token function">sendEmptyEntries</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ä¸€äº›ç»Ÿè®¡</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getEntriesCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Followerå®•æœºï¼ŒRPCå¤±è´¥çš„æƒ…å†µ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>status<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">notifyReplicatorStatusListener</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> ReplicatorEvent<span class="token punctuation">.</span>ERROR<span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//é‡ç½®è¯·æ±‚çš„Inflighté˜Ÿåˆ—å’Œè¯·æ±‚çš„å“åº”é˜Ÿåˆ—</span>
            r<span class="token punctuation">.</span><span class="token function">resetInflights</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>state <span class="token operator">=</span> State<span class="token punctuation">.</span>Probe<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// unlock in in block</span>
            r<span class="token punctuation">.</span><span class="token function">block</span><span class="token punctuation">(</span>startTimeMs<span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        r<span class="token punctuation">.</span>consecutiveErrorTimes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Followeræ‹’ç»çš„æƒ…å†µ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>response<span class="token punctuation">.</span><span class="token function">getSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å¦‚æœFollowerçš„ä»»æœŸå¤§äºLeaderè‡ªå·±çš„ä»»æœŸ</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> r<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> NodeImpl node <span class="token operator">=</span> r<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// é€šçŸ¥å›è°ƒï¼ŒFollowerå·²è¿½ä¸Š</span>
                r<span class="token punctuation">.</span><span class="token function">notifyOnCaughtUp</span><span class="token punctuation">(</span>RaftError<span class="token punctuation">.</span>EPERM<span class="token punctuation">.</span><span class="token function">getNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// é”€æ¯è¯¥Replicator</span>
                r<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// Leaderé€€ä½ä¸ºFollowerï¼Œå¹¶æ›´æ–°ä»»æœŸï¼Œé‡æ–°å¯åŠ¨é€‰ä¸¾è®¡æ—¶</span>
                node<span class="token punctuation">.</span><span class="token function">increaseTermTo</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Status</span><span class="token punctuation">(</span>RaftError<span class="token punctuation">.</span>EHIGHERTERMRESPONSE<span class="token punctuation">,</span> <span class="token string">"Leader receives higher term heartbeat_response from peer:%s"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getPeerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// è¿”å›</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">// Followerçš„ä»»æœŸæ²¡æœ‰å¤§äºLeaderè‡ªå·±çš„ä»»æœŸï¼Œæ›´æ–°é€šè®¯æ—¶é—´æˆ³</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>rpcSendTime <span class="token operator">></span> r<span class="token punctuation">.</span>lastRpcSendTimestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                r<span class="token punctuation">.</span>lastRpcSendTimestamp <span class="token operator">=</span> rpcSendTime<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// é‡ç½®è¯·æ±‚çš„Inflighté˜Ÿåˆ—å’Œè¯·æ±‚çš„å“åº”é˜Ÿåˆ—</span>
            r<span class="token punctuation">.</span><span class="token function">resetInflights</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ç†æƒ³æƒ…å†µä¸‹ï¼Œå¯¹ç«¯Followeræœ€åçš„æ—¥å¿—IndexåŠ ä¸€åº”è¯¥å°±æ˜¯ä¸‹ä¸€ä¸ªè¦å‘é€çš„æ—¥å¿—çš„Indexï¼Œå¦‚æœå°äº†ï¼Œè¯´æ˜Followeræ—¥å¿—è¿›åº¦è½å</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getLastLogIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> r<span class="token punctuation">.</span>nextIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æ›´æ–°ä¸‹æ¬¡å‘é€Logçš„ä½ç½®</span>
                r<span class="token punctuation">.</span>nextIndex <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getLastLogIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// Followeræ—¥å¿—ä½ç½®æ¯”Leaderä¸‹ä¸ªå‘é€çš„æ—¥å¿—ä½ç½®å¤§æˆ–ä¸€æ ·ï¼Œè¯´æ˜å¯èƒ½éœ€è¦Followeråˆ é™¤æ—¥å¿—</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>nextIndex <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ä½ç½®å‡å‡ï¼ŒFolloweræ”¶åˆ°åæ£€æŸ¥ä¸€è‡´æ€§ï¼Œä¸€ç›´å‘å‰</span>
                    r<span class="token punctuation">.</span>nextIndex<span class="token operator">--</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ç»§ç»­å‘é€Probeè¯·æ±‚</span>
            r<span class="token punctuation">.</span><span class="token function">sendEmptyEntries</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// LogåŒæ­¥æˆåŠŸï¼ŒFolloweråœ¨åŒæ­¥å‰ä¼šåŒæ­¥Leaderçš„ä»»æœŸï¼Œå¦‚æœä¸ä¸€è‡´ï¼Œè¯´æ˜Leaderçš„ä»»æœŸåœ¨å‘å‡ºè¯·æ±‚åä¸Šå‡äº†ï¼Œä¸å†å¤„ç†</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> r<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span><span class="token function">resetInflights</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>state <span class="token operator">=</span> State<span class="token punctuation">.</span>Probe<span class="token punctuation">;</span>
            id<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// æ­£å¸¸æƒ…å†µï¼Œæ›´æ–°é€šè®¯æ—¶é—´æˆ³</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rpcSendTime <span class="token operator">></span> r<span class="token punctuation">.</span>lastRpcSendTimestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span>lastRpcSendTimestamp <span class="token operator">=</span> rpcSendTime<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> entriesSize <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getEntriesCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ˜¯ä¸ªå¤åˆ¶æ—¥å¿—è¯·æ±‚</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>entriesSize <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å¤§å¤šæ•°Followerå“åº”åŒæ­¥æˆåŠŸåLeaderæ‰èƒ½æäº¤æ—¥å¿—</span>
            r<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getBallotBox</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">commitAt</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>nextIndex<span class="token punctuation">,</span> r<span class="token punctuation">.</span>nextIndex <span class="token operator">+</span> entriesSize <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getPeerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// æ˜¯ä¸ªProbeè¯·æ±‚</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Probeå®Œååˆ‡æ¢åˆ°å¤åˆ¶çŠ¶æ€</span>
            r<span class="token punctuation">.</span>state <span class="token operator">=</span> State<span class="token punctuation">.</span>Replicate<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ä¸‹æ¬¡Logå¤åˆ¶çš„ç´¢å¼•</span>
        r<span class="token punctuation">.</span>nextIndex <span class="token operator">+=</span> entriesSize<span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>hasSucceeded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span><span class="token function">notifyOnCaughtUp</span><span class="token punctuation">(</span>RaftError<span class="token punctuation">.</span>SUCCESS<span class="token punctuation">.</span><span class="token function">getNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// dummy_id is unlock in _send_entries</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>timeoutNowIndex <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>timeoutNowIndex <span class="token operator">&lt;</span> r<span class="token punctuation">.</span>nextIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span><span class="token function">sendTimeoutNow</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>Leaderå‘é€æ—¥å¿—</p>
<p>Replicator#sendEntries</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">void</span> <span class="token function">sendEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> doUnlock <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">long</span> prevSendIndex <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å°½å¯èƒ½å¤šåœ°å‘é€Log</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token keyword">long</span> nextSendingIndex <span class="token operator">=</span> <span class="token function">getNextSendIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>nextSendingIndex <span class="token operator">></span> prevSendIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å‘é€</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sendEntries</span><span class="token punctuation">(</span>nextSendingIndex<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        prevSendIndex <span class="token operator">=</span> nextSendingIndex<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        doUnlock <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>doUnlock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>Replicator#getNextSendIndex</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">long</span> <span class="token function">getNextSendIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// å‘é€ä¸€ä¸ªAppendEntriesRequestæ·»åŠ ä¸€ä¸ªInflightï¼Œä»£è¡¨Pipelineå‘é€ï¼Œå¤„ç†å“åº”åç§»é™¤</span>
        <span class="token comment" spellcheck="true">// è¯´æ˜æ²¡æœ‰å †ç§¯ï¼ŒnextIndexåœ¨æ”¶åˆ°å“åº”æ—¶æ‰ä¼šæ›´æ–°</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>inflights<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>nextIndex<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å †ç§¯å¤ªå¤šï¼Œä¸å†å‘é€</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>inflights<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>raftOptions<span class="token punctuation">.</span><span class="token function">getMaxReplicatorInflightMsgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token operator">-</span>1L<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Pipelineæƒ…å†µä¸‹ï¼Œå‘é€ä¸‹ä¸€ä¸ªè¯·æ±‚æ—¶ä¸ä¸€å®šå·²ç»æ”¶åˆ°ä¸Šä¸€ä¸ªè¯·æ±‚çš„å“åº”</span>
        <span class="token comment" spellcheck="true">// å¦‚æœä¸Šä¸€ä¸ªå‘é€çš„æ˜¯æ·»åŠ æ—¥å¿—è¯·æ±‚ï¼Œä¸æ˜¯Probeè¯·æ±‚</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>rpcInFly <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rpcInFly<span class="token punctuation">.</span><span class="token function">isSendingLogEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ¥ç€å‘é€</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rpcInFly<span class="token punctuation">.</span>startIndex <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rpcInFly<span class="token punctuation">.</span>count<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>1L<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>Replicator#sendEntries</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">sendEntries</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">long</span> nextSendingIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> AppendEntriesRequest<span class="token punctuation">.</span>Builder rb <span class="token operator">=</span> AppendEntriesRequest<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å…ˆå°è¯•å¡«å……å¸¸ç”¨çš„å­—æ®µï¼šTermï¼ŒGroupIdï¼ŒServerIdï¼ŒPeerIdï¼ŒPrevLogIndexï¼ŒPrevLogTermï¼ŒCommittedIndex</span>
        <span class="token comment" spellcheck="true">// NextSendingIndexæ˜¯æœ¬æ¬¡Logå¤åˆ¶çš„èµ·å§‹Indexï¼ŒPrevLogIndexå°±æ˜¯ä¸Šæ¬¡å¤åˆ¶çš„Index</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">fillCommonFields</span><span class="token punctuation">(</span>rb<span class="token punctuation">,</span> nextSendingIndex <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        ByteBufferCollector dataBuf <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Logæ¡ç›®æ•°é‡</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> maxEntriesSize <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>raftOptions<span class="token punctuation">.</span><span class="token function">getMaxEntriesSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> RecyclableByteBufferList byteBufList <span class="token operator">=</span> RecyclableByteBufferList<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å¾ªç¯è·å–æ—¥å¿—</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> maxEntriesSize<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> RaftOutter<span class="token punctuation">.</span>EntryMeta<span class="token punctuation">.</span>Builder emb <span class="token operator">=</span> RaftOutter<span class="token punctuation">.</span>EntryMeta<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å‡†å¤‡è¯¥æ¡Log</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">prepareEntry</span><span class="token punctuation">(</span>nextSendingIndex<span class="token punctuation">,</span> i<span class="token punctuation">,</span> emb<span class="token punctuation">,</span> byteBufList<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// æ·»åŠ </span>
                rb<span class="token punctuation">.</span><span class="token function">addEntries</span><span class="token punctuation">(</span>emb<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// æš‚æ—¶æ²¡è·å–åˆ°æ–°çš„Log</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">getEntriesCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>nextSendingIndex <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getLogManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFirstLogIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">installSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// æ·»åŠ ä¸‹æ¬¡æœŸå¾…çš„æ—¥å¿—ä½ç½®åˆ°ç¼“å­˜ï¼ŒLeaderæ·»åŠ æ–°æ—¥å¿—åå›è°ƒ</span>
                <span class="token function">waitMoreEntries</span><span class="token punctuation">(</span>nextSendingIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>byteBufList<span class="token punctuation">.</span><span class="token function">getCapacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                dataBuf <span class="token operator">=</span> ByteBufferCollector<span class="token punctuation">.</span><span class="token function">allocateByRecyclers</span><span class="token punctuation">(</span>byteBufList<span class="token punctuation">.</span><span class="token function">getCapacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> ByteBuffer b <span class="token operator">:</span> byteBufList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    dataBuf<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">final</span> ByteBuffer buf <span class="token operator">=</span> dataBuf<span class="token punctuation">.</span><span class="token function">getBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                buf<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// æ·»åŠ æ—¥å¿—çš„ç¼“å†²æ•°æ®</span>
                rb<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>ZeroByteStringHelper<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            RecycleUtil<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span>byteBufList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// åˆ›å»ºè¯·æ±‚</span>
        <span class="token keyword">final</span> AppendEntriesRequest request <span class="token operator">=</span> rb<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>statInfo<span class="token punctuation">.</span>runningState <span class="token operator">=</span> RunningState<span class="token punctuation">.</span>APPENDING_ENTRIES<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>statInfo<span class="token punctuation">.</span>firstLogIndex <span class="token operator">=</span> rb<span class="token punctuation">.</span><span class="token function">getPrevLogIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>statInfo<span class="token punctuation">.</span>lastLogIndex <span class="token operator">=</span> rb<span class="token punctuation">.</span><span class="token function">getPrevLogIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> rb<span class="token punctuation">.</span><span class="token function">getEntriesCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> Recyclable recyclable <span class="token operator">=</span> dataBuf<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> v <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>version<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> monotonicSendTimeMs <span class="token operator">=</span> Utils<span class="token punctuation">.</span><span class="token function">monotonicMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// åºåˆ—å·</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> seq <span class="token operator">=</span> <span class="token function">getAndIncrementReqSeq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// RPCå‘é€</span>
        <span class="token keyword">final</span> Future<span class="token operator">&lt;</span>Message<span class="token operator">></span> rpcFuture <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rpcService<span class="token punctuation">.</span><span class="token function">appendEntries</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getPeerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">RpcResponseClosureAdapter</span><span class="token operator">&lt;</span>AppendEntriesResponse<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">final</span> Status status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                RecycleUtil<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span>recyclable<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å“åº”å›è°ƒ</span>
                <span class="token function">onRpcReturned</span><span class="token punctuation">(</span>Replicator<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token punctuation">,</span> RequestType<span class="token punctuation">.</span>AppendEntries<span class="token punctuation">,</span> status<span class="token punctuation">,</span> request<span class="token punctuation">,</span> <span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> seq<span class="token punctuation">,</span> v<span class="token punctuation">,</span> monotonicSendTimeMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//</span>
        <span class="token function">addInflight</span><span class="token punctuation">(</span>RequestType<span class="token punctuation">.</span>AppendEntries<span class="token punctuation">,</span> nextSendingIndex<span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getEntriesCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> seq<span class="token punctuation">,</span> rpcFuture<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>é™„å¸¦Counterçš„è¯»ä¾‹å­</p>
<p>GetValueRequestProcessor#handleRequest</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> Object <span class="token function">handleRequest</span><span class="token punctuation">(</span><span class="token keyword">final</span> BizContext bizCtx<span class="token punctuation">,</span> <span class="token keyword">final</span> GetValueRequest request<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// å¦‚æœå½“å‰Serverä¸æ˜¯Leader</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>counterServer<span class="token punctuation">.</span><span class="token function">getFsm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// é‡å®šå‘åˆ°Leaderï¼ŒåŒ…å«äº†Leaderçš„PeerId</span>
            <span class="token comment" spellcheck="true">// å…¶å®Followerä¹Ÿèƒ½å¤„ç†è¯»è¯·æ±‚ï¼Œä¸€è‡´æ€§è¯»çš„æƒ…å†µä¸‹ä¸ä¼šå‘ç”Ÿè„è¯»</span>
            <span class="token comment" spellcheck="true">// ä½†æ˜¯èŠ‚ç‚¹é—´çš„å¤åˆ¶æ˜¯å¼‚æ­¥çš„ï¼Œåœ¨æ—¥å¿—è½åå¤ªå¤šçš„æƒ…å†µä¸‹ï¼Œå“åº”æ—¶é—´ä¼šæ¯”è¾ƒé•¿ï¼Œæ‰€ä»¥éƒ½äº¤ç»™Leader</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>counterServer<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å½“å‰Serveræ˜¯Leaderï¼Œå¤„ç†è¯»è¯·æ±‚</span>
        <span class="token keyword">final</span> ValueResponse response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ValueResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setSuccess</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Leaderç›´æ¥ä»çŠ¶æ€æœºè·å–å€¼ï¼Œè¿™é‡Œåº”è¯¥æ²¡æœ‰ä¸€è‡´æ€§è¯»çš„å¤„ç†ï¼Ÿ</span>
        response<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>counterServer<span class="token punctuation">.</span><span class="token function">getFsm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> response<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


        <footer>
             
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

        </footer>
    </div>
    <!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
    <script>
        var timeEnd = new Date();
        console.log('è€—æ—¶ï¼š' + (timeEnd - timeStart));
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre').forEach((block) => {
                block.classList.add("line-numbers");
            });
        });
    </script>
    <!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
    <!-- material design -->
    <!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
    <!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
    <!-- toc -->
    <!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
    <!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
    <!-- <script src="/js/main.js"></script> -->
    <script src="/js/prism.js"></script>
</body>
</html>
