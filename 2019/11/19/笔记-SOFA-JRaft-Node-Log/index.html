<!DOCTYPE HTML>
<html>

<head>
    <script>
        var timeStart = new Date();
    </script>
    <meta charset="utf-8">
    
    <title>[笔记]-SOFA-JRaft-Node-Log | 草木禾</title>
    
    <meta name="author" content="huangzhike">
    
    
    <meta name="description"
        content="Snapshot和Configuration部分暂时没有关注。

以Counter为例，略过CounterClient和CounterServer的实现
Leader收到写请求
IncrementAndGetRequestProcessor#handleRequest
    @Override
 ">
    
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta property="og:title" content="[笔记]-SOFA-JRaft-Node-Log" />
    
    <meta property="og:site_name" content="草木禾" />
    
    
    <!-- favicon -->
    <link rel="icon" type="image/ico" href="/logo.ico" sizes="32x32">
    <meta name="msapplication-TileColor" content="#009688">
    <meta name="msapplication-TileImage" content="/mstile-144x144.ico">
    <meta name="theme-color" content="#009688">
    <!-- favicon end -->
    <!-- <link href="//ok.ico" rel="icon"> -->
    

    <!-- <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.5.0/css/bootstrap.min.css" rel="stylesheet"> -->
    <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
    <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
    <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">

<meta name="generator" content="Hexo 4.2.1"></head>
<body>
    <nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">菜单</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" title="早く来い、クラウド" href="/">Reunion...</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" target="_blank" rel="noopener" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

    <div class="container" >
        <div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[笔记]-SOFA-JRaft-Node-Log</h2>
				
				<div>
					<div class="post-time">2019-11-19</div>
				</div>
				
				<div class="article-content">
				<p>Snapshot和Configuration部分暂时没有关注。</p>
<hr>
<p>以Counter为例，略过CounterClient和CounterServer的实现</p>
<p>Leader收到写请求</p>
<p>IncrementAndGetRequestProcessor#handleRequest</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleRequest</span><span class="token punctuation">(</span><span class="token keyword">final</span> BizContext bizCtx<span class="token punctuation">,</span> <span class="token keyword">final</span> AsyncContext asyncCtx<span class="token punctuation">,</span> <span class="token keyword">final</span> IncrementAndGetRequest request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 如果当前Server不是Leader</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>counterServer<span class="token punctuation">.</span><span class="token function">getFsm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 返回重定向响应，包含了Leader的PeerId</span>
            asyncCtx<span class="token punctuation">.</span><span class="token function">sendResponse</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>counterServer<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 当前Server是Leader，处理写请求</span>
        <span class="token keyword">final</span> ValueResponse response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ValueResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 创建回调</span>
        <span class="token keyword">final</span> IncrementAndAddClosure closure <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IncrementAndAddClosure</span><span class="token punctuation">(</span>counterServer<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> status <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 失败</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>status<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 返回错误信息</span>
                response<span class="token punctuation">.</span><span class="token function">setErrorMsg</span><span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">getErrorMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                response<span class="token punctuation">.</span><span class="token function">setSuccess</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">/*
             * 应用到状态机成功，返回应答
             * 这里有个问题，如果Leader在应用日志后崩溃，响应客户端失败，然后Client重试新的Leader，则会导致重复日志和执行
             * 为了实现幂等，请求应该携带一个唯一标识，Server执行前先校验
             */</span>
            asyncCtx<span class="token punctuation">.</span><span class="token function">sendResponse</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 创建任务</span>
            <span class="token keyword">final</span> Task task <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 设置回调</span>
            task<span class="token punctuation">.</span><span class="token function">setDone</span><span class="token punctuation">(</span>closure<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 填充请求数据</span>
            task<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>ByteBuffer<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>SerializerManager<span class="token punctuation">.</span><span class="token function">getSerializer</span><span class="token punctuation">(</span>SerializerManager<span class="token punctuation">.</span>Hessian2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 尝试发布日志，等待应用</span>
            counterServer<span class="token punctuation">.</span><span class="token function">getNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">final</span> CodecException e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>NodeImpl#apply</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">final</span> Task task<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 节点正在关闭</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>shutdownLatch <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 提交给回调线程池，执行失败回调</span>
            Utils<span class="token punctuation">.</span><span class="token function">runClosureInThread</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Status</span><span class="token punctuation">(</span>RaftError<span class="token punctuation">.</span>ENODESHUTDOWN<span class="token punctuation">,</span> <span class="token string">"Node is shutting down."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Node is shutting down"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        Requires<span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> <span class="token string">"Null task"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 创建一个Log条目</span>
        <span class="token keyword">final</span> LogEntry entry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LogEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        entry<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> retryTimes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//</span>
            <span class="token keyword">final</span> EventTranslator<span class="token operator">&lt;</span>LogEntryAndClosure<span class="token operator">></span> translator <span class="token operator">=</span> <span class="token punctuation">(</span>event<span class="token punctuation">,</span> sequence<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
                event<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                event<span class="token punctuation">.</span>done <span class="token operator">=</span> task<span class="token punctuation">.</span><span class="token function">getDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                event<span class="token punctuation">.</span>entry <span class="token operator">=</span> entry<span class="token punctuation">;</span>
                event<span class="token punctuation">.</span>expectedTerm <span class="token operator">=</span> task<span class="token punctuation">.</span><span class="token function">getExpectedTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 重试发布事件</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 发布到RingBuffer成功</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>applyQueue<span class="token punctuation">.</span><span class="token function">tryPublishEvent</span><span class="token punctuation">(</span>translator<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    retryTimes<span class="token operator">++</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// 超出重试次数</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>retryTimes <span class="token operator">></span> MAX_APPLY_RETRY_TIMES<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 提交给回调线程池，执行失败回调</span>
                        Utils<span class="token punctuation">.</span><span class="token function">runClosureInThread</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Status</span><span class="token punctuation">(</span>RaftError<span class="token punctuation">.</span>EBUSY<span class="token punctuation">,</span> <span class="token string">"Node is busy, has too many tasks."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// Thread#yield</span>
                    ThreadHelper<span class="token punctuation">.</span><span class="token function">onSpinWait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">final</span> Exception e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 提交给回调线程池，执行失败回调</span>
            Utils<span class="token punctuation">.</span><span class="token function">runClosureInThread</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token function">getDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Status</span><span class="token punctuation">(</span>RaftError<span class="token punctuation">.</span>EPERM<span class="token punctuation">,</span> <span class="token string">"Node is down."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>Leader处理日志事件</p>
<p>NodeImpl$LogEntryAndClosureHandler#onEvent</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onEvent</span><span class="token punctuation">(</span><span class="token keyword">final</span> LogEntryAndClosure event<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> sequence<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> endOfBatch<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 如果在关闭</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>shutdownLatch <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 事件列表不为空</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 批量执行任务</span>
                    <span class="token function">executeApplyingTasks</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">final</span> <span class="token keyword">int</span> num <span class="token operator">=</span> GLOBAL_NUM_NODES<span class="token punctuation">.</span><span class="token function">decrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ...</span>
                event<span class="token punctuation">.</span>shutdownLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 正常情况，先将事件加入任务列表</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 如果事件数量大于批量执行的数量，默认32 || 有批量结束的标记</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> NodeImpl<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>raftOptions<span class="token punctuation">.</span><span class="token function">getApplyBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> endOfBatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 批量执行任务</span>
                <span class="token function">executeApplyingTasks</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 执行完就清空任务</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span></code></pre>
<p>NodeImpl#executeApplyingTasks</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">executeApplyingTasks</span><span class="token punctuation">(</span><span class="token keyword">final</span> List<span class="token operator">&lt;</span>LogEntryAndClosure<span class="token operator">></span> tasks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 其实Disruptor这里是MPSC的，即单线程消费，所以理论上这里不会有并发写的问题</span>
        <span class="token comment" spellcheck="true">// 猜测这里加写锁是为了处理可见性的问题，避免没写完成就被读到</span>
        <span class="token comment" spellcheck="true">// 如果数据不是很大并且实时要求不高的话，也可以使用CopyOnWrite，读的时候是无锁的</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> size <span class="token operator">=</span> tasks<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// Leader才能执行</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">!=</span> State<span class="token punctuation">.</span>STATE_LEADER<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 回调，略</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">final</span> List<span class="token operator">&lt;</span>LogEntry<span class="token operator">></span> entries <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 遍历事件</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> LogEntryAndClosure task <span class="token operator">=</span> tasks<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 如果Leader发布事件时的任期和现在的当前任期不一致</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">.</span>expectedTerm <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> task<span class="token punctuation">.</span>expectedTerm <span class="token operator">!=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 回调，略</span>
                    <span class="token comment" spellcheck="true">// 跳过</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 将任务追加到投票箱的队列，Leader收到大多数Follower的日志响应后会调用BallotBox#commitAt取出任务提交并执行状态机</span>
                <span class="token comment" spellcheck="true">// 如果失败</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>ballotBox<span class="token punctuation">.</span><span class="token function">appendPendingTask</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>conf<span class="token punctuation">.</span><span class="token function">getConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>conf<span class="token punctuation">.</span><span class="token function">isStable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> null <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>conf<span class="token punctuation">.</span><span class="token function">getOldConf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> task<span class="token punctuation">.</span>done<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 提交给回调线程池，执行对应的失败回调</span>
                    Utils<span class="token punctuation">.</span><span class="token function">runClosureInThread</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>done<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Status</span><span class="token punctuation">(</span>RaftError<span class="token punctuation">.</span>EINTERNAL<span class="token punctuation">,</span> <span class="token string">"Fail to append task."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// 跳过</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                task<span class="token punctuation">.</span>entry<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setTerm</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">)</span><span class="token punctuation">;</span>
                task<span class="token punctuation">.</span>entry<span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span>EnumOutter<span class="token punctuation">.</span>EntryType<span class="token punctuation">.</span>ENTRY_TYPE_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 暂存日志事件</span>
                entries<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 将日志加入LogManager，包含了回调LeaderStableClosure</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>logManager<span class="token punctuation">.</span><span class="token function">appendEntries</span><span class="token punctuation">(</span>entries<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">LeaderStableClosure</span><span class="token punctuation">(</span>entries<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// update conf.first</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>conf <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>logManager<span class="token punctuation">.</span><span class="token function">checkAndSetConfiguration</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>LogManagerImpl#appendEntries追加日志持久化见后面，这里略</p>
<hr>
<p>Leader发送空白条目，HeartBeat或Probe</p>
<p>Replicator#sendEmptyEntries</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">sendEmptyEntries</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">boolean</span> isHeartbeat<span class="token punctuation">,</span> <span class="token keyword">final</span> RpcResponseClosure<span class="token operator">&lt;</span>AppendEntriesResponse<span class="token operator">></span> heartBeatClosure<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> AppendEntriesRequest<span class="token punctuation">.</span>Builder rb <span class="token operator">=</span> AppendEntriesRequest<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Leader为每个Follower维护了一个NextIndex，表示下一个需要发送的Log的Index，Leader上台后初始化为本地日志LastLogIndex+1</span>
        <span class="token comment" spellcheck="true">// 先尝试填充常用的字段：Term，GroupId，ServerId，PeerId，PrevLogIndex，PrevLogTerm，CommittedIndex</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">fillCommonFields</span><span class="token punctuation">(</span>rb<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>nextIndex <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> isHeartbeat<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> monotonicSendTimeMs <span class="token operator">=</span> Utils<span class="token punctuation">.</span><span class="token function">monotonicMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 创建空的添加条目请求</span>
            <span class="token keyword">final</span> AppendEntriesRequest request <span class="token operator">=</span> rb<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 如果是心跳</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isHeartbeat<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 心跳计数</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>heartbeatCounter<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 心跳应答的回调</span>
                RpcResponseClosure<span class="token operator">&lt;</span>AppendEntriesResponse<span class="token operator">></span> heartbeatDone<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>heartBeatClosure <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    heartbeatDone <span class="token operator">=</span> heartBeatClosure<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    heartbeatDone <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RpcResponseClosureAdapter</span><span class="token operator">&lt;</span>AppendEntriesResponse<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                        <span class="token annotation punctuation">@Override</span>
                        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">final</span> Status status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// 心跳响应回调</span>
                            <span class="token function">onHeartbeatReturned</span><span class="token punctuation">(</span>Replicator<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token punctuation">,</span> status<span class="token punctuation">,</span> request<span class="token punctuation">,</span> <span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> monotonicSendTimeMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// RPC发送心跳，返回Future</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>heartbeatInFly <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rpcService<span class="token punctuation">.</span><span class="token function">appendEntries</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getPeerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getElectionTimeoutMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> heartbeatDone<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 如果是Probe请求，因为Leader需要知道Follower当前的Log位置，方便同步</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 日志输出用</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>statInfo<span class="token punctuation">.</span>runningState <span class="token operator">=</span> RunningState<span class="token punctuation">.</span>APPENDING_ENTRIES<span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>statInfo<span class="token punctuation">.</span>firstLogIndex <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>nextIndex<span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>statInfo<span class="token punctuation">.</span>lastLogIndex <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>nextIndex <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>appendEntriesCounter<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> State<span class="token punctuation">.</span>Probe<span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token keyword">int</span> stateVersion <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>version<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 先返回全局序列号，再自增</span>
                <span class="token keyword">final</span> <span class="token keyword">int</span> seq <span class="token operator">=</span> <span class="token function">getAndIncrementReqSeq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// RPC发送Probe，返回Future</span>
                <span class="token keyword">final</span> Future<span class="token operator">&lt;</span>Message<span class="token operator">></span> rpcFuture <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rpcService<span class="token punctuation">.</span><span class="token function">appendEntries</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getPeerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">RpcResponseClosureAdapter</span><span class="token operator">&lt;</span>AppendEntriesResponse<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">final</span> Status status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// Probe响应回调</span>
                        <span class="token function">onRpcReturned</span><span class="token punctuation">(</span>Replicator<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token punctuation">,</span> RequestType<span class="token punctuation">.</span>AppendEntries<span class="token punctuation">,</span> status<span class="token punctuation">,</span> request<span class="token punctuation">,</span> <span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> seq<span class="token punctuation">,</span> stateVersion<span class="token punctuation">,</span> monotonicSendTimeMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 发送后添加一个Inflight入队列</span>
                <span class="token function">addInflight</span><span class="token punctuation">(</span>RequestType<span class="token punctuation">.</span>AppendEntries<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>nextIndex<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> seq<span class="token punctuation">,</span> rpcFuture<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 释放Replicator的锁</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>Replicator#fillCommonFields</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">fillCommonFields</span><span class="token punctuation">(</span><span class="token keyword">final</span> AppendEntriesRequest<span class="token punctuation">.</span>Builder rb<span class="token punctuation">,</span> <span class="token keyword">long</span> prevLogIndex<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> isHeartbeat<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 获取该Index的Log对应的Term</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> prevLogTerm <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getLogManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span>prevLogIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>prevLogTerm <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> prevLogIndex <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        rb<span class="token punctuation">.</span><span class="token function">setTerm</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Leader的任期</span>
        rb<span class="token punctuation">.</span><span class="token function">setGroupId</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getGroupId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 集群名称</span>
        rb<span class="token punctuation">.</span><span class="token function">setServerId</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getServerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Leader的ServerId</span>
        rb<span class="token punctuation">.</span><span class="token function">setPeerId</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getPeerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 对端Follower的PeerId</span>
        rb<span class="token punctuation">.</span><span class="token function">setPrevLogIndex</span><span class="token punctuation">(</span>prevLogIndex<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 上次发送的Log的Index</span>
        rb<span class="token punctuation">.</span><span class="token function">setPrevLogTerm</span><span class="token punctuation">(</span>prevLogTerm<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 上次发送的Log的Term</span>
        rb<span class="token punctuation">.</span><span class="token function">setCommittedIndex</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getBallotBox</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLastCommittedIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Leader的Log的提交位置</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>Follower收到Heartbeat或Probe或追加日志请求</p>
<p>NodeImpl#handleAppendEntriesRequest</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> Message <span class="token function">handleAppendEntriesRequest</span><span class="token punctuation">(</span><span class="token keyword">final</span> AppendEntriesRequest request<span class="token punctuation">,</span> <span class="token keyword">final</span> RpcRequestClosure done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> entriesCount <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getEntriesCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 节点未激活，响应异常</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">isActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">final</span> PeerId serverId <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PeerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 解析对端ServerId异常，响应异常</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>serverId<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getServerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 对端的任期比自己当前的任期小，不接受日志</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> AppendEntriesResponse<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//</span>
                        <span class="token punctuation">.</span><span class="token function">setSuccess</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//</span>
                        <span class="token punctuation">.</span><span class="token function">setTerm</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 通知对方Leader下台</span>
                        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 此时对端Leader的任期肯定是大于等于自身任期的，判断是否需要更新任期</span>
            <span class="token function">checkStepDown</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> serverId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 对端Leader不是当前节点的Leader</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>serverId<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>leaderId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 提升本地任期，当前Leader下次心跳后就会下台，减少分脑的影响</span>
                <span class="token function">stepDown</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Status</span><span class="token punctuation">(</span>RaftError<span class="token punctuation">.</span>ELEADERCONFLICT<span class="token punctuation">,</span> <span class="token string">"More than one leader in the same term."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> AppendEntriesResponse<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//</span>
                        <span class="token punctuation">.</span><span class="token function">setSuccess</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//</span>
                        <span class="token punctuation">.</span><span class="token function">setTerm</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 让对端Leader也下台，重新选举</span>
                        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 一切正常，更新Leader通信时间戳</span>
            <span class="token function">updateLastLeaderTimestamp</span><span class="token punctuation">(</span>Utils<span class="token punctuation">.</span><span class="token function">monotonicMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 节点安装Snapshot的时候不接受日志</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>entriesCount <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>snapshotExecutor <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>snapshotExecutor<span class="token punctuation">.</span><span class="token function">isInstallingSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// Leader上次同步的Log的Index</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> prevLogIndex <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getPrevLogIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// Leader上次同步的Log的Term</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> prevLogTerm <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getPrevLogTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">final</span> <span class="token keyword">long</span> localPrevLogTerm <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>logManager<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span>prevLogIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 一致性检查，同一个Index的Log，但Term不一致，不接受日志</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>localPrevLogTerm <span class="token operator">!=</span> prevLogTerm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 本地的最后一条Log的索引</span>
                <span class="token keyword">final</span> <span class="token keyword">long</span> lastLogIndex <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>logManager<span class="token punctuation">.</span><span class="token function">getLastLogIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> AppendEntriesResponse<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//</span>
                        <span class="token punctuation">.</span><span class="token function">setSuccess</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//</span>
                        <span class="token punctuation">.</span><span class="token function">setTerm</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 自己当前的任期</span>
                        <span class="token punctuation">.</span><span class="token function">setLastLogIndex</span><span class="token punctuation">(</span>lastLogIndex<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 通知对方Leader发送Log的起点</span>
                        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 空的说明是Heartbeat或Probe</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>entriesCount <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 心跳响应包含自己的任期，方便对方检查</span>
                <span class="token keyword">final</span> AppendEntriesResponse<span class="token punctuation">.</span>Builder respBuilder <span class="token operator">=</span> AppendEntriesResponse<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//</span>
                        <span class="token punctuation">.</span><span class="token function">setSuccess</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//</span>
                        <span class="token punctuation">.</span><span class="token function">setTerm</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 自己当前的任期</span>
                        <span class="token punctuation">.</span><span class="token function">setLastLogIndex</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logManager<span class="token punctuation">.</span><span class="token function">getLastLogIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Follower自己本地最后一条Log的Index</span>
                doUnlock <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 同步Leader的Log提交位置，同时也会提交任务，应用到自己的状态机，所以Follower的状态机至少比Leader落后一个心跳</span>
                <span class="token comment" spellcheck="true">// 取最小的一个，因为Follower日志可能落后</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>ballotBox<span class="token punctuation">.</span><span class="token function">setLastCommittedIndex</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getCommittedIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> prevLogIndex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 返回心跳响应</span>
                <span class="token keyword">return</span> respBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 非空白的Log条目，追加日志</span>
            <span class="token keyword">long</span> index <span class="token operator">=</span> prevLogIndex<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 暂存要添加到本地的LogEntry列表</span>
            <span class="token keyword">final</span> List<span class="token operator">&lt;</span>LogEntry<span class="token operator">></span> entries <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>entriesCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ByteBuffer allData <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">hasData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                allData <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asReadOnlyByteBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">final</span> List<span class="token operator">&lt;</span>RaftOutter<span class="token punctuation">.</span>EntryMeta<span class="token operator">></span> entriesList <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getEntriesList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 遍历发送过来的日志条目</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> entriesCount<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Log数据</span>
                <span class="token keyword">final</span> RaftOutter<span class="token punctuation">.</span>EntryMeta entry <span class="token operator">=</span> entriesList<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                index<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> EnumOutter<span class="token punctuation">.</span>EntryType<span class="token punctuation">.</span>ENTRY_TYPE_UNKNOWN<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 创建LogEntry</span>
                    <span class="token keyword">final</span> LogEntry logEntry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LogEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// LogIndex LogTerm</span>
                    logEntry<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LogId</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> entry<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    logEntry<span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">hasChecksum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">final</span> <span class="token keyword">long</span> dataLen <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getDataLen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>dataLen <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// 如果LogEntry包含了Peer数据</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getPeersCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> EnumOutter<span class="token punctuation">.</span>EntryType<span class="token punctuation">.</span>ENTRY_TYPE_CONFIGURATION<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// Validate checksum</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>raftOptions<span class="token punctuation">.</span><span class="token function">isEnableLogEntryChecksum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> logEntry<span class="token punctuation">.</span><span class="token function">isCorrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// 添加LogEntry</span>
                    entries<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>logEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">final</span> FollowerStableClosure closure <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FollowerStableClosure</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> AppendEntriesResponse<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setTerm</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> done<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 将来自Leader的数据写入日志，传入了回调FollowerStableClosure</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>logManager<span class="token punctuation">.</span><span class="token function">appendEntries</span><span class="token punctuation">(</span>entries<span class="token punctuation">,</span> closure<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>conf <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>logManager<span class="token punctuation">.</span><span class="token function">checkAndSetConfiguration</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>Follower检查任期</p>
<p>NodeImpl#checkStepDown</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">checkStepDown</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">long</span> requestTerm<span class="token punctuation">,</span> <span class="token keyword">final</span> PeerId serverId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> Status status <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 正常情况下任期应该是一致的，大于的话就要更新任期，Leader的话还要转为Follower</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>requestTerm <span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>currTerm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            status<span class="token punctuation">.</span><span class="token function">setError</span><span class="token punctuation">(</span>RaftError<span class="token punctuation">.</span>ENEWLEADER<span class="token punctuation">,</span> <span class="token string">"Raft node receives message from new leader with higher term."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">stepDown</span><span class="token punctuation">(</span>requestTerm<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 任期一致，但是当前节点是Candidate，那么得转为Follower</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">!=</span> State<span class="token punctuation">.</span>STATE_FOLLOWER<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            status<span class="token punctuation">.</span><span class="token function">setError</span><span class="token punctuation">(</span>RaftError<span class="token punctuation">.</span>ENEWLEADER<span class="token punctuation">,</span> <span class="token string">"Candidate receives message from new leader with the same term."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">stepDown</span><span class="token punctuation">(</span>requestTerm<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Follower收到了一个任期一致的新Leader</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>leaderId<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            status<span class="token punctuation">.</span><span class="token function">setError</span><span class="token punctuation">(</span>RaftError<span class="token punctuation">.</span>ENEWLEADER<span class="token punctuation">,</span> <span class="token string">"Follower receives message from new leader with the same term."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">stepDown</span><span class="token punctuation">(</span>requestTerm<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 保存当前Leader</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>leaderId <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>leaderId<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">resetLeaderId</span><span class="token punctuation">(</span>serverId<span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>Follower设置日志提交位置</p>
<p>BallotBox#setLastCommittedIndex</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">setLastCommittedIndex</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">long</span> lastCommittedIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> doUnlock <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> stamp <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>stampedLock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 初始状态下PendingIndex==0，PendingMetaQueue为空，否则说明节点变成了Leader</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pendingIndex <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>pendingMetaQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 不需要提交</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>lastCommittedIndex <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lastCommittedIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>lastCommittedIndex <span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>lastCommittedIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 更新位置</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>lastCommittedIndex <span class="token operator">=</span> lastCommittedIndex<span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>stampedLock<span class="token punctuation">.</span><span class="token function">unlockWrite</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                doUnlock <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 提交到状态机</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>waiter<span class="token punctuation">.</span><span class="token function">onCommitted</span><span class="token punctuation">(</span>lastCommittedIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>doUnlock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>stampedLock<span class="token punctuation">.</span><span class="token function">unlockWrite</span><span class="token punctuation">(</span>stamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>FSMCallerImpl#onCommitted</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">onCommitted</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">long</span> committedIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 生成Committed事件，发布到状态机的RingBuffer</span>
        <span class="token keyword">return</span> <span class="token function">enqueueTask</span><span class="token punctuation">(</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> sequence<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 任务类型为COMMITTED</span>
            task<span class="token punctuation">.</span>type <span class="token operator">=</span> TaskType<span class="token punctuation">.</span>COMMITTED<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 提交的位置</span>
            task<span class="token punctuation">.</span>committedIndex <span class="token operator">=</span> committedIndex<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>FSMCallerImpl#runApplyTask</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"ConstantConditions"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> <span class="token function">runApplyTask</span><span class="token punctuation">(</span><span class="token keyword">final</span> ApplyTask task<span class="token punctuation">,</span> <span class="token keyword">long</span> maxCommittedIndex<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> endOfBatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        CountDownLatch shutdown <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 提交日志</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">.</span>type <span class="token operator">==</span> TaskType<span class="token punctuation">.</span>COMMITTED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>task<span class="token punctuation">.</span>committedIndex <span class="token operator">></span> maxCommittedIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                maxCommittedIndex <span class="token operator">=</span> task<span class="token punctuation">.</span>committedIndex<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>endOfBatch <span class="token operator">&amp;&amp;</span> maxCommittedIndex <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>currTask <span class="token operator">=</span> TaskType<span class="token punctuation">.</span>COMMITTED<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 执行提交</span>
                <span class="token function">doCommitted</span><span class="token punctuation">(</span>maxCommittedIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                maxCommittedIndex <span class="token operator">=</span> <span class="token operator">-</span>1L<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// reset maxCommittedIndex</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>currTask <span class="token operator">=</span> TaskType<span class="token punctuation">.</span>IDLE<span class="token punctuation">;</span>
            <span class="token keyword">return</span> maxCommittedIndex<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>FSMCallerImpl#doCommitted</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doCommitted</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">long</span> committedIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>error<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">//</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> lastAppliedIndex <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lastAppliedIndex<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 忽略乱序</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lastAppliedIndex <span class="token operator">>=</span> committedIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> startMs <span class="token operator">=</span> Utils<span class="token punctuation">.</span><span class="token function">monotonicMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> List<span class="token operator">&lt;</span>Closure<span class="token operator">></span> closures <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> List<span class="token operator">&lt;</span>TaskClosure<span class="token operator">></span> taskClosures <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// Closure由Leader收到Client消息后创建并加入队列，在这里批量取出并填充到TaskClosure列表和Closure列表，返回第一个日志回调的索引</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> firstClosureIndex <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>closureQueue<span class="token punctuation">.</span><span class="token function">popClosureUntil</span><span class="token punctuation">(</span>committedIndex<span class="token punctuation">,</span> closures<span class="token punctuation">,</span> taskClosures<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 遍历TaskClosure列表，调用TaskClosure#onCommitted方法，具体实现由客户自定义，这里默认啥也没干</span>
            <span class="token function">onTaskCommitted</span><span class="token punctuation">(</span>taskClosures<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Requires<span class="token punctuation">.</span><span class="token function">requireTrue</span><span class="token punctuation">(</span>firstClosureIndex <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"Invalid firstClosureIndex"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 迭代器</span>
            <span class="token keyword">final</span> IteratorImpl iterImpl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IteratorImpl</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fsm<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>logManager<span class="token punctuation">,</span> closures<span class="token punctuation">,</span> firstClosureIndex<span class="token punctuation">,</span> lastAppliedIndex<span class="token punctuation">,</span> committedIndex<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>applyingIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 直到应用完</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>iterImpl<span class="token punctuation">.</span><span class="token function">isGood</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> LogEntry logEntry <span class="token operator">=</span> iterImpl<span class="token punctuation">.</span><span class="token function">entry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 非数据型的条目</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>logEntry<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> EnumOutter<span class="token punctuation">.</span>EntryType<span class="token punctuation">.</span>ENTRY_TYPE_DATA<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 配置相关，略</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 执行任务，应用到状态机</span>
                <span class="token function">doApplyTasks</span><span class="token punctuation">(</span>iterImpl<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>iterImpl<span class="token punctuation">.</span><span class="token function">hasError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 到这里状态机已应用完成</span>
            <span class="token comment" spellcheck="true">// 本批最后一个应用的条目的上一个位置，暂时不知道为什么两个AppliedId不一样</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> lastIndex <span class="token operator">=</span> iterImpl<span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> lastTerm <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>logManager<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span>lastIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> LogId lastAppliedId <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LogId</span><span class="token punctuation">(</span>lastIndex<span class="token punctuation">,</span> lastTerm<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 更新状态机的LastAppliedIndex</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>lastAppliedIndex<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>committedIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>lastAppliedTerm <span class="token operator">=</span> lastTerm<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 更新LogManager的AppliedId，是一个LogId</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>logManager<span class="token punctuation">.</span><span class="token function">setAppliedId</span><span class="token punctuation">(</span>lastAppliedId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 回调通知</span>
            <span class="token function">notifyLastAppliedIndexUpdated</span><span class="token punctuation">(</span>committedIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>IteratorImpl</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token function">IteratorImpl</span><span class="token punctuation">(</span><span class="token keyword">final</span> StateMachine fsm<span class="token punctuation">,</span> <span class="token keyword">final</span> LogManager logManager<span class="token punctuation">,</span> <span class="token keyword">final</span> List<span class="token operator">&lt;</span>Closure<span class="token operator">></span> closures<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> firstClosureIndex<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> lastAppliedIndex<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> committedIndex<span class="token punctuation">,</span> <span class="token keyword">final</span> AtomicLong applyingIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fsm <span class="token operator">=</span> fsm<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>logManager <span class="token operator">=</span> logManager<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>closures <span class="token operator">=</span> closures<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>firstClosureIndex <span class="token operator">=</span> firstClosureIndex<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>currentIndex <span class="token operator">=</span> lastAppliedIndex<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>committedIndex <span class="token operator">=</span> committedIndex<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>applyingIndex <span class="token operator">=</span> applyingIndex<span class="token punctuation">;</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>IteratorImpl#next</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 先释放当前条目</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>currEntry <span class="token operator">=</span> null<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//release current entry</span>
        <span class="token comment" spellcheck="true">// CurrentIndex初始为上批应用到的索引LastAppliedIndex，CommittedIndex为本批要应用到的日志索引</span>
        <span class="token comment" spellcheck="true">// 如果离目标应用索引还有距离</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currentIndex <span class="token operator">&lt;=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>committedIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token operator">++</span><span class="token keyword">this</span><span class="token punctuation">.</span>currentIndex<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 好吧</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currentIndex <span class="token operator">&lt;=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>committedIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 当前要应用的条目</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>currEntry <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>logManager<span class="token punctuation">.</span><span class="token function">getEntry</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currentIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currEntry <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">final</span> LogEntryCorruptedException e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 当前要应用的条目的索引</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>applyingIndex<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currentIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>FSMCallerImpl#doApplyTasks</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doApplyTasks</span><span class="token punctuation">(</span><span class="token keyword">final</span> IteratorImpl iterImpl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> IteratorWrapper iter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IteratorWrapper</span><span class="token punctuation">(</span>iterImpl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 调用状态机的实现</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>fsm<span class="token punctuation">.</span><span class="token function">onApply</span><span class="token punctuation">(</span>iter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 一般上面状态机应该已经应用完，不应该还有条目剩下</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 如果本批日志还没应用完，后移指针到下一个条目，避免下次应用时条目被重复应用</span>
        <span class="token comment" spellcheck="true">// 上面是原注释的翻译，不过这个Iterator是局部变量，线程返回后就没了，所以这个倒霉玩意估计是给LogManager设置AppliedId的</span>
        iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>以Counter的状态机实现为例</p>
<p>CounterStateMachine#onApply</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onApply</span><span class="token punctuation">(</span><span class="token keyword">final</span> Iterator iter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 遍历日志</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">long</span> delta <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            IncrementAndAddClosure closure <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 说明当前是Leader，因为Closure的回调不会被复制到Follower</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 当前是Leader，可以直接从IncrementAndAddClosure中获取delta，避免反序列化</span>
                closure <span class="token operator">=</span> <span class="token punctuation">(</span>IncrementAndAddClosure<span class="token punctuation">)</span> iter<span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                delta <span class="token operator">=</span> closure<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDelta</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 其它节点</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 需要反序列化</span>
                <span class="token keyword">final</span> ByteBuffer data <span class="token operator">=</span> iter<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> IncrementAndGetRequest request <span class="token operator">=</span> SerializerManager<span class="token punctuation">.</span><span class="token function">getSerializer</span><span class="token punctuation">(</span>SerializerManager<span class="token punctuation">.</span>Hessian2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> IncrementAndGetRequest<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    delta <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getDelta</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">final</span> CodecException e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> prev <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 更新状态机的值</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> updated <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">addAndGet</span><span class="token punctuation">(</span>delta<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 更新后，返回响应</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>closure <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                closure<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span>updated<span class="token punctuation">)</span><span class="token punctuation">;</span>
                closure<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setSuccess</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                closure<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>Status<span class="token punctuation">.</span><span class="token function">OK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 下一个</span>
            iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>Follower添加日志</p>
<p>LogManagerImpl#appendEntries</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">appendEntries</span><span class="token punctuation">(</span><span class="token keyword">final</span> List<span class="token operator">&lt;</span>LogEntry<span class="token operator">></span> entries<span class="token punctuation">,</span> <span class="token keyword">final</span> StableClosure done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// 如果LogManager发生了错误</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>hasError<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 清空LogEntry</span>
            entries<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 提交给回调线程池，执行对应回调</span>
            Utils<span class="token punctuation">.</span><span class="token function">runClosureInThread</span><span class="token punctuation">(</span>done<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Status</span><span class="token punctuation">(</span>RaftError<span class="token punctuation">.</span>EIO<span class="token punctuation">,</span> <span class="token string">"Corrupted LogStorage"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">boolean</span> doUnlock <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// LogEntry列表不为空 &amp;&amp; 检查和解决冲突失败</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>entries<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">checkAndResolveConflict</span><span class="token punctuation">(</span>entries<span class="token punctuation">,</span> done<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 清空LogEntry</span>
                entries<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 提交给回调线程池，执行对应回调</span>
                Utils<span class="token punctuation">.</span><span class="token function">runClosureInThread</span><span class="token punctuation">(</span>done<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Status</span><span class="token punctuation">(</span>RaftError<span class="token punctuation">.</span>EINTERNAL<span class="token punctuation">,</span> <span class="token string">"Fail to checkAndResolveConflict."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 遍历LogEntry</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> entries<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> LogEntry entry <span class="token operator">=</span> entries<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// Set checksum after checkAndResolveConflict</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>raftOptions<span class="token punctuation">.</span><span class="token function">isEnableLogEntryChecksum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    entry<span class="token punctuation">.</span><span class="token function">setChecksum</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">checksum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 如果是配置型的条目</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> EntryType<span class="token punctuation">.</span>ENTRY_TYPE_CONFIGURATION<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token comment" spellcheck="true">// 更新配置</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>entries<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 设置回调，本批日志的第一个日志的Index</span>
                done<span class="token punctuation">.</span><span class="token function">setFirstLogIndex</span><span class="token punctuation">(</span>entries<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 先添加到缓存</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>logsInMemory<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>entries<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 设置回调，日志列表</span>
            done<span class="token punctuation">.</span><span class="token function">setEntries</span><span class="token punctuation">(</span>entries<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> retryTimes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 包装</span>
            <span class="token keyword">final</span> EventTranslator<span class="token operator">&lt;</span>StableClosureEvent<span class="token operator">></span> translator <span class="token operator">=</span> <span class="token punctuation">(</span>event<span class="token punctuation">,</span> sequence<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
                event<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                event<span class="token punctuation">.</span>type <span class="token operator">=</span> EventType<span class="token punctuation">.</span>OTHER<span class="token punctuation">;</span>
                event<span class="token punctuation">.</span>done <span class="token operator">=</span> done<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 重试发布</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 发布到LogManager的RingBuffer成功</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tryOfferEvent</span><span class="token punctuation">(</span>done<span class="token punctuation">,</span> translator<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    retryTimes<span class="token operator">++</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// 超过重试次数</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>retryTimes <span class="token operator">></span> APPEND_LOG_RETRY_TIMES<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 发布到状态机的RingBuffer，调用状态机的onError方法</span>
                        <span class="token function">reportError</span><span class="token punctuation">(</span>RaftError<span class="token punctuation">.</span>EBUSY<span class="token punctuation">.</span><span class="token function">getNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"LogManager is busy, disk queue overload."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// Thread#yield</span>
                    ThreadHelper<span class="token punctuation">.</span><span class="token function">onSpinWait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            doUnlock <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">/*
             * 添加了新日志，这里是异步的，Leader的Log可能没有持久化成功，就开始向Follower发送Log了
             * 对于Leader来说，需要通知Follower，假如Leader在Replicator#sendEntries发送日志时没有新的日志，就会加入一个期待位置，新日志到达时回调，继续发送日志
             * 对于Follower来说，啥也不用干
             */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">wakeupAllWaiter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 监听器发布通知，默认没有监听器，需要自定义</span>
                <span class="token function">notifyLastLogIndexListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>doUnlock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>writeLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>Follower解决日志冲突</p>
<p>LogManagerImpl#checkAndResolveConflict</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"NonAtomicOperationOnVolatileField"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">checkAndResolveConflict</span><span class="token punctuation">(</span><span class="token keyword">final</span> List<span class="token operator">&lt;</span>LogEntry<span class="token operator">></span> entries<span class="token punctuation">,</span> <span class="token keyword">final</span> StableClosure done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 获取LogEntry列表的第一个LogEntry</span>
        <span class="token keyword">final</span> LogEntry firstLogEntry <span class="token operator">=</span> ArrayDeque<span class="token punctuation">.</span><span class="token function">peekFirst</span><span class="token punctuation">(</span>entries<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 节点当前是Leader，并且日志来自用户，不知道Log应该分配的Index</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>firstLogEntry<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> entries<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 分配正确的LogIndex，由Follower本地的最后一个日志Index开始，先加再用</span>
                entries<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIndex</span><span class="token punctuation">(</span><span class="token operator">++</span><span class="token keyword">this</span><span class="token punctuation">.</span>lastLogIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 成功</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 节点当前是Follower，并且日志来自Leader，需要检查和本地的日志冲突</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 要添加的第一个日志的Index和本地最后一条日志的Index相差1以上，说明存在日志空洞，拒绝</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>firstLogEntry<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>lastLogIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 提交到回调线程执行对应回调</span>
                Utils<span class="token punctuation">.</span><span class="token function">runClosureInThread</span><span class="token punctuation">(</span>done<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Status</span><span class="token punctuation">(</span>RaftError<span class="token punctuation">.</span>EINVAL<span class="token punctuation">,</span> <span class="token string">"There's gap between first_index=%d and last_log_index=%d"</span><span class="token punctuation">,</span> firstLogEntry<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lastLogIndex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 应用到状态机的日志索引</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> appliedIndex <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>appliedId<span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 要添加的最后一条日志</span>
            <span class="token keyword">final</span> LogEntry lastLogEntry <span class="token operator">=</span> ArrayDeque<span class="token punctuation">.</span><span class="token function">peekLast</span><span class="token punctuation">(</span>entries<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 要添加的最后一条日志的Index比已应用到状态机的Index还小，拒绝</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>lastLogEntry<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> appliedIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 要添加的第一条日志刚好接上了本地日志</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>firstLogEntry<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lastLogIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// fast path</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>lastLogIndex <span class="token operator">=</span> lastLogEntry<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 存在偏差，需要解决冲突</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> conflictingIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 遍历LogEntry列表</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> conflictingIndex <span class="token operator">&lt;</span> entries<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> conflictingIndex<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 先尝试从缓存中获取，不行再从持久化文件获取</span>
                    <span class="token comment" spellcheck="true">// 如果该Index对应的Log，Follower本地的Term和Leader的Term不一致</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unsafeGetTerm</span><span class="token punctuation">(</span>entries<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>conflictingIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> entries<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>conflictingIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 不用检测后面的了</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 说明Follower本地的Log和Leader的Log有冲突</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>conflictingIndex <span class="token operator">!=</span> entries<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 冲突的日志在列表的起始位置</span>
                    <span class="token comment" spellcheck="true">// 冲突的起始日志的Index比本地最后一条日志小或等于</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>entries<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>conflictingIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lastLogIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 删除本地之后的日志，以Leader的为准，这里是先更新LastLogIndex，再发布到LogManager的RingBuffer，异步删除</span>
                        <span class="token function">unsafeTruncateSuffix</span><span class="token punctuation">(</span>entries<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>conflictingIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>lastLogIndex <span class="token operator">=</span> lastLogEntry<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// else this is a duplicated AppendEntriesRequest, we have nothing to do besides releasing all the entries</span>
                <span class="token comment" spellcheck="true">// 删除没有冲突的重复Log条目，不需要重复添加</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>conflictingIndex <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// Remove duplication</span>
                    entries<span class="token punctuation">.</span><span class="token function">subList</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> conflictingIndex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>Follower从RingBuffer中消费事件，日志持久化刷盘</p>
<p>LogManagerImpl$StableClosureEventHandler#onEvent</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onEvent</span><span class="token punctuation">(</span><span class="token keyword">final</span> StableClosureEvent event<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> sequence<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> endOfBatch<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 如果LogManager要关闭</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>type <span class="token operator">==</span> EventType<span class="token punctuation">.</span>SHUTDOWN<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 先刷盘</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>lastId <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ab<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">setDiskId</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>lastId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                LogManagerImpl<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>shutDownLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">final</span> StableClosure done <span class="token operator">=</span> event<span class="token punctuation">.</span>done<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 回调包含Log条目</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>done<span class="token punctuation">.</span><span class="token function">getEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>done<span class="token punctuation">.</span><span class="token function">getEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 批量写入Log，在刷盘后会执行对应的回调</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>ab<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>done<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>lastId <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ab<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">boolean</span> ret <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token keyword">switch</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">case</span> LAST_LOG_ID<span class="token operator">:</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token keyword">case</span> TRUNCATE_PREFIX<span class="token operator">:</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token keyword">case</span> TRUNCATE_SUFFIX<span class="token operator">:</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token keyword">case</span> RESET<span class="token operator">:</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token keyword">default</span><span class="token operator">:</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">reportError</span><span class="token punctuation">(</span>RaftError<span class="token punctuation">.</span>EIO<span class="token punctuation">.</span><span class="token function">getNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Failed operation in LogStorage"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    done<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>Status<span class="token punctuation">.</span><span class="token function">OK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>endOfBatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>lastId <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ab<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">setDiskId</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>lastId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span></code></pre>
<p>LogManagerImpl$AppendBatcher#append</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">void</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token keyword">final</span> StableClosure done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>size <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cap <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>bufferSize <span class="token operator">>=</span> LogManagerImpl<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>raftOptions<span class="token punctuation">.</span><span class="token function">getMaxAppendBufferSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 先把原来的Log刷盘，执行回调</span>
                <span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 再把本次任务的加入缓存</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>storage<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>done<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>size<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>toAppend<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>done<span class="token punctuation">.</span><span class="token function">getEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> LogEntry entry <span class="token operator">:</span> done<span class="token punctuation">.</span><span class="token function">getEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>bufferSize <span class="token operator">+=</span> entry<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null <span class="token operator">?</span> entry<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span></code></pre>
<p>LogManagerImpl$AppendBatcher#flush</p>
<pre class=" language-java"><code class="language-java">        LogId <span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>size <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 把Log列表持久化</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>lastId <span class="token operator">=</span> <span class="token function">appendToStorage</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>toAppend<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 遍历每批的Log列表</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 清掉</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>storage<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// 有异常就执行异常对应的回调</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>LogManagerImpl<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>hasError<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// 正常情况</span>
                    <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 执行刷盘回调</span>
                        <span class="token comment" spellcheck="true">// 对于Follower，是FollowerStableClosure，提交Leader同步过来的CommittedIndex，并响应Leader</span>
                        <span class="token comment" spellcheck="true">// 对于Leader，是LeaderStableClosure，尝试提交CommitIndex，其实执行的方法和收到Follower响应时是一样的，只有收到大多数节点响应时才会真正提交</span>
                        <span class="token comment" spellcheck="true">// 至于为什么Leader这里持久化日志后也会尝试提交，因为Leader也是节点，即自己响应自己，和投票是同一个道理</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>storage<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>Status<span class="token punctuation">.</span><span class="token function">OK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 重置</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>toAppend<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>storage<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 重置</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>bufferSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lastId<span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>Follower日志持久化后执行回调，更新日志提交位置</p>
<p>NodeImpl$FollowerStableClosure</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">public</span> <span class="token function">FollowerStableClosure</span><span class="token punctuation">(</span><span class="token keyword">final</span> AppendEntriesRequest request<span class="token punctuation">,</span> <span class="token keyword">final</span> AppendEntriesResponse<span class="token punctuation">.</span>Builder responseBuilder<span class="token punctuation">,</span> <span class="token keyword">final</span> NodeImpl node<span class="token punctuation">,</span> <span class="token keyword">final</span> RpcRequestClosure done<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> term<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">super</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>committedIndex <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>
                    <span class="token comment" spellcheck="true">// committed index is likely less than the lastLogIndex</span>
                    request<span class="token punctuation">.</span><span class="token function">getCommittedIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token comment" spellcheck="true">// The logs after the appended entries can not be trust, so we can't commit them even if their indexes are less than request's committed index.</span>
                    request<span class="token punctuation">.</span><span class="token function">getPrevLogIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> request<span class="token punctuation">.</span><span class="token function">getEntriesCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>responseBuilder <span class="token operator">=</span> responseBuilder<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>node <span class="token operator">=</span> node<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>done <span class="token operator">=</span> done<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>term <span class="token operator">=</span> term<span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>NodeImpl$FollowerStableClosure#run</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">final</span> Status status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>status<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>node<span class="token punctuation">.</span>readLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 接收日志时的任期和当前的任期不一致，说明持久化过程中任期发生了变化</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>term <span class="token operator">!=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>node<span class="token punctuation">.</span>currTerm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 不能响应旧的Leader成功，因为不确定这些日志是否会被新Leader的日志覆盖</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>responseBuilder<span class="token punctuation">.</span><span class="token function">setSuccess</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setTerm</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>node<span class="token punctuation">.</span>currTerm<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">sendResponse</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>responseBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>node<span class="token punctuation">.</span>readLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>responseBuilder<span class="token punctuation">.</span><span class="token function">setSuccess</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setTerm</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>term<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 更新日志提交位置</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>node<span class="token punctuation">.</span>ballotBox<span class="token punctuation">.</span><span class="token function">setLastCommittedIndex</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>committedIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">sendResponse</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>responseBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<hr>
<p>Leader收到响应，两种情况</p>
<p>处理心跳响应</p>
<p>Replicator#onHeartbeatReturned</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">onHeartbeatReturned</span><span class="token punctuation">(</span><span class="token keyword">final</span> ThreadId id<span class="token punctuation">,</span> <span class="token keyword">final</span> Status status<span class="token punctuation">,</span> <span class="token keyword">final</span> AppendEntriesRequest request<span class="token punctuation">,</span> <span class="token keyword">final</span> AppendEntriesResponse response<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> rpcSendTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// replicator already was destroyed.</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> startTimeMs <span class="token operator">=</span> Utils<span class="token punctuation">.</span><span class="token function">nowMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Replicator r<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>r <span class="token operator">=</span> <span class="token punctuation">(</span>Replicator<span class="token punctuation">)</span> id<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">boolean</span> doUnlock <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// 心跳发送不成功</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>status<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
                r<span class="token punctuation">.</span>state <span class="token operator">=</span> State<span class="token punctuation">.</span>Probe<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 回调通知</span>
                <span class="token function">notifyReplicatorStatusListener</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> ReplicatorEvent<span class="token punctuation">.</span>ERROR<span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ...</span>
                <span class="token comment" spellcheck="true">// 下一次心跳超时</span>
                r<span class="token punctuation">.</span><span class="token function">startHeartbeatTimer</span><span class="token punctuation">(</span>startTimeMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 心跳发送成功</span>
            r<span class="token punctuation">.</span>consecutiveErrorTimes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 如果对方的任期比当前Leader，即比自己的任期还大，说明可能发生了网络分区</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> r<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
                <span class="token keyword">final</span> NodeImpl node <span class="token operator">=</span> r<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 通知回调，Follower已追上</span>
                r<span class="token punctuation">.</span><span class="token function">notifyOnCaughtUp</span><span class="token punctuation">(</span>RaftError<span class="token punctuation">.</span>EPERM<span class="token punctuation">.</span><span class="token function">getNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 销毁当前Replicator</span>
                r<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// Leader退位为Follower，并更新任期，重新启动选举计时</span>
                node<span class="token punctuation">.</span><span class="token function">increaseTermTo</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Status</span><span class="token punctuation">(</span>RaftError<span class="token punctuation">.</span>EHIGHERTERMRESPONSE<span class="token punctuation">,</span> <span class="token string">"Leader receives higher term heartbeat_response from peer:%s"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getPeerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 对端响应异常 &amp;&amp; 对端返回的响应包含LastLogIndex</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>response<span class="token punctuation">.</span><span class="token function">getSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> response<span class="token punctuation">.</span><span class="token function">hasLastLogIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
                doUnlock <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 再次发送一次Probe请求，探查对端Log的位置</span>
                r<span class="token punctuation">.</span><span class="token function">sendEmptyEntries</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 下一次心跳超时</span>
                r<span class="token punctuation">.</span><span class="token function">startHeartbeatTimer</span><span class="token punctuation">(</span>startTimeMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// 一切正常</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>rpcSendTime <span class="token operator">></span> r<span class="token punctuation">.</span>lastRpcSendTimestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 更新通讯时间戳</span>
                r<span class="token punctuation">.</span>lastRpcSendTimestamp <span class="token operator">=</span> rpcSendTime<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 下一次心跳超时</span>
            r<span class="token punctuation">.</span><span class="token function">startHeartbeatTimer</span><span class="token punctuation">(</span>startTimeMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>doUnlock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                id<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>处理Probe和追加日志请求的响应</p>
<p>Replicator#onRpcReturned</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">onRpcReturned</span><span class="token punctuation">(</span><span class="token keyword">final</span> ThreadId id<span class="token punctuation">,</span> <span class="token keyword">final</span> RequestType reqType<span class="token punctuation">,</span> <span class="token keyword">final</span> Status status<span class="token punctuation">,</span> <span class="token keyword">final</span> Message request<span class="token punctuation">,</span> <span class="token keyword">final</span> Message response<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> seq<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> stateVersion<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> rpcSendTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> startTimeMs <span class="token operator">=</span> Utils<span class="token punctuation">.</span><span class="token function">nowMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Replicator r<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>r <span class="token operator">=</span> <span class="token punctuation">(</span>Replicator<span class="token punctuation">)</span> id<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>stateVersion <span class="token operator">!=</span> r<span class="token punctuation">.</span>version<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
            id<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// AppendEntries响应的优先队列，根据发送时的序号排列</span>
        <span class="token keyword">final</span> PriorityQueue<span class="token operator">&lt;</span>RpcResponse<span class="token operator">></span> holdingQueue <span class="token operator">=</span> r<span class="token punctuation">.</span>pendingResponses<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 先将响应结果添加到优先队列</span>
        holdingQueue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RpcResponse</span><span class="token punctuation">(</span>reqType<span class="token punctuation">,</span> seq<span class="token punctuation">,</span> status<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> rpcSendTime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 响应队列堆积超过256</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>holdingQueue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> r<span class="token punctuation">.</span>raftOptions<span class="token punctuation">.</span><span class="token function">getMaxReplicatorInflightMsgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// 重置旧的响应数据</span>
            r<span class="token punctuation">.</span><span class="token function">resetInflights</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>state <span class="token operator">=</span> State<span class="token punctuation">.</span>Probe<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 重新发送Probe请求</span>
            r<span class="token punctuation">.</span><span class="token function">sendEmptyEntries</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">boolean</span> continueSendEntries <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> processed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 处理队列中堆积的响应结果</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>holdingQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 获取队列头的响应结果，这里是从小到大排列，对应最早的请求的响应</span>
                <span class="token keyword">final</span> RpcResponse queuedPipelinedResponse <span class="token operator">=</span> holdingQueue<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 初始都为0，相等</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>queuedPipelinedResponse<span class="token punctuation">.</span>seq <span class="token operator">!=</span> r<span class="token punctuation">.</span>requiredNextSeq<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 处理中出现了异常，跳过后面的</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>processed <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// 还没有处理的话，不再处理</span>
                    <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        continueSendEntries <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                        id<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 先移除响应结果</span>
                holdingQueue<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                processed<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 发送请求后会添加一个Inflight入队列尾，处理时从队列头取出，FIFO</span>
                <span class="token keyword">final</span> Inflight inflight <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">pollInflight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>inflight <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 请求的序列号和取出的响应的序列号不一致</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>inflight<span class="token punctuation">.</span>seq <span class="token operator">!=</span> queuedPipelinedResponse<span class="token punctuation">.</span>seq<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token comment" spellcheck="true">// 重置请求的Inflight队列和请求的响应队列</span>
                    r<span class="token punctuation">.</span><span class="token function">resetInflights</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    r<span class="token punctuation">.</span>state <span class="token operator">=</span> State<span class="token punctuation">.</span>Probe<span class="token punctuation">;</span>
                    continueSendEntries <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    r<span class="token punctuation">.</span><span class="token function">block</span><span class="token punctuation">(</span>Utils<span class="token punctuation">.</span><span class="token function">nowMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> RaftError<span class="token punctuation">.</span>EREQUEST<span class="token punctuation">.</span><span class="token function">getNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">switch</span> <span class="token punctuation">(</span>queuedPipelinedResponse<span class="token punctuation">.</span>requestType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">case</span> AppendEntries<span class="token operator">:</span>
                            <span class="token comment" spellcheck="true">// 处理响应</span>
                            continueSendEntries <span class="token operator">=</span> <span class="token function">onAppendEntriesReturned</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> inflight<span class="token punctuation">,</span> queuedPipelinedResponse<span class="token punctuation">.</span>status<span class="token punctuation">,</span> <span class="token punctuation">(</span>AppendEntriesRequest<span class="token punctuation">)</span> queuedPipelinedResponse<span class="token punctuation">.</span>request<span class="token punctuation">,</span> <span class="token punctuation">(</span>AppendEntriesResponse<span class="token punctuation">)</span> queuedPipelinedResponse<span class="token punctuation">.</span>response<span class="token punctuation">,</span> rpcSendTime<span class="token punctuation">,</span> startTimeMs<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token keyword">case</span> Snapshot<span class="token operator">:</span>
                            <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>continueSendEntries<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 成功，增加requiredNextSeq</span>
                        r<span class="token punctuation">.</span><span class="token function">getAndIncrementRequiredNextSeq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// 响应队列处理结束</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// 继续发送日志</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>continueSendEntries<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                r<span class="token punctuation">.</span><span class="token function">sendEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>Leader处理响应</p>
<p>Replicator#onAppendEntriesReturned</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">onAppendEntriesReturned</span><span class="token punctuation">(</span><span class="token keyword">final</span> ThreadId id<span class="token punctuation">,</span> <span class="token keyword">final</span> Inflight inflight<span class="token punctuation">,</span> <span class="token keyword">final</span> Status status<span class="token punctuation">,</span> <span class="token keyword">final</span> AppendEntriesRequest request<span class="token punctuation">,</span> <span class="token keyword">final</span> AppendEntriesResponse response<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> rpcSendTime<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> startTimeMs<span class="token punctuation">,</span> <span class="token keyword">final</span> Replicator r<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 一般不会发生</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>inflight<span class="token punctuation">.</span>startIndex <span class="token operator">!=</span> request<span class="token punctuation">.</span><span class="token function">getPrevLogIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span><span class="token function">resetInflights</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>state <span class="token operator">=</span> State<span class="token punctuation">.</span>Probe<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// unlock id in sendEmptyEntries</span>
            r<span class="token punctuation">.</span><span class="token function">sendEmptyEntries</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 一些统计</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getEntriesCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Follower宕机，RPC失败的情况</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>status<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">notifyReplicatorStatusListener</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> ReplicatorEvent<span class="token punctuation">.</span>ERROR<span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//重置请求的Inflight队列和请求的响应队列</span>
            r<span class="token punctuation">.</span><span class="token function">resetInflights</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>state <span class="token operator">=</span> State<span class="token punctuation">.</span>Probe<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// unlock in in block</span>
            r<span class="token punctuation">.</span><span class="token function">block</span><span class="token punctuation">(</span>startTimeMs<span class="token punctuation">,</span> status<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        r<span class="token punctuation">.</span>consecutiveErrorTimes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Follower拒绝的情况</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>response<span class="token punctuation">.</span><span class="token function">getSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 如果Follower的任期大于Leader自己的任期</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> r<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> NodeImpl node <span class="token operator">=</span> r<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 通知回调，Follower已追上</span>
                r<span class="token punctuation">.</span><span class="token function">notifyOnCaughtUp</span><span class="token punctuation">(</span>RaftError<span class="token punctuation">.</span>EPERM<span class="token punctuation">.</span><span class="token function">getNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 销毁该Replicator</span>
                r<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// Leader退位为Follower，并更新任期，重新启动选举计时</span>
                node<span class="token punctuation">.</span><span class="token function">increaseTermTo</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Status</span><span class="token punctuation">(</span>RaftError<span class="token punctuation">.</span>EHIGHERTERMRESPONSE<span class="token punctuation">,</span> <span class="token string">"Leader receives higher term heartbeat_response from peer:%s"</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getPeerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 返回</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">// Follower的任期没有大于Leader自己的任期，更新通讯时间戳</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>rpcSendTime <span class="token operator">></span> r<span class="token punctuation">.</span>lastRpcSendTimestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                r<span class="token punctuation">.</span>lastRpcSendTimestamp <span class="token operator">=</span> rpcSendTime<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 重置请求的Inflight队列和请求的响应队列</span>
            r<span class="token punctuation">.</span><span class="token function">resetInflights</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 理想情况下，对端Follower最后的日志Index加一应该就是下一个要发送的日志的Index，如果小了，说明Follower日志进度落后</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getLastLogIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> r<span class="token punctuation">.</span>nextIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 更新下次发送Log的位置</span>
                r<span class="token punctuation">.</span>nextIndex <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getLastLogIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// Follower日志位置比Leader下个发送的日志位置大或一样，说明可能需要Follower删除日志</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>nextIndex <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 位置减减，Follower收到后检查一致性，一直向前</span>
                    r<span class="token punctuation">.</span>nextIndex<span class="token operator">--</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 继续发送Probe请求</span>
            r<span class="token punctuation">.</span><span class="token function">sendEmptyEntries</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Log同步成功，Follower在同步前会同步Leader的任期，如果不一致，说明Leader的任期在发出请求后上升了，不再处理</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> r<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getTerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span><span class="token function">resetInflights</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            r<span class="token punctuation">.</span>state <span class="token operator">=</span> State<span class="token punctuation">.</span>Probe<span class="token punctuation">;</span>
            id<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 正常情况，更新通讯时间戳</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rpcSendTime <span class="token operator">></span> r<span class="token punctuation">.</span>lastRpcSendTimestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span>lastRpcSendTimestamp <span class="token operator">=</span> rpcSendTime<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> entriesSize <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getEntriesCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 是个复制日志请求</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>entriesSize <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 大多数Follower响应同步成功后Leader才能提交日志</span>
            r<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getBallotBox</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">commitAt</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>nextIndex<span class="token punctuation">,</span> r<span class="token punctuation">.</span>nextIndex <span class="token operator">+</span> entriesSize <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getPeerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 是个Probe请求</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Probe完后切换到复制状态</span>
            r<span class="token punctuation">.</span>state <span class="token operator">=</span> State<span class="token punctuation">.</span>Replicate<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 下次Log复制的索引</span>
        r<span class="token punctuation">.</span>nextIndex <span class="token operator">+=</span> entriesSize<span class="token punctuation">;</span>
        r<span class="token punctuation">.</span>hasSucceeded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        r<span class="token punctuation">.</span><span class="token function">notifyOnCaughtUp</span><span class="token punctuation">(</span>RaftError<span class="token punctuation">.</span>SUCCESS<span class="token punctuation">.</span><span class="token function">getNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// dummy_id is unlock in _send_entries</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span>timeoutNowIndex <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> r<span class="token punctuation">.</span>timeoutNowIndex <span class="token operator">&lt;</span> r<span class="token punctuation">.</span>nextIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            r<span class="token punctuation">.</span><span class="token function">sendTimeoutNow</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>Leader发送日志</p>
<p>Replicator#sendEntries</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">void</span> <span class="token function">sendEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> doUnlock <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">long</span> prevSendIndex <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 尽可能多地发送Log</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token keyword">long</span> nextSendingIndex <span class="token operator">=</span> <span class="token function">getNextSendIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>nextSendingIndex <span class="token operator">></span> prevSendIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 发送</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sendEntries</span><span class="token punctuation">(</span>nextSendingIndex<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        prevSendIndex <span class="token operator">=</span> nextSendingIndex<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        doUnlock <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>doUnlock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>Replicator#getNextSendIndex</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">long</span> <span class="token function">getNextSendIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 发送一个AppendEntriesRequest添加一个Inflight，代表Pipeline发送，处理响应后移除</span>
        <span class="token comment" spellcheck="true">// 说明没有堆积，nextIndex在收到响应时才会更新</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>inflights<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>nextIndex<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 堆积太多，不再发送</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>inflights<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>raftOptions<span class="token punctuation">.</span><span class="token function">getMaxReplicatorInflightMsgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token operator">-</span>1L<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Pipeline情况下，发送下一个请求时不一定已经收到上一个请求的响应</span>
        <span class="token comment" spellcheck="true">// 如果上一个发送的是添加日志请求，不是Probe请求</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>rpcInFly <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rpcInFly<span class="token punctuation">.</span><span class="token function">isSendingLogEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 接着发送</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rpcInFly<span class="token punctuation">.</span>startIndex <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rpcInFly<span class="token punctuation">.</span>count<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>1L<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>Replicator#sendEntries</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">sendEntries</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">long</span> nextSendingIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> AppendEntriesRequest<span class="token punctuation">.</span>Builder rb <span class="token operator">=</span> AppendEntriesRequest<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 先尝试填充常用的字段：Term，GroupId，ServerId，PeerId，PrevLogIndex，PrevLogTerm，CommittedIndex</span>
        <span class="token comment" spellcheck="true">// NextSendingIndex是本次Log复制的起始Index，PrevLogIndex就是上次复制的Index</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">fillCommonFields</span><span class="token punctuation">(</span>rb<span class="token punctuation">,</span> nextSendingIndex <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        ByteBufferCollector dataBuf <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Log条目数量</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> maxEntriesSize <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>raftOptions<span class="token punctuation">.</span><span class="token function">getMaxEntriesSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> RecyclableByteBufferList byteBufList <span class="token operator">=</span> RecyclableByteBufferList<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 循环获取日志</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> maxEntriesSize<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> RaftOutter<span class="token punctuation">.</span>EntryMeta<span class="token punctuation">.</span>Builder emb <span class="token operator">=</span> RaftOutter<span class="token punctuation">.</span>EntryMeta<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 准备该条Log</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">prepareEntry</span><span class="token punctuation">(</span>nextSendingIndex<span class="token punctuation">,</span> i<span class="token punctuation">,</span> emb<span class="token punctuation">,</span> byteBufList<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 添加</span>
                rb<span class="token punctuation">.</span><span class="token function">addEntries</span><span class="token punctuation">(</span>emb<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 暂时没获取到新的Log</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>rb<span class="token punctuation">.</span><span class="token function">getEntriesCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>nextSendingIndex <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getLogManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFirstLogIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">installSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 添加下次期待的日志位置到缓存，Leader添加新日志后回调</span>
                <span class="token function">waitMoreEntries</span><span class="token punctuation">(</span>nextSendingIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>byteBufList<span class="token punctuation">.</span><span class="token function">getCapacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                dataBuf <span class="token operator">=</span> ByteBufferCollector<span class="token punctuation">.</span><span class="token function">allocateByRecyclers</span><span class="token punctuation">(</span>byteBufList<span class="token punctuation">.</span><span class="token function">getCapacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> ByteBuffer b <span class="token operator">:</span> byteBufList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    dataBuf<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">final</span> ByteBuffer buf <span class="token operator">=</span> dataBuf<span class="token punctuation">.</span><span class="token function">getBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                buf<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 添加日志的缓冲数据</span>
                rb<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>ZeroByteStringHelper<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            RecycleUtil<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span>byteBufList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 创建请求</span>
        <span class="token keyword">final</span> AppendEntriesRequest request <span class="token operator">=</span> rb<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>statInfo<span class="token punctuation">.</span>runningState <span class="token operator">=</span> RunningState<span class="token punctuation">.</span>APPENDING_ENTRIES<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>statInfo<span class="token punctuation">.</span>firstLogIndex <span class="token operator">=</span> rb<span class="token punctuation">.</span><span class="token function">getPrevLogIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>statInfo<span class="token punctuation">.</span>lastLogIndex <span class="token operator">=</span> rb<span class="token punctuation">.</span><span class="token function">getPrevLogIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> rb<span class="token punctuation">.</span><span class="token function">getEntriesCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> Recyclable recyclable <span class="token operator">=</span> dataBuf<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> v <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>version<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> monotonicSendTimeMs <span class="token operator">=</span> Utils<span class="token punctuation">.</span><span class="token function">monotonicMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 序列号</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> seq <span class="token operator">=</span> <span class="token function">getAndIncrementReqSeq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// RPC发送</span>
        <span class="token keyword">final</span> Future<span class="token operator">&lt;</span>Message<span class="token operator">></span> rpcFuture <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rpcService<span class="token punctuation">.</span><span class="token function">appendEntries</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span><span class="token function">getPeerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">RpcResponseClosureAdapter</span><span class="token operator">&lt;</span>AppendEntriesResponse<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">final</span> Status status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                RecycleUtil<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span>recyclable<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 响应回调</span>
                <span class="token function">onRpcReturned</span><span class="token punctuation">(</span>Replicator<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token punctuation">,</span> RequestType<span class="token punctuation">.</span>AppendEntries<span class="token punctuation">,</span> status<span class="token punctuation">,</span> request<span class="token punctuation">,</span> <span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> seq<span class="token punctuation">,</span> v<span class="token punctuation">,</span> monotonicSendTimeMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//</span>
        <span class="token function">addInflight</span><span class="token punctuation">(</span>RequestType<span class="token punctuation">.</span>AppendEntries<span class="token punctuation">,</span> nextSendingIndex<span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getEntriesCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> seq<span class="token punctuation">,</span> rpcFuture<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>附带Counter的读例子</p>
<p>GetValueRequestProcessor#handleRequest</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> Object <span class="token function">handleRequest</span><span class="token punctuation">(</span><span class="token keyword">final</span> BizContext bizCtx<span class="token punctuation">,</span> <span class="token keyword">final</span> GetValueRequest request<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 如果当前Server不是Leader</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>counterServer<span class="token punctuation">.</span><span class="token function">getFsm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 重定向到Leader，包含了Leader的PeerId</span>
            <span class="token comment" spellcheck="true">// 其实Follower也能处理读请求，一致性读的情况下不会发生脏读</span>
            <span class="token comment" spellcheck="true">// 但是节点间的复制是异步的，在日志落后太多的情况下，响应时间会比较长，所以都交给Leader</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>counterServer<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 当前Server是Leader，处理读请求</span>
        <span class="token keyword">final</span> ValueResponse response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ValueResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setSuccess</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Leader直接从状态机获取值，这里应该没有一致性读的处理？</span>
        response<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>counterServer<span class="token punctuation">.</span><span class="token function">getFsm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> response<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>JRaft整个链路几乎都是Batch的，依靠Disruptor的MPSC模型批量消费：</p>
<ul>
<li><p>批量提交Task；</p>
</li>
<li><p>批量网络发送，Pipeline复制Log；</p>
</li>
<li><p>本地IO批量写入；</p>
</li>
<li><p>批量应用到状态机；</p>
</li>
<li><p>Leader持久化Log和向Follower发送Log是并行的，向所有Follower发送Log也是并行的；</p>
</li>
<li><p>整个链路基于回调，完全不阻塞；</p>
</li>
</ul>
<p>官方文档说，JRaft虽然是Batch，但不会累积请求，看代码，猜测应该是Disruptor的处理？不然那就是累积了。</p>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


        <footer>
             
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

        </footer>
    </div>
    <!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
    <script>
        var timeEnd = new Date();
        console.log('耗时：' + (timeEnd - timeStart));
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre').forEach((block) => {
                block.classList.add("line-numbers");
            });
        });
    </script>

    <script src="/js/prism.js"></script>
</body>
</html>
