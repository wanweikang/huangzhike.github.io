<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
        <script>
            var timeStart = new Date();
        </script>
        
        <title>[ç¬”è®°]-SOFA-JRaft-DistributedLock | ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜</title>
        
        <meta name="author" content="huangzhike">
        
        
        <meta name="description" content="å‚è€ƒSOFAStackçš„ä¸€ç¯‡æ–‡ç« ã€‚

åˆ†å¸ƒå¼é”çš„æ¡ä»¶ï¼š

è·å–é”å’Œé‡Šæ”¾é”çš„æ€§èƒ½è¦å¥½ï¼›

è·å¾—é”æ˜¯å¦æ˜¯åŸå­æ€§çš„ï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´å¤šä¸ªè¯·æ±‚éƒ½èƒ½è·å–åˆ°é”ï¼›

ç½‘ç»œä¸­æ–­æˆ–è€…å®•æœºæ— æ³•é‡Šæ”¾é”æ—¶ï¼Œé”å¿…é¡»è¢«æ¸…é™¤ï¼›

å¯é‡å…¥ï¼Œæœ¬åœ°ä¸€ä¸ªçº¿ç¨‹ä¸­å¤šæ¬¡è·å–åŒä¸€æŠŠé”ï¼Œæ— éœ€é‡æ–°è·å¾—é”ï¼›

é˜»å¡é”å’Œéé˜»å¡é”ï¼Œé˜»å¡é”å³æ²¡æœ‰è·å–åˆ°é”ï¼Œåˆ™ç»§">
        
        
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        
        <meta property="og:title" content="[ç¬”è®°]-SOFA-JRaft-DistributedLock"/>
        
        <meta property="og:site_name" content="ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜"/>
        
        
        <!-- favicon -->
        <link rel="icon" type="image/ico" href="/ok.ico" sizes="32x32">
        <meta name="msapplication-TileColor" content="#009688">
        <meta name="msapplication-TileImage" content="/mstile-144x144.ico">
        <meta name="theme-color" content="#009688">
        <!-- favicon end -->
        <!-- <link href="//ok.ico" rel="icon"> -->
        
        <!-- toc -->
        <!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
        <!-- material design -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
        <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
        
        <!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
        <!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
    <meta name="generator" content="Hexo 4.2.1"></head>

<body>
    <nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">èœå•</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" title="ä¸‹ä¸€å¥æ˜¯ï¼šå®¢æœ‰å¯äººæœŸä¸æ¥ã€‚å°æ—¶å€™ï¼Œå–œæ¬¢é åœ¨é˜³å°ä¸Šï¼Œä¸€è¾¹å¹é£ï¼Œä¸€è¾¹çœ‹ä¹¦ï¼Œå–œæ¬¢è¯»ä¹¦å—ï¼Œéªšå¹´ï¼Ÿ" href="/">ä¹¦å½“å¿«æ„è¯»æ˜“å°½</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" target="_blank" rel="noopener" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

    <div class="container" >
        <div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[ç¬”è®°]-SOFA-JRaft-DistributedLock</h2>
				
				<div>
					<div class="post-time">2019-11-19</div>
				</div>
				
				<div class="article-content">
				<p><a href="https://www.sofastack.tech/blog/sofa-jraft-rheakv-distributedlock/" target="_blank" rel="noopener">å‚è€ƒSOFAStackçš„ä¸€ç¯‡æ–‡ç« </a>ã€‚</p>
<hr>
<p>åˆ†å¸ƒå¼é”çš„æ¡ä»¶ï¼š</p>
<ul>
<li><p>è·å–é”å’Œé‡Šæ”¾é”çš„æ€§èƒ½è¦å¥½ï¼›</p>
</li>
<li><p>è·å¾—é”æ˜¯å¦æ˜¯åŸå­æ€§çš„ï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´å¤šä¸ªè¯·æ±‚éƒ½èƒ½è·å–åˆ°é”ï¼›</p>
</li>
<li><p>ç½‘ç»œä¸­æ–­æˆ–è€…å®•æœºæ— æ³•é‡Šæ”¾é”æ—¶ï¼Œé”å¿…é¡»è¢«æ¸…é™¤ï¼›</p>
</li>
<li><p>å¯é‡å…¥ï¼Œæœ¬åœ°ä¸€ä¸ªçº¿ç¨‹ä¸­å¤šæ¬¡è·å–åŒä¸€æŠŠé”ï¼Œæ— éœ€é‡æ–°è·å¾—é”ï¼›</p>
</li>
<li><p>é˜»å¡é”å’Œéé˜»å¡é”ï¼Œé˜»å¡é”å³æ²¡æœ‰è·å–åˆ°é”ï¼Œåˆ™ç»§ç»­ç­‰å¾…è·å–é”ï¼›éé˜»å¡é”å³æ²¡æœ‰è·å–åˆ°é”ï¼Œä¸ç»§ç»­ç­‰å¾…ç›´æ¥è¿”å›è·å–é”å¤±è´¥ï¼›</p>
</li>
</ul>
<p>åˆ†å¸ƒå¼é”çš„ä¸‰ç§å®ç°æ–¹å¼ï¼š</p>
<ul>
<li><p>åŸºäºæ•°æ®åº“å®ç°ï¼š</p>
<ul>
<li>åœ¨æ•°æ®åº“ä¸­åˆ›å»ºä¸€å¼ è¡¨ï¼ŒåŒ…å«æ–¹æ³•åç­‰å­—æ®µï¼Œå¹¶ä¸ºæ–¹æ³•åå­—æ®µåˆ›å»ºå”¯ä¸€ç´¢å¼•ï¼Œæ‰§è¡ŒæŸä¸ªæ–¹æ³•éœ€è¦ä½¿ç”¨æ–¹æ³•åå‘è¡¨ä¸­æ’å…¥æ•°æ®ï¼ŒæˆåŠŸæ’å…¥åˆ™è·å–é”ï¼Œæ‰§è¡Œç»“æŸåˆ™åˆ é™¤å¯¹åº”çš„è¡Œæ•°æ®é‡Šæ”¾é”ã€‚</li>
</ul>
</li>
<li><p>åŸºäºç¼“å­˜å®ç°ï¼š</p>
<ul>
<li><p>ä»¥Redisä¸ºä¾‹ï¼Œå› ä¸ºå•RedisèŠ‚ç‚¹çš„åˆ†å¸ƒå¼é”åœ¨Failoveræ—¶æœ‰å®‰å…¨é—®é¢˜ï¼ŒRedisä½œè€…æå‡ºäº†é›†ç¾¤æ¨¡å¼çš„Redisåˆ†å¸ƒå¼é”Redlockç®—æ³•ï¼ŒåŸºäºNä¸ªå®Œå…¨ç‹¬ç«‹çš„RedisèŠ‚ç‚¹ï¼ˆé€šå¸¸Nå¯ä»¥è®¾ç½®æˆ5ï¼‰ï¼›</p>
</li>
<li><p>å®¢æˆ·ç«¯å‘èµ·è·å–é”æ“ä½œå‰ï¼Œå…ˆè·å–å½“å‰æ—¶é—´ï¼›</p>
</li>
<li><p>å®¢æˆ·ç«¯æŒ‰é¡ºåºä¾æ¬¡å‘Nä¸ªRedisèŠ‚ç‚¹è·å–é”ï¼›</p>
<ul>
<li><p>è·å–æ“ä½œçš„å‚æ•°åŒ…å«ï¼šéšæœºå­—ç¬¦ä¸²ï¼Œè¿‡æœŸæ—¶é—´ï¼ˆé”çš„æœ‰æ•ˆæ—¶é—´ï¼‰ï¼Œè·å–é”è¶…æ—¶ï¼ˆè¿œå°äºé”çš„æœ‰æ•ˆæ—¶é—´ï¼Œä½¿å¾—RedisèŠ‚ç‚¹ä¸å¯ç”¨æ—¶æµç¨‹ç»§ç»­è¿›è¡Œï¼‰ï¼›</p>
</li>
<li><p>å®¢æˆ·ç«¯å‘æŸä¸ªRedisèŠ‚ç‚¹è·å–é”å¤±è´¥åï¼ˆåŒ…æ‹¬èŠ‚ç‚¹ä¸å¯ç”¨ï¼Œé”å·²è¢«æŒæœ‰ç­‰ï¼‰ï¼Œç«‹å³å°è¯•ä¸‹ä¸€ä¸ªRedisèŠ‚ç‚¹ï¼›</p>
</li>
</ul>
</li>
<li><p>å®¢æˆ·ç«¯è®¡ç®—æ•´ä¸ªè·å–é”çš„è¿‡ç¨‹æ€»è€—æ—¶ï¼Œå¦‚æœå®¢æˆ·ç«¯ä»å¤§å¤šæ•°RedisèŠ‚ç‚¹æˆåŠŸè·å–åˆ°äº†é”ï¼Œå¹¶ä¸”è·å–é”çš„æ€»è€—æ—¶æ²¡æœ‰è¶…è¿‡é”çš„æœ‰æ•ˆæ—¶é—´ï¼Œé‚£ä¹ˆè®¤ä¸ºæœ€ç»ˆè·å–é”æˆåŠŸï¼›å¦åˆ™è®¤ä¸ºå¤±è´¥ï¼›</p>
<ul>
<li><p>å¦‚æœæœ€ç»ˆè·å–é”æˆåŠŸï¼Œæ­¤é”çš„æœ‰æ•ˆæ—¶é—´åº”è¯¥é‡æ–°è®¡ç®—ï¼Œå®ƒç­‰äºæœ€åˆé”çš„æœ‰æ•ˆæ—¶é—´å‡å»è·å–é”è¿‡ç¨‹çš„æ€»è€—æ—¶ï¼›</p>
</li>
<li><p>å¦‚æœæœ€ç»ˆè·å–é”å¤±è´¥ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯ç«‹å³å‘æ‰€æœ‰RedisèŠ‚ç‚¹å‘èµ·é‡Šæ”¾é”çš„æ“ä½œï¼›</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>åŸºäºZooKeeperå®ç°ï¼š</p>
<ul>
<li><p>åˆ›å»ºä¸€ä¸ªé”ç›®å½•Lockï¼›</p>
</li>
<li><p>æœŸæœ›è·å¾—é”çš„çº¿ç¨‹Aåœ¨é”ç›®å½•ä¸‹åˆ›å»ºä¸´æ—¶é¡ºåºèŠ‚ç‚¹ï¼›</p>
</li>
<li><p>å½“å‰çº¿ç¨‹è·å–é”ç›®å½•ä¸‹æ‰€æœ‰çš„å­èŠ‚ç‚¹ï¼Œç„¶åè·å–æ¯”è‡ªå·±å°çš„å…„å¼ŸèŠ‚ç‚¹ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œè¯´æ˜å½“å‰çº¿ç¨‹é¡ºåºå·æœ€å°ï¼Œè·å¾—é”ï¼›</p>
</li>
<li><p>çº¿ç¨‹Bè·å–æ‰€æœ‰èŠ‚ç‚¹ï¼Œåˆ¤æ–­è‡ªå·±ä¸æ˜¯æœ€å°èŠ‚ç‚¹ï¼Œè®¾ç½®ç›‘å¬æ¯”è‡ªå·±æ¬¡å°çš„èŠ‚ç‚¹ï¼ˆåªå…³æ³¨æ¯”è‡ªå·±æ¬¡å°çš„èŠ‚ç‚¹æ˜¯ä¸ºäº†é˜²æ­¢å‘ç”Ÿç¾Šç¾¤æ•ˆåº”ï¼‰ï¼›</p>
</li>
<li><p>çº¿ç¨‹Aå¤„ç†å®Œåï¼Œåˆ é™¤è‡ªå·±çš„èŠ‚ç‚¹ï¼Œçº¿ç¨‹Bç›‘å¬åˆ°å˜æ›´äº‹ä»¶åˆ¤æ–­è‡ªå·±æ˜¯å¦ä¸ºæœ€å°çš„èŠ‚ç‚¹ï¼Œå¦‚æœæ˜¯åˆ™è·å¾—é”ï¼›</p>
</li>
</ul>
</li>
</ul>
<p>Redisçš„å®ç°æœ‰ç‚¹ç±»ä¼¼Raftç®—æ³•ï¼Œè€ŒZooKeeperçš„å®ç°åˆ™ç±»ä¼¼AQSçš„é˜Ÿåˆ—ã€‚</p>
<hr>
<p>DefaultRheaKVStore#getDistributedLock</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> DistributedLock<span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token function">getDistributedLock</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> target<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> lease<span class="token punctuation">,</span> <span class="token keyword">final</span> TimeUnit unit<span class="token punctuation">,</span> <span class="token keyword">final</span> ScheduledExecutorService watchdog<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DefaultDistributedLock</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> lease<span class="token punctuation">,</span> unit<span class="token punctuation">,</span> watchdog<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>DistributedLock</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">protected</span> <span class="token function">DistributedLock</span><span class="token punctuation">(</span>T target<span class="token punctuation">,</span> <span class="token keyword">long</span> lease<span class="token punctuation">,</span> TimeUnit unit<span class="token punctuation">,</span> ScheduledExecutorService watchdog<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// åˆ†å¸ƒå¼é”çš„Keyï¼Œé”çš„æ ‡è¯†</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>internalKey <span class="token operator">=</span> <span class="token function">withInternalKey</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// é”çš„è·å–è€…</span>
        <span class="token comment" spellcheck="true">// æœ‰ä¸€ä¸ªåˆ†å¸ƒå¼çš„å”¯ä¸€æ ‡è¯†ï¼Œå…¶å®å°±æ˜¯æ ¹æ®IPå’Œæ—¶é—´ç­‰ç”Ÿæˆ</span>
        <span class="token comment" spellcheck="true">// è¿˜æœ‰ä¸€ä¸ªç§Ÿçº¦Leaseï¼Œè¡¨ç¤ºé”çš„åˆ°æœŸæ—¶é—´ï¼Œå¦‚æœæ²¡æœ‰WatchDogï¼Œåˆ°æœŸé”ä¼šè¢«è‡ªåŠ¨é‡Šæ”¾</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>acquirer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Acquirer</span><span class="token punctuation">(</span>UniqueIdUtil<span class="token punctuation">.</span><span class="token function">generateId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> unit<span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span>lease<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// WatchDogçº¿ç¨‹æ± ï¼Œå³è‡ªåŠ¨ç»­ç§Ÿçš„è°ƒåº¦å™¨ï¼Œå®šæœŸä¸»åŠ¨ä¸ºé”ç»­æ—¶ï¼Œç›´åˆ°ç”¨æˆ·ä¸»åŠ¨é‡Šæ”¾é”</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>watchdog <span class="token operator">=</span> watchdog<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>æ²¡æœ‰è·å–é”è¶…æ—¶</p>
<p>DistributedLock#tryLock</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// åªå°è¯•ä¸€æ¬¡ï¼Œç›´æ¥è¿”å›è·å–é”æ˜¯å¦æˆåŠŸ</span>
        <span class="token keyword">return</span> <span class="token function">internalTryLock</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>æœ‰è·å–é”è¶…æ—¶</p>
<p>DistributedLock#tryLock</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ctx<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token keyword">final</span> TimeUnit unit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> timeoutNs <span class="token operator">=</span> unit<span class="token punctuation">.</span><span class="token function">toNanos</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> startNs <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> attempts <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å¾ªç¯é‡è¯•è·å–é”</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å°è¯•è·å–é”</span>
                <span class="token keyword">final</span> Owner owner <span class="token operator">=</span> <span class="token function">internalTryLock</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// è·å–æˆåŠŸï¼Œç›´æ¥è¿”å›</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>owner<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// è·å–é”è¶…æ—¶ï¼Œä¸å†å°è¯•</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startNs <span class="token operator">>=</span> timeoutNs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>attempts <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    attempts<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">final</span> <span class="token keyword">long</span> remaining <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> owner<span class="token punctuation">.</span><span class="token function">getRemainingMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// é¿å…æ´»é”</span>
                Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>remaining<span class="token punctuation">,</span> <span class="token number">2</span> <span class="token operator">&lt;&lt;</span> attempts<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">final</span> Throwable t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// è·å–é”å¤±è´¥</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>DefaultDistributedLock#internalTryLock</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> Owner <span class="token function">internalTryLock</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//</span>
        <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> internalKey <span class="token operator">=</span> <span class="token function">getInternalKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> Acquirer acquirer <span class="token operator">=</span> <span class="token function">getAcquirer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        acquirer<span class="token punctuation">.</span><span class="token function">setContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å°è¯•è·å–é”</span>
        <span class="token keyword">final</span> CompletableFuture<span class="token operator">&lt;</span>Owner<span class="token operator">></span> future <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rheaKVStore<span class="token punctuation">.</span><span class="token function">tryLockWith</span><span class="token punctuation">(</span>internalKey<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> acquirer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è¿”å›é”çš„æŒæœ‰è€…ï¼Œè¿™é‡Œæœ‰ç‚¹å®¹æ˜“è¯¯è§£</span>
        <span class="token keyword">final</span> Owner owner <span class="token operator">=</span> FutureHelper<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>future<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è·å–é”å¤±è´¥</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>owner<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ›´æ–°é”çš„æŒæœ‰è€…Owner</span>
            <span class="token function">updateOwner</span><span class="token punctuation">(</span>owner<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> owner<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// è·å–é”æˆåŠŸï¼Œæ›´æ–°Ownerå’ŒAcquirerï¼ŒåŒ…æ‹¬FencingToken</span>
        <span class="token function">updateOwnerAndAcquirer</span><span class="token punctuation">(</span>owner<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> ScheduledExecutorService watchdog <span class="token operator">=</span> <span class="token function">getWatchdog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ä¸éœ€è¦è‡ªåŠ¨ç»­çº¦ï¼Œç›´æ¥è¿”å›</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>watchdog <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> owner<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// è¿˜æ²¡æœ‰è®¡åˆ’ä»»åŠ¡</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>watchdogFuture <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// DCL</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>watchdogFuture <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// LeaseMillis / 3 * 2</span>
                    <span class="token keyword">final</span> <span class="token keyword">long</span> period <span class="token operator">=</span> <span class="token punctuation">(</span>acquirer<span class="token punctuation">.</span><span class="token function">getLeaseMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// çº¿ç¨‹æ± è‡ªåŠ¨è·å–é”ç»­ç§Ÿ</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>watchdogFuture <span class="token operator">=</span> <span class="token function">scheduleKeepingLease</span><span class="token punctuation">(</span>watchdog<span class="token punctuation">,</span> internalKey<span class="token punctuation">,</span> acquirer<span class="token punctuation">,</span> period<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// è¿”å›</span>
        <span class="token keyword">return</span> owner<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>DefaultRheaKVStore#tryLockWith</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> CompletableFuture<span class="token operator">&lt;</span>DistributedLock<span class="token punctuation">.</span>Owner<span class="token operator">></span> <span class="token function">tryLockWith</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> keepLease<span class="token punctuation">,</span> <span class="token keyword">final</span> DistributedLock<span class="token punctuation">.</span>Acquirer acquirer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">checkState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Requires<span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token string">"key"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> CompletableFuture<span class="token operator">&lt;</span>DistributedLock<span class="token punctuation">.</span>Owner<span class="token operator">></span> future <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CompletableFuture</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">internalTryLockWith</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> keepLease<span class="token punctuation">,</span> acquirer<span class="token punctuation">,</span> future<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>failoverRetries<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> future<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>DefaultRheaKVStore#internalTryLockWith</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">internalTryLockWith</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> keepLease<span class="token punctuation">,</span> <span class="token keyword">final</span> DistributedLock<span class="token punctuation">.</span>Acquirer acquirer<span class="token punctuation">,</span> <span class="token keyword">final</span> CompletableFuture<span class="token operator">&lt;</span>DistributedLock<span class="token punctuation">.</span>Owner<span class="token operator">></span> future<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> retriesLeft<span class="token punctuation">,</span> <span class="token keyword">final</span> Errors lastCause<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// æ ¹æ®Keyä»è·¯ç”±è¡¨æŸ¥æ‰¾å¯¹åº”çš„Region</span>
        <span class="token keyword">final</span> Region region <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pdClient<span class="token punctuation">.</span><span class="token function">findRegionByKey</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> ErrorsHelper<span class="token punctuation">.</span><span class="token function">isInvalidEpoch</span><span class="token punctuation">(</span>lastCause<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¯¹äºClientï¼Œç›´æ¥è¿”å›null</span>
        <span class="token comment" spellcheck="true">// å¯¹äºServerï¼Œæ ¹æ®RegionIdè¿”å›æœ¬åœ°çš„Regionçš„RegionEngineï¼Œå¦‚æœä¸æ˜¯Leaderï¼Œè¿”å›null</span>
        <span class="token keyword">final</span> RegionEngine regionEngine <span class="token operator">=</span> <span class="token function">getRegionEngine</span><span class="token punctuation">(</span>region<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// é‡è¯•æ–¹æ³•</span>
        <span class="token keyword">final</span> RetryRunner retryRunner <span class="token operator">=</span> retryCause <span class="token operator">-</span><span class="token operator">></span> <span class="token function">internalTryLockWith</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> keepLease<span class="token punctuation">,</span> acquirer<span class="token punctuation">,</span> future<span class="token punctuation">,</span> retriesLeft <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> retryCause<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¤±è´¥å›è°ƒ</span>
        <span class="token keyword">final</span> FailoverClosure<span class="token operator">&lt;</span>DistributedLock<span class="token punctuation">.</span>Owner<span class="token operator">></span> closure <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FailoverClosureImpl</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>future<span class="token punctuation">,</span> retriesLeft<span class="token punctuation">,</span> retryRunner<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// LeaderèŠ‚ç‚¹åœ¨æœ¬åœ°</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>regionEngine <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ensureOnValidEpoch</span><span class="token punctuation">(</span>region<span class="token punctuation">,</span> regionEngine<span class="token punctuation">,</span> closure<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æœ¬åœ°ç›´æ¥æ‰§è¡Œ</span>
                <span class="token function">getRawKVStore</span><span class="token punctuation">(</span>regionEngine<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">tryLockWith</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> region<span class="token punctuation">.</span><span class="token function">getStartKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> keepLease<span class="token punctuation">,</span> acquirer<span class="token punctuation">,</span> closure<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> KeyLockRequest request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KeyLockRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            request<span class="token punctuation">.</span><span class="token function">setKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            request<span class="token punctuation">.</span><span class="token function">setKeepLease</span><span class="token punctuation">(</span>keepLease<span class="token punctuation">)</span><span class="token punctuation">;</span>
            request<span class="token punctuation">.</span><span class="token function">setAcquirer</span><span class="token punctuation">(</span>acquirer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            request<span class="token punctuation">.</span><span class="token function">setRegionId</span><span class="token punctuation">(</span>region<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            request<span class="token punctuation">.</span><span class="token function">setRegionEpoch</span><span class="token punctuation">(</span>region<span class="token punctuation">.</span><span class="token function">getRegionEpoch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// RPCå‘Leaderè°ƒç”¨</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>rheaKVRpcService<span class="token punctuation">.</span><span class="token function">callAsyncWithRpc</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> closure<span class="token punctuation">,</span> lastCause<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>DefaultRheaKVRpcService#callAsyncWithRpc</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token operator">&lt;</span>V<span class="token operator">></span> CompletableFuture<span class="token operator">&lt;</span>V<span class="token operator">></span> <span class="token function">callAsyncWithRpc</span><span class="token punctuation">(</span><span class="token keyword">final</span> BaseRequest request<span class="token punctuation">,</span> <span class="token keyword">final</span> FailoverClosure<span class="token operator">&lt;</span>V<span class="token operator">></span> closure<span class="token punctuation">,</span> <span class="token keyword">final</span> Errors lastCause<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> requireLeader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> forceRefresh <span class="token operator">=</span> ErrorsHelper<span class="token punctuation">.</span><span class="token function">isInvalidPeer</span><span class="token punctuation">(</span>lastCause<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ ¹æ®RegionIdå’Œæ˜¯å¦éœ€è¦Leaderè¿”å›ç«¯ç‚¹</span>
        <span class="token keyword">final</span> Endpoint endpoint <span class="token operator">=</span> <span class="token function">getRpcEndpoint</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getRegionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> forceRefresh<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rpcTimeoutMillis<span class="token punctuation">,</span> requireLeader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ‰§è¡ŒRPC</span>
        <span class="token function">internalCallAsyncWithRpc</span><span class="token punctuation">(</span>endpoint<span class="token punctuation">,</span> request<span class="token punctuation">,</span> closure<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> closure<span class="token punctuation">.</span><span class="token function">future</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>KVCommandProcessor#handleRequest</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleRequest</span><span class="token punctuation">(</span><span class="token keyword">final</span> BizContext bizCtx<span class="token punctuation">,</span> <span class="token keyword">final</span> AsyncContext asyncCtx<span class="token punctuation">,</span> <span class="token keyword">final</span> T request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// å›è°ƒ</span>
        <span class="token keyword">final</span> RequestProcessClosure<span class="token operator">&lt;</span>BaseRequest<span class="token punctuation">,</span> BaseResponse<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>></span> closure <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RequestProcessClosure</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> bizCtx<span class="token punctuation">,</span> asyncCtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ ¹æ®RegionIdè·å–å¯¹åº”çš„RegionKVService</span>
        <span class="token keyword">final</span> RegionKVService regionKVService <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>storeEngine<span class="token punctuation">.</span><span class="token function">getRegionKVService</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getRegionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>regionKVService <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> NoRegionFoundResponse noRegion <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NoRegionFoundResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            noRegion<span class="token punctuation">.</span><span class="token function">setRegionId</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getRegionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            noRegion<span class="token punctuation">.</span><span class="token function">setError</span><span class="token punctuation">(</span>Errors<span class="token punctuation">.</span>NO_REGION_FOUND<span class="token punctuation">)</span><span class="token punctuation">;</span>
            noRegion<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            closure<span class="token punctuation">.</span><span class="token function">sendResponse</span><span class="token punctuation">(</span>noRegion<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">magic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> BaseRequest<span class="token punctuation">.</span>PUT<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> BaseRequest<span class="token punctuation">.</span>BATCH_PUT<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> BaseRequest<span class="token punctuation">.</span>PUT_IF_ABSENT<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> BaseRequest<span class="token punctuation">.</span>GET_PUT<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> BaseRequest<span class="token punctuation">.</span>COMPARE_PUT<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> BaseRequest<span class="token punctuation">.</span>DELETE<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> BaseRequest<span class="token punctuation">.</span>DELETE_RANGE<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> BaseRequest<span class="token punctuation">.</span>BATCH_DELETE<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> BaseRequest<span class="token punctuation">.</span>MERGE<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> BaseRequest<span class="token punctuation">.</span>GET<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> BaseRequest<span class="token punctuation">.</span>MULTI_GET<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> BaseRequest<span class="token punctuation">.</span>SCAN<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> BaseRequest<span class="token punctuation">.</span>GET_SEQUENCE<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> BaseRequest<span class="token punctuation">.</span>RESET_SEQUENCE<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> BaseRequest<span class="token punctuation">.</span>KEY_LOCK<span class="token operator">:</span>
                regionKVService<span class="token punctuation">.</span><span class="token function">handleKeyLockRequest</span><span class="token punctuation">(</span><span class="token punctuation">(</span>KeyLockRequest<span class="token punctuation">)</span> request<span class="token punctuation">,</span> closure<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> BaseRequest<span class="token punctuation">.</span>KEY_UNLOCK<span class="token operator">:</span>
                regionKVService<span class="token punctuation">.</span><span class="token function">handleKeyUnlockRequest</span><span class="token punctuation">(</span><span class="token punctuation">(</span>KeyUnlockRequest<span class="token punctuation">)</span> request<span class="token punctuation">,</span> closure<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> BaseRequest<span class="token punctuation">.</span>NODE_EXECUTE<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> BaseRequest<span class="token punctuation">.</span>RANGE_SPLIT<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>Leaderæ”¶åˆ°è·å–é”è¯·æ±‚</p>
<p>DefaultRegionKVService#handleKeyLockRequest</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleKeyLockRequest</span><span class="token punctuation">(</span><span class="token keyword">final</span> KeyLockRequest request<span class="token punctuation">,</span> <span class="token keyword">final</span> RequestProcessClosure<span class="token operator">&lt;</span>BaseRequest<span class="token punctuation">,</span> BaseResponse<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>></span> closure<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> KeyLockResponse response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KeyLockResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setRegionId</span><span class="token punctuation">(</span><span class="token function">getRegionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setRegionEpoch</span><span class="token punctuation">(</span><span class="token function">getRegionEpoch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            KVParameterRequires<span class="token punctuation">.</span><span class="token function">requireSameEpoch</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token function">getRegionEpoch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key <span class="token operator">=</span> KVParameterRequires<span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"lock.key"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// FencingKeyä¸ºRegionçš„å·¦ç«¯ç‚¹</span>
            <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fencingKey <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>regionEngine<span class="token punctuation">.</span><span class="token function">getRegion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStartKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ä»è¯·æ±‚è·å–Acquirer</span>
            <span class="token keyword">final</span> DistributedLock<span class="token punctuation">.</span>Acquirer acquirer <span class="token operator">=</span> KVParameterRequires<span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getAcquirer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"lock.acquirer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// å°è¯•è·å–é”</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>rawKVStore<span class="token punctuation">.</span><span class="token function">tryLockWith</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> fencingKey<span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">isKeepLease</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> acquirer<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">BaseKVStoreClosure</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">final</span> Status status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// æ—¥å¿—æˆåŠŸæäº¤</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        response<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span><span class="token punctuation">(</span>DistributedLock<span class="token punctuation">.</span>Owner<span class="token punctuation">)</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token function">setFailure</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> status<span class="token punctuation">,</span> <span class="token function">getError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    closure<span class="token punctuation">.</span><span class="token function">sendResponse</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">final</span> Throwable t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>RaftRawKVStore#tryLockWith</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">tryLockWith</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fencingKey<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> keepLease<span class="token punctuation">,</span> <span class="token keyword">final</span> DistributedLock<span class="token punctuation">.</span>Acquirer acquirer<span class="token punctuation">,</span> <span class="token keyword">final</span> KVStoreClosure closure<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">/*
         * ç®—æ³•ä¾èµ–äºä»¥ä¸‹å‡è®¾ï¼šå°½ç®¡è·¨è¿›ç¨‹å­˜åœ¨éåŒæ­¥æ—¶é’Ÿï¼Œä½†æ¯ä¸ªè¿›ç¨‹ä¸­çš„æœ¬åœ°æ—¶é—´ä»ä»¥å¤§è‡´ç›¸åŒçš„é€Ÿç‡æµåŠ¨ï¼Œå¹¶ä¸”ä¸é”çš„è‡ªåŠ¨é‡Šæ”¾æ—¶é—´ç›¸æ¯”å…¶é”™è¯¯è¾ƒå°
         */</span>
        <span class="token comment" spellcheck="true">// è®¾ç½®é”è·å–å™¨Acquirerçš„é”æ—¶é—´æˆ³</span>
        acquirer<span class="token punctuation">.</span><span class="token function">setLockingTimestamp</span><span class="token punctuation">(</span>Clock<span class="token punctuation">.</span><span class="token function">defaultClock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å‘å¸ƒæ—¥å¿—åˆ°æ‰€æœ‰FollowerèŠ‚ç‚¹</span>
        <span class="token function">applyOperation</span><span class="token punctuation">(</span>KVOperation<span class="token punctuation">.</span><span class="token function">createKeyLockRequest</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> fencingKey<span class="token punctuation">,</span> Pair<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>keepLease<span class="token punctuation">,</span> acquirer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> closure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>RaftRawKVStore#applyOperation</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">applyOperation</span><span class="token punctuation">(</span><span class="token keyword">final</span> KVOperation op<span class="token punctuation">,</span> <span class="token keyword">final</span> KVStoreClosure closure<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// å¿…é¡»ä¿è¯å½“å‰æ“ä½œçš„èŠ‚ç‚¹æ˜¯Leader</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// åˆ›å»ºä»»åŠ¡</span>
        <span class="token keyword">final</span> Task task <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        task<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>ByteBuffer<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>Serializers<span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        task<span class="token punctuation">.</span><span class="token function">setDone</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">KVClosureAdapter</span><span class="token punctuation">(</span>closure<span class="token punctuation">,</span> op<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å‘å¸ƒæ—¥å¿—</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>node<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ç•¥è¿‡Raftçš„æµç¨‹å¤„ç†ï¼Œå½“Leaderæ”¶åˆ°å¤§å¤šæ•°FollowerèŠ‚ç‚¹çš„å“åº”ï¼Œå¹¶åº”ç”¨çŠ¶æ€æœºçš„æ—¶å€™</p>
<p>KVStoreStateMachine#onApply</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onApply</span><span class="token punctuation">(</span><span class="token keyword">final</span> Iterator it<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> applied <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// KVStateè¾“å‡ºåˆ—è¡¨ï¼Œè™½ç„¶æœ‰ä¸ªnewInstanceï¼Œå…¶å®æ˜¯ä»å¯¹è±¡æ± æ‹¿</span>
            KVStateOutputList kvStates <span class="token operator">=</span> KVStateOutputList<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                KVOperation kvOp<span class="token punctuation">;</span>
                <span class="token keyword">final</span> KVClosureAdapter done <span class="token operator">=</span> <span class="token punctuation">(</span>KVClosureAdapter<span class="token punctuation">)</span> it<span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// LeaderèŠ‚ç‚¹æœ‰å›è°ƒ</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>done <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ç›´æ¥è·å–KVOperation</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// è¯´æ˜æ˜¯Followerï¼Œå›è°ƒä¸ä¼šè¢«åºåˆ—åŒ–</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ååºåˆ—åŒ–KVOperation</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">final</span> KVState first <span class="token operator">=</span> kvStates<span class="token punctuation">.</span><span class="token function">getFirstElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// æ²¡çœ‹æ‡‚è¿™äº›æ“ä½œçš„æ„å›¾</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>first <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>first<span class="token punctuation">.</span><span class="token function">isSameOp</span><span class="token punctuation">(</span>kvOp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    applied <span class="token operator">+=</span> <span class="token function">batchApplyAndRecycle</span><span class="token punctuation">(</span>first<span class="token punctuation">.</span><span class="token function">getOpByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kvStates<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    kvStates <span class="token operator">=</span> KVStateOutputList<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// å°†KVOperationå’Œå›è°ƒåŒ…è£…ä¸ºKVStateåŠ å…¥</span>
                kvStates<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>KVState<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>kvOp<span class="token punctuation">,</span> done<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">++</span>index<span class="token punctuation">;</span>
                it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>kvStates<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> KVState first <span class="token operator">=</span> kvStates<span class="token punctuation">.</span><span class="token function">getFirstElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">assert</span> first <span class="token operator">!=</span> null<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// æ‰§è¡Œ</span>
                applied <span class="token operator">+=</span> <span class="token function">batchApplyAndRecycle</span><span class="token punctuation">(</span>first<span class="token punctuation">.</span><span class="token function">getOpByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kvStates<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">final</span> Throwable t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>KVStoreStateMachine#batchApplyAndRecycle</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">batchApplyAndRecycle</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">byte</span> opByte<span class="token punctuation">,</span> <span class="token keyword">final</span> KVStateOutputList kvStates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> size <span class="token operator">=</span> kvStates<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token function">batchApply</span><span class="token punctuation">(</span>opByte<span class="token punctuation">,</span> kvStates<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> size<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            RecycleUtil<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span>kvStates<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>KVStoreStateMachine#batchApply</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">batchApply</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">byte</span> opType<span class="token punctuation">,</span> <span class="token keyword">final</span> KVStateOutputList kvStates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>opType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> KVOperation<span class="token punctuation">.</span>PUT<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> KVOperation<span class="token punctuation">.</span>PUT_IF_ABSENT<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> KVOperation<span class="token punctuation">.</span>PUT_LIST<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> KVOperation<span class="token punctuation">.</span>DELETE<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> KVOperation<span class="token punctuation">.</span>DELETE_RANGE<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> KVOperation<span class="token punctuation">.</span>DELETE_LIST<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> KVOperation<span class="token punctuation">.</span>GET_SEQUENCE<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> KVOperation<span class="token punctuation">.</span>NODE_EXECUTE<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> KVOperation<span class="token punctuation">.</span>KEY_LOCK<span class="token operator">:</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>rawKVStore<span class="token punctuation">.</span><span class="token function">batchTryLockWith</span><span class="token punctuation">(</span>kvStates<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> KVOperation<span class="token punctuation">.</span>KEY_LOCK_RELEASE<span class="token operator">:</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>rawKVStore<span class="token punctuation">.</span><span class="token function">batchReleaseLockWith</span><span class="token punctuation">(</span>kvStates<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> KVOperation<span class="token punctuation">.</span>GET<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> KVOperation<span class="token punctuation">.</span>MULTI_GET<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> KVOperation<span class="token punctuation">.</span>SCAN<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> KVOperation<span class="token punctuation">.</span>GET_PUT<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> KVOperation<span class="token punctuation">.</span>COMPARE_PUT<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> KVOperation<span class="token punctuation">.</span>MERGE<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> KVOperation<span class="token punctuation">.</span>RESET_SEQUENCE<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> KVOperation<span class="token punctuation">.</span>RANGE_SPLIT<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>BatchRawKVStore#batchTryLockWith</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">batchTryLockWith</span><span class="token punctuation">(</span><span class="token keyword">final</span> KVStateOutputList kvStates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> kvStates<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> KVState kvState <span class="token operator">=</span> kvStates<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> KVOperation op <span class="token operator">=</span> kvState<span class="token punctuation">.</span><span class="token function">getOp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> Pair<span class="token operator">&lt;</span>Boolean<span class="token punctuation">,</span> DistributedLock<span class="token punctuation">.</span>Acquirer<span class="token operator">></span> acquirerPair <span class="token operator">=</span> op<span class="token punctuation">.</span><span class="token function">getAcquirerPair</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">tryLockWith</span><span class="token punctuation">(</span>op<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> op<span class="token punctuation">.</span><span class="token function">getFencingKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> acquirerPair<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> acquirerPair<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kvState<span class="token punctuation">.</span><span class="token function">getDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>ä»¥MemoryRawKVStoreä¸ºä¾‹</p>
<p>MemoryRawKVStore#tryLockWith</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">tryLockWith</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fencingKey<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> keepLease<span class="token punctuation">,</span> <span class="token keyword">final</span> DistributedLock<span class="token punctuation">.</span>Acquirer acquirer<span class="token punctuation">,</span> <span class="token keyword">final</span> KVStoreClosure closure<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// The algorithm relies on the assumption that while there is no synchronized clock across the processes,</span>
            <span class="token comment" spellcheck="true">// still the local time in every process flows approximately at the same rate,</span>
            <span class="token comment" spellcheck="true">// with an error which is small compared to the auto-release time of the lock.</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> now <span class="token operator">=</span> acquirer<span class="token punctuation">.</span><span class="token function">getLockingTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> timeoutMillis <span class="token operator">=</span> acquirer<span class="token punctuation">.</span><span class="token function">getLeaseMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> ByteArray wrappedKey <span class="token operator">=</span> ByteArray<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è·å–è¯¥é”çš„ä¸Šä¸€ä¸ªæŒæœ‰è€…</span>
            <span class="token keyword">final</span> DistributedLock<span class="token punctuation">.</span>Owner prevOwner <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lockerDB<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>wrappedKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æœ¬æ¬¡å°è¯•è·å–é”çš„å¯¹è±¡</span>
            <span class="token keyword">final</span> DistributedLock<span class="token punctuation">.</span>Owner owner<span class="token punctuation">;</span>
            <span class="token keyword">do</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> DistributedLock<span class="token punctuation">.</span>OwnerBuilder builder <span class="token operator">=</span> DistributedLock<span class="token punctuation">.</span><span class="token function">newOwnerBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// é”è¿˜æ²¡è¢«è·å¾—ï¼Œç©ºé—²</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>prevOwner <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// æ˜¯å¦è‡ªåŠ¨ç»­çº¦ï¼Œåªæœ‰é€šè¿‡WatchDogçº¿ç¨‹æ± çš„è®¡åˆ’ä»»åŠ¡æ‰§è¡Œæ—¶æ‰æ˜¯</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>keepLease<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// æƒ³è‡ªåŠ¨ç»­çº¦ä½†æ˜¯å·²ç»æ™šäº†ï¼Œé”å·²ç»è¢«é‡Šæ”¾</span>
                        owner <span class="token operator">=</span> builder <span class="token comment" spellcheck="true">//</span>
                                <span class="token comment" spellcheck="true">// set acquirer id</span>
                                <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>acquirer<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token comment" spellcheck="true">// fail to keep lease</span>
                                <span class="token punctuation">.</span><span class="token function">remainingMillis</span><span class="token punctuation">(</span>DistributedLock<span class="token punctuation">.</span>OwnerBuilder<span class="token punctuation">.</span>KEEP_LEASE_FAIL<span class="token punctuation">)</span>
                                <span class="token comment" spellcheck="true">// è·å–é”å¤±è´¥</span>
                                <span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// ç¬¬ä¸€æ¬¡è·å–é”ï¼Œæˆ–è€…ä¹‹å‰çš„é”å·²ç»è¢«é‡Šæ”¾</span>
                    owner <span class="token operator">=</span> builder <span class="token comment" spellcheck="true">//</span>
                            <span class="token comment" spellcheck="true">// è®¾ç½®é”çš„æŒæœ‰è€…çš„Id</span>
                            <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>acquirer<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token comment" spellcheck="true">// æˆªæ­¢æ—¶é—´ä¸ºLeaderå°è¯•æ‰§è¡Œè·å–é”æ“ä½œçš„æ—¶é—´åŠ ä¸Šç§Ÿçº¦æ—¶é—´</span>
                            <span class="token punctuation">.</span><span class="token function">deadlineMillis</span><span class="token punctuation">(</span>now <span class="token operator">+</span> timeoutMillis<span class="token punctuation">)</span>
                            <span class="token comment" spellcheck="true">// first time to acquire and success</span>
                            <span class="token punctuation">.</span><span class="token function">remainingMillis</span><span class="token punctuation">(</span>DistributedLock<span class="token punctuation">.</span>OwnerBuilder<span class="token punctuation">.</span>FIRST_TIME_SUCCESS<span class="token punctuation">)</span>
                            <span class="token comment" spellcheck="true">// ç”Ÿæˆä¸€ä¸ªæ–°çš„FencingToken</span>
                            <span class="token punctuation">.</span><span class="token function">fencingToken</span><span class="token punctuation">(</span><span class="token function">getNextFencingToken</span><span class="token punctuation">(</span>fencingKey<span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token comment" spellcheck="true">// ç¬¬ä¸€æ¬¡è·å–ï¼Œé‡å…¥æ¬¡æ•°ä¸º1</span>
                            <span class="token punctuation">.</span><span class="token function">acquires</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
                            <span class="token comment" spellcheck="true">// è®¾ç½®Acquirerçš„ä¸Šä¸‹æ–‡</span>
                            <span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span>acquirer<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token comment" spellcheck="true">// è·å–é”æˆåŠŸ</span>
                            <span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// å­˜å…¥</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>lockerDB<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>wrappedKey<span class="token punctuation">,</span> owner<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// å¦‚æœé”å·²ç»æœ‰äº†æŒæœ‰è€…ï¼Œæ£€æŸ¥æ˜¯å¦å·²ç»è¿‡æœŸï¼Œç”¨ä¸Šä¸€ä¸ªé”çš„æˆªæ­¢æ—¥æœŸå‡å»è·å–å½“å‰çš„é”æ“ä½œçš„å¼€å§‹æ—¶é—´</span>
                <span class="token keyword">final</span> <span class="token keyword">long</span> remainingMillis <span class="token operator">=</span> prevOwner<span class="token punctuation">.</span><span class="token function">getDeadlineMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> now<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// é”å·²è¿‡æœŸ</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>remainingMillis <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// æ˜¯å¦è‡ªåŠ¨ç»­çº¦</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>keepLease<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// æƒ³è‡ªåŠ¨ç»­çº¦ä½†æ˜¯å·²ç»æ™šäº†ï¼Œé”å·²ç»è¿‡æœŸ</span>
                        owner <span class="token operator">=</span> builder <span class="token comment" spellcheck="true">//</span>
                                <span class="token comment" spellcheck="true">// still previous owner id</span>
                                <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>prevOwner<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token comment" spellcheck="true">// do not update</span>
                                <span class="token punctuation">.</span><span class="token function">deadlineMillis</span><span class="token punctuation">(</span>prevOwner<span class="token punctuation">.</span><span class="token function">getDeadlineMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token comment" spellcheck="true">// fail to keep lease</span>
                                <span class="token punctuation">.</span><span class="token function">remainingMillis</span><span class="token punctuation">(</span>DistributedLock<span class="token punctuation">.</span>OwnerBuilder<span class="token punctuation">.</span>KEEP_LEASE_FAIL<span class="token punctuation">)</span>
                                <span class="token comment" spellcheck="true">// set previous ctx</span>
                                <span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span>prevOwner<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token comment" spellcheck="true">// è·å–é”å¤±è´¥</span>
                                <span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// åˆ›å»ºæ–°çš„é”æŒæœ‰è€…</span>
                    owner <span class="token operator">=</span> builder <span class="token comment" spellcheck="true">//</span>
                            <span class="token comment" spellcheck="true">// set acquirer id, now it will own the lock</span>
                            <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>acquirer<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token comment" spellcheck="true">// set a new deadline</span>
                            <span class="token punctuation">.</span><span class="token function">deadlineMillis</span><span class="token punctuation">(</span>now <span class="token operator">+</span> timeoutMillis<span class="token punctuation">)</span>
                            <span class="token comment" spellcheck="true">// success as a new acquirer</span>
                            <span class="token punctuation">.</span><span class="token function">remainingMillis</span><span class="token punctuation">(</span>DistributedLock<span class="token punctuation">.</span>OwnerBuilder<span class="token punctuation">.</span>NEW_ACQUIRE_SUCCESS<span class="token punctuation">)</span>
                            <span class="token comment" spellcheck="true">// create a new fencing token</span>
                            <span class="token punctuation">.</span><span class="token function">fencingToken</span><span class="token punctuation">(</span><span class="token function">getNextFencingToken</span><span class="token punctuation">(</span>fencingKey<span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token comment" spellcheck="true">// init acquires</span>
                            <span class="token punctuation">.</span><span class="token function">acquires</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
                            <span class="token comment" spellcheck="true">// set acquirer ctx</span>
                            <span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span>acquirer<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token comment" spellcheck="true">// è·å–é”æˆåŠŸ</span>
                            <span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// å­˜å…¥</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>lockerDB<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>wrappedKey<span class="token punctuation">,</span> owner<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// åŸæœ¬çš„é”æŒæœ‰è€…è¿˜æ²¡è¿‡æœŸï¼Œæ ¹æ®Acquirerçš„Idå’ŒFencingTokenåˆ¤æ–­ï¼Œå¦‚æœæ˜¯åŒä¸€ä¸ªï¼Œåˆ™æ˜¯é‡å…¥</span>
                <span class="token keyword">final</span> <span class="token keyword">boolean</span> isReentrant <span class="token operator">=</span> prevOwner<span class="token punctuation">.</span><span class="token function">isSameAcquirer</span><span class="token punctuation">(</span>acquirer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// é‡å…¥</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>isReentrant<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// æ¥è‡ªè‡ªåŠ¨ç»­çº¦çº¿ç¨‹</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>keepLease<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        owner <span class="token operator">=</span> builder <span class="token comment" spellcheck="true">//</span>
                                <span class="token comment" spellcheck="true">// ä¿æŒä¸å˜</span>
                                <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>prevOwner<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token comment" spellcheck="true">// æ›´æ–°é”çš„æˆªæ­¢æ—¥æœŸ</span>
                                <span class="token punctuation">.</span><span class="token function">deadlineMillis</span><span class="token punctuation">(</span>now <span class="token operator">+</span> timeoutMillis<span class="token punctuation">)</span>
                                <span class="token comment" spellcheck="true">// success to keep lease</span>
                                <span class="token punctuation">.</span><span class="token function">remainingMillis</span><span class="token punctuation">(</span>DistributedLock<span class="token punctuation">.</span>OwnerBuilder<span class="token punctuation">.</span>KEEP_LEASE_SUCCESS<span class="token punctuation">)</span>
                                <span class="token comment" spellcheck="true">// ä¿æŒä¸å˜</span>
                                <span class="token punctuation">.</span><span class="token function">fencingToken</span><span class="token punctuation">(</span>prevOwner<span class="token punctuation">.</span><span class="token function">getFencingToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token comment" spellcheck="true">// ä¿æŒä¸å˜</span>
                                <span class="token punctuation">.</span><span class="token function">acquires</span><span class="token punctuation">(</span>prevOwner<span class="token punctuation">.</span><span class="token function">getAcquires</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token comment" spellcheck="true">// ä¿æŒä¸å˜</span>
                                <span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span>prevOwner<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token comment" spellcheck="true">// è·å–é”æˆåŠŸ</span>
                                <span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// æ›´æ–°</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>lockerDB<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>wrappedKey<span class="token punctuation">,</span> owner<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// é‡å…¥é”</span>
                    owner <span class="token operator">=</span> builder <span class="token comment" spellcheck="true">//</span>
                            <span class="token comment" spellcheck="true">// ä¿æŒä¸å˜</span>
                            <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>prevOwner<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token comment" spellcheck="true">// é¡ºä¾¿ä¹Ÿä¼šæ›´æ–°é”çš„æˆªæ­¢æ—¥æœŸ</span>
                            <span class="token punctuation">.</span><span class="token function">deadlineMillis</span><span class="token punctuation">(</span>now <span class="token operator">+</span> timeoutMillis<span class="token punctuation">)</span>
                            <span class="token comment" spellcheck="true">// success reentrant</span>
                            <span class="token punctuation">.</span><span class="token function">remainingMillis</span><span class="token punctuation">(</span>DistributedLock<span class="token punctuation">.</span>OwnerBuilder<span class="token punctuation">.</span>REENTRANT_SUCCESS<span class="token punctuation">)</span>
                            <span class="token comment" spellcheck="true">// ä¿æŒä¸å˜</span>
                            <span class="token punctuation">.</span><span class="token function">fencingToken</span><span class="token punctuation">(</span>prevOwner<span class="token punctuation">.</span><span class="token function">getFencingToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token comment" spellcheck="true">// é‡å…¥æ¬¡æ•°è‡ªå¢</span>
                            <span class="token punctuation">.</span><span class="token function">acquires</span><span class="token punctuation">(</span>prevOwner<span class="token punctuation">.</span><span class="token function">getAcquires</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
                            <span class="token comment" spellcheck="true">// é‡å…¥çš„æ—¶å€™éœ€è¦æ›´æ–°Acquirerä¸Šä¸‹æ–‡</span>
                            <span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span>acquirer<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token comment" spellcheck="true">// è·å–é”æˆåŠŸ</span>
                            <span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// æ›´æ–°</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>lockerDB<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>wrappedKey<span class="token punctuation">,</span> owner<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// é”å·²è¢«è·å–ï¼Œä½†æ˜¯ä¸æ˜¯é‡å…¥</span>
                owner <span class="token operator">=</span> builder <span class="token comment" spellcheck="true">//</span>
                        <span class="token comment" spellcheck="true">// set previous owner id to tell who is the real owner</span>
                        <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>prevOwner<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token comment" spellcheck="true">// set the remaining lease time of current owner</span>
                        <span class="token punctuation">.</span><span class="token function">remainingMillis</span><span class="token punctuation">(</span>remainingMillis<span class="token punctuation">)</span>
                        <span class="token comment" spellcheck="true">// set previous ctx</span>
                        <span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span>prevOwner<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token comment" spellcheck="true">// è·å–é”å¤±è´¥</span>
                        <span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// æ‰§è¡ŒæˆåŠŸå›è°ƒ</span>
            <span class="token function">setSuccess</span><span class="token punctuation">(</span>closure<span class="token punctuation">,</span> owner<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">final</span> Exception e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>å…³äºFencingTokenï¼ŒFencingTokenæ˜¯ä¸€ä¸ªå•è°ƒé€’å¢çš„Longç±»å‹ï¼Œæ ‡æ˜é”çš„æŒæœ‰è€…çš„å…ˆåé¡ºåºã€‚</p>
<p>æŒ‰ç…§å®˜æ–¹çš„è¯´æ³•ï¼Œå‡å¦‚ClientAè·å–é”åå‘ç”Ÿäº†å¾ˆé•¿çš„GCï¼Œè¿™æ®µæ—¶é—´å†…æ²¡æœ‰è‡ªåŠ¨ç»­ç§Ÿï¼Œå¹¶ä¸”é”è¿‡æœŸäº†ï¼Œç„¶åClientBè·å–äº†è¯¥é”ï¼Œåœ¨ClientAä»GCä¸­æ¢å¤åï¼Œå®ƒä¸çŸ¥é“è‡ªå·±çš„é”å·²ç»å¤±æ•ˆäº†ï¼Œé”å°±ä¼šåŒæ—¶è¢«ä¸¤ä¸ªClientæŒæœ‰ã€‚</p>
<p>ä¸è¿‡ï¼Œè¿™ä¸ªå’ŒFencingTokenæœ‰å•¥å…³ç³»å‘¢ï¼Œéš¾é“æ˜¯éœ€è¦åŠ ä¸€ä¸ªåˆ¤æ–­ï¼ŒFencingTokenä»£è¡¨çš„é”æ‰§è¡Œåï¼Œå°äºè¯¥FencingTokençš„é”å°±æ— æ•ˆï¼Ÿ</p>
<hr>
<p>DefaultDistributedLock#unlock</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> internalKey <span class="token operator">=</span> <span class="token function">getInternalKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> Acquirer acquirer <span class="token operator">=</span> <span class="token function">getAcquirer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// é‡Šæ”¾é”ï¼Œè¿”å›é”çš„Owner</span>
            <span class="token keyword">final</span> Owner owner <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rheaKVStore<span class="token punctuation">.</span><span class="token function">releaseLockWith</span><span class="token punctuation">(</span>internalKey<span class="token punctuation">,</span> acquirer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ›´æ–°Owner</span>
            <span class="token function">updateOwner</span><span class="token punctuation">(</span>owner<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// é‡Šæ”¾ä¸€ä¸ªä¸å±äºè‡ªå·±çš„é”</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>owner<span class="token punctuation">.</span><span class="token function">isSameAcquirer</span><span class="token punctuation">(</span>acquirer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// é‡å…¥çš„é”å…¨éƒ¨é‡Šæ”¾å®Œ</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>owner<span class="token punctuation">.</span><span class="token function">getAcquires</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å–æ¶ˆWatchDogä»»åŠ¡</span>
                <span class="token function">tryCancelScheduling</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">final</span> InvalidLockAcquirerException e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">final</span> Throwable t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>MemoryRawKVStore#releaseLockWith</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">releaseLockWith</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key<span class="token punctuation">,</span> <span class="token keyword">final</span> DistributedLock<span class="token punctuation">.</span>Acquirer acquirer<span class="token punctuation">,</span> <span class="token keyword">final</span> KVStoreClosure closure<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> ByteArray wrappedKey <span class="token operator">=</span> ByteArray<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// é”åŸæœ¬çš„æŒæœ‰è€…</span>
            <span class="token keyword">final</span> DistributedLock<span class="token punctuation">.</span>Owner prevOwner <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lockerDB<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>wrappedKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> DistributedLock<span class="token punctuation">.</span>Owner owner<span class="token punctuation">;</span>
            <span class="token keyword">do</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> DistributedLock<span class="token punctuation">.</span>OwnerBuilder builder <span class="token operator">=</span> DistributedLock<span class="token punctuation">.</span><span class="token function">newOwnerBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// é‡Šæ”¾é”ï¼Œä½†æ˜¯é”å·²ç»æ²¡æœ‰æŒæœ‰è€…äº†ï¼Œå¯èƒ½æ˜¯å› ä¸ºè¿‡æœŸï¼Œè¢«åˆ«äººè·å–åˆé‡Šæ”¾äº†ï¼Œæˆ–è€…æ˜¯é‡å¤çš„é‡Šæ”¾è¯·æ±‚</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>prevOwner <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    owner <span class="token operator">=</span> builder <span class="token comment" spellcheck="true">//</span>
                            <span class="token comment" spellcheck="true">// é‚£ä½ å°±æ˜¯æŒæœ‰è€…äº†</span>
                            <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>acquirer<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token comment" spellcheck="true">// set acquirer fencing token</span>
                            <span class="token punctuation">.</span><span class="token function">fencingToken</span><span class="token punctuation">(</span>acquirer<span class="token punctuation">.</span><span class="token function">getFencingToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token comment" spellcheck="true">// æ²¡æœ‰è¢«è·å–</span>
                            <span class="token punctuation">.</span><span class="token function">acquires</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
                            <span class="token comment" spellcheck="true">// é‡Šæ”¾é”æˆåŠŸ</span>
                            <span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// é‡Šæ”¾é”çš„å°±æ˜¯åŸæœ¬é”çš„æŒæœ‰è€…</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>prevOwner<span class="token punctuation">.</span><span class="token function">isSameAcquirer</span><span class="token punctuation">(</span>acquirer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// é‡å…¥æ¬¡æ•°è‡ªå‡</span>
                    <span class="token keyword">final</span> <span class="token keyword">long</span> acquires <span class="token operator">=</span> prevOwner<span class="token punctuation">.</span><span class="token function">getAcquires</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
                    owner <span class="token operator">=</span> builder <span class="token comment" spellcheck="true">//</span>
                            <span class="token comment" spellcheck="true">// ç»´æŒä¸å˜</span>
                            <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>prevOwner<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token comment" spellcheck="true">// ç»´æŒä¸å˜</span>
                            <span class="token punctuation">.</span><span class="token function">deadlineMillis</span><span class="token punctuation">(</span>prevOwner<span class="token punctuation">.</span><span class="token function">getDeadlineMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token comment" spellcheck="true">// ç»´æŒä¸å˜</span>
                            <span class="token punctuation">.</span><span class="token function">fencingToken</span><span class="token punctuation">(</span>prevOwner<span class="token punctuation">.</span><span class="token function">getFencingToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token comment" spellcheck="true">// æ›´æ–°é‡å…¥æ¬¡æ•°</span>
                            <span class="token punctuation">.</span><span class="token function">acquires</span><span class="token punctuation">(</span>acquires<span class="token punctuation">)</span>
                            <span class="token comment" spellcheck="true">// ç»´æŒä¸å˜</span>
                            <span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span>prevOwner<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token comment" spellcheck="true">// é‡Šæ”¾é”æˆåŠŸ</span>
                            <span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// æ‰€æœ‰çš„é‡å…¥éƒ½å·²è¢«é‡Šæ”¾</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>acquires <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// å¯ä»¥åˆ é™¤äº†</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>lockerDB<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>wrappedKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// æ›´æ–°</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>lockerDB<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>wrappedKey<span class="token punctuation">,</span> owner<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// é‡Šæ”¾é”çš„å’ŒæŒæœ‰é”çš„ä¸ä¸€è‡´ï¼Œä¸èƒ½é‡Šæ”¾é”</span>
                owner <span class="token operator">=</span> builder <span class="token comment" spellcheck="true">//</span>
                        <span class="token comment" spellcheck="true">// set previous owner id to tell who is the real owner</span>
                        <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>prevOwner<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token comment" spellcheck="true">// keep previous fencing token</span>
                        <span class="token punctuation">.</span><span class="token function">fencingToken</span><span class="token punctuation">(</span>prevOwner<span class="token punctuation">.</span><span class="token function">getFencingToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token comment" spellcheck="true">// do not update acquires</span>
                        <span class="token punctuation">.</span><span class="token function">acquires</span><span class="token punctuation">(</span>prevOwner<span class="token punctuation">.</span><span class="token function">getAcquires</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token comment" spellcheck="true">// set previous ctx</span>
                        <span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span>prevOwner<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token comment" spellcheck="true">// é‡Šæ”¾é”å¤±è´¥</span>
                        <span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ‰§è¡Œå›è°ƒ</span>
            <span class="token function">setSuccess</span><span class="token punctuation">(</span>closure<span class="token punctuation">,</span> owner<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">final</span> Exception e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


        <footer>
             
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

        </footer>
    </div>
    <!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
    <script>
        var timeEnd = new Date();
        console.log('è€—æ—¶ï¼š' + (timeEnd - timeStart));
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre').forEach((block) => {
                block.classList.add("line-numbers");
            });
        });
    </script>
    <!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
    <!-- material design -->
    <!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
    <!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
    <!-- toc -->
    <!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
    <!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
    <!-- <script src="/js/main.js"></script> -->
    <script src="/js/prism.js"></script>
</body>
</html>
