<!DOCTYPE HTML>
<html>

<head>
    <script>
        var timeStart = new Date();
    </script>
    <meta charset="utf-8">
    
    <title>[笔记]-SOFA-JRaft-DistributedLock | Reunion...</title>
    
    <meta name="author" content="huangzhike">
    
    
    <meta name="description"
        content="参考SOFAStack的一篇文章。

分布式锁的条件：

获取锁和释放锁的性能要好；

获得锁是否是原子性的，否则可能导致多个请求都能获取到锁；

网络中断或者宕机无法释放锁时，锁必须被清除；

可重入，本地一个线程中多次获取同一把锁，无需重新获得锁；

阻塞锁和非阻塞锁，阻塞锁即没有获取到锁，则继">
    
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta property="og:title" content="[笔记]-SOFA-JRaft-DistributedLock" />
    
    <meta property="og:site_name" content="Reunion..." />
    
    
    <!-- favicon -->
    <link rel="icon" type="image/ico" href="/logo.ico" sizes="32x32">
    <meta name="msapplication-TileColor" content="#009688">
    <meta name="msapplication-TileImage" content="/mstile-144x144.ico">
    <meta name="theme-color" content="#009688">
    <!-- favicon end -->
    <!-- <link href="//ok.ico" rel="icon"> -->
    

    <!-- <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.5.0/css/bootstrap.min.css" rel="stylesheet"> -->
    <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
    <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
    <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">

<meta name="generator" content="Hexo 4.2.1"></head>
<body>
    <nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">菜单</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" title="早く来い、クラウド" href="/">Reunion...</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" target="_blank" rel="noopener" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

    <div class="container" >
        <div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[笔记]-SOFA-JRaft-DistributedLock</h2>
				
				<div>
					<div class="post-time">2019-11-19</div>
				</div>
				
				<div class="article-content">
				<p><a href="https://www.sofastack.tech/blog/sofa-jraft-rheakv-distributedlock/" target="_blank" rel="noopener">参考SOFAStack的一篇文章</a>。</p>
<hr>
<p>分布式锁的条件：</p>
<ul>
<li><p>获取锁和释放锁的性能要好；</p>
</li>
<li><p>获得锁是否是原子性的，否则可能导致多个请求都能获取到锁；</p>
</li>
<li><p>网络中断或者宕机无法释放锁时，锁必须被清除；</p>
</li>
<li><p>可重入，本地一个线程中多次获取同一把锁，无需重新获得锁；</p>
</li>
<li><p>阻塞锁和非阻塞锁，阻塞锁即没有获取到锁，则继续等待获取锁；非阻塞锁即没有获取到锁，不继续等待直接返回获取锁失败；</p>
</li>
</ul>
<p>分布式锁的三种实现方式：</p>
<ul>
<li><p>基于数据库实现：</p>
<ul>
<li>在数据库中创建一张表，包含方法名等字段，并为方法名字段创建唯一索引，执行某个方法需要使用方法名向表中插入数据，成功插入则获取锁，执行结束则删除对应的行数据释放锁。</li>
</ul>
</li>
<li><p>基于缓存实现：</p>
<ul>
<li><p>以Redis为例，因为单Redis节点的分布式锁在Failover时有安全问题，Redis作者提出了集群模式的Redis分布式锁Redlock算法，基于N个完全独立的Redis节点（通常N可以设置成5）；</p>
</li>
<li><p>客户端发起获取锁操作前，先获取当前时间；</p>
</li>
<li><p>客户端按顺序依次向N个Redis节点获取锁；</p>
<ul>
<li><p>获取操作的参数包含：随机字符串，过期时间（锁的有效时间），获取锁超时（远小于锁的有效时间，使得Redis节点不可用时流程继续进行）；</p>
</li>
<li><p>客户端向某个Redis节点获取锁失败后（包括节点不可用，锁已被持有等），立即尝试下一个Redis节点；</p>
</li>
</ul>
</li>
<li><p>客户端计算整个获取锁的过程总耗时，如果客户端从大多数Redis节点成功获取到了锁，并且获取锁的总耗时没有超过锁的有效时间，那么认为最终获取锁成功；否则认为失败；</p>
<ul>
<li><p>如果最终获取锁成功，此锁的有效时间应该重新计算，它等于最初锁的有效时间减去获取锁过程的总耗时；</p>
</li>
<li><p>如果最终获取锁失败，那么客户端立即向所有Redis节点发起释放锁的操作；</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>基于ZooKeeper实现：</p>
<ul>
<li><p>创建一个锁目录Lock；</p>
</li>
<li><p>期望获得锁的线程A在锁目录下创建临时顺序节点；</p>
</li>
<li><p>当前线程获取锁目录下所有的子节点，然后获取比自己小的兄弟节点，如果不存在，说明当前线程顺序号最小，获得锁；</p>
</li>
<li><p>线程B获取所有节点，判断自己不是最小节点，设置监听比自己次小的节点（只关注比自己次小的节点是为了防止发生羊群效应）；</p>
</li>
<li><p>线程A处理完后，删除自己的节点，线程B监听到变更事件判断自己是否为最小的节点，如果是则获得锁；</p>
</li>
</ul>
</li>
</ul>
<p>Redis的实现有点类似Raft算法，而ZooKeeper的实现则类似AQS的队列。</p>
<hr>
<p>DefaultRheaKVStore#getDistributedLock</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> DistributedLock<span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">></span> <span class="token function">getDistributedLock</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> target<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> lease<span class="token punctuation">,</span> <span class="token keyword">final</span> TimeUnit unit<span class="token punctuation">,</span> <span class="token keyword">final</span> ScheduledExecutorService watchdog<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DefaultDistributedLock</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> lease<span class="token punctuation">,</span> unit<span class="token punctuation">,</span> watchdog<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>DistributedLock</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">protected</span> <span class="token function">DistributedLock</span><span class="token punctuation">(</span>T target<span class="token punctuation">,</span> <span class="token keyword">long</span> lease<span class="token punctuation">,</span> TimeUnit unit<span class="token punctuation">,</span> ScheduledExecutorService watchdog<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// 分布式锁的Key，锁的标识</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>internalKey <span class="token operator">=</span> <span class="token function">withInternalKey</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 锁的获取者</span>
        <span class="token comment" spellcheck="true">// 有一个分布式的唯一标识，其实就是根据IP和时间等生成</span>
        <span class="token comment" spellcheck="true">// 还有一个租约Lease，表示锁的到期时间，如果没有WatchDog，到期锁会被自动释放</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>acquirer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Acquirer</span><span class="token punctuation">(</span>UniqueIdUtil<span class="token punctuation">.</span><span class="token function">generateId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> unit<span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span>lease<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// WatchDog线程池，即自动续租的调度器，定期主动为锁续时，直到用户主动释放锁</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>watchdog <span class="token operator">=</span> watchdog<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>没有获取锁超时</p>
<p>DistributedLock#tryLock</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 只尝试一次，直接返回获取锁是否成功</span>
        <span class="token keyword">return</span> <span class="token function">internalTryLock</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>有获取锁超时</p>
<p>DistributedLock#tryLock</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ctx<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token keyword">final</span> TimeUnit unit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> timeoutNs <span class="token operator">=</span> unit<span class="token punctuation">.</span><span class="token function">toNanos</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> startNs <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> attempts <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 循环重试获取锁</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 尝试获取锁</span>
                <span class="token keyword">final</span> Owner owner <span class="token operator">=</span> <span class="token function">internalTryLock</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 获取成功，直接返回</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>owner<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 获取锁超时，不再尝试</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startNs <span class="token operator">>=</span> timeoutNs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>attempts <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    attempts<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">final</span> <span class="token keyword">long</span> remaining <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> owner<span class="token punctuation">.</span><span class="token function">getRemainingMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 避免活锁</span>
                Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>remaining<span class="token punctuation">,</span> <span class="token number">2</span> <span class="token operator">&lt;&lt;</span> attempts<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">final</span> Throwable t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 获取锁失败</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>DefaultDistributedLock#internalTryLock</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> Owner <span class="token function">internalTryLock</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//</span>
        <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> internalKey <span class="token operator">=</span> <span class="token function">getInternalKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> Acquirer acquirer <span class="token operator">=</span> <span class="token function">getAcquirer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        acquirer<span class="token punctuation">.</span><span class="token function">setContext</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 尝试获取锁</span>
        <span class="token keyword">final</span> CompletableFuture<span class="token operator">&lt;</span>Owner<span class="token operator">></span> future <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rheaKVStore<span class="token punctuation">.</span><span class="token function">tryLockWith</span><span class="token punctuation">(</span>internalKey<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> acquirer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 返回锁的持有者，这里有点容易误解</span>
        <span class="token keyword">final</span> Owner owner <span class="token operator">=</span> FutureHelper<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>future<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 获取锁失败</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>owner<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 更新锁的持有者Owner</span>
            <span class="token function">updateOwner</span><span class="token punctuation">(</span>owner<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> owner<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 获取锁成功，更新Owner和Acquirer，包括FencingToken</span>
        <span class="token function">updateOwnerAndAcquirer</span><span class="token punctuation">(</span>owner<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> ScheduledExecutorService watchdog <span class="token operator">=</span> <span class="token function">getWatchdog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 不需要自动续约，直接返回</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>watchdog <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> owner<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 还没有计划任务</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>watchdogFuture <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// DCL</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>watchdogFuture <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// LeaseMillis / 3 * 2</span>
                    <span class="token keyword">final</span> <span class="token keyword">long</span> period <span class="token operator">=</span> <span class="token punctuation">(</span>acquirer<span class="token punctuation">.</span><span class="token function">getLeaseMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// 线程池自动获取锁续租</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>watchdogFuture <span class="token operator">=</span> <span class="token function">scheduleKeepingLease</span><span class="token punctuation">(</span>watchdog<span class="token punctuation">,</span> internalKey<span class="token punctuation">,</span> acquirer<span class="token punctuation">,</span> period<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 返回</span>
        <span class="token keyword">return</span> owner<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>DefaultRheaKVStore#tryLockWith</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> CompletableFuture<span class="token operator">&lt;</span>DistributedLock<span class="token punctuation">.</span>Owner<span class="token operator">></span> <span class="token function">tryLockWith</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> keepLease<span class="token punctuation">,</span> <span class="token keyword">final</span> DistributedLock<span class="token punctuation">.</span>Acquirer acquirer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">checkState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Requires<span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token string">"key"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> CompletableFuture<span class="token operator">&lt;</span>DistributedLock<span class="token punctuation">.</span>Owner<span class="token operator">></span> future <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CompletableFuture</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">internalTryLockWith</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> keepLease<span class="token punctuation">,</span> acquirer<span class="token punctuation">,</span> future<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>failoverRetries<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> future<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>DefaultRheaKVStore#internalTryLockWith</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">internalTryLockWith</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> keepLease<span class="token punctuation">,</span> <span class="token keyword">final</span> DistributedLock<span class="token punctuation">.</span>Acquirer acquirer<span class="token punctuation">,</span> <span class="token keyword">final</span> CompletableFuture<span class="token operator">&lt;</span>DistributedLock<span class="token punctuation">.</span>Owner<span class="token operator">></span> future<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> retriesLeft<span class="token punctuation">,</span> <span class="token keyword">final</span> Errors lastCause<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 根据Key从路由表查找对应的Region</span>
        <span class="token keyword">final</span> Region region <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pdClient<span class="token punctuation">.</span><span class="token function">findRegionByKey</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> ErrorsHelper<span class="token punctuation">.</span><span class="token function">isInvalidEpoch</span><span class="token punctuation">(</span>lastCause<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 对于Client，直接返回null</span>
        <span class="token comment" spellcheck="true">// 对于Server，根据RegionId返回本地的Region的RegionEngine，如果不是Leader，返回null</span>
        <span class="token keyword">final</span> RegionEngine regionEngine <span class="token operator">=</span> <span class="token function">getRegionEngine</span><span class="token punctuation">(</span>region<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 重试方法</span>
        <span class="token keyword">final</span> RetryRunner retryRunner <span class="token operator">=</span> retryCause <span class="token operator">-</span><span class="token operator">></span> <span class="token function">internalTryLockWith</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> keepLease<span class="token punctuation">,</span> acquirer<span class="token punctuation">,</span> future<span class="token punctuation">,</span> retriesLeft <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> retryCause<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 失败回调</span>
        <span class="token keyword">final</span> FailoverClosure<span class="token operator">&lt;</span>DistributedLock<span class="token punctuation">.</span>Owner<span class="token operator">></span> closure <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FailoverClosureImpl</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>future<span class="token punctuation">,</span> retriesLeft<span class="token punctuation">,</span> retryRunner<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Leader节点在本地</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>regionEngine <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ensureOnValidEpoch</span><span class="token punctuation">(</span>region<span class="token punctuation">,</span> regionEngine<span class="token punctuation">,</span> closure<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 本地直接执行</span>
                <span class="token function">getRawKVStore</span><span class="token punctuation">(</span>regionEngine<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">tryLockWith</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> region<span class="token punctuation">.</span><span class="token function">getStartKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> keepLease<span class="token punctuation">,</span> acquirer<span class="token punctuation">,</span> closure<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> KeyLockRequest request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KeyLockRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            request<span class="token punctuation">.</span><span class="token function">setKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            request<span class="token punctuation">.</span><span class="token function">setKeepLease</span><span class="token punctuation">(</span>keepLease<span class="token punctuation">)</span><span class="token punctuation">;</span>
            request<span class="token punctuation">.</span><span class="token function">setAcquirer</span><span class="token punctuation">(</span>acquirer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            request<span class="token punctuation">.</span><span class="token function">setRegionId</span><span class="token punctuation">(</span>region<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            request<span class="token punctuation">.</span><span class="token function">setRegionEpoch</span><span class="token punctuation">(</span>region<span class="token punctuation">.</span><span class="token function">getRegionEpoch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// RPC向Leader调用</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>rheaKVRpcService<span class="token punctuation">.</span><span class="token function">callAsyncWithRpc</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> closure<span class="token punctuation">,</span> lastCause<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>DefaultRheaKVRpcService#callAsyncWithRpc</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token operator">&lt;</span>V<span class="token operator">></span> CompletableFuture<span class="token operator">&lt;</span>V<span class="token operator">></span> <span class="token function">callAsyncWithRpc</span><span class="token punctuation">(</span><span class="token keyword">final</span> BaseRequest request<span class="token punctuation">,</span> <span class="token keyword">final</span> FailoverClosure<span class="token operator">&lt;</span>V<span class="token operator">></span> closure<span class="token punctuation">,</span> <span class="token keyword">final</span> Errors lastCause<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> requireLeader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> forceRefresh <span class="token operator">=</span> ErrorsHelper<span class="token punctuation">.</span><span class="token function">isInvalidPeer</span><span class="token punctuation">(</span>lastCause<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 根据RegionId和是否需要Leader返回端点</span>
        <span class="token keyword">final</span> Endpoint endpoint <span class="token operator">=</span> <span class="token function">getRpcEndpoint</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getRegionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> forceRefresh<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rpcTimeoutMillis<span class="token punctuation">,</span> requireLeader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 执行RPC</span>
        <span class="token function">internalCallAsyncWithRpc</span><span class="token punctuation">(</span>endpoint<span class="token punctuation">,</span> request<span class="token punctuation">,</span> closure<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> closure<span class="token punctuation">.</span><span class="token function">future</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>KVCommandProcessor#handleRequest</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleRequest</span><span class="token punctuation">(</span><span class="token keyword">final</span> BizContext bizCtx<span class="token punctuation">,</span> <span class="token keyword">final</span> AsyncContext asyncCtx<span class="token punctuation">,</span> <span class="token keyword">final</span> T request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// 回调</span>
        <span class="token keyword">final</span> RequestProcessClosure<span class="token operator">&lt;</span>BaseRequest<span class="token punctuation">,</span> BaseResponse<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>></span> closure <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RequestProcessClosure</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> bizCtx<span class="token punctuation">,</span> asyncCtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 根据RegionId获取对应的RegionKVService</span>
        <span class="token keyword">final</span> RegionKVService regionKVService <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>storeEngine<span class="token punctuation">.</span><span class="token function">getRegionKVService</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getRegionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>regionKVService <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> NoRegionFoundResponse noRegion <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NoRegionFoundResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            noRegion<span class="token punctuation">.</span><span class="token function">setRegionId</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getRegionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            noRegion<span class="token punctuation">.</span><span class="token function">setError</span><span class="token punctuation">(</span>Errors<span class="token punctuation">.</span>NO_REGION_FOUND<span class="token punctuation">)</span><span class="token punctuation">;</span>
            noRegion<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            closure<span class="token punctuation">.</span><span class="token function">sendResponse</span><span class="token punctuation">(</span>noRegion<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">magic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> BaseRequest<span class="token punctuation">.</span>PUT<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> BaseRequest<span class="token punctuation">.</span>BATCH_PUT<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> BaseRequest<span class="token punctuation">.</span>PUT_IF_ABSENT<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> BaseRequest<span class="token punctuation">.</span>GET_PUT<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> BaseRequest<span class="token punctuation">.</span>COMPARE_PUT<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> BaseRequest<span class="token punctuation">.</span>DELETE<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> BaseRequest<span class="token punctuation">.</span>DELETE_RANGE<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> BaseRequest<span class="token punctuation">.</span>BATCH_DELETE<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> BaseRequest<span class="token punctuation">.</span>MERGE<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> BaseRequest<span class="token punctuation">.</span>GET<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> BaseRequest<span class="token punctuation">.</span>MULTI_GET<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> BaseRequest<span class="token punctuation">.</span>SCAN<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> BaseRequest<span class="token punctuation">.</span>GET_SEQUENCE<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> BaseRequest<span class="token punctuation">.</span>RESET_SEQUENCE<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> BaseRequest<span class="token punctuation">.</span>KEY_LOCK<span class="token operator">:</span>
                regionKVService<span class="token punctuation">.</span><span class="token function">handleKeyLockRequest</span><span class="token punctuation">(</span><span class="token punctuation">(</span>KeyLockRequest<span class="token punctuation">)</span> request<span class="token punctuation">,</span> closure<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> BaseRequest<span class="token punctuation">.</span>KEY_UNLOCK<span class="token operator">:</span>
                regionKVService<span class="token punctuation">.</span><span class="token function">handleKeyUnlockRequest</span><span class="token punctuation">(</span><span class="token punctuation">(</span>KeyUnlockRequest<span class="token punctuation">)</span> request<span class="token punctuation">,</span> closure<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> BaseRequest<span class="token punctuation">.</span>NODE_EXECUTE<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> BaseRequest<span class="token punctuation">.</span>RANGE_SPLIT<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>Leader收到获取锁请求</p>
<p>DefaultRegionKVService#handleKeyLockRequest</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleKeyLockRequest</span><span class="token punctuation">(</span><span class="token keyword">final</span> KeyLockRequest request<span class="token punctuation">,</span> <span class="token keyword">final</span> RequestProcessClosure<span class="token operator">&lt;</span>BaseRequest<span class="token punctuation">,</span> BaseResponse<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>></span> closure<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> KeyLockResponse response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KeyLockResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setRegionId</span><span class="token punctuation">(</span><span class="token function">getRegionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setRegionEpoch</span><span class="token punctuation">(</span><span class="token function">getRegionEpoch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            KVParameterRequires<span class="token punctuation">.</span><span class="token function">requireSameEpoch</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token function">getRegionEpoch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key <span class="token operator">=</span> KVParameterRequires<span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"lock.key"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// FencingKey为Region的左端点</span>
            <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fencingKey <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>regionEngine<span class="token punctuation">.</span><span class="token function">getRegion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStartKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 从请求获取Acquirer</span>
            <span class="token keyword">final</span> DistributedLock<span class="token punctuation">.</span>Acquirer acquirer <span class="token operator">=</span> KVParameterRequires<span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getAcquirer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"lock.acquirer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// 尝试获取锁</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>rawKVStore<span class="token punctuation">.</span><span class="token function">tryLockWith</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> fencingKey<span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">isKeepLease</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> acquirer<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">BaseKVStoreClosure</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">final</span> Status status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 日志成功提交</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">.</span><span class="token function">isOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        response<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span><span class="token punctuation">(</span>DistributedLock<span class="token punctuation">.</span>Owner<span class="token punctuation">)</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token function">setFailure</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> status<span class="token punctuation">,</span> <span class="token function">getError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    closure<span class="token punctuation">.</span><span class="token function">sendResponse</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">final</span> Throwable t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>RaftRawKVStore#tryLockWith</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">tryLockWith</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fencingKey<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> keepLease<span class="token punctuation">,</span> <span class="token keyword">final</span> DistributedLock<span class="token punctuation">.</span>Acquirer acquirer<span class="token punctuation">,</span> <span class="token keyword">final</span> KVStoreClosure closure<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">/*
         * 算法依赖于以下假设：尽管跨进程存在非同步时钟，但每个进程中的本地时间仍以大致相同的速率流动，并且与锁的自动释放时间相比其错误较小
         */</span>
        <span class="token comment" spellcheck="true">// 设置锁获取器Acquirer的锁时间戳</span>
        acquirer<span class="token punctuation">.</span><span class="token function">setLockingTimestamp</span><span class="token punctuation">(</span>Clock<span class="token punctuation">.</span><span class="token function">defaultClock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 发布日志到所有Follower节点</span>
        <span class="token function">applyOperation</span><span class="token punctuation">(</span>KVOperation<span class="token punctuation">.</span><span class="token function">createKeyLockRequest</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> fencingKey<span class="token punctuation">,</span> Pair<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>keepLease<span class="token punctuation">,</span> acquirer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> closure<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>RaftRawKVStore#applyOperation</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">applyOperation</span><span class="token punctuation">(</span><span class="token keyword">final</span> KVOperation op<span class="token punctuation">,</span> <span class="token keyword">final</span> KVStoreClosure closure<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 必须保证当前操作的节点是Leader</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 创建任务</span>
        <span class="token keyword">final</span> Task task <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        task<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>ByteBuffer<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>Serializers<span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        task<span class="token punctuation">.</span><span class="token function">setDone</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">KVClosureAdapter</span><span class="token punctuation">(</span>closure<span class="token punctuation">,</span> op<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 发布日志</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>node<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>略过Raft的流程处理，当Leader收到大多数Follower节点的响应，并应用状态机的时候</p>
<p>KVStoreStateMachine#onApply</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onApply</span><span class="token punctuation">(</span><span class="token keyword">final</span> Iterator it<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> applied <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// KVState输出列表，虽然有个newInstance，其实是从对象池拿</span>
            KVStateOutputList kvStates <span class="token operator">=</span> KVStateOutputList<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                KVOperation kvOp<span class="token punctuation">;</span>
                <span class="token keyword">final</span> KVClosureAdapter done <span class="token operator">=</span> <span class="token punctuation">(</span>KVClosureAdapter<span class="token punctuation">)</span> it<span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// Leader节点有回调</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>done <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 直接获取KVOperation</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 说明是Follower，回调不会被序列化</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 反序列化KVOperation</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">final</span> KVState first <span class="token operator">=</span> kvStates<span class="token punctuation">.</span><span class="token function">getFirstElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 没看懂这些操作的意图</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>first <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>first<span class="token punctuation">.</span><span class="token function">isSameOp</span><span class="token punctuation">(</span>kvOp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    applied <span class="token operator">+=</span> <span class="token function">batchApplyAndRecycle</span><span class="token punctuation">(</span>first<span class="token punctuation">.</span><span class="token function">getOpByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kvStates<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    kvStates <span class="token operator">=</span> KVStateOutputList<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 将KVOperation和回调包装为KVState加入</span>
                kvStates<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>KVState<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>kvOp<span class="token punctuation">,</span> done<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">++</span>index<span class="token punctuation">;</span>
                it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>kvStates<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> KVState first <span class="token operator">=</span> kvStates<span class="token punctuation">.</span><span class="token function">getFirstElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">assert</span> first <span class="token operator">!=</span> null<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 执行</span>
                applied <span class="token operator">+=</span> <span class="token function">batchApplyAndRecycle</span><span class="token punctuation">(</span>first<span class="token punctuation">.</span><span class="token function">getOpByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kvStates<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">final</span> Throwable t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>KVStoreStateMachine#batchApplyAndRecycle</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">batchApplyAndRecycle</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">byte</span> opByte<span class="token punctuation">,</span> <span class="token keyword">final</span> KVStateOutputList kvStates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> size <span class="token operator">=</span> kvStates<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token function">batchApply</span><span class="token punctuation">(</span>opByte<span class="token punctuation">,</span> kvStates<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> size<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            RecycleUtil<span class="token punctuation">.</span><span class="token function">recycle</span><span class="token punctuation">(</span>kvStates<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>KVStoreStateMachine#batchApply</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">batchApply</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">byte</span> opType<span class="token punctuation">,</span> <span class="token keyword">final</span> KVStateOutputList kvStates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>opType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> KVOperation<span class="token punctuation">.</span>PUT<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> KVOperation<span class="token punctuation">.</span>PUT_IF_ABSENT<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> KVOperation<span class="token punctuation">.</span>PUT_LIST<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> KVOperation<span class="token punctuation">.</span>DELETE<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> KVOperation<span class="token punctuation">.</span>DELETE_RANGE<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> KVOperation<span class="token punctuation">.</span>DELETE_LIST<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> KVOperation<span class="token punctuation">.</span>GET_SEQUENCE<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> KVOperation<span class="token punctuation">.</span>NODE_EXECUTE<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> KVOperation<span class="token punctuation">.</span>KEY_LOCK<span class="token operator">:</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>rawKVStore<span class="token punctuation">.</span><span class="token function">batchTryLockWith</span><span class="token punctuation">(</span>kvStates<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> KVOperation<span class="token punctuation">.</span>KEY_LOCK_RELEASE<span class="token operator">:</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>rawKVStore<span class="token punctuation">.</span><span class="token function">batchReleaseLockWith</span><span class="token punctuation">(</span>kvStates<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> KVOperation<span class="token punctuation">.</span>GET<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> KVOperation<span class="token punctuation">.</span>MULTI_GET<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> KVOperation<span class="token punctuation">.</span>SCAN<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> KVOperation<span class="token punctuation">.</span>GET_PUT<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> KVOperation<span class="token punctuation">.</span>COMPARE_PUT<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> KVOperation<span class="token punctuation">.</span>MERGE<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> KVOperation<span class="token punctuation">.</span>RESET_SEQUENCE<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">case</span> KVOperation<span class="token punctuation">.</span>RANGE_SPLIT<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>BatchRawKVStore#batchTryLockWith</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">batchTryLockWith</span><span class="token punctuation">(</span><span class="token keyword">final</span> KVStateOutputList kvStates<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> kvStates<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> KVState kvState <span class="token operator">=</span> kvStates<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> KVOperation op <span class="token operator">=</span> kvState<span class="token punctuation">.</span><span class="token function">getOp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> Pair<span class="token operator">&lt;</span>Boolean<span class="token punctuation">,</span> DistributedLock<span class="token punctuation">.</span>Acquirer<span class="token operator">></span> acquirerPair <span class="token operator">=</span> op<span class="token punctuation">.</span><span class="token function">getAcquirerPair</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">tryLockWith</span><span class="token punctuation">(</span>op<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> op<span class="token punctuation">.</span><span class="token function">getFencingKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> acquirerPair<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> acquirerPair<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kvState<span class="token punctuation">.</span><span class="token function">getDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>以MemoryRawKVStore为例</p>
<p>MemoryRawKVStore#tryLockWith</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">tryLockWith</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fencingKey<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> keepLease<span class="token punctuation">,</span> <span class="token keyword">final</span> DistributedLock<span class="token punctuation">.</span>Acquirer acquirer<span class="token punctuation">,</span> <span class="token keyword">final</span> KVStoreClosure closure<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// The algorithm relies on the assumption that while there is no synchronized clock across the processes,</span>
            <span class="token comment" spellcheck="true">// still the local time in every process flows approximately at the same rate,</span>
            <span class="token comment" spellcheck="true">// with an error which is small compared to the auto-release time of the lock.</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> now <span class="token operator">=</span> acquirer<span class="token punctuation">.</span><span class="token function">getLockingTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> timeoutMillis <span class="token operator">=</span> acquirer<span class="token punctuation">.</span><span class="token function">getLeaseMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> ByteArray wrappedKey <span class="token operator">=</span> ByteArray<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 获取该锁的上一个持有者</span>
            <span class="token keyword">final</span> DistributedLock<span class="token punctuation">.</span>Owner prevOwner <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lockerDB<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>wrappedKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 本次尝试获取锁的对象</span>
            <span class="token keyword">final</span> DistributedLock<span class="token punctuation">.</span>Owner owner<span class="token punctuation">;</span>
            <span class="token keyword">do</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> DistributedLock<span class="token punctuation">.</span>OwnerBuilder builder <span class="token operator">=</span> DistributedLock<span class="token punctuation">.</span><span class="token function">newOwnerBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 锁还没被获得，空闲</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>prevOwner <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 是否自动续约，只有通过WatchDog线程池的计划任务执行时才是</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>keepLease<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 想自动续约但是已经晚了，锁已经被释放</span>
                        owner <span class="token operator">=</span> builder <span class="token comment" spellcheck="true">//</span>
                                <span class="token comment" spellcheck="true">// set acquirer id</span>
                                <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>acquirer<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token comment" spellcheck="true">// fail to keep lease</span>
                                <span class="token punctuation">.</span><span class="token function">remainingMillis</span><span class="token punctuation">(</span>DistributedLock<span class="token punctuation">.</span>OwnerBuilder<span class="token punctuation">.</span>KEEP_LEASE_FAIL<span class="token punctuation">)</span>
                                <span class="token comment" spellcheck="true">// 获取锁失败</span>
                                <span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// 第一次获取锁，或者之前的锁已经被释放</span>
                    owner <span class="token operator">=</span> builder <span class="token comment" spellcheck="true">//</span>
                            <span class="token comment" spellcheck="true">// 设置锁的持有者的Id</span>
                            <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>acquirer<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token comment" spellcheck="true">// 截止时间为Leader尝试执行获取锁操作的时间加上租约时间</span>
                            <span class="token punctuation">.</span><span class="token function">deadlineMillis</span><span class="token punctuation">(</span>now <span class="token operator">+</span> timeoutMillis<span class="token punctuation">)</span>
                            <span class="token comment" spellcheck="true">// first time to acquire and success</span>
                            <span class="token punctuation">.</span><span class="token function">remainingMillis</span><span class="token punctuation">(</span>DistributedLock<span class="token punctuation">.</span>OwnerBuilder<span class="token punctuation">.</span>FIRST_TIME_SUCCESS<span class="token punctuation">)</span>
                            <span class="token comment" spellcheck="true">// 生成一个新的FencingToken</span>
                            <span class="token punctuation">.</span><span class="token function">fencingToken</span><span class="token punctuation">(</span><span class="token function">getNextFencingToken</span><span class="token punctuation">(</span>fencingKey<span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token comment" spellcheck="true">// 第一次获取，重入次数为1</span>
                            <span class="token punctuation">.</span><span class="token function">acquires</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
                            <span class="token comment" spellcheck="true">// 设置Acquirer的上下文</span>
                            <span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span>acquirer<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token comment" spellcheck="true">// 获取锁成功</span>
                            <span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// 存入</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>lockerDB<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>wrappedKey<span class="token punctuation">,</span> owner<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 如果锁已经有了持有者，检查是否已经过期，用上一个锁的截止日期减去获取当前的锁操作的开始时间</span>
                <span class="token keyword">final</span> <span class="token keyword">long</span> remainingMillis <span class="token operator">=</span> prevOwner<span class="token punctuation">.</span><span class="token function">getDeadlineMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> now<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 锁已过期</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>remainingMillis <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 是否自动续约</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>keepLease<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 想自动续约但是已经晚了，锁已经过期</span>
                        owner <span class="token operator">=</span> builder <span class="token comment" spellcheck="true">//</span>
                                <span class="token comment" spellcheck="true">// still previous owner id</span>
                                <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>prevOwner<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token comment" spellcheck="true">// do not update</span>
                                <span class="token punctuation">.</span><span class="token function">deadlineMillis</span><span class="token punctuation">(</span>prevOwner<span class="token punctuation">.</span><span class="token function">getDeadlineMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token comment" spellcheck="true">// fail to keep lease</span>
                                <span class="token punctuation">.</span><span class="token function">remainingMillis</span><span class="token punctuation">(</span>DistributedLock<span class="token punctuation">.</span>OwnerBuilder<span class="token punctuation">.</span>KEEP_LEASE_FAIL<span class="token punctuation">)</span>
                                <span class="token comment" spellcheck="true">// set previous ctx</span>
                                <span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span>prevOwner<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token comment" spellcheck="true">// 获取锁失败</span>
                                <span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// 创建新的锁持有者</span>
                    owner <span class="token operator">=</span> builder <span class="token comment" spellcheck="true">//</span>
                            <span class="token comment" spellcheck="true">// set acquirer id, now it will own the lock</span>
                            <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>acquirer<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token comment" spellcheck="true">// set a new deadline</span>
                            <span class="token punctuation">.</span><span class="token function">deadlineMillis</span><span class="token punctuation">(</span>now <span class="token operator">+</span> timeoutMillis<span class="token punctuation">)</span>
                            <span class="token comment" spellcheck="true">// success as a new acquirer</span>
                            <span class="token punctuation">.</span><span class="token function">remainingMillis</span><span class="token punctuation">(</span>DistributedLock<span class="token punctuation">.</span>OwnerBuilder<span class="token punctuation">.</span>NEW_ACQUIRE_SUCCESS<span class="token punctuation">)</span>
                            <span class="token comment" spellcheck="true">// create a new fencing token</span>
                            <span class="token punctuation">.</span><span class="token function">fencingToken</span><span class="token punctuation">(</span><span class="token function">getNextFencingToken</span><span class="token punctuation">(</span>fencingKey<span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token comment" spellcheck="true">// init acquires</span>
                            <span class="token punctuation">.</span><span class="token function">acquires</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
                            <span class="token comment" spellcheck="true">// set acquirer ctx</span>
                            <span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span>acquirer<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token comment" spellcheck="true">// 获取锁成功</span>
                            <span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// 存入</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>lockerDB<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>wrappedKey<span class="token punctuation">,</span> owner<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 原本的锁持有者还没过期，根据Acquirer的Id和FencingToken判断，如果是同一个，则是重入</span>
                <span class="token keyword">final</span> <span class="token keyword">boolean</span> isReentrant <span class="token operator">=</span> prevOwner<span class="token punctuation">.</span><span class="token function">isSameAcquirer</span><span class="token punctuation">(</span>acquirer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 重入</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>isReentrant<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 来自自动续约线程</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>keepLease<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        owner <span class="token operator">=</span> builder <span class="token comment" spellcheck="true">//</span>
                                <span class="token comment" spellcheck="true">// 保持不变</span>
                                <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>prevOwner<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token comment" spellcheck="true">// 更新锁的截止日期</span>
                                <span class="token punctuation">.</span><span class="token function">deadlineMillis</span><span class="token punctuation">(</span>now <span class="token operator">+</span> timeoutMillis<span class="token punctuation">)</span>
                                <span class="token comment" spellcheck="true">// success to keep lease</span>
                                <span class="token punctuation">.</span><span class="token function">remainingMillis</span><span class="token punctuation">(</span>DistributedLock<span class="token punctuation">.</span>OwnerBuilder<span class="token punctuation">.</span>KEEP_LEASE_SUCCESS<span class="token punctuation">)</span>
                                <span class="token comment" spellcheck="true">// 保持不变</span>
                                <span class="token punctuation">.</span><span class="token function">fencingToken</span><span class="token punctuation">(</span>prevOwner<span class="token punctuation">.</span><span class="token function">getFencingToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token comment" spellcheck="true">// 保持不变</span>
                                <span class="token punctuation">.</span><span class="token function">acquires</span><span class="token punctuation">(</span>prevOwner<span class="token punctuation">.</span><span class="token function">getAcquires</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token comment" spellcheck="true">// 保持不变</span>
                                <span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span>prevOwner<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token comment" spellcheck="true">// 获取锁成功</span>
                                <span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// 更新</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>lockerDB<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>wrappedKey<span class="token punctuation">,</span> owner<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// 重入锁</span>
                    owner <span class="token operator">=</span> builder <span class="token comment" spellcheck="true">//</span>
                            <span class="token comment" spellcheck="true">// 保持不变</span>
                            <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>prevOwner<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token comment" spellcheck="true">// 顺便也会更新锁的截止日期</span>
                            <span class="token punctuation">.</span><span class="token function">deadlineMillis</span><span class="token punctuation">(</span>now <span class="token operator">+</span> timeoutMillis<span class="token punctuation">)</span>
                            <span class="token comment" spellcheck="true">// success reentrant</span>
                            <span class="token punctuation">.</span><span class="token function">remainingMillis</span><span class="token punctuation">(</span>DistributedLock<span class="token punctuation">.</span>OwnerBuilder<span class="token punctuation">.</span>REENTRANT_SUCCESS<span class="token punctuation">)</span>
                            <span class="token comment" spellcheck="true">// 保持不变</span>
                            <span class="token punctuation">.</span><span class="token function">fencingToken</span><span class="token punctuation">(</span>prevOwner<span class="token punctuation">.</span><span class="token function">getFencingToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token comment" spellcheck="true">// 重入次数自增</span>
                            <span class="token punctuation">.</span><span class="token function">acquires</span><span class="token punctuation">(</span>prevOwner<span class="token punctuation">.</span><span class="token function">getAcquires</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
                            <span class="token comment" spellcheck="true">// 重入的时候需要更新Acquirer上下文</span>
                            <span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span>acquirer<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token comment" spellcheck="true">// 获取锁成功</span>
                            <span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// 更新</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>lockerDB<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>wrappedKey<span class="token punctuation">,</span> owner<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 锁已被获取，但是不是重入</span>
                owner <span class="token operator">=</span> builder <span class="token comment" spellcheck="true">//</span>
                        <span class="token comment" spellcheck="true">// set previous owner id to tell who is the real owner</span>
                        <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>prevOwner<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token comment" spellcheck="true">// set the remaining lease time of current owner</span>
                        <span class="token punctuation">.</span><span class="token function">remainingMillis</span><span class="token punctuation">(</span>remainingMillis<span class="token punctuation">)</span>
                        <span class="token comment" spellcheck="true">// set previous ctx</span>
                        <span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span>prevOwner<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token comment" spellcheck="true">// 获取锁失败</span>
                        <span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// 执行成功回调</span>
            <span class="token function">setSuccess</span><span class="token punctuation">(</span>closure<span class="token punctuation">,</span> owner<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">final</span> Exception e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>关于FencingToken，FencingToken是一个单调递增的Long类型，标明锁的持有者的先后顺序。</p>
<p>按照官方的说法，假如ClientA获取锁后发生了很长的GC，这段时间内没有自动续租，并且锁过期了，然后ClientB获取了该锁，在ClientA从GC中恢复后，它不知道自己的锁已经失效了，锁就会同时被两个Client持有。</p>
<p>不过，这个和FencingToken有啥关系呢，难道是需要加一个判断，FencingToken代表的锁执行后，小于该FencingToken的锁就无效？</p>
<hr>
<p>DefaultDistributedLock#unlock</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> internalKey <span class="token operator">=</span> <span class="token function">getInternalKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> Acquirer acquirer <span class="token operator">=</span> <span class="token function">getAcquirer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 释放锁，返回锁的Owner</span>
            <span class="token keyword">final</span> Owner owner <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rheaKVStore<span class="token punctuation">.</span><span class="token function">releaseLockWith</span><span class="token punctuation">(</span>internalKey<span class="token punctuation">,</span> acquirer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 更新Owner</span>
            <span class="token function">updateOwner</span><span class="token punctuation">(</span>owner<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 释放一个不属于自己的锁</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>owner<span class="token punctuation">.</span><span class="token function">isSameAcquirer</span><span class="token punctuation">(</span>acquirer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 重入的锁全部释放完</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>owner<span class="token punctuation">.</span><span class="token function">getAcquires</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 取消WatchDog任务</span>
                <span class="token function">tryCancelScheduling</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">final</span> InvalidLockAcquirerException e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">final</span> Throwable t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>MemoryRawKVStore#releaseLockWith</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">releaseLockWith</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key<span class="token punctuation">,</span> <span class="token keyword">final</span> DistributedLock<span class="token punctuation">.</span>Acquirer acquirer<span class="token punctuation">,</span> <span class="token keyword">final</span> KVStoreClosure closure<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> ByteArray wrappedKey <span class="token operator">=</span> ByteArray<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 锁原本的持有者</span>
            <span class="token keyword">final</span> DistributedLock<span class="token punctuation">.</span>Owner prevOwner <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lockerDB<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>wrappedKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> DistributedLock<span class="token punctuation">.</span>Owner owner<span class="token punctuation">;</span>
            <span class="token keyword">do</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> DistributedLock<span class="token punctuation">.</span>OwnerBuilder builder <span class="token operator">=</span> DistributedLock<span class="token punctuation">.</span><span class="token function">newOwnerBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 释放锁，但是锁已经没有持有者了，可能是因为过期，被别人获取又释放了，或者是重复的释放请求</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>prevOwner <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    owner <span class="token operator">=</span> builder <span class="token comment" spellcheck="true">//</span>
                            <span class="token comment" spellcheck="true">// 那你就是持有者了</span>
                            <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>acquirer<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token comment" spellcheck="true">// set acquirer fencing token</span>
                            <span class="token punctuation">.</span><span class="token function">fencingToken</span><span class="token punctuation">(</span>acquirer<span class="token punctuation">.</span><span class="token function">getFencingToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token comment" spellcheck="true">// 没有被获取</span>
                            <span class="token punctuation">.</span><span class="token function">acquires</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
                            <span class="token comment" spellcheck="true">// 释放锁成功</span>
                            <span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 释放锁的就是原本锁的持有者</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>prevOwner<span class="token punctuation">.</span><span class="token function">isSameAcquirer</span><span class="token punctuation">(</span>acquirer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 重入次数自减</span>
                    <span class="token keyword">final</span> <span class="token keyword">long</span> acquires <span class="token operator">=</span> prevOwner<span class="token punctuation">.</span><span class="token function">getAcquires</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
                    owner <span class="token operator">=</span> builder <span class="token comment" spellcheck="true">//</span>
                            <span class="token comment" spellcheck="true">// 维持不变</span>
                            <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>prevOwner<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token comment" spellcheck="true">// 维持不变</span>
                            <span class="token punctuation">.</span><span class="token function">deadlineMillis</span><span class="token punctuation">(</span>prevOwner<span class="token punctuation">.</span><span class="token function">getDeadlineMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token comment" spellcheck="true">// 维持不变</span>
                            <span class="token punctuation">.</span><span class="token function">fencingToken</span><span class="token punctuation">(</span>prevOwner<span class="token punctuation">.</span><span class="token function">getFencingToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token comment" spellcheck="true">// 更新重入次数</span>
                            <span class="token punctuation">.</span><span class="token function">acquires</span><span class="token punctuation">(</span>acquires<span class="token punctuation">)</span>
                            <span class="token comment" spellcheck="true">// 维持不变</span>
                            <span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span>prevOwner<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token comment" spellcheck="true">// 释放锁成功</span>
                            <span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// 所有的重入都已被释放</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>acquires <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 可以删除了</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>lockerDB<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>wrappedKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 更新</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>lockerDB<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>wrappedKey<span class="token punctuation">,</span> owner<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 释放锁的和持有锁的不一致，不能释放锁</span>
                owner <span class="token operator">=</span> builder <span class="token comment" spellcheck="true">//</span>
                        <span class="token comment" spellcheck="true">// set previous owner id to tell who is the real owner</span>
                        <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span>prevOwner<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token comment" spellcheck="true">// keep previous fencing token</span>
                        <span class="token punctuation">.</span><span class="token function">fencingToken</span><span class="token punctuation">(</span>prevOwner<span class="token punctuation">.</span><span class="token function">getFencingToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token comment" spellcheck="true">// do not update acquires</span>
                        <span class="token punctuation">.</span><span class="token function">acquires</span><span class="token punctuation">(</span>prevOwner<span class="token punctuation">.</span><span class="token function">getAcquires</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token comment" spellcheck="true">// set previous ctx</span>
                        <span class="token punctuation">.</span><span class="token function">context</span><span class="token punctuation">(</span>prevOwner<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token comment" spellcheck="true">// 释放锁失败</span>
                        <span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 执行回调</span>
            <span class="token function">setSuccess</span><span class="token punctuation">(</span>closure<span class="token punctuation">,</span> owner<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">final</span> Exception e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


        <footer>
             
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

        </footer>
    </div>
    <!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
    <script>
        var timeEnd = new Date();
        console.log('耗时：' + (timeEnd - timeStart));
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre').forEach((block) => {
                block.classList.add("line-numbers");
            });
        });
    </script>

    <script src="/js/prism.js"></script>
</body>
</html>
