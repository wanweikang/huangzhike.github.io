<!DOCTYPE HTML>
<html>

<head>
    <script>
        var timeStart = new Date();
    </script>
    <meta charset="utf-8">
    
    <title>[笔记]-Spring Framework-AOP | 草木禾</title>
    
    <meta name="author" content="huangzhike">
    
    
    <meta name="description"
        content="Spring的AOP：

运行时通过动态代理织入，基于CGLIB或JDK动态代理实现，AspectJ风格，如果需要实现AspectJ的AOP，需要另外的操作。


AspectJ的AOP：

编译时织入：利用ajc编译器替代javac编译器，直接将源文件(.java或.aspect)编译成.clas">
    
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta property="og:title" content="[笔记]-Spring Framework-AOP" />
    
    <meta property="og:site_name" content="草木禾" />
    
    
    <!-- favicon -->
    <link rel="icon" type="image/ico" href="/logo.ico" sizes="32x32">
    <meta name="msapplication-TileColor" content="#009688">
    <meta name="msapplication-TileImage" content="/mstile-144x144.ico">
    <meta name="theme-color" content="#009688">
    <!-- favicon end -->
    <!-- <link href="//ok.ico" rel="icon"> -->
    

    <!-- <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.5.0/css/bootstrap.min.css" rel="stylesheet"> -->
    <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
    <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
    <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">

<meta name="generator" content="Hexo 4.2.1"></head>
<body>
    <nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">菜单</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" title="早く来い、クラウド" href="/">Reunion...</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" target="_blank" rel="noopener" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

    <div class="container" >
        <div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[笔记]-Spring Framework-AOP</h2>
				
				<div>
					<div class="post-time">2019-08-09</div>
				</div>
				
				<div class="article-content">
				<ul>
<li><p>Spring的AOP：</p>
<ul>
<li>运行时通过动态代理织入，基于CGLIB或JDK动态代理实现，AspectJ风格，如果需要实现AspectJ的AOP，需要另外的操作。</li>
</ul>
</li>
<li><p>AspectJ的AOP：</p>
<ul>
<li><p>编译时织入：利用ajc编译器替代javac编译器，直接将源文件(.java或.aspect)编译成.class文件并织入。</p>
</li>
<li><p>编译后织入：利用ajc编译器向javac编译期编译后的.class文件或.jar文件织入。</p>
</li>
<li><p>加载时织入：不使用ajc编译器，利用aspectjweaver.jar，在类加载期织入。</p>
</li>
</ul>
</li>
</ul>
<p>简单来说就是Spring的AOP是运行时织入，基于代理，性能相对较低，而AspectJ的AOP可以在编译时织入，基于字节码操作，性能高一些。</p>
<hr>
<ul>
<li>Xml：<code>&lt;aop:aspectj-autoproxy/&gt;</code></li>
</ul>
<p>AopNamespaceHandler#init</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token function">registerBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token string">"aspectj-autoproxy"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">AspectJAutoProxyBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
    <span class="token punctuation">}</span></code></pre>
<ul>
<li>注解：<code>@EnableAspectJAutoProxy</code></li>
</ul>
<ul>
<li>SpringBoot：<code>@AopAutoConfiguration</code></li>
</ul>
<hr>
<p>AopAutoConfiguration</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token punctuation">{</span>EnableAspectJAutoProxy<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> Aspect<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> Advice<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> AnnotatedElement<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnProperty</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"spring.aop"</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">"auto"</span><span class="token punctuation">,</span> havingValue <span class="token operator">=</span> <span class="token string">"true"</span><span class="token punctuation">,</span> matchIfMissing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AopAutoConfiguration</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@EnableAspectJAutoProxy</span><span class="token punctuation">(</span>proxyTargetClass <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ConditionalOnProperty</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"spring.aop"</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">"proxy-target-class"</span><span class="token punctuation">,</span> havingValue <span class="token operator">=</span> <span class="token string">"false"</span><span class="token punctuation">,</span> matchIfMissing <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">JdkDynamicAutoProxyConfiguration</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@EnableAspectJAutoProxy</span><span class="token punctuation">(</span>proxyTargetClass <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ConditionalOnProperty</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"spring.aop"</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">"proxy-target-class"</span><span class="token punctuation">,</span> havingValue <span class="token operator">=</span> <span class="token string">"true"</span><span class="token punctuation">,</span> matchIfMissing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">CglibAutoProxyConfiguration</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span></code></pre>
<p>EnableAspectJAutoProxy</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span>ElementType<span class="token punctuation">.</span>TYPE<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span>RetentionPolicy<span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Documented</span>
<span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span>AspectJAutoProxyRegistrar<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 引入</span>
<span class="token keyword">public</span> @<span class="token keyword">interface</span> <span class="token class-name">EnableAspectJAutoProxy</span> <span class="token punctuation">{</span>

    <span class="token keyword">boolean</span> <span class="token function">proxyTargetClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">boolean</span> <span class="token function">exposeProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span></code></pre>
<p>AspectJAutoProxyRegistrar#registerBeanDefinitions</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerBeanDefinitions</span><span class="token punctuation">(</span>AnnotationMetadata importingClassMetadata<span class="token punctuation">,</span> BeanDefinitionRegistry registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 注册AnnotationAwareAspectJAutoProxyCreator</span>
        AopConfigUtils<span class="token punctuation">.</span><span class="token function">registerAspectJAnnotationAutoProxyCreatorIfNecessary</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
        AnnotationAttributes enableAspectJAutoProxy <span class="token operator">=</span> AnnotationConfigUtils<span class="token punctuation">.</span><span class="token function">attributesFor</span><span class="token punctuation">(</span>importingClassMetadata<span class="token punctuation">,</span> EnableAspectJAutoProxy<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>enableAspectJAutoProxy <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>enableAspectJAutoProxy<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token string">"proxyTargetClass"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 设置AnnotationAwareAspectJAutoProxyCreator的BeanDefinition的proxyTargetClass为true</span>
                AopConfigUtils<span class="token punctuation">.</span><span class="token function">forceAutoProxyCreatorToUseClassProxying</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>enableAspectJAutoProxy<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token string">"exposeProxy"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 设置AnnotationAwareAspectJAutoProxyCreator的BeanDefinition的exposeProxy为true</span>
                AopConfigUtils<span class="token punctuation">.</span><span class="token function">forceAutoProxyCreatorToExposeProxy</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>AspectJ风格AOP:</p>
<pre class=" language-java"><code class="language-java">AnnotationAwareAspectJAutoProxyCreator <span class="token comment" spellcheck="true">// 在Bean的初始化后拦截，从容器获取所有匹配适用的Advisor和被@AspectJ注解的Bean，包装生成代理</span>
<span class="token operator">-</span><span class="token operator">></span> AspectJAwareAdvisorAutoProxyCreator
<span class="token operator">-</span><span class="token operator">></span> AbstractAdvisorAutoProxyCreator
<span class="token operator">-</span><span class="token operator">></span> AbstractAutoProxyCreator
<span class="token operator">-</span><span class="token operator">></span> SmartInstantiationAwareBeanPostProcessor
<span class="token operator">-</span><span class="token operator">></span> InstantiationAwareBeanPostProcessor
<span class="token operator">-</span><span class="token operator">></span> BeanPostProcessor <span class="token comment" spellcheck="true">// 你懂的</span></code></pre>
<p>调用栈</p>
<pre class=" language-java"><code class="language-java">AbstractApplicationContext#refresh
<span class="token operator">-</span><span class="token operator">></span> AbstractApplicationContext#invokeBeanFactoryPostProcessors
    <span class="token operator">-</span><span class="token operator">></span> PostProcessorRegistrationDelegate#invokeBeanFactoryPostProcessors
        <span class="token operator">-</span><span class="token operator">></span> BeanDefinitionRegistryPostProcessor#postProcessBeanDefinitionRegistry
        <span class="token operator">-</span><span class="token operator">></span> PostProcessorRegistrationDelegate#invokeBeanFactoryPostProcessors
            <span class="token operator">-</span><span class="token operator">></span> BeanFactoryPostProcessor#postProcessBeanFactory
<span class="token operator">-</span><span class="token operator">></span> AbstractApplicationContext#registerBeanPostProcessors
    <span class="token operator">-</span><span class="token operator">></span> PostProcessorRegistrationDelegate#registerBeanPostProcessors
<span class="token operator">-</span><span class="token operator">></span> AbstractApplicationContext#finishBeanFactoryInitialization
    <span class="token operator">-</span><span class="token operator">></span> DefaultListableBeanFactory#preInstantiateSingletons
        <span class="token operator">-</span><span class="token operator">></span> AbstractBeanFactory#getBean
            <span class="token operator">-</span><span class="token operator">></span> AbstractBeanFactory#doGetBean
                <span class="token operator">-</span><span class="token operator">></span> AbstractAutowireCapableBeanFactory#createBean
                    <span class="token operator">-</span><span class="token operator">></span> AbstractAutowireCapableBeanFactory#resolveBeforeInstantiation
                        <span class="token operator">-</span><span class="token operator">></span> AbstractAutowireCapableBeanFactory#applyBeanPostProcessorsBeforeInstantiation
                            <span class="token operator">-</span><span class="token operator">></span> InstantiationAwareBeanPostProcessor#postProcessBeforeInstantiation
                        <span class="token operator">-</span><span class="token operator">></span> AbstractAutowireCapableBeanFactory#applyBeanPostProcessorsAfterInitialization
                            <span class="token operator">-</span><span class="token operator">></span><span class="token operator">|</span> BeanPostProcessor#postProcessAfterInitialization
                    <span class="token operator">-</span><span class="token operator">></span><span class="token operator">|</span> AbstractAutowireCapableBeanFactory#doCreateBean
                        <span class="token operator">-</span><span class="token operator">></span> AbstractAutowireCapableBeanFactory#createBeanInstance
                            <span class="token operator">-</span><span class="token operator">></span><span class="token operator">|</span> AbstractAutowireCapableBeanFactory#obtainFromSupplier
                            <span class="token operator">-</span><span class="token operator">></span><span class="token operator">|</span> AbstractAutowireCapableBeanFactory#instantiateUsingFactoryMethod
                                <span class="token operator">-</span><span class="token operator">></span> AbstractAutowireCapableBeanFactory#determineConstructorsFromBeanPostProcessors
                                    <span class="token operator">-</span><span class="token operator">></span> SmartInstantiationAwareBeanPostProcessor#determineCandidateConstructors
                                <span class="token operator">-</span><span class="token operator">></span><span class="token operator">|</span> AbstractAutowireCapableBeanFactory#autowireConstructor
                                <span class="token operator">-</span><span class="token operator">></span><span class="token operator">|</span> AbstractAutowireCapableBeanFactory#instantiateBean
                        <span class="token operator">-</span><span class="token operator">></span> AbstractAutowireCapableBeanFactory#applyMergedBeanDefinitionPostProcessors
                            <span class="token operator">-</span><span class="token operator">></span> MergedBeanDefinitionPostProcessor#postProcessMergedBeanDefinition
                        <span class="token operator">-</span><span class="token operator">></span> AbstractAutowireCapableBeanFactory#getEarlyBeanReference
                            <span class="token operator">-</span><span class="token operator">></span> SmartInstantiationAwareBeanPostProcessor#getEarlyBeanReference
                        <span class="token operator">-</span><span class="token operator">></span> AbstractAutowireCapableBeanFactory#populateBean
                            <span class="token operator">-</span><span class="token operator">></span> InstantiationAwareBeanPostProcessor#postProcessAfterInstantiation
                            <span class="token operator">-</span><span class="token operator">></span> InstantiationAwareBeanPostProcessor#postProcessProperties
                            <span class="token operator">-</span><span class="token operator">></span> InstantiationAwareBeanPostProcessor#postProcessPropertyValues
                            <span class="token operator">-</span><span class="token operator">></span> AbstractAutowireCapableBeanFactory#applyPropertyValues
                        <span class="token operator">-</span><span class="token operator">></span> AbstractAutowireCapableBeanFactory#initializeBean
                            <span class="token operator">-</span><span class="token operator">></span> AbstractAutowireCapableBeanFactory#applyBeanPostProcessorsBeforeInitialization
                                <span class="token operator">-</span><span class="token operator">></span> BeanPostProcessor#postProcessBeforeInitialization
                            <span class="token operator">-</span><span class="token operator">></span> AbstractAutowireCapableBeanFactory#invokeInitMethods
                                <span class="token operator">-</span><span class="token operator">></span> InitializingBean#afterPropertiesSet
                                <span class="token operator">-</span><span class="token operator">></span> AbstractAutowireCapableBeanFactory#invokeCustomInitMethod
                            <span class="token operator">-</span><span class="token operator">></span> AbstractAutowireCapableBeanFactory#applyBeanPostProcessorsAfterInitialization
                                <span class="token operator">-</span><span class="token operator">></span> BeanPostProcessor#postProcessAfterInitialization
        <span class="token operator">-</span><span class="token operator">></span> SmartInitializingSingleton#afterSingletonsInstantiated</code></pre>
<p>是不是很吓人，哈哈。</p>
<hr>
<p>AnnotationAwareAspectJAutoProxyCreator可能拦截并创建代理对象的几个时机：</p>
<ol>
<li><p>SmartInstantiationAwareBeanPostProcessor#getEarlyBeanReference：循环依赖的情况，要被代理的Bean有早期引用，提前拦截。</p>
</li>
<li><p>InstantiationAwareBeanPostProcessor#postProcessBeforeInstantiation：前提是配置了customTargetSourceCreators。</p>
</li>
<li><p>BeanPostProcessor#postProcessAfterInitialization：一般情况，在Bean实例完成属性注入后执行拦截代理。</p>
</li>
</ol>
<p>之所以AOP动态代理的时机可能不一样，是因为对于循环引用的情况，假设A和B循环引用，A要被代理拦截。</p>
<p>如果动态代理不提前，那么实例化B对象，执行属性注入时，注入的A对象还没被代理，然后B对象就暴露到单例缓存。</p>
<p>之后A对象执行完属性注入，再进行动态代理，生成被代理的A对象，暴露到单例缓存。</p>
<p>此时B注入的A对象和单例缓存中的被代理的A对象不是同一个对象（也就是B对象注入的A对象是没被代理的）。</p>
<p>AbstractAutoProxyCreator#postProcessAfterInitialization</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * 实例化并初始化完成后
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> Object <span class="token function">postProcessAfterInitialization</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> Object bean<span class="token punctuation">,</span> String beanName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Object cacheKey <span class="token operator">=</span> <span class="token function">getCacheKey</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>earlyProxyReferences<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span> <span class="token operator">!=</span> bean<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 代理包装</span>
                <span class="token keyword">return</span> <span class="token function">wrapIfNecessary</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> cacheKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>AbstractAutoProxyCreator#wrapIfNecessary</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">protected</span> Object <span class="token function">wrapIfNecessary</span><span class="token punctuation">(</span>Object bean<span class="token punctuation">,</span> String beanName<span class="token punctuation">,</span> Object cacheKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 该Bean之前已经被postProcessBeforeInstantiation处理过，不再处理</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">hasLength</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>targetSourcedBeans<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 该Bean之前已经被postProcessBeforeInstantiation标记为不需要处理</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Boolean<span class="token punctuation">.</span>FALSE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>advisedBeans<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 基础设施类 || 需要跳过的Bean</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isInfrastructureClass</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">shouldSkip</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 加到缓存，标记为不需要处理</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>advisedBeans<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> Boolean<span class="token punctuation">.</span>FALSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 不需要代理包装</span>
            <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 获取所有匹配某个Bean的Advice和Advisor，没有则不创建代理</span>
        Object<span class="token punctuation">[</span><span class="token punctuation">]</span> specificInterceptors <span class="token operator">=</span> <span class="token function">getAdvicesAndAdvisorsForBean</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>specificInterceptors <span class="token operator">!=</span> DO_NOT_PROXY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 加入缓存，表示当前Bean需要创建相应的代理对象</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>advisedBeans<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> Boolean<span class="token punctuation">.</span>TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 创建代理</span>
            Object proxy <span class="token operator">=</span> <span class="token function">createProxy</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> specificInterceptors<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SingletonTargetSource</span><span class="token punctuation">(</span>bean<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 缓存代理对象类型</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>proxyTypes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> proxy<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 返回代理对象</span>
            <span class="token keyword">return</span> proxy<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 加入缓存，表示当前Bean不需要创建代理</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>advisedBeans<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> Boolean<span class="token punctuation">.</span>FALSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>AbstractAutoProxyCreator#findEligibleAdvisors</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">protected</span> List<span class="token operator">&lt;</span>Advisor<span class="token operator">></span> <span class="token function">findEligibleAdvisors</span><span class="token punctuation">(</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> beanClass<span class="token punctuation">,</span> String beanName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 从BeanFactory中获取所有的Advisor和@AspectJ注解的Bean，解析被@AspectJ注解的切面类的Advice方法，每个构造成一个Advisor</span>
        List<span class="token operator">&lt;</span>Advisor<span class="token operator">></span> candidateAdvisors <span class="token operator">=</span> <span class="token function">findCandidateAdvisors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 过滤，找到所有适用该Bean的Advisor</span>
        List<span class="token operator">&lt;</span>Advisor<span class="token operator">></span> eligibleAdvisors <span class="token operator">=</span> <span class="token function">findAdvisorsThatCanApply</span><span class="token punctuation">(</span>candidateAdvisors<span class="token punctuation">,</span> beanClass<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 添加一个ExposeInvocationInterceptor</span>
        <span class="token function">extendAdvisors</span><span class="token punctuation">(</span>eligibleAdvisors<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>eligibleAdvisors<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 排序</span>
            eligibleAdvisors <span class="token operator">=</span> <span class="token function">sortAdvisors</span><span class="token punctuation">(</span>eligibleAdvisors<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> eligibleAdvisors<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>AbstractAutoProxyCreator#createProxy</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">protected</span> Object <span class="token function">createProxy</span><span class="token punctuation">(</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> beanClass<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> String beanName<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> Object<span class="token punctuation">[</span><span class="token punctuation">]</span> specificInterceptors<span class="token punctuation">,</span> TargetSource targetSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// 创建ProxyFactory</span>
        ProxyFactory proxyFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProxyFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 复制到ProxyConfig</span>
        proxyFactory<span class="token punctuation">.</span><span class="token function">copyFrom</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 如果设置proxyTargetClass=true，则不管有没有接口，都使用CGLIB生成代理（默认false）</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>proxyFactory<span class="token punctuation">.</span><span class="token function">isProxyTargetClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldProxyTargetClass</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                proxyFactory<span class="token punctuation">.</span><span class="token function">setProxyTargetClass</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 有可代理接口，添加到ProxyFactory，没有接口，proxyFactory.setProxyTargetClass(true);</span>
                <span class="token function">evaluateProxyInterfaces</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">,</span> proxyFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 适用于该Bean的所有Advisor：从BeanFactory获取通用拦截器（默认空），加上匹配该Bean的专用拦截器，包装成Advisor返回</span>
        Advisor<span class="token punctuation">[</span><span class="token punctuation">]</span> advisors <span class="token operator">=</span> <span class="token function">buildAdvisors</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> specificInterceptors<span class="token punctuation">)</span><span class="token punctuation">;</span>
        proxyFactory<span class="token punctuation">.</span><span class="token function">addAdvisors</span><span class="token punctuation">(</span>advisors<span class="token punctuation">)</span><span class="token punctuation">;</span>
        proxyFactory<span class="token punctuation">.</span><span class="token function">setTargetSource</span><span class="token punctuation">(</span>targetSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// 创建当前Bean的代理对象</span>
        <span class="token keyword">return</span> proxyFactory<span class="token punctuation">.</span><span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token function">getProxyClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>DefaultAopProxyFactory#createAopProxy</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * 创建代理
     * 如果被代理的目标类实现了自定义接口，使用JDK动态代理（只有接口中的方法会被增强）
     * 如果没实现任何接口，使用CGLIB实现代理（基于类继承，方法不能是final或private）
     * 如果设置了proxyTargetClass=true，全都使用CGLIB
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> AopProxy <span class="token function">createAopProxy</span><span class="token punctuation">(</span>AdvisedSupport config<span class="token punctuation">)</span> <span class="token keyword">throws</span> AopConfigException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Optimize，默认false || proxy-target-class=true || 没有实现接口</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">isOptimize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> config<span class="token punctuation">.</span><span class="token function">isProxyTargetClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">hasNoUserSuppliedProxyInterfaces</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> targetClass <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">getTargetClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// 如果要代理的类本身就是接口，用JDK动态代理</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>targetClass<span class="token punctuation">.</span><span class="token function">isInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> Proxy<span class="token punctuation">.</span><span class="token function">isProxyClass</span><span class="token punctuation">(</span>targetClass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JdkDynamicAopProxy</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// CGLIB</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ObjenesisCglibAopProxy</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 如果有接口</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JdkDynamicAopProxy</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>以JDK动态代理为例。</p>
<p>JdkDynamicAopProxy#invoke</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">public</span> Object <span class="token function">invoke</span><span class="token punctuation">(</span>Object proxy<span class="token punctuation">,</span> Method method<span class="token punctuation">,</span> Object<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{</span>
        MethodInvocation invocation<span class="token punctuation">;</span>
        Object oldProxy <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> setProxyContext <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        TargetSource targetSource <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>advised<span class="token punctuation">.</span>targetSource<span class="token punctuation">;</span>
        Object target <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
            Object retVal<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 如果暴露代理，默认false</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>advised<span class="token punctuation">.</span>exposeProxy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ThreadLocal保存当前代理对象，返回原本的代理对象</span>
                oldProxy <span class="token operator">=</span> AopContext<span class="token punctuation">.</span><span class="token function">setCurrentProxy</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
                setProxyContext <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            target <span class="token operator">=</span> targetSource<span class="token punctuation">.</span><span class="token function">getTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> targetClass <span class="token operator">=</span> <span class="token punctuation">(</span>target <span class="token operator">!=</span> null <span class="token operator">?</span> target<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 遍历，把Advisor中的Advice包装成Interceptor</span>
            List<span class="token operator">&lt;</span>Object<span class="token operator">></span> chain <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>advised<span class="token punctuation">.</span><span class="token function">getInterceptorsAndDynamicInterceptionAdvice</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> targetClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 如果链是空</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>chain<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 否则</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 创建一个ReflectiveMethodInvocation</span>
                invocation <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReflectiveMethodInvocation</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> target<span class="token punctuation">,</span> method<span class="token punctuation">,</span> args<span class="token punctuation">,</span> targetClass<span class="token punctuation">,</span> chain<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 执行链式调用，得到返回结果</span>
                retVal <span class="token operator">=</span> invocation<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">return</span> retVal<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>targetSource<span class="token punctuation">.</span><span class="token function">isStatic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                targetSource<span class="token punctuation">.</span><span class="token function">releaseTarget</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>setProxyContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 把原本的代理对象设回去</span>
                AopContext<span class="token punctuation">.</span><span class="token function">setCurrentProxy</span><span class="token punctuation">(</span>oldProxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>ReflectiveMethodInvocation#proceed</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">public</span> Object <span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 链接链执行终点</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currentInterceptorIndex <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>interceptorsAndDynamicMethodMatchers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 调用被代理对象的真实方法，递归终止</span>
            <span class="token keyword">return</span> <span class="token function">invokeJoinpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 获取下一个拦截器</span>
        Object interceptorOrInterceptionAdvice <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>interceptorsAndDynamicMethodMatchers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token operator">++</span><span class="token keyword">this</span><span class="token punctuation">.</span>currentInterceptorIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 需要动态匹配</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>interceptorOrInterceptionAdvice <span class="token keyword">instanceof</span> <span class="token class-name">InterceptorAndDynamicMethodMatcher</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 直接invoke</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 传入this</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>MethodInterceptor<span class="token punctuation">)</span> interceptorOrInterceptionAdvice<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>就是通过BeanPostProcessor对Bean进行拦截包装。</p>
<p>从BeanFactory中获取所有被@AspectJ注解的Bean，解析切面类的Advice方法，每个方法构造成一个Advisor。</p>
<p>然后过滤得到适用于该Bean的所有Advisor。</p>
<p>然后根据配置和被代理的Bean，使用JDK动态代理或CGLIB创建代理对象，实际注入的是代理对象。</p>
<p>调用时会创建拦截链，通过职责链的方式调用一个个Advisor，进行拦截增强。</p>
<hr>
<p>顺序是@Around，@Before，@After，@AfterReturning，@AfterThrowing。</p>
<p>假设有两个切面A、B，每个切面有@Around，@Before，@After，@AfterReturning，@AfterThrowing的方法，所有方法以职责链形式进行：</p>
<pre class=" language-java"><code class="language-java">A <span class="token operator">-</span> AspectJAroundAdvice#invoke
    A <span class="token operator">-</span> <span class="token annotation punctuation">@Around</span>
        proceed
            A <span class="token operator">-</span> MethodBeforeAdviceInterceptor#invoke
                A <span class="token operator">-</span> AspectJMethodBeforeAdvice#before
                    A <span class="token operator">-</span> <span class="token annotation punctuation">@Before</span>
                proceed
                     A <span class="token operator">-</span> AspectJAfterAdvice#invoke
                        proceed
                            A <span class="token operator">-</span> AfterReturningAdviceInterceptor#invoke
                                proceed
                                    A <span class="token operator">-</span> AspectJAfterThrowingAdvice#invoke
                                        proceed
                                            B <span class="token operator">-</span> AspectJAroundAdvice#invoke
                                                B <span class="token operator">-</span> <span class="token annotation punctuation">@Around</span>
                                                    proceed
                                                        B <span class="token operator">-</span> MethodBeforeAdviceInterceptor#invoke
                                                            B <span class="token operator">-</span> AspectJMethodBeforeAdvice#before
                                                                B <span class="token operator">-</span> <span class="token annotation punctuation">@Before</span>
                                                            proceed
                                                                 B <span class="token operator">-</span> AspectJAfterAdvice#invoke
                                                                    proceed
                                                                        B <span class="token operator">-</span> AfterReturningAdviceInterceptor#invoke
                                                                            proceed
                                                                                B <span class="token operator">-</span> AspectJAfterThrowingAdvice#invoke
                                                                                    proceed
                                                                                        invokeJoinpoint
                                                                                    B <span class="token operator">-</span> <span class="token annotation punctuation">@AfterThrowing</span>
                                                                            B <span class="token operator">-</span> AspectJAfterReturningAdvice#afterReturning
                                                                                B <span class="token operator">-</span> <span class="token annotation punctuation">@AfterReturning</span>
                                                                    B <span class="token operator">-</span> <span class="token annotation punctuation">@After</span>
                                        A <span class="token operator">-</span> <span class="token annotation punctuation">@AfterThrowing</span>
                                A <span class="token operator">-</span> AspectJAfterReturningAdvice#afterReturning
                                    A <span class="token operator">-</span> <span class="token annotation punctuation">@AfterReturning</span>
                        A <span class="token operator">-</span> <span class="token annotation punctuation">@After</span></code></pre>
<hr>
<p>一般AOP如果拦截的是Controller，因为没有接口，所以使用CGLIB子类继承代理的。</p>
<p>如果是Service，一般用JDK动态代理，所以AOP性能相对还是有损耗的，虽然Spring加了缓存。</p>
<p>Spring的AspectJ默认只是使用了几个AspectJ的注解，实际还是运行时织入，如果想运行前织入，需要另外配置。</p>
<p>运行时需要指定javaagent参数<code>-javaagent:spring-instrument-{version}.jar</code>。</p>
<p>javaagent是执行main方法前的拦截器，javaagent代码和main方法在同一个JVM运行。</p>
<p>实现javaagent需要实现premain方法。</p>
<p>javaagent类必须打成.jar包，里面的<code>META-INF/MAINIFEST.MF</code>必须包含<code>Premain-Class</code>属性。</p>
<p>MANIFEST.MF</p>
<pre class=" language-ini"><code class="language-ini">Manifest-Version: 1.0
Implementation-Title: spring-instrument
Automatic-Module-Name: spring.instrument
Premain-Class: org.springframework.instrument.InstrumentationSavingAgent
Implementation-Version: 5.1.8.RELEASE
Agent-Class: org.springframework.instrument.InstrumentationSavingAgent
Can-Redefine-Classes: true
Can-Retransform-Classes: true
Can-Set-Native-Method-Prefix: false
Created-By: 1.8.0_212 (Oracle Corporation)</code></pre>
<p>spring-instrument.jar: InstrumentationSavingAgent</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">InstrumentationSavingAgent</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">volatile</span> Instrumentation instrumentation<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// ...</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">premain</span><span class="token punctuation">(</span>String agentArgs<span class="token punctuation">,</span> Instrumentation inst<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 只是暴露出来</span>
        <span class="token comment" spellcheck="true">// 通过Instrumentation，可以添加自定义的ClassFileTransformer，来改变.class，不修改原有的代码进行增强</span>
        instrumentation <span class="token operator">=</span> inst<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">agentmain</span><span class="token punctuation">(</span>String agentArgs<span class="token punctuation">,</span> Instrumentation inst<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        instrumentation <span class="token operator">=</span> inst<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// ...</span>
<span class="token punctuation">}</span></code></pre>
<p>这种方式的@Aspect注解的切面类不在BeanFactory内，所以不要加@Component之类的添加进容器。</p>
<p>Spring在加载目标类的.class文件到JVM之前，AspectJ会将切面类中的增强逻辑织入到.class文件中，生成新的.class字节码，不需要动态代理就能实现AOP。</p>
<p>在类加载期，注册的ClassFileTransformer读取类路径下META-INF/aop.xml文件中定义的切面类和目标类信息，生成新的.class字节码，然后交给JVM加载。</p>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


        <footer>
             
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

        </footer>
    </div>
    <!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
    <script>
        var timeEnd = new Date();
        console.log('耗时：' + (timeEnd - timeStart));
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre').forEach((block) => {
                block.classList.add("line-numbers");
            });
        });
    </script>

    <script src="/js/prism.js"></script>
</body>
</html>
