<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
        <script>
            var timeStart = new Date();
        </script>
        
        <title>[ç¬”è®°]-Spring Framework-AOP | ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜</title>
        
        <meta name="author" content="huangzhike">
        
        
        <meta name="description" content="æ¨èä¸€ä¸ªé«˜è´¨é‡çš„æŠ€æœ¯ç½‘ç«™ï¼šBaeldungï¼ˆæ€»æ˜¯æ„Ÿè§‰å¤–å›½äººå†™çš„ä¸œè¥¿è´¨é‡æ¯”è¾ƒé«˜ï¼Œä¸ºä»€ä¹ˆå‘¢ã€‚ã€‚ã€‚ï¼‰
å‚è€ƒï¼šhttps://www.jianshu.com/p/a1950bbae852

Springçš„AOPï¼šå°†Springçš„AOPå’ŒAspectJé£æ ¼çš„AOPç»Ÿä¸€æˆAdvisoråˆ‡é¢ï¼Œé»˜è®¤åŸºäºCGLIBæˆ–">
        
        
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        
        <meta property="og:title" content="[ç¬”è®°]-Spring Framework-AOP"/>
        
        <meta property="og:site_name" content="ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜"/>
        
        
        <!-- favicon -->
        <link rel="icon" type="image/ico" href="/ok.ico" sizes="32x32">
        <meta name="msapplication-TileColor" content="#009688">
        <meta name="msapplication-TileImage" content="/mstile-144x144.ico">
        <meta name="theme-color" content="#009688">
        <!-- favicon end -->
        <!-- <link href="//ok.ico" rel="icon"> -->
        
        <!-- toc -->
        <!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
        <!-- material design -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
        <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
        
        <!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
        <!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
    <meta name="generator" content="Hexo 4.2.1"></head>

<body>
    <nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">èœå•</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" title="ä¸‹ä¸€å¥æ˜¯ï¼šå®¢æœ‰å¯äººæœŸä¸æ¥ã€‚å°æ—¶å€™ï¼Œå–œæ¬¢é åœ¨é˜³å°ä¸Šï¼Œä¸€è¾¹å¹é£ï¼Œä¸€è¾¹çœ‹ä¹¦ï¼Œå–œæ¬¢è¯»ä¹¦å—ï¼Œéªšå¹´ï¼Ÿ" href="/">ä¹¦å½“å¿«æ„è¯»æ˜“å°½</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" target="_blank" rel="noopener" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

    <div class="container" >
        <div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[ç¬”è®°]-Spring Framework-AOP</h2>
				
				<div>
					<div class="post-time">2019-08-09</div>
				</div>
				
				<div class="article-content">
				<p>æ¨èä¸€ä¸ªé«˜è´¨é‡çš„æŠ€æœ¯ç½‘ç«™ï¼š<a href="https://www.baeldung.com/aspectj" target="_blank" rel="noopener">Baeldung</a>ï¼ˆæ€»æ˜¯æ„Ÿè§‰å¤–å›½äººå†™çš„ä¸œè¥¿è´¨é‡æ¯”è¾ƒé«˜ï¼Œä¸ºä»€ä¹ˆå‘¢ã€‚ã€‚ã€‚ï¼‰</p>
<p>å‚è€ƒï¼š<a href="https://www.jianshu.com/p/a1950bbae852" target="_blank" rel="noopener">https://www.jianshu.com/p/a1950bbae852</a></p>
<ul>
<li><p>Springçš„AOPï¼šå°†Springçš„AOPå’ŒAspectJé£æ ¼çš„AOPç»Ÿä¸€æˆAdvisoråˆ‡é¢ï¼Œé»˜è®¤åŸºäºCGLIBæˆ–JDKåŠ¨æ€ä»£ç†å®ç°ï¼Œè¿è¡Œæ—¶é€šè¿‡åŠ¨æ€ä»£ç†ç»‡å…¥ï¼Œå¦‚æœéœ€è¦å®ç°AspectJçš„AOPï¼Œéœ€è¦å¦å¤–çš„æ“ä½œã€‚</p>
</li>
<li><p>AspectJçš„AOPï¼š</p>
<ul>
<li><p>ç¼–è¯‘æ—¶ç»‡å…¥ï¼ˆcompile-time weavingï¼‰ï¼šåˆ©ç”¨ajcç¼–è¯‘å™¨æ›¿ä»£javacç¼–è¯‘å™¨ï¼Œç›´æ¥å°†æºæ–‡ä»¶(.javaæˆ–.aspect)ç¼–è¯‘æˆ.classæ–‡ä»¶å¹¶ç»‡å…¥</p>
</li>
<li><p>ç¼–è¯‘åç»‡å…¥ï¼ˆpost-compile weavingï¼‰ï¼šåˆ©ç”¨ajcç¼–è¯‘å™¨å‘javacç¼–è¯‘æœŸç¼–è¯‘åçš„.classæ–‡ä»¶æˆ–.jaræ–‡ä»¶ç»‡å…¥</p>
</li>
<li><p>åŠ è½½æ—¶ç»‡å…¥ï¼ˆload-time weavingï¼‰ï¼šä¸ä½¿ç”¨ajcç¼–è¯‘å™¨ï¼Œåˆ©ç”¨aspectjweaver.jarï¼Œåœ¨ç±»åŠ è½½æœŸç»‡å…¥</p>
</li>
</ul>
</li>
</ul>
<p>æ²¡ç”¨è¿‡ï¼Œä¸å¤šè¯´ã€‚</p>
<hr>
<p>Xmlï¼š<code>&lt;aop:aspectj-autoproxy/&gt;</code></p>
<p>AopNamespaceHandler#init</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">registerBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token string">"config"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ConfigBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">registerBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token string">"aspectj-autoproxy"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">AspectJAutoProxyBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">registerBeanDefinitionDecorator</span><span class="token punctuation">(</span><span class="token string">"scoped-proxy"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ScopedProxyBeanDefinitionDecorator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">registerBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token string">"spring-configured"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SpringConfiguredBeanDefinitionParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>æ³¨è§£ï¼š<code>@EnableAspectJAutoProxy</code></p>
<p>SpringBootï¼š<code>@AopAutoConfiguration</code></p>
<hr>
<p>AopAutoConfiguration</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token punctuation">{</span>EnableAspectJAutoProxy<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> Aspect<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> Advice<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> AnnotatedElement<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnProperty</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"spring.aop"</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">"auto"</span><span class="token punctuation">,</span> havingValue <span class="token operator">=</span> <span class="token string">"true"</span><span class="token punctuation">,</span> matchIfMissing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AopAutoConfiguration</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@EnableAspectJAutoProxy</span><span class="token punctuation">(</span>proxyTargetClass <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ConditionalOnProperty</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"spring.aop"</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">"proxy-target-class"</span><span class="token punctuation">,</span> havingValue <span class="token operator">=</span> <span class="token string">"false"</span><span class="token punctuation">,</span> matchIfMissing <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">JdkDynamicAutoProxyConfiguration</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@EnableAspectJAutoProxy</span><span class="token punctuation">(</span>proxyTargetClass <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ConditionalOnProperty</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"spring.aop"</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">"proxy-target-class"</span><span class="token punctuation">,</span> havingValue <span class="token operator">=</span> <span class="token string">"true"</span><span class="token punctuation">,</span> matchIfMissing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">CglibAutoProxyConfiguration</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span></code></pre>
<p>EnableAspectJAutoProxy</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span>ElementType<span class="token punctuation">.</span>TYPE<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span>RetentionPolicy<span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Documented</span>
<span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span>AspectJAutoProxyRegistrar<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// å¼•å…¥</span>
<span class="token keyword">public</span> @<span class="token keyword">interface</span> <span class="token class-name">EnableAspectJAutoProxy</span> <span class="token punctuation">{</span>

    <span class="token keyword">boolean</span> <span class="token function">proxyTargetClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">boolean</span> <span class="token function">exposeProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span></code></pre>
<p>AspectJAutoProxyRegistrar#registerBeanDefinitions</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerBeanDefinitions</span><span class="token punctuation">(</span>AnnotationMetadata importingClassMetadata<span class="token punctuation">,</span> BeanDefinitionRegistry registry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// æ³¨å†ŒAnnotationAwareAspectJAutoProxyCreator</span>
        AopConfigUtils<span class="token punctuation">.</span><span class="token function">registerAspectJAnnotationAutoProxyCreatorIfNecessary</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
        AnnotationAttributes enableAspectJAutoProxy <span class="token operator">=</span> AnnotationConfigUtils<span class="token punctuation">.</span><span class="token function">attributesFor</span><span class="token punctuation">(</span>importingClassMetadata<span class="token punctuation">,</span> EnableAspectJAutoProxy<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>enableAspectJAutoProxy <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>enableAspectJAutoProxy<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token string">"proxyTargetClass"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// è®¾ç½®AnnotationAwareAspectJAutoProxyCreatorçš„BeanDefinitionçš„proxyTargetClassä¸ºtrue</span>
                AopConfigUtils<span class="token punctuation">.</span><span class="token function">forceAutoProxyCreatorToUseClassProxying</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>enableAspectJAutoProxy<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token string">"exposeProxy"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// è®¾ç½®AnnotationAwareAspectJAutoProxyCreatorçš„BeanDefinitionçš„exposeProxyä¸ºtrue</span>
                AopConfigUtils<span class="token punctuation">.</span><span class="token function">forceAutoProxyCreatorToExposeProxy</span><span class="token punctuation">(</span>registry<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>SpringAOPï¼š</p>
<pre class=" language-java"><code class="language-java">DefaultAdvisorAutoProxyCreator
<span class="token operator">-</span><span class="token operator">></span> AbstractAdvisorAutoProxyCreator
<span class="token operator">-</span><span class="token operator">></span> AbstractAutoProxyCreator
<span class="token operator">-</span><span class="token operator">></span> SmartInstantiationAwareBeanPostProcessor
<span class="token operator">-</span><span class="token operator">></span> InstantiationAwareBeanPostProcessor
<span class="token operator">-</span><span class="token operator">></span> BeanPostProcessor</code></pre>
<p>AspectJé£æ ¼AOP:</p>
<pre class=" language-java"><code class="language-java">AnnotationAwareAspectJAutoProxyCreator <span class="token comment" spellcheck="true">// åœ¨Beançš„åˆå§‹åŒ–åæ‹¦æˆªï¼Œä»å®¹å™¨è·å–æ‰€æœ‰åŒ¹é…é€‚ç”¨çš„Advisorå’Œè¢«@AspectJæ³¨è§£çš„Beanï¼ŒåŒ…è£…ç”Ÿæˆä»£ç†</span>
<span class="token operator">-</span><span class="token operator">></span> AspectJAwareAdvisorAutoProxyCreator
<span class="token operator">-</span><span class="token operator">></span> AbstractAdvisorAutoProxyCreator
<span class="token operator">-</span><span class="token operator">></span> AbstractAutoProxyCreator
<span class="token operator">-</span><span class="token operator">></span> SmartInstantiationAwareBeanPostProcessor
<span class="token operator">-</span><span class="token operator">></span> InstantiationAwareBeanPostProcessor
<span class="token operator">-</span><span class="token operator">></span> BeanPostProcessor <span class="token comment" spellcheck="true">// ä½ æ‡‚çš„</span></code></pre>
<p>è°ƒç”¨æ ˆ</p>
<pre class=" language-java"><code class="language-java">AbstractApplicationContext#refresh
<span class="token operator">-</span><span class="token operator">></span> AbstractApplicationContext#invokeBeanFactoryPostProcessors
    <span class="token operator">-</span><span class="token operator">></span> PostProcessorRegistrationDelegate#invokeBeanFactoryPostProcessors
        <span class="token operator">-</span><span class="token operator">></span> BeanDefinitionRegistryPostProcessor#postProcessBeanDefinitionRegistry
        <span class="token operator">-</span><span class="token operator">></span> PostProcessorRegistrationDelegate#invokeBeanFactoryPostProcessors
            <span class="token operator">-</span><span class="token operator">></span> BeanFactoryPostProcessor#postProcessBeanFactory
<span class="token operator">-</span><span class="token operator">></span> AbstractApplicationContext#registerBeanPostProcessors
    <span class="token operator">-</span><span class="token operator">></span> PostProcessorRegistrationDelegate#registerBeanPostProcessors
<span class="token operator">-</span><span class="token operator">></span> AbstractApplicationContext#finishBeanFactoryInitialization
    <span class="token operator">-</span><span class="token operator">></span> DefaultListableBeanFactory#preInstantiateSingletons
        <span class="token operator">-</span><span class="token operator">></span> AbstractBeanFactory#getBean
            <span class="token operator">-</span><span class="token operator">></span> AbstractBeanFactory#doGetBean
                <span class="token operator">-</span><span class="token operator">></span> AbstractAutowireCapableBeanFactory#createBean
                    <span class="token operator">-</span><span class="token operator">></span> AbstractAutowireCapableBeanFactory#resolveBeforeInstantiation
                        <span class="token operator">-</span><span class="token operator">></span> AbstractAutowireCapableBeanFactory#applyBeanPostProcessorsBeforeInstantiation
                            <span class="token operator">-</span><span class="token operator">></span> InstantiationAwareBeanPostProcessor#postProcessBeforeInstantiation
                        <span class="token operator">-</span><span class="token operator">></span> AbstractAutowireCapableBeanFactory#applyBeanPostProcessorsAfterInitialization
                            <span class="token operator">-</span><span class="token operator">></span><span class="token operator">|</span> BeanPostProcessor#postProcessAfterInitialization
                    <span class="token operator">-</span><span class="token operator">></span><span class="token operator">|</span> AbstractAutowireCapableBeanFactory#doCreateBean
                        <span class="token operator">-</span><span class="token operator">></span> AbstractAutowireCapableBeanFactory#createBeanInstance
                            <span class="token operator">-</span><span class="token operator">></span><span class="token operator">|</span> AbstractAutowireCapableBeanFactory#obtainFromSupplier
                            <span class="token operator">-</span><span class="token operator">></span><span class="token operator">|</span> AbstractAutowireCapableBeanFactory#instantiateUsingFactoryMethod
                                <span class="token operator">-</span><span class="token operator">></span> AbstractAutowireCapableBeanFactory#determineConstructorsFromBeanPostProcessors
                                    <span class="token operator">-</span><span class="token operator">></span> SmartInstantiationAwareBeanPostProcessor#determineCandidateConstructors
                                <span class="token operator">-</span><span class="token operator">></span><span class="token operator">|</span> AbstractAutowireCapableBeanFactory#autowireConstructor
                                <span class="token operator">-</span><span class="token operator">></span><span class="token operator">|</span> AbstractAutowireCapableBeanFactory#instantiateBean
                        <span class="token operator">-</span><span class="token operator">></span> AbstractAutowireCapableBeanFactory#applyMergedBeanDefinitionPostProcessors
                            <span class="token operator">-</span><span class="token operator">></span> MergedBeanDefinitionPostProcessor#postProcessMergedBeanDefinition
                        <span class="token operator">-</span><span class="token operator">></span> AbstractAutowireCapableBeanFactory#getEarlyBeanReference
                            <span class="token operator">-</span><span class="token operator">></span> SmartInstantiationAwareBeanPostProcessor#getEarlyBeanReference
                        <span class="token operator">-</span><span class="token operator">></span> AbstractAutowireCapableBeanFactory#populateBean
                            <span class="token operator">-</span><span class="token operator">></span> InstantiationAwareBeanPostProcessor#postProcessAfterInstantiation
                            <span class="token operator">-</span><span class="token operator">></span> InstantiationAwareBeanPostProcessor#postProcessProperties
                            <span class="token operator">-</span><span class="token operator">></span> InstantiationAwareBeanPostProcessor#postProcessPropertyValues
                            <span class="token operator">-</span><span class="token operator">></span> AbstractAutowireCapableBeanFactory#applyPropertyValues
                        <span class="token operator">-</span><span class="token operator">></span> AbstractAutowireCapableBeanFactory#initializeBean
                            <span class="token operator">-</span><span class="token operator">></span> AbstractAutowireCapableBeanFactory#applyBeanPostProcessorsBeforeInitialization
                                <span class="token operator">-</span><span class="token operator">></span> BeanPostProcessor#postProcessBeforeInitialization
                            <span class="token operator">-</span><span class="token operator">></span> AbstractAutowireCapableBeanFactory#invokeInitMethods
                                <span class="token operator">-</span><span class="token operator">></span> InitializingBean#afterPropertiesSet
                                <span class="token operator">-</span><span class="token operator">></span> AbstractAutowireCapableBeanFactory#invokeCustomInitMethod
                            <span class="token operator">-</span><span class="token operator">></span> AbstractAutowireCapableBeanFactory#applyBeanPostProcessorsAfterInitialization
                                <span class="token operator">-</span><span class="token operator">></span> BeanPostProcessor#postProcessAfterInitialization
        <span class="token operator">-</span><span class="token operator">></span> SmartInitializingSingleton#afterSingletonsInstantiated</code></pre>
<p>æ˜¯ä¸æ˜¯å¾ˆå“äººï¼Œå“ˆå“ˆã€‚</p>
<p>AnnotationAwareAspectJAutoProxyCreatorå®ç°äº†BeanFactoryAwareæ¥å£ï¼š</p>
<pre class=" language-java"><code class="language-java">AbstractAutowireCapableBeanFactory#createBean
<span class="token operator">-</span><span class="token operator">></span> AbstractAutowireCapableBeanFactory#doCreateBean
<span class="token operator">-</span><span class="token operator">></span> AbstractAutowireCapableBeanFactory#initializeBean
<span class="token operator">-</span><span class="token operator">></span> AbstractAutowireCapableBeanFactory#invokeAwareMethods</code></pre>
<p>AbstractAutowireCapableBeanFactory#invokeAwareMethods</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">invokeAwareMethods</span><span class="token punctuation">(</span><span class="token keyword">final</span> String beanName<span class="token punctuation">,</span> <span class="token keyword">final</span> Object bean<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token keyword">instanceof</span> <span class="token class-name">Aware</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token keyword">instanceof</span> <span class="token class-name">BeanNameAware</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// è®¾ç½®è‡ªå·±çš„åå­—</span>
                <span class="token punctuation">(</span><span class="token punctuation">(</span>BeanNameAware<span class="token punctuation">)</span> bean<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setBeanName</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token keyword">instanceof</span> <span class="token class-name">BeanClassLoaderAware</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ClassLoader bcl <span class="token operator">=</span> <span class="token function">getBeanClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>bcl <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token punctuation">(</span><span class="token punctuation">(</span>BeanClassLoaderAware<span class="token punctuation">)</span> bean<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setBeanClassLoader</span><span class="token punctuation">(</span>bcl<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token keyword">instanceof</span> <span class="token class-name">BeanFactoryAware</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æ³¨å…¥</span>
                <span class="token punctuation">(</span><span class="token punctuation">(</span>BeanFactoryAware<span class="token punctuation">)</span> bean<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setBeanFactory</span><span class="token punctuation">(</span>AbstractAutowireCapableBeanFactory<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>AbstractAdvisorAutoProxyCreator#setBeanFactory</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setBeanFactory</span><span class="token punctuation">(</span>BeanFactory beanFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// è°ƒç”¨çˆ¶ç±»AbstractAutoProxyCreatorçš„æ–¹æ³•è®¾ç½®BeanFactory</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">setBeanFactory</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ£€æŸ¥</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>beanFactory <span class="token keyword">instanceof</span> <span class="token class-name">ConfigurableListableBeanFactory</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"AdvisorAutoProxyCreator requires a ConfigurableListableBeanFactory: "</span> <span class="token operator">+</span> beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// åˆå§‹åŒ–BeanFactory</span>
        <span class="token function">initBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ConfigurableListableBeanFactory<span class="token punctuation">)</span> beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>AnnotationAwareAspectJAutoProxyCreator#initBeanFactory</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initBeanFactory</span><span class="token punctuation">(</span>ConfigurableListableBeanFactory beanFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">/*
         * è°ƒç”¨çˆ¶ç±»AbstractAdvisorAutoProxyCreator#initBeanFactoryåˆå§‹åŒ–BeanFactory
         * å…¶å®æ˜¯æ„é€ ä¸€ä¸ªBeanFactoryAdvisorRetrievalHelperï¼Œç”¨äºä»BeanFactoryè·å–Advisor
         */</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">initBeanFactory</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>aspectJAdvisorFactory <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>aspectJAdvisorFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReflectiveAspectJAdvisorFactory</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ç”¨äºé€šè¿‡åå°„ä»BeanFactoryè·å–æ‰€æœ‰è¢«@AspectJæ³¨è§£çš„Bean</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>aspectJAdvisorsBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BeanFactoryAspectJAdvisorsBuilderAdapter</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>aspectJAdvisorFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>AbstractAdvisorAutoProxyCreator#initBeanFactory</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">initBeanFactory</span><span class="token punctuation">(</span>ConfigurableListableBeanFactory beanFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// åˆ›å»ºä¸€ä¸ªAdvisorRetrievalHelperï¼Œç”¨äºä»BeanFactoryè·å–Advisor</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>advisorRetrievalHelper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BeanFactoryAdvisorRetrievalHelperAdapter</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>AnnotationAwareAspectJAutoProxyCreatorå¯èƒ½æ‹¦æˆªå¹¶åˆ›å»ºä»£ç†å¯¹è±¡çš„å‡ ä¸ªæ—¶æœºï¼š</p>
<ul>
<li><p>SmartInstantiationAwareBeanPostProcessor#getEarlyBeanReferenceï¼šå‰ææ˜¯æœ‰æ—©æœŸå¼•ç”¨</p>
</li>
<li><p>InstantiationAwareBeanPostProcessor#postProcessBeforeInstantiationï¼šå‰ææ˜¯é…ç½®äº†customTargetSourceCreators</p>
</li>
<li><p>BeanPostProcessor#postProcessAfterInitializationï¼šä¸€èˆ¬æƒ…å†µ</p>
</li>
</ul>
<p>AbstractAutoProxyCreator#postProcessAfterInitialization</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * å®ä¾‹åŒ–å¹¶åˆå§‹åŒ–å®Œæˆå
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> Object <span class="token function">postProcessAfterInitialization</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> Object bean<span class="token punctuation">,</span> String beanName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Object cacheKey <span class="token operator">=</span> <span class="token function">getCacheKey</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>earlyProxyReferences<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span> <span class="token operator">!=</span> bean<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ä»£ç†åŒ…è£…</span>
                <span class="token keyword">return</span> <span class="token function">wrapIfNecessary</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> cacheKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>AbstractAutoProxyCreator#wrapIfNecessary</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * ä»£ç†åŒ…è£…ï¼Œå¦‚æœéœ€è¦
     */</span>
    <span class="token keyword">protected</span> Object <span class="token function">wrapIfNecessary</span><span class="token punctuation">(</span>Object bean<span class="token punctuation">,</span> String beanName<span class="token punctuation">,</span> Object cacheKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// è¯¥Beanä¹‹å‰å·²ç»è¢«postProcessBeforeInstantiationå¤„ç†è¿‡ï¼Œä¸å†å¤„ç†</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">hasLength</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>targetSourcedBeans<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// è¯¥Beanä¹‹å‰å·²ç»è¢«postProcessBeforeInstantiationæ ‡è®°ä¸ºä¸éœ€è¦å¤„ç†</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Boolean<span class="token punctuation">.</span>FALSE<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>advisedBeans<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// åŸºç¡€è®¾æ–½ç±» || éœ€è¦è·³è¿‡çš„Bean</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isInfrastructureClass</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">shouldSkip</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// åŠ åˆ°ç¼“å­˜ï¼Œæ ‡è®°ä¸ºä¸éœ€è¦å¤„ç†</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>advisedBeans<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> Boolean<span class="token punctuation">.</span>FALSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ä¸éœ€è¦ä»£ç†åŒ…è£…</span>
            <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">/*
         * è·å–é€‚ç”¨è¯¥Beançš„æ‰€æœ‰ä¸“ç”¨æ‹¦æˆªå™¨å¯¹è±¡ï¼Œä¸‰ç§è¿”å›å€¼ :
         *      æœ‰å€¼ï¼šä»£ç†ï¼Œä½¿ç”¨ä¸“ç”¨æ‹¦æˆªå™¨å’Œé€šç”¨æ‹¦æˆªå™¨
         *      æ— å€¼ï¼šä»£ç†ï¼Œæ²¡æœ‰ä¸“ç”¨æ‹¦æˆªå™¨ï¼Œä»…ä½¿ç”¨é€šç”¨æ‹¦æˆªå™¨
         *      Nullï¼šä¸ä»£ç†
         */</span>
        Object<span class="token punctuation">[</span><span class="token punctuation">]</span> specificInterceptors <span class="token operator">=</span> <span class="token function">getAdvicesAndAdvisorsForBean</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>specificInterceptors <span class="token operator">!=</span> DO_NOT_PROXY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// åŠ å…¥ç¼“å­˜ï¼Œè¡¨ç¤ºå½“å‰Beanéœ€è¦åˆ›å»ºç›¸åº”çš„ä»£ç†å¯¹è±¡</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>advisedBeans<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> Boolean<span class="token punctuation">.</span>TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// åˆ›å»ºä»£ç†</span>
            Object proxy <span class="token operator">=</span> <span class="token function">createProxy</span><span class="token punctuation">(</span>bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> specificInterceptors<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SingletonTargetSource</span><span class="token punctuation">(</span>bean<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ç¼“å­˜ä»£ç†å¯¹è±¡ç±»å‹</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>proxyTypes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> proxy<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è¿”å›ä»£ç†å¯¹è±¡</span>
            <span class="token keyword">return</span> proxy<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// åŠ å…¥ç¼“å­˜ï¼Œè¡¨ç¤ºå½“å‰Beanä¸éœ€è¦åˆ›å»ºä»£ç†</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>advisedBeans<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> Boolean<span class="token punctuation">.</span>FALSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>AbstractAutoProxyCreator#getAdvicesAndAdvisorsForBean</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * è·å–æ‰€æœ‰åŒ¹é…æŸä¸ªBeançš„Adviceå’ŒAdvisorï¼Œæ²¡æœ‰åˆ™ä¸åˆ›å»ºä»£ç†
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">protected</span> Object<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getAdvicesAndAdvisorsForBean</span><span class="token punctuation">(</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> beanClass<span class="token punctuation">,</span> String beanName<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> TargetSource targetSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// åŒ¹é…çš„</span>
        List<span class="token operator">&lt;</span>Advisor<span class="token operator">></span> advisors <span class="token operator">=</span> <span class="token function">findEligibleAdvisors</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>advisors<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// nullï¼Œæ²¡æœ‰åŒ¹é…çš„Advisorï¼Œä¸ä¸ºè¯¥Beanåˆ›å»ºä»£ç†</span>
            <span class="token keyword">return</span> DO_NOT_PROXY<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> advisors<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>AbstractAutoProxyCreator#findEligibleAdvisors</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">protected</span> List<span class="token operator">&lt;</span>Advisor<span class="token operator">></span> <span class="token function">findEligibleAdvisors</span><span class="token punctuation">(</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> beanClass<span class="token punctuation">,</span> String beanName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">/*
         * æ‰¾åˆ°å®¹å™¨ä¸­æ‰€æœ‰çš„Advisor
         * å½“å‰ç±»å®ç°ï¼šè·å–å®¹å™¨ä¸­æ‰€æœ‰Advisor
         * AnnotationAwareAspectJAutoProxyCreatoré‡å†™ï¼šè·å–å®¹å™¨ä¸­æ‰€æœ‰AdvisoråŠå°†æ¯ä¸ªAspectJåˆ‡é¢ç±»ä¸­çš„æ¯ä¸ªAdviceæ–¹æ³•å°è£…æˆçš„Advisor
         */</span>
        List<span class="token operator">&lt;</span>Advisor<span class="token operator">></span> candidateAdvisors <span class="token operator">=</span> <span class="token function">findCandidateAdvisors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è¿‡æ»¤ï¼Œæ‰¾åˆ°æ‰€æœ‰é€‚ç”¨è¯¥Beançš„Advisor</span>
        List<span class="token operator">&lt;</span>Advisor<span class="token operator">></span> eligibleAdvisors <span class="token operator">=</span> <span class="token function">findAdvisorsThatCanApply</span><span class="token punctuation">(</span>candidateAdvisors<span class="token punctuation">,</span> beanClass<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">/*
         * æ‰©å±•Advisorï¼Œå­ç±»é‡å†™
         * AnnotationAwareAspectJAutoProxyCreator#extendAdvisorsï¼šæ·»åŠ ä¸€ä¸ªExposeInvocationInterceptor
         */</span>
        <span class="token function">extendAdvisors</span><span class="token punctuation">(</span>eligibleAdvisors<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>eligibleAdvisors<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ’åº</span>
            eligibleAdvisors <span class="token operator">=</span> <span class="token function">sortAdvisors</span><span class="token punctuation">(</span>eligibleAdvisors<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> eligibleAdvisors<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>AnnotationAwareAspectJAutoProxyCreator#findCandidateAdvisors</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * ä»BeanFactoryä¸­è·å–æ‰€æœ‰çš„Advisorå’Œ@AspectJæ³¨è§£çš„Beanï¼Œå°è£…æˆAdvisoråˆ—è¡¨è¿”å›
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> List<span class="token operator">&lt;</span>Advisor<span class="token operator">></span> <span class="token function">findCandidateAdvisors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// é€šè¿‡çˆ¶ç±»AbstractAdvisorAutoProxyCreatoræŸ¥æ‰¾ï¼šBeanFactoryAdvisorRetrievalHelper#findAdvisorBeansä»å®¹å™¨ä¸­æŸ¥æ‰¾</span>
        List<span class="token operator">&lt;</span>Advisor<span class="token operator">></span> advisors <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">findCandidateAdvisors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// é€šè¿‡AspectJAdvisorsBuilderä»å®¹å™¨ä¸­è·å–æ‰€æœ‰@AspectJæ³¨è§£çš„Beanï¼Œå¹¶åŒ…è£…æˆAdvisoråŠ å…¥</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>aspectJAdvisorsBuilder <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            advisors<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>aspectJAdvisorsBuilder<span class="token punctuation">.</span><span class="token function">buildAspectJAdvisors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> advisors<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>AbstractAutoProxyCreator#findCandidateAdvisors</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * ä»BeanFactoryä¸­è·å–æ‰€æœ‰çš„Advisorï¼Œå­ç±»å¯é‡å†™
     */</span>
    <span class="token keyword">protected</span> List<span class="token operator">&lt;</span>Advisor<span class="token operator">></span> <span class="token function">findCandidateAdvisors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Assert<span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>advisorRetrievalHelper <span class="token operator">!=</span> null<span class="token punctuation">,</span> <span class="token string">"No BeanFactoryAdvisorRetrievalHelper available"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>advisorRetrievalHelper<span class="token punctuation">.</span><span class="token function">findAdvisorBeans</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>BeanFactoryAdvisorRetrievalHelper#findAdvisorBeans</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * ä»BeanFactoryä¸­æ‰¾æ‰€æœ‰ç¬¦åˆçš„Advisorï¼ˆé™¤å»FactoryBeanå’Œåˆ›å»ºä¸­çš„Beanï¼‰
     */</span>
    <span class="token keyword">public</span> List<span class="token operator">&lt;</span>Advisor<span class="token operator">></span> <span class="token function">findAdvisorBeans</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        String<span class="token punctuation">[</span><span class="token punctuation">]</span> advisorNames <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cachedAdvisorBeanNames<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¦‚æœç¼“å­˜ä¸ºç©ºï¼Œä»å®¹å™¨ä»¥åŠå…¶çˆ¶å®¹å™¨å¾—åˆ°æ‰€æœ‰AdvisorBeançš„åç§°</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>advisorNames <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">/*
             * ä»å½“å‰åŠçˆ¶BeanFactoryè·å–æ‰€æœ‰Advisorçš„BeanName
             * includeNonSingletons=trueï¼ŒåŒ…å«å•ä¾‹ï¼Œéå•ä¾‹Bean
             * allowEagerInit=falseï¼Œä¸åˆå§‹åŒ–æ‡’åŠ è½½çš„å•ä¾‹å’ŒFactoryBeanåˆ›å»ºçš„Bean
             */</span>
            advisorNames <span class="token operator">=</span> BeanFactoryUtils<span class="token punctuation">.</span><span class="token function">beanNamesForTypeIncludingAncestors</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">,</span> Advisor<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// åŠ å…¥ç¼“å­˜</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>cachedAdvisorBeanNames <span class="token operator">=</span> advisorNames<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>advisorNames<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å­˜æ”¾è¿”å›å€¼</span>
        List<span class="token operator">&lt;</span>Advisor<span class="token operator">></span> advisors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// éå†</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>String name <span class="token operator">:</span> advisorNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ£€æŸ¥æ˜¯å¦ç¬¦åˆæ¡ä»¶ï¼Œé»˜è®¤trueï¼Œå­ç±»å¯é‡å†™</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isEligibleBean</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å¿½ç•¥æ­£åœ¨åˆ›å»ºä¸­çš„Bean</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">.</span><span class="token function">isCurrentlyInCreation</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Skipping currently created advisor '"</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// ç¬¦åˆæ¡ä»¶</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// å®ä¾‹åŒ–ï¼ŒåŠ å…¥</span>
                        advisors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> Advisor<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeanCreationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        Throwable rootCause <span class="token operator">=</span> ex<span class="token punctuation">.</span><span class="token function">getMostSpecificCause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// å¦‚æœåˆ›å»ºè¿‡ç¨‹ä¸­é‡åˆ°å¼‚å¸¸æ˜¯å› ä¸ºå…¶ä¾èµ–Beanæ­£åœ¨åˆ›å»ºä¸­</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>rootCause <span class="token keyword">instanceof</span> <span class="token class-name">BeanCurrentlyInCreationException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            BeanCreationException bce <span class="token operator">=</span> <span class="token punctuation">(</span>BeanCreationException<span class="token punctuation">)</span> rootCause<span class="token punctuation">;</span>
                            String bceBeanName <span class="token operator">=</span> bce<span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>bceBeanName <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">.</span><span class="token function">isCurrentlyInCreation</span><span class="token punctuation">(</span>bceBeanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Skipping advisor '"</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">"' with dependency on currently created bean: "</span> <span class="token operator">+</span> ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                                <span class="token comment" spellcheck="true">// å…ˆå¿½ç•¥</span>
                                <span class="token keyword">continue</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment" spellcheck="true">// å…¶ä»–å¼‚å¸¸ï¼ŒæŠ›å‡ºå¼‚å¸¸å¹¶ä¸­æ–­æ–¹æ³•</span>
                        <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> advisors<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>BeanFactoryAspectJAdvisorsBuilder#buildAspectJAdvisors</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * ä»BeanFactoryä¸­è·å–æ‰€æœ‰è¢«@AspectJæ³¨è§£çš„Beanï¼Œå°†å…¶Adviceæ–¹æ³•åŒ…è£…æˆAdvisorè¿”å›
     */</span>
    <span class="token keyword">public</span> List<span class="token operator">&lt;</span>Advisor<span class="token operator">></span> <span class="token function">buildAspectJAdvisors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        List<span class="token operator">&lt;</span>String<span class="token operator">></span> aspectNames <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>aspectBeanNames<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ç¬¬ä¸€æ¬¡è¿›æ¥</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>aspectNames <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                aspectNames <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>aspectBeanNames<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>aspectNames <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    List<span class="token operator">&lt;</span>Advisor<span class="token operator">></span> advisors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    aspectNames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">/*
                     * è·å–æ‰€æœ‰ç±»å‹ä¸ºObjectçš„BeanNameï¼Œå°±æ˜¯æ‰€æœ‰çš„BeanName
                     * includeNonSingletons=trueï¼ŒåŒ…å«å•ä¾‹ï¼Œéå•ä¾‹Bean
                     * allowEagerInit=falseï¼Œä¸åˆå§‹åŒ–æ‡’åŠ è½½çš„å•ä¾‹å’ŒFactoryBeanåˆ›å»ºçš„Bean
                     */</span>
                    String<span class="token punctuation">[</span><span class="token punctuation">]</span> beanNames <span class="token operator">=</span> BeanFactoryUtils<span class="token punctuation">.</span><span class="token function">beanNamesForTypeIncludingAncestors</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">,</span> Object<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// éå†æ‰€æœ‰Bean</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span>String beanName <span class="token operator">:</span> beanNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// é»˜è®¤trueï¼Œå­ç±»å¯é‡å†™</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isEligibleBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">continue</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> beanType <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>beanType <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">continue</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment" spellcheck="true">// Beanè¢«@AspectJæ³¨è§£</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>advisorFactory<span class="token punctuation">.</span><span class="token function">isAspect</span><span class="token punctuation">(</span>beanType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// åŠ è¿›å»</span>
                            aspectNames<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// åˆ‡é¢å…ƒæ•°æ®</span>
                            AspectMetadata amd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AspectMetadata</span><span class="token punctuation">(</span>beanType<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// ä¸€èˆ¬éƒ½æ˜¯è¿™ä¸ª</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>amd<span class="token punctuation">.</span><span class="token function">getAjType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPerClause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getKind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> PerClauseKind<span class="token punctuation">.</span>SINGLETON<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                MetadataAwareAspectInstanceFactory factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BeanFactoryAspectInstanceFactory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token comment" spellcheck="true">// è§£æè¢«@AspectJæ³¨è§£çš„åˆ‡é¢ç±»çš„Adviceæ–¹æ³•ï¼Œæ¯ä¸ªæ„é€ æˆä¸€ä¸ªAdvisorï¼ŒåŒ…å«Pointcutå’ŒAdvice</span>
                                List<span class="token operator">&lt;</span>Advisor<span class="token operator">></span> classAdvisors <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>advisorFactory<span class="token punctuation">.</span><span class="token function">getAdvisors</span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token comment" spellcheck="true">// åˆ‡é¢ç±»æ˜¯å•ä¾‹</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    <span class="token keyword">this</span><span class="token punctuation">.</span>advisorsCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> classAdvisors<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                                    <span class="token keyword">this</span><span class="token punctuation">.</span>aspectFactoryCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                                advisors<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>classAdvisors<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Bean with name '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">"' is a singleton, but aspect instantiation model is not singleton"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                                MetadataAwareAspectInstanceFactory factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PrototypeAspectInstanceFactory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">this</span><span class="token punctuation">.</span>aspectFactoryCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                advisors<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>advisorFactory<span class="token punctuation">.</span><span class="token function">getAdvisors</span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>aspectBeanNames <span class="token operator">=</span> aspectNames<span class="token punctuation">;</span>
                    <span class="token keyword">return</span> advisors<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>aspectNames<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> Collections<span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ä»ç¼“å­˜è·å–è¿”å›</span>
        List<span class="token operator">&lt;</span>Advisor<span class="token operator">></span> advisors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>String aspectName <span class="token operator">:</span> aspectNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            List<span class="token operator">&lt;</span>Advisor<span class="token operator">></span> cachedAdvisors <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>advisorsCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>aspectName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cachedAdvisors <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                advisors<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>cachedAdvisors<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                MetadataAwareAspectInstanceFactory factory <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>aspectFactoryCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>aspectName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                advisors<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>advisorFactory<span class="token punctuation">.</span><span class="token function">getAdvisors</span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> advisors<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ReflectiveAspectJAdvisorFactory#getAdvisors</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> List<span class="token operator">&lt;</span>Advisor<span class="token operator">></span> <span class="token function">getAdvisors</span><span class="token punctuation">(</span>MetadataAwareAspectInstanceFactory aspectInstanceFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// è¢«@AspectJæ³¨è§£çš„é¡¶çº§ç±»</span>
        Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> aspectClass <span class="token operator">=</span> aspectInstanceFactory<span class="token punctuation">.</span><span class="token function">getAspectMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAspectClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è¢«@AspectJæ³¨è§£çš„ç±»å</span>
        String aspectName <span class="token operator">=</span> aspectInstanceFactory<span class="token punctuation">.</span><span class="token function">getAspectMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAspectName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// éªŒè¯</span>
        <span class="token function">validate</span><span class="token punctuation">(</span>aspectClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        MetadataAwareAspectInstanceFactory lazySingletonAspectInstanceFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LazySingletonAspectInstanceFactoryDecorator</span><span class="token punctuation">(</span>aspectInstanceFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        List<span class="token operator">&lt;</span>Advisor<span class="token operator">></span> advisors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ç”¨æˆ·å£°æ˜çš„æ²¡æœ‰è¢«è¢«@Pointcutæ³¨è§£çš„æ–¹æ³•</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>Method method <span class="token operator">:</span> <span class="token function">getAdvisorMethods</span><span class="token punctuation">(</span>aspectClass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è½¬ä¸ºAdvisorï¼Œè¿™é‡Œadvisors.size()ä¼šç»™Advisorä¸€ä¸ªé¡ºåº</span>
            Advisor advisor <span class="token operator">=</span> <span class="token function">getAdvisor</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> lazySingletonAspectInstanceFactory<span class="token punctuation">,</span> advisors<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> aspectName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>advisor <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                advisors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>advisor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>advisors<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> lazySingletonAspectInstanceFactory<span class="token punctuation">.</span><span class="token function">getAspectMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isLazilyInstantiated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Advisor instantiationAdvisor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyntheticInstantiationAdvisor</span><span class="token punctuation">(</span>lazySingletonAspectInstanceFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
            advisors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> instantiationAdvisor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// éå†åŸŸå˜é‡</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>Field field <span class="token operator">:</span> aspectClass<span class="token punctuation">.</span><span class="token function">getDeclaredFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å¦‚æœæœ‰@DeclareParentsæ³¨è§£å°±è½¬ä¸ºAdvisor</span>
            Advisor advisor <span class="token operator">=</span> <span class="token function">getDeclareParentsAdvisor</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>advisor <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                advisors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>advisor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> advisors<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ReflectiveAspectJAdvisorFactory#getAdvisor</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">public</span> Advisor <span class="token function">getAdvisor</span><span class="token punctuation">(</span>Method candidateAdviceMethod<span class="token punctuation">,</span> MetadataAwareAspectInstanceFactory aspectInstanceFactory<span class="token punctuation">,</span> <span class="token keyword">int</span> declarationOrderInAspect<span class="token punctuation">,</span> String aspectName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">validate</span><span class="token punctuation">(</span>aspectInstanceFactory<span class="token punctuation">.</span><span class="token function">getAspectMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAspectClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è·å¾—Pointcutè¡¨è¾¾å¼ï¼ŒåŒ…å«äº†æ–¹æ³•ä¸Šé¢çš„@Beforeï¼Œ@Aroundä¹‹ç±»çš„æ³¨è§£</span>
        AspectJExpressionPointcut expressionPointcut <span class="token operator">=</span> <span class="token function">getPointcut</span><span class="token punctuation">(</span>candidateAdviceMethod<span class="token punctuation">,</span> aspectInstanceFactory<span class="token punctuation">.</span><span class="token function">getAspectMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAspectClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>expressionPointcut <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// è¿”å›Advisorå°è£…ï¼Œå®ä¾‹åŒ–è¿‡ç¨‹ä¼šè°ƒç”¨instantiateAdviceå®ä¾‹åŒ–é€šçŸ¥ï¼ˆå¢å¼ºï¼‰Advice</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">InstantiationModelAwarePointcutAdvisorImpl</span><span class="token punctuation">(</span>expressionPointcut<span class="token punctuation">,</span> candidateAdviceMethod<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> aspectInstanceFactory<span class="token punctuation">,</span> declarationOrderInAspect<span class="token punctuation">,</span> aspectName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ReflectiveAspectJAdvisorFactory#getAdvice</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * å®ä¾‹åŒ–Advice
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">public</span> Advice <span class="token function">getAdvice</span><span class="token punctuation">(</span>Method candidateAdviceMethod<span class="token punctuation">,</span> AspectJExpressionPointcut expressionPointcut<span class="token punctuation">,</span> MetadataAwareAspectInstanceFactory aspectInstanceFactory<span class="token punctuation">,</span> <span class="token keyword">int</span> declarationOrder<span class="token punctuation">,</span> String aspectName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// è¢«@AspectJæ³¨è§£çš„é¡¶çº§ç±»</span>
        Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> candidateAspectClass <span class="token operator">=</span> aspectInstanceFactory<span class="token punctuation">.</span><span class="token function">getAspectMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAspectClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// éªŒè¯</span>
        <span class="token function">validate</span><span class="token punctuation">(</span>candidateAspectClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è¿”å›æ–¹æ³•ä¸Šé¢çš„@Beforeï¼Œ@Aroundä¹‹ç±»çš„æ³¨è§£</span>
        AspectJAnnotation<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> aspectJAnnotation <span class="token operator">=</span> AbstractAspectJAdvisorFactory<span class="token punctuation">.</span><span class="token function">findAspectJAnnotationOnMethod</span><span class="token punctuation">(</span>candidateAdviceMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ²¡æœ‰å°±è¿”å›</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>aspectJAnnotation <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ç±»å¿…é¡»è¢«@AspectJæ³¨è§£</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isAspect</span><span class="token punctuation">(</span>candidateAspectClass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AopConfigException</span><span class="token punctuation">(</span><span class="token string">"Advice must be declared inside an aspect type: "</span> <span class="token operator">+</span> <span class="token string">"Offending method '"</span> <span class="token operator">+</span> candidateAdviceMethod <span class="token operator">+</span> <span class="token string">"' in class ["</span> <span class="token operator">+</span> candidateAspectClass<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Found AspectJ method: "</span> <span class="token operator">+</span> candidateAdviceMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        AbstractAspectJAdvice springAdvice<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// switch</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>aspectJAnnotation<span class="token punctuation">.</span><span class="token function">getAnnotationType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> AtPointcut<span class="token operator">:</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Processing pointcut '"</span> <span class="token operator">+</span> candidateAdviceMethod<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> null<span class="token punctuation">;</span>
            <span class="token keyword">case</span> AtAround<span class="token operator">:</span>
                springAdvice <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AspectJAroundAdvice</span><span class="token punctuation">(</span>candidateAdviceMethod<span class="token punctuation">,</span> expressionPointcut<span class="token punctuation">,</span> aspectInstanceFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> AtBefore<span class="token operator">:</span>
                springAdvice <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AspectJMethodBeforeAdvice</span><span class="token punctuation">(</span>candidateAdviceMethod<span class="token punctuation">,</span> expressionPointcut<span class="token punctuation">,</span> aspectInstanceFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> AtAfter<span class="token operator">:</span>
                springAdvice <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AspectJAfterAdvice</span><span class="token punctuation">(</span>candidateAdviceMethod<span class="token punctuation">,</span> expressionPointcut<span class="token punctuation">,</span> aspectInstanceFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> AtAfterReturning<span class="token operator">:</span>
                springAdvice <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AspectJAfterReturningAdvice</span><span class="token punctuation">(</span>candidateAdviceMethod<span class="token punctuation">,</span> expressionPointcut<span class="token punctuation">,</span> aspectInstanceFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
                AfterReturning afterReturningAnnotation <span class="token operator">=</span> <span class="token punctuation">(</span>AfterReturning<span class="token punctuation">)</span> aspectJAnnotation<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>afterReturningAnnotation<span class="token punctuation">.</span><span class="token function">returning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    springAdvice<span class="token punctuation">.</span><span class="token function">setReturningName</span><span class="token punctuation">(</span>afterReturningAnnotation<span class="token punctuation">.</span><span class="token function">returning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> AtAfterThrowing<span class="token operator">:</span>
                springAdvice <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AspectJAfterThrowingAdvice</span><span class="token punctuation">(</span>candidateAdviceMethod<span class="token punctuation">,</span> expressionPointcut<span class="token punctuation">,</span> aspectInstanceFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
                AfterThrowing afterThrowingAnnotation <span class="token operator">=</span> <span class="token punctuation">(</span>AfterThrowing<span class="token punctuation">)</span> aspectJAnnotation<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils<span class="token punctuation">.</span><span class="token function">hasText</span><span class="token punctuation">(</span>afterThrowingAnnotation<span class="token punctuation">.</span><span class="token function">throwing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    springAdvice<span class="token punctuation">.</span><span class="token function">setThrowingName</span><span class="token punctuation">(</span>afterThrowingAnnotation<span class="token punctuation">.</span><span class="token function">throwing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token string">"Unsupported advice type on method: "</span> <span class="token operator">+</span> candidateAdviceMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        springAdvice<span class="token punctuation">.</span><span class="token function">setAspectName</span><span class="token punctuation">(</span>aspectName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è®¾ç½®é¡ºåº</span>
        springAdvice<span class="token punctuation">.</span><span class="token function">setDeclarationOrder</span><span class="token punctuation">(</span>declarationOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        String<span class="token punctuation">[</span><span class="token punctuation">]</span> argNames <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>parameterNameDiscoverer<span class="token punctuation">.</span><span class="token function">getParameterNames</span><span class="token punctuation">(</span>candidateAdviceMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>argNames <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            springAdvice<span class="token punctuation">.</span><span class="token function">setArgumentNamesFromStringArray</span><span class="token punctuation">(</span>argNames<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// ç»‘å®šå‚æ•°</span>
        springAdvice<span class="token punctuation">.</span><span class="token function">calculateArgumentBindings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> springAdvice<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>AbstractAdvisorAutoProxyCreator#findAdvisorsThatCanApply</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">protected</span> List<span class="token operator">&lt;</span>Advisor<span class="token operator">></span> <span class="token function">findAdvisorsThatCanApply</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>Advisor<span class="token operator">></span> candidateAdvisors<span class="token punctuation">,</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> beanClass<span class="token punctuation">,</span> String beanName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ä½¿ç”¨ThreadLocalä¿å­˜å½“å‰BeanName</span>
        ProxyCreationContext<span class="token punctuation">.</span><span class="token function">setCurrentProxiedBeanName</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è¿”å›éœ€è¦åº”ç”¨åˆ°è¯¥Beançš„Advisor</span>
            <span class="token keyword">return</span> AopUtils<span class="token punctuation">.</span><span class="token function">findAdvisorsThatCanApply</span><span class="token punctuation">(</span>candidateAdvisors<span class="token punctuation">,</span> beanClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å®Œæˆåæ¸…é™¤</span>
            ProxyCreationContext<span class="token punctuation">.</span><span class="token function">setCurrentProxiedBeanName</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>AopUtils#findAdvisorsThatCanApply</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> List<span class="token operator">&lt;</span>Advisor<span class="token operator">></span> <span class="token function">findAdvisorsThatCanApply</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>Advisor<span class="token operator">></span> candidateAdvisors<span class="token punctuation">,</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> clazz<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ç©º</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>candidateAdvisors<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> candidateAdvisors<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å­˜æ”¾åˆæ ¼çš„Advisor</span>
        List<span class="token operator">&lt;</span>Advisor<span class="token operator">></span> eligibleAdvisors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// éå†</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>Advisor candidate <span class="token operator">:</span> candidateAdvisors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">/*
             * å¼•ä»‹ &amp;&amp; åˆæ ¼
             * DefaultIntroductionAdvisorï¼šå¯¹åº”IntroductionInfo
             * DeclareParentsAdvisorï¼šå¯¹åº”@DeclareParents
             */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>candidate <span class="token keyword">instanceof</span> <span class="token class-name">IntroductionAdvisor</span> <span class="token operator">&amp;&amp;</span> <span class="token function">canApply</span><span class="token punctuation">(</span>candidate<span class="token punctuation">,</span> clazz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// åŠ </span>
                eligibleAdvisors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>candidate<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// æœ‰åˆæ ¼çš„å¼•ä»‹Advisorï¼Œä¸€èˆ¬æ²¡æœ‰</span>
        <span class="token keyword">boolean</span> hasIntroductions <span class="token operator">=</span> <span class="token operator">!</span>eligibleAdvisors<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>Advisor candidate <span class="token operator">:</span> candidateAdvisors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è·³è¿‡IntroductionAdvisorï¼Œä¸Šé¢éªŒè¯è¿‡äº†</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>candidate <span class="token keyword">instanceof</span> <span class="token class-name">IntroductionAdvisor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// éªŒè¯éIntroductionAdvisorï¼Œæ¯”å¦‚ä¹‹å‰AspectJçš„AdviceMethodè½¬åŒ–çš„InstantiationModelAwarePointcutAdvisorImpl</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">canApply</span><span class="token punctuation">(</span>candidate<span class="token punctuation">,</span> clazz<span class="token punctuation">,</span> hasIntroductions<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// åŠ </span>
                eligibleAdvisors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>candidate<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> eligibleAdvisors<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>AopUtils#canApply</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">canApply</span><span class="token punctuation">(</span>Advisor advisor<span class="token punctuation">,</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> targetClass<span class="token punctuation">,</span> <span class="token keyword">boolean</span> hasIntroductions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>advisor <span class="token keyword">instanceof</span> <span class="token class-name">IntroductionAdvisor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>IntroductionAdvisor<span class="token punctuation">)</span> advisor<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>targetClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// InstantiationModelAwarePointcutAdvisorImpl</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>advisor <span class="token keyword">instanceof</span> <span class="token class-name">PointcutAdvisor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            PointcutAdvisor pca <span class="token operator">=</span> <span class="token punctuation">(</span>PointcutAdvisor<span class="token punctuation">)</span> advisor<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ä¼ å…¥AspectJExpressionPointcut</span>
            <span class="token keyword">return</span> <span class="token function">canApply</span><span class="token punctuation">(</span>pca<span class="token punctuation">.</span><span class="token function">getPointcut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> targetClass<span class="token punctuation">,</span> hasIntroductions<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>AopUtils#canApply</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">canApply</span><span class="token punctuation">(</span>Pointcut pc<span class="token punctuation">,</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> targetClass<span class="token punctuation">,</span> <span class="token keyword">boolean</span> hasIntroductions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Assert<span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>pc<span class="token punctuation">,</span> <span class="token string">"Pointcut must not be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// JoinPointä¸åŒ¹é…ç›®æ ‡ç±»</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pc<span class="token punctuation">.</span><span class="token function">getClassFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>targetClass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        MethodMatcher methodMatcher <span class="token operator">=</span> pc<span class="token punctuation">.</span><span class="token function">getMethodMatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¤§æ¦‚å°±æ˜¯ç›´æ¥é€šè¿‡ä¸ç”¨åŒ¹é…å§</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>methodMatcher <span class="token operator">==</span> MethodMatcher<span class="token punctuation">.</span>TRUE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        IntroductionAwareMethodMatcher introductionAwareMethodMatcher <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>methodMatcher <span class="token keyword">instanceof</span> <span class="token class-name">IntroductionAwareMethodMatcher</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è½¬å‹</span>
            introductionAwareMethodMatcher <span class="token operator">=</span> <span class="token punctuation">(</span>IntroductionAwareMethodMatcher<span class="token punctuation">)</span> methodMatcher<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        Set<span class="token operator">&lt;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>></span> classes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ²¡è¢«JDKåŠ¨æ€ä»£ç†</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Proxy<span class="token punctuation">.</span><span class="token function">isProxyClass</span><span class="token punctuation">(</span>targetClass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è¢«CGLIBä»£ç†å°±è¿”å›çˆ¶ç±»ï¼Œå¦åˆ™åŸæ ·è¿”å›</span>
            classes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ClassUtils<span class="token punctuation">.</span><span class="token function">getUserClass</span><span class="token punctuation">(</span>targetClass<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// æ‰€æœ‰çˆ¶æ¥å£</span>
        classes<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>ClassUtils<span class="token punctuation">.</span><span class="token function">getAllInterfacesForClassAsSet</span><span class="token punctuation">(</span>targetClass<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// éå†</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> clazz <span class="token operator">:</span> classes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å£°æ˜çš„æ–¹æ³•</span>
            Method<span class="token punctuation">[</span><span class="token punctuation">]</span> methods <span class="token operator">=</span> ReflectionUtils<span class="token punctuation">.</span><span class="token function">getAllDeclaredMethods</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// éå†</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>Method method <span class="token operator">:</span> methods<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// åŒ¹é…ç›®æ ‡ç±»æ–¹æ³•</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>introductionAwareMethodMatcher <span class="token operator">!=</span> null <span class="token operator">?</span> introductionAwareMethodMatcher<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> targetClass<span class="token punctuation">,</span> hasIntroductions<span class="token punctuation">)</span> <span class="token operator">:</span> methodMatcher<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> targetClass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>AbstractAutoProxyCreator#createProxy</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">protected</span> Object <span class="token function">createProxy</span><span class="token punctuation">(</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> beanClass<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> String beanName<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> Object<span class="token punctuation">[</span><span class="token punctuation">]</span> specificInterceptors<span class="token punctuation">,</span> TargetSource targetSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory <span class="token keyword">instanceof</span> <span class="token class-name">ConfigurableListableBeanFactory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">/*
             * æš´éœ²ç›®æ ‡ç±»ï¼š
             * åœ¨BeanDefinitionè®¾ç½®å±æ€§org.springframework.aop.framework.autoproxy.AutoProxyUtils.originalTargetClassä¸ºåŸå§‹ç±»
             */</span>
            AutoProxyUtils<span class="token punctuation">.</span><span class="token function">exposeTargetClass</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ConfigurableListableBeanFactory<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beanFactory<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> beanClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// åˆ›å»ºProxyFactory</span>
        ProxyFactory proxyFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProxyFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¤åˆ¶åˆ°ProxyConfig</span>
        proxyFactory<span class="token punctuation">.</span><span class="token function">copyFrom</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¦‚æœè®¾ç½®proxyTargetClass=trueï¼Œåˆ™ä¸ç®¡æœ‰æ²¡æœ‰æ¥å£ï¼Œéƒ½ä½¿ç”¨CGLIBç”Ÿæˆä»£ç†ï¼ˆé»˜è®¤falseï¼‰</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>proxyFactory<span class="token punctuation">.</span><span class="token function">isProxyTargetClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldProxyTargetClass</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                proxyFactory<span class="token punctuation">.</span><span class="token function">setProxyTargetClass</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æœ‰å¯ä»£ç†æ¥å£ï¼Œæ·»åŠ åˆ°ProxyFactoryï¼Œæ²¡æœ‰æ¥å£ï¼ŒproxyFactory.setProxyTargetClass(true);</span>
                <span class="token function">evaluateProxyInterfaces</span><span class="token punctuation">(</span>beanClass<span class="token punctuation">,</span> proxyFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// é€‚ç”¨äºè¯¥Beançš„æ‰€æœ‰Advisorï¼šä»BeanFactoryè·å–é€šç”¨æ‹¦æˆªå™¨ï¼ˆé»˜è®¤ç©ºï¼‰ï¼ŒåŠ ä¸ŠåŒ¹é…è¯¥Beançš„ä¸“ç”¨æ‹¦æˆªå™¨ï¼ŒåŒ…è£…æˆAdvisorè¿”å›</span>
        Advisor<span class="token punctuation">[</span><span class="token punctuation">]</span> advisors <span class="token operator">=</span> <span class="token function">buildAdvisors</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> specificInterceptors<span class="token punctuation">)</span><span class="token punctuation">;</span>
        proxyFactory<span class="token punctuation">.</span><span class="token function">addAdvisors</span><span class="token punctuation">(</span>advisors<span class="token punctuation">)</span><span class="token punctuation">;</span>
        proxyFactory<span class="token punctuation">.</span><span class="token function">setTargetSource</span><span class="token punctuation">(</span>targetSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">customizeProxyFactory</span><span class="token punctuation">(</span>proxyFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// é»˜è®¤false</span>
        proxyFactory<span class="token punctuation">.</span><span class="token function">setFrozen</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>freezeProxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">advisorsPreFiltered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            proxyFactory<span class="token punctuation">.</span><span class="token function">setPreFiltered</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// åˆ›å»ºå½“å‰Beançš„ä»£ç†å¯¹è±¡</span>
        <span class="token keyword">return</span> proxyFactory<span class="token punctuation">.</span><span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token function">getProxyClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>DefaultAopProxyFactory#createAopProxy</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * åˆ›å»ºä»£ç†
     * å¦‚æœè¢«ä»£ç†çš„ç›®æ ‡ç±»å®ç°äº†è‡ªå®šä¹‰æ¥å£ï¼Œä½¿ç”¨JDKåŠ¨æ€ä»£ç†ï¼ˆåªæœ‰æ¥å£ä¸­çš„æ–¹æ³•ä¼šè¢«å¢å¼ºï¼‰
     * å¦‚æœæ²¡å®ç°ä»»ä½•æ¥å£ï¼Œä½¿ç”¨CGLIBå®ç°ä»£ç†ï¼ˆåŸºäºç±»ç»§æ‰¿ï¼Œæ–¹æ³•ä¸èƒ½æ˜¯finalæˆ–privateï¼‰
     * å¦‚æœè®¾ç½®äº†proxyTargetClass=trueï¼Œå…¨éƒ½ä½¿ç”¨CGLIB
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> AopProxy <span class="token function">createAopProxy</span><span class="token punctuation">(</span>AdvisedSupport config<span class="token punctuation">)</span> <span class="token keyword">throws</span> AopConfigException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Optimizeï¼Œé»˜è®¤false || proxy-target-class=true || æ²¡æœ‰å®ç°æ¥å£</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">isOptimize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> config<span class="token punctuation">.</span><span class="token function">isProxyTargetClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">hasNoUserSuppliedProxyInterfaces</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> targetClass <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">getTargetClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>targetClass <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AopConfigException</span><span class="token punctuation">(</span><span class="token string">"TargetSource cannot determine target class: "</span> <span class="token operator">+</span> <span class="token string">"Either an interface or a target is required for proxy creation."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å¦‚æœè¦ä»£ç†çš„ç±»æœ¬èº«å°±æ˜¯æ¥å£ï¼Œç”¨JDKåŠ¨æ€ä»£ç†</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>targetClass<span class="token punctuation">.</span><span class="token function">isInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> Proxy<span class="token punctuation">.</span><span class="token function">isProxyClass</span><span class="token punctuation">(</span>targetClass<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JdkDynamicAopProxy</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// CGLIB</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ObjenesisCglibAopProxy</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å¦‚æœæœ‰æ¥å£</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JdkDynamicAopProxy</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>JdkDynamicAopProxy#getProxy</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> Object <span class="token function">getProxy</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> ClassLoader classLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Creating JDK dynamic proxy: "</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>advised<span class="token punctuation">.</span><span class="token function">getTargetSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> proxiedInterfaces <span class="token operator">=</span> AopProxyUtils<span class="token punctuation">.</span><span class="token function">completeProxiedInterfaces</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>advised<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// éå†ç¡®å®šæœ‰æ²¡æœ‰å®ç°equalså’ŒhashCodeæ–¹æ³•å¹¶ç¼“å­˜</span>
        <span class="token function">findDefinedEqualsAndHashCodeMethods</span><span class="token punctuation">(</span>proxiedInterfaces<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è¿”å›ä»£ç†å¯¹è±¡</span>
        <span class="token keyword">return</span> Proxy<span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>classLoader<span class="token punctuation">,</span> proxiedInterfaces<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>JdkDynamicAopProxy#invoke</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">public</span> Object <span class="token function">invoke</span><span class="token punctuation">(</span>Object proxy<span class="token punctuation">,</span> Method method<span class="token punctuation">,</span> Object<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{</span>
        MethodInvocation invocation<span class="token punctuation">;</span>
        Object oldProxy <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> setProxyContext <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        TargetSource targetSource <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>advised<span class="token punctuation">.</span>targetSource<span class="token punctuation">;</span>
        Object target <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ²¡æœ‰å£°æ˜equalsæ–¹æ³• &amp;&amp; è°ƒç”¨equalsæ–¹æ³•</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>equalsDefined <span class="token operator">&amp;&amp;</span> AopUtils<span class="token punctuation">.</span><span class="token function">isEqualsMethod</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// è°ƒç”¨JdkDynamicAopProxyçš„equalsæ–¹æ³•</span>
                <span class="token keyword">return</span> <span class="token function">equals</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// æ²¡æœ‰å£°æ˜hashCodeæ–¹æ³• &amp;&amp; è°ƒç”¨hashCodeæ–¹æ³•</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>hashCodeDefined <span class="token operator">&amp;&amp;</span> AopUtils<span class="token punctuation">.</span><span class="token function">isHashCodeMethod</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// è°ƒç”¨JdkDynamicAopProxyçš„equalsæ–¹æ³•</span>
                <span class="token keyword">return</span> <span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// è°ƒç”¨çš„æ–¹æ³•æ˜¯DecoratingProxyå£°æ˜çš„æ–¹æ³•</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> DecoratingProxy<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// DecoratingProxyåªæœ‰ä¸€ä¸ªgetDecoratedClassæ–¹æ³•ï¼Œç›´æ¥è¿”å›è¢«è£…é¥°çš„Class</span>
                <span class="token keyword">return</span> AopProxyUtils<span class="token punctuation">.</span><span class="token function">ultimateTargetClass</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>advised<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ä»£ç†ä¸æ˜¯ä¸é€æ˜çš„ &amp;&amp; æ˜¯æ¥å£å£°æ˜çš„æ–¹æ³• &amp;&amp; å£°æ˜è¯¥æ–¹æ³•çš„æ¥å£ç»§æ‰¿äº†Advisedæ¥å£</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>advised<span class="token punctuation">.</span>opaque <span class="token operator">&amp;&amp;</span> method<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> method<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>Advised<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ç›´æ¥è°ƒç”¨</span>
                <span class="token keyword">return</span> AopUtils<span class="token punctuation">.</span><span class="token function">invokeJoinpointUsingReflection</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>advised<span class="token punctuation">,</span> method<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            Object retVal<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å¦‚æœæš´éœ²ä»£ç†ï¼Œé»˜è®¤false</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>advised<span class="token punctuation">.</span>exposeProxy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ThreadLocalä¿å­˜å½“å‰ä»£ç†å¯¹è±¡ï¼Œè¿”å›åŸæœ¬çš„ä»£ç†å¯¹è±¡</span>
                oldProxy <span class="token operator">=</span> AopContext<span class="token punctuation">.</span><span class="token function">setCurrentProxy</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
                setProxyContext <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            target <span class="token operator">=</span> targetSource<span class="token punctuation">.</span><span class="token function">getTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> targetClass <span class="token operator">=</span> <span class="token punctuation">(</span>target <span class="token operator">!=</span> null <span class="token operator">?</span> target<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">/*
             * éå†ï¼ŒæŠŠAdvisorä¸­çš„AdviceåŒ…è£…æˆInterceptor
             * ä»¥AspectJä¸ºä¾‹ï¼šAdvisor - Advice - MethodInterceptor
             * AspectJAroundAdviceï¼ŒAspectJAfterAdviceï¼ŒAtAfterThrowingç›´æ¥æ·»åŠ 
             * AspectJMethodBeforeAdviceï¼ŒAspectJAfterReturningAdviceé€šè¿‡å¯¹åº”AdvisorAdapteråŒ…è£…æˆMethodInterceptoræ·»åŠ åˆ°å°¾éƒ¨
             */</span>
            List<span class="token operator">&lt;</span>Object<span class="token operator">></span> chain <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>advised<span class="token punctuation">.</span><span class="token function">getInterceptorsAndDynamicInterceptionAdvice</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> targetClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å¦‚æœé“¾æ˜¯ç©º</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>chain<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Object<span class="token punctuation">[</span><span class="token punctuation">]</span> argsToUse <span class="token operator">=</span> AopProxyUtils<span class="token punctuation">.</span><span class="token function">adaptArgumentsIfNecessary</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ç›´æ¥åå°„è°ƒç”¨è¢«ä»£ç†å¯¹è±¡çš„æ–¹æ³•</span>
                retVal <span class="token operator">=</span> AopUtils<span class="token punctuation">.</span><span class="token function">invokeJoinpointUsingReflection</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> method<span class="token punctuation">,</span> argsToUse<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å¦åˆ™</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// åˆ›å»ºä¸€ä¸ªReflectiveMethodInvocation</span>
                invocation <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReflectiveMethodInvocation</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> target<span class="token punctuation">,</span> method<span class="token punctuation">,</span> args<span class="token punctuation">,</span> targetClass<span class="token punctuation">,</span> chain<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// æ‰§è¡Œé“¾å¼è°ƒç”¨ï¼Œå¾—åˆ°è¿”å›ç»“æœ</span>
                retVal <span class="token operator">=</span> invocation<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> returnType <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">getReturnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è¿”å›ç»“æœä¸ä¸ºnull &amp;&amp; è¿”å›ç»“æœæ˜¯thisï¼Œå³åŸå§‹å¯¹è±¡ &amp;&amp; æ–¹æ³•å£°æ˜ç±»æ²¡æœ‰æ ‡è®°ä¸ºRawTargetAccess(æ²¡ç»§æ‰¿RawTargetAccessæ¥å£)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>retVal <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> retVal <span class="token operator">==</span> target <span class="token operator">&amp;&amp;</span> returnType <span class="token operator">!=</span> Object<span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token operator">&amp;&amp;</span> returnType<span class="token punctuation">.</span><span class="token function">isInstance</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>RawTargetAccess<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// è¿”å›ä»£ç†å¯¹è±¡</span>
                retVal <span class="token operator">=</span> proxy<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>retVal <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> returnType <span class="token operator">!=</span> Void<span class="token punctuation">.</span>TYPE <span class="token operator">&amp;&amp;</span> returnType<span class="token punctuation">.</span><span class="token function">isPrimitive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AopInvocationException</span><span class="token punctuation">(</span><span class="token string">"Null return value from advice does not match primitive return type for: "</span> <span class="token operator">+</span> method<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> retVal<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>targetSource<span class="token punctuation">.</span><span class="token function">isStatic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                targetSource<span class="token punctuation">.</span><span class="token function">releaseTarget</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>setProxyContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æŠŠåŸæœ¬çš„ä»£ç†å¯¹è±¡è®¾å›å»</span>
                AopContext<span class="token punctuation">.</span><span class="token function">setCurrentProxy</span><span class="token punctuation">(</span>oldProxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>ReflectiveMethodInvocation#proceed</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">public</span> Object <span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// é“¾æ¥é“¾æ‰§è¡Œç»ˆç‚¹</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currentInterceptorIndex <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>interceptorsAndDynamicMethodMatchers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è°ƒç”¨è¢«ä»£ç†å¯¹è±¡çš„çœŸå®æ–¹æ³•ï¼Œé€’å½’ç»ˆæ­¢</span>
            <span class="token keyword">return</span> <span class="token function">invokeJoinpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// è·å–ä¸‹ä¸€ä¸ªæ‹¦æˆªå™¨</span>
        Object interceptorOrInterceptionAdvice <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>interceptorsAndDynamicMethodMatchers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token operator">++</span><span class="token keyword">this</span><span class="token punctuation">.</span>currentInterceptorIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// éœ€è¦åŠ¨æ€åŒ¹é…</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>interceptorOrInterceptionAdvice <span class="token keyword">instanceof</span> <span class="token class-name">InterceptorAndDynamicMethodMatcher</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è½¬å‹</span>
            InterceptorAndDynamicMethodMatcher dm <span class="token operator">=</span> <span class="token punctuation">(</span>InterceptorAndDynamicMethodMatcher<span class="token punctuation">)</span> interceptorOrInterceptionAdvice<span class="token punctuation">;</span>
            Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> targetClass <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>targetClass <span class="token operator">!=</span> null <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>targetClass <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>method<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// åŒ¹é…æˆåŠŸ</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>dm<span class="token punctuation">.</span>methodMatcher<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>method<span class="token punctuation">,</span> targetClass<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>arguments<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æ‰§è¡Œ</span>
                <span class="token keyword">return</span> dm<span class="token punctuation">.</span>interceptor<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// åŒ¹é…å¤±è´¥</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// è·³è¿‡ï¼Œé€’å½’æ‰§è¡Œä¸‹ä¸€ä¸ª</span>
                <span class="token keyword">return</span> <span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ç›´æ¥invoke</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ä¼ å…¥this</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>MethodInterceptor<span class="token punctuation">)</span> interceptorOrInterceptionAdvice<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>å‰é¢AbstractAdvisorAutoProxyCreator#findEligibleAdvisorsä¼šç»™Advisoræ’åºï¼Œé¡ºåºåœ¨ReflectiveAspectJAdvisorFactory#getAdvisorsè®¾ç½®ï¼Œæ–¹æ³•æ¥è‡ªReflectiveAspectJAdvisorFactory#getAdvisorMethodsï¼Œé¡ºåºæ˜¯@Aroundï¼Œ@Beforeï¼Œ@Afterï¼Œ@AfterReturningï¼Œ@AfterThrowingã€‚</p>
<p>å‡è®¾æœ‰ä¸¤ä¸ªåˆ‡é¢Aã€Bï¼Œæ¯ä¸ªåˆ‡é¢æœ‰@Aroundï¼Œ@Beforeï¼Œ@Afterï¼Œ@AfterReturningï¼Œ@AfterThrowingçš„æ–¹æ³•ï¼Œæ‰€æœ‰æ–¹æ³•ä»¥èŒè´£é“¾å½¢å¼è¿›è¡Œï¼š</p>
<pre class=" language-java"><code class="language-java">A <span class="token operator">-</span> AspectJAroundAdvice#invoke
    A <span class="token operator">-</span> <span class="token annotation punctuation">@Around</span>
        proceed
            A <span class="token operator">-</span> MethodBeforeAdviceInterceptor#invoke
                A <span class="token operator">-</span> AspectJMethodBeforeAdvice#before
                    A <span class="token operator">-</span> <span class="token annotation punctuation">@Before</span>
                proceed
                     A <span class="token operator">-</span> AspectJAfterAdvice#invoke
                        proceed
                            A <span class="token operator">-</span> AfterReturningAdviceInterceptor#invoke
                                proceed
                                    A <span class="token operator">-</span> AspectJAfterThrowingAdvice#invoke
                                        proceed
                                            B <span class="token operator">-</span> AspectJAroundAdvice#invoke
                                                B <span class="token operator">-</span> <span class="token annotation punctuation">@Around</span>
                                                    proceed
                                                        B <span class="token operator">-</span> MethodBeforeAdviceInterceptor#invoke
                                                            B <span class="token operator">-</span> AspectJMethodBeforeAdvice#before
                                                                B <span class="token operator">-</span> <span class="token annotation punctuation">@Before</span>
                                                            proceed
                                                                 B <span class="token operator">-</span> AspectJAfterAdvice#invoke
                                                                    proceed
                                                                        B <span class="token operator">-</span> AfterReturningAdviceInterceptor#invoke
                                                                            proceed
                                                                                B <span class="token operator">-</span> AspectJAfterThrowingAdvice#invoke
                                                                                    proceed
                                                                                        invokeJoinpoint
                                                                                    B <span class="token operator">-</span> <span class="token annotation punctuation">@AfterThrowing</span>
                                                                            B <span class="token operator">-</span> AspectJAfterReturningAdvice#afterReturning
                                                                                B <span class="token operator">-</span> <span class="token annotation punctuation">@AfterReturning</span>
                                                                    B <span class="token operator">-</span> <span class="token annotation punctuation">@After</span>
                                        A <span class="token operator">-</span> <span class="token annotation punctuation">@AfterThrowing</span>
                                A <span class="token operator">-</span> AspectJAfterReturningAdvice#afterReturning
                                    A <span class="token operator">-</span> <span class="token annotation punctuation">@AfterReturning</span>
                        A <span class="token operator">-</span> <span class="token annotation punctuation">@After</span></code></pre>
<hr>
<p>ä¸€èˆ¬AOPå¦‚æœæ‹¦æˆªçš„æ˜¯Controllerï¼Œå› ä¸ºæ²¡æœ‰æ¥å£ï¼Œæ‰€ä»¥ä½¿ç”¨CGLIBå­ç±»ç»§æ‰¿ä»£ç†çš„ï¼Œå¦‚æœæ˜¯Serviceï¼Œä¸€èˆ¬ç”¨JDKåŠ¨æ€ä»£ç†ï¼Œæ‰€ä»¥AOPæ€§èƒ½ç›¸å¯¹è¿˜æ˜¯æœ‰æŸè€—çš„ï¼Œè™½ç„¶SpringåŠ äº†ç¼“å­˜ã€‚</p>
<p>Springçš„AspectJé»˜è®¤åªæ˜¯ä½¿ç”¨äº†å‡ ä¸ªAspectJçš„æ³¨è§£ï¼Œå®é™…è¿˜æ˜¯è¿è¡Œæ—¶ç»‡å…¥ï¼Œå¦‚æœæƒ³è¿è¡Œå‰ç»‡å…¥ï¼Œéœ€è¦å¦å¤–é…ç½®ï¼Œä»£ç æ˜¯å…¼å®¹çš„ã€‚</p>
<p>ä»¥SpringBootä¸ºä¾‹ï¼š</p>
<pre class=" language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span>
<span class="token doctype">&lt;!DOCTYPE aspectj PUBLIC "-//AspectJ//DTD//EN" "http://www.eclipse.org/aspectj/dtd/aspectj.dtd"></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>aspectj</span><span class="token punctuation">></span></span>
    <span class="token comment" spellcheck="true">&lt;!-- è¦ç»‡å…¥åˆ‡é¢çš„ç›®æ ‡ç±» --></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>weaver</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include</span> <span class="token attr-name">within</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>org..*<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>weaver</span><span class="token punctuation">></span></span>
    <span class="token comment" spellcheck="true">&lt;!-- åˆ‡é¢ç±» --></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>aspects</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>aspect</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>org.XxxAspect<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>aspects</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>aspectj</span><span class="token punctuation">></span></span></code></pre>
<p>è¿è¡Œæ—¶éœ€è¦æŒ‡å®šJavaAgentå‚æ•°<code>-javaagent:spring-instrument-{version}.jar</code>ã€‚</p>
<p>æˆ–è€…Mavené…ç½®ï¼š</p>
<pre class=" language-xml"><code class="language-xml">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.maven.plugins<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>maven-surefire-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>argLine</span><span class="token punctuation">></span></span>
                    -javaagent:"${settings.localRepository}/org/aspectj/aspectjweaver/${aspectj.version}/aspectjweaver-${aspectj.version}.jar"
                    -javaagent:"${settings.localRepository}/org/springframework/spring-instrument/${spring.version}/spring-instrument-${spring.version}.jar"
                    <span class="token comment" spellcheck="true">&lt;!-- -Dspring.profiles.active=test --></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>argLine</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>agent</span><span class="token punctuation">></span></span>
                    ${settings.localRepository}/org/aspectj/aspectjweaver/${aspectj.version}/aspectjweaver-${aspectj.version}.jar
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>agent</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>agent</span><span class="token punctuation">></span></span>
                    ${settings.localRepository}/org/springframework/spring-instrument/${spring.version}/spring-instrument-${spring.version}.jar
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>agent</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">></span></span></code></pre>
<p>å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š<a href="https://blog.csdn.net/scorpio3k/article/details/6745443" target="_blank" rel="noopener">https://blog.csdn.net/scorpio3k/article/details/6745443</a></p>
<p>Agentæ˜¯æ‰§è¡Œmainæ–¹æ³•å‰çš„ä¸€ä¸ªInterceptorï¼ŒAgentä»£ç å’Œmainæ–¹æ³•åœ¨åŒä¸€ä¸ªJVMè¿è¡Œï¼Œè¢«åŒä¸€ä¸ªClassloaderè£…è½½ï¼Œè¢«åŒä¸€ä¸ªSecurityPolicyå’ŒContextç®¡ç†ã€‚</p>
<p>å®ç°ä¸€ä¸ªAgentåªéœ€è¦å®ç°premainæ–¹æ³•ï¼š<code>public static void premain(String agentArgs, Instrumentation inst)</code>ã€‚</p>
<p>Agentç±»å¿…é¡»æ‰“æˆ.jaråŒ…ï¼Œé‡Œé¢çš„<code>META-INF/MAINIFEST.MF</code>å¿…é¡»åŒ…å«<code>Premain-Class</code>å±æ€§ã€‚</p>
<p>MANIFEST.MF</p>
<pre><code>Manifest-Version: 1.0
Implementation-Title: spring-instrument
Automatic-Module-Name: spring.instrument
Premain-Class: org.springframework.instrument.InstrumentationSavingAge
 nt
Implementation-Version: 5.1.8.RELEASE
Agent-Class: org.springframework.instrument.InstrumentationSavingAgent
Can-Redefine-Classes: true
Can-Retransform-Classes: true
Can-Set-Native-Method-Prefix: false
Created-By: 1.8.0_212 (Oracle Corporation)</code></pre><p>spring-instrument.jar: InstrumentationSavingAgent</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">InstrumentationSavingAgent</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">volatile</span> Instrumentation instrumentation<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token function">InstrumentationSavingAgent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">premain</span><span class="token punctuation">(</span>String agentArgs<span class="token punctuation">,</span> Instrumentation inst<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// åªæ˜¯æš´éœ²å‡ºæ¥</span>
        <span class="token comment" spellcheck="true">// é€šè¿‡Instrumentationï¼Œå¯ä»¥æ·»åŠ è‡ªå®šä¹‰çš„ClassFileTransformerï¼Œæ¥æ”¹å˜.classï¼Œä¸ä¿®æ”¹åŸæœ‰çš„ä»£ç è¿›è¡Œå¢å¼º</span>
        instrumentation <span class="token operator">=</span> inst<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">agentmain</span><span class="token punctuation">(</span>String agentArgs<span class="token punctuation">,</span> Instrumentation inst<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        instrumentation <span class="token operator">=</span> inst<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> Instrumentation <span class="token function">getInstrumentation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> instrumentation<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>EnableLoadTimeWeaving</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span>ElementType<span class="token punctuation">.</span>TYPE<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span>RetentionPolicy<span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Documented</span>
<span class="token annotation punctuation">@Import</span><span class="token punctuation">(</span>LoadTimeWeavingConfiguration<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// å¯¼å…¥</span>
<span class="token keyword">public</span> @<span class="token keyword">interface</span> <span class="token class-name">EnableLoadTimeWeaving</span> <span class="token punctuation">{</span>

    AspectJWeaving <span class="token function">aspectjWeaving</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> AspectJWeaving<span class="token punctuation">.</span>AUTODETECT<span class="token punctuation">;</span>

    <span class="token keyword">enum</span> AspectJWeaving <span class="token punctuation">{</span>

        ENABLED<span class="token punctuation">,</span>

        DISABLED<span class="token punctuation">,</span>
        <span class="token comment" spellcheck="true">/**
         * è‡ªåŠ¨æ£€æµ‹ï¼Œå¦‚æœç±»è·¯å¾„ä¸‹æœ‰META-INF/aop.xmlï¼Œå¼€å¯
         */</span>
        AUTODETECT<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span></code></pre>
<p>LoadTimeWeavingConfiguration#loadTimeWeaver</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> ConfigurableApplicationContext<span class="token punctuation">.</span>LOAD_TIME_WEAVER_BEAN_NAME<span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Role</span><span class="token punctuation">(</span>BeanDefinition<span class="token punctuation">.</span>ROLE_INFRASTRUCTURE<span class="token punctuation">)</span>
    <span class="token keyword">public</span> LoadTimeWeaver <span class="token function">loadTimeWeaver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Assert<span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanClassLoader <span class="token operator">!=</span> null<span class="token punctuation">,</span> <span class="token string">"No ClassLoader set"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        LoadTimeWeaver loadTimeWeaver <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>ltwConfigurer <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ç”¨æˆ·æä¾›äº†è‡ªå®šä¹‰çš„LoadTimeWeaverå®ä¾‹</span>
            loadTimeWeaver <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ltwConfigurer<span class="token punctuation">.</span><span class="token function">getLoadTimeWeaver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>loadTimeWeaver <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ²¡æœ‰å°±é»˜è®¤DefaultContextLoadTimeWeaver</span>
            loadTimeWeaver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultContextLoadTimeWeaver</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanClassLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>enableLTW <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            AspectJWeaving aspectJWeaving <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>enableLTW<span class="token punctuation">.</span><span class="token function">getEnum</span><span class="token punctuation">(</span><span class="token string">"aspectjWeaving"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>aspectJWeaving<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> DISABLED<span class="token operator">:</span>
                    <span class="token comment" spellcheck="true">// AJ weaving is disabled -> do nothing</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> AUTODETECT<span class="token operator">:</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanClassLoader<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span>AspectJWeavingEnabler<span class="token punctuation">.</span>ASPECTJ_AOP_XML_RESOURCE<span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// No aop.xml present on the classpath -> treat as 'disabled'</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// aop.xml is present on the classpath -> enable</span>
                    AspectJWeavingEnabler<span class="token punctuation">.</span><span class="token function">enableAspectJWeaving</span><span class="token punctuation">(</span>loadTimeWeaver<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beanClassLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> ENABLED<span class="token operator">:</span>
                    AspectJWeavingEnabler<span class="token punctuation">.</span><span class="token function">enableAspectJWeaving</span><span class="token punctuation">(</span>loadTimeWeaver<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>beanClassLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> loadTimeWeaver<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>DefaultContextLoadTimeWeaver#setBeanClassLoader</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setBeanClassLoader</span><span class="token punctuation">(</span>ClassLoader classLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        LoadTimeWeaver serverSpecificLoadTimeWeaver <span class="token operator">=</span> <span class="token function">createServerSpecificLoadTimeWeaver</span><span class="token punctuation">(</span>classLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// WebæœåŠ¡å™¨</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>serverSpecificLoadTimeWeaver <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>loadTimeWeaver <span class="token operator">=</span> serverSpecificLoadTimeWeaver<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// spring-instrument.jar -javaagent</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>InstrumentationLoadTimeWeaver<span class="token punctuation">.</span><span class="token function">isInstrumentationAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Found Spring's JVM agent for instrumentation"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>loadTimeWeaver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InstrumentationLoadTimeWeaver</span><span class="token punctuation">(</span>classLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// é»˜è®¤sun.misc.Launcher.AppClassLoader</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>loadTimeWeaver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReflectiveLoadTimeWeaver</span><span class="token punctuation">(</span>classLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalStateException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" Specify a custom LoadTimeWeaver or start your "</span> <span class="token operator">+</span> <span class="token string">"Java virtual machine with Spring's agent: -javaagent:spring-instrument-{version}.jar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>AspectJWeavingEnabler#enableAspectJWeaving</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">enableAspectJWeaving</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> LoadTimeWeaver weaverToUse<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> ClassLoader beanClassLoader<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>weaverToUse <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>InstrumentationLoadTimeWeaver<span class="token punctuation">.</span><span class="token function">isInstrumentationAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                weaverToUse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InstrumentationLoadTimeWeaver</span><span class="token punctuation">(</span>beanClassLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"No LoadTimeWeaver available"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ClassFileTransformer</span>
        weaverToUse<span class="token punctuation">.</span><span class="token function">addTransformer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AspectJClassBypassingClassFileTransformer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClassPreProcessorAgentAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>InstrumentationLoadTimeWeaver#addTransformer</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * new AspectJClassBypassingClassFileTransformer(new ClassPreProcessorAgentAdapter())
     * å…·ä½“çš„ç±»åŠ è½½å¤„ç†ç”±AspectJæ¥ç®¡
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addTransformer</span><span class="token punctuation">(</span>ClassFileTransformer transformer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Assert<span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>transformer<span class="token punctuation">,</span> <span class="token string">"Transformer must not be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        FilteringClassFileTransformer actualTransformer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FilteringClassFileTransformer</span><span class="token punctuation">(</span>transformer<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>classLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>transformers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Assert<span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>instrumentation <span class="token operator">!=</span> null<span class="token punctuation">,</span> <span class="token string">"Must start with Java agent to use InstrumentationLoadTimeWeaver. See Spring documentation."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>instrumentation<span class="token punctuation">.</span><span class="token function">addTransformer</span><span class="token punctuation">(</span>actualTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>transformers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>actualTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š <a href="https://www.cnblogs.com/hackem/p/9718311.html" target="_blank" rel="noopener">https://www.cnblogs.com/hackem/p/9718311.html</a></p>
<p>AbstractBeanFactory#doResolveBeanClass</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * é€‰æ‹©ä¸åŒçš„ClassLoaderåŠ è½½ç±»ï¼ŒbeanClassLoaderå’ŒtempClassLoaderï¼Œå’ŒAspectJæœ‰å…³
     */</span>
    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">private</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> <span class="token function">doResolveBeanClass</span><span class="token punctuation">(</span>RootBeanDefinition mbd<span class="token punctuation">,</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> typesToMatch<span class="token punctuation">)</span> <span class="token keyword">throws</span> ClassNotFoundException <span class="token punctuation">{</span>
        ClassLoader beanClassLoader <span class="token operator">=</span> <span class="token function">getBeanClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ClassLoader dynamicLoader <span class="token operator">=</span> beanClassLoader<span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> freshResolve <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¦‚æœä¸ä¸ºç©º</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ObjectUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>typesToMatch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">/*
             * åªæ˜¯ç±»å‹æ£€æŸ¥çš„æ—¶å€™ï¼ˆä¸åˆ›å»ºå®ä¾‹ï¼‰ï¼Œä½¿ç”¨è¿™ä¸ªæš‚æ—¶çš„Classloader(ç»‡å…¥)
             * ä¸€ä¸ªClassLoaderå¯¹ä¸€ä¸ªClassåªåŠ è½½ä¸€æ¬¡ï¼Œé˜²æ­¢LoadTimeWeaverè¿˜æ²¡æ‰§è¡Œï¼Œç±»å°±è¢«åŠ è½½äº†ï¼Œæ²¡è¢«AOPæ‹¦æˆªå¢å¼º
             * tempClassLoaderè®¾ç½®ï¼šbeanFactory.setTempClassLoader(new ContextTypeMatchClassLoader(beanFactory.getBeanClassLoader()));
             * æ—¶æœºï¼š
             *      Xmlï¼šAbstractApplicationContext#prepareBeanFactory
             *      Annotationï¼šAbstractApplicationContext#invokeBeanFactoryPostProcessors
             */</span>
            ClassLoader tempClassLoader <span class="token operator">=</span> <span class="token function">getTempClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>tempClassLoader <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                dynamicLoader <span class="token operator">=</span> tempClassLoader<span class="token punctuation">;</span>
                freshResolve <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>tempClassLoader <span class="token keyword">instanceof</span> <span class="token class-name">DecoratingClassLoader</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    DecoratingClassLoader dcl <span class="token operator">=</span> <span class="token punctuation">(</span>DecoratingClassLoader<span class="token punctuation">)</span> tempClassLoader<span class="token punctuation">;</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> typeToMatch <span class="token operator">:</span> typesToMatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        dcl<span class="token punctuation">.</span><span class="token function">excludeClass</span><span class="token punctuation">(</span>typeToMatch<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ...</span>
    <span class="token punctuation">}</span></code></pre>
<p>è¿™ç§æ–¹å¼çš„@Aspectæ³¨è§£çš„åˆ‡é¢ç±»ä¸åœ¨BeanFactoryå†…ï¼Œæ‰€ä»¥ä¸è¦åŠ @Componentä¹‹ç±»çš„æ·»åŠ è¿›å®¹å™¨ã€‚</p>
<p>Springåœ¨åŠ è½½ç›®æ ‡ç±»çš„.classæ–‡ä»¶åˆ°JVMä¹‹å‰ï¼ŒAspectJä¼šå°†åˆ‡é¢ç±»ä¸­çš„å¢å¼ºé€»è¾‘ç»‡å…¥åˆ°.classæ–‡ä»¶ä¸­ï¼Œç”Ÿæˆæ–°çš„.classå­—èŠ‚ç ï¼Œæ‰€ä»¥ä¸éœ€è¦åŠ¨æ€ä»£ç†å°±èƒ½å®ç°AOPã€‚</p>
<p>åœ¨ç±»åŠ è½½æœŸï¼Œæ³¨å†Œçš„ClassFileTransformerè¯»å–ç±»è·¯å¾„ä¸‹META-INF/aop.xmlæ–‡ä»¶ä¸­å®šä¹‰çš„åˆ‡é¢ç±»å’Œç›®æ ‡ç±»ä¿¡æ¯ï¼Œç”Ÿæˆæ–°çš„.classå­—èŠ‚ç ï¼Œç„¶åäº¤ç»™JVMåŠ è½½ã€‚</p>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


        <footer>
             
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

        </footer>
    </div>
    <!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
    <script>
        var timeEnd = new Date();
        console.log('è€—æ—¶ï¼š' + (timeEnd - timeStart));
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre').forEach((block) => {
                block.classList.add("line-numbers");
            });
        });
    </script>
    <!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
    <!-- material design -->
    <!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
    <!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
    <!-- toc -->
    <!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
    <!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
    <!-- <script src="/js/main.js"></script> -->
    <script src="/js/prism.js"></script>
</body>
</html>
