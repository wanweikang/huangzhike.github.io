<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
        <script>
            var timeStart = new Date();
        </script>
        
        <title>[ç¬”è®°]-Spring Framework-IoC-Xml | ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜</title>
        
        <meta name="author" content="huangzhike">
        
        
        <meta name="description" content="Springç‰ˆæœ¬ï¼š5.2.0-SNAPSHOT

Xml
FileSystemXmlApplicationContext / ClassPathXmlApplicationContext
-&gt; AbstractXmlApplicationContext
-&gt; AbstractRefreshableC">
        
        
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        
        <meta property="og:title" content="[ç¬”è®°]-Spring Framework-IoC-Xml"/>
        
        <meta property="og:site_name" content="ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜"/>
        
        
        <!-- favicon -->
        <link rel="icon" type="image/ico" href="/ok.ico" sizes="32x32">
        <meta name="msapplication-TileColor" content="#009688">
        <meta name="msapplication-TileImage" content="/mstile-144x144.ico">
        <meta name="theme-color" content="#009688">
        <!-- favicon end -->
        <!-- <link href="//ok.ico" rel="icon"> -->
        
        <!-- toc -->
        <!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
        <!-- material design -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
        <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
        
        <!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
        <!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
    <meta name="generator" content="Hexo 4.2.1"></head>

<body>
    <nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">èœå•</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" title="ä¸‹ä¸€å¥æ˜¯ï¼šå®¢æœ‰å¯äººæœŸä¸æ¥ã€‚å°æ—¶å€™ï¼Œå–œæ¬¢é åœ¨é˜³å°ä¸Šï¼Œä¸€è¾¹å¹é£ï¼Œä¸€è¾¹çœ‹ä¹¦ï¼Œå–œæ¬¢è¯»ä¹¦å—ï¼Œéªšå¹´ï¼Ÿ" href="/">ä¹¦å½“å¿«æ„è¯»æ˜“å°½</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" target="_blank" rel="noopener" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

    <div class="container" >
        <div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[ç¬”è®°]-Spring Framework-IoC-Xml</h2>
				
				<div>
					<div class="post-time">2019-08-09</div>
				</div>
				
				<div class="article-content">
				<p>Springç‰ˆæœ¬ï¼š5.2.0-SNAPSHOT</p>
<hr>
<p>Xml</p>
<pre class=" language-java"><code class="language-java">FileSystemXmlApplicationContext <span class="token operator">/</span> ClassPathXmlApplicationContext
<span class="token operator">-</span><span class="token operator">></span> AbstractXmlApplicationContext
<span class="token operator">-</span><span class="token operator">></span> AbstractRefreshableConfigApplicationContext
<span class="token operator">-</span><span class="token operator">></span> AbstractRefreshableApplicationContext
<span class="token operator">-</span><span class="token operator">></span> AbstractApplicationContext
<span class="token operator">-</span><span class="token operator">></span> ConfigurableApplicationContext
<span class="token operator">-</span><span class="token operator">></span> ApplicationContext
<span class="token operator">-</span><span class="token operator">></span> BeanFactory</code></pre>
<p>AbstractApplicationContext#refresh</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> BeansException<span class="token punctuation">,</span> IllegalStateException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// åŠ é”</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>startupShutdownMonitor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å‡†å¤‡åˆ·æ–°ï¼Œç”ŸæˆEnvironmentï¼Œç•¥</span>
            <span class="token function">prepareRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">/*
             * XMLï¼š
             *      é”€æ¯BeanFactoryï¼Œå†é‡æ–°åˆå§‹åŒ–
             *      è§£æXMLé…ç½®æˆBeanDefinitionï¼Œæ³¨å†Œåˆ°BeanFactoryï¼Œæ˜ å°„beanNameåˆ°beanDefinitionï¼Œæ˜ å°„aliasåˆ°beanNameï¼ŒBeanæœªåˆå§‹åŒ–
             * æ³¨è§£ï¼š
             *      BeanFactoryåœ¨ApplicationContextå®ä¾‹åŒ–æ—¶ä¸€èµ·å®ä¾‹åŒ–ï¼Œä¸é”€æ¯ï¼Œåªæ˜¯åŠ ä¸ªæ›´æ–°æ ‡è®°
             */</span>
            ConfigurableListableBeanFactory beanFactory <span class="token operator">=</span> <span class="token function">obtainFreshBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">/*
             * å‡†å¤‡BeanFactoryï¼š
             *       è®¾ç½®BeanFactoryçš„ç±»åŠ è½½å™¨ä¸ºåŠ è½½å½“å‰ApplicationContextç±»çš„ç±»åŠ è½½å™¨
             *       å®ä¾‹åŒ–å¹¶æ·»åŠ å‡ ä¸ªBeanPostProcessorï¼š
             *           æ·»åŠ ApplicationContextAwareProcessoråˆ°beanPostProcessorsåˆ—è¡¨,è´Ÿè´£Awareæ¥å£çš„Beanåˆå§‹åŒ–å›è°ƒ
             *       å¦‚æœBeanFactoryåŒ…å«LOAD_TIME_WEAVERçš„Beanï¼š
             *           å®ä¾‹åŒ–LoadTimeWeaverAwareProcessorå¹¶æ·»åŠ ï¼ŒåŒæ—¶ç»™BeanFactoryè®¾ç½®ä¸´æ—¶ç±»åŠ è½½å™¨ï¼Œé¿å…ç±»å‹åŒ¹é…æ—¶æå‰åŠ è½½ç±»
             *       å¦‚æœBeanFactoryæœªåŒ…å«ï¼Œæ·»åŠ å‡ ä¸ªå•ä¾‹Beanï¼ˆEnvironmentç­‰åŠ å…¥BeanFactoryï¼‰
             */</span>
            <span class="token function">prepareBeanFactory</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å­ç±»é‡å†™</span>
                <span class="token function">postProcessBeanFactory</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">/*
                 * å¯¹å·²å®ä¾‹åŒ–æ·»åŠ çš„BeanDefinitionRegistryPostProcessor
                 *      éå†å·²å®ä¾‹åŒ–æ·»åŠ çš„BeanFactoryPostProcessorï¼Œå¦‚æœæ˜¯BeanDefinitionRegistryPostProcessorå®ä¾‹ï¼Œè°ƒç”¨postProcessBeanDefinitionRegistry
                 * å¯¹æœªå®ä¾‹åŒ–çš„BeanDefinitionRegistryPostProcessor
                 *      ä»beanDefinitionNameså’ŒmanualSingletonNamesè·å–å·²æ³¨å†Œçš„BeanDefinitionRegistryPostProcessorç±»å‹çš„beanName
                 *      æŒ‰ç…§æ˜¯å¦å®ç°äº†PriorityOrderedã€Orderedæ¥å£çš„é¡ºåºï¼Œåˆ†ä¸‰æ‰¹è°ƒç”¨BeanFactory#getBeanå®ä¾‹åŒ–ï¼Œè°ƒç”¨postProcessBeanDefinitionRegistry
                 * éå†æ‰€æœ‰å·²å®ä¾‹åŒ–çš„BeanDefinitionRegistryPostProcessorç±»å‹çš„BeanFactoryPostProcessorï¼Œè°ƒç”¨postProcessBeanFactory
                 * éå†æ‰€æœ‰å·²å®ä¾‹åŒ–çš„éBeanDefinitionRegistryPostProcessorç±»å‹çš„BeanFactoryPostProcessorï¼Œè°ƒç”¨postProcessBeanFactory
                 * å¯¹æœªå®ä¾‹åŒ–çš„BeanFactoryPostProcessor
                 *      ä»beanDefinitionNameså’ŒmanualSingletonNamesè·å–å·²æ³¨å†Œçš„BeanFactoryPostProcessorç±»å‹çš„beanNameï¼Œéå†ï¼Œè·³è¿‡ä¸Šé¢å·²å¤„ç†è¿‡çš„BeanFactoryPostProcessor
                 *      æŒ‰ç…§æ˜¯å¦å®ç°äº†PriorityOrderedã€Orderedæ¥å£çš„é¡ºåºï¼Œåˆ†ä¸‰æ‰¹è°ƒç”¨BeanFactory#getBeanå®ä¾‹åŒ–ï¼Œè°ƒç”¨postProcessBeanDefinitionRegistry
                 * å¦‚æœBeanFactoryåŒ…å«LOAD_TIME_WEAVERçš„Beanå¹¶ä¸”æ²¡è®¾ç½®ä¸´æ—¶ç±»åŠ è½½å™¨ï¼š
                 *      å®ä¾‹åŒ–LoadTimeWeaverAwareProcessorå¹¶æ·»åŠ ï¼ŒåŒæ—¶ç»™BeanFactoryè®¾ç½®ä¸´æ—¶ç±»åŠ è½½å™¨ï¼Œé¿å…ç±»å‹åŒ¹é…æ—¶æå‰åŠ è½½ç±»
                 */</span>
                <span class="token function">invokeBeanFactoryPostProcessors</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">/*
                 * æ³¨å†ŒBeanPostProcessorçš„å®ç°ç±»ï¼ŒpostProcessBeforeInitializationã€postProcessAfterInitializationåˆ†åˆ«ä¼šåœ¨Beanåˆå§‹åŒ–å‰åæ‰§è¡Œ
                 *      ä»beanDefinitionNameså’ŒmanualSingletonNamesè·å–å·²æ³¨å†Œçš„BeanPostProcessorçš„beanName
                 *      æŒ‰ç…§æ˜¯å¦å®ç°äº†PriorityOrderedã€Orderedæ¥å£çš„é¡ºåºï¼Œåˆ†ä¸‰æ‰¹è°ƒç”¨BeanFactory#getBeanå®ä¾‹åŒ–ï¼Œå¹¶æ·»åŠ å®ä¾‹åˆ°BeanFactoryçš„beanPostProcessors
                 *      å¯¹äºå®ç°äº†MergedBeanDefinitionPostProcessoræ¥å£çš„ï¼Œå†è¦†ç›–æ·»åŠ å®ä¾‹åˆ°BeanFactoryçš„beanPostProcessors
                 *      è¦†ç›–æ·»åŠ æ–°çš„ApplicationListenerDetectoråˆ°BeanFactoryçš„beanPostProcessors
                 */</span>
                <span class="token function">registerBeanPostProcessors</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// åˆå§‹åŒ–MessageSourceï¼Œå›½é™…åŒ–ï¼Œç•¥</span>
                <span class="token function">initMessageSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// åˆå§‹åŒ–å½“å‰ApplicationContextçš„äº‹ä»¶å¹¿æ’­å™¨ï¼Œç•¥</span>
                <span class="token function">initApplicationEventMulticaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// æ¨¡æ¿æ–¹æ³•ï¼Œå­ç±»é‡å†™</span>
                <span class="token function">onRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">/*
                 * æ·»åŠ å·²æœ‰çš„ApplicationListeneråˆ°å½“å‰çš„äº‹ä»¶å¹¿æ’­å™¨
                 * ä»beanDefinitionNameså’ŒmanualSingletonNamesè·å–å·²æ³¨å†Œçš„ApplicationListenerçš„beanNameï¼Œæ·»åŠ åç§°åˆ°å½“å‰çš„äº‹ä»¶å¹¿æ’­å™¨
                 * é€šè¿‡äº‹ä»¶å¹¿æ’­å™¨å¹¿æ’­earlyApplicationEvents
                 */</span>
                <span class="token function">registerListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">/*
                 * å¦‚æœsingletonObjectsæˆ–beanDefinitionMapåŒ…å«åä¸ºconversionServiceçš„Beanï¼ŒBeanFactory#getBeanåˆå§‹åŒ–ï¼Œå¹¶ä¸ºå½“å‰BeanFactoryè®¾ç½®ConversionService
                 * å¦‚æœæœ€åè¿˜æ²¡æœ‰å†…ç½®çš„EmbeddedValueResolverï¼Œæ·»åŠ ä¸€ä¸ªStringValueResolverè¿›å»ï¼Œæ³¨å…¥ä¾èµ–æ—¶ç”¨æ¥è§£æ@Value(value = "${xxx.xxx}")
                 * ä»beanDefinitionNameså’ŒmanualSingletonNamesè·å–å·²æ³¨å†Œçš„LoadTimeWeaverAwareçš„beanNameï¼Œè°ƒç”¨BeanFactory#getBeanåˆå§‹åŒ–
                 * ç½®ç©ºä¸´æ—¶ç±»åŠ è½½å™¨
                 * åˆå§‹åŒ–å‰©ä¸‹æ‰€æœ‰éæ‡’åŠ è½½çš„å•ä¾‹ï¼Œå¦‚æœBeanå®ç°äº†SmartInitializingSingletonæ¥å£ï¼Œè§¦å‘afterSingletonsInstantiatedå›è°ƒ
                 */</span>
                <span class="token function">finishBeanFactoryInitialization</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">/*
                 * åˆå§‹åŒ–LifecycleProcessorï¼Œæ·»åŠ åˆ°BeanFactoryï¼Œè°ƒç”¨LifecycleProcessorçš„onRefresh
                 * é€šè¿‡é€šè¿‡äº‹ä»¶å¹¿æ’­å™¨å¹¿æ’­ContextRefreshedEvent
                 * å­ç±»å¯é‡å†™
                 */</span>
                <span class="token function">finishRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeansException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isWarnEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Exception encountered during context initialization - "</span> <span class="token operator">+</span> <span class="token string">"cancelling refresh attempt: "</span> <span class="token operator">+</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// é”€æ¯å·²åˆå§‹åŒ–çš„å•ä¾‹ï¼Œé¿å…å ç”¨èµ„æº</span>
                <span class="token function">destroyBeans</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// Reset 'active' flag.</span>
                <span class="token function">cancelRefresh</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ä¼ æ’­å¼‚å¸¸ç»™è°ƒç”¨è€…</span>
                <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Reset common introspection caches in Spring's core, since we</span>
                <span class="token comment" spellcheck="true">// might not ever need metadata for singleton beans anymore...</span>
                <span class="token function">resetCommonCaches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<ul>
<li><p>XmlBeanDefinitionReaderï¼šå°†Xmlè§£ææˆä¸ºDocument</p>
</li>
<li><p>BeanDefinitionDocumentReaderï¼šè§£æDocumentä¸ºBeanDefinitionå¹¶æ³¨å†Œåˆ°BeanFactory</p>
</li>
</ul>
<p>DefaultBeanDefinitionDocumentReader#parseBeanDefinitions</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * å¦‚æœæ˜¯é»˜è®¤æ ‡ç­¾ï¼Œåœ¨DefaultBeanDefinitionDocumentReaderä¸­è¿›è¡Œè§£æ
     * å¦åˆ™éœ€è¦BeanDefinitionParserDelegateæ ¹æ®å‘½åç©ºé—´æ‰¾åˆ°å¯¹åº”çš„NamespaceHandler
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">parseBeanDefinitions</span><span class="token punctuation">(</span>Element root<span class="token punctuation">,</span> BeanDefinitionParserDelegate delegate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>delegate<span class="token punctuation">.</span><span class="token function">isDefaultNamespace</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            NodeList nl <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">getChildNodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nl<span class="token punctuation">.</span><span class="token function">getLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Node node <span class="token operator">=</span> nl<span class="token punctuation">.</span><span class="token function">item</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token keyword">instanceof</span> <span class="token class-name">Element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    Element ele <span class="token operator">=</span> <span class="token punctuation">(</span>Element<span class="token punctuation">)</span> node<span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">/*
                     * è§£æDefaultNamespaceçš„å…ƒç´ ï¼š&lt;import/>ã€&lt;alias/>ã€&lt;bean/>ã€&lt;beans/>
                     *
                     * &lt;beans xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                     *        xmlns="http://www.springframework.org/schema/beans"
                     *        xsi:schemaLocation="http://www.springframework.org/schema/beans
                     *              http://www.springframework.org/schema/beans/spring-beans.xsd"
                     *        default-autowire="byName">
                     */</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>delegate<span class="token punctuation">.</span><span class="token function">isDefaultNamespace</span><span class="token punctuation">(</span>ele<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">parseDefaultElement</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> delegate<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">/*
                     * è§£æå…¶ä»–Namespaceçš„å…ƒç´ ï¼š&lt;mvc/>ã€&lt;task/>ã€&lt;context/>ã€&lt;aop/>ç­‰
                     * Xmlå¤´è¦å¼•å…¥ç›¸åº”çš„namespaceå’Œ.xsdæ–‡ä»¶çš„è·¯å¾„
                     * åŒæ—¶æä¾›ç›¸åº”NamespaceHandlerï¼Œå¦‚MvcNamespaceHandlerã€TaskNamespaceHandlerã€ContextNamespaceHandlerã€AopNamespaceHandlerç­‰
                     */</span>
                    <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        delegate<span class="token punctuation">.</span><span class="token function">parseCustomElement</span><span class="token punctuation">(</span>ele<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            delegate<span class="token punctuation">.</span><span class="token function">parseCustomElement</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>DefaultBeanDefinitionDocumentReader#processBeanDefinition</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * å°†BeanDefinitionæ³¨å†Œåˆ°BeanFactory
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">processBeanDefinition</span><span class="token punctuation">(</span>Element ele<span class="token punctuation">,</span> BeanDefinitionParserDelegate delegate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// å°†&lt;bean/>èŠ‚ç‚¹çš„ä¿¡æ¯æå–åˆ°BeanDefinitionHolder</span>
        <span class="token comment" spellcheck="true">// BeanDefinitionHolderæ˜¯å¯¹BeanDefinitionçš„å°è£…ï¼ŒåŒ…æ‹¬BeanDefinitionï¼ŒbeanNameï¼Œaliases</span>
        BeanDefinitionHolder bdHolder <span class="token operator">=</span> delegate<span class="token punctuation">.</span><span class="token function">parseBeanDefinitionElement</span><span class="token punctuation">(</span>ele<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bdHolder <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å¦‚æœæœ‰è‡ªå®šä¹‰å±æ€§çš„è¯ï¼Œè§£æ</span>
            bdHolder <span class="token operator">=</span> delegate<span class="token punctuation">.</span><span class="token function">decorateBeanDefinitionIfRequired</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> bdHolder<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æ³¨å†ŒBeanï¼Œå°†BeanDefinitionæ³¨å†Œåˆ°BeanFactory</span>
                BeanDefinitionReaderUtils<span class="token punctuation">.</span><span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span>bdHolder<span class="token punctuation">,</span> <span class="token function">getReaderContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionStoreException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">getReaderContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Failed to register bean definition with name '"</span> <span class="token operator">+</span> bdHolder<span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">,</span> ele<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// æ³¨å†Œå®Œæˆåï¼Œå‘é€äº‹ä»¶</span>
            <span class="token function">getReaderContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fireComponentRegistered</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BeanComponentDefinition</span><span class="token punctuation">(</span>bdHolder<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>BeanDefinitionReaderUtils#registerBeanDefinition</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span>BeanDefinitionHolder definitionHolder<span class="token punctuation">,</span> BeanDefinitionRegistry registry<span class="token punctuation">)</span> <span class="token keyword">throws</span> BeanDefinitionStoreException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Register bean definition under primary name.</span>
        String beanName <span class="token operator">=</span> definitionHolder<span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ³¨å†Œè¿™ä¸ªBean</span>
        registry<span class="token punctuation">.</span><span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> definitionHolder<span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¦‚æœæœ‰åˆ«åï¼Œæ³¨å†Œåˆ«å</span>
        String<span class="token punctuation">[</span><span class="token punctuation">]</span> aliases <span class="token operator">=</span> definitionHolder<span class="token punctuation">.</span><span class="token function">getAliases</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>aliases <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>String alias <span class="token operator">:</span> aliases<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// alias -> beanNameæ˜ å°„ï¼Œè·å–çš„æ—¶å€™ï¼Œé€šè¿‡aliasè·å¾—beanNameï¼Œå†æŸ¥æ‰¾</span>
                registry<span class="token punctuation">.</span><span class="token function">registerAlias</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> alias<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>å®ä¾‹åŒ–éæ‡’åŠ è½½å•ä¾‹</p>
<p>DefaultListableBeanFactory#preInstantiateSingletons</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * ä¸¤ç§ç±»å‹çš„Beanï¼šæ™®é€šJavaBeanï¼ŒFactoryBean
     * FactoryBeanæ˜¯å®ç°äº†FactoryBean&lt;T>æ¥å£çš„Beanï¼Œé€šè¿‡getBeanæ–¹æ³•è·å–åˆ°çš„ä¸æ˜¯è¯¥FactoryBeançš„å®ä¾‹ï¼Œè€Œæ˜¯FactoryBean#getObjectè¿”å›çš„å¯¹è±¡
     * getBeanæ—¶åœ¨å‚æ•°nameå‰é¢åŠ â€œ&amp;â€å¯ä»¥è·å–è¯¥FactoryBeançš„å®ä¾‹
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">preInstantiateSingletons</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> BeansException <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Pre-instantiating singletons in "</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// this.beanDefinitionNamesä¿å­˜äº†æ‰€æœ‰beanName</span>
        List<span class="token operator">&lt;</span>String<span class="token operator">></span> beanNames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionNames<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// éå†</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>String beanName <span class="token operator">:</span> beanNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// åˆå¹¶çˆ¶Beanä¸­çš„é…ç½®ï¼Œ&lt;bean id="" class="" parent=""/></span>
            RootBeanDefinition bd <span class="token operator">=</span> <span class="token function">getMergedLocalBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// éæŠ½è±¡ &amp;&amp; å•ä¾‹ &amp;&amp; éæ‡’åŠ è½½</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bd<span class="token punctuation">.</span><span class="token function">isAbstract</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> bd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>bd<span class="token punctuation">.</span><span class="token function">isLazyInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// FactoryBeanï¼šä»å•ä¾‹ç¼“å­˜æˆ–è€…BeanDefinitionåˆ¤æ–­</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFactoryBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// åŠ è½½FactoryBeanï¼Œåœ¨beanNameå‰åŠ &amp;ï¼Œå†getBean</span>
                    Object bean <span class="token operator">=</span> <span class="token function">getBean</span><span class="token punctuation">(</span>FACTORY_BEAN_PREFIX <span class="token operator">+</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token keyword">instanceof</span> <span class="token class-name">FactoryBean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">final</span> FactoryBean<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> factory <span class="token operator">=</span> <span class="token punctuation">(</span>FactoryBean<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">)</span> bean<span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// å½“å‰FactoryBeanæ˜¯å¦æ˜¯SmartFactoryBeançš„å®ç°ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦æå‰åŠ è½½</span>
                        <span class="token keyword">boolean</span> isEagerInit<span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> factory <span class="token keyword">instanceof</span> <span class="token class-name">SmartFactoryBean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            isEagerInit <span class="token operator">=</span> AccessController<span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PrivilegedAction<span class="token operator">&lt;</span>Boolean<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>SmartFactoryBean<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">)</span> factory<span class="token punctuation">)</span><span class="token operator">:</span><span class="token operator">:</span>isEagerInit<span class="token punctuation">,</span> <span class="token function">getAccessControlContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            isEagerInit <span class="token operator">=</span> <span class="token punctuation">(</span>factory <span class="token keyword">instanceof</span> <span class="token class-name">SmartFactoryBean</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>SmartFactoryBean<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">)</span> factory<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEagerInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment" spellcheck="true">// æå‰åŠ è½½</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>isEagerInit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// åŠ è½½FactoryBeanç”Ÿäº§çš„Bean</span>
                            <span class="token function">getBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// æ™®é€šçš„Beanåˆå§‹åŒ–</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token function">getBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// åˆ°è¿™é‡Œæ‰€æœ‰éæ‡’åŠ è½½çš„å•ä¾‹Beanå·²ç»å®Œæˆåˆå§‹åŒ–ï¼Œå†æ¬¡éå†</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>String beanName <span class="token operator">:</span> beanNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ä»singletonObjectsè·å–å•ä¾‹</span>
            Object singletonInstance <span class="token operator">=</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å¦‚æœBeanå®ç°äº†SmartInitializingSingletonæ¥å£ï¼Œè§¦å‘afterSingletonsInstantiatedå›è°ƒ</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>singletonInstance <span class="token keyword">instanceof</span> <span class="token class-name">SmartInitializingSingleton</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> SmartInitializingSingleton smartSingleton <span class="token operator">=</span> <span class="token punctuation">(</span>SmartInitializingSingleton<span class="token punctuation">)</span> singletonInstance<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    AccessController<span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PrivilegedAction<span class="token operator">&lt;</span>Object<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
                        smartSingleton<span class="token punctuation">.</span><span class="token function">afterSingletonsInstantiated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token function">getAccessControlContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    smartSingleton<span class="token punctuation">.</span><span class="token function">afterSingletonsInstantiated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>AbstractBeanFactory#doGetBean</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * å•ä¾‹ï¼šåˆ¤æ–­æ˜¯å¦å·²ç»åˆå§‹åŒ–å¹¶æ·»åŠ åˆ°ç¼“å­˜
     * åŸå‹ï¼šé‡æ–°åˆå§‹åŒ–
     */</span>
    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>
    <span class="token keyword">protected</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> T <span class="token function">doGetBean</span><span class="token punctuation">(</span><span class="token keyword">final</span> String name<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token keyword">final</span> Class<span class="token operator">&lt;</span>T<span class="token operator">></span> requiredType<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token keyword">final</span> Object<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">,</span> <span class="token keyword">boolean</span> typeCheckOnly<span class="token punctuation">)</span> <span class="token keyword">throws</span> BeansException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">/*
         * åˆ«åè½¬æ¢ï¼Œè¿”å›åŸå§‹beanNameï¼š
         *      &amp;å¼€å¤´ï¼šFactoryBeanï¼Œè¿”å›å»æ‰å‰ç¼€çš„åŸå
         *      åˆ«åæˆ–åŸåï¼šè¿”å›åŸå
         */</span>
        <span class="token keyword">final</span> String beanName <span class="token operator">=</span> <span class="token function">transformedBeanName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è¿”å›å€¼</span>
        Object bean<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">/*
         * å…ˆæŒ‰é¡ºåºæŸ¥ç¼“å­˜ï¼š
         *      this.singletonObjectsï¼šå­˜æ”¾å·²ç»å®Œæˆåˆå§‹åŒ–çš„å•ä¾‹ï¼ˆæ™®é€šå•ä¾‹Beanå’ŒFactoryBeanå•ä¾‹Beanï¼ŒFactoryBeanç”Ÿæˆçš„å•ä¾‹Beanåœ¨factoryBeanObjectCacheï¼‰
         *      this.earlySingletonObjectsï¼šå­˜æ”¾å·²å®ä¾‹åŒ–ä½†è¿˜æ²¡æœ‰åˆå§‹åŒ–æ³¨å…¥ä¾èµ–çš„æ—©æœŸå¼•ç”¨ï¼Œå®Œæˆåˆå§‹åŒ–ååˆ é™¤
         *      this.singletonFactoriesï¼šå­˜æ”¾ç”Ÿæˆæ—©æœŸå¼•ç”¨çš„ObjectFactoryï¼Œç”¨å®Œå°±åˆ 
         */</span>
        Object sharedInstance <span class="token operator">=</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å·²å­˜åœ¨</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sharedInstance <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> args <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// singletonsCurrentlyInCreationåŒ…å«beanName</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSingletonCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Returning eagerly cached instance of singleton bean '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">"' that is not fully initialized yet - a consequence of a circular reference"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Returning cached instance of singleton bean '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">/*
             * ä»¥&amp;å¼€å¤´ï¼Œå¦‚æœbeanInstanceä¸æ˜¯FactoryBeanç±»å‹ï¼ŒæŠ›å¼‚å¸¸
             * ä»¥&amp;å¼€å¤´ï¼Œå¦‚æœbeanInstanceæ˜¯FactoryBeanç±»å‹ï¼Œç›´æ¥è¿”å›beanInstance
             * ä¸ä»¥&amp;å¼€å¤´ï¼Œå¦‚æœbeanInstanceä¸æ˜¯FactoryBeanç±»å‹ï¼Œç›´æ¥è¿”å›beanInstance
             * ä¸ä»¥&amp;å¼€å¤´ï¼Œå¦‚æœbeanInstanceæ˜¯FactoryBeanç±»å‹
             *      å•ä¾‹ï¼šå…ˆä»factoryBeanObjectCacheè·å–ï¼Œä¸ºç©ºåˆ™è°ƒç”¨FactoryBean#getObjectåˆ›å»ºï¼Œå¹¶æ”¾å…¥factoryBeanObjectCache
             *      åŸå‹ï¼šä¸åŠ å…¥factoryBeanObjectCacheï¼Œæ¯æ¬¡éƒ½é‡æ–°åˆ›å»º
             */</span>
            bean <span class="token operator">=</span> <span class="token function">getObjectForBeanInstance</span><span class="token punctuation">(</span>sharedInstance<span class="token punctuation">,</span> name<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ç¬¬ä¸€æ¬¡åˆ›å»ºï¼Œå¯èƒ½æ˜¯åŸå‹æˆ–å•ä¾‹</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è·å–Beanä¹‹å‰å¦‚æœè¿™ä¸ªåŸå‹Beanæ­£åœ¨è¢«åˆ›å»ºåˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼ŒåŸå‹Beanåœ¨åˆ›å»ºä¹‹å‰ä¼šæ ‡è®°è¿™ä¸ªbeanNameæ­£åœ¨è¢«åˆ›å»ºï¼Œåˆ›å»ºç»“æŸä¹‹åä¼šåˆ é™¤æ ‡è®°</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPrototypeCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ä¸æ”¯æŒåŸå‹çš„å¾ªç¯ä¾èµ–ï¼Œä¸è®ºæ˜¯æ„é€ å™¨å‚æ•°å¾ªç¯ä¾èµ–ï¼Œè¿˜æ˜¯setXxxæ–¹æ³•å¾ªç¯ä¾èµ–</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCurrentlyInCreationException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// çˆ¶BeanFactory</span>
            BeanFactory parentBeanFactory <span class="token operator">=</span> <span class="token function">getParentBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å½“å‰å®¹å™¨beanDefinitionMapä¸å­˜åœ¨è¿™ä¸ªBeanDefinitionï¼ŒæŸ¥æ‰¾çˆ¶å®¹å™¨</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>parentBeanFactory <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">containsBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Not found -> check parent.</span>
                String nameToLookup <span class="token operator">=</span> <span class="token function">originalBeanName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>parentBeanFactory <span class="token keyword">instanceof</span> <span class="token class-name">AbstractBeanFactory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>AbstractBeanFactory<span class="token punctuation">)</span> parentBeanFactory<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doGetBean</span><span class="token punctuation">(</span>nameToLookup<span class="token punctuation">,</span> requiredType<span class="token punctuation">,</span> args<span class="token punctuation">,</span> typeCheckOnly<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>args <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// è¿”å›çˆ¶å®¹å™¨çš„æŸ¥è¯¢ç»“æœ</span>
                    <span class="token keyword">return</span> <span class="token punctuation">(</span>T<span class="token punctuation">)</span> parentBeanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>nameToLookup<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>requiredType <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// No args -> delegate to standard getBean method.</span>
                    <span class="token keyword">return</span> parentBeanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>nameToLookup<span class="token punctuation">,</span> requiredType<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token punctuation">(</span>T<span class="token punctuation">)</span> parentBeanFactory<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span>nameToLookup<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// typeCheckOnly == false</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>typeCheckOnly<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å°†beanNameæ”¾å…¥alreadyCreatedçš„Seté›†åˆ</span>
                <span class="token comment" spellcheck="true">// å°†beanNameä»mergedBeanDefinitionsçš„Mapé›†åˆç§»é™¤</span>
                <span class="token function">markBeanAsCreated</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å‡†å¤‡åˆ›å»ºBeanï¼Œå¯¹äºSingletonï¼Œè¿˜æ²¡åˆ›å»ºè¿‡ï¼Œå¯¹äºPrototypeï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ä»mergedBeanDefinitionsè·å–</span>
                <span class="token keyword">final</span> RootBeanDefinition mbd <span class="token operator">=</span> <span class="token function">getMergedLocalBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">checkMergedBeanDefinition</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å…ˆåˆå§‹åŒ–depends-onçš„æ‰€æœ‰Bean</span>
                String<span class="token punctuation">[</span><span class="token punctuation">]</span> dependsOn <span class="token operator">=</span> mbd<span class="token punctuation">.</span><span class="token function">getDependsOn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>dependsOn <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span>String dep <span class="token operator">:</span> dependsOn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// æ£€æŸ¥æ˜¯ä¸æ˜¯æœ‰å¾ªç¯ä¾èµ–</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDependent</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> dep<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token string">"Circular depends-on relationship between '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">"' and '"</span> <span class="token operator">+</span> dep <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment" spellcheck="true">// æ³¨å†Œä¾èµ–å…³ç³»</span>
                        <span class="token function">registerDependentBean</span><span class="token punctuation">(</span>dep<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// å…ˆåˆå§‹åŒ–è¢«ä¾èµ–é¡¹</span>
                            <span class="token function">getBean</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchBeanDefinitionException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token string">"'"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">"' depends on missing bean '"</span> <span class="token operator">+</span> dep <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// å¦‚æœæ˜¯Singletonï¼Œåˆ›å»ºSingletonå®ä¾‹</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">/*
                     * è·å–Beanï¼Œç”Ÿæˆä¸€ä¸ªåŒ¿åObjectFactoryå¯¹è±¡ä¼ å…¥ï¼Œå°è£…äº†åˆ›å»ºæ–¹æ³•ï¼Œé€šè¿‡è°ƒç”¨getObjectæ¥è°ƒç”¨createBeanåˆ›å»ºï¼š
                     *      å†æ¬¡å°è¯•ä»singletonObjectsè·å–ï¼Œæ²¡è·å–åˆ°
                     *      åˆ›å»ºå‰ï¼šå°è¯•å°†beanNameæ·»åŠ åˆ°singletonsCurrentlyInCreationï¼Œå¦‚æœå·²å­˜åœ¨ï¼ŒæŠ›å¼‚å¸¸
                     *      è°ƒç”¨createBeanåˆ›å»ºBean
                     *      åˆ›å»ºåï¼šå°è¯•å°†beanNameä»singletonsCurrentlyInCreationç§»é™¤ï¼Œå¦‚æœä¸å­˜åœ¨ï¼ŒæŠ›å¼‚å¸¸
                     *      æ·»åŠ åˆ›å»ºçš„å®ä¾‹åˆ°singletonObjects
                     *      ä»this.singletonFactoriesç§»é™¤beanNameé”®å€¼
                     *      ä»this.earlySingletonObjectsç§»é™¤beanNameé”®å€¼
                     *      æ·»åŠ beanNameåˆ°this.registeredSingletons
                     */</span>
                    sharedInstance <span class="token operator">=</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// æ‰§è¡Œåˆ›å»ºBean</span>
                            <span class="token keyword">return</span> <span class="token function">createBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeansException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// Explicitly remove instance from singleton cache: It might have been put there</span>
                            <span class="token comment" spellcheck="true">// eagerly by the creation process, to allow for circular reference resolution.</span>
                            <span class="token comment" spellcheck="true">// Also remove any beans that received a temporary reference to the bean.</span>
                            <span class="token function">destroySingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// å‚è€ƒä¸Šé¢</span>
                    bean <span class="token operator">=</span> <span class="token function">getObjectForBeanInstance</span><span class="token punctuation">(</span>sharedInstance<span class="token punctuation">,</span> name<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// å¦‚æœæ˜¯Prototypeï¼Œåˆ›å»ºPrototypeå®ä¾‹</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isPrototype</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    Object prototypeInstance <span class="token operator">=</span> null<span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// åˆ›å»ºåŸå‹ä¹‹å‰æ·»åŠ æ ‡è®°ï¼Œæ·»åŠ beanNameåˆ°prototypesCurrentlyInCreation</span>
                        <span class="token function">beforePrototypeCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// æ‰§è¡Œåˆ›å»ºBean</span>
                        prototypeInstance <span class="token operator">=</span> <span class="token function">createBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// åˆ›å»ºåŸå‹ä¹‹ååˆ é™¤æ ‡è®°ï¼Œå°†beanNameä»prototypesCurrentlyInCreationç§»é™¤</span>
                        <span class="token function">afterPrototypeCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    bean <span class="token operator">=</span> <span class="token function">getObjectForBeanInstance</span><span class="token punctuation">(</span>prototypeInstance<span class="token punctuation">,</span> name<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// å¦‚æœä¸æ˜¯Singletonæˆ–Prototype</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    String scopeName <span class="token operator">=</span> mbd<span class="token punctuation">.</span><span class="token function">getScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">final</span> Scope scope <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>scopes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>scopeName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>scope <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"No Scope registered for scope name '"</span> <span class="token operator">+</span> scopeName <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        Object scopedInstance <span class="token operator">=</span> scope<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
                            <span class="token function">beforePrototypeCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                                <span class="token comment" spellcheck="true">// æ‰§è¡Œåˆ›å»ºBean</span>
                                <span class="token keyword">return</span> <span class="token function">createBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                                <span class="token function">afterPrototypeCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        bean <span class="token operator">=</span> <span class="token function">getObjectForBeanInstance</span><span class="token punctuation">(</span>scopedInstance<span class="token punctuation">,</span> name<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalStateException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token string">"Scope '"</span> <span class="token operator">+</span> scopeName <span class="token operator">+</span> <span class="token string">"' is not active for the current thread; consider "</span> <span class="token operator">+</span> <span class="token string">"defining a scoped proxy for this bean if you intend to refer to it from a singleton"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeansException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">cleanupAfterBeanCreationFailure</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ç±»å‹æœ‰è¦æ±‚ &amp;&amp; å®ä¾‹ä¸æ˜¯è¦æ±‚çš„ç±»å‹</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>requiredType <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>requiredType<span class="token punctuation">.</span><span class="token function">isInstance</span><span class="token punctuation">(</span>bean<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// è½¬åŒ–ç±»å‹</span>
                T convertedBean <span class="token operator">=</span> <span class="token function">getTypeConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">convertIfNecessary</span><span class="token punctuation">(</span>bean<span class="token punctuation">,</span> requiredType<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>convertedBean <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanNotOfRequiredTypeException</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> requiredType<span class="token punctuation">,</span> bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// è¿”å›è½¬åŒ–åçš„ç±»å‹</span>
                <span class="token keyword">return</span> convertedBean<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TypeMismatchException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Failed to convert bean '"</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">"' to required type '"</span> <span class="token operator">+</span> ClassUtils<span class="token punctuation">.</span><span class="token function">getQualifiedName</span><span class="token punctuation">(</span>requiredType<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanNotOfRequiredTypeException</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> requiredType<span class="token punctuation">,</span> bean<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ç›´æ¥è¿”å›</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>T<span class="token punctuation">)</span> bean<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>DefaultSingletonBeanRegistry#getSingleton</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> Object <span class="token function">getSingleton</span><span class="token punctuation">(</span>String beanName<span class="token punctuation">,</span> ObjectFactory<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> singletonFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Assert<span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token string">"Bean name must not be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å…ˆä»singletonObjectsè·å–</span>
            Object singletonObject <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>singletonObject <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å•ä¾‹åœ¨é”€æ¯</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>singletonsCurrentlyInDestruction<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationNotAllowedException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token string">"Singleton bean creation not allowed while singletons of this factory are in destruction "</span> <span class="token operator">+</span> <span class="token string">"(Do not request a bean from a BeanFactory in a destroy method implementation!)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Creating shared instance of singleton bean '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">/*
                 * åˆ›å»ºå³å°†å¼€å§‹
                 * inCreationCheckExclusionsä¸åŒ…å«beanName &amp;&amp; å°†beanNameæ·»åŠ singletonsCurrentlyInCreationå´å·²å­˜åœ¨
                 * æŠ›å‡ºå½“å‰Beanæ­£åœ¨åˆ›å»ºå¼‚å¸¸
                 */</span>
                <span class="token function">beforeSingletonCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">boolean</span> newSingleton <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">boolean</span> recordSuppressedExceptions <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>suppressedExceptions <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>recordSuppressedExceptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>suppressedExceptions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// åˆ›å»ºå¯¹è±¡</span>
                    singletonObject <span class="token operator">=</span> singletonFactory<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    newSingleton <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalStateException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// Has the singleton object implicitly appeared in the meantime -></span>
                    <span class="token comment" spellcheck="true">// if yes, proceed with it since the exception indicates that state.</span>
                    singletonObject <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>singletonObject <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeanCreationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>recordSuppressedExceptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span>Exception suppressedException <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>suppressedExceptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            ex<span class="token punctuation">.</span><span class="token function">addRelatedCause</span><span class="token punctuation">(</span>suppressedException<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>recordSuppressedExceptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>suppressedExceptions <span class="token operator">=</span> null<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">/*
                     * åˆ›å»ºå·²ç»å®Œæˆ
                     * inCreationCheckExclusionsä¸åŒ…å«beanName &amp;&amp; å°†beanNameä»singletonsCurrentlyInCreationç§»é™¤å´ä¸å­˜åœ¨
                     * æŠ›å‡ºå½“å‰Beanä¸åœ¨åˆ›å»ºå¼‚å¸¸
                     */</span>
                    <span class="token function">afterSingletonCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// æ­¤æ—¶Beanå·²å®ä¾‹åŒ–å¹¶åˆå§‹åŒ–å®Œæˆï¼Œä¾èµ–å·²ç»æ³¨å…¥ï¼Œåˆ›å»ºå®Œæˆ</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>newSingleton<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">/*
                     * æ·»åŠ ç”Ÿæˆçš„å®ä¾‹åˆ°singletonObjects
                     * ä»singletonFactoriesç§»é™¤beanNameé”®å’Œå€¼
                     * ä»earlySingletonObjectsç§»é™¤beanNameé”®å’Œå€¼
                     * æ·»åŠ beanNameåˆ°registeredSingletons
                     */</span>
                    <span class="token function">addSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> singletonObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> singletonObject<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>AbstractBeanFactory#getObjectForBeanInstance</p>
<ul>
<li><p>ä»¥&amp;å¼€å¤´ï¼Œå¦‚æœbeanInstanceä¸æ˜¯FactoryBeanç±»å‹ï¼ŒæŠ›å¼‚å¸¸ã€‚</p>
</li>
<li><p>ä»¥&amp;å¼€å¤´ï¼Œå¦‚æœbeanInstanceæ˜¯FactoryBeanç±»å‹ï¼Œç›´æ¥è¿”å›beanInstanceã€‚</p>
</li>
<li><p>ä¸ä»¥&amp;å¼€å¤´ï¼Œå¦‚æœbeanInstanceä¸æ˜¯FactoryBeanç±»å‹ï¼Œç›´æ¥è¿”å›beanInstanceã€‚</p>
</li>
<li><p>ä¸ä»¥&amp;å¼€å¤´ï¼Œå¦‚æœbeanInstanceæ˜¯FactoryBeanç±»å‹ã€‚</p>
<ul>
<li><p>å•ä¾‹ï¼šå…ˆä»factoryBeanObjectCacheè·å–ï¼Œä¸ºç©ºåˆ™è°ƒç”¨FactoryBean#getObjectåˆ›å»ºï¼Œå¹¶æ”¾å…¥factoryBeanObjectCacheã€‚</p>
</li>
<li><p>åŸå‹ï¼šä¸åŠ å…¥factoryBeanObjectCacheï¼Œæ¯æ¬¡éƒ½é‡æ–°åˆ›å»ºã€‚</p>
</li>
</ul>
</li>
</ul>
<pre class=" language-java"><code class="language-java">
    <span class="token keyword">protected</span> Object <span class="token function">getObjectForBeanInstance</span><span class="token punctuation">(</span><span class="token comment" spellcheck="true">/*å®ä¾‹*/</span>Object beanInstance<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">/*è¾“å…¥çš„åå­—*/</span>String name<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">/*åŸå*/</span>String beanName<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> RootBeanDefinition mbd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ä»¥&amp;å¼€å¤´ï¼ˆæƒ³ç›´æ¥å¼•ç”¨FactoryBeanï¼‰</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>BeanFactoryUtils<span class="token punctuation">.</span><span class="token function">isFactoryDereference</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>beanInstance <span class="token keyword">instanceof</span> <span class="token class-name">NullBean</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> beanInstance<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å¦‚æœBeanä¸æ˜¯FactoryBeanï¼Œä¸è®©è°ƒç”¨ä»£ç é—´æ¥å¼•ç”¨Factory</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>beanInstance <span class="token keyword">instanceof</span> <span class="token class-name">FactoryBean</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanIsNotAFactoryException</span><span class="token punctuation">(</span><span class="token function">transformedBeanName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span> beanInstance<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ï¼ˆä¸æ˜¯FactoryBeanï¼‰ || ï¼ˆä»¥&amp;å¼€å¤´ &amp;&amp; FactoryBeanï¼‰</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>beanInstance <span class="token keyword">instanceof</span> <span class="token class-name">FactoryBean</span><span class="token punctuation">)</span> <span class="token operator">||</span> BeanFactoryUtils<span class="token punctuation">.</span><span class="token function">isFactoryDereference</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ç›´æ¥è¿”å›</span>
            <span class="token keyword">return</span> beanInstance<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ä¸ä»¥&amp;å¼€å¤´ &amp;&amp; FactoryBean</span>
        Object object <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ä»factoryBeanObjectCacheè·å–</span>
            object <span class="token operator">=</span> <span class="token function">getCachedObjectForFactoryBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>object <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            FactoryBean<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> factory <span class="token operator">=</span> <span class="token punctuation">(</span>FactoryBean<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">)</span> beanInstance<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// mbd == null &amp;&amp; beanDefinitionMapåŒ…å«beanName</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> <span class="token function">containsBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ä»mergedBeanDefinitionsè·å–</span>
                mbd <span class="token operator">=</span> <span class="token function">getMergedLocalBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">boolean</span> synthetic <span class="token operator">=</span> <span class="token punctuation">(</span>mbd <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> mbd<span class="token punctuation">.</span><span class="token function">isSynthetic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">/*
             * å•ä¾‹ï¼šå…ˆä»factoryBeanObjectCacheè·å–ï¼Œä¸ºç©ºåˆ™è°ƒç”¨FactoryBean#getObjectåˆ›å»ºï¼Œå¹¶æ”¾å…¥factoryBeanObjectCache
             * åŸå‹ï¼šæ¯æ¬¡éƒ½åˆ›å»ºæ–°çš„
             */</span>
            object <span class="token operator">=</span> <span class="token function">getObjectFromFactoryBean</span><span class="token punctuation">(</span>factory<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token operator">!</span>synthetic<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> object<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>AbstractAutowireCapableBeanFactory#createBean</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> Object <span class="token function">createBean</span><span class="token punctuation">(</span>String beanName<span class="token punctuation">,</span> RootBeanDefinition mbd<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> Object<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> BeanCreationException <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Creating instance of bean '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        RootBeanDefinition mbdToUse <span class="token operator">=</span> mbd<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ç¡®ä¿BeanDefinitionä¸­çš„Classè¢«åŠ è½½ï¼Œå…‹éš†BeanDefinitionï¼Œé¢„é˜²åŠ¨æ€resolvedçš„ç±»ä¸èƒ½å­˜æ”¾åœ¨å…±äº«çš„MergedBeanDefinition</span>
        Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> resolvedClass <span class="token operator">=</span> <span class="token function">resolveBeanClass</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>resolvedClass <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>mbd<span class="token punctuation">.</span><span class="token function">hasBeanClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> mbd<span class="token punctuation">.</span><span class="token function">getBeanClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mbdToUse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RootBeanDefinition</span><span class="token punctuation">(</span>mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mbdToUse<span class="token punctuation">.</span><span class="token function">setBeanClass</span><span class="token punctuation">(</span>resolvedClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å‡†å¤‡æ–¹æ³•è¦†å†™MethodOverridesï¼Œæ¥è‡ª&lt;lookup-method/>å’Œ&lt;replaced-method/></span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            mbdToUse<span class="token punctuation">.</span><span class="token function">prepareMethodOverrides</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionValidationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanDefinitionStoreException</span><span class="token punctuation">(</span>mbdToUse<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token string">"Validation of method overrides failed"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">/*
             * éå†å·²å®ä¾‹åŒ–çš„BeanPostProcessorï¼Œå¦‚æœæ˜¯InstantiationAwareBeanPostProcessorç±»å‹ï¼Œè°ƒç”¨postProcessBeforeInstantiation
             * å¦‚æœä¸Šä¸€æ­¥è¿”å›äº†Beanå®ä¾‹ï¼ˆä»£ç†ï¼‰ï¼Œéå†å·²å®ä¾‹åŒ–çš„BeanPostProcessorï¼Œè°ƒç”¨postProcessAfterInitializationï¼Œç›´æ¥è¿”å›Beanï¼Œä¸å†å¤„ç†
             */</span>
            Object bean <span class="token operator">=</span> <span class="token function">resolveBeforeInstantiation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbdToUse<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbdToUse<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token string">"BeanPostProcessor before instantiation of bean failed"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// åˆ›å»ºBean</span>
            Object beanInstance <span class="token operator">=</span> <span class="token function">doCreateBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbdToUse<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Finished creating instance of bean '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">"'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> beanInstance<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeanCreationException</span> <span class="token operator">|</span> ImplicitlyAppearedSingletonException ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// A previously detected exception with proper bean creation context already,</span>
            <span class="token comment" spellcheck="true">// or illegal singleton state to be communicated up to DefaultSingletonBeanRegistry.</span>
            <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbdToUse<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token string">"Unexpected exception during bean creation"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>AbstractAutowireCapableBeanFactory#doCreateBean</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * createBeanInstance åˆ›å»ºBeanå®ä¾‹
     * addSingletonFactory å°†åˆå§‹åŒ–çš„Beanæå‰æš´éœ²ï¼Œå¤„ç†å•ä¾‹çš„éæ„é€ å‡½æ•°çš„å¾ªç¯å¼•ç”¨
     * populateBean ä¾èµ–æ³¨å…¥
     * initializeBean å›è°ƒï¼ŒapplyBeanPostProcessorsBeforeInitialization - init-method - applyBeanPostProcessorsAfterInitialization
     */</span>
    <span class="token keyword">protected</span> Object <span class="token function">doCreateBean</span><span class="token punctuation">(</span><span class="token keyword">final</span> String beanName<span class="token punctuation">,</span> <span class="token keyword">final</span> RootBeanDefinition mbd<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token annotation punctuation">@Nullable</span> Object<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> BeanCreationException <span class="token punctuation">{</span>
        BeanWrapper instanceWrapper <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">/*
             * å¦‚æœæ˜¯å•ä¾‹å…ˆç§»é™¤factoryBeanInstanceCacheï¼ŒçŒœæµ‹æ˜¯FactoryBeanç±»å‹åŒ¹é…æ—¶ç”Ÿæˆçš„ï¼Œä¸ç®¡å®ƒ
             */</span>
            instanceWrapper <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>factoryBeanInstanceCache<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>instanceWrapper <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">/*
             * å®ä¾‹åŒ–Beanï¼š
             *      é€šè¿‡Supplierå®ä¾‹åŒ–
             *      é€šè¿‡FactoryMethodå®ä¾‹åŒ–
             *      é€šè¿‡å«å‚æ„é€ å‡½æ•°å®ä¾‹åŒ–ï¼Œä¾èµ–æ³¨å…¥
             *          éå†å·²å®ä¾‹åŒ–çš„BeanPostProcessorï¼Œå¦‚æœæ˜¯SmartInstantiationAwareBeanPostProcessorç±»å‹ï¼Œè°ƒç”¨determineCandidateConstructorsåˆ¤æ–­æ„é€ å‡½æ•°
             *      é€šè¿‡æ— å‚æ„é€ å‡½æ•°å®ä¾‹åŒ–
             */</span>
            instanceWrapper <span class="token operator">=</span> <span class="token function">createBeanInstance</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Beanå®ä¾‹</span>
        <span class="token keyword">final</span> Object bean <span class="token operator">=</span> instanceWrapper<span class="token punctuation">.</span><span class="token function">getWrappedInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ç±»å‹</span>
        Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> beanType <span class="token operator">=</span> instanceWrapper<span class="token punctuation">.</span><span class="token function">getWrappedClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>beanType <span class="token operator">!=</span> NullBean<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mbd<span class="token punctuation">.</span>resolvedTargetType <span class="token operator">=</span> beanType<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span>postProcessingLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mbd<span class="token punctuation">.</span>postProcessed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// éå†å·²å®ä¾‹åŒ–çš„BeanPostProcessorï¼Œå¦‚æœæ˜¯MergedBeanDefinitionPostProcessorç±»å‹ï¼Œè°ƒç”¨postProcessMergedBeanDefinition</span>
                    <span class="token function">applyMergedBeanDefinitionPostProcessors</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> beanType<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token string">"Post-processing of merged bean definition failed"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                mbd<span class="token punctuation">.</span>postProcessed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å•ä¾‹ &amp;&amp; å…è®¸å¾ªç¯å¼•ç”¨ &amp;&amp; å½“å‰beanNameåœ¨singletonsCurrentlyInCreationä¸­</span>
        <span class="token keyword">boolean</span> earlySingletonExposure <span class="token operator">=</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>allowCircularReferences <span class="token operator">&amp;&amp;</span> <span class="token function">isSingletonCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è§£å†³å¾ªç¯ä¾èµ–ï¼Œæ­¤æ—¶ä¾èµ–æœªæ³¨å…¥ï¼Œæå‰æš´éœ²åˆå§‹åŒ–çš„Beanï¼Œæš´éœ²ä¸€ä¸ªObjectFactory</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>earlySingletonExposure<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>logger<span class="token punctuation">.</span><span class="token function">isTraceEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Eagerly caching bean '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">"' to allow for resolving potential circular references"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">/*
             * å¦‚æœthis.singletonObjectsä¸åŒ…å«beanNameï¼ˆå³åˆå§‹åŒ–æ²¡å®Œæˆï¼‰ï¼š
             *      å°†ä¸€ä¸ªåŒ¿åçš„ObjectFactoryå®ç°æ”¾å…¥this.singletonFactoriesï¼Œè¿™ä¸ªObjectFactoryåŒ…è£…äº†åˆ›å»ºè¿‡ç¨‹ï¼š
             *          éå†å·²å®ä¾‹åŒ–çš„BeanPostProcessorï¼Œå¦‚æœæ˜¯SmartInstantiationAwareBeanPostProcessorç±»å‹ï¼Œè°ƒç”¨getEarlyBeanReferenceï¼Œè¿”å›ä¸€ä¸ªæ—©æœŸå¼•ç”¨å¯¹è±¡
             *          åŸºæœ¬æ˜¯ä»€ä¹ˆä¹Ÿæ²¡å¹²å°†Beanå®ä¾‹åŸæ ·è¿”å›ï¼Œä½†æ˜¯ç»™äº†AbstractAutoProxyCreatorä¸€ä¸ªåŒ…è£…ä»£ç†çš„æœºä¼š
             *      ä»this.earlySingletonObjectsç§»é™¤beanNameé”®å’Œå€¼ï¼ˆæ–°çš„ç”±ObjectFactoryç”Ÿæˆï¼‰
             *      æ·»åŠ beanNameåˆ°this.registeredSingletons
             */</span>
            <span class="token function">addSingletonFactory</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">getEarlyBeanReference</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> bean<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// åˆ›å»ºä¸€ä¸ªå˜é‡ä¿å­˜å¯¹è±¡</span>
        Object exposedObject <span class="token operator">=</span> bean<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">/*
             * å±æ€§æ³¨å…¥ï¼š
             * éå†å·²å®ä¾‹åŒ–çš„BeanPostProcessorï¼Œå¦‚æœæ˜¯InstantiationAwareBeanPostProcessorç±»å‹ï¼Œè°ƒç”¨postProcessAfterInstantiationå¤„ç†Beanå®ä¾‹
             * å¦‚æœéœ€è¦ç»§ç»­è®¾ç½®å€¼ï¼Œç»§ç»­ï¼Œå¦åˆ™ç›´æ¥è¿”å›
             * æŒ‰ç…§è£…é…ç±»å‹ï¼ŒæŒ‰åå­—æˆ–ç±»å‹è°ƒç”¨BeanFactory#getBeanè·å–å¯¹åº”ä¾èµ–
             * éå†å·²å®ä¾‹åŒ–çš„BeanPostProcessorï¼Œå¦‚æœæ˜¯InstantiationAwareBeanPostProcessorç±»å‹ï¼Œè°ƒç”¨postProcessPropertiesåŠpostProcessPropertyValues
             * ä¸Šé¢ä¸€æ­¥ä¸­AutowiredAnnotationBeanPostProcessorä¼šå¯¹@Autowiredã€@Valueã€@Injectæ³¨è§£çš„ä¾èµ–æ³¨å…¥è®¾å€¼
             * å¯¹Beanåº”ç”¨ä¾èµ–ï¼Œæ³¨å…¥è®¾å€¼
             */</span>
            <span class="token function">populateBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> instanceWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">/*
             * å¦‚æœBeanå®ç°äº†BeanNameAwareã€BeanClassLoaderAwareæˆ–BeanFactoryAwareæ¥å£ï¼Œå›è°ƒ
             * éå†å·²å®ä¾‹åŒ–æ·»åŠ çš„BeanPostProcessorï¼Œè°ƒç”¨postProcessBeforeInitialization
             * å¦‚æœBeanå®ç°äº†InitializingBeanæ¥å£ï¼Œè°ƒç”¨afterPropertiesSet
             * å¦‚æœBeanå®šä¹‰äº†initMethodæ–¹æ³•ï¼Œåå°„è°ƒç”¨initMethod
             * éå†å·²å®ä¾‹åŒ–æ·»åŠ çš„BeanPostProcessorï¼Œè°ƒç”¨postProcessAfterInitialization
             * AOPä¼šåœ¨åˆ›å»ºBeanå®ä¾‹æœ€åè¿›è¡Œä»£ç†å¢å¼º
             */</span>
            exposedObject <span class="token operator">=</span> <span class="token function">initializeBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> exposedObject<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ex <span class="token keyword">instanceof</span> <span class="token class-name">BeanCreationException</span> <span class="token operator">&amp;&amp;</span> beanName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>BeanCreationException<span class="token punctuation">)</span> ex<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token punctuation">(</span>BeanCreationException<span class="token punctuation">)</span> ex<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token string">"Initialization of bean failed"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">/*
         * æ­¤æ—¶ä¾èµ–å·²æ³¨å…¥ï¼Œåˆå§‹åŒ–å®Œæˆï¼Œå¤„ç†ä¹‹å‰æå‰æš´éœ²çš„æ—©æœŸå•ä¾‹
         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>earlySingletonExposure<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">/*
             * æŒ‰é¡ºåºæŸ¥ç¼“å­˜ï¼š
             *      this.singletonObjects
             *      this.earlySingletonObjects
             *      this.singletonFactories(å› ä¸ºallowEarlyReference==falseï¼Œæ‰€ä»¥ä¸ä»è¿™é‡ŒæŸ¥æ‰¾)
             */</span>
            Object earlySingletonReference <span class="token operator">=</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>earlySingletonReference <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>exposedObject <span class="token operator">==</span> bean<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// è¿”å›æ—©æœŸå¼•ç”¨</span>
                    exposedObject <span class="token operator">=</span> earlySingletonReference<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>allowRawInjectionDespiteWrapping <span class="token operator">&amp;&amp;</span> <span class="token function">hasDependentBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    String<span class="token punctuation">[</span><span class="token punctuation">]</span> dependentBeans <span class="token operator">=</span> <span class="token function">getDependentBeans</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    Set<span class="token operator">&lt;</span>String<span class="token operator">></span> actualDependentBeans <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>dependentBeans<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span>String dependentBean <span class="token operator">:</span> dependentBeans<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">removeSingletonIfCreatedForTypeCheckOnly</span><span class="token punctuation">(</span>dependentBean<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            actualDependentBeans<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>dependentBean<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>actualDependentBeans<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCurrentlyInCreationException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token string">"Bean with name '"</span> <span class="token operator">+</span> beanName <span class="token operator">+</span> <span class="token string">"' has been injected into other beans ["</span> <span class="token operator">+</span> StringUtils<span class="token punctuation">.</span><span class="token function">collectionToCommaDelimitedString</span><span class="token punctuation">(</span>actualDependentBeans<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"] in its raw version as part of a circular reference, but has eventually been "</span> <span class="token operator">+</span> <span class="token string">"wrapped. This means that said other beans do not use the final version of the "</span> <span class="token operator">+</span> <span class="token string">"bean. This is often the result of over-eager type matching - consider using "</span> <span class="token operator">+</span> <span class="token string">"'getBeanNamesOfType' with the 'allowEagerInit' flag turned off, for example."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ”¾å…¥disposableBeans</span>
            <span class="token function">registerDisposableBeanIfNecessary</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> bean<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionValidationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCreationException</span><span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">getResourceDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> <span class="token string">"Invalid destruction signature"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> exposedObject<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>DefaultSingletonBeanRegistry#getSingleton</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * this.singletonObjects
     * this.earlySingletonObjects
     * this.singletonFactories
     */</span>
    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">protected</span> Object <span class="token function">getSingleton</span><span class="token punctuation">(</span>String beanName<span class="token punctuation">,</span> <span class="token keyword">boolean</span> allowEarlyReference<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// æŸ¥å•ä¾‹ç¼“å­˜</span>
        Object singletonObject <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ²¡æœ‰ &amp;&amp; åœ¨åˆ›å»ºè¿‡ç¨‹ä¸­</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>singletonObject <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> <span class="token function">isSingletonCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// åŠ é”</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æŸ¥æ—©æœŸå•ä¾‹ç¼“å­˜</span>
                singletonObject <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>earlySingletonObjects<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// æ—©æœŸå•ä¾‹ç¼“å­˜æ²¡æœ‰ &amp;&amp; å…è®¸æ—©æœŸå¼•ç”¨</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>singletonObject <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> allowEarlyReference<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å•ä¾‹å·¥å‚ï¼Œä¹‹å‰åœ¨æš´éœ²æ—©æœŸå¼•ç”¨æ—¶åŠ å…¥</span>
                    ObjectFactory<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> singletonFactory <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>singletonFactories<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>singletonFactory <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ä»å•ä¾‹å·¥å‚è·å–</span>
                        singletonObject <span class="token operator">=</span> singletonFactory<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// åŠ å…¥æ—©æœŸå•ä¾‹ç¼“å­˜</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>earlySingletonObjects<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> singletonObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// ç”¨å®Œå°±åˆ é™¤è‡ªå·±</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>singletonFactories<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> singletonObject<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>å¯¹å¾ªç¯ä¾èµ–çš„å¤„ç†ï¼š</p>
<ul>
<li>Prototypeï¼šä¸æ”¯æŒï¼Œæ— è®ºæ˜¯é€šè¿‡æ„é€ å™¨å‚æ•°è¿˜æ˜¯setterå¾ªç¯ä¾èµ–ï¼ŒBeanFactory#getBeanè·å–æ—¶å¦‚æœè¿™ä¸ªåŸå‹Beanæ­£åœ¨è¢«åˆ›å»ºï¼Œç›´æ¥æŠ›å¼‚å¸¸ã€‚</li>
</ul>
<p>AbstractBeanFactory#doGetBean</p>
<pre class=" language-java"><code class="language-java">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPrototypeCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCurrentlyInCreationException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span></code></pre>
<p>åŸå‹Beanåˆ›å»ºå‰ä¼šæ ‡è®°è¿™ä¸ªbeanNameæ­£åœ¨è¢«åˆ›å»ºï¼Œåˆ›å»ºç»“æŸä¹‹ååˆ é™¤æ ‡è®°ã€‚</p>
<p>AbstractBeanFactory#doGetBean</p>
<pre class=" language-java"><code class="language-java">                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// åˆ›å»ºåŸå‹ä¹‹å‰æ·»åŠ æ ‡è®°ï¼Œæ·»åŠ beanNameåˆ°prototypesCurrentlyInCreation</span>
                        <span class="token function">beforePrototypeCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// æ‰§è¡Œåˆ›å»ºBean</span>
                        prototypeInstance <span class="token operator">=</span> <span class="token function">createBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// åˆ›å»ºåŸå‹ä¹‹ååˆ é™¤æ ‡è®°ï¼Œå°†beanNameä»prototypesCurrentlyInCreationç§»é™¤</span>
                        <span class="token function">afterPrototypeCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span></code></pre>
<ul>
<li>Singletonï¼ˆæ„é€ å™¨å‚æ•°å¾ªç¯ä¾èµ–ï¼‰ï¼šæŠ›å¼‚å¸¸ã€‚</li>
</ul>
<p>å‡è®¾ClassAå’ŒClassBé€šè¿‡æ„é€ å™¨å¾ªç¯ä¾èµ–ã€‚</p>
<p>BeanFactory#getBeanåˆ›å»ºClassAï¼š<code>AbstractBeanFactory#doGetBean</code> -&gt; <code>DefaultSingletonBeanRegistry#getSingleton</code> -&gt; <code>DefaultSingletonBeanRegistry#beforeSingletonCreation</code>ï¼Œåˆ¤æ–­å•ä¾‹Beanæ˜¯å¦æ­£åœ¨è¢«åˆ›å»ºï¼Œå¦‚æœæ­£åœ¨è¢«åˆ›å»ºåˆ™æŠ¥é”™ï¼Œå¦‚æœæ²¡æœ‰è¢«åˆ›å»ºåˆ™åšæ ‡è®°ã€‚</p>
<p>å®ä¾‹åŒ–ClassAæ—¶ä¼šè·å–ClassBå®ä¾‹ï¼š<code>BeanFactory#getBean</code>åˆ›å»ºClassBï¼Œè°ƒç”¨<code>DefaultSingletonBeanRegistry#beforeSingletonCreation</code>ï¼Œæ­£å¸¸ã€‚</p>
<p>å®ä¾‹åŒ–ClassBæ—¶ä¼šè·å–ClassAå®ä¾‹ï¼š<code>BeanFactory#getBean</code>åˆ›å»ºClassAï¼Œè°ƒç”¨<code>DefaultSingletonBeanRegistry#beforeSingletonCreation</code>ï¼ŒæŠ¥é”™ã€‚</p>
<p>å¾ªç¯å®ä¾‹åŒ–ï¼šClassA-&gt; ClassB-&gt; ClassAï¼Œç¬¬äºŒæ¬¡å®ä¾‹åŒ–ClassAæ—¶æŠ›å‡ºå¼‚å¸¸ã€‚</p>
<ul>
<li>Singletonï¼ˆsetteræˆ–@Autowiredå¾ªç¯ä¾èµ–ï¼‰ï¼šæ­£å¸¸ã€‚</li>
</ul>
<p>å‡è®¾ClassAå’ŒClassBé€šè¿‡æ„é€ å™¨å¾ªç¯ä¾èµ–ã€‚</p>
<p><code>AbstractAutowireCapableBeanFactory#createBeanInstance</code>åˆ›å»ºClassAå®ä¾‹ï¼Œåœ¨æ³¨å…¥ClassBä¾èµ–å‰ï¼Œæå‰åŠ å…¥å®¹å™¨ã€‚</p>
<p>AbstractAutowireCapableBeanFactory#doCreateBean</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">boolean</span> earlySingletonExposure <span class="token operator">=</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>allowCircularReferences <span class="token operator">&amp;&amp;</span> <span class="token function">isSingletonCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>earlySingletonExposure<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">addSingletonFactory</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">getEarlyBeanReference</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> bean<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>ClassAå®ä¾‹é€šè¿‡Setteræ³¨å…¥ClassBå®ä¾‹ï¼š<code>BeanFactory#getBean</code>è·å–å¹¶å®ä¾‹åŒ–ClassBï¼Œåœ¨æ³¨å…¥ClassBä¾èµ–å‰ï¼Œæå‰æŠŠClassAå®ä¾‹åŠ å…¥å®¹å™¨ã€‚</p>
<p>ClassBå®ä¾‹é€šè¿‡Setteræ³¨å…¥ClassAå®ä¾‹ï¼š<code>BeanFactory#getBean</code>è·å–ClassAå®ä¾‹ï¼Œæ³¨å…¥ClassAå®ä¾‹åˆ°ClassBå®ä¾‹ã€‚</p>
<p>ClassAå®ä¾‹é€šè¿‡Setteræ³¨å…¥ClassBå®ä¾‹ï¼š<code>BeanFactory#getBean</code>è·å–ClassBå®ä¾‹ï¼Œæ³¨å…¥ClassBå®ä¾‹åˆ°ClassAå®ä¾‹ã€‚</p>
<pre><code>this.singletonObjects   []
this.earlySingletonObjects   []
this.singletonFactories   []</code></pre><pre><code>this.singletonObjects   []
this.earlySingletonObjects   []
this.singletonFactories   [BeanA&#39;s ObjectFactory]</code></pre><pre><code>this.singletonObjects   []
this.earlySingletonObjects   []
this.singletonFactories   [BeanA&#39;s ObjectFactory, BeanB&#39;s ObjectFactory]</code></pre><pre><code>this.singletonObjects   []
this.earlySingletonObjects   [BeanA]
this.singletonFactories   [BeanB&#39;s ObjectFactory]</code></pre><pre><code>this.singletonObjects   [BeanB]
this.earlySingletonObjects   [BeanA]
this.singletonFactories   []</code></pre><pre><code>this.singletonObjects   [BeanA, BeanB]
this.earlySingletonObjects   []
this.singletonFactories    []</code></pre>
				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


        <footer>
             
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

        </footer>
    </div>
    <!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
    <script>
        var timeEnd = new Date();
        console.log('è€—æ—¶ï¼š' + (timeEnd - timeStart));
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre').forEach((block) => {
                block.classList.add("line-numbers");
            });
        });
    </script>
    <!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
    <!-- material design -->
    <!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
    <!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
    <!-- toc -->
    <!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
    <!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
    <!-- <script src="/js/main.js"></script> -->
    <script src="/js/prism.js"></script>
</body>
</html>
