<!DOCTYPE HTML>
<html>

<head>
    <script>
        var timeStart = new Date();
    </script>
    <meta charset="utf-8">
    
    <title>[笔记]-Spring Framework-IoC-Xml | 草木禾</title>
    
    <meta name="author" content="huangzhike">
    
    
    <meta name="description"
        content="Spring版本：5.2.0-SNAPSHOT

Xml
FileSystemXmlApplicationContext / ClassPathXmlApplicationContext
-&gt; AbstractXmlApplicationContext
-&gt; AbstractRefreshableC">
    
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta property="og:title" content="[笔记]-Spring Framework-IoC-Xml" />
    
    <meta property="og:site_name" content="草木禾" />
    
    
    <!-- favicon -->
    <link rel="icon" type="image/ico" href="/logo.ico" sizes="32x32">
    <meta name="msapplication-TileColor" content="#009688">
    <meta name="msapplication-TileImage" content="/mstile-144x144.ico">
    <meta name="theme-color" content="#009688">
    <!-- favicon end -->
    <!-- <link href="//ok.ico" rel="icon"> -->
    

    <!-- <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.5.0/css/bootstrap.min.css" rel="stylesheet"> -->
    <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
    <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
    <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">

<meta name="generator" content="Hexo 4.2.1"></head>
<body>
    <nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">菜单</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" title="早く来い、クラウド" href="/">Reunion...</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" target="_blank" rel="noopener" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

    <div class="container" >
        <div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[笔记]-Spring Framework-IoC-Xml</h2>
				
				<div>
					<div class="post-time">2019-08-09</div>
				</div>
				
				<div class="article-content">
				<p>Spring版本：5.2.0-SNAPSHOT</p>
<hr>
<p>Xml</p>
<pre class=" language-java"><code class="language-java">FileSystemXmlApplicationContext <span class="token operator">/</span> ClassPathXmlApplicationContext
<span class="token operator">-</span><span class="token operator">></span> AbstractXmlApplicationContext
<span class="token operator">-</span><span class="token operator">></span> AbstractRefreshableConfigApplicationContext
<span class="token operator">-</span><span class="token operator">></span> AbstractRefreshableApplicationContext
<span class="token operator">-</span><span class="token operator">></span> AbstractApplicationContext
<span class="token operator">-</span><span class="token operator">></span> ConfigurableApplicationContext
<span class="token operator">-</span><span class="token operator">></span> ApplicationContext
<span class="token operator">-</span><span class="token operator">></span> BeanFactory</code></pre>
<p>AbstractApplicationContext#refresh</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> BeansException<span class="token punctuation">,</span> IllegalStateException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 加锁</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>startupShutdownMonitor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 准备刷新，生成Environment，略</span>
            <span class="token function">prepareRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">/*
             * XML：
             *      销毁BeanFactory，再重新初始化
             *      解析XML配置成BeanDefinition，注册到BeanFactory，映射beanName到beanDefinition，映射alias到beanName，Bean未初始化
             * 注解：
             *      BeanFactory在ApplicationContext实例化时一起实例化，不销毁，只是加个更新标记
             */</span>
            ConfigurableListableBeanFactory beanFactory <span class="token operator">=</span> <span class="token function">obtainFreshBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">/*
             * 准备BeanFactory：
             *       设置BeanFactory的类加载器为加载当前ApplicationContext类的类加载器
             *       实例化并添加几个BeanPostProcessor：
             *           添加ApplicationContextAwareProcessor到beanPostProcessors列表,负责Aware接口的Bean初始化回调
             *       如果BeanFactory包含LOAD_TIME_WEAVER的Bean：
             *           实例化LoadTimeWeaverAwareProcessor并添加，同时给BeanFactory设置临时类加载器，避免类型匹配时提前加载类
             *       如果BeanFactory未包含，添加几个单例Bean（Environment等加入BeanFactory）
             */</span>
            <span class="token function">prepareBeanFactory</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 子类重写</span>
                <span class="token function">postProcessBeanFactory</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">/*
                 * 对已实例化添加的BeanDefinitionRegistryPostProcessor
                 *      遍历已实例化添加的BeanFactoryPostProcessor，如果是BeanDefinitionRegistryPostProcessor实例，调用postProcessBeanDefinitionRegistry
                 * 对未实例化的BeanDefinitionRegistryPostProcessor
                 *      从beanDefinitionNames和manualSingletonNames获取已注册的BeanDefinitionRegistryPostProcessor类型的beanName
                 *      按照是否实现了PriorityOrdered、Ordered接口的顺序，分三批调用BeanFactory#getBean实例化，调用postProcessBeanDefinitionRegistry
                 * 遍历所有已实例化的BeanDefinitionRegistryPostProcessor类型的BeanFactoryPostProcessor，调用postProcessBeanFactory
                 * 遍历所有已实例化的非BeanDefinitionRegistryPostProcessor类型的BeanFactoryPostProcessor，调用postProcessBeanFactory
                 * 对未实例化的BeanFactoryPostProcessor
                 *      从beanDefinitionNames和manualSingletonNames获取已注册的BeanFactoryPostProcessor类型的beanName，遍历，跳过上面已处理过的BeanFactoryPostProcessor
                 *      按照是否实现了PriorityOrdered、Ordered接口的顺序，分三批调用BeanFactory#getBean实例化，调用postProcessBeanDefinitionRegistry
                 * 如果BeanFactory包含LOAD_TIME_WEAVER的Bean并且没设置临时类加载器：
                 *      实例化LoadTimeWeaverAwareProcessor并添加，同时给BeanFactory设置临时类加载器，避免类型匹配时提前加载类
                 */</span>
                <span class="token function">invokeBeanFactoryPostProcessors</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">/*
                 * 注册BeanPostProcessor的实现类，postProcessBeforeInitialization、postProcessAfterInitialization分别会在Bean初始化前后执行
                 *      从beanDefinitionNames和manualSingletonNames获取已注册的BeanPostProcessor的beanName
                 *      按照是否实现了PriorityOrdered、Ordered接口的顺序，分三批调用BeanFactory#getBean实例化，并添加实例到BeanFactory的beanPostProcessors
                 *      对于实现了MergedBeanDefinitionPostProcessor接口的，再覆盖添加实例到BeanFactory的beanPostProcessors
                 *      覆盖添加新的ApplicationListenerDetector到BeanFactory的beanPostProcessors
                 */</span>
                <span class="token function">registerBeanPostProcessors</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 初始化MessageSource，国际化，略</span>
                <span class="token function">initMessageSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 初始化当前ApplicationContext的事件广播器，略</span>
                <span class="token function">initApplicationEventMulticaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 模板方法，子类重写</span>
                <span class="token function">onRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">/*
                 * 添加已有的ApplicationListener到当前的事件广播器
                 * 从beanDefinitionNames和manualSingletonNames获取已注册的ApplicationListener的beanName，添加名称到当前的事件广播器
                 * 通过事件广播器广播earlyApplicationEvents
                 */</span>
                <span class="token function">registerListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">/*
                 * 如果singletonObjects或beanDefinitionMap包含名为conversionService的Bean，BeanFactory#getBean初始化，并为当前BeanFactory设置ConversionService
                 * 如果最后还没有内置的EmbeddedValueResolver，添加一个StringValueResolver进去，注入依赖时用来解析@Value(value = "${xxx.xxx}")
                 * 从beanDefinitionNames和manualSingletonNames获取已注册的LoadTimeWeaverAware的beanName，调用BeanFactory#getBean初始化
                 * 置空临时类加载器
                 * 初始化剩下所有非懒加载的单例，如果Bean实现了SmartInitializingSingleton接口，触发afterSingletonsInstantiated回调
                 */</span>
                <span class="token function">finishBeanFactoryInitialization</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">/*
                 * 初始化LifecycleProcessor，添加到BeanFactory，调用LifecycleProcessor的onRefresh
                 * 通过通过事件广播器广播ContextRefreshedEvent
                 * 子类可重写
                 */</span>
                <span class="token function">finishRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeansException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<ul>
<li><p>XmlBeanDefinitionReader：将Xml解析成为Document</p>
</li>
<li><p>BeanDefinitionDocumentReader：解析Document为BeanDefinition并注册到BeanFactory</p>
</li>
</ul>
<p>DefaultBeanDefinitionDocumentReader#parseBeanDefinitions</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * 如果是默认标签，在DefaultBeanDefinitionDocumentReader中进行解析
     * 否则需要BeanDefinitionParserDelegate根据命名空间找到对应的NamespaceHandler
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">parseBeanDefinitions</span><span class="token punctuation">(</span>Element root<span class="token punctuation">,</span> BeanDefinitionParserDelegate delegate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>delegate<span class="token punctuation">.</span><span class="token function">isDefaultNamespace</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            NodeList nl <span class="token operator">=</span> root<span class="token punctuation">.</span><span class="token function">getChildNodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nl<span class="token punctuation">.</span><span class="token function">getLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Node node <span class="token operator">=</span> nl<span class="token punctuation">.</span><span class="token function">item</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token keyword">instanceof</span> <span class="token class-name">Element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    Element ele <span class="token operator">=</span> <span class="token punctuation">(</span>Element<span class="token punctuation">)</span> node<span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">/*
                     * 解析DefaultNamespace的元素：&lt;import/>、&lt;alias/>、&lt;bean/>、&lt;beans/>
                     *
                     * &lt;beans xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                     *        xmlns="http://www.springframework.org/schema/beans"
                     *        xsi:schemaLocation="http://www.springframework.org/schema/beans
                     *              http://www.springframework.org/schema/beans/spring-beans.xsd"
                     *        default-autowire="byName">
                     */</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>delegate<span class="token punctuation">.</span><span class="token function">isDefaultNamespace</span><span class="token punctuation">(</span>ele<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">parseDefaultElement</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> delegate<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">/*
                     * 解析其他Namespace的元素：&lt;mvc/>、&lt;task/>、&lt;context/>、&lt;aop/>等
                     * Xml头要引入相应的namespace和.xsd文件的路径
                     * 同时提供相应NamespaceHandler，如MvcNamespaceHandler、TaskNamespaceHandler、ContextNamespaceHandler、AopNamespaceHandler等
                     */</span>
                    <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        delegate<span class="token punctuation">.</span><span class="token function">parseCustomElement</span><span class="token punctuation">(</span>ele<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            delegate<span class="token punctuation">.</span><span class="token function">parseCustomElement</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>DefaultBeanDefinitionDocumentReader#processBeanDefinition</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * 将BeanDefinition注册到BeanFactory
     */</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">processBeanDefinition</span><span class="token punctuation">(</span>Element ele<span class="token punctuation">,</span> BeanDefinitionParserDelegate delegate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 将&lt;bean/>节点的信息提取到BeanDefinitionHolder</span>
        <span class="token comment" spellcheck="true">// BeanDefinitionHolder是对BeanDefinition的封装，包括BeanDefinition，beanName，aliases</span>
        BeanDefinitionHolder bdHolder <span class="token operator">=</span> delegate<span class="token punctuation">.</span><span class="token function">parseBeanDefinitionElement</span><span class="token punctuation">(</span>ele<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bdHolder <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 如果有自定义属性的话，解析</span>
            bdHolder <span class="token operator">=</span> delegate<span class="token punctuation">.</span><span class="token function">decorateBeanDefinitionIfRequired</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> bdHolder<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 注册Bean，将BeanDefinition注册到BeanFactory</span>
                BeanDefinitionReaderUtils<span class="token punctuation">.</span><span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span>bdHolder<span class="token punctuation">,</span> <span class="token function">getReaderContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeanDefinitionStoreException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 注册完成后，发送事件</span>
            <span class="token function">getReaderContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fireComponentRegistered</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BeanComponentDefinition</span><span class="token punctuation">(</span>bdHolder<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>BeanDefinitionReaderUtils#registerBeanDefinition</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span>BeanDefinitionHolder definitionHolder<span class="token punctuation">,</span> BeanDefinitionRegistry registry<span class="token punctuation">)</span> <span class="token keyword">throws</span> BeanDefinitionStoreException <span class="token punctuation">{</span>
        String beanName <span class="token operator">=</span> definitionHolder<span class="token punctuation">.</span><span class="token function">getBeanName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 注册这个Bean</span>
        registry<span class="token punctuation">.</span><span class="token function">registerBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> definitionHolder<span class="token punctuation">.</span><span class="token function">getBeanDefinition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 如果有别名，注册别名</span>
        String<span class="token punctuation">[</span><span class="token punctuation">]</span> aliases <span class="token operator">=</span> definitionHolder<span class="token punctuation">.</span><span class="token function">getAliases</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>aliases <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>String alias <span class="token operator">:</span> aliases<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// alias -> beanName映射，获取的时候，通过alias获得beanName，再查找</span>
                registry<span class="token punctuation">.</span><span class="token function">registerAlias</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> alias<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<ol>
<li><p>解析配置，转为BeanDefinition，注册到BeanFactory（映射beanName到beanDefinition）。</p>
</li>
<li><p>实例化BeanFactoryPostProcessor和BeanPostProcessor，BeanFactoryPostProcessor用于对BeanDefinition执行拦截增强，BeanPostProcessor用于在Bean实例初始化前后做一些事情，比如AOP创建代理对象。</p>
</li>
<li><p>实例化剩下所有非懒加载的单例。</p>
</li>
</ol>
<hr>
<p>实例化非懒加载单例</p>
<p>DefaultListableBeanFactory#preInstantiateSingletons</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">preInstantiateSingletons</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> BeansException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// this.beanDefinitionNames保存了所有beanName</span>
        List<span class="token operator">&lt;</span>String<span class="token operator">></span> beanNames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>beanDefinitionNames<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 遍历</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>String beanName <span class="token operator">:</span> beanNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 合并父Bean中的配置，&lt;bean id="" class="" parent=""/></span>
            RootBeanDefinition bd <span class="token operator">=</span> <span class="token function">getMergedLocalBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 非抽象 &amp;&amp; 单例 &amp;&amp; 非懒加载</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bd<span class="token punctuation">.</span><span class="token function">isAbstract</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> bd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>bd<span class="token punctuation">.</span><span class="token function">isLazyInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// FactoryBean：从单例缓存或者BeanDefinition判断</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFactoryBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 普通的Bean初始化</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token function">getBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 到这里所有非懒加载的单例Bean已经完成初始化，再次遍历</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>String beanName <span class="token operator">:</span> beanNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 从singletonObjects获取单例</span>
            Object singletonInstance <span class="token operator">=</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 如果Bean实现了SmartInitializingSingleton接口，触发afterSingletonsInstantiated回调</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>singletonInstance <span class="token keyword">instanceof</span> <span class="token class-name">SmartInitializingSingleton</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>两种类型的Bean：普通JavaBean，FactoryBean。</p>
<p>FactoryBean是实现了<code>FactoryBean&lt;T&gt;</code>接口的Bean，包装了创建Bean的方法。</p>
<p>通过getBean获取的不是该FactoryBean的实例，而是FactoryBean#getObject返回的对象。</p>
<p>适用于创建Bean实例的逻辑比较复杂的情况。</p>
<p>AbstractBeanFactory#doGetBean</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span>
    <span class="token keyword">protected</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> T <span class="token function">doGetBean</span><span class="token punctuation">(</span><span class="token keyword">final</span> String name<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token keyword">final</span> Class<span class="token operator">&lt;</span>T<span class="token operator">></span> requiredType<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token keyword">final</span> Object<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">,</span> <span class="token keyword">boolean</span> typeCheckOnly<span class="token punctuation">)</span> <span class="token keyword">throws</span> BeansException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 别名转换，返回原始beanName</span>
        <span class="token keyword">final</span> String beanName <span class="token operator">=</span> <span class="token function">transformedBeanName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 返回值</span>
        Object bean<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">/*
         * 先按顺序查缓存：
         *      this.singletonObjects：存放已经完成初始化的单例（普通单例Bean和FactoryBean单例Bean，FactoryBean生成的单例Bean在factoryBeanObjectCache）
         *      this.earlySingletonObjects：存放已实例化但还没有初始化注入依赖的早期引用，完成初始化后删除
         *      this.singletonFactories：存放生成早期引用的ObjectFactory，用完就删
         */</span>
        Object sharedInstance <span class="token operator">=</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 已存在</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sharedInstance <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> args <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">/*
             * 以&amp;开头，如果beanInstance不是FactoryBean类型，抛异常
             * 以&amp;开头，如果beanInstance是FactoryBean类型，直接返回beanInstance
             * 不以&amp;开头，如果beanInstance不是FactoryBean类型，直接返回beanInstance
             * 不以&amp;开头，如果beanInstance是FactoryBean类型
             *      单例：先从factoryBeanObjectCache获取，为空则调用FactoryBean#getObject创建，并放入factoryBeanObjectCache
             *      原型：不加入factoryBeanObjectCache，每次都重新创建
             */</span>
            bean <span class="token operator">=</span> <span class="token function">getObjectForBeanInstance</span><span class="token punctuation">(</span>sharedInstance<span class="token punctuation">,</span> name<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 第一次创建，可能是原型或单例</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 获取Bean之前如果这个原型Bean正在被创建则直接抛出异常，原型Bean在创建之前会标记这个beanName正在被创建，创建结束之后会删除标记</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPrototypeCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 不支持原型的循环依赖，不论是构造器参数循环依赖，还是setXxx方法循环依赖</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BeanCurrentlyInCreationException</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 父BeanFactory</span>
            BeanFactory parentBeanFactory <span class="token operator">=</span> <span class="token function">getParentBeanFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 当前容器beanDefinitionMap不存在这个BeanDefinition，查找父容器</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>parentBeanFactory <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">containsBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// 准备创建Bean，对于Singleton，还没创建过，对于Prototype，创建一个新的</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 从mergedBeanDefinitions获取</span>
                <span class="token keyword">final</span> RootBeanDefinition mbd <span class="token operator">=</span> <span class="token function">getMergedLocalBeanDefinition</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ...</span>
                <span class="token comment" spellcheck="true">// 先初始化depends-on的所有Bean</span>
                String<span class="token punctuation">[</span><span class="token punctuation">]</span> dependsOn <span class="token operator">=</span> mbd<span class="token punctuation">.</span><span class="token function">getDependsOn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>dependsOn <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 如果是Singleton，创建Singleton实例</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">/*
                     * 获取Bean，生成一个匿名ObjectFactory对象传入，封装了创建方法，通过调用getObject来调用createBean创建：
                     *      再次尝试从singletonObjects获取，没获取到
                     *      创建前：尝试将beanName添加到singletonsCurrentlyInCreation，如果已存在，抛异常
                     *      调用createBean创建Bean
                     *      创建后：尝试将beanName从singletonsCurrentlyInCreation移除，如果不存在，抛异常
                     *      添加创建的实例到singletonObjects
                     *      从this.singletonFactories移除beanName键值
                     *      从this.earlySingletonObjects移除beanName键值
                     *      添加beanName到this.registeredSingletons
                     */</span>
                    sharedInstance <span class="token operator">=</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// 执行创建Bean</span>
                            <span class="token keyword">return</span> <span class="token function">createBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeansException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// ...</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// 参考上面</span>
                    bean <span class="token operator">=</span> <span class="token function">getObjectForBeanInstance</span><span class="token punctuation">(</span>sharedInstance<span class="token punctuation">,</span> name<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 如果是Prototype，创建Prototype实例</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isPrototype</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    Object prototypeInstance <span class="token operator">=</span> null<span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 创建原型之前添加标记，添加beanName到prototypesCurrentlyInCreation</span>
                        <span class="token function">beforePrototypeCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// 执行创建Bean</span>
                        prototypeInstance <span class="token operator">=</span> <span class="token function">createBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 创建原型之后删除标记，将beanName从prototypesCurrentlyInCreation移除</span>
                        <span class="token function">afterPrototypeCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    bean <span class="token operator">=</span> <span class="token function">getObjectForBeanInstance</span><span class="token punctuation">(</span>prototypeInstance<span class="token punctuation">,</span> name<span class="token punctuation">,</span> beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 如果不是Singleton或Prototype</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeansException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 类型有要求 &amp;&amp; 实例不是要求的类型</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>requiredType <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>requiredType<span class="token punctuation">.</span><span class="token function">isInstance</span><span class="token punctuation">(</span>bean<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 转化类型</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 直接返回</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>T<span class="token punctuation">)</span> bean<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>对于单例，判断是否已经初始化并添加到缓存，只会实例化一次。</p>
<p>对于原型，每次都重新初始化。</p>
<p>获取单例时，先按顺序查缓存：</p>
<ol>
<li><p>singletonObjects：存放已经<strong>完成初始化的单例</strong>（普通单例Bean和FactoryBean单例Bean，FactoryBean生成的单例Bean在factoryBeanObjectCache）。</p>
</li>
<li><p>earlySingletonObjects：存放已实例化但还没有初始化注入依赖的<strong>早期引用</strong>，完成初始化后删除。</p>
</li>
<li><p>singletonFactories：存放<strong>生成早期引用的ObjectFactory</strong>，用完就删。</p>
</li>
</ol>
<p>循环引用时，单例可能在这三级缓存中移动：</p>
<p>singletonFactories [BeanA’s ObjectFactory] </p>
<p>-&gt; earlySingletonObjects [BeanA’s EarlyReference] </p>
<p>-&gt; singletonObjects [BeanA]</p>
<p>DefaultSingletonBeanRegistry#getSingleton</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> Object <span class="token function">getSingleton</span><span class="token punctuation">(</span>String beanName<span class="token punctuation">,</span> ObjectFactory<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> singletonFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 先从singletonObjects获取</span>
            Object singletonObject <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>singletonObject <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
                <span class="token comment" spellcheck="true">/*
                 * 创建即将开始
                 * inCreationCheckExclusions不包含beanName &amp;&amp; 将beanName添加singletonsCurrentlyInCreation却已存在
                 * 抛出当前Bean正在创建异常
                 */</span>
                <span class="token function">beforeSingletonCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">boolean</span> newSingleton <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ...</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 创建对象</span>
                    singletonObject <span class="token operator">=</span> singletonFactory<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    newSingleton <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalStateException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeanCreationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">/*
                     * 创建已经完成
                     * inCreationCheckExclusions不包含beanName &amp;&amp; 将beanName从singletonsCurrentlyInCreation移除却不存在
                     * 抛出当前Bean不在创建异常
                     */</span>
                    <span class="token function">afterSingletonCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 此时Bean已实例化并初始化完成，依赖已经注入，创建完成</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>newSingleton<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">/*
                     * 添加生成的实例到singletonObjects
                     * 从singletonFactories移除beanName键和值
                     * 从earlySingletonObjects移除beanName键和值
                     * 添加beanName到registeredSingletons
                     */</span>
                    <span class="token function">addSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> singletonObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> singletonObject<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>AbstractAutowireCapableBeanFactory#createBean</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> Object <span class="token function">createBean</span><span class="token punctuation">(</span>String beanName<span class="token punctuation">,</span> RootBeanDefinition mbd<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> Object<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> BeanCreationException <span class="token punctuation">{</span>

        RootBeanDefinition mbdToUse <span class="token operator">=</span> mbd<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">/*
             * 遍历已实例化的BeanPostProcessor，如果是InstantiationAwareBeanPostProcessor类型，调用postProcessBeforeInstantiation
             * 如果上一步返回了Bean实例（代理），遍历已实例化的BeanPostProcessor，调用postProcessAfterInitialization，直接返回Bean，不再处理
             */</span>
            Object bean <span class="token operator">=</span> <span class="token function">resolveBeforeInstantiation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbdToUse<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>bean <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> bean<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 创建Bean</span>
            Object beanInstance <span class="token operator">=</span> <span class="token function">doCreateBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbdToUse<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> beanInstance<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BeanCreationException</span> <span class="token operator">|</span> ImplicitlyAppearedSingletonException ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>AbstractAutowireCapableBeanFactory#doCreateBean</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * createBeanInstance 创建Bean实例
     * addSingletonFactory 将初始化的Bean提前暴露，处理单例的非构造函数的循环引用
     * populateBean 依赖注入
     * initializeBean 回调，applyBeanPostProcessorsBeforeInitialization - init-method - applyBeanPostProcessorsAfterInitialization
     */</span>
    <span class="token keyword">protected</span> Object <span class="token function">doCreateBean</span><span class="token punctuation">(</span><span class="token keyword">final</span> String beanName<span class="token punctuation">,</span> <span class="token keyword">final</span> RootBeanDefinition mbd<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token annotation punctuation">@Nullable</span> Object<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> BeanCreationException <span class="token punctuation">{</span>
        BeanWrapper instanceWrapper <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">/*
             * 如果是单例先移除factoryBeanInstanceCache，猜测是FactoryBean类型匹配时生成的，不管它
             */</span>
            instanceWrapper <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>factoryBeanInstanceCache<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>instanceWrapper <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">/*
             * 实例化Bean：
             *      通过Supplier实例化
             *      通过FactoryMethod实例化
             *      通过含参构造函数实例化，依赖注入
             *          遍历已实例化的BeanPostProcessor，如果是SmartInstantiationAwareBeanPostProcessor类型，调用determineCandidateConstructors判断构造函数
             *      通过无参构造函数实例化
             */</span>
            instanceWrapper <span class="token operator">=</span> <span class="token function">createBeanInstance</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Bean实例</span>
        <span class="token keyword">final</span> Object bean <span class="token operator">=</span> instanceWrapper<span class="token punctuation">.</span><span class="token function">getWrappedInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 类型</span>
        Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> beanType <span class="token operator">=</span> instanceWrapper<span class="token punctuation">.</span><span class="token function">getWrappedClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span>postProcessingLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mbd<span class="token punctuation">.</span>postProcessed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 遍历已实例化的BeanPostProcessor，如果是MergedBeanDefinitionPostProcessor类型，调用postProcessMergedBeanDefinition</span>
                    <span class="token function">applyMergedBeanDefinitionPostProcessors</span><span class="token punctuation">(</span>mbd<span class="token punctuation">,</span> beanType<span class="token punctuation">,</span> beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                mbd<span class="token punctuation">.</span>postProcessed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 单例 &amp;&amp; 允许循环引用 &amp;&amp; 当前beanName在singletonsCurrentlyInCreation中</span>
        <span class="token keyword">boolean</span> earlySingletonExposure <span class="token operator">=</span> <span class="token punctuation">(</span>mbd<span class="token punctuation">.</span><span class="token function">isSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>allowCircularReferences <span class="token operator">&amp;&amp;</span> <span class="token function">isSingletonCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 解决循环依赖，此时依赖未注入，提前暴露初始化的Bean，暴露一个ObjectFactory</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>earlySingletonExposure<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">/*
             * 如果this.singletonObjects不包含beanName（即初始化没完成）：
             *      将一个匿名的ObjectFactory实现放入this.singletonFactories，这个ObjectFactory包装了创建过程：
             *          遍历已实例化的BeanPostProcessor，如果是SmartInstantiationAwareBeanPostProcessor类型，调用getEarlyBeanReference，返回一个早期引用对象
             *          基本是什么也没干将Bean实例原样返回，但是给了AbstractAutoProxyCreator一个包装代理的机会
             *      从this.earlySingletonObjects移除beanName键和值（新的由ObjectFactory生成）
             *      添加beanName到this.registeredSingletons
             */</span>
            <span class="token function">addSingletonFactory</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">getEarlyBeanReference</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> bean<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 创建一个变量保存对象</span>
        Object exposedObject <span class="token operator">=</span> bean<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">/*
             * 属性注入：
             * 遍历已实例化的BeanPostProcessor，如果是InstantiationAwareBeanPostProcessor类型，调用postProcessAfterInstantiation处理Bean实例
             * 如果需要继续设置值，继续，否则直接返回
             * 按照装配类型，按名字或类型调用BeanFactory#getBean获取对应依赖
             * 遍历已实例化的BeanPostProcessor，如果是InstantiationAwareBeanPostProcessor类型，调用postProcessProperties及postProcessPropertyValues
             * 上面一步中AutowiredAnnotationBeanPostProcessor会对@Autowired、@Value、@Inject注解的依赖注入设值
             * 对Bean应用依赖，注入设值
             */</span>
            <span class="token function">populateBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> mbd<span class="token punctuation">,</span> instanceWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">/*
             * 如果Bean实现了BeanNameAware、BeanClassLoaderAware或BeanFactoryAware接口，回调
             * 遍历已实例化添加的BeanPostProcessor，调用postProcessBeforeInitialization
             * 如果Bean实现了InitializingBean接口，调用afterPropertiesSet
             * 如果Bean定义了initMethod方法，反射调用initMethod
             * 遍历已实例化添加的BeanPostProcessor，调用postProcessAfterInitialization
             * AOP会在创建Bean实例最后进行代理增强
             */</span>
            exposedObject <span class="token operator">=</span> <span class="token function">initializeBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> exposedObject<span class="token punctuation">,</span> mbd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">/*
         * 此时依赖已注入，初始化完成，处理之前提前暴露的早期单例
         */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>earlySingletonExposure<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">/*
             * 按顺序查缓存：
             *      this.singletonObjects
             *      this.earlySingletonObjects
             *      this.singletonFactories(因为allowEarlyReference==false，所以不从这里查找)
             */</span>
            Object earlySingletonReference <span class="token operator">=</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>earlySingletonReference <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>exposedObject <span class="token operator">==</span> bean<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 返回早期引用</span>
                    exposedObject <span class="token operator">=</span> earlySingletonReference<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>allowRawInjectionDespiteWrapping <span class="token operator">&amp;&amp;</span> <span class="token function">hasDependentBean</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">return</span> exposedObject<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>DefaultSingletonBeanRegistry#getSingleton</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * this.singletonObjects
     * this.earlySingletonObjects
     * this.singletonFactories
     */</span>
    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">protected</span> Object <span class="token function">getSingleton</span><span class="token punctuation">(</span>String beanName<span class="token punctuation">,</span> <span class="token keyword">boolean</span> allowEarlyReference<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 查单例缓存</span>
        Object singletonObject <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 没有 &amp;&amp; 在创建过程中</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>singletonObject <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> <span class="token function">isSingletonCurrentlyInCreation</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 加锁</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>singletonObjects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 查早期单例缓存</span>
                singletonObject <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>earlySingletonObjects<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 早期单例缓存没有 &amp;&amp; 允许早期引用</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>singletonObject <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> allowEarlyReference<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 单例工厂，之前在暴露早期引用时加入</span>
                    ObjectFactory<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> singletonFactory <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>singletonFactories<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>singletonFactory <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 从单例工厂获取</span>
                        singletonObject <span class="token operator">=</span> singletonFactory<span class="token punctuation">.</span><span class="token function">getObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// 加入早期单例缓存</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>earlySingletonObjects<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>beanName<span class="token punctuation">,</span> singletonObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// 用完就删除自己</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>singletonFactories<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>beanName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> singletonObject<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>获取/创建单例Bean的过程：</p>
<ol>
<li><p>先查找有没有别名，有的话则要转换。</p>
</li>
<li><p>先尝试从singletonObjects获取，有就直接返回。</p>
</li>
<li><p>如果没有，并且当前获取的实例被标记为正在创建当中，就再尝试从earlySingletonObjects获取早期引用返回。</p>
</li>
<li><p>都没有的话，则执行创建，并将该对象的ObjectFactory放入singletonFactories，该ObjectFactory用于返回该对象实例的早期引用。</p>
</li>
<li><p>调用BeanPostProcessor对刚实例化的对象执行一堆增强操作，并注入依赖，此时注入的依赖可能引用了该对象，那么则会从singletonFactories获取该对象的ObjectFactory，获得该对象的早期引用，然后移除ObjectFactory，将早期引用加入earlySingletonObjects，并返回该对象的早期引用。</p>
</li>
<li><p>该对象实例完成初始化注入依赖后，调用BeanPostProcessor执行一堆增强操作（AOP在此时增强），然后返回该对象的早期引用。</p>
</li>
<li><p>然后将早期引用从earlySingletonObjects移除，再加入singletonObjects。</p>
</li>
</ol>
<hr>
<p>循环依赖的处理：</p>
<ul>
<li>Prototype：不支持，无论是通过构造器参数还是setter循环依赖。</li>
</ul>
<p>原型Bean创建前会标记这个beanName正在被创建，创建结束之后删除标记。</p>
<p>如果发现被标记为正在创建，则直接抛出异常。</p>
<ul>
<li><p>Singleton（构造器参数循环依赖）：抛异常。</p>
</li>
<li><p>Singleton（setter或@Autowired循环依赖）：正常，提前将实例加入容器。</p>
</li>
</ul>
<hr>
<p>AOP实现原理、IOC的初始化过程、IOC原理、怎么实现一个IOC容器？</p>
<p>还不懂吗。</p>
<p>另外，Spring生成单例时，为了保证线程安全，使用了双重检查加锁。</p>
<p>还有使用Spring单例的时候，比如Servlet时，也需要注意线程安全问题，尽量不要多线程共享实例，或者使用ThreadLocal。</p>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


        <footer>
             
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

        </footer>
    </div>
    <!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
    <script>
        var timeEnd = new Date();
        console.log('耗时：' + (timeEnd - timeStart));
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre').forEach((block) => {
                block.classList.add("line-numbers");
            });
        });
    </script>

    <script src="/js/prism.js"></script>
</body>
</html>
