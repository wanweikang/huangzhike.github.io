<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
        <script>
            var timeStart = new Date();
        </script>
        
        <title>[ç¬”è®°]-Spring Framework-Transaction | ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜</title>
        
        <meta name="author" content="huangzhike">
        
        
        <meta name="description" content="ç¼–ç¨‹å¼äº‹åŠ¡ï¼šä½¿ç”¨TransactionTemplateæˆ–ç›´æ¥ç”¨PlatformTransactionManagerã€‚
å£°æ˜å¼äº‹åŠ¡ï¼šåŸºäºAOPã€‚
Xmlæ–¹å¼ç•¥ï¼Œå‚è€ƒTxNamespaceHandlerã€‚
SpringBootï¼š
DataSourceTransactionManagerAutoConfi">
        
        
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        
        <meta property="og:title" content="[ç¬”è®°]-Spring Framework-Transaction"/>
        
        <meta property="og:site_name" content="ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜"/>
        
        
        <!-- favicon -->
        <link rel="icon" type="image/ico" href="/ok.ico" sizes="32x32">
        <meta name="msapplication-TileColor" content="#009688">
        <meta name="msapplication-TileImage" content="/mstile-144x144.ico">
        <meta name="theme-color" content="#009688">
        <!-- favicon end -->
        <!-- <link href="//ok.ico" rel="icon"> -->
        
        <!-- toc -->
        <!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
        <!-- material design -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
        <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
        
        <!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
        <!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
    <meta name="generator" content="Hexo 4.2.1"></head>

<body>
    <nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">èœå•</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" title="ä¸‹ä¸€å¥æ˜¯ï¼šå®¢æœ‰å¯äººæœŸä¸æ¥ã€‚å°æ—¶å€™ï¼Œå–œæ¬¢é åœ¨é˜³å°ä¸Šï¼Œä¸€è¾¹å¹é£ï¼Œä¸€è¾¹çœ‹ä¹¦ï¼Œå–œæ¬¢è¯»ä¹¦å—ï¼Œéªšå¹´ï¼Ÿ" href="/">ä¹¦å½“å¿«æ„è¯»æ˜“å°½</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" target="_blank" rel="noopener" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

    <div class="container" >
        <div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[ç¬”è®°]-Spring Framework-Transaction</h2>
				
				<div>
					<div class="post-time">2019-08-09</div>
				</div>
				
				<div class="article-content">
				<p>ç¼–ç¨‹å¼äº‹åŠ¡ï¼šä½¿ç”¨TransactionTemplateæˆ–ç›´æ¥ç”¨PlatformTransactionManagerã€‚</p>
<p>å£°æ˜å¼äº‹åŠ¡ï¼šåŸºäºAOPã€‚</p>
<p>Xmlæ–¹å¼ç•¥ï¼Œå‚è€ƒ<code>TxNamespaceHandler</code>ã€‚</p>
<p>SpringBootï¼š</p>
<p>DataSourceTransactionManagerAutoConfiguration</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token punctuation">{</span>JdbcTemplate<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> PlatformTransactionManager<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@AutoConfigureOrder</span><span class="token punctuation">(</span>Ordered<span class="token punctuation">.</span>LOWEST_PRECEDENCE<span class="token punctuation">)</span>
<span class="token annotation punctuation">@EnableConfigurationProperties</span><span class="token punctuation">(</span>DataSourceProperties<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// spring.datasource</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataSourceTransactionManagerAutoConfiguration</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ConditionalOnSingleCandidate</span><span class="token punctuation">(</span>DataSource<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// å®¹å™¨ä¸­åªæœ‰ä¸€ä¸ªDataSourceçš„Beanï¼Œæˆ–è€…è¿™ä¸ªDataSourceçš„Beanæ˜¯é¦–é€‰Bean</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">DataSourceTransactionManagerConfiguration</span> <span class="token punctuation">{</span>

        <span class="token comment" spellcheck="true">/**
         * æ³¨å†ŒDataSourceTransactionManager
         * DataSourceTransactionManagerå®ç°äº†PlatformTransactionManageræ¥å£
         */</span>
        <span class="token annotation punctuation">@Bean</span>
        <span class="token annotation punctuation">@ConditionalOnMissingBean</span><span class="token punctuation">(</span>PlatformTransactionManager<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// ä¸å­˜åœ¨PlatformTransactionManagerçš„Beanæ—¶ï¼ˆé¿å…è¦†ç›–ï¼‰</span>
        <span class="token keyword">public</span> DataSourceTransactionManager <span class="token function">transactionManager</span><span class="token punctuation">(</span>DataSource dataSource<span class="token punctuation">,</span> ObjectProvider<span class="token operator">&lt;</span>TransactionManagerCustomizers<span class="token operator">></span> transactionManagerCustomizers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ³¨å…¥DataSource</span>
            DataSourceTransactionManager transactionManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataSourceTransactionManager</span><span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ³¨å…¥TransactionManagerCustomizersï¼Œè¿›è¡Œè‡ªå®šä¹‰</span>
            transactionManagerCustomizers<span class="token punctuation">.</span><span class="token function">ifAvailable</span><span class="token punctuation">(</span><span class="token punctuation">(</span>customizers<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> customizers<span class="token punctuation">.</span><span class="token function">customize</span><span class="token punctuation">(</span>transactionManager<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> transactionManager<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span></code></pre>
<p>TransactionAutoConfiguration</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span>PlatformTransactionManager<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@AutoConfigureAfter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// JtaAutoConfiguration.class,</span>
        <span class="token comment" spellcheck="true">// HibernateJpaAutoConfiguration.class,</span>
        DataSourceTransactionManagerAutoConfiguration<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// åœ¨DataSourceTransactionManagerä¹‹å</span>
        <span class="token comment" spellcheck="true">// Neo4jDataAutoConfiguration.class</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@EnableConfigurationProperties</span><span class="token punctuation">(</span>TransactionProperties<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransactionAutoConfiguration</span> <span class="token punctuation">{</span>

    <span class="token comment" spellcheck="true">/**
     * åŒ…è£…PlatformTransactionManagerCustomizerï¼Œå¯¹PlatformTransactionManagerä½œè‡ªå®šä¹‰å¤„ç†
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@ConditionalOnMissingBean</span> <span class="token comment" spellcheck="true">// ä¸å­˜åœ¨æ—¶</span>
    <span class="token keyword">public</span> TransactionManagerCustomizers <span class="token function">platformTransactionManagerCustomizers</span><span class="token punctuation">(</span>ObjectProvider<span class="token operator">&lt;</span>PlatformTransactionManagerCustomizer<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>></span> customizers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TransactionManagerCustomizers</span><span class="token punctuation">(</span>customizers<span class="token punctuation">.</span><span class="token function">orderedStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>Collectors<span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ConditionalOnSingleCandidate</span><span class="token punctuation">(</span>PlatformTransactionManager<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// å­˜åœ¨ä¸€ä¸ªPlatformTransactionManagerçš„Bean</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">TransactionTemplateConfiguration</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">/**
         * æ³¨å†ŒTransactionTemplateï¼šç”¨äºç¼–ç¨‹å¼äº‹åŠ¡
         */</span>
        <span class="token annotation punctuation">@Bean</span>
        <span class="token annotation punctuation">@ConditionalOnMissingBean</span>
        <span class="token keyword">public</span> TransactionTemplate <span class="token function">transactionTemplate</span><span class="token punctuation">(</span>PlatformTransactionManager transactionManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">TransactionTemplate</span><span class="token punctuation">(</span>transactionManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ConditionalOnBean</span><span class="token punctuation">(</span>PlatformTransactionManager<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ConditionalOnMissingBean</span><span class="token punctuation">(</span>AbstractTransactionManagementConfiguration<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">EnableTransactionManagementConfiguration</span> <span class="token punctuation">{</span>

        <span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
        <span class="token annotation punctuation">@EnableTransactionManagement</span><span class="token punctuation">(</span>proxyTargetClass <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// @EnableTransactionManagement</span>
        <span class="token annotation punctuation">@ConditionalOnProperty</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"spring.aop"</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">"proxy-target-class"</span><span class="token punctuation">,</span> havingValue <span class="token operator">=</span> <span class="token string">"false"</span><span class="token punctuation">,</span> matchIfMissing <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">JdkDynamicAutoProxyConfiguration</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">/*
             * å¼•å…¥EnableTransactionManagement
             * EnableTransactionManagementå¼•å…¥TransactionManagementConfigurationSelector
             * TransactionManagementConfigurationSelectoræ ¹æ®AdviceModeæ˜¯PROXYè¿˜æ˜¯ASPECTJå¯¼å…¥ä¸åŒçš„é…ç½®
             * é»˜è®¤PROXYæ¨¡å¼ï¼Œå¼•å…¥AutoProxyRegistrarå’ŒProxyTransactionManagementConfiguration
             * AutoProxyRegistrarï¼š
             *      æ³¨å†ŒInfrastructureAdvisorAutoProxyCreator
             *          InfrastructureAdvisorAutoProxyCreatorå®ç°äº†InstantiationAwareBeanPostProcessoræ¥å£ï¼Œæ‹¦æˆªBeanå¹¶å¯»æ‰¾åˆé€‚çš„Advisorï¼Œåˆ›å»ºä»£ç†
             *          InfrastructureAdvisorAutoProxyCreator
             *          -> AbstractAdvisorAutoProxyCreator
             *          -> AbstractAutoProxyCreator
             *          -> SmartInstantiationAwareBeanPostProcessor
             *          -> InstantiationAwareBeanPostProcessor
             * ProxyTransactionManagementConfigurationï¼š
             *      æ³¨å†ŒBeanFactoryTransactionAttributeSourceAdvisorï¼šAdvisor
             *      æ³¨å†ŒAnnotationTransactionAttributeSourceï¼šåŒ¹é…è§„åˆ™ï¼Œå¤„ç†@Transactionalæ³¨è§£
             *      æ³¨å†ŒTransactionInterceptorï¼šäº‹åŠ¡æ‹¦æˆªå™¨
             */</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
        <span class="token annotation punctuation">@EnableTransactionManagement</span><span class="token punctuation">(</span>proxyTargetClass <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token annotation punctuation">@ConditionalOnProperty</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"spring.aop"</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">"proxy-target-class"</span><span class="token punctuation">,</span> havingValue <span class="token operator">=</span> <span class="token string">"true"</span><span class="token punctuation">,</span> matchIfMissing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">CglibAutoProxyConfiguration</span> <span class="token punctuation">{</span>

        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

<span class="token punctuation">}</span></code></pre>
<p>ProxyTransactionManagementConfiguration</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProxyTransactionManagementConfiguration</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractTransactionManagementConfiguration</span> <span class="token punctuation">{</span>

    <span class="token comment" spellcheck="true">/**
     *
     */</span>
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> TransactionManagementConfigUtils<span class="token punctuation">.</span>TRANSACTION_ADVISOR_BEAN_NAME<span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Role</span><span class="token punctuation">(</span>BeanDefinition<span class="token punctuation">.</span>ROLE_INFRASTRUCTURE<span class="token punctuation">)</span>
    <span class="token keyword">public</span> BeanFactoryTransactionAttributeSourceAdvisor <span class="token function">transactionAdvisor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Advisor</span>
        BeanFactoryTransactionAttributeSourceAdvisor advisor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BeanFactoryTransactionAttributeSourceAdvisor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ³¨å…¥åŒ¹é…è§„åˆ™</span>
        advisor<span class="token punctuation">.</span><span class="token function">setTransactionAttributeSource</span><span class="token punctuation">(</span><span class="token function">transactionAttributeSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ³¨å…¥å¢å¼ºå™¨</span>
        advisor<span class="token punctuation">.</span><span class="token function">setAdvice</span><span class="token punctuation">(</span><span class="token function">transactionInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>enableTx <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            advisor<span class="token punctuation">.</span><span class="token function">setOrder</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>enableTx<span class="token punctuation">.</span>&lt;Integer<span class="token operator">></span><span class="token function">getNumber</span><span class="token punctuation">(</span><span class="token string">"order"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> advisor<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * åŒ¹é…è§„åˆ™
     * å¤„ç†@org.springframework.transaction.annotation.Transactionalï¼Œ@javax.transaction.Transactionalç­‰
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@Role</span><span class="token punctuation">(</span>BeanDefinition<span class="token punctuation">.</span>ROLE_INFRASTRUCTURE<span class="token punctuation">)</span>
    <span class="token keyword">public</span> TransactionAttributeSource <span class="token function">transactionAttributeSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AnnotationTransactionAttributeSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * å¢å¼ºå™¨
     * æ‹¦æˆªäº‹åŠ¡
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@Role</span><span class="token punctuation">(</span>BeanDefinition<span class="token punctuation">.</span>ROLE_INFRASTRUCTURE<span class="token punctuation">)</span>
    <span class="token keyword">public</span> TransactionInterceptor <span class="token function">transactionInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        TransactionInterceptor interceptor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransactionInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ³¨å…¥åŒ¹é…è§„åˆ™</span>
        interceptor<span class="token punctuation">.</span><span class="token function">setTransactionAttributeSource</span><span class="token punctuation">(</span><span class="token function">transactionAttributeSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>txManager <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            interceptor<span class="token punctuation">.</span><span class="token function">setTransactionManager</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>txManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> interceptor<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span></code></pre>
<p>BeanFactoryTransactionAttributeSourceAdvisor</p>
<pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"serial"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BeanFactoryTransactionAttributeSourceAdvisor</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractBeanFactoryPointcutAdvisor</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">private</span> TransactionAttributeSource transactionAttributeSource<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> TransactionAttributeSourcePointcut pointcut <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransactionAttributeSourcePointcut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token annotation punctuation">@Nullable</span>
        <span class="token keyword">protected</span> TransactionAttributeSource <span class="token function">getTransactionAttributeSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> transactionAttributeSource<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setTransactionAttributeSource</span><span class="token punctuation">(</span>TransactionAttributeSource transactionAttributeSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>transactionAttributeSource <span class="token operator">=</span> transactionAttributeSource<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setClassFilter</span><span class="token punctuation">(</span>ClassFilter classFilter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>pointcut<span class="token punctuation">.</span><span class="token function">setClassFilter</span><span class="token punctuation">(</span>classFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> Pointcut <span class="token function">getPointcut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pointcut<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span></code></pre>
<p>TransactionInterceptor#invoke</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">public</span> Object <span class="token function">invoke</span><span class="token punctuation">(</span>MethodInvocation invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{</span>

        <span class="token comment" spellcheck="true">// è¢«ä»£ç†ç±»</span>
        Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> targetClass <span class="token operator">=</span> <span class="token punctuation">(</span>invocation<span class="token punctuation">.</span><span class="token function">getThis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null <span class="token operator">?</span> AopUtils<span class="token punctuation">.</span><span class="token function">getTargetClass</span><span class="token punctuation">(</span>invocation<span class="token punctuation">.</span><span class="token function">getThis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Adapt to TransactionAspectSupport's invokeWithinTransaction...</span>
        <span class="token keyword">return</span> <span class="token function">invokeWithinTransaction</span><span class="token punctuation">(</span>invocation<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> targetClass<span class="token punctuation">,</span>
                <span class="token comment" spellcheck="true">// å®ç°ç±»ä¸ºReflectiveMethodInvocation</span>
                invocation<span class="token operator">:</span><span class="token operator">:</span>proceed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>TransactionAspectSupport#invokeWithinTransaction</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">protected</span> Object <span class="token function">invokeWithinTransaction</span><span class="token punctuation">(</span>Method method<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> targetClass<span class="token punctuation">,</span> <span class="token keyword">final</span> InvocationCallback invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reactiveAdapterRegistry <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ReactiveAdapter adapter <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reactiveAdapterRegistry<span class="token punctuation">.</span><span class="token function">getAdapter</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getReturnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>adapter <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ReactiveTransactionSupport</span><span class="token punctuation">(</span>adapter<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invokeWithinTransaction</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> targetClass<span class="token punctuation">,</span> invocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">/*
         * AnnotationTransactionAttributeSource
         * å¯¹æ¯ä¸ªç¬¦åˆæ¡ä»¶çš„æ–¹æ³•ï¼Œéƒ½æœ‰ç¼“å­˜è¯¥æ–¹æ³•çš„äº‹åŠ¡å±æ€§TransactionAttributeï¼ŒåŒ…æ‹¬ä¼ æ’­æœºåˆ¶ã€éš”ç¦»çº§åˆ«ç­‰
         */</span>
        TransactionAttributeSource tas <span class="token operator">=</span> <span class="token function">getTransactionAttributeSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è·å–è¯¥æ–¹æ³•çš„äº‹åŠ¡å±æ€§</span>
        <span class="token keyword">final</span> TransactionAttribute txAttr <span class="token operator">=</span> <span class="token punctuation">(</span>tas <span class="token operator">!=</span> null <span class="token operator">?</span> tas<span class="token punctuation">.</span><span class="token function">getTransactionAttribute</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> targetClass<span class="token punctuation">)</span> <span class="token operator">:</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æŸ¥æ‰¾å®¹å™¨ä¸­çš„PlatformTransactionManagerï¼Œäº‹åŠ¡æ‹¦æˆªå™¨ï¼Œè¿™é‡Œæ˜¯DataSourceTransactionManager</span>
        <span class="token keyword">final</span> PlatformTransactionManager tm <span class="token operator">=</span> <span class="token function">determineTransactionManager</span><span class="token punctuation">(</span>txAttr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è·å–è¢«ä»£ç†çš„ç±»æ–¹æ³•åç§°</span>
        <span class="token keyword">final</span> String joinpointIdentification <span class="token operator">=</span> <span class="token function">methodIdentification</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> targetClass<span class="token punctuation">,</span> txAttr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å£°æ˜å¼äº‹åŠ¡</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>txAttr <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token operator">!</span><span class="token punctuation">(</span>tm <span class="token keyword">instanceof</span> <span class="token class-name">CallbackPreferringPlatformTransactionManager</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ ¹æ®éœ€è¦åˆ›å»ºäº‹åŠ¡</span>
            TransactionInfo txInfo <span class="token operator">=</span> <span class="token function">createTransactionIfNecessary</span><span class="token punctuation">(</span>tm<span class="token punctuation">,</span> txAttr<span class="token punctuation">,</span> joinpointIdentification<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Object retVal<span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// do it</span>
                retVal <span class="token operator">=</span> invocation<span class="token punctuation">.</span><span class="token function">proceedWithInvocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å›æ»šäº‹åŠ¡</span>
                <span class="token function">completeTransactionAfterThrowing</span><span class="token punctuation">(</span>txInfo<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æ¸…ç†äº‹åŠ¡çŠ¶æ€</span>
                <span class="token function">cleanupTransactionInfo</span><span class="token punctuation">(</span>txInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>vavrPresent <span class="token operator">&amp;&amp;</span> VavrDelegate<span class="token punctuation">.</span><span class="token function">isVavrTry</span><span class="token punctuation">(</span>retVal<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Set rollback-only in case of Vavr failure matching our rollback rules...</span>
                TransactionStatus status <span class="token operator">=</span> txInfo<span class="token punctuation">.</span><span class="token function">getTransactionStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> txAttr <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    retVal <span class="token operator">=</span> VavrDelegate<span class="token punctuation">.</span><span class="token function">evaluateTryFailure</span><span class="token punctuation">(</span>retVal<span class="token punctuation">,</span> txAttr<span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// æ‰§è¡ŒæˆåŠŸï¼Œæäº¤äº‹åŠ¡</span>
            <span class="token function">commitTransactionAfterReturning</span><span class="token punctuation">(</span>txInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> retVal<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ç¼–ç¨‹å¼äº‹åŠ¡</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>AbstractFallbackTransactionAttributeSource#AbstractFallbackTransactionAttributeSource</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">protected</span> TransactionAttribute <span class="token function">computeTransactionAttribute</span><span class="token punctuation">(</span>Method method<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> targetClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// épublicæ–¹æ³•ä¸å…è®¸äº‹åŠ¡</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">allowPublicMethodsOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>Modifier<span class="token punctuation">.</span><span class="token function">isPublic</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getModifiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ä»CGLIBä»£ç†å¯¹è±¡ï¼ˆå­ç±»ï¼‰ä¸Šçš„ä¸€ä¸ªæ–¹æ³•ï¼Œæ‰¾åˆ°çœŸå®å¯¹è±¡ï¼ˆçˆ¶ç±»ï¼‰ä¸Šå¯¹åº”çš„æ–¹æ³•ï¼Œæˆ–è€…åŸæœ¬è¿”å›</span>
        Method specificMethod <span class="token operator">=</span> AopUtils<span class="token punctuation">.</span><span class="token function">getMostSpecificMethod</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> targetClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">/*
         * å…ˆæ‰¾æ–¹æ³•ä¸Šçš„äº‹åŠ¡æ³¨è§£
         * é€šè¿‡TransactionAnnotationParserè§£æä¸åŒçš„äº‹åŠ¡æ³¨è§£
         * @javax.transaction.Transactionalæˆ–@org.springframework.transaction.annotation.Transactionalæˆ–åˆ«çš„
         * åŒ…è£…ä¿¡æ¯ä¸ºTransactionAttributeç±»å‹è¿”å›
         */</span>
        TransactionAttribute txAttr <span class="token operator">=</span> <span class="token function">findTransactionAttribute</span><span class="token punctuation">(</span>specificMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>txAttr <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> txAttr<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// æ–¹æ³•ä¸Šæ²¡æœ‰ï¼Œå°±ä»ç±»ä¸Šæ‰¾</span>
        txAttr <span class="token operator">=</span> <span class="token function">findTransactionAttribute</span><span class="token punctuation">(</span>specificMethod<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>txAttr <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> ClassUtils<span class="token punctuation">.</span><span class="token function">isUserLevelMethod</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> txAttr<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// è¯´æ˜å­ç±»é‡å†™äº†æ–¹æ³•</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>specificMethod <span class="token operator">!=</span> method<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ‰¾çˆ¶ç±»çš„æ–¹æ³•</span>
            txAttr <span class="token operator">=</span> <span class="token function">findTransactionAttribute</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>txAttr <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> txAttr<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ä»æœ€åˆçš„ç±»ä¸Šæ‰¾ï¼ˆå£°æ˜æ–¹æ³•çš„ç±»ï¼‰</span>
            txAttr <span class="token operator">=</span> <span class="token function">findTransactionAttribute</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getDeclaringClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>txAttr <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> ClassUtils<span class="token punctuation">.</span><span class="token function">isUserLevelMethod</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> txAttr<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>äº‹åŠ¡çš„ä¸€äº›æ³¨æ„äº‹é¡¹ï¼š</p>
<p>å‚è€ƒäº†è¿™ç¯‡æ–‡ç« ï¼š<a href="https://blog.csdn.net/bntX2jSQfEHy7/article/details/79040349" target="_blank" rel="noopener">https://blog.csdn.net/bntX2jSQfEHy7/article/details/79040349</a> ï¼Œæ–‡ç« ä¸é”™ï¼Œå°±æ˜¯æ ‡é¢˜å¤ªã€‚ã€‚ã€‚æˆ‘è¿˜ä»¥ä¸ºåœ¨çœ‹å¾®ä¿¡ä¼ é”€å·å‘¢ã€‚ã€‚ã€‚</p>
<p>@Transactionalæ³¨è§£å¯ç”¨äºæ¥å£ã€æ¥å£æ–¹æ³•ã€ç±»ä»¥åŠç±»æ–¹æ³•ä¸Šï¼Œä½†å»ºè®®ä¸è¦åœ¨æ¥å£æ–¹æ³•ä¸Šå£°æ˜@Transactionalæ³¨è§£ï¼Œè¿™æ ·åªæœ‰åœ¨åŸºäºæ¥å£çš„JDKä»£ç†æ—¶æ‰ä¼šç”Ÿæ•ˆï¼Œæœ€å¥½åœ¨å…·ä½“ç±»çš„æ–¹æ³•ä¸Šä½¿ç”¨@Transactionalæ³¨è§£ã€‚åŸå› æ˜¯è¢«å­ç±»é‡å†™çš„æ–¹æ³•ä¸èƒ½ç»§æ‰¿çˆ¶ç±»çš„æ³¨è§£ï¼Œæ‰€ä»¥å¦‚æœæ˜¯åŸºäºç±»çš„CGLIBä»£ç†æ—¶ï¼Œä¸ä¼šè¢«æ‹¦æˆªï¼ˆè²Œä¼¼ç°åœ¨å¯ä»¥äº†ï¼ŸAbstractFallbackTransactionAttributeSource#AbstractFallbackTransactionAttributeSourceï¼‰ã€‚</p>
<p>@Transactionalæ³¨è§£åœ¨ç±»çº§çš„å£°æ˜ä¸­ï¼Œä¼šä½¿å¾—æ‰€æœ‰æ–¹æ³•éƒ½æœ‰äº‹åŠ¡ï¼Œä¸éœ€è¦ä½¿ç”¨äº‹åŠ¡çš„æ–¹æ³•ï¼Œä¸è¦æ”¾ç½®äº‹åŠ¡ï¼Œæ¯”å¦‚æŸ¥è¯¢æ–¹æ³•ï¼Œå¦åˆ™å¯¹æ€§èƒ½æœ‰å½±å“ã€‚</p>
<p>å‡è®¾æŸç±»æœ‰æ–¹æ³•Aå’Œæ–¹æ³•Bï¼Œæ–¹æ³•Aæ²¡æœ‰@Transactionalæ³¨è§£ï¼Œæ–¹æ³•Bæœ‰@Transactionalæ³¨è§£ï¼Œæ–¹æ³•Aå†…éƒ¨è°ƒç”¨äº†æ–¹æ³•Bï¼Œæ­¤æ—¶äº‹åŠ¡ä¸ä¼šç”Ÿæ•ˆã€‚</p>
<p>å› ä¸ºAOPç”Ÿæˆçš„ä»£ç†å¯¹è±¡ï¼Œä¸ä¼šæ‹¦æˆªæ–¹æ³•Aï¼Œæ‰€ä»¥ç›´æ¥è°ƒç”¨äº†åŸæœ¬å®ä¾‹çš„æ–¹æ³•Aï¼Œæ–¹æ³•Aç›´æ¥è°ƒç”¨äº†è‡ªèº«çš„æ–¹æ³•Bï¼Œå®Œå…¨æ²¡èµ°AOPçš„æ‹¦æˆªï¼Œæ‰€ä»¥äº‹åŠ¡ä¸ä¼šç”Ÿæ•ˆã€‚</p>
<p>å‡è®¾æŸç±»æœ‰æ–¹æ³•Aå’Œæ–¹æ³•Bï¼Œéƒ½æœ‰@Transactionalæ³¨è§£ï¼Œæ–¹æ³•Aå†…éƒ¨è°ƒç”¨äº†æ–¹æ³•Bï¼Œæ­¤æ—¶æ–¹æ³•Bçš„äº‹åŠ¡æ˜¯è·Ÿéšç€æ–¹æ³•Açš„ã€‚</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// jdbc... å‡è®¾æ²¡æœ‰å¼‚å¸¸</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">B</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// äº‹åŠ¡æ— æ•ˆï¼Œä¸ä¼šå›æ»š</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">B</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// jdbc...</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>åŸå› è¿˜æ˜¯ä¸€æ ·ï¼Œæ–¹æ³•Aå†…éƒ¨è°ƒç”¨çš„æ–¹æ³•Bæ˜¯ç›´æ¥è°ƒç”¨å®ä¾‹å¯¹è±¡çš„æ–¹æ³•ï¼Œæ²¡æœ‰è¢«æ‹¦æˆªã€‚</p>
<p>è§£å†³æ–¹æ³•ï¼š <code>@EnableAspectJAutoProxy(exposeProxy = true)</code></p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// jdbc...</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span>Xxx<span class="token punctuation">)</span> AopContext<span class="token punctuation">.</span><span class="token function">currentProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">B</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">B</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// jdbc...</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>@Transactionalæ³¨è§£åªè¢«åº”ç”¨åˆ°publicæ–¹æ³•ä¸Šï¼Œå¦åˆ™å°†è¢«å¿½ç•¥ï¼Œä¹Ÿä¸ä¼šæŠ›å¼‚å¸¸ã€‚</p>
<p>åŒæ ·çš„é“ç†ï¼Œåªæœ‰å¤–éƒ¨è°ƒç”¨æ—¶ï¼Œæ‰èµ°AOPçš„æ‹¦æˆªï¼Œè€Œå†…éƒ¨çš„ç›¸äº’è°ƒç”¨æ˜¯ä¸ä¼šè¢«æ‹¦æˆªçš„ï¼Œä¸ºäº†é¿å…è¿™ä¸€ç‚¹ï¼Œæ‰€ä»¥ä¸æ”¯æŒépublicæ–¹æ³•ã€‚</p>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


        <footer>
             
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

        </footer>
    </div>
    <!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
    <script>
        var timeEnd = new Date();
        console.log('è€—æ—¶ï¼š' + (timeEnd - timeStart));
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre').forEach((block) => {
                block.classList.add("line-numbers");
            });
        });
    </script>
    <!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
    <!-- material design -->
    <!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
    <!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
    <!-- toc -->
    <!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
    <!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
    <!-- <script src="/js/main.js"></script> -->
    <script src="/js/prism.js"></script>
</body>
</html>
