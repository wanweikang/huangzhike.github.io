<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
        <script>
            var timeStart = new Date();
        </script>
        
        <title>[ç¬”è®°]-RocketMQ-Consumer-PullMessage | ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜</title>
        
        <meta name="author" content="huangzhike">
        
        
        <meta name="description" content="PullMessageService#run
    @Override
    public void run() {
        while (!this.isStopped()) {
            try {
                // ä»é˜»å¡é˜Ÿåˆ—å–å‡ºPullReque">
        
        
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        
        <meta property="og:title" content="[ç¬”è®°]-RocketMQ-Consumer-PullMessage"/>
        
        <meta property="og:site_name" content="ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜"/>
        
        
        <!-- favicon -->
        <link rel="icon" type="image/ico" href="/ok.ico" sizes="32x32">
        <meta name="msapplication-TileColor" content="#009688">
        <meta name="msapplication-TileImage" content="/mstile-144x144.ico">
        <meta name="theme-color" content="#009688">
        <!-- favicon end -->
        <!-- <link href="//ok.ico" rel="icon"> -->
        
        <!-- toc -->
        <!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
        <!-- material design -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
        <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
        
        <!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
        <!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
    <meta name="generator" content="Hexo 4.2.1"></head>

<body>
    <nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">èœå•</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" title="ä¸‹ä¸€å¥æ˜¯ï¼šå®¢æœ‰å¯äººæœŸä¸æ¥ã€‚å°æ—¶å€™ï¼Œå–œæ¬¢é åœ¨é˜³å°ä¸Šï¼Œä¸€è¾¹å¹é£ï¼Œä¸€è¾¹çœ‹ä¹¦ï¼Œå–œæ¬¢è¯»ä¹¦å—ï¼Œéªšå¹´ï¼Ÿ" href="/">ä¹¦å½“å¿«æ„è¯»æ˜“å°½</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" target="_blank" rel="noopener" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

    <div class="container" >
        <div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[ç¬”è®°]-RocketMQ-Consumer-PullMessage</h2>
				
				<div>
					<div class="post-time">2019-10-21</div>
				</div>
				
				<div class="article-content">
				<p>PullMessageService#run</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ä»é˜»å¡é˜Ÿåˆ—å–å‡ºPullRequestå¯¹è±¡ï¼Œåœ¨RebalanceImplä¸­åˆ›å»ºåŠ å…¥ï¼Œæ²¡æœ‰å°±é˜»å¡</span>
                PullRequest pullRequest <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pullRequestQueue<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// æ‰§è¡Œæ¶ˆæ¯æ‹‰å–</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">pullMessage</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>PullMessageService#pullMessage</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">pullMessage</span><span class="token punctuation">(</span><span class="token keyword">final</span> PullRequest pullRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ä»MQClientInstanceä¸­æ ¹æ®ConsumerGroupè·å–ä¸€ä¸ªConsumer</span>
        <span class="token keyword">final</span> MQConsumerInner consumer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">.</span><span class="token function">selectConsumer</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>consumer <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            DefaultMQPushConsumerImpl impl <span class="token operator">=</span> <span class="token punctuation">(</span>DefaultMQPushConsumerImpl<span class="token punctuation">)</span> consumer<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// é€šè¿‡è¯¥Consumeræ‰§è¡Œæ¶ˆæ¯æ‹‰å–æ¶ˆè´¹</span>
            impl<span class="token punctuation">.</span><span class="token function">pullMessage</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>DefaultMQPushConsumerImpl#pullMessage</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">pullMessage</span><span class="token punctuation">(</span><span class="token keyword">final</span> PullRequest pullRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// è·å–å¤„ç†é˜Ÿåˆ—</span>
        <span class="token keyword">final</span> ProcessQueue processQueue <span class="token operator">=</span> pullRequest<span class="token punctuation">.</span><span class="token function">getProcessQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¦‚æœProcessQueueè¢«æ ‡è®°ä¸ºåºŸå¼ƒ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>processQueue<span class="token punctuation">.</span><span class="token function">isDropped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ç›´æ¥è¿”å›</span>
        <span class="token punctuation">}</span>
        pullRequest<span class="token punctuation">.</span><span class="token function">getProcessQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setLastPullTimestamp</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ç¡®ä¿æ¶ˆè´¹è€…å¤„äºè¿è¡ŒçŠ¶æ€</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">makeSureStateOK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">MQClientException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æäº¤å»¶æ—¶ä»»åŠ¡ï¼Œå°†PullRequestæ”¾å›é˜Ÿåˆ—ï¼Œå»¶æ—¶æ‹‰å–ï¼Œç„¶åè¿”å›</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">executePullRequestLater</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">,</span> PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å¦‚æœæ¶ˆè´¹è€…è¢«æš‚åœ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isPause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æäº¤å»¶æ—¶ä»»åŠ¡ï¼Œå°†PullRequestæ”¾å›é˜Ÿåˆ—ï¼Œå»¶æ—¶æ‹‰å–ï¼Œç„¶åè¿”å›</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">long</span> cachedMessageCount <span class="token operator">=</span> processQueue<span class="token punctuation">.</span><span class="token function">getMsgCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> cachedMessageSizeInMiB <span class="token operator">=</span> processQueue<span class="token punctuation">.</span><span class="token function">getMsgSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¦‚æœConsumeræœ¬åœ°å †ç§¯æœªå¤„ç†çš„æ¶ˆæ¯è¿‡å¤šï¼Œè¶…è¿‡æ¶ˆæ¯æ‹‰å–é˜ˆå€¼ï¼Œåˆ™éœ€è¦æ‰§è¡Œæµé‡æ§åˆ¶</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cachedMessageCount <span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getPullThresholdForQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æäº¤å»¶æ—¶ä»»åŠ¡ï¼Œå°†PullRequestæ”¾å›é˜Ÿåˆ—ï¼Œå»¶æ—¶æ‹‰å–ï¼Œç„¶åè¿”å›</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å¦‚æœConsumeræœ¬åœ°å †ç§¯æ¶ˆæ¯è¿‡å¤§ï¼Œè¶…è¿‡æ¶ˆæ¯æ‹‰å–é˜Ÿåˆ—å¤§å°ï¼Œåˆ™éœ€è¦æ‰§è¡Œæµé‡æ§åˆ¶</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cachedMessageSizeInMiB <span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getPullThresholdSizeForQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æäº¤å»¶æ—¶ä»»åŠ¡ï¼Œå°†PullRequestæ”¾å›é˜Ÿåˆ—ï¼Œå»¶æ—¶æ‹‰å–ï¼Œç„¶åè¿”å›</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ä¸éœ€è¦é¡ºåºæ¶ˆè´¹æ¶ˆæ¯</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>consumeOrderly<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ¶ˆæ¯åç§»è·¨åº¦è¿‡å¤§ï¼Œåˆ™éœ€è¦æ‰§è¡Œæµé‡æ§åˆ¶</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>processQueue<span class="token punctuation">.</span><span class="token function">getMaxSpan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getConsumeConcurrentlyMaxSpan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æäº¤å»¶æ—¶ä»»åŠ¡ï¼Œå°†PullRequestæ”¾å›é˜Ÿåˆ—ï¼Œå»¶æ—¶æ‹‰å–ï¼Œç„¶åè¿”å›</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// éœ€è¦é¡ºåºæ¶ˆè´¹æ¶ˆæ¯</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å·²ç»å‘Brokerè·å–äº†è¯¥MessageQueueçš„åˆ†å¸ƒå¼é”</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>processQueue<span class="token punctuation">.</span><span class="token function">isLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// PullRequestå¯¹è±¡æ˜¯é‡å¤ä½¿ç”¨çš„ï¼Œç¬¬ä¸€æ¬¡æ‹‰å–æ—¶æ²¡æ ‡è®°é”å®š</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pullRequest<span class="token punctuation">.</span><span class="token function">isLockedFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å‘Brokerå‘é€QUERY_CONSUMER_OFFSETè¯·æ±‚ï¼Œè·å–MessageQueueçš„æ¶ˆè´¹è¿›åº¦</span>
                    <span class="token keyword">final</span> <span class="token keyword">long</span> offset <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rebalanceImpl<span class="token punctuation">.</span><span class="token function">computePullFromWhere</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// æ ‡è®°é”å®š</span>
                    pullRequest<span class="token punctuation">.</span><span class="token function">setLockedFirst</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// è®¾ç½®æ‹‰å–åç§»</span>
                    pullRequest<span class="token punctuation">.</span><span class="token function">setNextOffset</span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// æ²¡æœ‰è·å–é”</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æäº¤å»¶æ—¶ä»»åŠ¡ï¼Œå°†PullRequestæ”¾å›é˜Ÿåˆ—ï¼Œå»¶æ—¶æ‹‰å–ï¼Œç„¶åè¿”å›</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// æ£€æŸ¥è®¢é˜…å…³ç³»ï¼Œå¯èƒ½å»¶æ—¶åï¼ŒTopicæˆ–Consumerçš„é…ç½®å‘ç”Ÿäº†å˜åŒ–</span>
        <span class="token keyword">final</span> SubscriptionData subscriptionData <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rebalanceImpl<span class="token punctuation">.</span><span class="token function">getSubscriptionInner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ²¡æ‰¾åˆ°è¯¥Topicçš„è®¢é˜…æ•°æ®</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">==</span> subscriptionData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æäº¤å»¶æ—¶ä»»åŠ¡ï¼Œå°†PullRequestæ”¾å›é˜Ÿåˆ—ï¼Œå»¶æ—¶æ‹‰å–ï¼Œç„¶åè¿”å›</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> beginTimestamp <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// åˆ›å»ºæ‹‰å–å›è°ƒ</span>
        PullCallback pullCallback <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PullCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSuccess</span><span class="token punctuation">(</span>PullResult pullResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>pullResult <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å¤„ç†æ‹‰å–ç»“æœï¼Œå®¢æˆ·ç«¯æ ¹æ®Tagçš„å­—ç¬¦ä¸²å†æ¬¡è¿‡æ»¤</span>
                    <span class="token comment" spellcheck="true">// ç™¾åº¦äº†ä¸€ä¸‹ï¼ŒRocketMQä¹‹æ‰€ä»¥è®¾è®¡ä¸ºBrokeræ ¹æ®å“ˆå¸Œè¿‡æ»¤è€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨å­—ç¬¦ä¸²ï¼Œæ˜¯å› ä¸ºConsumeQueueä¸ºäº†æ€§èƒ½è®¾è®¡ä¸ºå®šé•¿å•å…ƒï¼Œæ˜¾ç„¶ä¸èƒ½ä½¿ç”¨å­—ç¬¦ä¸²</span>
                    pullResult <span class="token operator">=</span> DefaultMQPushConsumerImpl<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>pullAPIWrapper<span class="token punctuation">.</span><span class="token function">processPullResult</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pullResult<span class="token punctuation">,</span> subscriptionData<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// æ‹‰å–çŠ¶æ€</span>
                    <span class="token keyword">switch</span> <span class="token punctuation">(</span>pullResult<span class="token punctuation">.</span><span class="token function">getPullStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// æ‰¾åˆ°äº†æ¶ˆæ¯</span>
                        <span class="token keyword">case</span> FOUND<span class="token operator">:</span>
                            <span class="token keyword">long</span> prevRequestOffset <span class="token operator">=</span> pullRequest<span class="token punctuation">.</span><span class="token function">getNextOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// æ ¹æ®Brokerè¿”å›çš„ä¸‹æ¬¡æ‹‰å–çš„å¼€å§‹åç§»æ›´æ–°PullRequest</span>
                            pullRequest<span class="token punctuation">.</span><span class="token function">setNextOffset</span><span class="token punctuation">(</span>pullResult<span class="token punctuation">.</span><span class="token function">getNextBeginOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// RoundTime</span>
                            <span class="token keyword">long</span> pullRT <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> beginTimestamp<span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// ç»Ÿè®¡</span>
                            DefaultMQPushConsumerImpl<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getConsumerStatsManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">incPullRT</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pullRequest<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pullRT<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">long</span> firstMsgOffset <span class="token operator">=</span> Long<span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// å¦‚æœæ²¡æœ‰æ¶ˆæ¯ï¼Œå¯èƒ½æ˜¯åœ¨ä¸Šé¢è¢«Consumerè¿‡æ»¤äº†Tag</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>pullResult<span class="token punctuation">.</span><span class="token function">getMsgFoundList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null <span class="token operator">||</span> pullResult<span class="token punctuation">.</span><span class="token function">getMsgFoundList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token comment" spellcheck="true">// ç›´æ¥æäº¤PullRequeståˆ°é˜Ÿåˆ—ï¼Œæ‰§è¡Œä¸‹ä¸€æ¬¡æ‹‰å–</span>
                                DefaultMQPushConsumerImpl<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">executePullRequestImmediately</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            <span class="token comment" spellcheck="true">// æœ‰æ¶ˆæ¯</span>
                            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                                firstMsgOffset <span class="token operator">=</span> pullResult<span class="token punctuation">.</span><span class="token function">getMsgFoundList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueueOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token comment" spellcheck="true">// ç»Ÿè®¡</span>
                                DefaultMQPushConsumerImpl<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getConsumerStatsManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">incPullTPS</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pullRequest<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pullResult<span class="token punctuation">.</span><span class="token function">getMsgFoundList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token comment" spellcheck="true">// æŠŠæ¶ˆæ¯æ”¾å…¥ProcessQueueï¼Œè¿”å›æ˜¯å¦åˆ†å‘ç»™æ¶ˆè´¹è€…æ¶ˆè´¹</span>
                                <span class="token keyword">boolean</span> dispatchToConsume <span class="token operator">=</span> processQueue<span class="token punctuation">.</span><span class="token function">putMessage</span><span class="token punctuation">(</span>pullResult<span class="token punctuation">.</span><span class="token function">getMsgFoundList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token comment" spellcheck="true">// åˆ›å»ºConsumeRequestå¯¹è±¡ï¼Œæäº¤åˆ°çº¿ç¨‹æ± ï¼Œè°ƒç”¨MessageListeneræ¶ˆè´¹æ¶ˆæ¯ï¼Œå¤„ç†å®Œæˆä¼šé€šçŸ¥ProcessQueue</span>
                                DefaultMQPushConsumerImpl<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>consumeMessageService<span class="token punctuation">.</span><span class="token function">submitConsumeRequest</span><span class="token punctuation">(</span>pullResult<span class="token punctuation">.</span><span class="token function">getMsgFoundList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> processQueue<span class="token punctuation">,</span> pullRequest<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dispatchToConsume<span class="token punctuation">)</span><span class="token punctuation">;</span>

                                <span class="token keyword">if</span> <span class="token punctuation">(</span>DefaultMQPushConsumerImpl<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getPullInterval</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    <span class="token comment" spellcheck="true">// å»¶è¿Ÿé—´éš”æ—¶é—´åå†æ¬¡æäº¤PullRequeståˆ°é˜Ÿåˆ—</span>
                                    DefaultMQPushConsumerImpl<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">executePullRequestLater</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">,</span> DefaultMQPushConsumerImpl<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getPullInterval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                                <span class="token comment" spellcheck="true">// PushConsumer</span>
                                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                                    <span class="token comment" spellcheck="true">// ç›´æ¥æäº¤PullRequeståˆ°é˜Ÿåˆ—ï¼Œæ‰§è¡Œä¸‹ä¸€æ¬¡æ‹‰å–</span>
                                    DefaultMQPushConsumerImpl<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">executePullRequestImmediately</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// æ²¡æœ‰æ‰¾åˆ°æ–°çš„æ¶ˆæ¯</span>
                        <span class="token keyword">case</span> NO_NEW_MSG<span class="token operator">:</span>
                            <span class="token comment" spellcheck="true">// ä½¿ç”¨Brokeræ ¡å‡†çš„åç§»</span>
                            pullRequest<span class="token punctuation">.</span><span class="token function">setNextOffset</span><span class="token punctuation">(</span>pullResult<span class="token punctuation">.</span><span class="token function">getNextBeginOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            DefaultMQPushConsumerImpl<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">correctTagsOffset</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// ç›´æ¥æäº¤PullRequeståˆ°é˜Ÿåˆ—ï¼Œæ‰§è¡Œä¸‹ä¸€æ¬¡æ‹‰å–</span>
                            DefaultMQPushConsumerImpl<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">executePullRequestImmediately</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token keyword">case</span> NO_MATCHED_MSG<span class="token operator">:</span>
                            pullRequest<span class="token punctuation">.</span><span class="token function">setNextOffset</span><span class="token punctuation">(</span>pullResult<span class="token punctuation">.</span><span class="token function">getNextBeginOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            DefaultMQPushConsumerImpl<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">correctTagsOffset</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            DefaultMQPushConsumerImpl<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">executePullRequestImmediately</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// åç§»éæ³•</span>
                        <span class="token keyword">case</span> OFFSET_ILLEGAL<span class="token operator">:</span>
                            <span class="token comment" spellcheck="true">// ä½¿ç”¨Brokeræ ¡å‡†çš„åç§»</span>
                            pullRequest<span class="token punctuation">.</span><span class="token function">setNextOffset</span><span class="token punctuation">(</span>pullResult<span class="token punctuation">.</span><span class="token function">getNextBeginOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// å°†è¯¥ProcessQueueæ ‡è®°ä¸ºä¸¢å¼ƒ</span>
                            pullRequest<span class="token punctuation">.</span><span class="token function">getProcessQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setDropped</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// æäº¤å»¶æ—¶ä»»åŠ¡ï¼Œå°†PullRequestæ”¾å›é˜Ÿåˆ—ï¼Œå»¶æ—¶æ‹‰å–</span>
                            DefaultMQPushConsumerImpl<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">executeTaskLater</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                                <span class="token annotation punctuation">@Override</span>
                                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                                        <span class="token comment" spellcheck="true">// æ›´æ–°Consumeræœ¬åœ°è¯¥MessageQueueçš„æ¶ˆè´¹è¿›åº¦ç¼“å­˜</span>
                                        DefaultMQPushConsumerImpl<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>offsetStore<span class="token punctuation">.</span><span class="token function">updateOffset</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pullRequest<span class="token punctuation">.</span><span class="token function">getNextOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                        <span class="token comment" spellcheck="true">// æŒä¹…åŒ–å½“å‰æ¶ˆæ¯é˜Ÿåˆ—çš„æ¶ˆè´¹è¿›åº¦ï¼Œé›†ç¾¤æ¨¡å¼ä¸‹æ˜¯å‘Brokerå‘é€UPDATE_CONSUMER_OFFSETçš„å•å‘è¯·æ±‚</span>
                                        DefaultMQPushConsumerImpl<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>offsetStore<span class="token punctuation">.</span><span class="token function">persist</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                        <span class="token comment" spellcheck="true">// ç§»é™¤å½“å‰MessageQueueçš„ProcessQueueï¼Œç­‰å¾…ä¸‹æ¬¡æ‰§è¡Œè´Ÿè½½å‡è¡¡</span>
                                        DefaultMQPushConsumerImpl<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>rebalanceImpl<span class="token punctuation">.</span><span class="token function">removeProcessQueue</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                        <span class="token comment" spellcheck="true">// ...</span>
                                    <span class="token punctuation">}</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token keyword">default</span><span class="token operator">:</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onException</span><span class="token punctuation">(</span>Throwable e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æäº¤å»¶æ—¶ä»»åŠ¡ï¼Œå°†PullRequestæ”¾å›é˜Ÿåˆ—ï¼Œå»¶æ—¶æ‹‰å–</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// å›è°ƒä»£ç ç»“æŸ</span>
        <span class="token comment" spellcheck="true">// æ˜¯å¦åŒæ­¥æ¶ˆè´¹è¿›åº¦åˆ°Brokerï¼Œé™¤äº†å®šæ—¶ä»»åŠ¡å‘BrokeråŒæ­¥æ¶ˆè´¹è¿›åº¦ï¼Œæ‹‰å–æ¶ˆæ¯æ—¶ä¹Ÿå¯èƒ½ä¼šé¡ºä¾¿åŒæ­¥</span>
        <span class="token keyword">boolean</span> commitOffsetEnable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> commitOffsetValue <span class="token operator">=</span> 0L<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¦‚æœæ˜¯é›†ç¾¤æ¶ˆè´¹æ¨¡å¼</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>MessageModel<span class="token punctuation">.</span>CLUSTERING <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getMessageModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ä»æœ¬åœ°ç¼“å­˜è·å–è¯¥MessageQueueçš„æ¶ˆè´¹è¿›åº¦</span>
            commitOffsetValue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>offsetStore<span class="token punctuation">.</span><span class="token function">readOffset</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ReadOffsetType<span class="token punctuation">.</span>READ_FROM_MEMORY<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>commitOffsetValue <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// åŒæ­¥</span>
                commitOffsetEnable <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        String subExpression <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> classFilter <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        SubscriptionData sd <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rebalanceImpl<span class="token punctuation">.</span><span class="token function">getSubscriptionInner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sd <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ç³»ç»Ÿæ ‡è®°</span>
        <span class="token keyword">int</span> sysFlag <span class="token operator">=</span> PullSysFlag<span class="token punctuation">.</span><span class="token function">buildSysFlag</span><span class="token punctuation">(</span>commitOffsetEnable<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// commitOffset</span>
                <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// suspend</span>
                subExpression <span class="token operator">!=</span> null<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// subscription</span>
                classFilter <span class="token comment" spellcheck="true">// class filter</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ‰§è¡Œæ‹‰å–</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>pullAPIWrapper<span class="token punctuation">.</span><span class="token function">pullKernelImpl</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//</span>
                    subExpression<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//</span>
                    subscriptionData<span class="token punctuation">.</span><span class="token function">getExpressionType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//</span>
                    subscriptionData<span class="token punctuation">.</span><span class="token function">getSubVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//</span>
                    pullRequest<span class="token punctuation">.</span><span class="token function">getNextOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getPullBatchSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// æ‰¹é‡æ‹‰å–å¤§å°</span>
                    sysFlag<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//</span>
                    commitOffsetValue<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//</span>
                    BROKER_SUSPEND_MAX_TIME_MILLIS<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//</span>
                    CONSUMER_TIMEOUT_MILLIS_WHEN_SUSPEND<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//</span>
                    CommunicationMode<span class="token punctuation">.</span>ASYNC<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// å¼‚æ­¥</span>
                    pullCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æäº¤å»¶æ—¶ä»»åŠ¡ï¼Œå°†PullRequestæ”¾å›é˜Ÿåˆ—ï¼Œå»¶æ—¶æ‹‰å–</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">executePullRequestLater</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">,</span> PULL_TIME_DELAY_MILLS_WHEN_EXCEPTION<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>PullAPIWrapper#pullKernelImpl</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> PullResult <span class="token function">pullKernelImpl</span><span class="token punctuation">(</span><span class="token keyword">final</span> MessageQueue mq<span class="token punctuation">,</span> <span class="token keyword">final</span> String subExpression<span class="token punctuation">,</span> <span class="token keyword">final</span> String expressionType<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> subVersion<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> offset<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> maxNums<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> sysFlag<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> commitOffset<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> brokerSuspendMaxTimeMillis<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> timeoutMillis<span class="token punctuation">,</span> <span class="token keyword">final</span> CommunicationMode communicationMode<span class="token punctuation">,</span> <span class="token keyword">final</span> PullCallback pullCallback<span class="token punctuation">)</span> <span class="token keyword">throws</span> MQClientException<span class="token punctuation">,</span> RemotingException<span class="token punctuation">,</span> MQBrokerException<span class="token punctuation">,</span> InterruptedException <span class="token punctuation">{</span>

        <span class="token comment" spellcheck="true">// æ ¹æ®MessageQueueçš„BrokerNameåŠä¸Šæ¬¡ä»Brokeræ‹‰å–è¿”å›çš„å»ºè®®BrokerIdï¼Œå†³å®šBrokerçš„åœ°å€</span>
        FindBrokerResult findBrokerResult <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">.</span><span class="token function">findBrokerAddressInSubscribe</span><span class="token punctuation">(</span>mq<span class="token punctuation">.</span><span class="token function">getBrokerName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">recalculatePullFromWhichNode</span><span class="token punctuation">(</span>mq<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ²¡æœ‰å°±ä»NameServeræ›´æ–°åå†è·å–</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">==</span> findBrokerResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>findBrokerResult <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ£€æŸ¥ç‰ˆæœ¬...</span>
            <span class="token keyword">int</span> sysFlagInner <span class="token operator">=</span> sysFlag<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å¦‚æœæ˜¯å‘Slaveæ‹‰å–æ¶ˆæ¯</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>findBrokerResult<span class="token punctuation">.</span><span class="token function">isSlave</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æ¸…é™¤åŒæ­¥æ¶ˆè´¹åç§»çš„æ ‡è®°</span>
                sysFlagInner <span class="token operator">=</span> PullSysFlag<span class="token punctuation">.</span><span class="token function">clearCommitOffsetFlag</span><span class="token punctuation">(</span>sysFlagInner<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            PullMessageRequestHeader requestHeader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PullMessageRequestHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ConsumerGroup</span>
            requestHeader<span class="token punctuation">.</span><span class="token function">setConsumerGroup</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>consumerGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ‹‰å–çš„Topic</span>
            requestHeader<span class="token punctuation">.</span><span class="token function">setTopic</span><span class="token punctuation">(</span>mq<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ‹‰å–çš„MessageQueueId</span>
            requestHeader<span class="token punctuation">.</span><span class="token function">setQueueId</span><span class="token punctuation">(</span>mq<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æœ¬æ¬¡æ‹‰å–çš„èµ·å§‹åç§»</span>
            requestHeader<span class="token punctuation">.</span><span class="token function">setQueueOffset</span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ä¸€æ¬¡æ‹‰å–çš„æœ€å¤§æ¶ˆæ¯æ•°é‡</span>
            requestHeader<span class="token punctuation">.</span><span class="token function">setMaxMsgNums</span><span class="token punctuation">(</span>maxNums<span class="token punctuation">)</span><span class="token punctuation">;</span>
            requestHeader<span class="token punctuation">.</span><span class="token function">setSysFlag</span><span class="token punctuation">(</span>sysFlagInner<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å‘BrokeråŒæ­¥Consumerå¯¹è¯¥MessageQueueçš„æ¶ˆè´¹è¿›åº¦</span>
            requestHeader<span class="token punctuation">.</span><span class="token function">setCommitOffset</span><span class="token punctuation">(</span>commitOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            requestHeader<span class="token punctuation">.</span><span class="token function">setSuspendTimeoutMillis</span><span class="token punctuation">(</span>brokerSuspendMaxTimeMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
            requestHeader<span class="token punctuation">.</span><span class="token function">setSubscription</span><span class="token punctuation">(</span>subExpression<span class="token punctuation">)</span><span class="token punctuation">;</span>
            requestHeader<span class="token punctuation">.</span><span class="token function">setSubVersion</span><span class="token punctuation">(</span>subVersion<span class="token punctuation">)</span><span class="token punctuation">;</span>
            requestHeader<span class="token punctuation">.</span><span class="token function">setExpressionType</span><span class="token punctuation">(</span>expressionType<span class="token punctuation">)</span><span class="token punctuation">;</span>
            String brokerAddr <span class="token operator">=</span> findBrokerResult<span class="token punctuation">.</span><span class="token function">getBrokerAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æœ‰è¿‡æ»¤æ ‡è®°</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>PullSysFlag<span class="token punctuation">.</span><span class="token function">hasClassFilterFlag</span><span class="token punctuation">(</span>sysFlagInner<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// éšæœºé€‰æ‹©ä¸€ä¸ªFilterServerçš„åœ°å€ï¼Œä¹‹åå°±ä»FilterServeræ‹‰å–æ¶ˆæ¯</span>
                brokerAddr <span class="token operator">=</span> <span class="token function">computPullFromWhichFilterServer</span><span class="token punctuation">(</span>mq<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> brokerAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å‘é€PULL_MESSAGEè¯·æ±‚ï¼Œä»Brokeræ‹‰å–æ¶ˆæ¯</span>
            PullResult pullResult <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">.</span><span class="token function">getMQClientAPIImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pullMessage</span><span class="token punctuation">(</span>brokerAddr<span class="token punctuation">,</span> requestHeader<span class="token punctuation">,</span> timeoutMillis<span class="token punctuation">,</span> communicationMode<span class="token punctuation">,</span> pullCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> pullResult<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// æŠ›å¼‚å¸¸</span>
    <span class="token punctuation">}</span></code></pre>
<p>MQClientAPIImpl#pullMessageAsync</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">pullMessageAsync</span><span class="token punctuation">(</span><span class="token keyword">final</span> String addr<span class="token punctuation">,</span> <span class="token keyword">final</span> RemotingCommand request<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> timeoutMillis<span class="token punctuation">,</span> <span class="token keyword">final</span> PullCallback pullCallback<span class="token punctuation">)</span> <span class="token keyword">throws</span> RemotingException<span class="token punctuation">,</span> InterruptedException <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>remotingClient<span class="token punctuation">.</span><span class="token function">invokeAsync</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> request<span class="token punctuation">,</span> timeoutMillis<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">InvokeCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">operationComplete</span><span class="token punctuation">(</span>ResponseFuture responseFuture<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                RemotingCommand response <span class="token operator">=</span> responseFuture<span class="token punctuation">.</span><span class="token function">getResponseCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>response <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        PullResult pullResult <span class="token operator">=</span> MQClientAPIImpl<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">processPullResponse</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">assert</span> pullResult <span class="token operator">!=</span> null<span class="token punctuation">;</span>
                        pullCallback<span class="token punctuation">.</span><span class="token function">onSuccess</span><span class="token punctuation">(</span>pullResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        pullCallback<span class="token punctuation">.</span><span class="token function">onException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>PullAPIWrapper#processPullResult</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> PullResult <span class="token function">processPullResult</span><span class="token punctuation">(</span><span class="token keyword">final</span> MessageQueue mq<span class="token punctuation">,</span> <span class="token keyword">final</span> PullResult pullResult<span class="token punctuation">,</span> <span class="token keyword">final</span> SubscriptionData subscriptionData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        PullResultExt pullResultExt <span class="token operator">=</span> <span class="token punctuation">(</span>PullResultExt<span class="token punctuation">)</span> pullResult<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ ¹æ®Brokerçš„è¿”å›å»ºè®®ï¼Œæ›´æ–°ä¸‹æ¬¡å»ºè®®æ‹‰å–çš„Broker</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updatePullFromWhichNode</span><span class="token punctuation">(</span>mq<span class="token punctuation">,</span> pullResultExt<span class="token punctuation">.</span><span class="token function">getSuggestWhichBrokerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ‹‰å–åˆ°äº†æ¶ˆæ¯</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>PullStatus<span class="token punctuation">.</span>FOUND <span class="token operator">==</span> pullResult<span class="token punctuation">.</span><span class="token function">getPullStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ByteBuffer byteBuffer <span class="token operator">=</span> ByteBuffer<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>pullResultExt<span class="token punctuation">.</span><span class="token function">getMessageBinary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è§£ç æ‹‰å–çš„æ¶ˆæ¯åˆ—è¡¨</span>
            List<span class="token operator">&lt;</span>MessageExt<span class="token operator">></span> msgList <span class="token operator">=</span> MessageDecoder<span class="token punctuation">.</span><span class="token function">decodes</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            List<span class="token operator">&lt;</span>MessageExt<span class="token operator">></span> msgListFilterAgain <span class="token operator">=</span> msgList<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>subscriptionData<span class="token punctuation">.</span><span class="token function">getTagsSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>subscriptionData<span class="token punctuation">.</span><span class="token function">isClassFilterMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                msgListFilterAgain <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>MessageExt<span class="token operator">></span><span class="token punctuation">(</span>msgList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>MessageExt msg <span class="token operator">:</span> msgList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getTags</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// Brokeråªæ˜¯æ ¹æ®Tagçš„å“ˆå¸Œå€¼è¿‡æ»¤ï¼Œå› ä¸ºå¯èƒ½å­˜åœ¨å“ˆå¸Œå†²çªï¼ŒConsumeréœ€è¦æ ¹æ®å­—ç¬¦ä¸²å†æ¬¡è¿‡æ»¤</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>subscriptionData<span class="token punctuation">.</span><span class="token function">getTagsSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getTags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            msgListFilterAgain<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// æ‰§è¡Œé’©å­å‡½æ•°ï¼Œç”¨äºè¿‡æ»¤æ¶ˆæ¯</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hasHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>MessageExt msg <span class="token operator">:</span> msgListFilterAgain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ä¸€äº›å±æ€§å¤„ç†</span>
            <span class="token punctuation">}</span>
            pullResultExt<span class="token punctuation">.</span><span class="token function">setMsgFoundList</span><span class="token punctuation">(</span>msgListFilterAgain<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        pullResultExt<span class="token punctuation">.</span><span class="token function">setMessageBinary</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> pullResult<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ProcessQueue#putMessage</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">putMessage</span><span class="token punctuation">(</span><span class="token keyword">final</span> List<span class="token operator">&lt;</span>MessageExt<span class="token operator">></span> msgs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// æ˜¯å¦åˆ†å‘ç»™æ¶ˆè´¹è€…æ¶ˆè´¹</span>
        <span class="token keyword">boolean</span> dispatchToConsume <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è·å–å†™é”</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>lockTreeMap<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> validMsgCnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>MessageExt msg <span class="token operator">:</span> msgs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å°†æ¶ˆæ¯åŠ å…¥TreeMapï¼Œç­‰å¾…è¢«æ¶ˆè´¹</span>
                    <span class="token comment" spellcheck="true">// æ³¨æ„è¿™é‡ŒTreeMapä¼šè‡ªåŠ¨æ’åºï¼Œé”®ä¸ºæ¶ˆæ¯åœ¨é˜Ÿåˆ—çš„åç§»ï¼ˆç´¢å¼•ï¼‰</span>
                    MessageExt old <span class="token operator">=</span> msgTreeMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getQueueOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// æ¶ˆæ¯æœªé‡å¤</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">==</span> old<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        validMsgCnt<span class="token operator">++</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// æ›´æ–°é˜Ÿåˆ—æœ€å¤§åç§»</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>queueOffsetMax <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getQueueOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        msgSize<span class="token punctuation">.</span><span class="token function">addAndGet</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                msgCount<span class="token punctuation">.</span><span class="token function">addAndGet</span><span class="token punctuation">(</span>validMsgCnt<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// Mapæœ‰æ¶ˆæ¯è¢«æ¶ˆè´¹ &amp;&amp; å½“å‰æ­¤ProcessQueueæ²¡è¢«æ¶ˆè´¹</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>msgTreeMap<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>consuming<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// åˆ†å‘ç»™æ¶ˆè´¹è€…æ¶ˆè´¹</span>
                    dispatchToConsume <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// æ ‡è®°ä¸ºæ­£åœ¨è¢«æ¶ˆè´¹</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>consuming <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>msgs<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>lockTreeMap<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> dispatchToConsume<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>é¡ºåºæ¶ˆè´¹</p>
<p>ConsumeMessageOrderlyService#submitConsumeRequest</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">submitConsumeRequest</span><span class="token punctuation">(</span><span class="token keyword">final</span> List<span class="token operator">&lt;</span>MessageExt<span class="token operator">></span> msgs<span class="token punctuation">,</span> <span class="token keyword">final</span> ProcessQueue processQueue<span class="token punctuation">,</span> <span class="token keyword">final</span> MessageQueue messageQueue<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> dispathToConsume<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dispathToConsume<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ConsumeRequest consumeRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConsumeRequest</span><span class="token punctuation">(</span>processQueue<span class="token punctuation">,</span> messageQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æäº¤æ¶ˆè´¹è¯·æ±‚</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>consumeExecutor<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>consumeRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>ConsumeMessageOrderlyService$ConsumeRequest#run</p>
<pre class=" language-java"><code class="language-java">       <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ProcessQueueè¢«æ ‡è®°ä¸ºåºŸå¼ƒå°±ä¸å†æ¶ˆè´¹</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>processQueue<span class="token punctuation">.</span><span class="token function">isDropped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// è·å–è¯¥MessageQueueçš„é”å¯¹è±¡</span>
            <span class="token keyword">final</span> Object objLock <span class="token operator">=</span> messageQueueLock<span class="token punctuation">.</span><span class="token function">fetchLockObject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messageQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è·å–åŒæ­¥é”</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>objLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å¹¿æ’­æ¨¡å¼ || é›†ç¾¤æ¶ˆè´¹æ¨¡å¼ï¼ŒProcessQueueè¢«é”å®šå¹¶ä¸”æ²¡å¤±æ•ˆ</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>MessageModel<span class="token punctuation">.</span>BROADCASTING<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>ConsumeMessageOrderlyService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumerImpl<span class="token punctuation">.</span><span class="token function">messageModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>processQueue<span class="token punctuation">.</span><span class="token function">isLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>processQueue<span class="token punctuation">.</span><span class="token function">isLockExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> <span class="token keyword">long</span> beginTime <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">//</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">boolean</span> continueConsume <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> continueConsume<span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// æ¯æ¬¡æ¶ˆè´¹å‰æ£€æŸ¥ï¼ŒProcessQueueè¢«æ ‡è®°ä¸ºåºŸå¼ƒå°±ä¸å†æ¶ˆè´¹</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>processQueue<span class="token punctuation">.</span><span class="token function">isDropped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment" spellcheck="true">// é›†ç¾¤æ¶ˆè´¹æ¨¡å¼ &amp;&amp; ProcessQueueæ²¡è¢«é”å®š</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>MessageModel<span class="token punctuation">.</span>CLUSTERING<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>ConsumeMessageOrderlyService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumerImpl<span class="token punctuation">.</span><span class="token function">messageModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>processQueue<span class="token punctuation">.</span><span class="token function">isLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// ç¨åå‘Brokerå‘é€LOCK_BATCH_MQè¯·æ±‚ï¼Œè·å–è¯¥MessageQueueçš„åˆ†å¸ƒå¼é”ï¼Œç„¶åé‡æ–°æäº¤ConsumeRequestè¯·æ±‚</span>
                            ConsumeMessageOrderlyService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">tryLockLaterAndReconsume</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messageQueue<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>processQueue<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment" spellcheck="true">// é›†ç¾¤æ¶ˆè´¹æ¨¡å¼ &amp;&amp; ProcessQueueé”å¤±æ•ˆ</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>MessageModel<span class="token punctuation">.</span>CLUSTERING<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>ConsumeMessageOrderlyService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumerImpl<span class="token punctuation">.</span><span class="token function">messageModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>processQueue<span class="token punctuation">.</span><span class="token function">isLockExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// ç¨åå‘Brokerå‘é€LOCK_BATCH_MQè¯·æ±‚ï¼Œè·å–è¯¥MessageQueueçš„åˆ†å¸ƒå¼é”ï¼Œç„¶åé‡æ–°æäº¤ConsumeRequestè¯·æ±‚</span>
                            ConsumeMessageOrderlyService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">tryLockLaterAndReconsume</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messageQueue<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>processQueue<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment" spellcheck="true">// æäº¤åˆ†å¸ƒå¼é”è¯·æ±‚è€—æ—¶</span>
                        <span class="token keyword">long</span> interval <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> beginTime<span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// æ—¶é—´è¿‡é•¿ï¼Œè¶…è¿‡60ç§’</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>interval <span class="token operator">></span> MAX_TIME_CONSUME_CONTINUOUSLY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// é‡æ–°æäº¤ConsumeRequestè¯·æ±‚</span>
                            ConsumeMessageOrderlyService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">submitConsumeRequestLater</span><span class="token punctuation">(</span>processQueue<span class="token punctuation">,</span> messageQueue<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment" spellcheck="true">// æœ¬æ¬¡æ¶ˆè´¹çš„æ¶ˆæ¯æ•°é‡</span>
                        <span class="token keyword">final</span> <span class="token keyword">int</span> consumeBatchSize <span class="token operator">=</span> ConsumeMessageOrderlyService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getConsumeMessageBatchMaxSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// ä»å¤„ç†é˜Ÿåˆ—æ‹¿å‡ºæ¶ˆæ¯ï¼Œé¡ºåºæ¶ˆè´¹ä¼šæŠŠå¾…æ¶ˆè´¹çš„æ¶ˆæ¯å–å‡ºï¼Œå¹¶æ”¾å…¥ä¸´æ—¶çš„TreeMapä¸­ï¼ŒæŒ‰é˜Ÿåˆ—åç§»æ’åºï¼Œæ‰€ä»¥æ˜¯æœ‰åºæ¶ˆè´¹</span>
                        <span class="token comment" spellcheck="true">// å¦å¤–ï¼ŒtakeMessagsæ‹¼å†™é”™è¯¯</span>
                        List<span class="token operator">&lt;</span>MessageExt<span class="token operator">></span> msgs <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>processQueue<span class="token punctuation">.</span><span class="token function">takeMessags</span><span class="token punctuation">(</span>consumeBatchSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        defaultMQPushConsumerImpl<span class="token punctuation">.</span><span class="token function">resetRetryAndNamespace</span><span class="token punctuation">(</span>msgs<span class="token punctuation">,</span> defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>msgs<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">final</span> ConsumeOrderlyContext context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConsumeOrderlyContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messageQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            ConsumeOrderlyStatus status <span class="token operator">=</span> null<span class="token punctuation">;</span>
                            ConsumeMessageContext consumeMessageContext <span class="token operator">=</span> null<span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// æ‰§è¡Œå‰ç½®Hook</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>ConsumeMessageOrderlyService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumerImpl<span class="token punctuation">.</span><span class="token function">hasHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token comment" spellcheck="true">// ...</span>
                            <span class="token punctuation">}</span>
                            <span class="token keyword">long</span> beginTimestamp <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            ConsumeReturnType returnType <span class="token operator">=</span> ConsumeReturnType<span class="token punctuation">.</span>SUCCESS<span class="token punctuation">;</span>
                            <span class="token keyword">boolean</span> hasException <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                                <span class="token comment" spellcheck="true">// å…ˆè·å–ProcessQueueé”</span>
                                <span class="token keyword">this</span><span class="token punctuation">.</span>processQueue<span class="token punctuation">.</span><span class="token function">getLockConsume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token comment" spellcheck="true">// å†æ¬¡æ£€æŸ¥</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>processQueue<span class="token punctuation">.</span><span class="token function">isDropped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                                <span class="token comment" spellcheck="true">// å†ä½¿ç”¨ç›‘å¬å™¨æ¶ˆè´¹æ¶ˆæ¯ï¼Œè¿”å›æ¶ˆè´¹çŠ¶æ€ï¼Œæ³¨æ„æ¶ˆè´¹éƒ½æ˜¯æ‰¹é‡çš„</span>
                                status <span class="token operator">=</span> messageListener<span class="token punctuation">.</span><span class="token function">consumeMessage</span><span class="token punctuation">(</span>Collections<span class="token punctuation">.</span><span class="token function">unmodifiableList</span><span class="token punctuation">(</span>msgs<span class="token punctuation">)</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token comment" spellcheck="true">// ...</span>
                            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                                <span class="token comment" spellcheck="true">// æœ€åé‡Šæ”¾ProcessQueueé”</span>
                                <span class="token keyword">this</span><span class="token punctuation">.</span>processQueue<span class="token punctuation">.</span><span class="token function">getLockConsume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            <span class="token comment" spellcheck="true">// ...</span>
                            <span class="token keyword">long</span> consumeRT <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> beginTimestamp<span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">==</span> status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token comment" spellcheck="true">// ...</span>
                            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>consumeRT <span class="token operator">>=</span> defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getConsumeTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token comment" spellcheck="true">// ...</span>
                            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ConsumeOrderlyStatus<span class="token punctuation">.</span>SUSPEND_CURRENT_QUEUE_A_MOMENT <span class="token operator">==</span> status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token comment" spellcheck="true">// ...</span>
                            <span class="token punctuation">}</span>
                            <span class="token comment" spellcheck="true">// æ¶ˆè´¹æˆåŠŸ</span>
                            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ConsumeOrderlyStatus<span class="token punctuation">.</span>SUCCESS <span class="token operator">==</span> status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                returnType <span class="token operator">=</span> ConsumeReturnType<span class="token punctuation">.</span>SUCCESS<span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            <span class="token comment" spellcheck="true">// ...</span>
                            <span class="token comment" spellcheck="true">// æ‰§è¡Œåç½®Hook</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>ConsumeMessageOrderlyService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumerImpl<span class="token punctuation">.</span><span class="token function">hasHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token comment" spellcheck="true">// ...</span>
                            <span class="token punctuation">}</span>
                            ConsumeMessageOrderlyService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getConsumerStatsManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">incConsumeRT</span><span class="token punctuation">(</span>ConsumeMessageOrderlyService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>consumerGroup<span class="token punctuation">,</span> messageQueue<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> consumeRT<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// æ ¹æ®æ¶ˆè´¹ç»“æœå†³å®šæ˜¯å¦ç»§ç»­æ¶ˆè´¹</span>
                            continueConsume <span class="token operator">=</span> ConsumeMessageOrderlyService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">processConsumeResult</span><span class="token punctuation">(</span>msgs<span class="token punctuation">,</span> status<span class="token punctuation">,</span> context<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            continueConsume <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// é›†ç¾¤æ¶ˆè´¹æ¨¡å¼ï¼Œé˜Ÿåˆ—æ²¡è¢«é”å®šæˆ–è€…é”å¤±æ•ˆ</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>processQueue<span class="token punctuation">.</span><span class="token function">isDropped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// ç¨åå‘Brokerå‘é€LOCK_BATCH_MQè¯·æ±‚ï¼Œè·å–è¯¥MessageQueueçš„åˆ†å¸ƒå¼é”ï¼Œç„¶åé‡æ–°æäº¤ConsumeRequestè¯·æ±‚</span>
                    <span class="token comment" spellcheck="true">// é›†ç¾¤æ¨¡å¼ä¸‹ï¼Œé˜Ÿåˆ—å¿…é¡»è¢«é”å®šæ‰èƒ½è¢«æ¶ˆè´¹</span>
                    ConsumeMessageOrderlyService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">tryLockLaterAndReconsume</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messageQueue<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>processQueue<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span></code></pre>
<p>ConsumeMessageOrderlyService#processConsumeResult</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">processConsumeResult</span><span class="token punctuation">(</span><span class="token keyword">final</span> List<span class="token operator">&lt;</span>MessageExt<span class="token operator">></span> msgs<span class="token punctuation">,</span> <span class="token keyword">final</span> ConsumeOrderlyStatus status<span class="token punctuation">,</span> <span class="token keyword">final</span> ConsumeOrderlyContext context<span class="token punctuation">,</span> <span class="token keyword">final</span> ConsumeRequest consumeRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> continueConsume <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> commitOffset <span class="token operator">=</span> <span class="token operator">-</span>1L<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// é»˜è®¤ï¼Œè‡ªåŠ¨æäº¤æ¶ˆè´¹è¿›åº¦</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">isAutoCommit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> COMMIT<span class="token operator">:</span>
                <span class="token keyword">case</span> ROLLBACK<span class="token operator">:</span>
                <span class="token keyword">case</span> SUCCESS<span class="token operator">:</span>
                    <span class="token comment" spellcheck="true">// è¿”å›æœ¬æ‰¹æ¶ˆæ¯çš„é˜Ÿåˆ—æ¶ˆè´¹åç§»</span>
                    commitOffset <span class="token operator">=</span> consumeRequest<span class="token punctuation">.</span><span class="token function">getProcessQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// ç»Ÿè®¡</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getConsumerStatsManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">incConsumeOKTPS</span><span class="token punctuation">(</span>consumerGroup<span class="token punctuation">,</span> consumeRequest<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msgs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> SUSPEND_CURRENT_QUEUE_A_MOMENT<span class="token operator">:</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getConsumerStatsManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">incConsumeFailedTPS</span><span class="token punctuation">(</span>consumerGroup<span class="token punctuation">,</span> consumeRequest<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> msgs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// æ¶ˆæ¯æœªè¶…è¿‡æœ€å¤§é‡æ¶ˆè´¹æ¬¡æ•°ï¼Œæˆ–è€…è¶…å‡ºäº†å¹¶ä¸”æŠŠæ¶ˆæ¯å‘å›Brokerçš„æ­»ä¿¡é˜Ÿåˆ—å¤±è´¥</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkReconsumeTimes</span><span class="token punctuation">(</span>msgs<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// è®¾ç½®å¯é‡æ–°æ¶ˆè´¹ï¼Œå°†æœ¬æ‰¹æ¶ˆæ¯æ”¾å›ProcessQueue</span>
                        consumeRequest<span class="token punctuation">.</span><span class="token function">getProcessQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">makeMessageToCosumeAgain</span><span class="token punctuation">(</span>msgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// æäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚ï¼Œå»¶è¿Ÿæ¶ˆè´¹è¯¥é˜Ÿåˆ—</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">submitConsumeRequestLater</span><span class="token punctuation">(</span>consumeRequest<span class="token punctuation">.</span><span class="token function">getProcessQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> consumeRequest<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span><span class="token function">getSuspendCurrentQueueTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// ä¸èƒ½ç»§ç»­æ¶ˆè´¹ï¼Œé¡ºåºæ¶ˆæ¯ï¼Œä¸èƒ½è·³è¿‡</span>
                        continueConsume <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// æ¶ˆæ¯è¶…è¿‡æœ€å¤§é‡æ¶ˆè´¹æ¬¡æ•°ï¼Œå¹¶ä¸”å‘é€å›æ­»ä¿¡é˜Ÿåˆ—æˆåŠŸ</span>
                    <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// è¿”å›æœ¬æ‰¹æ¶ˆæ¯çš„é˜Ÿåˆ—æ¶ˆè´¹åç§»</span>
                        commitOffset <span class="token operator">=</span> consumeRequest<span class="token punctuation">.</span><span class="token function">getProcessQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">default</span><span class="token operator">:</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// é˜Ÿåˆ—çš„æ¶ˆè´¹åç§» >= 0 &amp;&amp; ProcessQueueæœªè¢«æ ‡å¿—ä¸ºåºŸå¼ƒ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>commitOffset <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>consumeRequest<span class="token punctuation">.</span><span class="token function">getProcessQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isDropped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ›´æ–°æœ¬åœ°ç¼“å­˜ä¸­çš„è¯¥MessageQueueçš„æ¶ˆè´¹è¿›åº¦</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumerImpl<span class="token punctuation">.</span><span class="token function">getOffsetStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">updateOffset</span><span class="token punctuation">(</span>consumeRequest<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> commitOffset<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> continueConsume<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ProcessQueue#commit</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è·å–å†™é”</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>lockTreeMap<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ä»æœ¬æ‰¹æ¶ˆè´¹çš„æ¶ˆæ¯ä¸­è·å–æœ€å¤§æ¶ˆæ¯é˜Ÿåˆ—åç§»</span>
                Long offset <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>consumingMsgOrderlyTreeMap<span class="token punctuation">.</span><span class="token function">lastKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                msgCount<span class="token punctuation">.</span><span class="token function">addAndGet</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>consumingMsgOrderlyTreeMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>MessageExt msg <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>consumingMsgOrderlyTreeMap<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    msgSize<span class="token punctuation">.</span><span class="token function">addAndGet</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">-</span> msg<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// æ¶ˆè´¹å®Œå°±æ¸…é™¤</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>consumingMsgOrderlyTreeMap<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>offset <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// è¿”å›æ¶ˆè´¹è¿›åº¦</span>
                    <span class="token keyword">return</span> offset <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>lockTreeMap<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>å¹¶å‘æ¶ˆè´¹</p>
<p>ConsumeMessageConcurrentlyService#submitConsumeRequest</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">submitConsumeRequest</span><span class="token punctuation">(</span><span class="token keyword">final</span> List<span class="token operator">&lt;</span>MessageExt<span class="token operator">></span> msgs<span class="token punctuation">,</span> <span class="token keyword">final</span> ProcessQueue processQueue<span class="token punctuation">,</span> <span class="token keyword">final</span> MessageQueue messageQueue<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> dispatchToConsume<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> consumeBatchSize <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getConsumeMessageBatchMaxSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æäº¤æ¶ˆè´¹çš„æ•°é‡å°äºç­‰äºæ‰¹é‡æ¶ˆè´¹çš„æ•°é‡</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>msgs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> consumeBatchSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ConsumeRequest consumeRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConsumeRequest</span><span class="token punctuation">(</span>msgs<span class="token punctuation">,</span> processQueue<span class="token punctuation">,</span> messageQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æäº¤ç»™çº¿ç¨‹æ± ï¼Œæ‰€ä»¥æ˜¯å¤šçº¿ç¨‹å¹¶å‘æ¶ˆè´¹</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>consumeExecutor<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>consumeRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RejectedExecutionException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// è¢«æ‹’ç»å°±ç¨åå†æäº¤</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">submitConsumeRequestLater</span><span class="token punctuation">(</span>consumeRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å¤§äº</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ä¸¤å±‚å¾ªç¯æ‹†åˆ†æ¶ˆæ¯</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> total <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> total <span class="token operator">&lt;</span> msgs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                List<span class="token operator">&lt;</span>MessageExt<span class="token operator">></span> msgThis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>MessageExt<span class="token operator">></span><span class="token punctuation">(</span>consumeBatchSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> consumeBatchSize<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">,</span> total<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>total <span class="token operator">&lt;</span> msgs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        msgThis<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>msgs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>total<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                ConsumeRequest consumeRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConsumeRequest</span><span class="token punctuation">(</span>msgThis<span class="token punctuation">,</span> processQueue<span class="token punctuation">,</span> messageQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// æ‹†åˆ†ååˆ†æ‰¹æäº¤</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>consumeExecutor<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>consumeRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RejectedExecutionException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> total <span class="token operator">&lt;</span> msgs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> total<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        msgThis<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>msgs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>total<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">submitConsumeRequestLater</span><span class="token punctuation">(</span>consumeRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>ConsumeMessageConcurrentlyService$ConsumeRequest#run</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>processQueue<span class="token punctuation">.</span><span class="token function">isDropped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// æ‰§è¡Œå‰ç½®Hook</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ConsumeMessageConcurrentlyService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumerImpl<span class="token punctuation">.</span><span class="token function">hasHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
                <span class="token comment" spellcheck="true">// æ¶ˆè´¹æ¶ˆæ¯ï¼Œè¿”å›æ¶ˆè´¹çŠ¶æ€</span>
                status <span class="token operator">=</span> listener<span class="token punctuation">.</span><span class="token function">consumeMessage</span><span class="token punctuation">(</span>Collections<span class="token punctuation">.</span><span class="token function">unmodifiableList</span><span class="token punctuation">(</span>msgs<span class="token punctuation">)</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ä¸€äº›çŠ¶æ€åˆ¤æ–­ï¼Œç•¥</span>
            <span class="token comment" spellcheck="true">// æ‰§è¡Œåç½®é’©å­</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ConsumeMessageConcurrentlyService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumerImpl<span class="token punctuation">.</span><span class="token function">hasHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>processQueue<span class="token punctuation">.</span><span class="token function">isDropped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å¤„ç†æ¶ˆè´¹ç»“æœ</span>
                ConsumeMessageConcurrentlyService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">processConsumeResult</span><span class="token punctuation">(</span>status<span class="token punctuation">,</span> context<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span></code></pre>
<p>ConsumeMessageConcurrentlyService#processConsumeResult</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processConsumeResult</span><span class="token punctuation">(</span><span class="token keyword">final</span> ConsumeConcurrentlyStatus status<span class="token punctuation">,</span> <span class="token keyword">final</span> ConsumeConcurrentlyContext context<span class="token punctuation">,</span> <span class="token keyword">final</span> ConsumeRequest consumeRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// åˆå§‹å€¼ä¸ºInteger.MAX_VALUE</span>
        <span class="token keyword">int</span> ackIndex <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getAckIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>consumeRequest<span class="token punctuation">.</span><span class="token function">getMsgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ¶ˆè´¹çŠ¶æ€</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æˆåŠŸ</span>
            <span class="token keyword">case</span> CONSUME_SUCCESS<span class="token operator">:</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ackIndex <span class="token operator">>=</span> consumeRequest<span class="token punctuation">.</span><span class="token function">getMsgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// æœ¬æ‰¹æ¶ˆæ¯ä¸­æœ€åä¸€ä¸ªæ¶ˆæ¯çš„ç´¢å¼•</span>
                    ackIndex <span class="token operator">=</span> consumeRequest<span class="token punctuation">.</span><span class="token function">getMsgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// æœ¬æ‰¹æ¶ˆæ¯æˆåŠŸæ¶ˆè´¹çš„æ•°é‡</span>
                <span class="token keyword">int</span> ok <span class="token operator">=</span> ackIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> failed <span class="token operator">=</span> consumeRequest<span class="token punctuation">.</span><span class="token function">getMsgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> ok<span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getConsumerStatsManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">incConsumeOKTPS</span><span class="token punctuation">(</span>consumerGroup<span class="token punctuation">,</span> consumeRequest<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ok<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getConsumerStatsManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">incConsumeFailedTPS</span><span class="token punctuation">(</span>consumerGroup<span class="token punctuation">,</span> consumeRequest<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> failed<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ç¨åå†æ¶ˆè´¹</span>
            <span class="token keyword">case</span> RECONSUME_LATER<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// è¿™æ‰¹æ¶ˆæ¯éƒ½è¦å‘å›Broker</span>
                ackIndex <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getConsumerStatsManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">incConsumeFailedTPS</span><span class="token punctuation">(</span>consumerGroup<span class="token punctuation">,</span> consumeRequest<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> consumeRequest<span class="token punctuation">.</span><span class="token function">getMsgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// æ¶ˆè´¹æ¨¡å¼</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getMessageModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å¹¿æ’­æ¨¡å¼</span>
            <span class="token keyword">case</span> BROADCASTING<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// ä»æœ€åä¸€ä¸ªæ¶ˆè´¹æˆåŠŸçš„æ¶ˆæ¯åçš„æ¶ˆæ¯å¼€å§‹</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> ackIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> consumeRequest<span class="token punctuation">.</span><span class="token function">getMsgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    MessageExt msg <span class="token operator">=</span> consumeRequest<span class="token punctuation">.</span><span class="token function">getMsgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// æ¶ˆè´¹å¤±è´¥ï¼Œå¿½ç•¥å¹¶ä¸¢å¼ƒ</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// é›†ç¾¤æ¨¡å¼</span>
            <span class="token keyword">case</span> CLUSTERING<span class="token operator">:</span>
                List<span class="token operator">&lt;</span>MessageExt<span class="token operator">></span> msgBackFailed <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>MessageExt<span class="token operator">></span><span class="token punctuation">(</span>consumeRequest<span class="token punctuation">.</span><span class="token function">getMsgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// éå†æ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> ackIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> consumeRequest<span class="token punctuation">.</span><span class="token function">getMsgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    MessageExt msg <span class="token operator">=</span> consumeRequest<span class="token punctuation">.</span><span class="token function">getMsgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// ç›´æ¥å°†æ¶ˆæ¯å‘å›Brokerï¼ŒæœŸå¾…é‡æ–°å‘é€ï¼Œè¿™é‡Œä¹Ÿä¼šå¯¼è‡´ä¹±åº</span>
                    <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sendMessageBack</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// å‘å›å¤±è´¥</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        msg<span class="token punctuation">.</span><span class="token function">setReconsumeTimes</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getReconsumeTimes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        msgBackFailed<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>msgBackFailed<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ç§»é™¤æ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯</span>
                    consumeRequest<span class="token punctuation">.</span><span class="token function">getMsgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeAll</span><span class="token punctuation">(</span>msgBackFailed<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// å‘å›Brokerå¤±è´¥ï¼Œåˆ™å†æ¬¡æäº¤æ¶ˆè´¹è¯·æ±‚ï¼Œæ‰€ä»¥è·³è¿‡äº†æ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯ï¼Œä¸æ˜¯æœ‰åºçš„</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">submitConsumeRequestLater</span><span class="token punctuation">(</span>msgBackFailed<span class="token punctuation">,</span> consumeRequest<span class="token punctuation">.</span><span class="token function">getProcessQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> consumeRequest<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// æ¶ˆè´¹å®Œæ¯•ï¼Œå°†æ¶ˆè´¹æˆåŠŸçš„æ¶ˆæ¯ä»ProcessQueueç§»é™¤ï¼Œè¿”å›ä¸‹æ¡å¾…æ¶ˆè´¹çš„æ¶ˆæ¯çš„åç§»</span>
        <span class="token keyword">long</span> offset <span class="token operator">=</span> consumeRequest<span class="token punctuation">.</span><span class="token function">getProcessQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeMessage</span><span class="token punctuation">(</span>consumeRequest<span class="token punctuation">.</span><span class="token function">getMsgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>offset <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>consumeRequest<span class="token punctuation">.</span><span class="token function">getProcessQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isDropped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ›´æ–°æ¶ˆè´¹åç§»</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumerImpl<span class="token punctuation">.</span><span class="token function">getOffsetStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">updateOffset</span><span class="token punctuation">(</span>consumeRequest<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> offset<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>ProcessQueue#removeMessage</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">removeMessage</span><span class="token punctuation">(</span><span class="token keyword">final</span> List<span class="token operator">&lt;</span>MessageExt<span class="token operator">></span> msgs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> result <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> now <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è·å–å†™é”</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>lockTreeMap<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>lastConsumeTimestamp <span class="token operator">=</span> now<span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>msgTreeMap<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// æ¶ˆæ¯çš„æœ€å¤§åç§» + 1</span>
                    result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>queueOffsetMax <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                    <span class="token keyword">int</span> removedCnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// éå†æ¶ˆæ¯</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span>MessageExt msg <span class="token operator">:</span> msgs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// åˆ é™¤æ¶ˆè´¹æˆåŠŸçš„æ¶ˆæ¯</span>
                        MessageExt prev <span class="token operator">=</span> msgTreeMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getQueueOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>prev <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            removedCnt<span class="token operator">--</span><span class="token punctuation">;</span>
                            msgSize<span class="token punctuation">.</span><span class="token function">addAndGet</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">-</span> msg<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    msgCount<span class="token punctuation">.</span><span class="token function">addAndGet</span><span class="token punctuation">(</span>removedCnt<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// åˆ é™¤åè¿˜æœ‰æ¶ˆæ¯ï¼Œè¯´æ˜å‰©ä¸‹æ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>msgTreeMap<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// TreeMapï¼ŒæŒ‰åç§»å‡åºï¼Œç¬¬ä¸€ä¸ªæ˜¯æœ€å°çš„åç§»ï¼Œè¿™é‡Œå°±æ˜¯æ¶ˆè´¹å¤±è´¥çš„ç¬¬ä¸€æ¡æ¶ˆæ¯çš„é˜Ÿåˆ—åç§»</span>
                        <span class="token comment" spellcheck="true">// å‡è®¾å¤šçº¿ç¨‹å¹¶å‘æ¶ˆè´¹é˜Ÿåˆ—é‡Œçš„æ¶ˆæ¯1ï¼Œ2ï¼Œ3ï¼Œ4ï¼Œ5ï¼Œå¯èƒ½æ¶ˆè´¹çš„é¡ºåºæ˜¯1ï¼Œ4ï¼Œ2ï¼Œ5ï¼Œ3</span>
                        <span class="token comment" spellcheck="true">// è¿”å›æœ€å°åç§»å¯ä»¥é¿å…æ¶ˆè´¹æœªè¢«æ¶ˆè´¹ï¼Œä½†æ˜¯å¯èƒ½ä¼šå¯¼è‡´é‡å¤æ¶ˆè´¹</span>
                        result <span class="token operator">=</span> msgTreeMap<span class="token punctuation">.</span><span class="token function">firstKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>lockTreeMap<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>å…³äºé¡ºåºæ¶ˆæ¯</p>
<p>Producer</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> UnsupportedEncodingException <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            MQProducer producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQProducer</span><span class="token punctuation">(</span><span class="token string">"please_rename_unique_group_name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            producer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            String<span class="token punctuation">[</span><span class="token punctuation">]</span> tags <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">"TagA"</span><span class="token punctuation">,</span> <span class="token string">"TagB"</span><span class="token punctuation">,</span> <span class="token string">"TagC"</span><span class="token punctuation">,</span> <span class="token string">"TagD"</span><span class="token punctuation">,</span> <span class="token string">"TagE"</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> orderId <span class="token operator">=</span> i <span class="token operator">%</span> <span class="token number">10</span><span class="token punctuation">;</span>
                Message msg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token string">"TopicTestjjj"</span><span class="token punctuation">,</span> tags<span class="token punctuation">[</span>i <span class="token operator">%</span> tags<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"KEY"</span> <span class="token operator">+</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"Hello RocketMQ "</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span>RemotingHelper<span class="token punctuation">.</span>DEFAULT_CHARSET<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                SendResult sendResult <span class="token operator">=</span> producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>
                        msg<span class="token punctuation">,</span>
                        <span class="token keyword">new</span> <span class="token class-name">MessageQueueSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token annotation punctuation">@Override</span>
                            <span class="token keyword">public</span> MessageQueue <span class="token function">select</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>MessageQueue<span class="token operator">></span> mqs<span class="token punctuation">,</span> Message msg<span class="token punctuation">,</span> Object arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                Integer id <span class="token operator">=</span> <span class="token punctuation">(</span>Integer<span class="token punctuation">)</span> arg<span class="token punctuation">;</span>
                                <span class="token keyword">int</span> index <span class="token operator">=</span> id <span class="token operator">%</span> mqs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">return</span> mqs<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span><span class="token punctuation">,</span>
                        <span class="token comment" spellcheck="true">// Producerå•çº¿ç¨‹åŒæ­¥é¡ºåºå‘é€æ¶ˆæ¯ï¼Œä¸”å‘é€åˆ°åŒä¸€ä¸ªé˜Ÿåˆ—ï¼Œä¹Ÿæ˜¯åŒä¸€ä¸ªBrokerï¼Œå› ä¸ºé¡ºåºå­˜å‚¨ï¼Œæ‰€ä»¥æ˜¯æœ‰åºçš„</span>
                        <span class="token comment" spellcheck="true">// ä»¥OrderIdæŒ‡å®šé˜Ÿåˆ—å‘é€ï¼Œæ‰€ä»¥ç›¸åŒçš„OrderIdå‘åˆ°åŒä¸€ä¸ªé˜Ÿåˆ—</span>
                        orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>

                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s%n"</span><span class="token punctuation">,</span> sendResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            producer<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">MQClientException</span> <span class="token operator">|</span> RemotingException <span class="token operator">|</span> MQBrokerException <span class="token operator">|</span> InterruptedException e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>Brokerï¼šä¸éœ€è¦åšä»»ä½•å¤„ç†ã€‚</p>
<p>Consumer</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> MQClientException <span class="token punctuation">{</span>
        DefaultMQPushConsumer consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMQPushConsumer</span><span class="token punctuation">(</span><span class="token string">"please_rename_unique_group_name_3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">setConsumeFromWhere</span><span class="token punctuation">(</span>ConsumeFromWhere<span class="token punctuation">.</span>CONSUME_FROM_FIRST_OFFSET<span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">"TopicTest"</span><span class="token punctuation">,</span> <span class="token string">"TagA || TagC || TagD"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">registerMessageListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">MessageListenerOrderly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            AtomicLong consumeTimes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicLong</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> ConsumeOrderlyStatus <span class="token function">consumeMessage</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>MessageExt<span class="token operator">></span> msgs<span class="token punctuation">,</span> ConsumeOrderlyContext context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                context<span class="token punctuation">.</span><span class="token function">setAutoCommit</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>consumeTimes<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>consumeTimes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> ConsumeOrderlyStatus<span class="token punctuation">.</span>SUCCESS<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>consumeTimes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> ConsumeOrderlyStatus<span class="token punctuation">.</span>ROLLBACK<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>consumeTimes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> ConsumeOrderlyStatus<span class="token punctuation">.</span>COMMIT<span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>consumeTimes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    context<span class="token punctuation">.</span><span class="token function">setSuspendCurrentQueueTimeMillis</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> ConsumeOrderlyStatus<span class="token punctuation">.</span>SUSPEND_CURRENT_QUEUE_A_MOMENT<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> ConsumeOrderlyStatus<span class="token punctuation">.</span>SUCCESS<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>é¡ºåºæ¶ˆè´¹ä¸‹ï¼Œä¸€ä¸ªQueueåŒæ—¶åªå…è®¸ä¸€ä¸ªConsumeræ¶ˆè´¹ï¼ŒConsumeråªæœ‰å…ˆå‘Brokerè·å–åˆ°Queueçš„é”æ‰èƒ½æ¶ˆè´¹æ¶ˆæ¯ï¼ŒåŒæ—¶æ¶ˆæ¯æ¶ˆè´¹å¤±è´¥æ—¶ä¼šé‡è¯•ï¼Œç›´åˆ°è¶…è¿‡æœ€å¤§æ¬¡æ•°ï¼Œåˆ™å°†æ¶ˆæ¯å‘å›Brokerçš„æ­»ä¿¡é˜Ÿåˆ—ï¼Œä¸ä¼šå†æ¬¡æ¶ˆè´¹ã€‚</p>
<p>å¹¶å‘æ¶ˆè´¹ä¸‹ï¼ŒConsumeræ‹‰å–åˆ°æ¶ˆæ¯åå›è¢«æ”¾å…¥ProcessQueueï¼Œæœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶å¤„ç†é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ï¼ŒåŒæ—¶æ¶ˆæ¯æ¶ˆè´¹å¤±è´¥æ—¶ä¼šè·³è¿‡è¯¥æ¶ˆæ¯ï¼Œå¹¶å°†æ¶ˆæ¯å‘å›Brokerï¼Œä¸‹æ¬¡ç»§ç»­æ¶ˆè´¹ã€‚</p>
<p>å¦å¤–ï¼Œé¡ºåºæ¶ˆè´¹éœ€è¦æ³¨æ„æ¶ˆæ¯å †ç§¯çš„é—®é¢˜ã€‚</p>
<p>é¡ºåºæ¶ˆæ¯ä¹Ÿä¸æ˜¯ç»å¯¹çš„ï¼Œä¸¤æ¡é¡ºåºæ¶ˆæ¯MsgAå’ŒMsgBï¼ŒMsgAå‘åˆ°BrokerAçš„QueueAï¼Œä¹‹åBrokerAå…³é—­ï¼ŒMsgBå‘åˆ°BrokerBçš„QueueBï¼Œè¿™æ ·å°±ä¸èƒ½ä¿è¯é¡ºåºæ¶ˆè´¹äº†ã€‚</p>
<hr>
<p>è¡¥å……ä¸€ä¸‹Pullï¼ŒPushä¹‹ç±»çš„æ¨¡å¼çš„åŒºåˆ«ï¼š</p>
<p>Push</p>
<ul>
<li><p>ä¼˜ç‚¹ï¼šå®æ—¶ï¼›</p>
</li>
<li><p>ç¼ºç‚¹ï¼šPushçš„é€Ÿç‡å¯èƒ½ä¼šè¶…è¿‡Consumerçš„æ¶ˆè´¹é€Ÿç‡ï¼›Brokeréœ€è¦ç»´æŠ¤Consumerçš„çŠ¶æ€ï¼Œç‰¹åˆ«æ˜¯Consumeræ•°é‡æ¯”è¾ƒå¤šçš„æƒ…å†µï¼›</p>
</li>
</ul>
<p>Pull</p>
<ul>
<li><p>ä¼˜ç‚¹ï¼šConsumerå¯è‡ªç”±è°ƒèŠ‚æ¶ˆè´¹é€Ÿåº¦ï¼›çŠ¶æ€ç”±Consumerç»´æŠ¤ï¼Œæ¯æ¬¡Pullè¯·æ±‚éƒ½ä¼šæºå¸¦åç§»ï¼›æ–¹ä¾¿æ‰¹é‡æ¶ˆè´¹æ¶ˆæ¯ï¼›</p>
</li>
<li><p>ç¼ºç‚¹ï¼šå¯èƒ½ä¸åŠæ—¶ï¼Œä¸æ–­è½®è¯¢æ¶ˆè€—æ¯”è¾ƒå¤§ï¼›</p>
</li>
</ul>
<p>Long Polling</p>
<ul>
<li><p>ä¼˜ç‚¹ï¼šåŸºæœ¬ä¸Šç»“åˆäº†Pushå’ŒPullçš„ä¼˜ç‚¹</p>
</li>
<li><p>ç¼ºç‚¹ï¼šå‡å¦‚Brokerä¸€ç›´æœ‰æ¶ˆæ¯ï¼Œå®é™…ä¸Šé•¿è½®è¯¢å°±ç­‰äºæ— é—´éš”çš„Pullï¼Œä¸€ç›´é‡å¤è¯·æ±‚-å“åº”ï¼Œç½‘ç»œäº¤äº’å¼€é”€è¾ƒå¤§</p>
</li>
</ul>
<p>é•¿è½®è¯¢çš„è¶…æ—¶ï¼šConsumerå’ŒBrokerä¹‹é—´ç½‘ç»œäº¤äº’éœ€è¦æ—¶é—´ï¼Œæœ¬åœ°æ—¶é’Ÿé€Ÿç‡ä¹Ÿä¸åŒï¼ˆè™½ç„¶å¯ä»¥å¿½ç•¥ï¼‰ï¼Œå‡å¦‚ä¸€ä¸ªPullè¯·æ±‚çš„è¶…æ—¶æ—¶é—´æ˜¯5ç§’ï¼Œåœ¨Brokerç«¯é˜»å¡äº†5ç§’æ‰è¿”å›ï¼Œé‚£ä¹ˆConsumeråœ¨æ”¶åˆ°Brokerå“åº”å‰å°±ä¼šåˆ¤å®šè¶…æ—¶ã€‚</p>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


        <footer>
             
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

        </footer>
    </div>
    <!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
    <script>
        var timeEnd = new Date();
        console.log('è€—æ—¶ï¼š' + (timeEnd - timeStart));
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre').forEach((block) => {
                block.classList.add("line-numbers");
            });
        });
    </script>
    <!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
    <!-- material design -->
    <!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
    <!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
    <!-- toc -->
    <!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
    <!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
    <!-- <script src="/js/main.js"></script> -->
    <script src="/js/prism.js"></script>
</body>
</html>
