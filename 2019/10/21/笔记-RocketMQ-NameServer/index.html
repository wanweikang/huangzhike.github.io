<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
        <script>
            var timeStart = new Date();
        </script>
        
        <title>[ç¬”è®°]-RocketMQ-NameServer | å­¦è€Œæ—¶ä¹ ä¹‹</title>
        
        <meta name="author" content="Huangzhike">
        
        
        <meta name="description" content="K.I.S.S">
        
        
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        
        <meta property="og:title" content="[ç¬”è®°]-RocketMQ-NameServer"/>
        
        <meta property="og:site_name" content="å­¦è€Œæ—¶ä¹ ä¹‹"/>
        
        
        <!-- favicon -->
        <link rel="icon" type="image/ico" href="/ok.ico" sizes="32x32">
        <meta name="msapplication-TileColor" content="#009688">
        <meta name="msapplication-TileImage" content="/mstile-144x144.ico">
        <meta name="theme-color" content="#009688">
        <!-- favicon end -->
        <!-- <link href="//ok.ico" rel="icon"> -->
        
        <!-- toc -->
        <!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
        <!-- material design -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
        <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
        
        <!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
        <!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
    <meta name="generator" content="Hexo 4.2.1"></head>

<body>
    <nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">èœå•</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" href="/">å­¦è€Œæ—¶ä¹ ä¹‹</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" target="_blank" rel="noopener" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

    <div class="container" >
        <div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[ç¬”è®°]-RocketMQ-NameServer</h2>
				
				<div>
					<div class="post-time">2019-10-21</div>
				</div>
				
				<div class="article-content">
				<p>å›½åº†å›å®¶èººäº†ä¸ƒå¤©å°¸ï¼Œå›æ¥ä¸Šç­åäº‹æƒ…çªç„¶å¤šäº†èµ·æ¥ï¼Œæ‰€ä»¥è€½è¯¯äº†ç‚¹è¿›åº¦ï¼Œæƒ³æƒ³åŒåä¸€é…äº†å°å¼æœºåå¯èƒ½æ§åˆ¶ä¸ä½æ‰‹æ‰“æ¸¸æˆï¼Œç®—äº†ï¼Œè¯¥ç©ç©è¯¥å­¦å­¦ã€‚</p>
<p>æœ€è¿‘æ¯”è¾ƒå¤´ç–¼çš„æ˜¯æ€ä¹ˆå’Œè€æ¿æè·‘è·¯çš„äº‹æƒ…ï¼Œæˆ‘çš„æƒ³æ³•æ˜¯ï¼Œå¹´åº•è‡³å°‘ç©ºå‡ºä¸€ä¸ªæœˆæ—¶é—´ä¸“å¿ƒå¤ä¹ ï¼Œå‡†å¤‡é¢è¯•çš„äº‹æƒ…ï¼Œè™½ç„¶å…¶å®æˆ‘ä¸€ç›´ä¸Šç­å¾ˆé—²ğŸ˜¬ï¼Œä½†æ˜¯è¿˜æ˜¯æƒ³æå‰å¤„ç†å¥½äº¤æ¥ã€‚</p>
<hr>
<p>æ¨èå…ˆçœ‹å®˜æ–¹çš„<a href="https://github.com/apache/rocketmq/tree/master/docs/cn" target="_blank" rel="noopener">å¼€å‘è€…æŒ‡å—</a>å“ˆï¼ŒèŒæ–°ä¹‹å‰å¯¹MQä¹Ÿæ˜¯ä¸€çŸ¥åŠè§£çš„ï¼Œçœ‹æºç çš„æ—¶å€™ä¸éœ€è¦å®³æ€•ï¼Œç¬¬ä¸€æ¬¡çœ‹ä¸æ‡‚ï¼Œå¤šçœ‹å‡ æ¬¡è‡ªç„¶å°±æ‡‚äº†ã€‚</p>
<p>èŒæ–°çœ‹æºç çš„æ–¹æ³•å°±æ˜¯ï¼Œå…ˆä¸»å¹²å†ç»†èŠ‚ï¼Œæœ‰ä¸æ‡‚çš„åœ°æ–¹å¯ä»¥æš‚æ—¶è·³è¿‡ï¼Œä»å¤´åˆ°å°¾åå¤è¿‡å‡ éå®Œæ•´çš„æµç¨‹ï¼Œè¿™æ ·ä¸‹æ¥åŸºæœ¬å°±æ˜¯çœ‹å¾—ä¸ƒä¸ƒå…«å…«äº†ã€‚</p>
<p>ç›¸å…³ä¹¦ç±å¯ä»¥çœ‹çœ‹<a href="https://read.douban.com/ebook/60819364/" target="_blank" rel="noopener">RocketMQæŠ€æœ¯å†…å¹•ï¼šRocketMQæ¶æ„è®¾è®¡ä¸å®ç°åŸç†</a>è¿™æœ¬ä¹¦ï¼Œå¸®èŒæ–°è§£ç­”äº†ä¸å°‘ç–‘æƒ‘ã€‚</p>
<p>RocketMQç‰ˆæœ¬ï¼š4.5.2</p>
<p>æ¥ä¸‹æ¥å‡†å¤‡çœ‹Raftåè®®å®ç°ã€‚</p>
<hr>
<p>å°åæ§½ï¼š</p>
<p>RocketMQçœ‹äº†ä¸€ä¸ªæœˆï¼Œå‘ç°ä¸€äº›è¯­æ³•å’Œæ‹¼å†™çš„é”™è¯¯ï¼Œå¼ºè¿«ç—‡è¡¨ç¤ºæœ‰ç‚¹éš¾å—ï¼Œåˆä¸å¥½å› ä¸ºè¿™ç§äº‹å»æä¸€ä¸ªIssueï¼Œæ¯”å¦‚è¯´ï¼š</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">enum</span> LocalTransactionState <span class="token punctuation">{</span>
    COMMIT_MESSAGE<span class="token punctuation">,</span> ROLLBACK_MESSAGE<span class="token punctuation">,</span> UNKNOW<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// è¿™é‡Œåº”è¯¥æ˜¯UNKNOWNï¼Ÿ</span>
<span class="token punctuation">}</span></code></pre>
<p>è¿˜æœ‰ä¸€äº›æ‹¼å†™é”™è¯¯ï¼š</p>
<p><code>ProcessQueue#makeMessageToCosumeAgain</code>åº”è¯¥æ˜¯<code>ProcessQueue#makeMessageToConsumeAgain</code>ã€‚</p>
<p><code>ProcessQueue#takeMessags</code>åº”è¯¥æ˜¯<code>ProcessQueue#takeMessages</code>ã€‚</p>
<p>è¿˜æœ‰ä¸€äº›è‹±æ–‡æ³¨é‡Šï¼Œæˆ‘è§‰å¾—æ˜¯æœ‰é—®é¢˜çš„ï¼Œä¸åˆ—ä¸¾äº†ã€‚</p>
<hr>
<p>NamesrvController#initialize</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// åŠ è½½${user.home}/namesrv/kvConfig.json</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>kvConfigManager<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è¿œç¨‹é€šä¿¡æœåŠ¡å™¨ï¼ŒBrokerHousekeepingServiceç”¨äºå¤„ç†ç½‘ç»œçŠ¶å†µå˜åŠ¨æ—¶Brokerçš„å­˜æ´»æƒ…å†µ</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>remotingServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NettyRemotingServer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>nettyServerConfig<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerHousekeepingService<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ä¸šåŠ¡çº¿ç¨‹æ± </span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>remotingExecutor <span class="token operator">=</span> Executors<span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span>nettyServerConfig<span class="token punctuation">.</span><span class="token function">getServerWorkerThreads</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryImpl</span><span class="token punctuation">(</span><span class="token string">"RemotingExecutorThread_"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ³¨å†Œè¯·æ±‚å¤„ç†å™¨</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è®¡åˆ’ä»»åŠ¡ï¼Œæ‰«æBrokerå­˜æ´»çŠ¶å†µåˆ—è¡¨ï¼Œå¦‚æœä¸€å®šæ—¶é—´å†…æ²¡æœ‰æ•°æ®äº¤äº’ï¼Œåˆ é™¤Brokerç›¸å…³çš„ä¿¡æ¯</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>scheduledExecutorService<span class="token punctuation">.</span><span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                NamesrvController<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>routeInfoManager<span class="token punctuation">.</span><span class="token function">scanNotActiveBroker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è®¡åˆ’ä»»åŠ¡ï¼Œæ¯10åˆ†é’Ÿæ‰“å°é”®å€¼é…ç½®</span>
        <span class="token comment" spellcheck="true">// ...</span>

        <span class="token comment" spellcheck="true">// åˆå§‹åŒ–TLSè¯ä¹¦æ–‡ä»¶ç›‘å¬æœåŠ¡</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>TlsSystemConfig<span class="token punctuation">.</span>tlsMode <span class="token operator">!=</span> TlsMode<span class="token punctuation">.</span>DISABLED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>NamesrvController#registerProcessor</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">registerProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>namesrvConfig<span class="token punctuation">.</span><span class="token function">isClusterTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>remotingServer<span class="token punctuation">.</span><span class="token function">registerDefaultProcessor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ClusterTestRequestProcessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> namesrvConfig<span class="token punctuation">.</span><span class="token function">getProductEnvName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>remotingExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ³¨å†Œè¯·æ±‚çš„å¤„ç†å™¨å’Œå¯¹åº”çš„å¤„ç†çº¿ç¨‹æ± </span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>remotingServer<span class="token punctuation">.</span><span class="token function">registerDefaultProcessor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DefaultRequestProcessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>remotingExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>NamesrvController#start</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// å¯åŠ¨è¿œç¨‹æœåŠ¡å™¨ï¼Œç›‘å¬è¯·æ±‚</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>remotingServer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fileWatchService <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å¯åŠ¨ç›‘å¬TLSæ–‡ä»¶çš„æœåŠ¡</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>fileWatchService<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>DefaultRequestProcessor#processRequest</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> RemotingCommand <span class="token function">processRequest</span><span class="token punctuation">(</span>ChannelHandlerContext ctx<span class="token punctuation">,</span> RemotingCommand request<span class="token punctuation">)</span> <span class="token keyword">throws</span> RemotingCommandException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// æ³¨å†ŒBroker</span>
            <span class="token keyword">case</span> RequestCode<span class="token punctuation">.</span>REGISTER_BROKER<span class="token operator">:</span>
                Version brokerVersion <span class="token operator">=</span> MQVersion<span class="token punctuation">.</span><span class="token function">value2Version</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// é«˜ç‰ˆæœ¬</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>brokerVersion<span class="token punctuation">.</span><span class="token function">ordinal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> MQVersion<span class="token punctuation">.</span>Version<span class="token punctuation">.</span>V3_0_11<span class="token punctuation">.</span><span class="token function">ordinal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">registerBrokerWithFilterServer</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">registerBroker</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// æ ¹æ®Topicè·å–Brokerè·¯ç”±ä¿¡æ¯</span>
            <span class="token keyword">case</span> RequestCode<span class="token punctuation">.</span>GET_ROUTEINTO_BY_TOPIC<span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRouteInfoByTopic</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ä¸»è¦çœ‹ä¸¤ä¸ª</p>
<ul>
<li><p>RequestCode.REGISTER_BROKER</p>
</li>
<li><p>RequestCode.GET_ROUTEINTO_BY_TOPIC</p>
</li>
</ul>
<hr>
<p>DefaultRequestProcessor#registerBrokerWithFilterServer</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> RemotingCommand <span class="token function">registerBrokerWithFilterServer</span><span class="token punctuation">(</span>ChannelHandlerContext ctx<span class="token punctuation">,</span> RemotingCommand request<span class="token punctuation">)</span> <span class="token keyword">throws</span> RemotingCommandException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// æ›´æ–°Brokerä¿¡æ¯ï¼Œå¦‚æœæ³¨å†Œè¯·æ±‚åŒ…å«äº†TopicConfigï¼Œå¹¶ä¸”æ¥è‡ªMasterï¼Œåˆ™æ›´æ–°TopicConfig</span>
        <span class="token comment" spellcheck="true">// æ‰€ä»¥NameServeråªä¿å­˜Masterçš„Topicé…ç½®ï¼ŒSlaveæ˜¯ä»MasteråŒæ­¥è¿‡å»çš„</span>
        RegisterBrokerResult result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>namesrvController<span class="token punctuation">.</span><span class="token function">getRouteInfoManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">registerBroker</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getClusterName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getBrokerAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getBrokerName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getBrokerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getHaServerAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> registerBrokerBody<span class="token punctuation">.</span><span class="token function">getTopicConfigSerializeWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> registerBrokerBody<span class="token punctuation">.</span><span class="token function">getFilterServerList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        responseHeader<span class="token punctuation">.</span><span class="token function">setHaServerAddr</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getHaServerAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        responseHeader<span class="token punctuation">.</span><span class="token function">setMasterAddr</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getMasterAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> jsonValue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>namesrvController<span class="token punctuation">.</span><span class="token function">getKvConfigManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getKVListByNamespace</span><span class="token punctuation">(</span>NamesrvUtil<span class="token punctuation">.</span>NAMESPACE_ORDER_TOPIC_CONFIG<span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setBody</span><span class="token punctuation">(</span>jsonValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span>ResponseCode<span class="token punctuation">.</span>SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setRemark</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> response<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>RouteInfoManager#registerBroker</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> RegisterBrokerResult <span class="token function">registerBroker</span><span class="token punctuation">(</span><span class="token keyword">final</span> String clusterName<span class="token punctuation">,</span> <span class="token keyword">final</span> String brokerAddr<span class="token punctuation">,</span> <span class="token keyword">final</span> String brokerName<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> brokerId<span class="token punctuation">,</span> <span class="token keyword">final</span> String haServerAddr<span class="token punctuation">,</span> <span class="token keyword">final</span> TopicConfigSerializeWrapper topicConfigWrapper<span class="token punctuation">,</span> <span class="token keyword">final</span> List<span class="token operator">&lt;</span>String<span class="token operator">></span> filterServerList<span class="token punctuation">,</span> <span class="token keyword">final</span> Channel channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        RegisterBrokerResult result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegisterBrokerResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å†™é”ï¼Œç‹¬å ï¼Œä¸å…è®¸åˆ«çš„çº¿ç¨‹è¯»å†™</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// æ ¹æ®ClusterNameè·å–Brokeré›†ç¾¤ä¸‹æ‰€æœ‰BrokerNameåˆ—è¡¨</span>
                Set<span class="token operator">&lt;</span>String<span class="token operator">></span> brokerNames <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clusterAddrTable<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>clusterName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// è¯¥é›†ç¾¤ä¸‹ä¸å­˜åœ¨BrokerName</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">==</span> brokerNames<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    brokerNames <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token operator">&lt;</span>String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// åŠ å…¥</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>clusterAddrTable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>clusterName<span class="token punctuation">,</span> brokerNames<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// åŠ å…¥</span>
                brokerNames<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>brokerName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">boolean</span> registerFirst <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// è·å–è¯¥BrokerNameä¸‹çš„Brokeråˆ—è¡¨ï¼ŒMasterå’ŒSlave</span>
                BrokerData brokerData <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerAddrTable<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>brokerName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// è¯¥BrokerNameé¦–æ¬¡æ³¨å†Œ</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">==</span> brokerData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    registerFirst <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    brokerData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BrokerData</span><span class="token punctuation">(</span>clusterName<span class="token punctuation">,</span> brokerName<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span>Long<span class="token punctuation">,</span> String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// åŠ å…¥</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>brokerAddrTable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>brokerName<span class="token punctuation">,</span> brokerData<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// è¯¥BrokerNameä¸‹çš„Brokeråœ°å€åˆ—è¡¨ï¼ŒåŒ…æ‹¬ä¸»ä»</span>
                Map<span class="token operator">&lt;</span>Long<span class="token punctuation">,</span> String<span class="token operator">></span> brokerAddrsMap <span class="token operator">=</span> brokerData<span class="token punctuation">.</span><span class="token function">getBrokerAddrs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Iterator<span class="token operator">&lt;</span>Entry<span class="token operator">&lt;</span>Long<span class="token punctuation">,</span> String<span class="token operator">>></span> it <span class="token operator">=</span> brokerAddrsMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// éå†è¯¥BrokerNameä¸‹çš„Brokeråœ°å€åˆ—è¡¨</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    Entry<span class="token operator">&lt;</span>Long<span class="token punctuation">,</span> String<span class="token operator">></span> item <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// ä¸åŒçš„Brokerï¼ŒIPåœ°å€ä¸å…è®¸é‡å¤ï¼Œæ‰€ä»¥ä¸€ä¸ªä¸»æœºä¸Šä¸èƒ½åŒæ—¶éƒ¨ç½²ä¸»ä»ï¼Ÿ</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">!=</span> brokerAddr <span class="token operator">&amp;&amp;</span> brokerAddr<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> brokerId <span class="token operator">!=</span> item<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ç§»é™¤æ—§çš„</span>
                        it<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// è¯¥Brokeræ˜¯å¦å·²æ³¨å†Œ</span>
                String oldAddr <span class="token operator">=</span> brokerData<span class="token punctuation">.</span><span class="token function">getBrokerAddrs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>brokerId<span class="token punctuation">,</span> brokerAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                registerFirst <span class="token operator">=</span> registerFirst <span class="token operator">||</span> <span class="token punctuation">(</span>null <span class="token operator">==</span> oldAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// TopicConfigWrapperä¸ä¸ºç©º &amp;&amp; å½“å‰Brokeræ˜¯MasterèŠ‚ç‚¹</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">!=</span> topicConfigWrapper <span class="token operator">&amp;&amp;</span> MixAll<span class="token punctuation">.</span>MASTER_ID <span class="token operator">==</span> brokerId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// æ ¹æ®BrokerLiveInfoçš„DataVersionåˆ¤æ–­æ˜¯å¦æœ‰å˜åŒ–</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isBrokerTopicConfigChanged</span><span class="token punctuation">(</span>brokerAddr<span class="token punctuation">,</span> topicConfigWrapper<span class="token punctuation">.</span><span class="token function">getDataVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> registerFirst<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// Brokerå‘è¿‡æ¥çš„Topicä¿¡æ¯</span>
                        ConcurrentMap<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> TopicConfig<span class="token operator">></span> tcTable <span class="token operator">=</span> topicConfigWrapper<span class="token punctuation">.</span><span class="token function">getTopicConfigTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>tcTable <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// éå†Topicåˆ—è¡¨</span>
                            <span class="token keyword">for</span> <span class="token punctuation">(</span>Map<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> TopicConfig<span class="token operator">></span> entry <span class="token operator">:</span> tcTable<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token comment" spellcheck="true">// </span>
                                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createAndUpdateQueueData</span><span class="token punctuation">(</span>brokerName<span class="token punctuation">,</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// æ›´æ–°Brokerç”Ÿå­˜ä¿¡æ¯</span>
                BrokerLiveInfo prevBrokerLiveInfo <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerLiveTable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>brokerAddr<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">BrokerLiveInfo</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> topicConfigWrapper<span class="token punctuation">.</span><span class="token function">getDataVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> channel<span class="token punctuation">,</span> haServerAddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ...</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>filterServerList <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>filterServerList<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>filterServerTable<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>brokerAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>filterServerTable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>brokerAddr<span class="token punctuation">,</span> filterServerList<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// å¦‚æœå½“å‰Brokeræ˜¯Slave</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>MixAll<span class="token punctuation">.</span>MASTER_ID <span class="token operator">!=</span> brokerId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    String masterAddr <span class="token operator">=</span> brokerData<span class="token punctuation">.</span><span class="token function">getBrokerAddrs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>MixAll<span class="token punctuation">.</span>MASTER_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>masterAddr <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// è·å–Masterçš„ä¿¡æ¯</span>
                        BrokerLiveInfo brokerLiveInfo <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerLiveTable<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>masterAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>brokerLiveInfo <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// å‘Slaveè¿”å›Masteråœ°å€</span>
                            result<span class="token punctuation">.</span><span class="token function">setHaServerAddr</span><span class="token punctuation">(</span>brokerLiveInfo<span class="token punctuation">.</span><span class="token function">getHaServerAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            result<span class="token punctuation">.</span><span class="token function">setMasterAddr</span><span class="token punctuation">(</span>masterAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// é‡Šæ”¾å†™é”</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>RouteInfoManager#createAndUpdateQueueData</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">createAndUpdateQueueData</span><span class="token punctuation">(</span><span class="token keyword">final</span> String brokerName<span class="token punctuation">,</span> <span class="token keyword">final</span> TopicConfig topicConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// é˜Ÿåˆ—</span>
        QueueData queueData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueueData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        queueData<span class="token punctuation">.</span><span class="token function">setBrokerName</span><span class="token punctuation">(</span>brokerName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        queueData<span class="token punctuation">.</span><span class="token function">setWriteQueueNums</span><span class="token punctuation">(</span>topicConfig<span class="token punctuation">.</span><span class="token function">getWriteQueueNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        queueData<span class="token punctuation">.</span><span class="token function">setReadQueueNums</span><span class="token punctuation">(</span>topicConfig<span class="token punctuation">.</span><span class="token function">getReadQueueNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        queueData<span class="token punctuation">.</span><span class="token function">setPerm</span><span class="token punctuation">(</span>topicConfig<span class="token punctuation">.</span><span class="token function">getPerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        queueData<span class="token punctuation">.</span><span class="token function">setTopicSynFlag</span><span class="token punctuation">(</span>topicConfig<span class="token punctuation">.</span><span class="token function">getTopicSysFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è·å–è¯¥Topicä¸‹çš„é˜Ÿåˆ—åˆ—è¡¨</span>
        List<span class="token operator">&lt;</span>QueueData<span class="token operator">></span> queueDataList <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>topicQueueTable<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>topicConfig<span class="token punctuation">.</span><span class="token function">getTopicName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ²¡æœ‰å°±åŠ å…¥</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">==</span> queueDataList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            queueDataList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token operator">&lt;</span>QueueData<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            queueDataList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>queueData<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>topicQueueTable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>topicConfig<span class="token punctuation">.</span><span class="token function">getTopicName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> queueDataList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å·²æœ‰</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">boolean</span> addNewOne <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            Iterator<span class="token operator">&lt;</span>QueueData<span class="token operator">></span> it <span class="token operator">=</span> queueDataList<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                QueueData qd <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>qd<span class="token punctuation">.</span><span class="token function">getBrokerName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>brokerName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// æ²¡å˜åŒ–</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>qd<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>queueData<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        addNewOne <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ç§»é™¤æ—§çš„</span>
                        it<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>addNewOne<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// åŠ å…¥æ–°çš„</span>
                queueDataList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>queueData<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>DefaultRequestProcessor#getRouteInfoByTopic</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> RemotingCommand <span class="token function">getRouteInfoByTopic</span><span class="token punctuation">(</span>ChannelHandlerContext ctx<span class="token punctuation">,</span> RemotingCommand request<span class="token punctuation">)</span> <span class="token keyword">throws</span> RemotingCommandException <span class="token punctuation">{</span>
        <span class="token keyword">final</span> RemotingCommand response <span class="token operator">=</span> RemotingCommand<span class="token punctuation">.</span><span class="token function">createResponseCommand</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> GetRouteInfoRequestHeader requestHeader <span class="token operator">=</span> <span class="token punctuation">(</span>GetRouteInfoRequestHeader<span class="token punctuation">)</span> request<span class="token punctuation">.</span><span class="token function">decodeCommandCustomHeader</span><span class="token punctuation">(</span>GetRouteInfoRequestHeader<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ä»RouteInfoManagerè·å–Topicçš„è·¯ç”±ä¿¡æ¯</span>
        TopicRouteData topicRouteData <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>namesrvController<span class="token punctuation">.</span><span class="token function">getRouteInfoManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pickupTopicRouteData</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>topicRouteData <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å¦‚æœNameServerå¯ç”¨é¡ºåºæ¶ˆæ¯ï¼Œé»˜è®¤ä¸å¯ç”¨</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>namesrvController<span class="token punctuation">.</span><span class="token function">getNamesrvConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isOrderMessageEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                String orderTopicConf <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>namesrvController<span class="token punctuation">.</span><span class="token function">getKvConfigManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getKVConfig</span><span class="token punctuation">(</span>NamesrvUtil<span class="token punctuation">.</span>NAMESPACE_ORDER_TOPIC_CONFIG<span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                topicRouteData<span class="token punctuation">.</span><span class="token function">setOrderTopicConf</span><span class="token punctuation">(</span>orderTopicConf<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> content <span class="token operator">=</span> topicRouteData<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">setBody</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span>ResponseCode<span class="token punctuation">.</span>SUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">setRemark</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> response<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        response<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span>ResponseCode<span class="token punctuation">.</span>TOPIC_NOT_EXIST<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">return</span> response<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> TopicRouteData <span class="token function">pickupTopicRouteData</span><span class="token punctuation">(</span><span class="token keyword">final</span> String topic<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        TopicRouteData topicRouteData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TopicRouteData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// è·å–è¯»é”</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// è·å–Topicçš„Queueåˆ—è¡¨</span>
                List<span class="token operator">&lt;</span>QueueData<span class="token operator">></span> queueDataList <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>topicQueueTable<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>queueDataList <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// åŠ å…¥</span>
                    topicRouteData<span class="token punctuation">.</span><span class="token function">setQueueDatas</span><span class="token punctuation">(</span>queueDataList<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    foundQueueData <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    Iterator<span class="token operator">&lt;</span>QueueData<span class="token operator">></span> it <span class="token operator">=</span> queueDataList<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// éå†Topicçš„Queueåˆ—è¡¨</span>
                    <span class="token keyword">while</span> <span class="token punctuation">(</span>it<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        QueueData qd <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// Queueæ‰€å±çš„BrokerName</span>
                        brokerNameSet<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>qd<span class="token punctuation">.</span><span class="token function">getBrokerName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// éå†BrokerNameåˆ—è¡¨</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span>String brokerName <span class="token operator">:</span> brokerNameSet<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// æ ¹æ®BrokerNameè·å–Brokeråˆ—è¡¨ï¼ŒMasterå’ŒSlave</span>
                        BrokerData brokerData <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerAddrTable<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>brokerName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">!=</span> brokerData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// å¤åˆ¶ä¸€ä»½</span>
                            BrokerData brokerDataClone <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BrokerData</span><span class="token punctuation">(</span>brokerData<span class="token punctuation">.</span><span class="token function">getCluster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> brokerData<span class="token punctuation">.</span><span class="token function">getBrokerName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>HashMap<span class="token operator">&lt;</span>Long<span class="token punctuation">,</span> String<span class="token operator">></span><span class="token punctuation">)</span> brokerData<span class="token punctuation">.</span><span class="token function">getBrokerAddrs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// åŠ å…¥</span>
                            brokerDataList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>brokerDataClone<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            foundBrokerData <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// éå†è¯¥BrokerNameä¸‹çš„ä¸»ä»Brokeråœ°å€</span>
                            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> String brokerAddr <span class="token operator">:</span> brokerDataClone<span class="token punctuation">.</span><span class="token function">getBrokerAddrs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                List<span class="token operator">&lt;</span>String<span class="token operator">></span> filterServerList <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>filterServerTable<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>brokerAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                filterServerMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>brokerAddr<span class="token punctuation">,</span> filterServerList<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>foundBrokerData <span class="token operator">&amp;&amp;</span> foundQueueData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> topicRouteData<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


        <footer>
             
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

        </footer>
    </div>
    <!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
    <script>
        var timeEnd = new Date();
        console.log('è€—æ—¶ï¼š' + (timeEnd - timeStart));
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre').forEach((block) => {
                block.classList.add("line-numbers");
            });
        });
    </script>
    <!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
    <!-- material design -->
    <!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
    <!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
    <!-- toc -->
    <!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
    <!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
    <!-- <script src="/js/main.js"></script> -->
    <script src="/js/prism.js"></script>
</body>
</html>
