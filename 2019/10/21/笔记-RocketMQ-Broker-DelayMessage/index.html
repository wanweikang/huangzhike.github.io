<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
        <script>
            var timeStart = new Date();
        </script>
        
        <title>[ç¬”è®°]-RocketMQ-Broker-DelayMessage | ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜</title>
        
        <meta name="author" content="huangzhike">
        
        
        <meta name="description" content="CommitLog#putMessage
    public PutMessageResult putMessage(final MessageExtBrokerInner msg) {
        // ...
        final int tranType = MessageSysF">
        
        
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        
        <meta property="og:title" content="[ç¬”è®°]-RocketMQ-Broker-DelayMessage"/>
        
        <meta property="og:site_name" content="ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜"/>
        
        
        <!-- favicon -->
        <link rel="icon" type="image/ico" href="/ok.ico" sizes="32x32">
        <meta name="msapplication-TileColor" content="#009688">
        <meta name="msapplication-TileImage" content="/mstile-144x144.ico">
        <meta name="theme-color" content="#009688">
        <!-- favicon end -->
        <!-- <link href="//ok.ico" rel="icon"> -->
        
        <!-- toc -->
        <!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
        <!-- material design -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
        <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
        
        <!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
        <!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
    <meta name="generator" content="Hexo 4.2.1"></head>

<body>
    <nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">èœå•</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" title="ä¸‹ä¸€å¥æ˜¯ï¼šå®¢æœ‰å¯äººæœŸä¸æ¥ã€‚å°æ—¶å€™ï¼Œå–œæ¬¢é åœ¨é˜³å°ä¸Šï¼Œä¸€è¾¹å¹é£ï¼Œä¸€è¾¹çœ‹ä¹¦ï¼Œå–œæ¬¢è¯»ä¹¦å—ï¼Œéªšå¹´ï¼Ÿ" href="/">ä¹¦å½“å¿«æ„è¯»æ˜“å°½</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" target="_blank" rel="noopener" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

    <div class="container" >
        <div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[ç¬”è®°]-RocketMQ-Broker-DelayMessage</h2>
				
				<div>
					<div class="post-time">2019-10-21</div>
				</div>
				
				<div class="article-content">
				<p>CommitLog#putMessage</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> PutMessageResult <span class="token function">putMessage</span><span class="token punctuation">(</span><span class="token keyword">final</span> MessageExtBrokerInner msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> tranType <span class="token operator">=</span> MessageSysFlag<span class="token punctuation">.</span><span class="token function">getTransactionValue</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getSysFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// éäº‹åŠ¡æ¶ˆæ¯ || Commitå‹äº‹åŠ¡æ¶ˆæ¯</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tranType <span class="token operator">==</span> MessageSysFlag<span class="token punctuation">.</span>TRANSACTION_NOT_TYPE <span class="token operator">||</span> tranType <span class="token operator">==</span> MessageSysFlag<span class="token punctuation">.</span>TRANSACTION_COMMIT_TYPE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å¦‚æœè®¾ç½®äº†å»¶è¿ŸæŠ•é€’</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getDelayTimeLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getDelayTimeLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getScheduleMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxDelayLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    msg<span class="token punctuation">.</span><span class="token function">setDelayTimeLevel</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getScheduleMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxDelayLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// ä¿®æ”¹Topicä¸ºSCHEDULE_TOPIC_XXXXï¼Œä¸ä¼šè¢«Consumeræ¶ˆè´¹ï¼Œå› ä¸ºæ²¡è®¢é˜…è¿™ä¸ªTopicï¼Œåç»­ç”±åå°çº¿ç¨‹æ‰«ææ¢å¤åŸæœ¬ä¸»é¢˜</span>
                topic <span class="token operator">=</span> ScheduleMessageService<span class="token punctuation">.</span>SCHEDULE_TOPIC<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// æ ¹æ®å»¶æ—¶çº§åˆ«è®¡ç®—QueueIdï¼Œå…¶å®å°±æ˜¯DelayLevel-1ï¼Œåé¢ä¼šæŠŠæ¶ˆæ¯æ”¾åˆ°SCHEDULE_TOPIC_XXXXçš„é˜Ÿåˆ—é‡Œ</span>
                queueId <span class="token operator">=</span> ScheduleMessageService<span class="token punctuation">.</span><span class="token function">delayLevel2QueueId</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getDelayTimeLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å¤‡ä»½åŸæœ¬çš„Topicå’ŒQueueId</span>
                MessageAccessor<span class="token punctuation">.</span><span class="token function">putProperty</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> MessageConst<span class="token punctuation">.</span>PROPERTY_REAL_TOPIC<span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                MessageAccessor<span class="token punctuation">.</span><span class="token function">putProperty</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> MessageConst<span class="token punctuation">.</span>PROPERTY_REAL_QUEUE_ID<span class="token punctuation">,</span> String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                msg<span class="token punctuation">.</span><span class="token function">setPropertiesString</span><span class="token punctuation">(</span>MessageDecoder<span class="token punctuation">.</span><span class="token function">messageProperties2String</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ä¿®æ”¹Topic</span>
                msg<span class="token punctuation">.</span><span class="token function">setTopic</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ä¿®æ”¹QueueId</span>
                msg<span class="token punctuation">.</span><span class="token function">setQueueId</span><span class="token punctuation">(</span>queueId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">/*
                 * ç®€å•è¯´ä¸€ä¸‹å»¶æ—¶æ¶ˆæ¯çš„é€»è¾‘ï¼š
                 * å»¶æ—¶æ¶ˆæ¯åˆ°è¾¾Brokeråï¼Œä¿®æ”¹Topicä¸ºSCHEDULE_TOPIC_XXXXï¼ŒQueueIdä¸ºDelayLevel-1
                 * ReputMessageServiceå°†æ¶ˆæ¯ä»CommitLogä¸­æ›´æ–°ConsumeQueueæ—¶ï¼Œå°†TagsCodeæ¢æˆæ—¶é—´æˆ³ï¼Œå› ä¸ºå»¶æ—¶æ¶ˆæ¯ä¸éœ€è¦Tagè¿‡æ»¤ï¼Œæ²¡æœ‰Consumerè®¢é˜…
                 * DeliverDelayedMessageTimerTaskä»»åŠ¡çº¿ç¨‹éå†ConsumeQueueï¼Œæ ¹æ®TagsCodeå–å‡ºåˆ°æ—¶çš„æ¶ˆæ¯ï¼Œæ¢å¤åŸæœ¬çš„Topicå’ŒQueueIdï¼Œå†æ¬¡å†™å…¥CommitLog
                 * ç„¶åå†æ¬¡æ›´æ–°ConsumeQueueï¼Œè¿™æ ·å°±å¯ä»¥è¢«æ¶ˆè´¹äº†
                 */</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ...</span>
        MappedFile unlockMappedFile <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è·å–æœ€åä¸€ä¸ªMappedFileï¼Œå› ä¸ºæ˜¯é¡ºåºå†™å…¥</span>
        MappedFile mappedFile <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileQueue<span class="token punctuation">.</span><span class="token function">getLastMappedFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è·å–é”</span>
        putMessageLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//spin or ReentrantLock ,depending on store config</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// åœ¨å›è°ƒä¸­å°†æ¶ˆæ¯å†™å…¥MappedFileï¼Œè¿”å›ç»“æœ</span>
            result <span class="token operator">=</span> mappedFile<span class="token punctuation">.</span><span class="token function">appendMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>appendMessageCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">return</span> putMessageResult<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>CommitLog#checkMessageAndReturnSize</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> DispatchRequest <span class="token function">checkMessageAndReturnSize</span><span class="token punctuation">(</span>java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>ByteBuffer byteBuffer<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> checkCRC<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> readBody<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// Propertiesé•¿åº¦ï¼Œ2å­—èŠ‚</span>
            <span class="token keyword">short</span> propertiesLength <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">getShort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> propertiesMap <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>propertiesLength <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
                String tags <span class="token operator">=</span> propertiesMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>MessageConst<span class="token punctuation">.</span>PROPERTY_TAGS<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>tags <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> tags<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// TagsCode</span>
                    tagsCode <span class="token operator">=</span> MessageExtBrokerInner<span class="token punctuation">.</span><span class="token function">tagsString2tagsCode</span><span class="token punctuation">(</span>MessageExt<span class="token punctuation">.</span><span class="token function">parseTopicFilterType</span><span class="token punctuation">(</span>sysFlag<span class="token punctuation">)</span><span class="token punctuation">,</span> tags<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// å¤„ç†å»¶æ—¶æ¶ˆæ¯</span>
                <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å»¶æ—¶çº§åˆ«</span>
                    String t <span class="token operator">=</span> propertiesMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>MessageConst<span class="token punctuation">.</span>PROPERTY_DELAY_TIME_LEVEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// å¦‚æœæ˜¯å»¶æ—¶æ¶ˆæ¯</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>ScheduleMessageService<span class="token punctuation">.</span>SCHEDULE_TOPIC<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> t <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">int</span> delayLevel <span class="token operator">=</span> Integer<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// æ£€æŸ¥ï¼Œå¦‚æœå¤§äºæœ€å¤§çš„å»¶æ—¶çº§åˆ«</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>delayLevel <span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getScheduleMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxDelayLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            delayLevel <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getScheduleMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxDelayLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>delayLevel <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// è®¡ç®—å»¶è¿Ÿæ¶ˆæ¯åº”è¯¥è¢«æŠ•é€’çš„æ—¶é—´ï¼Œè¦†ç›–åŸæœ‰çš„TagsCode</span>
                            tagsCode <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getScheduleMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">computeDeliverTimestamp</span><span class="token punctuation">(</span>delayLevel<span class="token punctuation">,</span> storeTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// å°è£…æ¶ˆæ¯ï¼Œè¿”å›DispatchRequest</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DispatchRequest</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> physicOffset<span class="token punctuation">,</span> totalSize<span class="token punctuation">,</span> tagsCode<span class="token punctuation">,</span> storeTimestamp<span class="token punctuation">,</span> queueOffset<span class="token punctuation">,</span> keys<span class="token punctuation">,</span> uniqKey<span class="token punctuation">,</span> sysFlag<span class="token punctuation">,</span> preparedTransactionOffset<span class="token punctuation">,</span> propertiesMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DispatchRequest</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/* success */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ScheduleMessageService#start</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>started<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å®ˆæŠ¤çº¿ç¨‹</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>timer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Timer</span><span class="token punctuation">(</span><span class="token string">"ScheduleMessageTimerThread"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// éå†æ‰€æœ‰å»¶è¿Ÿçº§åˆ«</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>Map<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span>Integer<span class="token punctuation">,</span> Long<span class="token operator">></span> entry <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>delayLevelTable<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å»¶è¿Ÿçº§åˆ«</span>
                Integer level <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å»¶è¿Ÿæ¯«ç§’</span>
                Long timeDelay <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å»¶è¿Ÿçº§åˆ«å¯¹åº”çš„æ¶ˆè´¹è¿›åº¦åç§»</span>
                Long offset <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>offsetTable<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>level<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">==</span> offset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    offset <span class="token operator">=</span> 0L<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>timeDelay <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// æ¯ä¸ªå»¶è¿Ÿçº§åˆ«éƒ½æœ‰ä¸€ä¸ªTimerTaskè´Ÿè´£æ‰«æï¼Œä¸æ”¯æŒä»»æ„ç²¾åº¦çš„å»¶è¿Ÿ</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>timer<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DeliverDelayedMessageTimerTask</span><span class="token punctuation">(</span>level<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">,</span> FIRST_DELAY_TIME<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å®šæ—¶ä»»åŠ¡ï¼Œæ¯éš”åç§’å°†æ¶ˆè´¹è¿›åº¦æŒä¹…åŒ–åˆ°${user.home}/store/config/delayOffset.json</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>timer<span class="token punctuation">.</span><span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TimerTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>started<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            ScheduleMessageService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">persist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFlushDelayOffsetInterval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>ScheduleMessageService$DeliverDelayedMessageTimerTask#executeOnTimeup</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">executeOnTimeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ ¹æ®Topicå’Œå»¶è¿Ÿçº§åˆ«æ‰¾åˆ°ConsumeQueueï¼Œä¹‹å‰åŠ å…¥æ—¶è®¾ç½®QueueId = DelayLevel - 1</span>
            <span class="token comment" spellcheck="true">// æ‰€æœ‰çš„å»¶è¿Ÿæ¶ˆæ¯éƒ½æ”¾åœ¨SCHEDULE_TOPICä¸»é¢˜ä¸‹ï¼Œæ ¹æ®å»¶è¿Ÿçº§åˆ«ä¸åŒï¼ŒConsumeQueueé˜Ÿåˆ—ä¸åŒ</span>
            ConsumeQueue cq <span class="token operator">=</span> ScheduleMessageService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">findConsumeQueue</span><span class="token punctuation">(</span>SCHEDULE_TOPIC<span class="token punctuation">,</span> <span class="token function">delayLevel2QueueId</span><span class="token punctuation">(</span>delayLevel<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// åˆå§‹åŒ–æ—¶ä¼ å…¥çš„è¯¥å»¶è¿Ÿçº§åˆ«çš„ConsumeQueueçš„æ¶ˆæ¯æ¶ˆè´¹è¿›åº¦</span>
            <span class="token keyword">long</span> failScheduleOffset <span class="token operator">=</span> offset<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cq <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æ ¹æ®è¯¥å»¶è¿Ÿçº§åˆ«çš„æ¶ˆè´¹è¿›åº¦åç§»è·å–æ‰€æœ‰çš„æœªæ¶ˆè´¹æ¶ˆæ¯</span>
                SelectMappedBufferResult bufferCQ <span class="token operator">=</span> cq<span class="token punctuation">.</span><span class="token function">getIndexBuffer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// è·å–åˆ°æ¶ˆæ¯ç¼“å†²</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>bufferCQ <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token keyword">long</span> nextOffset <span class="token operator">=</span> offset<span class="token punctuation">;</span>
                        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                        ConsumeQueueExt<span class="token punctuation">.</span>CqExtUnit cqExtUnit <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConsumeQueueExt<span class="token punctuation">.</span>CqExtUnit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// éå†</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> bufferCQ<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">+=</span> ConsumeQueue<span class="token punctuation">.</span>CQ_STORE_UNIT_SIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">long</span> offsetPy <span class="token operator">=</span> bufferCQ<span class="token punctuation">.</span><span class="token function">getByteBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">int</span> sizePy <span class="token operator">=</span> bufferCQ<span class="token punctuation">.</span><span class="token function">getByteBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// TagsCode</span>
                            <span class="token keyword">long</span> tagsCode <span class="token operator">=</span> bufferCQ<span class="token punctuation">.</span><span class="token function">getByteBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>cq<span class="token punctuation">.</span><span class="token function">isExtAddr</span><span class="token punctuation">(</span>tagsCode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token comment" spellcheck="true">// ...</span>
                            <span class="token punctuation">}</span>
                            <span class="token keyword">long</span> now <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// æ ¹æ®TagsCodeè®¡ç®—å»¶æ—¶åˆ°æœŸæ—¶é—´ï¼Œæ›´æ–°ConsumeQueueæ—¶ï¼Œå¦‚æœæ˜¯å»¶æ—¶æ¶ˆæ¯ï¼Œä¼šå°†TagsCodeæ¢æˆæ—¶é—´æˆ³ï¼Œå› ä¸ºä¸éœ€è¦ç”¨Tagè¿‡æ»¤</span>
                            <span class="token keyword">long</span> deliverTimestamp <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">correctDeliverTimestamp</span><span class="token punctuation">(</span>now<span class="token punctuation">,</span> tagsCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            nextOffset <span class="token operator">=</span> offset <span class="token operator">+</span> <span class="token punctuation">(</span>i <span class="token operator">/</span> ConsumeQueue<span class="token punctuation">.</span>CQ_STORE_UNIT_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">long</span> countdown <span class="token operator">=</span> deliverTimestamp <span class="token operator">-</span> now<span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// æ¶ˆæ¯åˆ°æœŸï¼Œå¯ä»¥è¢«æ¶ˆè´¹</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>countdown <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token comment" spellcheck="true">// æ ¹æ®æ¶ˆæ¯åœ¨CommitLogçš„åç§»åŠæ¶ˆæ¯å¤§å°ä»CommitLogæŸ¥è¯¢æ¶ˆæ¯</span>
                                MessageExt msgExt <span class="token operator">=</span> ScheduleMessageService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">lookMessageByOffset</span><span class="token punctuation">(</span>offsetPy<span class="token punctuation">,</span> sizePy<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>msgExt <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                                        <span class="token comment" spellcheck="true">// å…ˆæ¢å¤æ¶ˆæ¯åŸå…ˆçš„QueueIdåŠTopic</span>
                                        MessageExtBrokerInner msgInner <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">messageTimeup</span><span class="token punctuation">(</span>msgExt<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                        <span class="token comment" spellcheck="true">// é‡æ–°å†™å…¥CommitLog</span>
                                        PutMessageResult putMessageResult <span class="token operator">=</span> ScheduleMessageService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>writeMessageStore<span class="token punctuation">.</span><span class="token function">putMessage</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                        <span class="token comment" spellcheck="true">// å†™å…¥æˆåŠŸ</span>
                                        <span class="token keyword">if</span> <span class="token punctuation">(</span>putMessageResult <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> putMessageResult<span class="token punctuation">.</span><span class="token function">getPutMessageStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> PutMessageStatus<span class="token punctuation">.</span>PUT_OK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                            <span class="token comment" spellcheck="true">// è·³è¿‡ï¼Œç»§ç»­ä¸‹ä¸€ä¸ªæ¶ˆæ¯</span>
                                            <span class="token keyword">continue</span><span class="token punctuation">;</span>
                                        <span class="token punctuation">}</span>
                                        <span class="token comment" spellcheck="true">// å†™å…¥å¤±è´¥</span>
                                        <span class="token keyword">else</span> <span class="token punctuation">{</span>
                                            <span class="token comment" spellcheck="true">// åç§’åç»§ç»­ä¸‹ä¸€æ¬¡è°ƒåº¦ä»»åŠ¡</span>
                                            ScheduleMessageService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>timer<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DeliverDelayedMessageTimerTask</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>delayLevel<span class="token punctuation">,</span> nextOffset<span class="token punctuation">)</span><span class="token punctuation">,</span> DELAY_FOR_A_PERIOD<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                            <span class="token comment" spellcheck="true">// æ›´æ–°å½“å‰å»¶è¿Ÿçº§åˆ«çš„æ¶ˆè´¹è¿›åº¦åç§»</span>
                                            ScheduleMessageService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateOffset</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>delayLevel<span class="token punctuation">,</span> nextOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                            <span class="token keyword">return</span><span class="token punctuation">;</span>
                                        <span class="token punctuation">}</span>
                                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                        <span class="token comment" spellcheck="true">// ...</span>
                                    <span class="token punctuation">}</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span>
                            <span class="token comment" spellcheck="true">// æ—¶é—´è¿˜æ²¡åˆ°</span>
                            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                                <span class="token comment" spellcheck="true">// æ ¹æ®å‰©ä½™æ—¶é—´ï¼Œå¯åŠ¨å®šæ—¶ä»»åŠ¡</span>
                                ScheduleMessageService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>timer<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DeliverDelayedMessageTimerTask</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>delayLevel<span class="token punctuation">,</span> nextOffset<span class="token punctuation">)</span><span class="token punctuation">,</span> countdown<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token comment" spellcheck="true">// æ›´æ–°å½“å‰å»¶è¿Ÿçº§åˆ«çš„æ¶ˆè´¹è¿›åº¦åç§»</span>
                                ScheduleMessageService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateOffset</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>delayLevel<span class="token punctuation">,</span> nextOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token comment" spellcheck="true">// è¿”å›</span>
                                <span class="token keyword">return</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// æ¶ˆæ¯éå†ç»“æŸ</span>
                        <span class="token comment" spellcheck="true">//</span>
                        nextOffset <span class="token operator">=</span> offset <span class="token operator">+</span> <span class="token punctuation">(</span>i <span class="token operator">/</span> ConsumeQueue<span class="token punctuation">.</span>CQ_STORE_UNIT_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        ScheduleMessageService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>timer<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DeliverDelayedMessageTimerTask</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>delayLevel<span class="token punctuation">,</span> nextOffset<span class="token punctuation">)</span><span class="token punctuation">,</span> DELAY_FOR_A_WHILE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        ScheduleMessageService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateOffset</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>delayLevel<span class="token punctuation">,</span> nextOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// ConsumeQueueçš„æ¶ˆè´¹åç§»åé¢æ²¡æœ‰æ•°æ®</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// è®¡åˆ’ä¸‹ä¸€æ¬¡ä»»åŠ¡</span>
            ScheduleMessageService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>timer<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DeliverDelayedMessageTimerTask</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>delayLevel<span class="token punctuation">,</span> failScheduleOffset<span class="token punctuation">)</span><span class="token punctuation">,</span> DELAY_FOR_A_WHILE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<hr>
<p>2019å¹´11æœˆ19æ—¥æ›´æ–°ï¼š</p>
<p>RocketMQæ˜¯ä¸æ”¯æŒä»»æ„ç²¾åº¦çš„å»¶æ—¶æ¶ˆæ¯çš„ï¼Œè€Œæ˜¯ä¸€ä¸ªå»¶æ—¶çº§åˆ«çš„æ¶ˆæ¯æ”¾åœ¨ä¸€ä¸ªé˜Ÿåˆ—é‡Œè¾¹ï¼ŒæŒ‰æ”¶åˆ°æ¶ˆæ¯çš„é¡ºåºæŒä¹…åŒ–ï¼Œä¹ŸæŒ‰ç…§æ­¤é¡ºåºå‘é€æ¶ˆæ¯ï¼Œå·§å¦™åœ°é¿å…äº†æ¶ˆæ¯æ’åºçš„å¼€é”€ï¼ŒåŒæ—¶æœ‰ä¸€ä¸ªç‹¬ç«‹çš„å®šæ—¶å™¨ï¼Œå¼€é”€ä¹Ÿä¸å¤§ã€‚</p>
<p>å¦‚æœæƒ³åŸºäºRocketMQå®ç°ä»»æ„ç²¾åº¦çš„å»¶æ—¶æ¶ˆæ¯ï¼Œæˆ‘è§‰å¾—é¦–å…ˆå¾—è§£å†³æ¶ˆæ¯æ’åºçš„é—®é¢˜ï¼Œä»Šå¤©å¶ç„¶çœ‹åˆ°<a href="https://www.cnblogs.com/hzmark/p/mq-delay-msg.html" target="_blank" rel="noopener">ä¸€ä½å¤§ä½¬çš„æ–‡ç« </a>åè±ç„¶å¼€æœ—ï¼Œä»¥ä¸‹æ˜¯æˆ‘å¯¹ä»–çš„æ€è·¯çš„ç†è§£ï¼š</p>
<ul>
<li><p>æ¶ˆæ¯å†™å…¥CommitLogï¼›</p>
</li>
<li><p>Dispatcherå¤„ç†å»¶è¿Ÿæ¶ˆæ¯ï¼›</p>
</li>
<li><p>å‡è®¾MQæ¯æ¬¡åªå¤„ç†å°†æ¥30åˆ†é’Ÿçš„å»¶è¿Ÿæ¶ˆæ¯ï¼Œå‡è®¾ç¬¬ä¸€æ¬¡å¤„ç†çš„å¼€å§‹æ—¶é—´ä¸ºæ•´ç‚¹ï¼Œå¦‚2019å¹´11æœˆ19æ—¥00ç‚¹00åˆ†ï¼Œä¸‹ä¸€æ¬¡å¤„ç†çš„å¼€å§‹æ—¶é—´å°±æ˜¯2019å¹´11æœˆ19æ—¥00ç‚¹30åˆ†ï¼Œä»¥æ­¤ç±»æ¨ï¼›</p>
</li>
<li><p>ç³»ç»Ÿæœ‰ä¸€ä¸ªTimeWheelï¼Œæ¯æ¬¡Tickçš„ç²¾åº¦ä¸º1sï¼Œå®Œæˆä¸€åœˆéœ€è¦30*60sï¼Œæ¯ä¸ªæ ¼å­çš„é“¾è¡¨åˆ™å­˜æ”¾è¯¥ç§’éœ€è¦å‘é€çš„æ¶ˆæ¯ç´¢å¼•ï¼ˆå†…å­˜çš„æ¶ˆè€—å¯ä»¥æ¥å—ï¼‰ï¼›</p>
</li>
<li><p>ç³»ç»Ÿæœ‰ä¸€ä¸ªDelayMsgFileæ–‡ä»¶é˜Ÿåˆ—ï¼Œä¸“é—¨å­˜æ”¾å»¶æ—¶æ¶ˆæ¯ï¼ŒæŒ‰é¡ºåºåªæ”¾è¯¥åŒºé—´çš„æ¶ˆæ¯ï¼Œæ¯”å¦‚ç¬¬ä¸€ä¸ªæ–‡ä»¶å­˜æ”¾2019å¹´11æœˆ19æ—¥00ç‚¹00åˆ†<del>2019å¹´11æœˆ19æ—¥00ç‚¹30åˆ†çš„æ¶ˆæ¯ï¼Œç¬¬äºŒä¸ªæ–‡ä»¶å­˜æ”¾2019å¹´11æœˆ19æ—¥30ç‚¹00åˆ†</del>2019å¹´11æœˆ19æ—¥01ç‚¹00åˆ†çš„æ¶ˆæ¯ï¼Œä¾æ¬¡ç±»æ¨ï¼Œå­˜å‚¨æ—¶æ¯ä¸ªæ¶ˆæ¯å•å…ƒåŒ…å«äº†æ¶ˆæ¯çš„ç›¸å¯¹æ—¶é—´ç´¢å¼•ï¼Œå³è¯¥æ¶ˆæ¯çš„æŠ•é€’æ—¶é—´ç›¸å¯¹äºè¯¥æ—¶é—´åŒºé—´å·¦ç«¯ç‚¹çš„ç§’æ•°å·®ï¼Œæ¯”å¦‚ï¼Œå¦‚æœä¸€ä¸ªæ¶ˆæ¯è®¡åˆ’åœ¨2019å¹´11æœˆ19æ—¥00ç‚¹03åˆ†æŠ•é€’ï¼Œé‚£ä¹ˆå®ƒçš„æ—¶é—´ç´¢å¼•å°±æ˜¯3*60ï¼Œå¯¹åº”çš„å°±æ˜¯TimeWheelçš„æŸä¸ªæ ¼å­ï¼›</p>
</li>
<li><p>TimeWheelå¯åŠ¨æ—¶ï¼Œä»å¯¹åº”çš„åŒºé—´çš„DelayMsgFileåŠ è½½æ¶ˆæ¯åˆ°TimeWheelï¼Œèµ°åˆ°å¯¹åº”æ ¼å­åå°±å°†é“¾è¡¨é‡Œçš„æ¶ˆæ¯æŠ•é€’åˆ°ConsumeQueueï¼Œè¿™æ ·å°±å¯¹æ¶ˆè´¹è€…å¯è§ã€‚è¿™æ®µæ—¶é—´å†…ï¼Œå¦‚æœæœ‰æ–°çš„ã€åœ¨åŒºé—´å†…çš„å»¶æ—¶æ¶ˆæ¯ï¼Œç›´æ¥æ”¾å…¥TimeWheelï¼Œå¦åˆ™æŒä¹…åŒ–å…¥å¯¹åº”çš„DelayMsgFileã€‚å½“TimeWheelèµ°å®Œä¸€åœˆåï¼Œåˆ é™¤å¯¹åº”çš„DelayMsgFileã€‚</p>
</li>
</ul>
<p>è¿™ä¸ªåšæ³•ä¹Ÿæ˜¯å·§å¦™åœ°é¿å¼€äº†å»¶æ—¶æ¶ˆæ¯çš„æ’åºé—®é¢˜ï¼Œå¤§æ¦‚è¿™å°±æ˜¯å¤§ä½¬å§ï¼Œå¯ä»¥æå‡ºåˆ›é€ æ€§çš„è§£å†³æ–¹æ¡ˆï¼Œåƒæˆ‘ï¼Œå°±æƒ³ä¸å‡ºæ¥ğŸ˜¬ã€‚</p>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


        <footer>
             
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

        </footer>
    </div>
    <!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
    <script>
        var timeEnd = new Date();
        console.log('è€—æ—¶ï¼š' + (timeEnd - timeStart));
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre').forEach((block) => {
                block.classList.add("line-numbers");
            });
        });
    </script>
    <!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
    <!-- material design -->
    <!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
    <!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
    <!-- toc -->
    <!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
    <!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
    <!-- <script src="/js/main.js"></script> -->
    <script src="/js/prism.js"></script>
</body>
</html>
