<!DOCTYPE HTML>
<html>
	<head><meta name="generator" content="Hexo 3.9.0">
		<meta charset="utf-8">
		<script src="/js/highlight.js"></script>
				<script>hljs.initHighlightingOnLoad();var timeStart = new Date();</script>
		
		<title>[ç¬”è®°]-RocketMQ-Broker-DelayMessage | å­¦è€Œæ—¶ä¹ ä¹‹</title>
		
		<meta name="author" content="Huangzhike">
		
		
		<meta name="description" content="K.I.S.S">
		
		
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		
		<meta property="og:title" content="[ç¬”è®°]-RocketMQ-Broker-DelayMessage">
		
		<meta property="og:site_name" content="å­¦è€Œæ—¶ä¹ ä¹‹">
		
		
		<!-- favicon -->
		<link rel="icon" type="image/ico" href="/ok.ico" sizes="32x32">
 


		<meta name="msapplication-TileColor" content="#009688">
		<meta name="msapplication-TileImage" content="/mstile-144x144.ico">
		<meta name="theme-color" content="#009688">

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Didact+Gothic"> 

		<!-- favicon end -->
		<!-- <link href="//ok.ico" rel="icon"> -->
		
		<!-- toc -->
		<!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
		<!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
		<!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
		<!-- material design -->
		<!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
		<!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
		<!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
		<!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
		<!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
		<link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
		 
		 
		<!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
		<!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
	</head>
</html>
<body>
	<nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">èœå•</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" href="/">å­¦è€Œæ—¶ä¹ ä¹‹</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

	<div class="container" >
		<div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[ç¬”è®°]-RocketMQ-Broker-DelayMessage</h2>
				
				<div>
					<div class="post-time">2019-10-21</div>
				</div>
				
				<div class="article-content">
				<p>CommitLog#putMessage</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> PutMessageResult <span class="title">putMessage</span><span class="params">(<span class="keyword">final</span> MessageExtBrokerInner msg)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> tranType = MessageSysFlag.getTransactionValue(msg.getSysFlag());</span><br><span class="line">    <span class="comment">// éäº‹åŠ¡æ¶ˆæ¯ || Commitå‹äº‹åŠ¡æ¶ˆæ¯</span></span><br><span class="line">    <span class="keyword">if</span> (tranType == MessageSysFlag.TRANSACTION_NOT_TYPE || tranType == MessageSysFlag.TRANSACTION_COMMIT_TYPE) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœè®¾ç½®äº†å»¶è¿ŸæŠ•é€’</span></span><br><span class="line">        <span class="keyword">if</span> (msg.getDelayTimeLevel() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (msg.getDelayTimeLevel() &gt; <span class="keyword">this</span>.defaultMessageStore.getScheduleMessageService().getMaxDelayLevel()) &#123;</span><br><span class="line">                msg.setDelayTimeLevel(<span class="keyword">this</span>.defaultMessageStore.getScheduleMessageService().getMaxDelayLevel());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// ä¿®æ”¹Topicä¸ºSCHEDULE_TOPIC_XXXXï¼Œä¸ä¼šè¢«Consumeræ¶ˆè´¹ï¼Œå› ä¸ºæ²¡è®¢é˜…è¿™ä¸ªTopicï¼Œåç»­ç”±åå°çº¿ç¨‹æ‰«ææ¢å¤åŸæœ¬ä¸»é¢˜</span></span><br><span class="line">            topic = ScheduleMessageService.SCHEDULE_TOPIC;</span><br><span class="line">            <span class="comment">// æ ¹æ®å»¶æ—¶çº§åˆ«è®¡ç®—QueueIdï¼Œå…¶å®å°±æ˜¯DelayLevel-1ï¼Œåé¢ä¼šæŠŠæ¶ˆæ¯æ”¾åˆ°SCHEDULE_TOPIC_XXXXçš„é˜Ÿåˆ—é‡Œ</span></span><br><span class="line">            queueId = ScheduleMessageService.delayLevel2QueueId(msg.getDelayTimeLevel());</span><br><span class="line">            <span class="comment">// å¤‡ä»½åŸæœ¬çš„Topicå’ŒQueueId</span></span><br><span class="line">            MessageAccessor.putProperty(msg, MessageConst.PROPERTY_REAL_TOPIC, msg.getTopic());</span><br><span class="line">            MessageAccessor.putProperty(msg, MessageConst.PROPERTY_REAL_QUEUE_ID, String.valueOf(msg.getQueueId()));</span><br><span class="line">            msg.setPropertiesString(MessageDecoder.messageProperties2String(msg.getProperties()));</span><br><span class="line">            <span class="comment">// ä¿®æ”¹Topic</span></span><br><span class="line">            msg.setTopic(topic);</span><br><span class="line">            <span class="comment">// ä¿®æ”¹QueueId</span></span><br><span class="line">            msg.setQueueId(queueId);</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * ç®€å•è¯´ä¸€ä¸‹å»¶æ—¶æ¶ˆæ¯çš„é€»è¾‘ï¼š</span></span><br><span class="line"><span class="comment">             * å»¶æ—¶æ¶ˆæ¯åˆ°è¾¾Brokeråï¼Œä¿®æ”¹Topicä¸ºSCHEDULE_TOPIC_XXXXï¼ŒQueueIdä¸ºDelayLevel-1</span></span><br><span class="line"><span class="comment">             * ReputMessageServiceå°†æ¶ˆæ¯ä»CommitLogä¸­æ›´æ–°ConsumeQueueæ—¶ï¼Œå°†TagsCodeæ¢æˆæ—¶é—´æˆ³ï¼Œå› ä¸ºå»¶æ—¶æ¶ˆæ¯ä¸éœ€è¦Tagè¿‡æ»¤ï¼Œæ²¡æœ‰Consumerè®¢é˜…</span></span><br><span class="line"><span class="comment">             * DeliverDelayedMessageTimerTaskä»»åŠ¡çº¿ç¨‹éå†ConsumeQueueï¼Œæ ¹æ®TagsCodeå–å‡ºåˆ°æ—¶çš„æ¶ˆæ¯ï¼Œæ¢å¤åŸæœ¬çš„Topicå’ŒQueueIdï¼Œå†æ¬¡å†™å…¥CommitLog</span></span><br><span class="line"><span class="comment">             * ç„¶åå†æ¬¡æ›´æ–°ConsumeQueueï¼Œè¿™æ ·å°±å¯ä»¥è¢«æ¶ˆè´¹äº†</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    MappedFile unlockMappedFile = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// è·å–æœ€åä¸€ä¸ªMappedFileï¼Œå› ä¸ºæ˜¯é¡ºåºå†™å…¥</span></span><br><span class="line">    MappedFile mappedFile = <span class="keyword">this</span>.mappedFileQueue.getLastMappedFile();</span><br><span class="line">    <span class="comment">// è·å–é”</span></span><br><span class="line">    putMessageLock.lock(); <span class="comment">//spin or ReentrantLock ,depending on store config</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="comment">// åœ¨å›è°ƒä¸­å°†æ¶ˆæ¯å†™å…¥MappedFileï¼Œè¿”å›ç»“æœ</span></span><br><span class="line">        result = mappedFile.appendMessage(msg, <span class="keyword">this</span>.appendMessageCallback);</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">return</span> putMessageResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>CommitLog#checkMessageAndReturnSize</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> DispatchRequest <span class="title">checkMessageAndReturnSize</span><span class="params">(java.nio.ByteBuffer byteBuffer, <span class="keyword">final</span> <span class="keyword">boolean</span> checkCRC, <span class="keyword">final</span> <span class="keyword">boolean</span> readBody)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="comment">// Propertiesé•¿åº¦ï¼Œ2å­—èŠ‚</span></span><br><span class="line">        <span class="keyword">short</span> propertiesLength = byteBuffer.getShort();</span><br><span class="line">        Map&lt;String, String&gt; propertiesMap = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (propertiesLength &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">            String tags = propertiesMap.get(MessageConst.PROPERTY_TAGS);</span><br><span class="line">            <span class="keyword">if</span> (tags != <span class="keyword">null</span> &amp;&amp; tags.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// TagsCode</span></span><br><span class="line">                tagsCode = MessageExtBrokerInner.tagsString2tagsCode(MessageExt.parseTopicFilterType(sysFlag), tags);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å¤„ç†å»¶æ—¶æ¶ˆæ¯</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// å»¶æ—¶çº§åˆ«</span></span><br><span class="line">                String t = propertiesMap.get(MessageConst.PROPERTY_DELAY_TIME_LEVEL);</span><br><span class="line">                <span class="comment">// å¦‚æœæ˜¯å»¶æ—¶æ¶ˆæ¯</span></span><br><span class="line">                <span class="keyword">if</span> (ScheduleMessageService.SCHEDULE_TOPIC.equals(topic) &amp;&amp; t != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">int</span> delayLevel = Integer.parseInt(t);</span><br><span class="line">                    <span class="comment">// æ£€æŸ¥ï¼Œå¦‚æœå¤§äºæœ€å¤§çš„å»¶æ—¶çº§åˆ«</span></span><br><span class="line">                    <span class="keyword">if</span> (delayLevel &gt; <span class="keyword">this</span>.defaultMessageStore.getScheduleMessageService().getMaxDelayLevel()) &#123;</span><br><span class="line">                        delayLevel = <span class="keyword">this</span>.defaultMessageStore.getScheduleMessageService().getMaxDelayLevel();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (delayLevel &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">// è®¡ç®—å»¶è¿Ÿæ¶ˆæ¯åº”è¯¥è¢«æŠ•é€’çš„æ—¶é—´ï¼Œè¦†ç›–åŸæœ‰çš„TagsCode</span></span><br><span class="line">                        tagsCode = <span class="keyword">this</span>.defaultMessageStore.getScheduleMessageService().computeDeliverTimestamp(delayLevel, storeTimestamp);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="comment">// å°è£…æ¶ˆæ¯ï¼Œè¿”å›DispatchRequest</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DispatchRequest(topic, queueId, physicOffset, totalSize, tagsCode, storeTimestamp, queueOffset, keys, uniqKey, sysFlag, preparedTransactionOffset, propertiesMap);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> DispatchRequest(-<span class="number">1</span>, <span class="keyword">false</span> <span class="comment">/* success */</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ScheduleMessageService#start</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (started.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">        <span class="comment">// å®ˆæŠ¤çº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">this</span>.timer = <span class="keyword">new</span> Timer(<span class="string">"ScheduleMessageTimerThread"</span>, <span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">// éå†æ‰€æœ‰å»¶è¿Ÿçº§åˆ«</span></span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;Integer, Long&gt; entry : <span class="keyword">this</span>.delayLevelTable.entrySet()) &#123;</span><br><span class="line">            <span class="comment">// å»¶è¿Ÿçº§åˆ«</span></span><br><span class="line">            Integer level = entry.getKey();</span><br><span class="line">            <span class="comment">// å»¶è¿Ÿæ¯«ç§’</span></span><br><span class="line">            Long timeDelay = entry.getValue();</span><br><span class="line">            <span class="comment">// å»¶è¿Ÿçº§åˆ«å¯¹åº”çš„æ¶ˆè´¹è¿›åº¦åç§»</span></span><br><span class="line">            Long offset = <span class="keyword">this</span>.offsetTable.get(level);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> == offset) &#123;</span><br><span class="line">                offset = <span class="number">0L</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (timeDelay != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// æ¯ä¸ªå»¶è¿Ÿçº§åˆ«éƒ½æœ‰ä¸€ä¸ªTimerTaskè´Ÿè´£æ‰«æï¼Œä¸æ”¯æŒä»»æ„ç²¾åº¦çš„å»¶è¿Ÿ</span></span><br><span class="line">                <span class="keyword">this</span>.timer.schedule(<span class="keyword">new</span> DeliverDelayedMessageTimerTask(level, offset), FIRST_DELAY_TIME);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å®šæ—¶ä»»åŠ¡ï¼Œæ¯éš”åç§’å°†æ¶ˆè´¹è¿›åº¦æŒä¹…åŒ–åˆ°$&#123;user.home&#125;/store/config/delayOffset.json</span></span><br><span class="line">        <span class="keyword">this</span>.timer.scheduleAtFixedRate(<span class="keyword">new</span> TimerTask() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (started.get())</span><br><span class="line">                        ScheduleMessageService.<span class="keyword">this</span>.persist();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    <span class="comment">// ...</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">10000</span>, <span class="keyword">this</span>.defaultMessageStore.getMessageStoreConfig().getFlushDelayOffsetInterval());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ScheduleMessageService$DeliverDelayedMessageTimerTask#executeOnTimeup</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeOnTimeup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ ¹æ®Topicå’Œå»¶è¿Ÿçº§åˆ«æ‰¾åˆ°ConsumeQueueï¼Œä¹‹å‰åŠ å…¥æ—¶è®¾ç½®QueueId = DelayLevel - 1</span></span><br><span class="line">    <span class="comment">// æ‰€æœ‰çš„å»¶è¿Ÿæ¶ˆæ¯éƒ½æ”¾åœ¨SCHEDULE_TOPICä¸»é¢˜ä¸‹ï¼Œæ ¹æ®å»¶è¿Ÿçº§åˆ«ä¸åŒï¼ŒConsumeQueueé˜Ÿåˆ—ä¸åŒ</span></span><br><span class="line">    ConsumeQueue cq = ScheduleMessageService.<span class="keyword">this</span>.defaultMessageStore.findConsumeQueue(SCHEDULE_TOPIC, delayLevel2QueueId(delayLevel));</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–æ—¶ä¼ å…¥çš„è¯¥å»¶è¿Ÿçº§åˆ«çš„ConsumeQueueçš„æ¶ˆæ¯æ¶ˆè´¹è¿›åº¦</span></span><br><span class="line">    <span class="keyword">long</span> failScheduleOffset = offset;</span><br><span class="line">    <span class="keyword">if</span> (cq != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// æ ¹æ®è¯¥å»¶è¿Ÿçº§åˆ«çš„æ¶ˆè´¹è¿›åº¦åç§»è·å–æ‰€æœ‰çš„æœªæ¶ˆè´¹æ¶ˆæ¯</span></span><br><span class="line">        SelectMappedBufferResult bufferCQ = cq.getIndexBuffer(<span class="keyword">this</span>.offset);</span><br><span class="line">        <span class="comment">// è·å–åˆ°æ¶ˆæ¯ç¼“å†²</span></span><br><span class="line">        <span class="keyword">if</span> (bufferCQ != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">long</span> nextOffset = offset;</span><br><span class="line">                <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">                ConsumeQueueExt.CqExtUnit cqExtUnit = <span class="keyword">new</span> ConsumeQueueExt.CqExtUnit();</span><br><span class="line">                <span class="comment">// éå†</span></span><br><span class="line">                <span class="keyword">for</span> (; i &lt; bufferCQ.getSize(); i += ConsumeQueue.CQ_STORE_UNIT_SIZE) &#123;</span><br><span class="line">                    <span class="keyword">long</span> offsetPy = bufferCQ.getByteBuffer().getLong();</span><br><span class="line">                    <span class="keyword">int</span> sizePy = bufferCQ.getByteBuffer().getInt();</span><br><span class="line">                    <span class="comment">// TagsCode</span></span><br><span class="line">                    <span class="keyword">long</span> tagsCode = bufferCQ.getByteBuffer().getLong();</span><br><span class="line">                    <span class="keyword">if</span> (cq.isExtAddr(tagsCode)) &#123;</span><br><span class="line">                        <span class="comment">// ...</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">long</span> now = System.currentTimeMillis();</span><br><span class="line">                    <span class="comment">// æ ¹æ®TagsCodeè®¡ç®—å»¶æ—¶åˆ°æœŸæ—¶é—´ï¼Œæ›´æ–°ConsumeQueueæ—¶ï¼Œå¦‚æœæ˜¯å»¶æ—¶æ¶ˆæ¯ï¼Œä¼šå°†TagsCodeæ¢æˆæ—¶é—´æˆ³ï¼Œå› ä¸ºä¸éœ€è¦ç”¨Tagè¿‡æ»¤</span></span><br><span class="line">                    <span class="keyword">long</span> deliverTimestamp = <span class="keyword">this</span>.correctDeliverTimestamp(now, tagsCode);</span><br><span class="line">                    nextOffset = offset + (i / ConsumeQueue.CQ_STORE_UNIT_SIZE);</span><br><span class="line">                    <span class="keyword">long</span> countdown = deliverTimestamp - now;</span><br><span class="line">                    <span class="comment">// æ¶ˆæ¯åˆ°æœŸï¼Œå¯ä»¥è¢«æ¶ˆè´¹</span></span><br><span class="line">                    <span class="keyword">if</span> (countdown &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">// æ ¹æ®æ¶ˆæ¯åœ¨CommitLogçš„åç§»åŠæ¶ˆæ¯å¤§å°ä»CommitLogæŸ¥è¯¢æ¶ˆæ¯</span></span><br><span class="line">                        MessageExt msgExt = ScheduleMessageService.<span class="keyword">this</span>.defaultMessageStore.lookMessageByOffset(offsetPy, sizePy);</span><br><span class="line">                        <span class="keyword">if</span> (msgExt != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                <span class="comment">// å…ˆæ¢å¤æ¶ˆæ¯åŸå…ˆçš„QueueIdåŠTopic</span></span><br><span class="line">                                MessageExtBrokerInner msgInner = <span class="keyword">this</span>.messageTimeup(msgExt);</span><br><span class="line">                                <span class="comment">// é‡æ–°å†™å…¥CommitLog</span></span><br><span class="line">                                PutMessageResult putMessageResult = ScheduleMessageService.<span class="keyword">this</span>.writeMessageStore.putMessage(msgInner);</span><br><span class="line">                                <span class="comment">// å†™å…¥æˆåŠŸ</span></span><br><span class="line">                                <span class="keyword">if</span> (putMessageResult != <span class="keyword">null</span> &amp;&amp; putMessageResult.getPutMessageStatus() == PutMessageStatus.PUT_OK) &#123;</span><br><span class="line">                                    <span class="comment">// è·³è¿‡ï¼Œç»§ç»­ä¸‹ä¸€ä¸ªæ¶ˆæ¯</span></span><br><span class="line">                                    <span class="keyword">continue</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="comment">// å†™å…¥å¤±è´¥</span></span><br><span class="line">                                <span class="keyword">else</span> &#123;</span><br><span class="line">                                    <span class="comment">// åç§’åç»§ç»­ä¸‹ä¸€æ¬¡è°ƒåº¦ä»»åŠ¡</span></span><br><span class="line">                                    ScheduleMessageService.<span class="keyword">this</span>.timer.schedule(<span class="keyword">new</span> DeliverDelayedMessageTimerTask(<span class="keyword">this</span>.delayLevel, nextOffset), DELAY_FOR_A_PERIOD);</span><br><span class="line">                                    <span class="comment">// æ›´æ–°å½“å‰å»¶è¿Ÿçº§åˆ«çš„æ¶ˆè´¹è¿›åº¦åç§»</span></span><br><span class="line">                                    ScheduleMessageService.<span class="keyword">this</span>.updateOffset(<span class="keyword">this</span>.delayLevel, nextOffset);</span><br><span class="line">                                    <span class="keyword">return</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                                <span class="comment">// ...</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// æ—¶é—´è¿˜æ²¡åˆ°</span></span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// æ ¹æ®å‰©ä½™æ—¶é—´ï¼Œå¯åŠ¨å®šæ—¶ä»»åŠ¡</span></span><br><span class="line">                        ScheduleMessageService.<span class="keyword">this</span>.timer.schedule(<span class="keyword">new</span> DeliverDelayedMessageTimerTask(<span class="keyword">this</span>.delayLevel, nextOffset), countdown);</span><br><span class="line">                        <span class="comment">// æ›´æ–°å½“å‰å»¶è¿Ÿçº§åˆ«çš„æ¶ˆè´¹è¿›åº¦åç§»</span></span><br><span class="line">                        ScheduleMessageService.<span class="keyword">this</span>.updateOffset(<span class="keyword">this</span>.delayLevel, nextOffset);</span><br><span class="line">                        <span class="comment">// è¿”å›</span></span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="comment">// æ¶ˆæ¯éå†ç»“æŸ</span></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                nextOffset = offset + (i / ConsumeQueue.CQ_STORE_UNIT_SIZE);</span><br><span class="line">                ScheduleMessageService.<span class="keyword">this</span>.timer.schedule(<span class="keyword">new</span> DeliverDelayedMessageTimerTask(<span class="keyword">this</span>.delayLevel, nextOffset), DELAY_FOR_A_WHILE);</span><br><span class="line">                ScheduleMessageService.<span class="keyword">this</span>.updateOffset(<span class="keyword">this</span>.delayLevel, nextOffset);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// ...</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ConsumeQueueçš„æ¶ˆè´¹åç§»åé¢æ²¡æœ‰æ•°æ®</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è®¡åˆ’ä¸‹ä¸€æ¬¡ä»»åŠ¡</span></span><br><span class="line">    ScheduleMessageService.<span class="keyword">this</span>.timer.schedule(<span class="keyword">new</span> DeliverDelayedMessageTimerTask(<span class="keyword">this</span>.delayLevel, failScheduleOffset), DELAY_FOR_A_WHILE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p>2019å¹´11æœˆ19æ—¥æ›´æ–°ï¼š</p>
<p>RocketMQæ˜¯ä¸æ”¯æŒä»»æ„ç²¾åº¦çš„å»¶æ—¶æ¶ˆæ¯çš„ï¼Œè€Œæ˜¯ä¸€ä¸ªå»¶æ—¶çº§åˆ«çš„æ¶ˆæ¯æ”¾åœ¨ä¸€ä¸ªé˜Ÿåˆ—é‡Œè¾¹ï¼ŒæŒ‰æ”¶åˆ°æ¶ˆæ¯çš„é¡ºåºæŒä¹…åŒ–ï¼Œä¹ŸæŒ‰ç…§æ­¤é¡ºåºå‘é€æ¶ˆæ¯ï¼Œå·§å¦™åœ°é¿å…äº†æ¶ˆæ¯æ’åºçš„å¼€é”€ï¼ŒåŒæ—¶æœ‰ä¸€ä¸ªç‹¬ç«‹çš„å®šæ—¶å™¨ï¼Œå¼€é”€ä¹Ÿä¸å¤§ã€‚</p>
<p>å¦‚æœæƒ³åŸºäºRocketMQå®ç°ä»»æ„ç²¾åº¦çš„å»¶æ—¶æ¶ˆæ¯ï¼Œæˆ‘è§‰å¾—é¦–å…ˆå¾—è§£å†³æ¶ˆæ¯æ’åºçš„é—®é¢˜ï¼Œä»Šå¤©å¶ç„¶çœ‹åˆ°<a href="https://www.cnblogs.com/hzmark/p/mq-delay-msg.html" target="_blank" rel="noopener">ä¸€ä½å¤§ä½¬çš„æ–‡ç« </a>åè±ç„¶å¼€æœ—ï¼Œä»¥ä¸‹æ˜¯æˆ‘å¯¹ä»–çš„æ€è·¯çš„ç†è§£ï¼š</p>
<ul>
<li><p>æ¶ˆæ¯å†™å…¥CommitLogï¼›</p>
</li>
<li><p>Dispatcherå¤„ç†å»¶è¿Ÿæ¶ˆæ¯ï¼›</p>
</li>
<li><p>å‡è®¾MQæ¯æ¬¡åªå¤„ç†å°†æ¥30åˆ†é’Ÿçš„å»¶è¿Ÿæ¶ˆæ¯ï¼Œå‡è®¾ç¬¬ä¸€æ¬¡å¤„ç†çš„å¼€å§‹æ—¶é—´ä¸ºæ•´ç‚¹ï¼Œå¦‚2019å¹´11æœˆ19æ—¥00ç‚¹00åˆ†ï¼Œä¸‹ä¸€æ¬¡å¤„ç†çš„å¼€å§‹æ—¶é—´å°±æ˜¯2019å¹´11æœˆ19æ—¥00ç‚¹30åˆ†ï¼Œä»¥æ­¤ç±»æ¨ï¼›</p>
</li>
<li><p>ç³»ç»Ÿæœ‰ä¸€ä¸ªTimeWheelï¼Œæ¯æ¬¡Tickçš„ç²¾åº¦ä¸º1sï¼Œå®Œæˆä¸€åœˆéœ€è¦30*60sï¼Œæ¯ä¸ªæ ¼å­çš„é“¾è¡¨åˆ™å­˜æ”¾è¯¥ç§’éœ€è¦å‘é€çš„æ¶ˆæ¯ç´¢å¼•ï¼ˆå†…å­˜çš„æ¶ˆè€—å¯ä»¥æ¥å—ï¼‰ï¼›</p>
</li>
<li><p>ç³»ç»Ÿæœ‰ä¸€ä¸ªDelayMsgFileæ–‡ä»¶é˜Ÿåˆ—ï¼Œä¸“é—¨å­˜æ”¾å»¶æ—¶æ¶ˆæ¯ï¼ŒæŒ‰é¡ºåºåªæ”¾è¯¥åŒºé—´çš„æ¶ˆæ¯ï¼Œæ¯”å¦‚ç¬¬ä¸€ä¸ªæ–‡ä»¶å­˜æ”¾2019å¹´11æœˆ19æ—¥00ç‚¹00åˆ†~2019å¹´11æœˆ19æ—¥00ç‚¹30åˆ†çš„æ¶ˆæ¯ï¼Œç¬¬äºŒä¸ªæ–‡ä»¶å­˜æ”¾2019å¹´11æœˆ19æ—¥30ç‚¹00åˆ†~2019å¹´11æœˆ19æ—¥01ç‚¹00åˆ†çš„æ¶ˆæ¯ï¼Œä¾æ¬¡ç±»æ¨ï¼Œå­˜å‚¨æ—¶æ¯ä¸ªæ¶ˆæ¯å•å…ƒåŒ…å«äº†æ¶ˆæ¯çš„ç›¸å¯¹æ—¶é—´ç´¢å¼•ï¼Œå³è¯¥æ¶ˆæ¯çš„æŠ•é€’æ—¶é—´ç›¸å¯¹äºè¯¥æ—¶é—´åŒºé—´å·¦ç«¯ç‚¹çš„ç§’æ•°å·®ï¼Œæ¯”å¦‚ï¼Œå¦‚æœä¸€ä¸ªæ¶ˆæ¯è®¡åˆ’åœ¨2019å¹´11æœˆ19æ—¥00ç‚¹03åˆ†æŠ•é€’ï¼Œé‚£ä¹ˆå®ƒçš„æ—¶é—´ç´¢å¼•å°±æ˜¯3*60ï¼Œå¯¹åº”çš„å°±æ˜¯TimeWheelçš„æŸä¸ªæ ¼å­ï¼›</p>
</li>
<li><p>TimeWheelå¯åŠ¨æ—¶ï¼Œä»å¯¹åº”çš„åŒºé—´çš„DelayMsgFileåŠ è½½æ¶ˆæ¯åˆ°TimeWheelï¼Œèµ°åˆ°å¯¹åº”æ ¼å­åå°±å°†é“¾è¡¨é‡Œçš„æ¶ˆæ¯æŠ•é€’åˆ°ConsumeQueueï¼Œè¿™æ ·å°±å¯¹æ¶ˆè´¹è€…å¯è§ã€‚è¿™æ®µæ—¶é—´å†…ï¼Œå¦‚æœæœ‰æ–°çš„ã€åœ¨åŒºé—´å†…çš„å»¶æ—¶æ¶ˆæ¯ï¼Œç›´æ¥æ”¾å…¥TimeWheelï¼Œå¦åˆ™æŒä¹…åŒ–å…¥å¯¹åº”çš„DelayMsgFileã€‚å½“TimeWheelèµ°å®Œä¸€åœˆåï¼Œåˆ é™¤å¯¹åº”çš„DelayMsgFileã€‚</p>
</li>
</ul>
<p>è¿™ä¸ªåšæ³•ä¹Ÿæ˜¯å·§å¦™åœ°é¿å¼€äº†å»¶æ—¶æ¶ˆæ¯çš„æ’åºé—®é¢˜ï¼Œå¤§æ¦‚è¿™å°±æ˜¯å¤§ä½¬å§ï¼Œå¯ä»¥æå‡ºåˆ›é€ æ€§çš„è§£å†³æ–¹æ¡ˆï¼Œåƒæˆ‘ï¼Œå°±æƒ³ä¸å‡ºæ¥ğŸ˜¬ã€‚</p>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


		<footer>
			 
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

		</footer>
	</div>
	<!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->

	<script>var timeEnd = new Date();console.log('è€—æ—¶ï¼š' + (timeEnd - timeStart));</script>
	<!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
	<!-- material design -->
	<!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
	<!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
	<!-- toc -->
	<!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
	<!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
	<!-- <script src="/js/main.js"></script> -->
</body>
</html>
