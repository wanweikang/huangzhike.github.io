<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
        <script>
            var timeStart = new Date();
        </script>
        
        <title>[ç¬”è®°]-RocketMQ-Broker-CommitLog-Put | ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜</title>
        
        <meta name="author" content="huangzhike">
        
        
        <meta name="description" content="DefaultMessageStore#putMessage
    public PutMessageResult putMessage(MessageExtBrokerInner msg) {
        // MessageStoreå…³é—­ï¼Œä¸æ¥å—æ¶ˆæ¯
        if (this.sh">
        
        
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        
        <meta property="og:title" content="[ç¬”è®°]-RocketMQ-Broker-CommitLog-Put"/>
        
        <meta property="og:site_name" content="ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜"/>
        
        
        <!-- favicon -->
        <link rel="icon" type="image/ico" href="/ok.ico" sizes="32x32">
        <meta name="msapplication-TileColor" content="#009688">
        <meta name="msapplication-TileImage" content="/mstile-144x144.ico">
        <meta name="theme-color" content="#009688">
        <!-- favicon end -->
        <!-- <link href="//ok.ico" rel="icon"> -->
        
        <!-- toc -->
        <!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
        <!-- material design -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
        <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
        
        <!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
        <!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
    <meta name="generator" content="Hexo 4.2.1"></head>

<body>
    <nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">èœå•</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" title="ä¸‹ä¸€å¥æ˜¯ï¼šå®¢æœ‰å¯äººæœŸä¸æ¥ã€‚å°æ—¶å€™ï¼Œå–œæ¬¢é åœ¨é˜³å°ä¸Šï¼Œä¸€è¾¹å¹é£ï¼Œä¸€è¾¹çœ‹ä¹¦ï¼Œå–œæ¬¢è¯»ä¹¦å—ï¼Œéªšå¹´ï¼Ÿ" href="/">ä¹¦å½“å¿«æ„è¯»æ˜“å°½</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" target="_blank" rel="noopener" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

    <div class="container" >
        <div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[ç¬”è®°]-RocketMQ-Broker-CommitLog-Put</h2>
				
				<div>
					<div class="post-time">2019-10-21</div>
				</div>
				
				<div class="article-content">
				<p>DefaultMessageStore#putMessage</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> PutMessageResult <span class="token function">putMessage</span><span class="token punctuation">(</span>MessageExtBrokerInner msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// MessageStoreå…³é—­ï¼Œä¸æ¥å—æ¶ˆæ¯</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>shutdown<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// SLAVEï¼Œä¸æ¥å—æ¶ˆæ¯</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>BrokerRole<span class="token punctuation">.</span>SLAVE <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>messageStoreConfig<span class="token punctuation">.</span><span class="token function">getBrokerRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Brokerä¸å¯å†™ï¼Œä¸ä¿å­˜</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>runningFlags<span class="token punctuation">.</span><span class="token function">isWriteable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Topicé•¿åº¦è¶…è¿‡Byte.MAX_VALUEï¼Œä¸ä¿å­˜</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> Byte<span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Propertiesé•¿åº¦è¶…è¿‡Short.MAX_VALUEï¼Œä¸ä¿å­˜</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getPropertiesString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> msg<span class="token punctuation">.</span><span class="token function">getPropertiesString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> Short<span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// æ“ä½œç³»ç»ŸPageCacheå¿™ï¼Œä¸ä¿å­˜</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isOSPageCacheBusy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// æŠŠæ¶ˆæ¯æ”¾å…¥CommitLogï¼Œè¿”å›ç»“æœ</span>
        PutMessageResult result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>commitLog<span class="token punctuation">.</span><span class="token function">putMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// ç»Ÿè®¡è€—æ—¶</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// ç»Ÿè®¡å¤±è´¥æ¬¡æ•°</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> PutMessageResult <span class="token function">putMessage</span><span class="token punctuation">(</span><span class="token keyword">final</span> MessageExtBrokerInner msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// å­˜å‚¨æ—¶é—´æˆ³ï¼Œåé¢ä¼šè¢«è¦†ç›–ï¼Œæ‰€ä»¥è¿™é‡Œçš„æ„ä¹‰æ˜¯ï¼Ÿ</span>
        msg<span class="token punctuation">.</span><span class="token function">setStoreTimestamp</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ¶ˆæ¯ä½“çš„CRCæ ¡éªŒ</span>
        msg<span class="token punctuation">.</span><span class="token function">setBodyCRC</span><span class="token punctuation">(</span>UtilAll<span class="token punctuation">.</span><span class="token function">crc32</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Back to Results</span>
        AppendMessageResult result <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        String topic <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> queueId <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> tranType <span class="token operator">=</span> MessageSysFlag<span class="token punctuation">.</span><span class="token function">getTransactionValue</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getSysFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// éäº‹åŠ¡æ¶ˆæ¯ || Commitå‹äº‹åŠ¡æ¶ˆæ¯</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tranType <span class="token operator">==</span> MessageSysFlag<span class="token punctuation">.</span>TRANSACTION_NOT_TYPE <span class="token operator">||</span> tranType <span class="token operator">==</span> MessageSysFlag<span class="token punctuation">.</span>TRANSACTION_COMMIT_TYPE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å¦‚æœè®¾ç½®äº†å»¶è¿ŸæŠ•é€’</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getDelayTimeLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getDelayTimeLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getScheduleMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxDelayLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    msg<span class="token punctuation">.</span><span class="token function">setDelayTimeLevel</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getScheduleMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxDelayLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// ä¿®æ”¹Topicä¸ºSCHEDULE_TOPIC_XXXXï¼Œä¸ä¼šè¢«Consumeræ¶ˆè´¹ï¼Œå› ä¸ºæ²¡è®¢é˜…è¿™ä¸ªTopicï¼Œåç»­ç”±åå°çº¿ç¨‹æ‰«ææ¢å¤åŸæœ¬ä¸»é¢˜</span>
                topic <span class="token operator">=</span> ScheduleMessageService<span class="token punctuation">.</span>SCHEDULE_TOPIC<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// æ ¹æ®å»¶æ—¶çº§åˆ«è®¡ç®—QueueIdï¼Œå…¶å®å°±æ˜¯DelayLevel-1ï¼Œåé¢ä¼šæŠŠæ¶ˆæ¯æ”¾åˆ°SCHEDULE_TOPIC_XXXXçš„é˜Ÿåˆ—é‡Œ</span>
                queueId <span class="token operator">=</span> ScheduleMessageService<span class="token punctuation">.</span><span class="token function">delayLevel2QueueId</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getDelayTimeLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å¤‡ä»½åŸæœ¬çš„Topicå’ŒQueueId</span>
                MessageAccessor<span class="token punctuation">.</span><span class="token function">putProperty</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> MessageConst<span class="token punctuation">.</span>PROPERTY_REAL_TOPIC<span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                MessageAccessor<span class="token punctuation">.</span><span class="token function">putProperty</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> MessageConst<span class="token punctuation">.</span>PROPERTY_REAL_QUEUE_ID<span class="token punctuation">,</span> String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                msg<span class="token punctuation">.</span><span class="token function">setPropertiesString</span><span class="token punctuation">(</span>MessageDecoder<span class="token punctuation">.</span><span class="token function">messageProperties2String</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ä¿®æ”¹Topic</span>
                msg<span class="token punctuation">.</span><span class="token function">setTopic</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ä¿®æ”¹QueueId</span>
                msg<span class="token punctuation">.</span><span class="token function">setQueueId</span><span class="token punctuation">(</span>queueId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">/*
                 * ç®€å•è¯´ä¸€ä¸‹å»¶æ—¶æ¶ˆæ¯çš„é€»è¾‘ï¼š
                 * å»¶æ—¶æ¶ˆæ¯åˆ°è¾¾Brokeråï¼Œä¿®æ”¹Topicä¸ºSCHEDULE_TOPIC_XXXXï¼ŒQueueIdä¸ºDelayLevel-1
                 * ReputMessageServiceå°†æ¶ˆæ¯ä»CommitLogä¸­æ›´æ–°ConsumeQueueæ—¶ï¼Œå°†TagsCodeæ¢æˆæ—¶é—´æˆ³ï¼Œå› ä¸ºå»¶æ—¶æ¶ˆæ¯ä¸éœ€è¦Tagè¿‡æ»¤ï¼Œæ²¡æœ‰Consumerè®¢é˜…
                 * DeliverDelayedMessageTimerTaskä»»åŠ¡çº¿ç¨‹éå†ConsumeQueueï¼Œæ ¹æ®TagsCodeå–å‡ºåˆ°æ—¶çš„æ¶ˆæ¯ï¼Œæ¢å¤åŸæœ¬çš„Topicå’ŒQueueIdï¼Œå†æ¬¡å†™å…¥CommitLog
                 * ç„¶åå†æ¬¡æ›´æ–°ConsumeQueueï¼Œè¿™æ ·å°±å¯ä»¥è¢«æ¶ˆè´¹äº†
                 */</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ...</span>
        MappedFile unlockMappedFile <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è·å–æœ€åä¸€ä¸ªMappedFileï¼Œå› ä¸ºæ˜¯é¡ºåºå†™å…¥</span>
        MappedFile mappedFile <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileQueue<span class="token punctuation">.</span><span class="token function">getLastMappedFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è·å–é”</span>
        putMessageLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//spin or ReentrantLock ,depending on store config</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">long</span> beginLockTimestamp <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getSystemClock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>beginTimeInLock <span class="token operator">=</span> beginLockTimestamp<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ä¸ºäº†ä¿è¯å…¨å±€æœ‰åºï¼Œä½¿ç”¨è·å¾—é”åçš„æ—¶é—´æˆ³ä¸ºå­˜å‚¨æ—¶é—´æˆ³</span>
            msg<span class="token punctuation">.</span><span class="token function">setStoreTimestamp</span><span class="token punctuation">(</span>beginLockTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ä¸å­˜åœ¨ï¼Œå¯èƒ½æ˜¯ç¬¬ä¸€æ¬¡å¯åŠ¨ || æ–‡ä»¶å·²æ»¡</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">==</span> mappedFile <span class="token operator">||</span> mappedFile<span class="token punctuation">.</span><span class="token function">isFull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// åˆ›å»ºæ–°çš„MappedFileï¼ŒåŸæ³¨é‡Šçš„å™ªéŸ³å¤§æ¦‚æŒ‡çš„æ˜¯å†…å­˜æŠ–åŠ¨ï¼Ÿ</span>
                <span class="token comment" spellcheck="true">// may be cause noise è¿™å¥è¯æ˜¯ä¸æ˜¯æœ‰è¯­æ³•é”™è¯¯å•Šï¼Ÿåº”è¯¥æ˜¯ may cause noise æˆ– may be causing noise å§ï¼Ÿ</span>
                mappedFile <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileQueue<span class="token punctuation">.</span><span class="token function">getLastMappedFile</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Mark: NewFile may be cause noise</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// åˆ›å»ºMappedFileå¤±è´¥</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">==</span> mappedFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ç›´æ¥è¿”å›</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// åœ¨å›è°ƒä¸­å°†æ¶ˆæ¯å†™å…¥MappedFileï¼Œè¿”å›ç»“æœ</span>
            result <span class="token operator">=</span> mappedFile<span class="token punctuation">.</span><span class="token function">appendMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>appendMessageCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å†™å…¥çŠ¶æ€</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æˆåŠŸ</span>
                <span class="token keyword">case</span> PUT_OK<span class="token operator">:</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// æ–‡ä»¶å·²æ»¡ï¼Œå‰©ä½™ç©ºé—´æ”¾ä¸ä¸‹å®Œæ•´çš„æ¶ˆæ¯</span>
                <span class="token keyword">case</span> END_OF_FILE<span class="token operator">:</span>
                    unlockMappedFile <span class="token operator">=</span> mappedFile<span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// æ–°å»ºMappedFileï¼Œç»§ç»­</span>
                    mappedFile <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileQueue<span class="token punctuation">.</span><span class="token function">getLastMappedFile</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// åˆ›å»ºå¤±è´¥</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">==</span> mappedFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ç›´æ¥è¿”å›</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// ç»§ç»­å†™å…¥MappedFile</span>
                    result <span class="token operator">=</span> mappedFile<span class="token punctuation">.</span><span class="token function">appendMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>appendMessageCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> MESSAGE_SIZE_EXCEEDED<span class="token operator">:</span>
                <span class="token keyword">case</span> PROPERTIES_SIZE_EXCEEDED<span class="token operator">:</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token keyword">case</span> UNKNOWN_ERROR<span class="token operator">:</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token keyword">default</span><span class="token operator">:</span>
                    <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// é‡Šæ”¾é”</span>
            putMessageLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å†™æ¶ˆæ¯è€—æ—¶è¿‡é•¿ï¼Œæ‰“å°æ—¥å¿—</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">!=</span> unlockMappedFile <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isWarmMapedFileEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// é‡Šæ”¾MappedFile</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">unlockMappedFile</span><span class="token punctuation">(</span>unlockMappedFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        PutMessageResult putMessageResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PutMessageResult</span><span class="token punctuation">(</span>PutMessageStatus<span class="token punctuation">.</span>PUT_OK<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Statistics</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// å¤„ç†åˆ·ç›˜</span>
        <span class="token function">handleDiskFlush</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> putMessageResult<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¤„ç†é«˜å¯ç”¨ï¼Œå¦‚æœBrokeræ˜¯SYNC_MASTERï¼Œåˆ™ç­‰SLAVEæ¥æ”¶åˆ°æ•°æ®åæ‰è¿”å›ï¼Œå¦‚æœæ˜¯ASYNC_MASTERï¼Œäº¤ç»™HAServiceçº¿ç¨‹æ‰§è¡ŒåŒæ­¥</span>
        <span class="token function">handleHA</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> putMessageResult<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> putMessageResult<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>MappedFileQueue#getLastMappedFile</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> MappedFile <span class="token function">getLastMappedFile</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">long</span> startOffset<span class="token punctuation">,</span> <span class="token keyword">boolean</span> needCreate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> createOffset <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// MappedFileé˜Ÿåˆ—çš„æœ€åä¸€ä¸ªMappedFile</span>
        MappedFile mappedFileLast <span class="token operator">=</span> <span class="token function">getLastMappedFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ä¸€ä¸ªMappedFileä¹Ÿæ²¡æœ‰</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mappedFileLast <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è®¡ç®—æ–°åˆ›å»ºçš„MappedFileçš„èµ·å§‹åç§»</span>
            createOffset <span class="token operator">=</span> startOffset <span class="token operator">-</span> <span class="token punctuation">(</span>startOffset <span class="token operator">%</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// æœ€åä¸€ä¸ªMappedFileå·²å†™æ»¡</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mappedFileLast <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> mappedFileLast<span class="token punctuation">.</span><span class="token function">isFull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è®¡ç®—æ–°åˆ›å»ºçš„MappedFileçš„èµ·å§‹åç§»</span>
            createOffset <span class="token operator">=</span> mappedFileLast<span class="token punctuation">.</span><span class="token function">getFileFromOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileSize<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// åªæœ‰æ–‡ä»¶å†™æ»¡æˆ–æ‰¾ä¸åˆ°æ–‡ä»¶æ—¶ï¼Œæ‰åˆ›å»ºæ–°çš„æ–‡ä»¶</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>createOffset <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> needCreate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ–°å»ºçš„MappedFileæ–‡ä»¶è·¯å¾„åŠæ–‡ä»¶å</span>
            String nextFilePath <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>storePath <span class="token operator">+</span> File<span class="token punctuation">.</span>separator <span class="token operator">+</span> UtilAll<span class="token punctuation">.</span><span class="token function">offset2FileName</span><span class="token punctuation">(</span>createOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ–°å»ºçš„MappedFileçš„ä¸‹ä¸€ä¸ªMappedFileæ–‡ä»¶è·¯å¾„åŠæ–‡ä»¶å</span>
            String nextNextFilePath <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>storePath <span class="token operator">+</span> File<span class="token punctuation">.</span>separator <span class="token operator">+</span> UtilAll<span class="token punctuation">.</span><span class="token function">offset2FileName</span><span class="token punctuation">(</span>createOffset <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
            MappedFile mappedFile <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æœ‰AllocateMappedFileService</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>allocateMappedFileService <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// é€šè¿‡AllocateMappedFileServiceåˆ†é…MappedFileï¼Œå¦‚CommitLog</span>
                mappedFile <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>allocateMappedFileService<span class="token punctuation">.</span><span class="token function">putRequestAndReturnMappedFile</span><span class="token punctuation">(</span>nextFilePath<span class="token punctuation">,</span> nextNextFilePath<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ConsumeQueueåˆ™æ˜¯ç›´æ¥åˆ›å»º</span>
                    mappedFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MappedFile</span><span class="token punctuation">(</span>nextFilePath<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// åˆ›å»ºMappedFileæˆåŠŸ</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mappedFile <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å¦‚æœé˜Ÿåˆ—æ²¡æœ‰åˆ«çš„MappedFile</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mappedFiles<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// é‚£å°±æ˜¯é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªåˆ›å»ºçš„</span>
                    mappedFile<span class="token punctuation">.</span><span class="token function">setFirstCreateInQueue</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// æ·»åŠ åˆ°é˜Ÿåˆ—</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFiles<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>mappedFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> mappedFile<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> mappedFileLast<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>MappedFile#appendMessagesInner</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> AppendMessageResult <span class="token function">appendMessagesInner</span><span class="token punctuation">(</span><span class="token keyword">final</span> MessageExt messageExt<span class="token punctuation">,</span> <span class="token keyword">final</span> AppendMessageCallback cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">assert</span> messageExt <span class="token operator">!=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">assert</span> cb <span class="token operator">!=</span> null<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å½“å‰MappedFileçš„å†™ä½ç½®</span>
        <span class="token keyword">int</span> currentPos <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>wrotePosition<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å†™æŒ‡é’ˆä½ç½®å°äºæ–‡ä»¶å¤§å°æ‰æœ‰ç©ºé—´ç»§ç»­å†™</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentPos <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fileSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å­ç¼“å†²ï¼Œç´¢å¼•ç‹¬ç«‹</span>
            <span class="token comment" spellcheck="true">// è¿™é‡Œæœ‰ä¸¤ä¸ªç¼“å†²ï¼Œå…¶ä¸­WriteBufferæ˜¯ä»å †å¤–å†…å­˜æ± TransientStorePoolä¸­è·å–çš„</span>
            <span class="token comment" spellcheck="true">// åªæœ‰åœ¨å¼€å¯äº†TransientStorePoolEnableï¼Œå¹¶ä¸”æ˜¯å¼‚æ­¥åˆ·ç›˜çš„Masteræ‰ä½¿ç”¨ï¼Œé»˜è®¤ä¸ä½¿ç”¨</span>
            ByteBuffer byteBuffer <span class="token operator">=</span> writeBuffer <span class="token operator">!=</span> null <span class="token operator">?</span> writeBuffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedByteBuffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è®¾ç½®å†™ç´¢å¼•</span>
            byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span>currentPos<span class="token punctuation">)</span><span class="token punctuation">;</span>
            AppendMessageResult result<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>messageExt <span class="token keyword">instanceof</span> <span class="token class-name">MessageExtBrokerInner</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æ·»åŠ </span>
                result <span class="token operator">=</span> cb<span class="token punctuation">.</span><span class="token function">doAppend</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getFileFromOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> byteBuffer<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fileSize <span class="token operator">-</span> currentPos<span class="token punctuation">,</span> <span class="token punctuation">(</span>MessageExtBrokerInner<span class="token punctuation">)</span> messageExt<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>messageExt <span class="token keyword">instanceof</span> <span class="token class-name">MessageExtBatch</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æ‰¹é‡æ·»åŠ </span>
                result <span class="token operator">=</span> cb<span class="token punctuation">.</span><span class="token function">doAppend</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getFileFromOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> byteBuffer<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fileSize <span class="token operator">-</span> currentPos<span class="token punctuation">,</span> <span class="token punctuation">(</span>MessageExtBatch<span class="token punctuation">)</span> messageExt<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AppendMessageResult</span><span class="token punctuation">(</span>AppendMessageStatus<span class="token punctuation">.</span>UNKNOWN_ERROR<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// æ›´æ–°å†™ä½ç½®</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>wrotePosition<span class="token punctuation">.</span><span class="token function">addAndGet</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getWroteBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>storeTimestamp <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getStoreTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AppendMessageResult</span><span class="token punctuation">(</span>AppendMessageStatus<span class="token punctuation">.</span>UNKNOWN_ERROR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>CommitLog#doAppend</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">public</span> AppendMessageResult <span class="token function">doAppend</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">long</span> fileFromOffset<span class="token punctuation">,</span> <span class="token keyword">final</span> ByteBuffer byteBuffer<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> maxBlank<span class="token punctuation">,</span> <span class="token keyword">final</span> MessageExtBrokerInner msgInner<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å¾…å†™å…¥çš„æ¶ˆæ¯åœ¨CommitLogçš„å…¨å±€åç§» = æ–‡ä»¶çš„èµ·å§‹åç§» + MappedFileçš„ç¼“å†²çš„å†™ç´¢å¼•</span>
            <span class="token keyword">long</span> wroteOffset <span class="token operator">=</span> fileFromOffset <span class="token operator">+</span> byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// é‡ç½®HostHolderè¿™å—ç¼“å†²</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resetByteBuffer</span><span class="token punctuation">(</span>hostHolder<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ç”ŸæˆMessageIdï¼Œ16å­—èŠ‚ï¼Œå†™å…¥MessageIdçš„ç¼“å†²ï¼Œå‰8ä½æ˜¯Hoståœ°å€ï¼ŒåŒ…æ‹¬IPå’ŒPortï¼Œå8ä½æ˜¯æ¶ˆæ¯åœ¨CommitLogçš„åç§»</span>
            <span class="token comment" spellcheck="true">// å¯ä»¥æ ¹æ®MessageIdçŸ¥é“æ¶ˆæ¯å­˜åœ¨å“ªä¸ªBrokerçš„CommitLogä½ç½®</span>
            String msgId <span class="token operator">=</span> MessageDecoder<span class="token punctuation">.</span><span class="token function">createMessageId</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>msgIdMemory<span class="token punctuation">,</span> msgInner<span class="token punctuation">.</span><span class="token function">getStoreHostBytes</span><span class="token punctuation">(</span>hostHolder<span class="token punctuation">)</span><span class="token punctuation">,</span> wroteOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// Record ConsumeQueue information</span>
            keyBuilder<span class="token punctuation">.</span><span class="token function">setLength</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            keyBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            keyBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            keyBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            String key <span class="token operator">=</span> keyBuilder<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ ¹æ®Topicå’ŒQueueIdè·å–ConsumeQueueçš„é˜Ÿåˆ—åç§»ï¼Œå°±æ˜¯é˜Ÿåˆ—çš„æ¶ˆæ¯æ•°é‡</span>
            Long queueOffset <span class="token operator">=</span> CommitLog<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>topicQueueTable<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">==</span> queueOffset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Queueçš„ç¬¬ä¸€æ¡æ¶ˆæ¯</span>
                queueOffset <span class="token operator">=</span> 0L<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// åˆå§‹åŒ–</span>
                CommitLog<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>topicQueueTable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> queueOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// äº‹åŠ¡ç±»å‹</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> tranType <span class="token operator">=</span> MessageSysFlag<span class="token punctuation">.</span><span class="token function">getTransactionValue</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getSysFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>tranType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Preparedå’ŒRollbackç±»å‹çš„äº‹åŠ¡æ¶ˆæ¯ä¸è¿›å…¥é˜Ÿåˆ—</span>
                <span class="token keyword">case</span> MessageSysFlag<span class="token punctuation">.</span>TRANSACTION_PREPARED_TYPE<span class="token operator">:</span>
                <span class="token keyword">case</span> MessageSysFlag<span class="token punctuation">.</span>TRANSACTION_ROLLBACK_TYPE<span class="token operator">:</span>
                    queueOffset <span class="token operator">=</span> 0L<span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> MessageSysFlag<span class="token punctuation">.</span>TRANSACTION_NOT_TYPE<span class="token operator">:</span>
                <span class="token keyword">case</span> MessageSysFlag<span class="token punctuation">.</span>TRANSACTION_COMMIT_TYPE<span class="token operator">:</span>
                <span class="token keyword">default</span><span class="token operator">:</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">// Propertiesåºåˆ—åŒ–</span>
            <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> propertiesData <span class="token operator">=</span> msgInner<span class="token punctuation">.</span><span class="token function">getPropertiesString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null <span class="token operator">?</span> null <span class="token operator">:</span> msgInner<span class="token punctuation">.</span><span class="token function">getPropertiesString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span>MessageDecoder<span class="token punctuation">.</span>CHARSET_UTF8<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> propertiesLength <span class="token operator">=</span> propertiesData <span class="token operator">==</span> null <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> propertiesData<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// Propertiesé•¿åº¦ä¸èƒ½è¶…è¿‡Short.MAX_VALUE</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>propertiesLength <span class="token operator">></span> Short<span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ç›´æ¥è¿”å›</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// Topicåºåˆ—åŒ–</span>
            <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> topicData <span class="token operator">=</span> msgInner<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span>MessageDecoder<span class="token punctuation">.</span>CHARSET_UTF8<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> topicLength <span class="token operator">=</span> topicData<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> bodyLength <span class="token operator">=</span> msgInner<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> msgInner<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è®¡ç®—æ¶ˆæ¯å®é™…é•¿åº¦</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> msgLen <span class="token operator">=</span> <span class="token function">calMsgLength</span><span class="token punctuation">(</span>bodyLength<span class="token punctuation">,</span> topicLength<span class="token punctuation">,</span> propertiesLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ¶ˆæ¯é•¿åº¦è¿‡é•¿</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>msgLen <span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>maxMessageSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ç›´æ¥è¿”å›</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// æ¶ˆæ¯é•¿åº¦ + æ–‡ä»¶ç»“å°¾æœ€å°ç©ºç™½é•¿åº¦ > æ–‡ä»¶å‰©ä½™å¯å†™é•¿åº¦</span>
            <span class="token comment" spellcheck="true">// è¯´æ˜ç©ºé—´ä¸è¶³ä»¥å†™ä¸‹æ­¤æ¡æ¶ˆæ¯</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>msgLen <span class="token operator">+</span> END_FILE_MIN_BLANK_LENGTH<span class="token punctuation">)</span> <span class="token operator">></span> maxBlank<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resetByteBuffer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">,</span> maxBlank<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ç©ºç™½å¡«å……çš„é•¿åº¦ï¼Œ4å­—èŠ‚</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>maxBlank<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ç©ºç™½çš„é­”æ•°ï¼Œ4å­—èŠ‚</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>CommitLog<span class="token punctuation">.</span>BLANK_MAGIC_CODE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token keyword">long</span> beginTimeMills <span class="token operator">=</span> CommitLog<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å¡«å……</span>
                byteBuffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> maxBlank<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AppendMessageResult</span><span class="token punctuation">(</span>AppendMessageStatus<span class="token punctuation">.</span>END_OF_FILE<span class="token punctuation">,</span> wroteOffset<span class="token punctuation">,</span> maxBlank<span class="token punctuation">,</span> msgId<span class="token punctuation">,</span> msgInner<span class="token punctuation">.</span><span class="token function">getStoreTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> queueOffset<span class="token punctuation">,</span> CommitLog<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> beginTimeMills<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// Initialization of storage space</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resetByteBuffer</span><span class="token punctuation">(</span>msgStoreItemMemory<span class="token punctuation">,</span> msgLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ¶ˆæ¯æ€»é•¿åº¦ï¼Œ4å­—èŠ‚</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>msgLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ¶ˆæ¯çš„é­”æ•°ï¼Œ4å­—èŠ‚</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>CommitLog<span class="token punctuation">.</span>MESSAGE_MAGIC_CODE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ¶ˆæ¯ä½“CRCæ ¡éªŒï¼Œ4å­—èŠ‚</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getBodyCRC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ¶ˆæ¯æ‰€åœ¨é˜Ÿåˆ—çš„Idï¼Œ4å­—èŠ‚</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ ‡è®°ï¼Œ4å­—èŠ‚</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ¶ˆæ¯åœ¨é˜Ÿåˆ—çš„ä½ç½®åç§»ï¼Œ8å­—èŠ‚</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">putLong</span><span class="token punctuation">(</span>queueOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ¶ˆæ¯åœ¨CommitLogçš„ç‰©ç†åç§»ï¼Œ8å­—èŠ‚</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">putLong</span><span class="token punctuation">(</span>fileFromOffset <span class="token operator">+</span> byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ç³»ç»Ÿæ ‡è®°ï¼Œ4å­—èŠ‚</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getSysFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å‡ºç”Ÿæ—¶é—´æˆ³ï¼Œ8å­—èŠ‚</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">putLong</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getBornTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resetByteBuffer</span><span class="token punctuation">(</span>hostHolder<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ç”Ÿäº§çš„Brokeråœ°å€ï¼ŒåŒ…æ‹¬IPå’Œç«¯å£ï¼Œ8å­—èŠ‚</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getBornHostBytes</span><span class="token punctuation">(</span>hostHolder<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å­˜å‚¨æ—¶é—´æˆ³ï¼Œ8å­—èŠ‚</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">putLong</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getStoreTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resetByteBuffer</span><span class="token punctuation">(</span>hostHolder<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å­˜å‚¨çš„Brokeråœ°å€ï¼ŒåŒ…æ‹¬IPå’Œç«¯å£ï¼Œ8å­—èŠ‚</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getStoreHostBytes</span><span class="token punctuation">(</span>hostHolder<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//this.msgBatchMemory.put(msgInner.getStoreHostBytes());</span>
            <span class="token comment" spellcheck="true">// æ¶ˆè´¹é‡è¯•æ¬¡æ•°ï¼Œ4å­—èŠ‚</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getReconsumeTimes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 14 Prepared Transaction Offset</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">putLong</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getPreparedTransactionOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ¶ˆæ¯ä½“é•¿åº¦ï¼Œ4å­—èŠ‚</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>bodyLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>bodyLength <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// æ¶ˆæ¯ä½“</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// Topicé•¿åº¦ï¼Œ1å­—èŠ‚</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> topicLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// Topic</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>topicData<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å±æ€§é•¿åº¦ï¼Œ2å­—èŠ‚</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">putShort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span> propertiesLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>propertiesLength <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// å±æ€§</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>propertiesData<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> beginTimeMills <span class="token operator">=</span> CommitLog<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// Write messages to the queue buffer</span>
            byteBuffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> msgLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//</span>
            AppendMessageResult result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AppendMessageResult</span><span class="token punctuation">(</span>AppendMessageStatus<span class="token punctuation">.</span>PUT_OK<span class="token punctuation">,</span> wroteOffset<span class="token punctuation">,</span> msgLen<span class="token punctuation">,</span> msgId<span class="token punctuation">,</span> msgInner<span class="token punctuation">.</span><span class="token function">getStoreTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> queueOffset<span class="token punctuation">,</span> CommitLog<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> beginTimeMills<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>tranType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å¿½ç•¥Preparedå’ŒRollbackç±»å‹çš„äº‹åŠ¡æ¶ˆæ¯</span>
                <span class="token keyword">case</span> MessageSysFlag<span class="token punctuation">.</span>TRANSACTION_PREPARED_TYPE<span class="token operator">:</span>
                <span class="token keyword">case</span> MessageSysFlag<span class="token punctuation">.</span>TRANSACTION_ROLLBACK_TYPE<span class="token operator">:</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// éäº‹åŠ¡æ¶ˆæ¯å’ŒCommitç±»å‹çš„äº‹åŠ¡æ¶ˆæ¯éœ€è¦æ›´æ–°é˜Ÿåˆ—çš„åç§»</span>
                <span class="token keyword">case</span> MessageSysFlag<span class="token punctuation">.</span>TRANSACTION_NOT_TYPE<span class="token operator">:</span>
                <span class="token keyword">case</span> MessageSysFlag<span class="token punctuation">.</span>TRANSACTION_COMMIT_TYPE<span class="token operator">:</span>
                    <span class="token comment" spellcheck="true">// The next update ConsumeQueue information</span>
                    CommitLog<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>topicQueueTable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token operator">++</span>queueOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">default</span><span class="token operator">:</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>CommitLog#handleDiskFlush</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleDiskFlush</span><span class="token punctuation">(</span>AppendMessageResult result<span class="token punctuation">,</span> PutMessageResult putMessageResult<span class="token punctuation">,</span> MessageExt messageExt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// åŒæ­¥åˆ·ç›˜</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>FlushDiskType<span class="token punctuation">.</span>SYNC_FLUSH <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFlushDiskType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> GroupCommitService service <span class="token operator">=</span> <span class="token punctuation">(</span>GroupCommitService<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>flushCommitLogService<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å¦‚æœè¦ç­‰å¾…å­˜å‚¨ç»“æœæ˜¯å¦OK</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>messageExt<span class="token punctuation">.</span><span class="token function">isWaitStoreMsgOK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// åˆ›å»ºæäº¤è¯·æ±‚</span>
                GroupCommitRequest request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GroupCommitRequest</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getWroteOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> result<span class="token punctuation">.</span><span class="token function">getWroteBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// åŠ å…¥GroupCommitServiceçš„é˜Ÿåˆ—</span>
                service<span class="token punctuation">.</span><span class="token function">putRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// é˜»å¡ç­‰åˆ·ç›˜å®Œæˆæˆ–è¶…æ—¶</span>
                <span class="token keyword">boolean</span> flushOK <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">waitForFlush</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSyncFlushTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>flushOK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å”¤é†’GroupCommitServiceåŒæ­¥åˆ·ç›˜çº¿ç¨‹ï¼Œè¿™é‡Œçº¿ç¨‹ç›´æ¥è¿”å›</span>
                service<span class="token punctuation">.</span><span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å¼‚æ­¥åˆ·ç›˜</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// é»˜è®¤æƒ…å†µï¼Œä¸å¯ç”¨ç¼“å†²æ± </span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isTransientStorePoolEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å”¤é†’FlushCommitLogServiceï¼Œç”±FlushCommitLogServiceåˆ·ç›˜</span>
                flushCommitLogService<span class="token punctuation">.</span><span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å”¤é†’CommitRealTimeServiceï¼Œç”±CommitRealTimeServiceåˆ·ç›˜</span>
                commitLogService<span class="token punctuation">.</span><span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>åŒæ­¥åˆ·ç›˜</p>
<p>CommitLog$GroupCommitService#putRequest</p>
<pre class=" language-java"><code class="language-java">        <span class="token comment" spellcheck="true">/**
         * è¯·æ±‚å…ˆæäº¤åˆ°å†™é˜Ÿåˆ—ï¼Œæ¯æ¬¡å¤„ç†å‰ï¼Œå…ˆäº¤æ¢è¯»å†™é˜Ÿåˆ—ï¼Œç„¶åä»è¯»é˜Ÿåˆ—è·å–è¯·æ±‚ï¼Œæäº¤åå†æ¸…ç©ºè¯»é˜Ÿåˆ—ï¼Œé¿å…å¤šçº¿ç¨‹æ“ä½œé—®é¢˜
         */</span>
        <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">putRequest</span><span class="token punctuation">(</span><span class="token keyword">final</span> GroupCommitRequest request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è·å–å†™é˜Ÿåˆ—çš„åŒæ­¥é”ï¼Œå› ä¸ºswapRequestsæ–¹æ³•ä¼šäº¤æ¢å†™é˜Ÿåˆ—å’Œè¯»é˜Ÿåˆ—</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>requestsWrite<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æ·»åŠ åˆ°å†™é˜Ÿåˆ—</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>requestsWrite<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// æ–°è¯·æ±‚åŠ å…¥æ—¶ï¼Œæ²¡å”¤é†’å°±å”¤é†’GroupCommitServiceçº¿ç¨‹</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>hasNotified<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                waitPoint<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// notify</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span></code></pre>
<p>CommitLog$GroupCommitService#run</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å¦‚æœå”¤é†’æ ‡å¿—ä¸ºå·²å”¤é†’ï¼ˆæœ‰è¯·æ±‚åŠ å…¥ï¼‰ï¼Œé‡ç½®æ ‡è®°ä¸ºæœªå”¤é†’ï¼Œå¹¶äº¤æ¢è¯»å†™é˜Ÿåˆ—</span>
                    <span class="token comment" spellcheck="true">// å¦‚æœå”¤é†’æ ‡è®°ä¸ºæœªå”¤é†’ï¼Œåˆ™é˜»å¡è¶…æ—¶ç­‰å¾…å”¤é†’ï¼Œæœ€åé‡ç½®æ ‡è®°ä¸ºæœªå”¤é†’ï¼Œå¹¶äº¤æ¢è¯»å†™é˜Ÿåˆ—</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">waitForRunning</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// æ‰§è¡Œæäº¤</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doCommit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// æ™®é€šå…³é—­ï¼Œç­‰å¾…è¯·æ±‚åˆ°è¾¾ï¼Œç„¶ååˆ·ç›˜</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// äº¤æ¢è¯»å†™é˜Ÿåˆ—</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">swapRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// æœ€åæ‰§è¡Œä¸€æ¬¡åˆ·ç›˜</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doCommit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span></code></pre>
<p>CommitLog$GroupCommitService#swapRequests</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">swapRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            List<span class="token operator">&lt;</span>GroupCommitRequest<span class="token operator">></span> tmp <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>requestsWrite<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>requestsWrite <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>requestsRead<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>requestsRead <span class="token operator">=</span> tmp<span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>CommitLog$GroupCommitService#doCommit</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doCommit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è·å–è¯»é˜Ÿåˆ—çš„åŒæ­¥é”</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>requestsRead<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>requestsRead<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// éå†åŒæ­¥åˆ·ç›˜è¯·æ±‚</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span>GroupCommitRequest req <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>requestsRead<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">boolean</span> flushOK <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// è²Œä¼¼æ˜¯æ‰§è¡Œä¸¤æ¬¡ï¼Œè€Œä¸æ˜¯é‡è¯•ä¸¤æ¬¡ï¼Ÿ</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>flushOK<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// å·²åˆ·ç›˜ä½ç½® >= è¯·æ±‚åˆ·ç›˜çš„ç»“æŸä½ç½®</span>
                            <span class="token comment" spellcheck="true">// è¯´æ˜åˆ·ç›˜æˆåŠŸ</span>
                            flushOK <span class="token operator">=</span> CommitLog<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileQueue<span class="token punctuation">.</span><span class="token function">getFlushedWhere</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> req<span class="token punctuation">.</span><span class="token function">getNextOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>flushOK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token comment" spellcheck="true">// æ‰§è¡Œåˆ·ç›˜</span>
                                CommitLog<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileQueue<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment" spellcheck="true">// å”¤é†’æäº¤åŒæ­¥åˆ·ç›˜è¯·æ±‚çš„Brokerçº¿ç¨‹ï¼Œæ˜¯å¦åˆ·ç›˜æˆåŠŸ</span>
                        req<span class="token punctuation">.</span><span class="token function">wakeupCustomer</span><span class="token punctuation">(</span>flushOK<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">long</span> storeTimestamp <span class="token operator">=</span> CommitLog<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileQueue<span class="token punctuation">.</span><span class="token function">getStoreTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>storeTimestamp <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// æ›´æ–°åˆ·ç›˜çš„Checkpointæ—¶é—´æˆ³</span>
                        CommitLog<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getStoreCheckpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPhysicMsgTimestamp</span><span class="token punctuation">(</span>storeTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// å¤„ç†å®Œå°±æ¸…ç©ºè¯»é˜Ÿåˆ—</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>requestsRead<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// è¯»é˜Ÿåˆ—ä¸ºç©º</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å¯èƒ½æ²¡æœ‰åŒæ­¥åˆ·ç›˜æ¶ˆæ¯æäº¤ï¼ŒGroupCommitServiceçº¿ç¨‹è¶…æ—¶å”¤é†’èµ°åˆ°è¿™é‡Œï¼Œé‚£å°±å¼ºåˆ¶åˆ·ç›˜ä¸€æ¬¡</span>
                    CommitLog<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileQueue<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span></code></pre>
<p>ä¸‹é¢çš„ä»£ç å¯èƒ½æˆ‘ç†è§£æœ‰é—®é¢˜ï¼Œæ€»è§‰å¾—è¿™æ ·ä¸å¤ªå¥½ï¼Ÿ</p>
<p>MappedFileQueue#flush</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">flush</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span> flushLeastPages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ ¹æ®ä¸Šæ¬¡åˆ·ç›˜ä½ç½®è·å–MappedFile</span>
        MappedFile mappedFile <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">findMappedFileByOffset</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>flushedWhere<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>flushedWhere <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mappedFile <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">long</span> tmpTimeStamp <span class="token operator">=</span> mappedFile<span class="token punctuation">.</span><span class="token function">getStoreTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// åˆ·ç›˜å¹¶è¿”å›MappedFileçš„åˆ·ç›˜ä½ç½®</span>
            <span class="token keyword">int</span> offset <span class="token operator">=</span> mappedFile<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span>flushLeastPages<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// åˆ·ç›˜ä½ç½®åœ¨CommitLogï¼Œæˆ–è€…ConsumeQueueçš„åç§» = MappedFileçš„èµ·å§‹åç§» + MappedFileçš„åˆ·ç›˜åç§»</span>
            <span class="token keyword">long</span> where <span class="token operator">=</span> mappedFile<span class="token punctuation">.</span><span class="token function">getFileFromOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> offset<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æœ¬æ¬¡åˆ·ç›˜çš„ä½ç½®ç­‰äºä¸Šæ¬¡åˆ·ç›˜çš„ä½ç½®ï¼Œè¯´æ˜åˆ·ç›˜ä¸¤æ¬¡ï¼ŒæˆåŠŸï¼Ÿ</span>
            <span class="token comment" spellcheck="true">// ä¹Ÿå°±æ˜¯è¯´ï¼Œç¬¬ä¸€æ¬¡åˆ·ç›˜æ˜¯æ‰§è¡Œåˆ·ç›˜ï¼Œç¬¬äºŒæ¬¡åªæ˜¯éªŒè¯ï¼Ÿå¯èƒ½æˆ‘æ²¡ç†è§£è¿™æ®µä»£ç </span>
            result <span class="token operator">=</span> where <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>flushedWhere<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ›´æ–°åˆ·ç›˜ä½ç½®ï¼Œè¿™ä¸ªä½ç½®æ˜¯ç›¸å¯¹äºæ•´ä¸ªæ–‡ä»¶é˜Ÿåˆ—çš„</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>flushedWhere <span class="token operator">=</span> where<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è¯´æ˜æ˜¯å¼ºåˆ¶åˆ·ç›˜</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> flushLeastPages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>storeTimestamp <span class="token operator">=</span> tmpTimeStamp<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>MappedFileQueue#findMappedFileByOffset</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> MappedFile <span class="token function">findMappedFileByOffset</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">long</span> offset<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> returnFirstOnNotFound<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è·å–ç¬¬ä¸€ä¸ªMappedFile</span>
            MappedFile firstMappedFile <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getFirstMappedFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è·å–æœ€åä¸€ä¸ªMappedFile</span>
            MappedFile lastMappedFile <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getLastMappedFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>firstMappedFile <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> lastMappedFile <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ä¸Šæ¬¡åˆ·ç›˜çš„åç§» &lt; ç¬¬ä¸€ä¸ªMappedFileçš„èµ·å§‹åç§» || ä¸Šæ¬¡åˆ·ç›˜çš„åç§» >= æœ€åä¸€ä¸ªMappedFileçš„èµ·å§‹åç§» + MappedFileå¤§å°</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>offset <span class="token operator">&lt;</span> firstMappedFile<span class="token punctuation">.</span><span class="token function">getFileFromOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> offset <span class="token operator">>=</span> lastMappedFile<span class="token punctuation">.</span><span class="token function">getFileFromOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// æ­£å¸¸æƒ…å†µ</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å¯¹åº”çš„MappedFileåœ¨é˜Ÿåˆ—çš„ä½ç½® = åç§»å¯¹åº”çš„MappedFileä½ç½® - é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªMappedFileä½ç½®</span>
                    <span class="token comment" spellcheck="true">// å› ä¸ºè¿‡æœŸæ–‡ä»¶å¯èƒ½ä¼šè¢«åˆ é™¤</span>
                    <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>offset <span class="token operator">/</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileSize<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>firstMappedFile<span class="token punctuation">.</span><span class="token function">getFileFromOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    MappedFile targetFile <span class="token operator">=</span> null<span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// è·å–å¯¹åº”ä½ç½®çš„MappedFile</span>
                        targetFile <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFiles<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// å†æ£€æŸ¥ä¸€æ¬¡</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>targetFile <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> offset <span class="token operator">>=</span> targetFile<span class="token punctuation">.</span><span class="token function">getFileFromOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> offset <span class="token operator">&lt;</span> targetFile<span class="token punctuation">.</span><span class="token function">getFileFromOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> targetFile<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// å¦‚æœæ²¡æ‰¾åˆ°åˆé€‚çš„ï¼Œé‚£å°±éå†æ‰€æœ‰çš„MappedFile</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span>MappedFile tmpMappedFile <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFiles<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// æŸ¥æ‰¾åŒ¹é…çš„MappedFileè¿”å›</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>offset <span class="token operator">>=</span> tmpMappedFile<span class="token punctuation">.</span><span class="token function">getFileFromOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> offset <span class="token operator">&lt;</span> tmpMappedFile<span class="token punctuation">.</span><span class="token function">getFileFromOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">return</span> tmpMappedFile<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// æœ€åè¿˜æ²¡æ‰¾åˆ°ï¼Œå¦‚æœè®¾ç½®è¿”å›ç¬¬ä¸€ä¸ªMappedFile</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>returnFirstOnNotFound<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// é‚£å°±è¿”å›ç¬¬ä¸€ä¸ª</span>
                    <span class="token keyword">return</span> firstMappedFile<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>MappedFile#flush</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">flush</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span> flushLeastPages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// å‡‘å¤Ÿé¡µæ•°ï¼Œå¯ä»¥åˆ·ç›˜</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isAbleToFlush</span><span class="token punctuation">(</span>flushLeastPages<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è·å–MappedFileå¼•ç”¨è®¡æ•°</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hold</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// è¿™ä¸ªæ˜¯æ•°æ®å†™å…¥ç¼“å†²çš„ç»“æŸä½ç½®ï¼Œå³æœŸå¾…åˆ·ç›˜ç»“æŸçš„ä½ç½®ï¼Œåå­—å¾ˆè¯¯å¯¼</span>
                <span class="token keyword">int</span> value <span class="token operator">=</span> <span class="token function">getReadPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// é€šè¿‡FileChannelæˆ–MappedByteBufferï¼ŒæŠŠç¼“å†²åˆ·åˆ°ç£ç›˜ï¼Œæ ¹æ®TransientStorePoolEnableï¼Œåˆ·ç›˜æ–¹å¼å’ŒBrokerè§’è‰²å†³å®š</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>writeBuffer <span class="token operator">!=</span> null <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fileChannel<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>fileChannel<span class="token punctuation">.</span><span class="token function">force</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>mappedByteBuffer<span class="token punctuation">.</span><span class="token function">force</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// è®¾ç½®FlushedPositionï¼Œä¸Šé¢æŠŠå¼‚å¸¸æ•æ‰äº†ï¼Œæ€ä¹ˆç¡®ä¿ä¸€å®šåˆ·ç›˜æˆåŠŸäº†å‘¢ï¼Ÿ</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>flushedPosition<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// é‡Šæ”¾è®¡æ•°</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>flushedPosition<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token function">getReadPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// è¿”å›FlushedPosition</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getFlushedPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>MappedFile#isAbleToFlush</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isAbleToFlush</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span> flushLeastPages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ä¸Šæ¬¡MappedFileåˆ·ç›˜ä½ç½®</span>
        <span class="token keyword">int</span> flush <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>flushedPosition<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// MappedFileç¼“å†²çš„å†™æŒ‡é’ˆä½ç½®</span>
        <span class="token keyword">int</span> write <span class="token operator">=</span> <span class="token function">getReadPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ç¼“å†²çš„å†™æŒ‡é’ˆä½ç½®ç­‰äºæ–‡ä»¶å¤§å°ï¼Œè¯´æ˜MappedFileå·²å†™æ»¡</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isFull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å¯ä»¥åˆ·ç›˜</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// æŒ‡å®šäº†åˆ·ç›˜é¡µæ•°</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>flushLeastPages <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å¯æäº¤çš„é¡µæ•°å¤§äºæœ€å°é¡µæ•°æ‰æäº¤</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>write <span class="token operator">/</span> OS_PAGE_SIZE<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>flush <span class="token operator">/</span> OS_PAGE_SIZE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>=</span> flushLeastPages<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// æœ‰æ–°æ•°æ®æœªåˆ·ç›˜å°±å¯ä»¥åˆ·ç›˜</span>
        <span class="token keyword">return</span> write <span class="token operator">></span> flush<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>å¼‚æ­¥åˆ·ç›˜ï¼Œä¸ä½¿ç”¨ç¼“å†²æ± ã€‚</p>
<p>CommitLog$FlushCommitLogService#run</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æ˜¯å®šæ—¶è®¡åˆ’åˆ·ç›˜è¿˜æ˜¯ç­‰å¾…å”¤é†’åˆ·ç›˜ï¼Œé»˜è®¤æ˜¯ç­‰å¾…å”¤é†’ï¼Œæ¯”è¾ƒå®æ—¶</span>
                <span class="token keyword">boolean</span> flushCommitLogTimed <span class="token operator">=</span> CommitLog<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isFlushCommitLogTimed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å®šæ—¶åˆ·ç›˜é—´éš”ï¼Œé»˜è®¤500æ¯«ç§’</span>
                <span class="token keyword">int</span> interval <span class="token operator">=</span> CommitLog<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFlushIntervalCommitLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// CommitLogåˆ·ç›˜éœ€è¦è¾¾åˆ°çš„æœ€å°é¡µæ•°ï¼Œé»˜è®¤4</span>
                <span class="token keyword">int</span> flushPhysicQueueLeastPages <span class="token operator">=</span> CommitLog<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFlushCommitLogLeastPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// é»˜è®¤10ç§’</span>
                <span class="token keyword">int</span> flushPhysicQueueThoroughInterval <span class="token operator">=</span> CommitLog<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFlushCommitLogThoroughInterval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ä¸æ‰“å°åˆ·ç›˜è¿›ç¨‹</span>
                <span class="token keyword">boolean</span> printFlushProgress <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// Print flush progress</span>
                <span class="token keyword">long</span> currentTimeMillis <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ä¸Šæ¬¡åˆ·ç›˜ç¦»ç°åœ¨å·²ç»è¶…å‡ºåˆ·ç›˜é—´éš”</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>currentTimeMillis <span class="token operator">>=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>lastFlushTimestamp <span class="token operator">+</span> flushPhysicQueueThoroughInterval<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>lastFlushTimestamp <span class="token operator">=</span> currentTimeMillis<span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// æ ‡å¿—ç«‹å³æ‰§è¡Œåˆ·ç›˜</span>
                    flushPhysicQueueLeastPages <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// æ‰§è¡Œåæ¬¡æ‰“å°ä¸€æ¬¡åˆ·ç›˜è¿›ç¨‹</span>
                    printFlushProgress <span class="token operator">=</span> <span class="token punctuation">(</span>printTimes<span class="token operator">++</span> <span class="token operator">%</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å®šæ—¶åˆ·ç›˜</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>flushCommitLogTimed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>interval<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// é»˜è®¤æ˜¯ç­‰å¾…å”¤é†’çš„æ–¹å¼</span>
                    <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">waitForRunning</span><span class="token punctuation">(</span>interval<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// æ˜¯å¦æ‰“å°åˆ·ç›˜è¿›ç¨‹</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>printFlushProgress<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">printFlushProgress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">long</span> begin <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// æ‰§è¡Œåˆ·ç›˜</span>
                    CommitLog<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileQueue<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span>flushPhysicQueueLeastPages<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">long</span> storeTimestamp <span class="token operator">=</span> CommitLog<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileQueue<span class="token punctuation">.</span><span class="token function">getStoreTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>storeTimestamp <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// è®¾ç½®åˆ·ç›˜æ£€æŸ¥ç‚¹</span>
                        CommitLog<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getStoreCheckpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPhysicMsgTimestamp</span><span class="token punctuation">(</span>storeTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">long</span> past <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> begin<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>past <span class="token operator">></span> <span class="token number">500</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// æ‰“å°åˆ·ç›˜è¿›ç¨‹</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// æ­£å¸¸å…³é—­ï¼Œè¦ä¿è¯é€€å‡ºå‰å®Œæˆåˆ·ç›˜</span>
            <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// é»˜è®¤æœ€å¤šé‡è¯•10æ¬¡</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> RETRY_TIMES_OVER <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>result<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// åˆ·ç›˜</span>
                result <span class="token operator">=</span> CommitLog<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileQueue<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// æ‰“å°åˆ·ç›˜è¿›ç¨‹</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">printFlushProgress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span></code></pre>
<hr>
<p>å¼‚æ­¥åˆ·ç›˜ï¼Œä½¿ç”¨ç¼“å†²æ± ã€‚</p>
<p>CommitLog$CommitRealTimeService#run</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// åˆ·ç›˜é—´éš”ï¼Œé»˜è®¤200æ¯«ç§’</span>
                <span class="token keyword">int</span> interval <span class="token operator">=</span> CommitLog<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCommitIntervalCommitLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// CommitLogåˆ·ç›˜éœ€è¦è¾¾åˆ°çš„æœ€å°é¡µæ•°ï¼Œé»˜è®¤4</span>
                <span class="token keyword">int</span> commitDataLeastPages <span class="token operator">=</span> CommitLog<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCommitCommitLogLeastPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// é»˜è®¤200æ¯«ç§’</span>
                <span class="token keyword">int</span> commitDataThoroughInterval <span class="token operator">=</span> CommitLog<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCommitCommitLogThoroughInterval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">long</span> begin <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ä¸Šæ¬¡åˆ·ç›˜ç¦»ç°åœ¨å·²ç»è¶…å‡ºåˆ·ç›˜é—´éš”</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>begin <span class="token operator">>=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>lastCommitTimestamp <span class="token operator">+</span> commitDataThoroughInterval<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>lastCommitTimestamp <span class="token operator">=</span> begin<span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// æ ‡è®°ç«‹å³åˆ·ç›˜</span>
                    commitDataLeastPages <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// æäº¤ç¼“å†²çš„æ•°æ®åˆ°FileChannel</span>
                    <span class="token keyword">boolean</span> result <span class="token operator">=</span> CommitLog<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileQueue<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span>commitDataLeastPages<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">long</span> end <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// è¯´æ˜æœ‰æ–°çš„æ•°æ®æäº¤åˆ°FileChannelï¼Œéœ€è¦åˆ·ç›˜</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>lastCommitTimestamp <span class="token operator">=</span> end<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// result = false means some data committed.</span>
                        <span class="token comment" spellcheck="true">// å”¤é†’åˆ·ç›˜çº¿ç¨‹</span>
                        flushCommitLogService<span class="token punctuation">.</span><span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token comment" spellcheck="true">// ç­‰å¾…å”¤é†’æˆ–è¶…æ—¶</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">waitForRunning</span><span class="token punctuation">(</span>interval<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// é€€å‡ºå‰å…ˆæŠŠç¼“å†²æäº¤åˆ°FileChannelï¼Œæœ€å¤šé‡è¯•10æ¬¡</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> RETRY_TIMES_OVER <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>result<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                result <span class="token operator">=</span> CommitLog<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileQueue<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span></code></pre>
<p>MappedFileQueue#commit</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">commit</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span> commitLeastPages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è·å–å¯¹åº”çš„MappedFile</span>
        MappedFile mappedFile <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">findMappedFileByOffset</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>committedWhere<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>committedWhere <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mappedFile <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è¿”å›æäº¤åˆ°FileChannelçš„ä½ç½®</span>
            <span class="token keyword">int</span> offset <span class="token operator">=</span> mappedFile<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span>commitLeastPages<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æœ¬æ¬¡æäº¤çš„ä½ç½®åœ¨æ•´ä¸ªæ–‡ä»¶é˜Ÿåˆ—çš„åç§»</span>
            <span class="token keyword">long</span> where <span class="token operator">=</span> mappedFile<span class="token punctuation">.</span><span class="token function">getFileFromOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> offset<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æœ¬æ¬¡æäº¤çš„ä½ç½®ç­‰äºä¸Šæ¬¡æäº¤ä½ç½®ï¼Œè¯´æ˜FileChannelä¸éœ€è¦åˆ·ç›˜ï¼Œå¦åˆ™è¯´æ˜æœ‰æ–°æäº¤çš„æ•°æ®ï¼Œéœ€è¦åˆ·ç›˜</span>
            result <span class="token operator">=</span> where <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>committedWhere<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ›´æ–°æäº¤ä½ç½®</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>committedWhere <span class="token operator">=</span> where<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>MappedFile#commit</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * æ•°æ®å…ˆå†™åˆ°å†™ç¼“å†²ï¼Œå†Commitåˆ°FileChannel
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">commit</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span> commitLeastPages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// å¦‚æœå†™ç¼“å†²ä¸ºnullï¼Œè¯´æ˜è¿™ä¸ªMappedFileå·²ç»ä¸éœ€è¦å†™å…¥æ•°æ®äº†</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>writeBuffer <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ä¸éœ€è¦æäº¤æ•°æ®åˆ°FileChannelï¼Œå†™ç¼“å†²çš„WrotePositionå°±æ˜¯CommittedPosition</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>wrotePosition<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å¯ä»¥æäº¤</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isAbleToCommit</span><span class="token punctuation">(</span>commitLeastPages<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è·å–å¼•ç”¨è®¡æ•°æˆåŠŸ</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hold</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æäº¤åˆ°FileChannel</span>
                <span class="token function">commit0</span><span class="token punctuation">(</span>commitLeastPages<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// é‡Šæ”¾å¼•ç”¨è®¡æ•°</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// MappedFileçš„å¤§å°ç­‰äºç¼“å†²æäº¤åˆ°FileChannelçš„ä½ç½®ï¼Œè¯´æ˜æ–‡ä»¶å·²ç»å†™æ»¡</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>writeBuffer <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>transientStorePool <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fileSize <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>committedPosition<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è¿”è¿˜ç¼“å­˜åˆ°ç¼“å†²æ± </span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>transientStorePool<span class="token punctuation">.</span><span class="token function">returnBuffer</span><span class="token punctuation">(</span>writeBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ç½®ç©ºå†™ç¼“å†²</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>writeBuffer <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// è¿”å›æäº¤åˆ°FileChannelçš„ä½ç½®</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>committedPosition<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>MappedFile#commit0</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">commit0</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span> commitLeastPages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// å†™ç¼“å†²å†™çš„ä½ç½®</span>
        <span class="token keyword">int</span> writePos <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>wrotePosition<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å†™ç¼“å†²ä¸Šæ¬¡æäº¤åˆ°FileChannelçš„ä½ç½®</span>
        <span class="token keyword">int</span> lastCommittedPosition <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>committedPosition<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æœ‰æ–°çš„æ•°æ®éœ€è¦æäº¤åˆ°FileChannel</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>writePos <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>committedPosition<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å­ç¼“å†²ï¼Œå…±ç”¨å†…å­˜ï¼ŒæŒ‡é’ˆç‹¬ç«‹</span>
                ByteBuffer byteBuffer <span class="token operator">=</span> writeBuffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// è®¾ç½®ç¼“å†²çš„è¯»ç´¢å¼•</span>
                byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span>lastCommittedPosition<span class="token punctuation">)</span><span class="token punctuation">;</span>
                byteBuffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>writePos<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// è®¾ç½®FileChannelçš„å†™ç´¢å¼•</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>fileChannel<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span>lastCommittedPosition<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å°†ç¼“å†²å†™å…¥FileChannel</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>fileChannel<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// æ›´æ–°æäº¤ä½ç½®</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>committedPosition<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>writePos<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>è¿™ç§æ–¹å¼çš„ä¸åŒä¹‹å¤„åœ¨äºï¼Œä¹‹å‰çš„æ–¹å¼æ˜¯å°†æ•°æ®å†™å…¥MappedByteBufferï¼Œåå°çº¿ç¨‹å†æ‰§è¡Œåˆ·ç›˜ï¼Œè€Œè¿™ç§æ–¹å¼æ˜¯å°†æ•°æ®å†™åˆ°ä¸€ä¸ªå †å¤–ç¼“å†²ä¸­ï¼Œç„¶ååå°çº¿ç¨‹å†å°†ç¼“å†²çš„æ•°æ®å†™å…¥FileChannelï¼Œéœ€è¦æäº¤çš„æ—¶å€™ç”±å¦ä¸€ä¸ªçº¿ç¨‹åˆ·ç›˜ã€‚</p>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


        <footer>
             
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

        </footer>
    </div>
    <!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
    <script>
        var timeEnd = new Date();
        console.log('è€—æ—¶ï¼š' + (timeEnd - timeStart));
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre').forEach((block) => {
                block.classList.add("line-numbers");
            });
        });
    </script>
    <!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
    <!-- material design -->
    <!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
    <!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
    <!-- toc -->
    <!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
    <!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
    <!-- <script src="/js/main.js"></script> -->
    <script src="/js/prism.js"></script>
</body>
</html>
