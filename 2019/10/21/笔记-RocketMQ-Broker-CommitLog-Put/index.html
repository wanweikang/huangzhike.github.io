<!DOCTYPE HTML>
<html>

<head>
    <script>
        var timeStart = new Date();
    </script>
    <meta charset="utf-8">
    
    <title>[笔记]-RocketMQ-Broker-CommitLog-Put | 草木禾</title>
    
    <meta name="author" content="huangzhike">
    
    
    <meta name="description"
        content="DefaultMessageStore#putMessage
    public PutMessageResult putMessage(MessageExtBrokerInner msg) {
        // MessageStore关闭，不接受消息
        if (this.sh">
    
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta property="og:title" content="[笔记]-RocketMQ-Broker-CommitLog-Put" />
    
    <meta property="og:site_name" content="草木禾" />
    
    
    <!-- favicon -->
    <link rel="icon" type="image/ico" href="/logo.ico" sizes="32x32">
    <meta name="msapplication-TileColor" content="#009688">
    <meta name="msapplication-TileImage" content="/mstile-144x144.ico">
    <meta name="theme-color" content="#009688">
    <!-- favicon end -->
    <!-- <link href="//ok.ico" rel="icon"> -->
    

    <!-- <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.5.0/css/bootstrap.min.css" rel="stylesheet"> -->
    <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
    <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
    <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">

<meta name="generator" content="Hexo 4.2.1"></head>
<body>
    <nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">菜单</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" title="早く来い、クラウド" href="/">Reunion...</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" target="_blank" rel="noopener" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

    <div class="container" >
        <div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[笔记]-RocketMQ-Broker-CommitLog-Put</h2>
				
				<div>
					<div class="post-time">2019-10-21</div>
				</div>
				
				<div class="article-content">
				<p>DefaultMessageStore#putMessage</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> PutMessageResult <span class="token function">putMessage</span><span class="token punctuation">(</span>MessageExtBrokerInner msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// MessageStore关闭，不接受消息</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>shutdown<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// SLAVE，不接受消息</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>BrokerRole<span class="token punctuation">.</span>SLAVE <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>messageStoreConfig<span class="token punctuation">.</span><span class="token function">getBrokerRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Broker不可写，不保存</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>runningFlags<span class="token punctuation">.</span><span class="token function">isWriteable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Topic长度超过Byte.MAX_VALUE，不保存</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> Byte<span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Properties长度超过Short.MAX_VALUE，不保存</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getPropertiesString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> msg<span class="token punctuation">.</span><span class="token function">getPropertiesString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> Short<span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 操作系统PageCache忙，不保存</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isOSPageCacheBusy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// 把消息放入CommitLog，返回结果</span>
        PutMessageResult result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>commitLog<span class="token punctuation">.</span><span class="token function">putMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// 统计耗时</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// 统计失败次数</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> PutMessageResult <span class="token function">putMessage</span><span class="token punctuation">(</span><span class="token keyword">final</span> MessageExtBrokerInner msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 存储时间戳，后面会被覆盖，所以这里的意义是？</span>
        msg<span class="token punctuation">.</span><span class="token function">setStoreTimestamp</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 消息体的CRC校验</span>
        msg<span class="token punctuation">.</span><span class="token function">setBodyCRC</span><span class="token punctuation">(</span>UtilAll<span class="token punctuation">.</span><span class="token function">crc32</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Back to Results</span>
        AppendMessageResult result <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        String topic <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> queueId <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> tranType <span class="token operator">=</span> MessageSysFlag<span class="token punctuation">.</span><span class="token function">getTransactionValue</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getSysFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 非事务消息 || Commit型事务消息</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tranType <span class="token operator">==</span> MessageSysFlag<span class="token punctuation">.</span>TRANSACTION_NOT_TYPE <span class="token operator">||</span> tranType <span class="token operator">==</span> MessageSysFlag<span class="token punctuation">.</span>TRANSACTION_COMMIT_TYPE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 如果设置了延迟投递</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getDelayTimeLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getDelayTimeLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getScheduleMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxDelayLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    msg<span class="token punctuation">.</span><span class="token function">setDelayTimeLevel</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getScheduleMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxDelayLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 修改Topic为SCHEDULE_TOPIC_XXXX，不会被Consumer消费，因为没订阅这个Topic，后续由后台线程扫描恢复原本主题</span>
                topic <span class="token operator">=</span> ScheduleMessageService<span class="token punctuation">.</span>SCHEDULE_TOPIC<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 根据延时级别计算QueueId，其实就是DelayLevel-1，后面会把消息放到SCHEDULE_TOPIC_XXXX的队列里</span>
                queueId <span class="token operator">=</span> ScheduleMessageService<span class="token punctuation">.</span><span class="token function">delayLevel2QueueId</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getDelayTimeLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 备份原本的Topic和QueueId</span>
                MessageAccessor<span class="token punctuation">.</span><span class="token function">putProperty</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> MessageConst<span class="token punctuation">.</span>PROPERTY_REAL_TOPIC<span class="token punctuation">,</span> msg<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                MessageAccessor<span class="token punctuation">.</span><span class="token function">putProperty</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> MessageConst<span class="token punctuation">.</span>PROPERTY_REAL_QUEUE_ID<span class="token punctuation">,</span> String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                msg<span class="token punctuation">.</span><span class="token function">setPropertiesString</span><span class="token punctuation">(</span>MessageDecoder<span class="token punctuation">.</span><span class="token function">messageProperties2String</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">getProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 修改Topic</span>
                msg<span class="token punctuation">.</span><span class="token function">setTopic</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 修改QueueId</span>
                msg<span class="token punctuation">.</span><span class="token function">setQueueId</span><span class="token punctuation">(</span>queueId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">/*
                 * 延时消息的逻辑：
                 * 延时消息到达Broker后，修改Topic为SCHEDULE_TOPIC_XXXX，QueueId为DelayLevel - 1
                 * ReputMessageService将消息从CommitLog中更新ConsumeQueue时，将TagsCode换成时间戳，因为延时消息不需要Tag过滤，没有Consumer订阅
                 * DeliverDelayedMessageTimerTask任务线程遍历ConsumeQueue，根据TagsCode取出到时的消息，恢复原本的Topic和QueueId，再次写入CommitLog
                 * 然后再次更新ConsumeQueue，这样就可以被消费了
                 */</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ...</span>
        MappedFile unlockMappedFile <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 获取最后一个MappedFile，因为是顺序写入</span>
        MappedFile mappedFile <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileQueue<span class="token punctuation">.</span><span class="token function">getLastMappedFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 获取锁</span>
        putMessageLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//spin or ReentrantLock ,depending on store config</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">long</span> beginLockTimestamp <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getSystemClock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>beginTimeInLock <span class="token operator">=</span> beginLockTimestamp<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 为了保证全局有序，使用获得锁后的时间戳为存储时间戳</span>
            msg<span class="token punctuation">.</span><span class="token function">setStoreTimestamp</span><span class="token punctuation">(</span>beginLockTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 不存在，可能是第一次启动 || 文件已满</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">==</span> mappedFile <span class="token operator">||</span> mappedFile<span class="token punctuation">.</span><span class="token function">isFull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 创建新的MappedFile，原注释的噪音大概指的是内存抖动？</span>
                <span class="token comment" spellcheck="true">// may be cause noise 这句话是不是有语法错误啊？应该是 may cause noise 或 may be causing noise 吧？</span>
                mappedFile <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileQueue<span class="token punctuation">.</span><span class="token function">getLastMappedFile</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Mark: NewFile may be cause noise</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 创建MappedFile失败</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">==</span> mappedFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 直接返回</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 在回调中将消息写入MappedFile，返回结果</span>
            result <span class="token operator">=</span> mappedFile<span class="token punctuation">.</span><span class="token function">appendMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>appendMessageCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 写入状态</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 成功</span>
                <span class="token keyword">case</span> PUT_OK<span class="token operator">:</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 文件已满，剩余空间放不下完整的消息</span>
                <span class="token keyword">case</span> END_OF_FILE<span class="token operator">:</span>
                    unlockMappedFile <span class="token operator">=</span> mappedFile<span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// 新建MappedFile，继续</span>
                    mappedFile <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileQueue<span class="token punctuation">.</span><span class="token function">getLastMappedFile</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// 创建失败</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">==</span> mappedFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 直接返回</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// 继续写入MappedFile</span>
                    result <span class="token operator">=</span> mappedFile<span class="token punctuation">.</span><span class="token function">appendMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>appendMessageCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> MESSAGE_SIZE_EXCEEDED<span class="token operator">:</span>
                <span class="token keyword">case</span> PROPERTIES_SIZE_EXCEEDED<span class="token operator">:</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token keyword">case</span> UNKNOWN_ERROR<span class="token operator">:</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token keyword">default</span><span class="token operator">:</span>
                    <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 释放锁</span>
            putMessageLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 写消息耗时过长，打印日志</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">!=</span> unlockMappedFile <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isWarmMapedFileEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 释放MappedFile</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">unlockMappedFile</span><span class="token punctuation">(</span>unlockMappedFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        PutMessageResult putMessageResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PutMessageResult</span><span class="token punctuation">(</span>PutMessageStatus<span class="token punctuation">.</span>PUT_OK<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Statistics</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// 处理刷盘</span>
        <span class="token function">handleDiskFlush</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> putMessageResult<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 处理高可用，如果Broker是SYNC_MASTER，则等SLAVE接收到数据后才返回，如果是ASYNC_MASTER，交给HAService线程执行同步</span>
        <span class="token function">handleHA</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> putMessageResult<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> putMessageResult<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>MappedFileQueue#getLastMappedFile</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> MappedFile <span class="token function">getLastMappedFile</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">long</span> startOffset<span class="token punctuation">,</span> <span class="token keyword">boolean</span> needCreate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> createOffset <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// MappedFile队列的最后一个MappedFile</span>
        MappedFile mappedFileLast <span class="token operator">=</span> <span class="token function">getLastMappedFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 一个MappedFile也没有</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mappedFileLast <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 计算新创建的MappedFile的起始偏移</span>
            createOffset <span class="token operator">=</span> startOffset <span class="token operator">-</span> <span class="token punctuation">(</span>startOffset <span class="token operator">%</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 最后一个MappedFile已写满</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mappedFileLast <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> mappedFileLast<span class="token punctuation">.</span><span class="token function">isFull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 计算新创建的MappedFile的起始偏移</span>
            createOffset <span class="token operator">=</span> mappedFileLast<span class="token punctuation">.</span><span class="token function">getFileFromOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileSize<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 只有文件写满或找不到文件时，才创建新的文件</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>createOffset <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> needCreate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 新建的MappedFile文件路径及文件名</span>
            String nextFilePath <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>storePath <span class="token operator">+</span> File<span class="token punctuation">.</span>separator <span class="token operator">+</span> UtilAll<span class="token punctuation">.</span><span class="token function">offset2FileName</span><span class="token punctuation">(</span>createOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 新建的MappedFile的下一个MappedFile文件路径及文件名</span>
            String nextNextFilePath <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>storePath <span class="token operator">+</span> File<span class="token punctuation">.</span>separator <span class="token operator">+</span> UtilAll<span class="token punctuation">.</span><span class="token function">offset2FileName</span><span class="token punctuation">(</span>createOffset <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
            MappedFile mappedFile <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 有AllocateMappedFileService</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>allocateMappedFileService <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 通过AllocateMappedFileService分配MappedFile，如CommitLog</span>
                mappedFile <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>allocateMappedFileService<span class="token punctuation">.</span><span class="token function">putRequestAndReturnMappedFile</span><span class="token punctuation">(</span>nextFilePath<span class="token punctuation">,</span> nextNextFilePath<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ConsumeQueue则是直接创建</span>
                    mappedFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MappedFile</span><span class="token punctuation">(</span>nextFilePath<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 创建MappedFile成功</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mappedFile <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 如果队列没有别的MappedFile</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mappedFiles<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 那就是队列中第一个创建的</span>
                    mappedFile<span class="token punctuation">.</span><span class="token function">setFirstCreateInQueue</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 添加到队列</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFiles<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>mappedFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> mappedFile<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> mappedFileLast<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>MappedFile#appendMessagesInner</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> AppendMessageResult <span class="token function">appendMessagesInner</span><span class="token punctuation">(</span><span class="token keyword">final</span> MessageExt messageExt<span class="token punctuation">,</span> <span class="token keyword">final</span> AppendMessageCallback cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">assert</span> messageExt <span class="token operator">!=</span> null<span class="token punctuation">;</span>
        <span class="token keyword">assert</span> cb <span class="token operator">!=</span> null<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 当前MappedFile的写位置</span>
        <span class="token keyword">int</span> currentPos <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>wrotePosition<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 写指针位置小于文件大小才有空间继续写</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentPos <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fileSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 子缓冲，索引独立</span>
            <span class="token comment" spellcheck="true">// 这里有两个缓冲，其中WriteBuffer是从堆外内存池TransientStorePool中获取的</span>
            <span class="token comment" spellcheck="true">// 只有在开启了TransientStorePoolEnable，并且是异步刷盘的Master才使用，默认不使用</span>
            ByteBuffer byteBuffer <span class="token operator">=</span> writeBuffer <span class="token operator">!=</span> null <span class="token operator">?</span> writeBuffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedByteBuffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 设置写索引</span>
            byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span>currentPos<span class="token punctuation">)</span><span class="token punctuation">;</span>
            AppendMessageResult result<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>messageExt <span class="token keyword">instanceof</span> <span class="token class-name">MessageExtBrokerInner</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 添加</span>
                result <span class="token operator">=</span> cb<span class="token punctuation">.</span><span class="token function">doAppend</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getFileFromOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> byteBuffer<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fileSize <span class="token operator">-</span> currentPos<span class="token punctuation">,</span> <span class="token punctuation">(</span>MessageExtBrokerInner<span class="token punctuation">)</span> messageExt<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>messageExt <span class="token keyword">instanceof</span> <span class="token class-name">MessageExtBatch</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 批量添加</span>
                result <span class="token operator">=</span> cb<span class="token punctuation">.</span><span class="token function">doAppend</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getFileFromOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> byteBuffer<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fileSize <span class="token operator">-</span> currentPos<span class="token punctuation">,</span> <span class="token punctuation">(</span>MessageExtBatch<span class="token punctuation">)</span> messageExt<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AppendMessageResult</span><span class="token punctuation">(</span>AppendMessageStatus<span class="token punctuation">.</span>UNKNOWN_ERROR<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 更新写位置</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>wrotePosition<span class="token punctuation">.</span><span class="token function">addAndGet</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getWroteBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>storeTimestamp <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getStoreTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AppendMessageResult</span><span class="token punctuation">(</span>AppendMessageStatus<span class="token punctuation">.</span>UNKNOWN_ERROR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>CommitLog#doAppend</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">public</span> AppendMessageResult <span class="token function">doAppend</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">long</span> fileFromOffset<span class="token punctuation">,</span> <span class="token keyword">final</span> ByteBuffer byteBuffer<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> maxBlank<span class="token punctuation">,</span> <span class="token keyword">final</span> MessageExtBrokerInner msgInner<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 待写入的消息在CommitLog的全局偏移 = 文件的起始偏移 + MappedFile的缓冲的写索引</span>
            <span class="token keyword">long</span> wroteOffset <span class="token operator">=</span> fileFromOffset <span class="token operator">+</span> byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 重置HostHolder这块缓冲</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resetByteBuffer</span><span class="token punctuation">(</span>hostHolder<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 生成MessageId，16字节，写入MessageId的缓冲，前8位是Host地址，包括IP和Port，后8位是消息在CommitLog的偏移</span>
            <span class="token comment" spellcheck="true">// 可以根据MessageId知道消息存在哪个Broker的CommitLog位置</span>
            String msgId <span class="token operator">=</span> MessageDecoder<span class="token punctuation">.</span><span class="token function">createMessageId</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>msgIdMemory<span class="token punctuation">,</span> msgInner<span class="token punctuation">.</span><span class="token function">getStoreHostBytes</span><span class="token punctuation">(</span>hostHolder<span class="token punctuation">)</span><span class="token punctuation">,</span> wroteOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// Record ConsumeQueue information</span>
            keyBuilder<span class="token punctuation">.</span><span class="token function">setLength</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            keyBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            keyBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            keyBuilder<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            String key <span class="token operator">=</span> keyBuilder<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 根据Topic和QueueId获取ConsumeQueue的队列偏移，就是队列的消息数量</span>
            Long queueOffset <span class="token operator">=</span> CommitLog<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>topicQueueTable<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">==</span> queueOffset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Queue的第一条消息</span>
                queueOffset <span class="token operator">=</span> 0L<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 初始化</span>
                CommitLog<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>topicQueueTable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> queueOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 事务类型</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> tranType <span class="token operator">=</span> MessageSysFlag<span class="token punctuation">.</span><span class="token function">getTransactionValue</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getSysFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>tranType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Prepared和Rollback类型的事务消息不进入队列</span>
                <span class="token keyword">case</span> MessageSysFlag<span class="token punctuation">.</span>TRANSACTION_PREPARED_TYPE<span class="token operator">:</span>
                <span class="token keyword">case</span> MessageSysFlag<span class="token punctuation">.</span>TRANSACTION_ROLLBACK_TYPE<span class="token operator">:</span>
                    queueOffset <span class="token operator">=</span> 0L<span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> MessageSysFlag<span class="token punctuation">.</span>TRANSACTION_NOT_TYPE<span class="token operator">:</span>
                <span class="token keyword">case</span> MessageSysFlag<span class="token punctuation">.</span>TRANSACTION_COMMIT_TYPE<span class="token operator">:</span>
                <span class="token keyword">default</span><span class="token operator">:</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">// Properties序列化</span>
            <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> propertiesData <span class="token operator">=</span> msgInner<span class="token punctuation">.</span><span class="token function">getPropertiesString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null <span class="token operator">?</span> null <span class="token operator">:</span> msgInner<span class="token punctuation">.</span><span class="token function">getPropertiesString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span>MessageDecoder<span class="token punctuation">.</span>CHARSET_UTF8<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> propertiesLength <span class="token operator">=</span> propertiesData <span class="token operator">==</span> null <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> propertiesData<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// Properties长度不能超过Short.MAX_VALUE</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>propertiesLength <span class="token operator">></span> Short<span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 直接返回</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// Topic序列化</span>
            <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> topicData <span class="token operator">=</span> msgInner<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span>MessageDecoder<span class="token punctuation">.</span>CHARSET_UTF8<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> topicLength <span class="token operator">=</span> topicData<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> bodyLength <span class="token operator">=</span> msgInner<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> msgInner<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 计算消息实际长度</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> msgLen <span class="token operator">=</span> <span class="token function">calMsgLength</span><span class="token punctuation">(</span>bodyLength<span class="token punctuation">,</span> topicLength<span class="token punctuation">,</span> propertiesLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 消息长度过长</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>msgLen <span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>maxMessageSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 直接返回</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 消息长度 + 文件结尾最小空白长度 > 文件剩余可写长度</span>
            <span class="token comment" spellcheck="true">// 说明空间不足以写下此条消息</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>msgLen <span class="token operator">+</span> END_FILE_MIN_BLANK_LENGTH<span class="token punctuation">)</span> <span class="token operator">></span> maxBlank<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resetByteBuffer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">,</span> maxBlank<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 空白填充的长度，4字节</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>maxBlank<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 空白的魔数，4字节</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>CommitLog<span class="token punctuation">.</span>BLANK_MAGIC_CODE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">final</span> <span class="token keyword">long</span> beginTimeMills <span class="token operator">=</span> CommitLog<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 填充</span>
                byteBuffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> maxBlank<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">AppendMessageResult</span><span class="token punctuation">(</span>AppendMessageStatus<span class="token punctuation">.</span>END_OF_FILE<span class="token punctuation">,</span> wroteOffset<span class="token punctuation">,</span> maxBlank<span class="token punctuation">,</span> msgId<span class="token punctuation">,</span> msgInner<span class="token punctuation">.</span><span class="token function">getStoreTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> queueOffset<span class="token punctuation">,</span> CommitLog<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> beginTimeMills<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// Initialization of storage space</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resetByteBuffer</span><span class="token punctuation">(</span>msgStoreItemMemory<span class="token punctuation">,</span> msgLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 消息总长度，4字节</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>msgLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 消息的魔数，4字节</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>CommitLog<span class="token punctuation">.</span>MESSAGE_MAGIC_CODE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 消息体CRC校验，4字节</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getBodyCRC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 消息所在队列的Id，4字节</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 标记，4字节</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 消息在队列的位置偏移，8字节</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">putLong</span><span class="token punctuation">(</span>queueOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 消息在CommitLog的物理偏移，8字节</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">putLong</span><span class="token punctuation">(</span>fileFromOffset <span class="token operator">+</span> byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 系统标记，4字节</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getSysFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 出生时间戳，8字节</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">putLong</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getBornTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resetByteBuffer</span><span class="token punctuation">(</span>hostHolder<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 生产的Broker地址，包括IP和端口，8字节</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getBornHostBytes</span><span class="token punctuation">(</span>hostHolder<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 存储时间戳，8字节</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">putLong</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getStoreTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resetByteBuffer</span><span class="token punctuation">(</span>hostHolder<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 存储的Broker地址，包括IP和端口，8字节</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getStoreHostBytes</span><span class="token punctuation">(</span>hostHolder<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//this.msgBatchMemory.put(msgInner.getStoreHostBytes());</span>
            <span class="token comment" spellcheck="true">// 消费重试次数，4字节</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getReconsumeTimes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 14 Prepared Transaction Offset</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">putLong</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getPreparedTransactionOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 消息体长度，4字节</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>bodyLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>bodyLength <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// 消息体</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// Topic长度，1字节</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> topicLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// Topic</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>topicData<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 属性长度，2字节</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">putShort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">short</span><span class="token punctuation">)</span> propertiesLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>propertiesLength <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// 属性</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>propertiesData<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> beginTimeMills <span class="token operator">=</span> CommitLog<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// Write messages to the queue buffer</span>
            byteBuffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>msgStoreItemMemory<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> msgLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//</span>
            AppendMessageResult result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AppendMessageResult</span><span class="token punctuation">(</span>AppendMessageStatus<span class="token punctuation">.</span>PUT_OK<span class="token punctuation">,</span> wroteOffset<span class="token punctuation">,</span> msgLen<span class="token punctuation">,</span> msgId<span class="token punctuation">,</span> msgInner<span class="token punctuation">.</span><span class="token function">getStoreTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> queueOffset<span class="token punctuation">,</span> CommitLog<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> beginTimeMills<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>tranType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 忽略Prepared和Rollback类型的事务消息</span>
                <span class="token keyword">case</span> MessageSysFlag<span class="token punctuation">.</span>TRANSACTION_PREPARED_TYPE<span class="token operator">:</span>
                <span class="token keyword">case</span> MessageSysFlag<span class="token punctuation">.</span>TRANSACTION_ROLLBACK_TYPE<span class="token operator">:</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 非事务消息和Commit类型的事务消息需要更新队列的偏移</span>
                <span class="token keyword">case</span> MessageSysFlag<span class="token punctuation">.</span>TRANSACTION_NOT_TYPE<span class="token operator">:</span>
                <span class="token keyword">case</span> MessageSysFlag<span class="token punctuation">.</span>TRANSACTION_COMMIT_TYPE<span class="token operator">:</span>
                    <span class="token comment" spellcheck="true">// The next update ConsumeQueue information</span>
                    CommitLog<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>topicQueueTable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token operator">++</span>queueOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">default</span><span class="token operator">:</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>CommitLog#handleDiskFlush</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleDiskFlush</span><span class="token punctuation">(</span>AppendMessageResult result<span class="token punctuation">,</span> PutMessageResult putMessageResult<span class="token punctuation">,</span> MessageExt messageExt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 同步刷盘</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>FlushDiskType<span class="token punctuation">.</span>SYNC_FLUSH <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFlushDiskType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> GroupCommitService service <span class="token operator">=</span> <span class="token punctuation">(</span>GroupCommitService<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>flushCommitLogService<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 如果要等待存储结果是否OK</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>messageExt<span class="token punctuation">.</span><span class="token function">isWaitStoreMsgOK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 创建提交请求</span>
                GroupCommitRequest request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GroupCommitRequest</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getWroteOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> result<span class="token punctuation">.</span><span class="token function">getWroteBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 加入GroupCommitService的队列</span>
                service<span class="token punctuation">.</span><span class="token function">putRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 阻塞等刷盘完成或超时</span>
                <span class="token keyword">boolean</span> flushOK <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">waitForFlush</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSyncFlushTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>flushOK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 唤醒GroupCommitService同步刷盘线程，这里线程直接返回</span>
                service<span class="token punctuation">.</span><span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 异步刷盘</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 默认情况，不启用缓冲池</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isTransientStorePoolEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 唤醒FlushCommitLogService，由FlushCommitLogService刷盘</span>
                flushCommitLogService<span class="token punctuation">.</span><span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 唤醒CommitRealTimeService，由CommitRealTimeService刷盘</span>
                commitLogService<span class="token punctuation">.</span><span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>同步刷盘</p>
<p>CommitLog$GroupCommitService#putRequest</p>
<pre class=" language-java"><code class="language-java">        <span class="token comment" spellcheck="true">/**
         * 请求先提交到写队列，每次处理前，先交换读写队列，然后从读队列获取请求，提交后再清空读队列，避免多线程操作问题
         */</span>
        <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">putRequest</span><span class="token punctuation">(</span><span class="token keyword">final</span> GroupCommitRequest request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 获取写队列的同步锁，因为swapRequests方法会交换写队列和读队列</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>requestsWrite<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 添加到写队列</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>requestsWrite<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 新请求加入时，没唤醒就唤醒GroupCommitService线程</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>hasNotified<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                waitPoint<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// notify</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span></code></pre>
<p>CommitLog$GroupCommitService#run</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 如果唤醒标志为已唤醒（有请求加入），重置标记为未唤醒，并交换读写队列</span>
                    <span class="token comment" spellcheck="true">// 如果唤醒标记为未唤醒，则阻塞超时等待唤醒，最后重置标记为未唤醒，并交换读写队列</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">waitForRunning</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// 执行提交</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doCommit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 普通关闭，等待请求到达，然后刷盘</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 交换读写队列</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">swapRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 最后执行一次刷盘</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doCommit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span></code></pre>
<p>CommitLog$GroupCommitService#swapRequests</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">swapRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            List<span class="token operator">&lt;</span>GroupCommitRequest<span class="token operator">></span> tmp <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>requestsWrite<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>requestsWrite <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>requestsRead<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>requestsRead <span class="token operator">=</span> tmp<span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>CommitLog$GroupCommitService#doCommit</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doCommit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 获取读队列的同步锁</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>requestsRead<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>requestsRead<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 遍历同步刷盘请求</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span>GroupCommitRequest req <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>requestsRead<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">boolean</span> flushOK <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// 貌似是执行两次，而不是重试两次？</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>flushOK<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// 已刷盘位置 >= 请求刷盘的结束位置</span>
                            <span class="token comment" spellcheck="true">// 说明刷盘成功</span>
                            flushOK <span class="token operator">=</span> CommitLog<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileQueue<span class="token punctuation">.</span><span class="token function">getFlushedWhere</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> req<span class="token punctuation">.</span><span class="token function">getNextOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>flushOK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token comment" spellcheck="true">// 执行刷盘</span>
                                CommitLog<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileQueue<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment" spellcheck="true">// 唤醒提交同步刷盘请求的Broker线程，是否刷盘成功</span>
                        req<span class="token punctuation">.</span><span class="token function">wakeupCustomer</span><span class="token punctuation">(</span>flushOK<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">long</span> storeTimestamp <span class="token operator">=</span> CommitLog<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileQueue<span class="token punctuation">.</span><span class="token function">getStoreTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>storeTimestamp <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 更新刷盘的Checkpoint时间戳</span>
                        CommitLog<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getStoreCheckpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPhysicMsgTimestamp</span><span class="token punctuation">(</span>storeTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// 处理完就清空读队列</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>requestsRead<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 读队列为空</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 可能没有同步刷盘消息提交，GroupCommitService线程超时唤醒走到这里，那就强制刷盘一次</span>
                    CommitLog<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileQueue<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span></code></pre>
<p>下面的代码可能我理解有问题，总觉得这样不太好？</p>
<p>MappedFileQueue#flush</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">flush</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span> flushLeastPages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 根据上次刷盘位置获取MappedFile</span>
        MappedFile mappedFile <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">findMappedFileByOffset</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>flushedWhere<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>flushedWhere <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mappedFile <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">long</span> tmpTimeStamp <span class="token operator">=</span> mappedFile<span class="token punctuation">.</span><span class="token function">getStoreTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 刷盘并返回MappedFile的刷盘位置</span>
            <span class="token keyword">int</span> offset <span class="token operator">=</span> mappedFile<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span>flushLeastPages<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 刷盘位置在CommitLog，或者ConsumeQueue的偏移 = MappedFile的起始偏移 + MappedFile的刷盘偏移</span>
            <span class="token keyword">long</span> where <span class="token operator">=</span> mappedFile<span class="token punctuation">.</span><span class="token function">getFileFromOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> offset<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 本次刷盘的位置等于上次刷盘的位置，说明刷盘两次，成功？</span>
            <span class="token comment" spellcheck="true">// 也就是说，第一次刷盘是执行刷盘，第二次只是验证？可能我没理解这段代码</span>
            result <span class="token operator">=</span> where <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>flushedWhere<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 更新刷盘位置，这个位置是相对于整个文件队列的</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>flushedWhere <span class="token operator">=</span> where<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 说明是强制刷盘</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> flushLeastPages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>storeTimestamp <span class="token operator">=</span> tmpTimeStamp<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>MappedFileQueue#findMappedFileByOffset</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> MappedFile <span class="token function">findMappedFileByOffset</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">long</span> offset<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> returnFirstOnNotFound<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 获取第一个MappedFile</span>
            MappedFile firstMappedFile <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getFirstMappedFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 获取最后一个MappedFile</span>
            MappedFile lastMappedFile <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getLastMappedFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>firstMappedFile <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> lastMappedFile <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 上次刷盘的偏移 &lt; 第一个MappedFile的起始偏移 || 上次刷盘的偏移 >= 最后一个MappedFile的起始偏移 + MappedFile大小</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>offset <span class="token operator">&lt;</span> firstMappedFile<span class="token punctuation">.</span><span class="token function">getFileFromOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> offset <span class="token operator">>=</span> lastMappedFile<span class="token punctuation">.</span><span class="token function">getFileFromOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 正常情况</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 对应的MappedFile在队列的位置 = 偏移对应的MappedFile位置 - 队列的第一个MappedFile位置</span>
                    <span class="token comment" spellcheck="true">// 因为过期文件可能会被删除</span>
                    <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>offset <span class="token operator">/</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileSize<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>firstMappedFile<span class="token punctuation">.</span><span class="token function">getFileFromOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    MappedFile targetFile <span class="token operator">=</span> null<span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 获取对应位置的MappedFile</span>
                        targetFile <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFiles<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// 再检查一次</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>targetFile <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> offset <span class="token operator">>=</span> targetFile<span class="token punctuation">.</span><span class="token function">getFileFromOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> offset <span class="token operator">&lt;</span> targetFile<span class="token punctuation">.</span><span class="token function">getFileFromOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> targetFile<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// 如果没找到合适的，那就遍历所有的MappedFile</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span>MappedFile tmpMappedFile <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFiles<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 查找匹配的MappedFile返回</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>offset <span class="token operator">>=</span> tmpMappedFile<span class="token punctuation">.</span><span class="token function">getFileFromOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> offset <span class="token operator">&lt;</span> tmpMappedFile<span class="token punctuation">.</span><span class="token function">getFileFromOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">return</span> tmpMappedFile<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 最后还没找到，如果设置返回第一个MappedFile</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>returnFirstOnNotFound<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 那就返回第一个</span>
                    <span class="token keyword">return</span> firstMappedFile<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>MappedFile#flush</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">flush</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span> flushLeastPages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 凑够页数，可以刷盘</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isAbleToFlush</span><span class="token punctuation">(</span>flushLeastPages<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 获取MappedFile引用计数</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hold</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 这个是数据写入缓冲的结束位置，即期待刷盘结束的位置，名字很误导</span>
                <span class="token keyword">int</span> value <span class="token operator">=</span> <span class="token function">getReadPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 通过FileChannel或MappedByteBuffer，把缓冲刷到磁盘，根据TransientStorePoolEnable，刷盘方式和Broker角色决定</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>writeBuffer <span class="token operator">!=</span> null <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fileChannel<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>fileChannel<span class="token punctuation">.</span><span class="token function">force</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>mappedByteBuffer<span class="token punctuation">.</span><span class="token function">force</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 设置FlushedPosition，上面把异常捕捉了，怎么确保一定刷盘成功了呢？</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>flushedPosition<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 释放计数</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>flushedPosition<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token function">getReadPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 返回FlushedPosition</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getFlushedPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>MappedFile#isAbleToFlush</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isAbleToFlush</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span> flushLeastPages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 上次MappedFile刷盘位置</span>
        <span class="token keyword">int</span> flush <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>flushedPosition<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// MappedFile缓冲的写指针位置</span>
        <span class="token keyword">int</span> write <span class="token operator">=</span> <span class="token function">getReadPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 缓冲的写指针位置等于文件大小，说明MappedFile已写满</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isFull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 可以刷盘</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 指定了刷盘页数</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>flushLeastPages <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 可提交的页数大于最小页数才提交</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>write <span class="token operator">/</span> OS_PAGE_SIZE<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>flush <span class="token operator">/</span> OS_PAGE_SIZE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>=</span> flushLeastPages<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 有新数据未刷盘就可以刷盘</span>
        <span class="token keyword">return</span> write <span class="token operator">></span> flush<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>异步刷盘，不使用缓冲池。</p>
<p>CommitLog$FlushCommitLogService#run</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 是定时计划刷盘还是等待唤醒刷盘，默认是等待唤醒，比较实时</span>
                <span class="token keyword">boolean</span> flushCommitLogTimed <span class="token operator">=</span> CommitLog<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isFlushCommitLogTimed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 定时刷盘间隔，默认500毫秒</span>
                <span class="token keyword">int</span> interval <span class="token operator">=</span> CommitLog<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFlushIntervalCommitLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// CommitLog刷盘需要达到的最小页数，默认4</span>
                <span class="token keyword">int</span> flushPhysicQueueLeastPages <span class="token operator">=</span> CommitLog<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFlushCommitLogLeastPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 默认10秒</span>
                <span class="token keyword">int</span> flushPhysicQueueThoroughInterval <span class="token operator">=</span> CommitLog<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFlushCommitLogThoroughInterval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 不打印刷盘进程</span>
                <span class="token keyword">boolean</span> printFlushProgress <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// Print flush progress</span>
                <span class="token keyword">long</span> currentTimeMillis <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 上次刷盘离现在已经超出刷盘间隔</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>currentTimeMillis <span class="token operator">>=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>lastFlushTimestamp <span class="token operator">+</span> flushPhysicQueueThoroughInterval<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>lastFlushTimestamp <span class="token operator">=</span> currentTimeMillis<span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// 标志立即执行刷盘</span>
                    flushPhysicQueueLeastPages <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// 执行十次打印一次刷盘进程</span>
                    printFlushProgress <span class="token operator">=</span> <span class="token punctuation">(</span>printTimes<span class="token operator">++</span> <span class="token operator">%</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 定时刷盘</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>flushCommitLogTimed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>interval<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// 默认是等待唤醒的方式</span>
                    <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">waitForRunning</span><span class="token punctuation">(</span>interval<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// 是否打印刷盘进程</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>printFlushProgress<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">printFlushProgress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">long</span> begin <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// 执行刷盘</span>
                    CommitLog<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileQueue<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span>flushPhysicQueueLeastPages<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">long</span> storeTimestamp <span class="token operator">=</span> CommitLog<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileQueue<span class="token punctuation">.</span><span class="token function">getStoreTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>storeTimestamp <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 设置刷盘检查点</span>
                        CommitLog<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getStoreCheckpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPhysicMsgTimestamp</span><span class="token punctuation">(</span>storeTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">long</span> past <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> begin<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>past <span class="token operator">></span> <span class="token number">500</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 打印刷盘进程</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 正常关闭，要保证退出前完成刷盘</span>
            <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 默认最多重试10次</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> RETRY_TIMES_OVER <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>result<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 刷盘</span>
                result <span class="token operator">=</span> CommitLog<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileQueue<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 打印刷盘进程</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">printFlushProgress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span></code></pre>
<hr>
<p>异步刷盘，使用缓冲池。</p>
<p>CommitLog$CommitRealTimeService#run</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 刷盘间隔，默认200毫秒</span>
                <span class="token keyword">int</span> interval <span class="token operator">=</span> CommitLog<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCommitIntervalCommitLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// CommitLog刷盘需要达到的最小页数，默认4</span>
                <span class="token keyword">int</span> commitDataLeastPages <span class="token operator">=</span> CommitLog<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCommitCommitLogLeastPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 默认200毫秒</span>
                <span class="token keyword">int</span> commitDataThoroughInterval <span class="token operator">=</span> CommitLog<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCommitCommitLogThoroughInterval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">long</span> begin <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 上次刷盘离现在已经超出刷盘间隔</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>begin <span class="token operator">>=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>lastCommitTimestamp <span class="token operator">+</span> commitDataThoroughInterval<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>lastCommitTimestamp <span class="token operator">=</span> begin<span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// 标记立即刷盘</span>
                    commitDataLeastPages <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 提交缓冲的数据到FileChannel</span>
                    <span class="token keyword">boolean</span> result <span class="token operator">=</span> CommitLog<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileQueue<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span>commitDataLeastPages<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">long</span> end <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// 说明有新的数据提交到FileChannel，需要刷盘</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>lastCommitTimestamp <span class="token operator">=</span> end<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// result = false means some data committed.</span>
                        <span class="token comment" spellcheck="true">// 唤醒刷盘线程</span>
                        flushCommitLogService<span class="token punctuation">.</span><span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token comment" spellcheck="true">// 等待唤醒或超时</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">waitForRunning</span><span class="token punctuation">(</span>interval<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 退出前先把缓冲提交到FileChannel，最多重试10次</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> RETRY_TIMES_OVER <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>result<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                result <span class="token operator">=</span> CommitLog<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileQueue<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span></code></pre>
<p>MappedFileQueue#commit</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">commit</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span> commitLeastPages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 获取对应的MappedFile</span>
        MappedFile mappedFile <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">findMappedFileByOffset</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>committedWhere<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>committedWhere <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mappedFile <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 返回提交到FileChannel的位置</span>
            <span class="token keyword">int</span> offset <span class="token operator">=</span> mappedFile<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span>commitLeastPages<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 本次提交的位置在整个文件队列的偏移</span>
            <span class="token keyword">long</span> where <span class="token operator">=</span> mappedFile<span class="token punctuation">.</span><span class="token function">getFileFromOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> offset<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 本次提交的位置等于上次提交位置，说明FileChannel不需要刷盘，否则说明有新提交的数据，需要刷盘</span>
            result <span class="token operator">=</span> where <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>committedWhere<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 更新提交位置</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>committedWhere <span class="token operator">=</span> where<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>MappedFile#commit</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * 数据先写到写缓冲，再Commit到FileChannel
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">commit</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span> commitLeastPages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 如果写缓冲为null，说明这个MappedFile已经不需要写入数据了</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>writeBuffer <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 不需要提交数据到FileChannel，写缓冲的WrotePosition就是CommittedPosition</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>wrotePosition<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 可以提交</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isAbleToCommit</span><span class="token punctuation">(</span>commitLeastPages<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 获取引用计数成功</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hold</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 提交到FileChannel</span>
                <span class="token function">commit0</span><span class="token punctuation">(</span>commitLeastPages<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 释放引用计数</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// MappedFile的大小等于缓冲提交到FileChannel的位置，说明文件已经写满</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>writeBuffer <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>transientStorePool <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fileSize <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>committedPosition<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 返还缓存到缓冲池</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>transientStorePool<span class="token punctuation">.</span><span class="token function">returnBuffer</span><span class="token punctuation">(</span>writeBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 置空写缓冲</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>writeBuffer <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 返回提交到FileChannel的位置</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>committedPosition<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>MappedFile#commit0</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">commit0</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span> commitLeastPages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 写缓冲写的位置</span>
        <span class="token keyword">int</span> writePos <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>wrotePosition<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 写缓冲上次提交到FileChannel的位置</span>
        <span class="token keyword">int</span> lastCommittedPosition <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>committedPosition<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 有新的数据需要提交到FileChannel</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>writePos <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>committedPosition<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 子缓冲，共用内存，指针独立</span>
                ByteBuffer byteBuffer <span class="token operator">=</span> writeBuffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 设置缓冲的读索引</span>
                byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span>lastCommittedPosition<span class="token punctuation">)</span><span class="token punctuation">;</span>
                byteBuffer<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>writePos<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 设置FileChannel的写索引</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>fileChannel<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span>lastCommittedPosition<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 将缓冲写入FileChannel</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>fileChannel<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 更新提交位置</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>committedPosition<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>writePos<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>这种方式的不同之处在于，之前的方式是将数据写入MappedByteBuffer，后台线程再执行刷盘，而这种方式是将数据写到一个堆外缓冲中，然后后台线程再将缓冲的数据写入FileChannel，需要提交的时候由另一个线程刷盘。</p>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


        <footer>
             
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

        </footer>
    </div>
    <!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
    <script>
        var timeEnd = new Date();
        console.log('耗时：' + (timeEnd - timeStart));
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre').forEach((block) => {
                block.classList.add("line-numbers");
            });
        });
    </script>

    <script src="/js/prism.js"></script>
</body>
</html>
