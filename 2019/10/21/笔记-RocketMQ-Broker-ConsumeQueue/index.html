<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
        <script>
            var timeStart = new Date();
        </script>
        
        <title>[ç¬”è®°]-RocketMQ-Broker-ConsumeQueue | ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜</title>
        
        <meta name="author" content="huangzhike">
        
        
        <meta name="description" content="DefaultMessageStore$ReputMessageService#run
        @Override
        public void run() {
            // ...
            while (!this.isStopped()) {
 ">
        
        
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        
        <meta property="og:title" content="[ç¬”è®°]-RocketMQ-Broker-ConsumeQueue"/>
        
        <meta property="og:site_name" content="ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜"/>
        
        
        <!-- favicon -->
        <link rel="icon" type="image/ico" href="/ok.ico" sizes="32x32">
        <meta name="msapplication-TileColor" content="#009688">
        <meta name="msapplication-TileImage" content="/mstile-144x144.ico">
        <meta name="theme-color" content="#009688">
        <!-- favicon end -->
        <!-- <link href="//ok.ico" rel="icon"> -->
        
        <!-- toc -->
        <!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
        <!-- material design -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
        <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
        
        <!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
        <!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
    <meta name="generator" content="Hexo 4.2.1"></head>

<body>
    <nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">èœå•</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" title="ä¸‹ä¸€å¥æ˜¯ï¼šå®¢æœ‰å¯äººæœŸä¸æ¥ã€‚å°æ—¶å€™ï¼Œå–œæ¬¢é åœ¨é˜³å°ä¸Šï¼Œä¸€è¾¹å¹é£ï¼Œä¸€è¾¹çœ‹ä¹¦ï¼Œå–œæ¬¢è¯»ä¹¦å—ï¼Œéªšå¹´ï¼Ÿ" href="/">ä¹¦å½“å¿«æ„è¯»æ˜“å°½</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" target="_blank" rel="noopener" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

    <div class="container" >
        <div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[ç¬”è®°]-RocketMQ-Broker-ConsumeQueue</h2>
				
				<div>
					<div class="post-time">2019-10-21</div>
				</div>
				
				<div class="article-content">
				<p>DefaultMessageStore$ReputMessageService#run</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ä¸€æ¯«ç§’</span>
                    Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// å®šæ—¶æ›´æ–°ConsumeQueue</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doReput</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span></code></pre>
<p>DefaultMessageStore$ReputMessageService#doReput</p>
<pre class=" language-java"><code class="language-java">        <span class="token comment" spellcheck="true">/**
         * ä»CommitLogè¯»å–æ¶ˆæ¯ï¼Œå°†æ¶ˆæ¯åç§»å†™åˆ°ConsumeQueueå’ŒIndexFileï¼Œç»™æ¶ˆè´¹è€…æ‹‰å–æ¶ˆæ¯ç”¨
         * ReputMessageServiceåˆ†å‘ç»™Dispatcherè´Ÿè´£Writeï¼Œè¿˜æœ‰ä¸€ä¸ªFlushConsumeQueueServiceè´Ÿè´£Flush
         */</span>
        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doReput</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è¯»å–çš„èµ·å§‹åç§»æ¯”å½“å‰çš„CommitLogæœ€å°åç§»è¿˜å°ï¼Œå¯èƒ½æ˜¯åˆ†å‘è½åå¤ªå¤šï¼ŒCommitLogè¢«æ¸…é™¤äº†</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reputFromOffset <span class="token operator">&lt;</span> DefaultMessageStore<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>commitLog<span class="token punctuation">.</span><span class="token function">getMinOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ä»æœ€å°åç§»å¼€å§‹è¯»</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>reputFromOffset <span class="token operator">=</span> DefaultMessageStore<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>commitLog<span class="token punctuation">.</span><span class="token function">getMinOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// CommitLogçš„æœ€å¤§åç§»æ¯”ReputMessageServiceä¸Šæ¬¡è¯»å–çš„åç§»å¤§ï¼Œåˆ™CommitLogå¯ç”¨</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">boolean</span> doNext <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isCommitLogAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> doNext<span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å¯ç”¨é‡å¤ï¼Œé»˜è®¤å…³é—­ &amp;&amp; å½“å‰å·²è¯»åç§»å¤§äºç­‰äºç¡®è®¤çš„åç§»</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>DefaultMessageStore<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isDuplicationEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reputFromOffset <span class="token operator">>=</span> DefaultMessageStore<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getConfirmOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// ä»ä¸Šæ¬¡ç»“æŸçš„åç§»å¼€å§‹è¯»å–CommitLogä¸­çš„å¯¹åº”çš„ByteBuffer</span>
                SelectMappedBufferResult result <span class="token operator">=</span> DefaultMessageStore<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>commitLog<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span>reputFromOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">//</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// æ›´æ–°Reputçš„èµ·å§‹å­—èŠ‚åç§»</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>reputFromOffset <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getStartOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// éå†æ¯ä¸ªæ¶ˆæ¯</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> readSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> readSize <span class="token operator">&lt;</span> result<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> doNext<span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å®Œæ•´ï¼Œå¤„ç†å»¶æ—¶æ¶ˆæ¯ï¼Œå¹¶å°è£…æ¶ˆæ¯ä¸ºDispatchRequest</span>
                            DispatchRequest dispatchRequest <span class="token operator">=</span> DefaultMessageStore<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>commitLog<span class="token punctuation">.</span><span class="token function">checkMessageAndReturnSize</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getByteBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// æ¶ˆæ¯é•¿åº¦</span>
                            <span class="token keyword">int</span> size <span class="token operator">=</span> dispatchRequest<span class="token punctuation">.</span><span class="token function">getBufferSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">?</span> dispatchRequest<span class="token punctuation">.</span><span class="token function">getMsgSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> dispatchRequest<span class="token punctuation">.</span><span class="token function">getBufferSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// æ¶ˆæ¯æ£€éªŒé€šè¿‡</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>dispatchRequest<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token comment" spellcheck="true">// æ˜¯æ¶ˆæ¯</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    <span class="token comment" spellcheck="true">// åˆ†å‘æ¶ˆæ¯åˆ°CommitLogDispatcherï¼Œæ„å»ºIndexï¼Œå¹¶æ›´æ–°ConsumeQueue</span>
                                    DefaultMessageStore<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doDispatch</span><span class="token punctuation">(</span>dispatchRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token comment" spellcheck="true">// å¦‚æœBrokeræ˜¯Master &amp;&amp; å¯ç”¨äº†é•¿è½®è¯¢</span>
                                    <span class="token keyword">if</span> <span class="token punctuation">(</span>BrokerRole<span class="token punctuation">.</span>SLAVE <span class="token operator">!=</span> DefaultMessageStore<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBrokerRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> DefaultMessageStore<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">isLongPollingEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                        <span class="token comment" spellcheck="true">// åˆ†å‘æ¶ˆæ¯åˆ°MessageArrivingListenerï¼Œå”¤é†’ç­‰å¾…çš„PullRequestæ¥æ”¶æ¶ˆæ¯</span>
                                        DefaultMessageStore<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>messageArrivingListener<span class="token punctuation">.</span><span class="token function">arriving</span><span class="token punctuation">(</span>dispatchRequest<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dispatchRequest<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dispatchRequest<span class="token punctuation">.</span><span class="token function">getConsumeQueueOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> dispatchRequest<span class="token punctuation">.</span><span class="token function">getTagsCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dispatchRequest<span class="token punctuation">.</span><span class="token function">getStoreTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dispatchRequest<span class="token punctuation">.</span><span class="token function">getBitMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dispatchRequest<span class="token punctuation">.</span><span class="token function">getPropertiesMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token punctuation">}</span>
                                    <span class="token comment" spellcheck="true">// ç´¯è®¡æ›´æ–°Reputçš„èµ·å§‹å­—èŠ‚åç§»</span>
                                    <span class="token keyword">this</span><span class="token punctuation">.</span>reputFromOffset <span class="token operator">+=</span> size<span class="token punctuation">;</span>
                                    readSize <span class="token operator">+=</span> size<span class="token punctuation">;</span>
                                    <span class="token comment" spellcheck="true">// å¦‚æœBrokeræ˜¯Slaveï¼Œç»Ÿè®¡</span>
                                    <span class="token keyword">if</span> <span class="token punctuation">(</span>DefaultMessageStore<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBrokerRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> BrokerRole<span class="token punctuation">.</span>SLAVE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                        <span class="token comment" spellcheck="true">// ...</span>
                                    <span class="token punctuation">}</span>
                                <span class="token punctuation">}</span>
                                <span class="token comment" spellcheck="true">// æ˜¯BLANKï¼Œè¯»åˆ°äº†MappedFileæ–‡ä»¶å°¾</span>
                                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    <span class="token comment" spellcheck="true">// æ¢åˆ°æ–°æ–‡ä»¶</span>
                                    <span class="token keyword">this</span><span class="token punctuation">.</span>reputFromOffset <span class="token operator">=</span> DefaultMessageStore<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>commitLog<span class="token punctuation">.</span><span class="token function">rollNextFile</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reputFromOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    readSize <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span>
                            <span class="token comment" spellcheck="true">// æ£€éªŒæ¶ˆæ¯å‡ºé”™ï¼Œå¯èƒ½æ˜¯CommitLogæ–‡ä»¶æŸå</span>
                            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dispatchRequest<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token comment" spellcheck="true">// æ¶ˆæ¯</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    <span class="token comment" spellcheck="true">// è·³è¿‡</span>
                                    <span class="token keyword">this</span><span class="token punctuation">.</span>reputFromOffset <span class="token operator">+=</span> size<span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                                <span class="token comment" spellcheck="true">// ç©ºç™½å¡«å……</span>
                                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                                    <span class="token comment" spellcheck="true">// ...</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// é‡Šæ”¾MappedFileçš„å¼•ç”¨è®¡æ•°</span>
                        <span class="token comment" spellcheck="true">// é€šè¿‡CommitLogè¯»å–æ¶ˆæ¯æ—¶ï¼Œä¸ä¼šæŠŠæ¶ˆæ¯å¤åˆ¶åˆ°å †å†…å­˜ä¸­ï¼Œåªæ˜¯è¿”å›æ˜ å°„çš„ç¼“å†²</span>
                        result<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    doNext <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span></code></pre>
<p>CommitLog#checkMessageAndReturnSize</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> DispatchRequest <span class="token function">checkMessageAndReturnSize</span><span class="token punctuation">(</span>java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>ByteBuffer byteBuffer<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> checkCRC<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> readBody<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ¶ˆæ¯æ€»é•¿åº¦ï¼Œ4å­—èŠ‚</span>
            <span class="token keyword">int</span> totalSize <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ¶ˆæ¯çš„é­”æ•°ï¼Œ4å­—èŠ‚</span>
            <span class="token keyword">int</span> magicCode <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>magicCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æ­£å¸¸æ¶ˆæ¯çš„é­”æ•°</span>
                <span class="token keyword">case</span> MESSAGE_MAGIC_CODE<span class="token operator">:</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ç©ºç™½çš„é­”æ•°ï¼Œè¯´æ˜åˆ°äº†æ–‡ä»¶æœ«å°¾ï¼Œè¿”å›sizeä¸º0ï¼Œé‡ç½®reputFromOffset</span>
                <span class="token keyword">case</span> BLANK_MAGIC_CODE<span class="token operator">:</span>
                    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DispatchRequest</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">/* success */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// éæ³•</span>
                <span class="token keyword">default</span><span class="token operator">:</span>
                    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DispatchRequest</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/* success */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytesContent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span>totalSize<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ¶ˆæ¯ä½“CRCæ ¡éªŒï¼Œ4å­—èŠ‚</span>
            <span class="token keyword">int</span> bodyCRC <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ¶ˆæ¯æ‰€åœ¨ConsumeQueueçš„Idï¼Œ4å­—èŠ‚</span>
            <span class="token keyword">int</span> queueId <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ ‡è®°ï¼Œ4å­—èŠ‚</span>
            <span class="token keyword">int</span> flag <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ¶ˆæ¯åœ¨ConsumeQueueçš„ä½ç½®åç§»ï¼Œ8å­—èŠ‚</span>
            <span class="token keyword">long</span> queueOffset <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ¶ˆæ¯åœ¨CommitLogçš„ç‰©ç†åç§»ï¼Œ8å­—èŠ‚</span>
            <span class="token keyword">long</span> physicOffset <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ç³»ç»Ÿæ ‡è®°ï¼Œ4å­—èŠ‚</span>
            <span class="token keyword">int</span> sysFlag <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å‡ºç”Ÿæ—¶é—´æˆ³ï¼Œ8å­—èŠ‚</span>
            <span class="token keyword">long</span> bornTimeStamp <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ç”Ÿäº§çš„Brokeråœ°å€ï¼ŒåŒ…æ‹¬IPå’Œç«¯å£ï¼Œ8å­—èŠ‚</span>
            ByteBuffer byteBuffer1 <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>bytesContent<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å­˜å‚¨æ—¶é—´æˆ³ï¼Œ8å­—èŠ‚</span>
            <span class="token keyword">long</span> storeTimestamp <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å­˜å‚¨çš„Brokeråœ°å€ï¼ŒåŒ…æ‹¬IPå’Œç«¯å£ï¼Œ8å­—èŠ‚</span>
            ByteBuffer byteBuffer2 <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>bytesContent<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// é‡æ¶ˆè´¹æ¬¡æ•°ï¼Œ4å­—èŠ‚</span>
            <span class="token keyword">int</span> reconsumeTimes <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">long</span> preparedTransactionOffset <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ¶ˆæ¯ä½“é•¿åº¦ï¼Œ4å­—èŠ‚</span>
            <span class="token keyword">int</span> bodyLen <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>bodyLen <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å¦‚æœè¯»å–æ¶ˆæ¯ä½“</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>readBody<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ä»ç¼“å†²è¯»å–æ¶ˆæ¯ä½“å­—èŠ‚åˆ°æ•°ç»„</span>
                    byteBuffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>bytesContent<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> bodyLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// å¦‚æœæ ¡éªŒCRC</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>checkCRC<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// ä¸è¯»å–æ¶ˆæ¯ä½“</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// è¯»æŒ‡é’ˆè·³è¿‡æ¶ˆæ¯ä½“</span>
                    byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> bodyLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// Topicé•¿åº¦ï¼Œ1å­—èŠ‚</span>
            <span class="token keyword">byte</span> topicLen <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            byteBuffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>bytesContent<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> topicLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// Topic</span>
            String topic <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>bytesContent<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> topicLen<span class="token punctuation">,</span> MessageDecoder<span class="token punctuation">.</span>CHARSET_UTF8<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">long</span> tagsCode <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// Propertiesé•¿åº¦ï¼Œ2å­—èŠ‚</span>
            <span class="token keyword">short</span> propertiesLength <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">getShort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> propertiesMap <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>propertiesLength <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                byteBuffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>bytesContent<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> propertiesLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// Properties</span>
                String properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>bytesContent<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> propertiesLength<span class="token punctuation">,</span> MessageDecoder<span class="token punctuation">.</span>CHARSET_UTF8<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ...</span>
                String tags <span class="token operator">=</span> propertiesMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>MessageConst<span class="token punctuation">.</span>PROPERTY_TAGS<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>tags <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> tags<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// TagsCode</span>
                    tagsCode <span class="token operator">=</span> MessageExtBrokerInner<span class="token punctuation">.</span><span class="token function">tagsString2tagsCode</span><span class="token punctuation">(</span>MessageExt<span class="token punctuation">.</span><span class="token function">parseTopicFilterType</span><span class="token punctuation">(</span>sysFlag<span class="token punctuation">)</span><span class="token punctuation">,</span> tags<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// å¤„ç†å»¶æ—¶æ¶ˆæ¯</span>
                <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å»¶æ—¶çº§åˆ«</span>
                    String t <span class="token operator">=</span> propertiesMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>MessageConst<span class="token punctuation">.</span>PROPERTY_DELAY_TIME_LEVEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// å¦‚æœæ˜¯å»¶æ—¶æ¶ˆæ¯</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>ScheduleMessageService<span class="token punctuation">.</span>SCHEDULE_TOPIC<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> t <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">int</span> delayLevel <span class="token operator">=</span> Integer<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// æ£€æŸ¥ï¼Œå¦‚æœå¤§äºæœ€å¤§çš„å»¶æ—¶çº§åˆ«</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>delayLevel <span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getScheduleMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxDelayLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            delayLevel <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getScheduleMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxDelayLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>delayLevel <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// è®¡ç®—å»¶è¿Ÿæ¶ˆæ¯åº”è¯¥è¢«æŠ•é€’çš„æ—¶é—´ï¼Œè¦†ç›–åŸæœ‰çš„TagsCode</span>
                            tagsCode <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getScheduleMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">computeDeliverTimestamp</span><span class="token punctuation">(</span>delayLevel<span class="token punctuation">,</span> storeTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">int</span> readLength <span class="token operator">=</span> <span class="token function">calMsgLength</span><span class="token punctuation">(</span>bodyLen<span class="token punctuation">,</span> topicLen<span class="token punctuation">,</span> propertiesLength<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>totalSize <span class="token operator">!=</span> readLength<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å°è£…æ¶ˆæ¯ï¼Œè¿”å›DispatchRequest</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DispatchRequest</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> physicOffset<span class="token punctuation">,</span> totalSize<span class="token punctuation">,</span> tagsCode<span class="token punctuation">,</span> storeTimestamp<span class="token punctuation">,</span> queueOffset<span class="token punctuation">,</span> keys<span class="token punctuation">,</span> uniqKey<span class="token punctuation">,</span> sysFlag<span class="token punctuation">,</span> preparedTransactionOffset<span class="token punctuation">,</span> propertiesMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DispatchRequest</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">/* success */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>DefaultMessageStore#doDispatch</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doDispatch</span><span class="token punctuation">(</span>DispatchRequest req<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>CommitLogDispatcher dispatcher <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dispatcherList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            dispatcher<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>Indexç›¸å…³è¿™é‡Œå…ˆç•¥è¿‡ã€‚</p>
<p>DefaultMessageStore$CommitLogDispatcherBuildConsumeQueue#dispatch</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">class</span> <span class="token class-name">CommitLogDispatcherBuildConsumeQueue</span> <span class="token keyword">implements</span> <span class="token class-name">CommitLogDispatcher</span> <span class="token punctuation">{</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">dispatch</span><span class="token punctuation">(</span>DispatchRequest request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> tranType <span class="token operator">=</span> MessageSysFlag<span class="token punctuation">.</span><span class="token function">getTransactionValue</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getSysFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>tranType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// éäº‹åŠ¡æ¶ˆæ¯</span>
                <span class="token keyword">case</span> MessageSysFlag<span class="token punctuation">.</span>TRANSACTION_NOT_TYPE<span class="token operator">:</span>
                    <span class="token comment" spellcheck="true">// Commitå‹äº‹åŠ¡æ¶ˆæ¯</span>
                <span class="token keyword">case</span> MessageSysFlag<span class="token punctuation">.</span>TRANSACTION_COMMIT_TYPE<span class="token operator">:</span>
                    <span class="token comment" spellcheck="true">// åŠ åˆ°ConsumeQueueç»™Consumeræ¶ˆè´¹</span>
                    DefaultMessageStore<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">putMessagePositionInfo</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// Preparedå’ŒRollbackå‹æ¶ˆæ¯ä¸ç»™æ¶ˆè´¹</span>
                <span class="token keyword">case</span> MessageSysFlag<span class="token punctuation">.</span>TRANSACTION_PREPARED_TYPE<span class="token operator">:</span>
                <span class="token keyword">case</span> MessageSysFlag<span class="token punctuation">.</span>TRANSACTION_ROLLBACK_TYPE<span class="token operator">:</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span></code></pre>
<p>DefaultMessageStore#putMessagePositionInfo</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">putMessagePositionInfo</span><span class="token punctuation">(</span>DispatchRequest dispatchRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// æ ¹æ®Topicå’ŒQueueIdè·å–ConsumeQueue</span>
        ConsumeQueue cq <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">findConsumeQueue</span><span class="token punctuation">(</span>dispatchRequest<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dispatchRequest<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æŠŠæ¶ˆæ¯çš„ä½ç½®ä¿¡æ¯åŠ å…¥ConsumeQueue</span>
        cq<span class="token punctuation">.</span><span class="token function">putMessagePositionInfoWrapper</span><span class="token punctuation">(</span>dispatchRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ConsumeQueue#putMessagePositionInfoWrapper</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">putMessagePositionInfoWrapper</span><span class="token punctuation">(</span>DispatchRequest request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// æœ€å¤§é‡è¯•30æ¬¡</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> maxRetries <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ConsumerQueueæ˜¯å¦å¯å†™</span>
        <span class="token keyword">boolean</span> canWrite <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getRunningFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isCQWriteable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// é‡è¯•</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> maxRetries <span class="token operator">&amp;&amp;</span> canWrite<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">long</span> tagsCode <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getTagsCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å¦‚æœå…è®¸å†™Extæ–‡ä»¶ï¼Œé»˜è®¤ä¸å…è®¸</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isExtWriteEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å†™å…¥ConsumerQueue</span>
            <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">putMessagePositionInfo</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getCommitLogOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getMsgSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tagsCode<span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getConsumeQueueOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å†™å…¥æˆåŠŸ</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// è®¾ç½®StoreCheckpointä¸ºæ¶ˆæ¯å­˜å‚¨æ—¶é—´</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getStoreCheckpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setLogicsMsgTimestamp</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getStoreTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ä¸æˆåŠŸå°±å…ˆä¼‘çœ 1ç§’</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ...</span>
    <span class="token punctuation">}</span></code></pre>
<p>ConsumeQueue#putMessagePositionInfo</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">putMessagePositionInfo</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">long</span> offset<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> size<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> tagsCode<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> cqOffset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// æ¶ˆæ¯åœ¨CommitLogçš„åç§» + æ¶ˆæ¯å¤§å° &lt; å½“å‰ConsumeQueueè®°å½•çš„æœ€å¤§ç‰©ç†åç§»</span>
        <span class="token comment" spellcheck="true">// è¯´æ˜å·²å†™è¿‡</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>offset <span class="token operator">+</span> size <span class="token operator">&lt;=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>maxPhysicOffset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// é‡ç½®å†™ç´¢å¼•</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>byteBufferIndex<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ConsumeQueueå•å…ƒçš„å¤§å°ï¼Œ20å­—èŠ‚</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>byteBufferIndex<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>CQ_STORE_UNIT_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ¶ˆæ¯åœ¨CommitLogçš„åç§»ï¼Œ8å­—èŠ‚</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>byteBufferIndex<span class="token punctuation">.</span><span class="token function">putLong</span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ¶ˆæ¯å¤§å°ï¼Œ4å­—èŠ‚</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>byteBufferIndex<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// TagsCodeï¼Œ8å­—èŠ‚</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>byteBufferIndex<span class="token punctuation">.</span><span class="token function">putLong</span><span class="token punctuation">(</span>tagsCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ¶ˆæ¯åœ¨ConsumeQueueæœŸå¾…çš„å­—èŠ‚åç§» = æ¶ˆæ¯åœ¨ConsumeQueueçš„åºå· * ConsumeQueueå•å…ƒå¤§å°</span>
        <span class="token comment" spellcheck="true">// å…¶ä¸­æ¶ˆæ¯åœ¨ConsumeQueueçš„åºå·æ˜¯åœ¨åŠ å…¥CommitLogæ—¶å°±å·²ç»ç¡®å®šçš„</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> expectLogicOffset <span class="token operator">=</span> cqOffset <span class="token operator">*</span> CQ_STORE_UNIT_SIZE<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ ¹æ®æœŸå¾…åç§»ï¼Œè·å–æœ€åä¸€ä¸ªMappedFileæ–‡ä»¶</span>
        MappedFile mappedFile <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileQueue<span class="token punctuation">.</span><span class="token function">getLastMappedFile</span><span class="token punctuation">(</span>expectLogicOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mappedFile <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ä¹‹å‰MappedFileé˜Ÿåˆ—ä¸ºç©ºï¼Œæ–°åˆ›å»ºçš„MappedFile &amp;&amp; æ¶ˆæ¯ä¸æ˜¯ConsumeQueueé˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ª &amp;&amp; MappedFileæœªå†™å…¥</span>
            <span class="token comment" spellcheck="true">// å¯èƒ½æ˜¯Topicæœ‰å¾ˆé•¿æ—¶é—´ä¸€ç›´æ²¡æœ‰æ¶ˆæ¯ï¼Œå¯¹åº”çš„æ–‡ä»¶å·²è¢«æ¸…ç†ï¼Œåæ¥Topicçªç„¶äº§ç”Ÿäº†æ–°æ¶ˆæ¯ï¼Ÿ</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mappedFile<span class="token punctuation">.</span><span class="token function">isFirstCreateInQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> cqOffset <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> mappedFile<span class="token punctuation">.</span><span class="token function">getWrotePosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>minLogicOffset <span class="token operator">=</span> expectLogicOffset<span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileQueue<span class="token punctuation">.</span><span class="token function">setFlushedWhere</span><span class="token punctuation">(</span>expectLogicOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileQueue<span class="token punctuation">.</span><span class="token function">setCommittedWhere</span><span class="token punctuation">(</span>expectLogicOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ç”¨ç©ºç™½å ä½ç¬¦å¡«å……å‰é¢çš„ç©ºé—´</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fillPreBlank</span><span class="token punctuation">(</span>mappedFile<span class="token punctuation">,</span> expectLogicOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// æ¶ˆæ¯ä¸æ˜¯ConsumeQueueé˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªæ¶ˆæ¯</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cqOffset <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å½“å‰ConsumeQueueå­—èŠ‚åç§» = MappedFileçš„å†™åç§» + MappedFileçš„èµ·å§‹åç§»</span>
                <span class="token keyword">long</span> currentLogicOffset <span class="token operator">=</span> mappedFile<span class="token punctuation">.</span><span class="token function">getWrotePosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> mappedFile<span class="token punctuation">.</span><span class="token function">getFileFromOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// æœ¬æ¬¡æ¶ˆæ¯çš„æœŸå¾…åç§» &lt; å½“å‰åç§»</span>
                <span class="token comment" spellcheck="true">// è¯´æ˜å·²ç»åŠ å…¥è¿‡äº†</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>expectLogicOffset <span class="token operator">&lt;</span> currentLogicOffset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// æœ¬æ¬¡æ¶ˆæ¯çš„æœŸå¾…åç§» > å½“å‰åç§»</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>expectLogicOffset <span class="token operator">!=</span> currentLogicOffset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// è®°å½•ConsumeQueueçš„æ¶ˆæ¯åœ¨CommitLogçš„æœ€å¤§åç§»</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>maxPhysicOffset <span class="token operator">=</span> offset <span class="token operator">+</span> size<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å†™å…¥MappedFile</span>
            <span class="token keyword">return</span> mappedFile<span class="token punctuation">.</span><span class="token function">appendMessage</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>byteBufferIndex<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>NotifyMessageArrivingListener#arriving</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">arriving</span><span class="token punctuation">(</span>String topic<span class="token punctuation">,</span> <span class="token keyword">int</span> queueId<span class="token punctuation">,</span> <span class="token keyword">long</span> logicOffset<span class="token punctuation">,</span> <span class="token keyword">long</span> tagsCode<span class="token punctuation">,</span> <span class="token keyword">long</span> msgStoreTime<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> filterBitMap<span class="token punctuation">,</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> properties<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// é€šçŸ¥PullRequestHoldServiceéå†PullRequestï¼Œé‡æ–°æ‰§è¡Œæ¶ˆæ¯æ‹‰å–</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>pullRequestHoldService<span class="token punctuation">.</span><span class="token function">notifyMessageArriving</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> logicOffset<span class="token punctuation">,</span> tagsCode<span class="token punctuation">,</span> msgStoreTime<span class="token punctuation">,</span> filterBitMap<span class="token punctuation">,</span> properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>ConsumeQueueåˆ·ç›˜</p>
<p>DefaultMessageStore$FlushConsumeQueueService#doFlush</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doFlush</span><span class="token punctuation">(</span><span class="token keyword">int</span> retryTimes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// é»˜è®¤2</span>
            <span class="token keyword">int</span> flushConsumeQueueLeastPages <span class="token operator">=</span> DefaultMessageStore<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFlushConsumeQueueLeastPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å…³é—­æ—¶ä¼ å…¥</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>retryTimes <span class="token operator">==</span> RETRY_TIMES_OVER<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å¼ºåˆ¶Flush</span>
                flushConsumeQueueLeastPages <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">long</span> logicsMsgTimestamp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// é»˜è®¤60ç§’</span>
            <span class="token keyword">int</span> flushConsumeQueueThoroughInterval <span class="token operator">=</span> DefaultMessageStore<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFlushConsumeQueueThoroughInterval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">long</span> currentTimeMillis <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ç¦»ä¸Šæ¬¡åˆ·ç›˜æ—¶é—´è¶…å‡ºäº†é—´éš”</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>currentTimeMillis <span class="token operator">>=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>lastFlushTimestamp <span class="token operator">+</span> flushConsumeQueueThoroughInterval<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æ›´æ–°åˆ·ç›˜æ—¶é—´æˆ³</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>lastFlushTimestamp <span class="token operator">=</span> currentTimeMillis<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å¼ºåˆ¶Flush</span>
                flushConsumeQueueLeastPages <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// æ›´æ–°æ£€æŸ¥ç‚¹</span>
                logicsMsgTimestamp <span class="token operator">=</span> DefaultMessageStore<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getStoreCheckpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLogicsMsgTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            ConcurrentMap<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> ConcurrentMap<span class="token operator">&lt;</span>Integer<span class="token punctuation">,</span> ConsumeQueue<span class="token operator">>></span> tables <span class="token operator">=</span> DefaultMessageStore<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>consumeQueueTable<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// éå†Topic</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>ConcurrentMap<span class="token operator">&lt;</span>Integer<span class="token punctuation">,</span> ConsumeQueue<span class="token operator">></span> maps <span class="token operator">:</span> tables<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// éå†ConsumeQueue</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>ConsumeQueue cq <span class="token operator">:</span> maps<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> retryTimes <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>result<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// åˆ·ç›˜</span>
                        result <span class="token operator">=</span> cq<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span>flushConsumeQueueLeastPages<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å¦‚æœæ˜¯å¼ºåˆ¶åˆ·ç›˜</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> flushConsumeQueueLeastPages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>logicsMsgTimestamp <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    DefaultMessageStore<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getStoreCheckpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setLogicsMsgTimestamp</span><span class="token punctuation">(</span>logicsMsgTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// æ£€æŸ¥ç‚¹ä¹Ÿè¦åˆ·ç›˜</span>
                DefaultMessageStore<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getStoreCheckpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span></code></pre>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


        <footer>
             
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

        </footer>
    </div>
    <!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
    <script>
        var timeEnd = new Date();
        console.log('è€—æ—¶ï¼š' + (timeEnd - timeStart));
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre').forEach((block) => {
                block.classList.add("line-numbers");
            });
        });
    </script>
    <!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
    <!-- material design -->
    <!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
    <!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
    <!-- toc -->
    <!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
    <!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
    <!-- <script src="/js/main.js"></script> -->
    <script src="/js/prism.js"></script>
</body>
</html>
