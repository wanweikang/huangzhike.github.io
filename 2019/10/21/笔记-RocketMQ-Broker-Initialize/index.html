<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
        <script>
            var timeStart = new Date();
        </script>
        
        <title>[笔记]-RocketMQ-Broker-Initialize | 学而时习之</title>
        
        <meta name="author" content="Huangzhike">
        
        
        <meta name="description" content="K.I.S.S">
        
        
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        
        <meta property="og:title" content="[笔记]-RocketMQ-Broker-Initialize"/>
        
        <meta property="og:site_name" content="学而时习之"/>
        
        
        <!-- favicon -->
        <link rel="icon" type="image/ico" href="/ok.ico" sizes="32x32">
        <meta name="msapplication-TileColor" content="#009688">
        <meta name="msapplication-TileImage" content="/mstile-144x144.ico">
        <meta name="theme-color" content="#009688">
        <!-- favicon end -->
        <!-- <link href="//ok.ico" rel="icon"> -->
        
        <!-- toc -->
        <!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
        <!-- material design -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
        <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
        
        <!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
        <!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
    <meta name="generator" content="Hexo 4.2.1"></head>

<body>
    <nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">菜单</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" href="/">学而时习之</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" target="_blank" rel="noopener" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

    <div class="container" >
        <div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[笔记]-RocketMQ-Broker-Initialize</h2>
				
				<div>
					<div class="post-time">2019-10-21</div>
				</div>
				
				<div class="article-content">
				<p>BrokerController</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token function">BrokerController</span><span class="token punctuation">(</span><span class="token keyword">final</span> BrokerConfig brokerConfig<span class="token punctuation">,</span> <span class="token keyword">final</span> NettyServerConfig nettyServerConfig<span class="token punctuation">,</span> <span class="token keyword">final</span> NettyClientConfig nettyClientConfig<span class="token punctuation">,</span> <span class="token keyword">final</span> MessageStoreConfig messageStoreConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// 创建一些内置Topic</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>topicConfigManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TopicConfigManager</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
    <span class="token punctuation">}</span></code></pre>
<p>TopicConfigManager</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token function">TopicConfigManager</span><span class="token punctuation">(</span>BrokerController brokerController<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController <span class="token operator">=</span> brokerController<span class="token punctuation">;</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// MixAll.SELF_TEST_TOPIC</span>
            <span class="token comment" spellcheck="true">// 创建一个自我测试主题SELF_TEST_TOPIC</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// MixAll.AUTO_CREATE_TOPIC_KEY_TOPIC</span>
            <span class="token comment" spellcheck="true">// 如果允许自动创建Topic，添加一个默认的主题TBW102</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAutoCreateTopicEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                String topic <span class="token operator">=</span> MixAll<span class="token punctuation">.</span>AUTO_CREATE_TOPIC_KEY_TOPIC<span class="token punctuation">;</span>
                TopicConfig topicConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TopicConfig</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>systemTopicList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 默认8</span>
                topicConfig<span class="token punctuation">.</span><span class="token function">setReadQueueNums</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDefaultTopicQueueNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 默认8</span>
                topicConfig<span class="token punctuation">.</span><span class="token function">setWriteQueueNums</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDefaultTopicQueueNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> perm <span class="token operator">=</span> PermName<span class="token punctuation">.</span>PERM_INHERIT <span class="token operator">|</span> PermName<span class="token punctuation">.</span>PERM_READ <span class="token operator">|</span> PermName<span class="token punctuation">.</span>PERM_WRITE<span class="token punctuation">;</span>
                topicConfig<span class="token punctuation">.</span><span class="token function">setPerm</span><span class="token punctuation">(</span>perm<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>topicConfigTable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>topicConfig<span class="token punctuation">.</span><span class="token function">getTopicName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> topicConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// MixAll.BENCHMARK_TOPIC</span>
            <span class="token comment" spellcheck="true">// 创建一个跑分主题BenchmarkTest</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 创建一个Broker集群名主题，默认DefaultCluster</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 创建一个Broker名主题，默认为Broker所在的主机名</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// MixAll.OFFSET_MOVED_EVENT</span>
            <span class="token comment" spellcheck="true">// 创建一个OFFSET_MOVED_EVENT主题</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// MixAll.RMQ_SYS_TRACE_TOPIC</span>
            <span class="token comment" spellcheck="true">// 如果Broker启用了主题跟踪，创建一个RMQ_SYS_TRACE_TOPIC主题，默认不启用</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>BrokerController#initialize</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> CloneNotSupportedException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Broker启动时不从NameServer请求Topic配置，从本地JSON文件加载，默认${user.home}/store/config/topics.json</span>
        <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>topicConfigManager<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 从本地文件加载Consumer的消费进度偏移，默认${user.home}/store/config/consumerOffset.json</span>
        result <span class="token operator">=</span> result <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>consumerOffsetManager<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 从本地文件加载订阅组，默认${user.home}/store/config/subscriptionGroup.json</span>
        result <span class="token operator">=</span> result <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>subscriptionGroupManager<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 默认${user.home}/store/config/consumerFilter.json</span>
        result <span class="token operator">=</span> result <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>consumerFilterManager<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 用于管理消息存储等</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>messageStore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMessageStore</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messageStoreConfig<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerStatsManager<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>messageArrivingListener<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 默认不启用</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>messageStoreConfig<span class="token punctuation">.</span><span class="token function">isEnableDLegerCommitLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    DLedgerRoleChangeHandler roleChangeHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DLedgerRoleChangeHandler</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>DefaultMessageStore<span class="token punctuation">)</span> messageStore<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">(</span><span class="token punctuation">(</span>DLedgerCommitLog<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>DefaultMessageStore<span class="token punctuation">)</span> messageStore<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCommitLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getdLedgerServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getdLedgerLeaderElector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addRoleChangeHandler</span><span class="token punctuation">(</span>roleChangeHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 用于统计数据</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>brokerStats <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BrokerStats</span><span class="token punctuation">(</span><span class="token punctuation">(</span>DefaultMessageStore<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>messageStore<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 上下文</span>
                MessageStorePluginContext context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageStorePluginContext</span><span class="token punctuation">(</span>messageStoreConfig<span class="token punctuation">,</span> brokerStatsManager<span class="token punctuation">,</span> messageArrivingListener<span class="token punctuation">,</span> brokerConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 包装MessageStore，没发现有什么用，直接忽略</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>messageStore <span class="token operator">=</span> MessageStoreFactory<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>messageStore<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>messageStore<span class="token punctuation">.</span><span class="token function">getDispatcherList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addFirst</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CommitLogDispatcherCalcBitMap</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>consumerFilterManager<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 从持久化文件加载CommitLog、ConsumeQueue、IndexFile，并恢复进度</span>
        result <span class="token operator">=</span> result <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>messageStore<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 远程通讯服务器，ClientHousekeepingService监听通道变化，处理Producer和Consumer的连接存活情况</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>remotingServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NettyRemotingServer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>nettyServerConfig<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clientHousekeepingService<span class="token punctuation">)</span><span class="token punctuation">;</span>
            NettyServerConfig fastConfig <span class="token operator">=</span> <span class="token punctuation">(</span>NettyServerConfig<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>nettyServerConfig<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// VIP通道，不处理Consumer的PullRequest</span>
            fastConfig<span class="token punctuation">.</span><span class="token function">setListenPort</span><span class="token punctuation">(</span>nettyServerConfig<span class="token punctuation">.</span><span class="token function">getListenPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 远程通讯服务器，和上面的共用业务处理器和业务线程池，只是端口和IO线程池不一样</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>fastRemotingServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NettyRemotingServer</span><span class="token punctuation">(</span>fastConfig<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clientHousekeepingService<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 处理Producer消息的线程池</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>sendMessageExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BrokerFixedThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getSendMessageThreadPoolNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getSendMessageThreadPoolNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sendThreadPoolQueue<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryImpl</span><span class="token punctuation">(</span><span class="token string">"SendMessageThread_"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 处理Consumer消息的线程池</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>pullMessageExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BrokerFixedThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getPullMessageThreadPoolNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getPullMessageThreadPoolNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pullThreadPoolQueue<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryImpl</span><span class="token punctuation">(</span><span class="token string">"PullMessageThread_"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 处理消息查询的线程池</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>queryMessageExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BrokerFixedThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getQueryMessageThreadPoolNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getQueryMessageThreadPoolNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>queryThreadPoolQueue<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryImpl</span><span class="token punctuation">(</span><span class="token string">"QueryMessageThread_"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 处理Broker管理的线程池</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>adminBrokerExecutor <span class="token operator">=</span> Executors<span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getAdminBrokerThreadPoolNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryImpl</span><span class="token punctuation">(</span><span class="token string">"AdminBrokerThread_"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 处理Client管理的线程池</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>clientManageExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getClientManageThreadPoolNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getClientManageThreadPoolNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clientManagerThreadPoolQueue<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryImpl</span><span class="token punctuation">(</span><span class="token string">"ClientManageThread_"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 处理心跳的线程池</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>heartbeatExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BrokerFixedThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getHeartbeatThreadPoolNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getHeartbeatThreadPoolNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>heartbeatThreadPoolQueue<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryImpl</span><span class="token punctuation">(</span><span class="token string">"HeartbeatThread_"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 处理事务的线程池</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>endTransactionExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BrokerFixedThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getEndTransactionThreadPoolNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getEndTransactionThreadPoolNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>endTransactionThreadPoolQueue<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryImpl</span><span class="token punctuation">(</span><span class="token string">"EndTransactionThread_"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 处理Consumer管理的线程池</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>consumerManageExecutor <span class="token operator">=</span> Executors<span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getConsumerManageThreadPoolNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryImpl</span><span class="token punctuation">(</span><span class="token string">"ConsumerManageThread_"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 注册消息处理器，及处理的线程池</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// 计划任务，每日一次，打印Broker统计数据相关</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// 计划任务，每五秒一次，持久化Consumer消费偏移</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// 计划任务，每十秒一次，持久化ConsumerFilter</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// 计划任务，每三分钟一次，如果Consumer消费延时太大，禁用该Consumer，不再向它投递消息</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// 计划任务，每一秒一次，打印生产消费队列信息</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// 计划任务，每分钟一次，打印Dispatch落后情况</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// 如果系统变量、环境变量、程序指定了NameServer地址</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getNamesrvAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 更新本地NameServer地址列表缓存</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>brokerOuterAPI<span class="token punctuation">.</span><span class="token function">updateNameServerAddressList</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getNamesrvAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 没有指定NameServer地址，如果设置从远程获取NameServer地址</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">isFetchNamesrvAddrByAddressServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 计划任务，每两分钟一次，从指定的HTTP接口更新NameServer地址信息</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>scheduledExecutorService<span class="token punctuation">.</span><span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        BrokerController<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerOuterAPI<span class="token punctuation">.</span><span class="token function">fetchNameServerAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 默认</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>messageStoreConfig<span class="token punctuation">.</span><span class="token function">isEnableDLegerCommitLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// SLAVE</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>BrokerRole<span class="token punctuation">.</span>SLAVE <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>messageStoreConfig<span class="token punctuation">.</span><span class="token function">getBrokerRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 配置了高可用Master地址</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messageStoreConfig<span class="token punctuation">.</span><span class="token function">getHaMasterAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>messageStoreConfig<span class="token punctuation">.</span><span class="token function">getHaMasterAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 更新本地Master地址缓存</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>messageStore<span class="token punctuation">.</span><span class="token function">updateHaMasterAddress</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messageStoreConfig<span class="token punctuation">.</span><span class="token function">getHaMasterAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// 不需要周期性更新Master地址</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>updateMasterHAServerAddrPeriodically <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>updateMasterHAServerAddrPeriodically <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// MASTER</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 计划任务，打印Slave落后的信息Diff</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>TlsSystemConfig<span class="token punctuation">.</span>tlsMode <span class="token operator">!=</span> TlsMode<span class="token punctuation">.</span>DISABLED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 初始化事务消息服务</span>
            <span class="token function">initialTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// Access Control List</span>
            <span class="token function">initialAcl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 注册一些钩子</span>
            <span class="token function">initialRpcHooks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>DefaultMessageStore</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token function">DefaultMessageStore</span><span class="token punctuation">(</span><span class="token keyword">final</span> MessageStoreConfig messageStoreConfig<span class="token punctuation">,</span> <span class="token keyword">final</span> BrokerStatsManager brokerStatsManager<span class="token punctuation">,</span> <span class="token keyword">final</span> MessageArrivingListener messageArrivingListener<span class="token punctuation">,</span> <span class="token keyword">final</span> BrokerConfig brokerConfig<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 消息到达监听器</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>messageArrivingListener <span class="token operator">=</span> messageArrivingListener<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig <span class="token operator">=</span> brokerConfig<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>messageStoreConfig <span class="token operator">=</span> messageStoreConfig<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Broker统计管理</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>brokerStatsManager <span class="token operator">=</span> brokerStatsManager<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>allocateMappedFileService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AllocateMappedFileService</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>messageStoreConfig<span class="token punctuation">.</span><span class="token function">isEnableDLegerCommitLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>commitLog <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DLedgerCommitLog</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// CommitLog</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>commitLog <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CommitLog</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">/*
         * 所有消息都存储在CommitLog中，但是Consumer按Topic和Queue消费消息
         * 所以每个Topic下的每个Queue都会生成ConsumeQueue，存储消息在CommitLog中的偏移
         * 结构为ConcurrentMap&lt;String, ConcurrentMap&lt;Integer, ConsumeQueue>>
         */</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>consumeQueueTable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ConsumeQueue的刷盘服务</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>flushConsumeQueueService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FlushConsumeQueueService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 清除过期的CommitLog文件的服务</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>cleanCommitLogService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CleanCommitLogService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 清除过期的ConsumeQueue文件的服务</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>cleanConsumeQueueService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CleanConsumeQueueService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 存储统计服务</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>storeStatsService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StoreStatsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 索引服务，负责读写IndexFile</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>indexService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexService</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>messageStoreConfig<span class="token punctuation">.</span><span class="token function">isEnableDLegerCommitLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 高可用服务，负责Master-Slave间的CommitLog同步</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>haService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HAService</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>haService <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 消息存储到CommitLog后，MessageStore的接口调用就返回了</span>
        <span class="token comment" spellcheck="true">// 后续由ReputMessageService负责将消息分发到ConsumeQueue和IndexService</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>reputMessageService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReputMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 延迟消息服务</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>scheduleMessageService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ScheduleMessageService</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>transientStorePool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransientStorePool</span><span class="token punctuation">(</span>messageStoreConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>messageStoreConfig<span class="token punctuation">.</span><span class="token function">isTransientStorePoolEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>transientStorePool<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 负责分配MappedFile</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>allocateMappedFileService<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 空的，啥也没干</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>indexService<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>dispatcherList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// 分发CommitLog，创建ConsumeQueue</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>dispatcherList<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CommitLogDispatcherBuildConsumeQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 分发CommitLog，创建ConsumeIndex</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>dispatcherList<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CommitLogDispatcherBuildIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ${user.home}/store/lock</span>
        File file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>StorePathConfigHelper<span class="token punctuation">.</span><span class="token function">getLockFile</span><span class="token punctuation">(</span>messageStoreConfig<span class="token punctuation">.</span><span class="token function">getStorePathRootDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        MappedFile<span class="token punctuation">.</span><span class="token function">ensureDirOK</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 锁文件，大概是用来标志整个存储目录</span>
        lockFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RandomAccessFile</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token string">"rw"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>CommitLog</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token function">CommitLog</span><span class="token punctuation">(</span><span class="token keyword">final</span> DefaultMessageStore defaultMessageStore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 目录：${user.home}/store/commitlog/</span>
        <span class="token comment" spellcheck="true">// 单个文件默认大小：1024 * 1024 * 1024</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MappedFileQueue</span><span class="token punctuation">(</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStorePathCommitLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMappedFileSizeCommitLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> defaultMessageStore<span class="token punctuation">.</span><span class="token function">getAllocateMappedFileService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore <span class="token operator">=</span> defaultMessageStore<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 同步刷盘</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>FlushDiskType<span class="token punctuation">.</span>SYNC_FLUSH <span class="token operator">==</span> defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFlushDiskType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>flushCommitLogService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GroupCommitService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 异步刷盘</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>flushCommitLogService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FlushRealTimeService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 异步刷盘，这个默认是不启动的</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>commitLogService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CommitRealTimeService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 在回调中执行</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>appendMessageCallback <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultAppendMessageCallback</span><span class="token punctuation">(</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxMessageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        batchEncoderThreadLocal <span class="token operator">=</span> ThreadLocal<span class="token punctuation">.</span><span class="token function">withInitial</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">new</span> <span class="token class-name">MessageExtBatchEncoder</span><span class="token punctuation">(</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxMessageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>putMessageLock <span class="token operator">=</span> defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isUseReentrantLockWhenPutMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">PutMessageReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">PutMessageSpinLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>DefaultMessageStore#load</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 判断${user.home}/store/abort文件是否存在</span>
            <span class="token comment" spellcheck="true">// 此文件在DefaultMessageStore启动时创建，关闭时删除，如果存在，说明不是正常关闭</span>
            <span class="token keyword">boolean</span> lastExitOK <span class="token operator">=</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isTempFileExist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">!=</span> scheduleMessageService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 从${user.home}/store/config/delayOffset.json加载延迟消息的消费进度</span>
                result <span class="token operator">=</span> result <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>scheduleMessageService<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// 从${user.home}/store/commitlog目录下加载CommitLog</span>
            result <span class="token operator">=</span> result <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>commitLog<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 再从${user.home}/store/consumequeue目录下加载ConsumeQueue</span>
            result <span class="token operator">=</span> result <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">loadConsumeQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 再从${user.home}/store/checkpoint加载检查点</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>storeCheckpoint <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StoreCheckpoint</span><span class="token punctuation">(</span>StorePathConfigHelper<span class="token punctuation">.</span><span class="token function">getStoreCheckpoint</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messageStoreConfig<span class="token punctuation">.</span><span class="token function">getStorePathRootDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 根据上次是否正常退出，从${user.home}/store/index目录下加载IndexFile</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>indexService<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>lastExitOK<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 根据上次是否正常退出，恢复ConsumeQueue，CommitLog的指针和TopicQueue目录</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">recover</span><span class="token punctuation">(</span>lastExitOK<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<ul>
<li><p>CommitLog由MappedFile队列组成，每个MappedFile文件大小固定，默认1024 * 1024 * 1024 = 1073741824 = 1G</p>
</li>
<li><p>Message不定长，顺序写入CommitLog，写满后自动生成下一个文件，文件名为存储的第一条消息的偏移，长度20位，左边补零，剩余为起始偏移量</p>
</li>
<li><p>第一个文件名为00000000000000000000，第二个文件名为00000000001073741824，以此类推</p>
</li>
<li><p>1 CommitLog -&gt; 1 MappedFileQueue -&gt; N MappedFile</p>
</li>
<li><p>简单地说，MappedFileQueue代表了文件夹下的MappedFile文件队列，在这里就是CommitLog的映射，ConsumeQueue也是类似</p>
</li>
<li><p>MappedFile是存储消息的文件的映射，FileName[n] = FileName[n - 1] + MappedFileSize</p>
</li>
</ul>
<p>CommitLog#load</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//</span>
        <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileQueue<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>MappedFileQueue#load</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 持久化文件目录</span>
        File dir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>storePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 目录下文件列表</span>
        File<span class="token punctuation">[</span><span class="token punctuation">]</span> files <span class="token operator">=</span> dir<span class="token punctuation">.</span><span class="token function">listFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>files <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 升序</span>
            Arrays<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 遍历</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>File file <span class="token operator">:</span> files<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 大小不对</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 创建MappedFile映射文件</span>
                    MappedFile mappedFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MappedFile</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mappedFileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// 初始指针都设为最大值，会在启动恢复时重置</span>
                    mappedFile<span class="token punctuation">.</span><span class="token function">setWrotePosition</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mappedFile<span class="token punctuation">.</span><span class="token function">setFlushedPosition</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mappedFile<span class="token punctuation">.</span><span class="token function">setCommittedPosition</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// 加入列表</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFiles<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>mappedFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>MappedFile#init</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">final</span> String fileName<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> fileSize<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fileName <span class="token operator">=</span> fileName<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fileSize <span class="token operator">=</span> fileSize<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 文件的起始偏移就是文件名</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fileFromOffset <span class="token operator">=</span> Long<span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>file<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> ok <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token function">ensureDirOK</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>file<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// NIO的FileChannel</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>fileChannel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RandomAccessFile</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>file<span class="token punctuation">,</span> <span class="token string">"rw"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 文件在内存中的映射，PageCache</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>mappedByteBuffer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fileChannel<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>MapMode<span class="token punctuation">.</span>READ_WRITE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> fileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 静态类变量，所有MappedFile实例映射的字节总数</span>
            TOTAL_MAPPED_VIRTUAL_MEMORY<span class="token punctuation">.</span><span class="token function">addAndGet</span><span class="token punctuation">(</span>fileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 静态类变量，MappedFile实例数</span>
            TOTAL_MAPPED_FILES<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ok <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">FileNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>DefaultMessageStore#loadConsumeQueue</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">loadConsumeQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ${user.home}/store/consumequeue目录</span>
        <span class="token comment" spellcheck="true">// 结构是${user.home}/store/consumequeue/{topic}/{queueid}/{filename}</span>
        File dirLogic <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>StorePathConfigHelper<span class="token punctuation">.</span><span class="token function">getStorePathConsumeQueue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messageStoreConfig<span class="token punctuation">.</span><span class="token function">getStorePathRootDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Topic目录列表</span>
        File<span class="token punctuation">[</span><span class="token punctuation">]</span> fileTopicList <span class="token operator">=</span> dirLogic<span class="token punctuation">.</span><span class="token function">listFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fileTopicList <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 遍历Topic目录列表</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>File fileTopic <span class="token operator">:</span> fileTopicList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Topic名称为目录名</span>
                String topic <span class="token operator">=</span> fileTopic<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 该Topic目录下的Queue目录列表</span>
                File<span class="token punctuation">[</span><span class="token punctuation">]</span> fileQueueIdList <span class="token operator">=</span> fileTopic<span class="token punctuation">.</span><span class="token function">listFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>fileQueueIdList <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 遍历该Topic目录下的Queue目录列表</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span>File fileQueueId <span class="token operator">:</span> fileQueueIdList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">int</span> queueId<span class="token punctuation">;</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// 队列Id为目录名</span>
                            queueId <span class="token operator">=</span> Integer<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>fileQueueId<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NumberFormatException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">continue</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment" spellcheck="true">// 根据Topic和QueueId创建ConsumeQueue</span>
                        ConsumeQueue logic <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConsumeQueue</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> StorePathConfigHelper<span class="token punctuation">.</span><span class="token function">getStorePathConsumeQueue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messageStoreConfig<span class="token punctuation">.</span><span class="token function">getStorePathRootDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMappedFileSizeConsumeQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// 加入this.consumeQueueTable</span>
                        <span class="token comment" spellcheck="true">// 结构为ConcurrentMap&lt;String, ConcurrentMap&lt;Integer, ConsumeQueue>></span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">putConsumeQueue</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> logic<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// 加载ConsumeQueue，类似CommitLog的加载方式</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>logic<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ConsumeQueue</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token function">ConsumeQueue</span><span class="token punctuation">(</span><span class="token keyword">final</span> String topic<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> queueId<span class="token punctuation">,</span> <span class="token keyword">final</span> String storePath<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> mappedFileSize<span class="token punctuation">,</span> <span class="token keyword">final</span> DefaultMessageStore defaultMessageStore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ConsumeQueue文件路径</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>storePath <span class="token operator">=</span> storePath<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ConsumeQueue文件大小</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileSize <span class="token operator">=</span> mappedFileSize<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore <span class="token operator">=</span> defaultMessageStore<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 所属Topic</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>topic <span class="token operator">=</span> topic<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ConsumeQueue的Id</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>queueId <span class="token operator">=</span> queueId<span class="token punctuation">;</span>
        String queueDir <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>storePath <span class="token operator">+</span> File<span class="token punctuation">.</span>separator <span class="token operator">+</span> topic <span class="token operator">+</span> File<span class="token punctuation">.</span>separator <span class="token operator">+</span> queueId<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 类似CommitLog，ConsumeQueue也是连续的文件，一个ConsumeQueue可能分多个文件存储，差别就是ConsumeQueue的单元内容是定长的</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MappedFileQueue</span><span class="token punctuation">(</span>queueDir<span class="token punctuation">,</span> mappedFileSize<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>byteBufferIndex <span class="token operator">=</span> ByteBuffer<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>CQ_STORE_UNIT_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEnableConsumeQueueExt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>consumeQueueExt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConsumeQueueExt</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> StorePathConfigHelper<span class="token punctuation">.</span><span class="token function">getStorePathConsumeQueueExt</span><span class="token punctuation">(</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStorePathRootDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMappedFileSizeConsumeQueueExt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBitMapLengthConsumeQueueExt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>ConsumeQueue#load</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//</span>
        <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileQueue<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isExtReadEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            result <span class="token operator">&amp;=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>consumeQueueExt<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>IndexService#load</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">boolean</span> lastExitOK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ${user.home}/store/index目录</span>
        File dir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>storePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 目录下的IndexFile文件列表</span>
        File<span class="token punctuation">[</span><span class="token punctuation">]</span> files <span class="token operator">=</span> dir<span class="token punctuation">.</span><span class="token function">listFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>files <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ascending order</span>
            Arrays<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>File file <span class="token operator">:</span> files<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    IndexFile f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexFile</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hashSlotNum<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>indexNum<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// 加载IndexFile，恢复索引</span>
                    f<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// 上次是非正常退出</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>lastExitOK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// IndexFile的最新一条消息的时间 > 检查点的时间 </span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token punctuation">.</span><span class="token function">getEndTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getStoreCheckpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIndexMsgTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// 销毁并跳过</span>
                            f<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">continue</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// 加入文件列表</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>indexFileList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NumberFormatException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<ul>
<li><p>IndexFile的功能是通过Key或时间来查询消息</p>
</li>
<li><p>默认位置${user.home}/store/index/{fileName}，文件名为创建时间戳</p>
</li>
<li><p>一个IndexFile大小为40 + 5000000 * 4 + 20000000 * 20 = 420000040，依次包括：</p>
</li>
<li><p>IndexHeader：共40字节</p>
<ul>
<li><p>BeginTimestamp：第一个Index的时间戳，8字节</p>
</li>
<li><p>EndTimestamp：最后一个Index的时间戳，8字节</p>
</li>
<li><p>BeginPhyOffset：第一个Index对应的消息在CommitLog的物理偏移，8字节</p>
</li>
<li><p>EndPhyOffset：最后一个Index对应的消息在CommitLog的物理偏移，8字节</p>
</li>
<li><p>HashSlotCount：当前Slot的数量，4字节</p>
</li>
<li><p>IndexCount：当前Index的数量，4字节</p>
</li>
</ul>
</li>
<li><p>SlotTable：Slot列表，存放该Slot对应的最新的Index的序号，每个Slot共4字节，默认共5000000个Slot</p>
</li>
<li><p>IndexLinkedList：Index列表，每个Index都有同Slot的前一个Index的位置偏移，形成一个链表，每个Index共20字节，默认共20000000个Index</p>
</li>
</ul>
<p>IndexFile</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token function">IndexFile</span><span class="token punctuation">(</span><span class="token keyword">final</span> String fileName<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> hashSlotNum<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> indexNum<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> endPhyOffset<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> endTimestamp<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>

        <span class="token comment" spellcheck="true">// 一个IndexFile大小为：40 + 5000000 * 4 + 20000000 * 20 = 420000040</span>
        <span class="token keyword">int</span> fileTotalSize <span class="token operator">=</span> IndexHeader<span class="token punctuation">.</span>INDEX_HEADER_SIZE <span class="token operator">+</span> <span class="token punctuation">(</span>hashSlotNum <span class="token operator">*</span> hashSlotSize<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>indexNum <span class="token operator">*</span> indexSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// MappedFile</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MappedFile</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span> fileTotalSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fileChannel <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFile<span class="token punctuation">.</span><span class="token function">getFileChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>mappedByteBuffer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFile<span class="token punctuation">.</span><span class="token function">getMappedByteBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Slot数量，默认5000000</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>hashSlotNum <span class="token operator">=</span> hashSlotNum<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Index数量</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>indexNum <span class="token operator">=</span> indexNum<span class="token punctuation">;</span>
        ByteBuffer byteBuffer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedByteBuffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 将映射的子缓冲传入IndexHeader</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>indexHeader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexHeader</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>endPhyOffset <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>indexHeader<span class="token punctuation">.</span><span class="token function">setBeginPhyOffset</span><span class="token punctuation">(</span>endPhyOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>indexHeader<span class="token punctuation">.</span><span class="token function">setEndPhyOffset</span><span class="token punctuation">(</span>endPhyOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>endTimestamp <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>indexHeader<span class="token punctuation">.</span><span class="token function">setBeginTimestamp</span><span class="token punctuation">(</span>endTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>indexHeader<span class="token punctuation">.</span><span class="token function">setEndTimestamp</span><span class="token punctuation">(</span>endTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>IndexFile#load</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 从文件中恢复头部的各项数据到IndexHeader</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>indexHeader<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>IndexHeader#load</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>beginTimestamp<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span>beginTimestampIndex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>endTimestamp<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span>endTimestampIndex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>beginPhyOffset<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span>beginPhyoffsetIndex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>endPhyOffset<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span>endPhyoffsetIndex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>hashSlotCount<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>hashSlotcountIndex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>indexCount<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>indexCountIndex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>indexCount<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>indexCount<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>DefaultMessageStore#recover</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">boolean</span> lastExitOK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 恢复ConsumeQueue的刷盘指针，返回最大的物理偏移</span>
        <span class="token keyword">long</span> maxPhyOffsetOfConsumeQueue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">recoverConsumeQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lastExitOK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 正常恢复CommitLog的刷盘指针，和上面差不多，也是从最后三个文件开始遍历检查</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>commitLog<span class="token punctuation">.</span><span class="token function">recoverNormally</span><span class="token punctuation">(</span>maxPhyOffsetOfConsumeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>commitLog<span class="token punctuation">.</span><span class="token function">recoverAbnormally</span><span class="token punctuation">(</span>maxPhyOffsetOfConsumeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 恢复TopicQueue</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">recoverTopicQueueTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>DefaultMessageStore#recoverConsumeQueue</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">long</span> <span class="token function">recoverConsumeQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> maxPhysicOffset <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 遍历所有的Topic</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>ConcurrentMap<span class="token operator">&lt;</span>Integer<span class="token punctuation">,</span> ConsumeQueue<span class="token operator">></span> maps <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>consumeQueueTable<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 遍历所有的ConsumeQueue</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>ConsumeQueue logic <span class="token operator">:</span> maps<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 检查ConsumeQueue内容，并恢复刷盘指针</span>
                logic<span class="token punctuation">.</span><span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>logic<span class="token punctuation">.</span><span class="token function">getMaxPhysicOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> maxPhysicOffset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 更新最大偏移</span>
                    maxPhysicOffset <span class="token operator">=</span> logic<span class="token punctuation">.</span><span class="token function">getMaxPhysicOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 返回ConsumeQueue的最大物理偏移</span>
        <span class="token keyword">return</span> maxPhysicOffset<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ConsumeQueue#recover</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 一个ConsumeQueue下有多个文件，先获取MappedFile映射列表</span>
        <span class="token keyword">final</span> List<span class="token operator">&lt;</span>MappedFile<span class="token operator">></span> mappedFiles <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileQueue<span class="token punctuation">.</span><span class="token function">getMappedFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mappedFiles<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 从倒数第三个文件开始</span>
            <span class="token keyword">int</span> index <span class="token operator">=</span> mappedFiles<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> mappedFileSizeLogics <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileSize<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 获取对应位置的MappedFile</span>
            MappedFile mappedFile <span class="token operator">=</span> mappedFiles<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 分出个子缓冲，维护独立索引</span>
            ByteBuffer byteBuffer <span class="token operator">=</span> mappedFile<span class="token punctuation">.</span><span class="token function">sliceByteBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 文件名/起始偏移</span>
            <span class="token keyword">long</span> processOffset <span class="token operator">=</span> mappedFile<span class="token punctuation">.</span><span class="token function">getFileFromOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//</span>
            <span class="token keyword">long</span> mappedFileOffset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">long</span> maxExtAddr <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 遍历检验ConsumeQueue所有单元，每次遍历单位为一个单元大小，20字节</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> mappedFileSizeLogics<span class="token punctuation">;</span> i <span class="token operator">+=</span> CQ_STORE_UNIT_SIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 消息在CommitLog的偏移，8字节</span>
                    <span class="token keyword">long</span> offset <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// 消息总长度，4字节</span>
                    <span class="token keyword">int</span> size <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// 消息的TagsCode，8字节</span>
                    <span class="token keyword">long</span> tagsCode <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// 说明不是空白</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>offset <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> size <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 累计所有单元的大小</span>
                        mappedFileOffset <span class="token operator">=</span> i <span class="token operator">+</span> CQ_STORE_UNIT_SIZE<span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// 累计最大物理偏移</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>maxPhysicOffset <span class="token operator">=</span> offset <span class="token operator">+</span> size<span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isExtAddr</span><span class="token punctuation">(</span>tagsCode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            maxExtAddr <span class="token operator">=</span> tagsCode<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// 文件有异常，或者当前文件到了结尾</span>
                    <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// for循环结束，当前文件检验结束</span>
                <span class="token comment" spellcheck="true">// 说明该文件所有单元都合法</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mappedFileOffset <span class="token operator">==</span> mappedFileSizeLogics<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 继续下一个MappedFile</span>
                    index<span class="token operator">++</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// 所有MappedFile检查完毕</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">>=</span> mappedFiles<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 再见</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// 下一个MappedFile，继续循环</span>
                        mappedFile <span class="token operator">=</span> mappedFiles<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        byteBuffer <span class="token operator">=</span> mappedFile<span class="token punctuation">.</span><span class="token function">sliceByteBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        processOffset <span class="token operator">=</span> mappedFile<span class="token punctuation">.</span><span class="token function">getFileFromOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        mappedFileOffset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// 文件有异常，不用继续检查了</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// while循环结束，所有文件检验结束</span>
            <span class="token comment" spellcheck="true">// 最后一个有效的ConsumeQueue文件的最大偏移</span>
            processOffset <span class="token operator">+=</span> mappedFileOffset<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 恢复指针</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileQueue<span class="token punctuation">.</span><span class="token function">setFlushedWhere</span><span class="token punctuation">(</span>processOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileQueue<span class="token punctuation">.</span><span class="token function">setCommittedWhere</span><span class="token punctuation">(</span>processOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 截断后面无效的文件</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileQueue<span class="token punctuation">.</span><span class="token function">truncateDirtyFiles</span><span class="token punctuation">(</span>processOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isExtReadEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>consumeQueueExt<span class="token punctuation">.</span><span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">//</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>consumeQueueExt<span class="token punctuation">.</span><span class="token function">truncateByMaxAddress</span><span class="token punctuation">(</span>maxExtAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>ConsumeQueue#recoverTopicQueueTable</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">recoverTopicQueueTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        HashMap<span class="token operator">&lt;</span>String<span class="token comment" spellcheck="true">/* topic-queueid */</span><span class="token punctuation">,</span> Long<span class="token comment" spellcheck="true">/* offset */</span><span class="token operator">></span> table <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Long<span class="token operator">></span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// CommitLog的最小物理偏移</span>
        <span class="token keyword">long</span> minPhyOffset <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>commitLog<span class="token punctuation">.</span><span class="token function">getMinOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 遍历所有Topic</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>ConcurrentMap<span class="token operator">&lt;</span>Integer<span class="token punctuation">,</span> ConsumeQueue<span class="token operator">></span> maps <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>consumeQueueTable<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 遍历Topic下所有ConsumeQueue</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>ConsumeQueue logic <span class="token operator">:</span> maps<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Topic + "-" + QueueId</span>
                String key <span class="token operator">=</span> logic<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"-"</span> <span class="token operator">+</span> logic<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 值为ConsumeQueue内消息的数量，MaxOffset / CQ_STORE_UNIT_SIZE</span>
                table<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> logic<span class="token punctuation">.</span><span class="token function">getMaxOffsetInQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 扩展相关，忽略</span>
                logic<span class="token punctuation">.</span><span class="token function">correctMinOffset</span><span class="token punctuation">(</span>minPhyOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 设回去</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>commitLog<span class="token punctuation">.</span><span class="token function">setTopicQueueTable</span><span class="token punctuation">(</span>table<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>BrokerController#registerProcessor</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">/**
         * SendMessageProcessor
         */</span>
        SendMessageProcessor sendProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SendMessageProcessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sendProcessor<span class="token punctuation">.</span><span class="token function">registerSendMessageHook</span><span class="token punctuation">(</span>sendMessageHookList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        sendProcessor<span class="token punctuation">.</span><span class="token function">registerConsumeMessageHook</span><span class="token punctuation">(</span>consumeMessageHookList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 处理Producer发送的消息</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>remotingServer<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>SEND_MESSAGE<span class="token punctuation">,</span> sendProcessor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sendMessageExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>remotingServer<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>SEND_MESSAGE_V2<span class="token punctuation">,</span> sendProcessor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sendMessageExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 处理Producer发送的批量消息</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>remotingServer<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>SEND_BATCH_MESSAGE<span class="token punctuation">,</span> sendProcessor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sendMessageExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 处理Consumer将消息发回Broker的消息，要求重新消费</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>remotingServer<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>CONSUMER_SEND_MSG_BACK<span class="token punctuation">,</span> sendProcessor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sendMessageExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// VIPChannel共用处理器和业务线程池，只是监听的端口不同</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fastRemotingServer<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>SEND_MESSAGE<span class="token punctuation">,</span> sendProcessor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sendMessageExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fastRemotingServer<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>SEND_MESSAGE_V2<span class="token punctuation">,</span> sendProcessor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sendMessageExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fastRemotingServer<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>SEND_BATCH_MESSAGE<span class="token punctuation">,</span> sendProcessor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sendMessageExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fastRemotingServer<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>CONSUMER_SEND_MSG_BACK<span class="token punctuation">,</span> sendProcessor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sendMessageExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">/**
         * PullMessageProcessor
         */</span>
        <span class="token comment" spellcheck="true">// 处理Consumer拉取消息请求，VIPChannel没有这个</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>remotingServer<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>PULL_MESSAGE<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pullMessageProcessor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pullMessageExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 一些Hook</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>pullMessageProcessor<span class="token punctuation">.</span><span class="token function">registerConsumeMessageHook</span><span class="token punctuation">(</span>consumeMessageHookList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">/**
         * QueryMessageProcessor
         */</span>
        <span class="token comment" spellcheck="true">// 查询消息接口，Index</span>
        NettyRequestProcessor queryProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryMessageProcessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>remotingServer<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>QUERY_MESSAGE<span class="token punctuation">,</span> queryProcessor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>queryMessageExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>remotingServer<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>VIEW_MESSAGE_BY_ID<span class="token punctuation">,</span> queryProcessor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>queryMessageExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fastRemotingServer<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>QUERY_MESSAGE<span class="token punctuation">,</span> queryProcessor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>queryMessageExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fastRemotingServer<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>VIEW_MESSAGE_BY_ID<span class="token punctuation">,</span> queryProcessor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>queryMessageExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">/**
         * ClientManageProcessor
         */</span>
        ClientManageProcessor clientProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClientManageProcessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 处理客户端如Producer和Consumer的心跳</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>remotingServer<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>HEART_BEAT<span class="token punctuation">,</span> clientProcessor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>heartbeatExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>remotingServer<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>UNREGISTER_CLIENT<span class="token punctuation">,</span> clientProcessor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clientManageExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>remotingServer<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>CHECK_CLIENT_CONFIG<span class="token punctuation">,</span> clientProcessor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clientManageExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fastRemotingServer<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>HEART_BEAT<span class="token punctuation">,</span> clientProcessor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>heartbeatExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fastRemotingServer<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>UNREGISTER_CLIENT<span class="token punctuation">,</span> clientProcessor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clientManageExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fastRemotingServer<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>CHECK_CLIENT_CONFIG<span class="token punctuation">,</span> clientProcessor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clientManageExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">/**
         * ConsumerManageProcessor
         */</span>
        ConsumerManageProcessor consumerManageProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConsumerManageProcessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 处理Consumer发送的根据ConsumerGroup查询Consumer列表请求</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>remotingServer<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>GET_CONSUMER_LIST_BY_GROUP<span class="token punctuation">,</span> consumerManageProcessor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>consumerManageExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 处理Consumer发送的更新Consumer消费进度偏移请求</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>remotingServer<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>UPDATE_CONSUMER_OFFSET<span class="token punctuation">,</span> consumerManageProcessor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>consumerManageExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 处理Consumer发送的查询Consumer消费进度偏移请求</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>remotingServer<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>QUERY_CONSUMER_OFFSET<span class="token punctuation">,</span> consumerManageProcessor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>consumerManageExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fastRemotingServer<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>GET_CONSUMER_LIST_BY_GROUP<span class="token punctuation">,</span> consumerManageProcessor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>consumerManageExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fastRemotingServer<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>UPDATE_CONSUMER_OFFSET<span class="token punctuation">,</span> consumerManageProcessor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>consumerManageExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fastRemotingServer<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>QUERY_CONSUMER_OFFSET<span class="token punctuation">,</span> consumerManageProcessor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>consumerManageExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">/**
         * EndTransactionProcessor
         */</span>
        <span class="token comment" spellcheck="true">// 处理结束事务消息</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>remotingServer<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>END_TRANSACTION<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">EndTransactionProcessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>endTransactionExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fastRemotingServer<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>END_TRANSACTION<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">EndTransactionProcessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>endTransactionExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">/**
         * Default
         */</span>
        AdminBrokerProcessor adminProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AdminBrokerProcessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Fallback的处理器，处理其它请求</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>remotingServer<span class="token punctuation">.</span><span class="token function">registerDefaultProcessor</span><span class="token punctuation">(</span>adminProcessor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>adminBrokerExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fastRemotingServer<span class="token punctuation">.</span><span class="token function">registerDefaultProcessor</span><span class="token punctuation">(</span>adminProcessor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>adminBrokerExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


        <footer>
             
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

        </footer>
    </div>
    <!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
    <script>
        var timeEnd = new Date();
        console.log('耗时：' + (timeEnd - timeStart));
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre').forEach((block) => {
                block.classList.add("line-numbers");
            });
        });
    </script>
    <!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
    <!-- material design -->
    <!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
    <!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
    <!-- toc -->
    <!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
    <!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
    <!-- <script src="/js/main.js"></script> -->
    <script src="/js/prism.js"></script>
</body>
</html>
