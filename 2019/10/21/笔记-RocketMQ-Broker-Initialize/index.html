<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
        <script>
            var timeStart = new Date();
        </script>
        
        <title>[ç¬”è®°]-RocketMQ-Broker-Initialize | ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜</title>
        
        <meta name="author" content="huangzhike">
        
        
        <meta name="description" content="BrokerController
    public BrokerController(final BrokerConfig brokerConfig, final NettyServerConfig nettyServerConfig, final NettyClientConfig netty">
        
        
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        
        <meta property="og:title" content="[ç¬”è®°]-RocketMQ-Broker-Initialize"/>
        
        <meta property="og:site_name" content="ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜"/>
        
        
        <!-- favicon -->
        <link rel="icon" type="image/ico" href="/ok.ico" sizes="32x32">
        <meta name="msapplication-TileColor" content="#009688">
        <meta name="msapplication-TileImage" content="/mstile-144x144.ico">
        <meta name="theme-color" content="#009688">
        <!-- favicon end -->
        <!-- <link href="//ok.ico" rel="icon"> -->
        
        <!-- toc -->
        <!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
        <!-- material design -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
        <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
        
        <!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
        <!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
    <meta name="generator" content="Hexo 4.2.1"></head>

<body>
    <nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">èœå•</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" title="ä¸‹ä¸€å¥æ˜¯ï¼šå®¢æœ‰å¯äººæœŸä¸æ¥ã€‚å°æ—¶å€™ï¼Œå–œæ¬¢é åœ¨é˜³å°ä¸Šï¼Œä¸€è¾¹å¹é£ï¼Œä¸€è¾¹çœ‹ä¹¦ï¼Œå–œæ¬¢è¯»ä¹¦å—ï¼Œéªšå¹´ï¼Ÿ" href="/">ä¹¦å½“å¿«æ„è¯»æ˜“å°½</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" target="_blank" rel="noopener" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

    <div class="container" >
        <div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[ç¬”è®°]-RocketMQ-Broker-Initialize</h2>
				
				<div>
					<div class="post-time">2019-10-21</div>
				</div>
				
				<div class="article-content">
				<p>BrokerController</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token function">BrokerController</span><span class="token punctuation">(</span><span class="token keyword">final</span> BrokerConfig brokerConfig<span class="token punctuation">,</span> <span class="token keyword">final</span> NettyServerConfig nettyServerConfig<span class="token punctuation">,</span> <span class="token keyword">final</span> NettyClientConfig nettyClientConfig<span class="token punctuation">,</span> <span class="token keyword">final</span> MessageStoreConfig messageStoreConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// åˆ›å»ºä¸€äº›å†…ç½®Topic</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>topicConfigManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TopicConfigManager</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
    <span class="token punctuation">}</span></code></pre>
<p>TopicConfigManager</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token function">TopicConfigManager</span><span class="token punctuation">(</span>BrokerController brokerController<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController <span class="token operator">=</span> brokerController<span class="token punctuation">;</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// MixAll.SELF_TEST_TOPIC</span>
            <span class="token comment" spellcheck="true">// åˆ›å»ºä¸€ä¸ªè‡ªæˆ‘æµ‹è¯•ä¸»é¢˜SELF_TEST_TOPIC</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// MixAll.AUTO_CREATE_TOPIC_KEY_TOPIC</span>
            <span class="token comment" spellcheck="true">// å¦‚æœå…è®¸è‡ªåŠ¨åˆ›å»ºTopicï¼Œæ·»åŠ ä¸€ä¸ªé»˜è®¤çš„ä¸»é¢˜TBW102</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAutoCreateTopicEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                String topic <span class="token operator">=</span> MixAll<span class="token punctuation">.</span>AUTO_CREATE_TOPIC_KEY_TOPIC<span class="token punctuation">;</span>
                TopicConfig topicConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TopicConfig</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>systemTopicList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// é»˜è®¤8</span>
                topicConfig<span class="token punctuation">.</span><span class="token function">setReadQueueNums</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDefaultTopicQueueNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// é»˜è®¤8</span>
                topicConfig<span class="token punctuation">.</span><span class="token function">setWriteQueueNums</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDefaultTopicQueueNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> perm <span class="token operator">=</span> PermName<span class="token punctuation">.</span>PERM_INHERIT <span class="token operator">|</span> PermName<span class="token punctuation">.</span>PERM_READ <span class="token operator">|</span> PermName<span class="token punctuation">.</span>PERM_WRITE<span class="token punctuation">;</span>
                topicConfig<span class="token punctuation">.</span><span class="token function">setPerm</span><span class="token punctuation">(</span>perm<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>topicConfigTable<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>topicConfig<span class="token punctuation">.</span><span class="token function">getTopicName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> topicConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// MixAll.BENCHMARK_TOPIC</span>
            <span class="token comment" spellcheck="true">// åˆ›å»ºä¸€ä¸ªè·‘åˆ†ä¸»é¢˜BenchmarkTest</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// åˆ›å»ºä¸€ä¸ªBrokeré›†ç¾¤åä¸»é¢˜ï¼Œé»˜è®¤DefaultCluster</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// åˆ›å»ºä¸€ä¸ªBrokeråä¸»é¢˜ï¼Œé»˜è®¤ä¸ºBrokeræ‰€åœ¨çš„ä¸»æœºå</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// MixAll.OFFSET_MOVED_EVENT</span>
            <span class="token comment" spellcheck="true">// åˆ›å»ºä¸€ä¸ªOFFSET_MOVED_EVENTä¸»é¢˜</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// MixAll.RMQ_SYS_TRACE_TOPIC</span>
            <span class="token comment" spellcheck="true">// å¦‚æœBrokerå¯ç”¨äº†ä¸»é¢˜è·Ÿè¸ªï¼Œåˆ›å»ºä¸€ä¸ªRMQ_SYS_TRACE_TOPICä¸»é¢˜ï¼Œé»˜è®¤ä¸å¯ç”¨</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>BrokerController#initialize</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> CloneNotSupportedException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Brokerå¯åŠ¨æ—¶ä¸ä»NameServerè¯·æ±‚Topicé…ç½®ï¼Œä»æœ¬åœ°JSONæ–‡ä»¶åŠ è½½ï¼Œé»˜è®¤${user.home}/store/config/topics.json</span>
        <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>topicConfigManager<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ä»æœ¬åœ°æ–‡ä»¶åŠ è½½Consumerçš„æ¶ˆè´¹è¿›åº¦åç§»ï¼Œé»˜è®¤${user.home}/store/config/consumerOffset.json</span>
        result <span class="token operator">=</span> result <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>consumerOffsetManager<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ä»æœ¬åœ°æ–‡ä»¶åŠ è½½è®¢é˜…ç»„ï¼Œé»˜è®¤${user.home}/store/config/subscriptionGroup.json</span>
        result <span class="token operator">=</span> result <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>subscriptionGroupManager<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// é»˜è®¤${user.home}/store/config/consumerFilter.json</span>
        result <span class="token operator">=</span> result <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>consumerFilterManager<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ç”¨äºç®¡ç†æ¶ˆæ¯å­˜å‚¨ç­‰</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>messageStore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultMessageStore</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messageStoreConfig<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerStatsManager<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>messageArrivingListener<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// é»˜è®¤ä¸å¯ç”¨</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>messageStoreConfig<span class="token punctuation">.</span><span class="token function">isEnableDLegerCommitLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    DLedgerRoleChangeHandler roleChangeHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DLedgerRoleChangeHandler</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>DefaultMessageStore<span class="token punctuation">)</span> messageStore<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">(</span><span class="token punctuation">(</span>DLedgerCommitLog<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>DefaultMessageStore<span class="token punctuation">)</span> messageStore<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCommitLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getdLedgerServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getdLedgerLeaderElector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addRoleChangeHandler</span><span class="token punctuation">(</span>roleChangeHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// ç”¨äºç»Ÿè®¡æ•°æ®</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>brokerStats <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BrokerStats</span><span class="token punctuation">(</span><span class="token punctuation">(</span>DefaultMessageStore<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>messageStore<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ä¸Šä¸‹æ–‡</span>
                MessageStorePluginContext context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageStorePluginContext</span><span class="token punctuation">(</span>messageStoreConfig<span class="token punctuation">,</span> brokerStatsManager<span class="token punctuation">,</span> messageArrivingListener<span class="token punctuation">,</span> brokerConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// åŒ…è£…MessageStoreï¼Œæ²¡å‘ç°æœ‰ä»€ä¹ˆç”¨ï¼Œç›´æ¥å¿½ç•¥</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>messageStore <span class="token operator">=</span> MessageStoreFactory<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>messageStore<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>messageStore<span class="token punctuation">.</span><span class="token function">getDispatcherList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addFirst</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CommitLogDispatcherCalcBitMap</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>consumerFilterManager<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ä»æŒä¹…åŒ–æ–‡ä»¶åŠ è½½CommitLogã€ConsumeQueueã€IndexFileï¼Œå¹¶æ¢å¤è¿›åº¦</span>
        result <span class="token operator">=</span> result <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>messageStore<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è¿œç¨‹é€šè®¯æœåŠ¡å™¨ï¼ŒClientHousekeepingServiceç›‘å¬é€šé“å˜åŒ–ï¼Œå¤„ç†Producerå’ŒConsumerçš„è¿æ¥å­˜æ´»æƒ…å†µ</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>remotingServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NettyRemotingServer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>nettyServerConfig<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clientHousekeepingService<span class="token punctuation">)</span><span class="token punctuation">;</span>
            NettyServerConfig fastConfig <span class="token operator">=</span> <span class="token punctuation">(</span>NettyServerConfig<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>nettyServerConfig<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// VIPé€šé“ï¼Œä¸å¤„ç†Consumerçš„PullRequest</span>
            fastConfig<span class="token punctuation">.</span><span class="token function">setListenPort</span><span class="token punctuation">(</span>nettyServerConfig<span class="token punctuation">.</span><span class="token function">getListenPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è¿œç¨‹é€šè®¯æœåŠ¡å™¨ï¼Œå’Œä¸Šé¢çš„å…±ç”¨ä¸šåŠ¡å¤„ç†å™¨å’Œä¸šåŠ¡çº¿ç¨‹æ± ï¼Œåªæ˜¯ç«¯å£å’ŒIOçº¿ç¨‹æ± ä¸ä¸€æ ·</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>fastRemotingServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NettyRemotingServer</span><span class="token punctuation">(</span>fastConfig<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clientHousekeepingService<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å¤„ç†Produceræ¶ˆæ¯çš„çº¿ç¨‹æ± </span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>sendMessageExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BrokerFixedThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getSendMessageThreadPoolNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getSendMessageThreadPoolNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sendThreadPoolQueue<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryImpl</span><span class="token punctuation">(</span><span class="token string">"SendMessageThread_"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å¤„ç†Consumeræ¶ˆæ¯çš„çº¿ç¨‹æ± </span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>pullMessageExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BrokerFixedThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getPullMessageThreadPoolNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getPullMessageThreadPoolNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pullThreadPoolQueue<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryImpl</span><span class="token punctuation">(</span><span class="token string">"PullMessageThread_"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å¤„ç†æ¶ˆæ¯æŸ¥è¯¢çš„çº¿ç¨‹æ± </span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>queryMessageExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BrokerFixedThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getQueryMessageThreadPoolNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getQueryMessageThreadPoolNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>queryThreadPoolQueue<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryImpl</span><span class="token punctuation">(</span><span class="token string">"QueryMessageThread_"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å¤„ç†Brokerç®¡ç†çš„çº¿ç¨‹æ± </span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>adminBrokerExecutor <span class="token operator">=</span> Executors<span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getAdminBrokerThreadPoolNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryImpl</span><span class="token punctuation">(</span><span class="token string">"AdminBrokerThread_"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å¤„ç†Clientç®¡ç†çš„çº¿ç¨‹æ± </span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>clientManageExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getClientManageThreadPoolNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getClientManageThreadPoolNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clientManagerThreadPoolQueue<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryImpl</span><span class="token punctuation">(</span><span class="token string">"ClientManageThread_"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å¤„ç†å¿ƒè·³çš„çº¿ç¨‹æ± </span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>heartbeatExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BrokerFixedThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getHeartbeatThreadPoolNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getHeartbeatThreadPoolNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>heartbeatThreadPoolQueue<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryImpl</span><span class="token punctuation">(</span><span class="token string">"HeartbeatThread_"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å¤„ç†äº‹åŠ¡çš„çº¿ç¨‹æ± </span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>endTransactionExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BrokerFixedThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getEndTransactionThreadPoolNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getEndTransactionThreadPoolNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>endTransactionThreadPoolQueue<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryImpl</span><span class="token punctuation">(</span><span class="token string">"EndTransactionThread_"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å¤„ç†Consumerç®¡ç†çš„çº¿ç¨‹æ± </span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>consumerManageExecutor <span class="token operator">=</span> Executors<span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getConsumerManageThreadPoolNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryImpl</span><span class="token punctuation">(</span><span class="token string">"ConsumerManageThread_"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ³¨å†Œæ¶ˆæ¯å¤„ç†å™¨ï¼ŒåŠå¤„ç†çš„çº¿ç¨‹æ± </span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// è®¡åˆ’ä»»åŠ¡ï¼Œæ¯æ—¥ä¸€æ¬¡ï¼Œæ‰“å°Brokerç»Ÿè®¡æ•°æ®ç›¸å…³</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// è®¡åˆ’ä»»åŠ¡ï¼Œæ¯äº”ç§’ä¸€æ¬¡ï¼ŒæŒä¹…åŒ–Consumeræ¶ˆè´¹åç§»</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// è®¡åˆ’ä»»åŠ¡ï¼Œæ¯åç§’ä¸€æ¬¡ï¼ŒæŒä¹…åŒ–ConsumerFilter</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// è®¡åˆ’ä»»åŠ¡ï¼Œæ¯ä¸‰åˆ†é’Ÿä¸€æ¬¡ï¼Œå¦‚æœConsumeræ¶ˆè´¹å»¶æ—¶å¤ªå¤§ï¼Œç¦ç”¨è¯¥Consumerï¼Œä¸å†å‘å®ƒæŠ•é€’æ¶ˆæ¯</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// è®¡åˆ’ä»»åŠ¡ï¼Œæ¯ä¸€ç§’ä¸€æ¬¡ï¼Œæ‰“å°ç”Ÿäº§æ¶ˆè´¹é˜Ÿåˆ—ä¿¡æ¯</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// è®¡åˆ’ä»»åŠ¡ï¼Œæ¯åˆ†é’Ÿä¸€æ¬¡ï¼Œæ‰“å°Dispatchè½åæƒ…å†µ</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// å¦‚æœç³»ç»Ÿå˜é‡ã€ç¯å¢ƒå˜é‡ã€ç¨‹åºæŒ‡å®šäº†NameServeråœ°å€</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getNamesrvAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æ›´æ–°æœ¬åœ°NameServeråœ°å€åˆ—è¡¨ç¼“å­˜</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>brokerOuterAPI<span class="token punctuation">.</span><span class="token function">updateNameServerAddressList</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">getNamesrvAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// æ²¡æœ‰æŒ‡å®šNameServeråœ°å€ï¼Œå¦‚æœè®¾ç½®ä»è¿œç¨‹è·å–NameServeråœ°å€</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig<span class="token punctuation">.</span><span class="token function">isFetchNamesrvAddrByAddressServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// è®¡åˆ’ä»»åŠ¡ï¼Œæ¯ä¸¤åˆ†é’Ÿä¸€æ¬¡ï¼Œä»æŒ‡å®šçš„HTTPæ¥å£æ›´æ–°NameServeråœ°å€ä¿¡æ¯</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>scheduledExecutorService<span class="token punctuation">.</span><span class="token function">scheduleAtFixedRate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        BrokerController<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerOuterAPI<span class="token punctuation">.</span><span class="token function">fetchNameServerAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// é»˜è®¤</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>messageStoreConfig<span class="token punctuation">.</span><span class="token function">isEnableDLegerCommitLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// SLAVE</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>BrokerRole<span class="token punctuation">.</span>SLAVE <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>messageStoreConfig<span class="token punctuation">.</span><span class="token function">getBrokerRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// é…ç½®äº†é«˜å¯ç”¨Masteråœ°å€</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messageStoreConfig<span class="token punctuation">.</span><span class="token function">getHaMasterAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>messageStoreConfig<span class="token punctuation">.</span><span class="token function">getHaMasterAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// æ›´æ–°æœ¬åœ°Masteråœ°å€ç¼“å­˜</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>messageStore<span class="token punctuation">.</span><span class="token function">updateHaMasterAddress</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messageStoreConfig<span class="token punctuation">.</span><span class="token function">getHaMasterAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// ä¸éœ€è¦å‘¨æœŸæ€§æ›´æ–°Masteråœ°å€</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>updateMasterHAServerAddrPeriodically <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>updateMasterHAServerAddrPeriodically <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// MASTER</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// è®¡åˆ’ä»»åŠ¡ï¼Œæ‰“å°Slaveè½åçš„ä¿¡æ¯Diff</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>TlsSystemConfig<span class="token punctuation">.</span>tlsMode <span class="token operator">!=</span> TlsMode<span class="token punctuation">.</span>DISABLED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// åˆå§‹åŒ–äº‹åŠ¡æ¶ˆæ¯æœåŠ¡</span>
            <span class="token function">initialTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// Access Control List</span>
            <span class="token function">initialAcl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ³¨å†Œä¸€äº›é’©å­</span>
            <span class="token function">initialRpcHooks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>DefaultMessageStore</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token function">DefaultMessageStore</span><span class="token punctuation">(</span><span class="token keyword">final</span> MessageStoreConfig messageStoreConfig<span class="token punctuation">,</span> <span class="token keyword">final</span> BrokerStatsManager brokerStatsManager<span class="token punctuation">,</span> <span class="token keyword">final</span> MessageArrivingListener messageArrivingListener<span class="token punctuation">,</span> <span class="token keyword">final</span> BrokerConfig brokerConfig<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// æ¶ˆæ¯åˆ°è¾¾ç›‘å¬å™¨</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>messageArrivingListener <span class="token operator">=</span> messageArrivingListener<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>brokerConfig <span class="token operator">=</span> brokerConfig<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>messageStoreConfig <span class="token operator">=</span> messageStoreConfig<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Brokerç»Ÿè®¡ç®¡ç†</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>brokerStatsManager <span class="token operator">=</span> brokerStatsManager<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>allocateMappedFileService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AllocateMappedFileService</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>messageStoreConfig<span class="token punctuation">.</span><span class="token function">isEnableDLegerCommitLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>commitLog <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DLedgerCommitLog</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// CommitLog</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>commitLog <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CommitLog</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">/*
         * æ‰€æœ‰æ¶ˆæ¯éƒ½å­˜å‚¨åœ¨CommitLogä¸­ï¼Œä½†æ˜¯ConsumeræŒ‰Topicå’ŒQueueæ¶ˆè´¹æ¶ˆæ¯
         * æ‰€ä»¥æ¯ä¸ªTopicä¸‹çš„æ¯ä¸ªQueueéƒ½ä¼šç”ŸæˆConsumeQueueï¼Œå­˜å‚¨æ¶ˆæ¯åœ¨CommitLogä¸­çš„åç§»
         * ç»“æ„ä¸ºConcurrentMap&lt;String, ConcurrentMap&lt;Integer, ConsumeQueue>>
         */</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>consumeQueueTable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ConsumeQueueçš„åˆ·ç›˜æœåŠ¡</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>flushConsumeQueueService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FlushConsumeQueueService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ¸…é™¤è¿‡æœŸçš„CommitLogæ–‡ä»¶çš„æœåŠ¡</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>cleanCommitLogService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CleanCommitLogService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ¸…é™¤è¿‡æœŸçš„ConsumeQueueæ–‡ä»¶çš„æœåŠ¡</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>cleanConsumeQueueService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CleanConsumeQueueService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å­˜å‚¨ç»Ÿè®¡æœåŠ¡</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>storeStatsService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StoreStatsService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ç´¢å¼•æœåŠ¡ï¼Œè´Ÿè´£è¯»å†™IndexFile</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>indexService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexService</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>messageStoreConfig<span class="token punctuation">.</span><span class="token function">isEnableDLegerCommitLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// é«˜å¯ç”¨æœåŠ¡ï¼Œè´Ÿè´£Master-Slaveé—´çš„CommitLogåŒæ­¥</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>haService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HAService</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>haService <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// æ¶ˆæ¯å­˜å‚¨åˆ°CommitLogåï¼ŒMessageStoreçš„æ¥å£è°ƒç”¨å°±è¿”å›äº†</span>
        <span class="token comment" spellcheck="true">// åç»­ç”±ReputMessageServiceè´Ÿè´£å°†æ¶ˆæ¯åˆ†å‘åˆ°ConsumeQueueå’ŒIndexService</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>reputMessageService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReputMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å»¶è¿Ÿæ¶ˆæ¯æœåŠ¡</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>scheduleMessageService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ScheduleMessageService</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>transientStorePool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransientStorePool</span><span class="token punctuation">(</span>messageStoreConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>messageStoreConfig<span class="token punctuation">.</span><span class="token function">isTransientStorePoolEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>transientStorePool<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// è´Ÿè´£åˆ†é…MappedFile</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>allocateMappedFileService<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ç©ºçš„ï¼Œå•¥ä¹Ÿæ²¡å¹²</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>indexService<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>dispatcherList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// åˆ†å‘CommitLogï¼Œåˆ›å»ºConsumeQueue</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>dispatcherList<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CommitLogDispatcherBuildConsumeQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// åˆ†å‘CommitLogï¼Œåˆ›å»ºConsumeIndex</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>dispatcherList<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CommitLogDispatcherBuildIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ${user.home}/store/lock</span>
        File file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>StorePathConfigHelper<span class="token punctuation">.</span><span class="token function">getLockFile</span><span class="token punctuation">(</span>messageStoreConfig<span class="token punctuation">.</span><span class="token function">getStorePathRootDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        MappedFile<span class="token punctuation">.</span><span class="token function">ensureDirOK</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// é”æ–‡ä»¶ï¼Œå¤§æ¦‚æ˜¯ç”¨æ¥æ ‡å¿—æ•´ä¸ªå­˜å‚¨ç›®å½•</span>
        lockFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RandomAccessFile</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token string">"rw"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>CommitLog</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token function">CommitLog</span><span class="token punctuation">(</span><span class="token keyword">final</span> DefaultMessageStore defaultMessageStore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ç›®å½•ï¼š${user.home}/store/commitlog/</span>
        <span class="token comment" spellcheck="true">// å•ä¸ªæ–‡ä»¶é»˜è®¤å¤§å°ï¼š1024 * 1024 * 1024</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MappedFileQueue</span><span class="token punctuation">(</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStorePathCommitLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMappedFileSizeCommitLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> defaultMessageStore<span class="token punctuation">.</span><span class="token function">getAllocateMappedFileService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore <span class="token operator">=</span> defaultMessageStore<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// åŒæ­¥åˆ·ç›˜</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>FlushDiskType<span class="token punctuation">.</span>SYNC_FLUSH <span class="token operator">==</span> defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFlushDiskType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>flushCommitLogService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GroupCommitService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å¼‚æ­¥åˆ·ç›˜</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>flushCommitLogService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FlushRealTimeService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å¼‚æ­¥åˆ·ç›˜ï¼Œè¿™ä¸ªé»˜è®¤æ˜¯ä¸å¯åŠ¨çš„</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>commitLogService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CommitRealTimeService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// åœ¨å›è°ƒä¸­æ‰§è¡Œ</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>appendMessageCallback <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultAppendMessageCallback</span><span class="token punctuation">(</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxMessageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        batchEncoderThreadLocal <span class="token operator">=</span> ThreadLocal<span class="token punctuation">.</span><span class="token function">withInitial</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">new</span> <span class="token class-name">MessageExtBatchEncoder</span><span class="token punctuation">(</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxMessageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>putMessageLock <span class="token operator">=</span> defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isUseReentrantLockWhenPutMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">PutMessageReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">PutMessageSpinLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>DefaultMessageStore#load</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// åˆ¤æ–­${user.home}/store/abortæ–‡ä»¶æ˜¯å¦å­˜åœ¨</span>
            <span class="token comment" spellcheck="true">// æ­¤æ–‡ä»¶åœ¨DefaultMessageStoreå¯åŠ¨æ—¶åˆ›å»ºï¼Œå…³é—­æ—¶åˆ é™¤ï¼Œå¦‚æœå­˜åœ¨ï¼Œè¯´æ˜ä¸æ˜¯æ­£å¸¸å…³é—­</span>
            <span class="token keyword">boolean</span> lastExitOK <span class="token operator">=</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isTempFileExist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">!=</span> scheduleMessageService<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ä»${user.home}/store/config/delayOffset.jsonåŠ è½½å»¶è¿Ÿæ¶ˆæ¯çš„æ¶ˆè´¹è¿›åº¦</span>
                result <span class="token operator">=</span> result <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>scheduleMessageService<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ä»${user.home}/store/commitlogç›®å½•ä¸‹åŠ è½½CommitLog</span>
            result <span class="token operator">=</span> result <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>commitLog<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å†ä»${user.home}/store/consumequeueç›®å½•ä¸‹åŠ è½½ConsumeQueue</span>
            result <span class="token operator">=</span> result <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">loadConsumeQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å†ä»${user.home}/store/checkpointåŠ è½½æ£€æŸ¥ç‚¹</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>storeCheckpoint <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StoreCheckpoint</span><span class="token punctuation">(</span>StorePathConfigHelper<span class="token punctuation">.</span><span class="token function">getStoreCheckpoint</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messageStoreConfig<span class="token punctuation">.</span><span class="token function">getStorePathRootDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// æ ¹æ®ä¸Šæ¬¡æ˜¯å¦æ­£å¸¸é€€å‡ºï¼Œä»${user.home}/store/indexç›®å½•ä¸‹åŠ è½½IndexFile</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>indexService<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>lastExitOK<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// æ ¹æ®ä¸Šæ¬¡æ˜¯å¦æ­£å¸¸é€€å‡ºï¼Œæ¢å¤ConsumeQueueï¼ŒCommitLogçš„æŒ‡é’ˆå’ŒTopicQueueç›®å½•</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">recover</span><span class="token punctuation">(</span>lastExitOK<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<ul>
<li><p>CommitLogç”±MappedFileé˜Ÿåˆ—ç»„æˆï¼Œæ¯ä¸ªMappedFileæ–‡ä»¶å¤§å°å›ºå®šï¼Œé»˜è®¤1024 * 1024 * 1024 = 1073741824 = 1G</p>
</li>
<li><p>Messageä¸å®šé•¿ï¼Œé¡ºåºå†™å…¥CommitLogï¼Œå†™æ»¡åè‡ªåŠ¨ç”Ÿæˆä¸‹ä¸€ä¸ªæ–‡ä»¶ï¼Œæ–‡ä»¶åä¸ºå­˜å‚¨çš„ç¬¬ä¸€æ¡æ¶ˆæ¯çš„åç§»ï¼Œé•¿åº¦20ä½ï¼Œå·¦è¾¹è¡¥é›¶ï¼Œå‰©ä½™ä¸ºèµ·å§‹åç§»é‡</p>
</li>
<li><p>ç¬¬ä¸€ä¸ªæ–‡ä»¶åä¸º00000000000000000000ï¼Œç¬¬äºŒä¸ªæ–‡ä»¶åä¸º00000000001073741824ï¼Œä»¥æ­¤ç±»æ¨</p>
</li>
<li><p>1 CommitLog -&gt; 1 MappedFileQueue -&gt; N MappedFile</p>
</li>
<li><p>ç®€å•åœ°è¯´ï¼ŒMappedFileQueueä»£è¡¨äº†æ–‡ä»¶å¤¹ä¸‹çš„MappedFileæ–‡ä»¶é˜Ÿåˆ—ï¼Œåœ¨è¿™é‡Œå°±æ˜¯CommitLogçš„æ˜ å°„ï¼ŒConsumeQueueä¹Ÿæ˜¯ç±»ä¼¼</p>
</li>
<li><p>MappedFileæ˜¯å­˜å‚¨æ¶ˆæ¯çš„æ–‡ä»¶çš„æ˜ å°„ï¼ŒFileName[n] = FileName[n - 1] + MappedFileSize</p>
</li>
</ul>
<p>CommitLog#load</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//</span>
        <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileQueue<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>MappedFileQueue#load</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// æŒä¹…åŒ–æ–‡ä»¶ç›®å½•</span>
        File dir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>storePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ç›®å½•ä¸‹æ–‡ä»¶åˆ—è¡¨</span>
        File<span class="token punctuation">[</span><span class="token punctuation">]</span> files <span class="token operator">=</span> dir<span class="token punctuation">.</span><span class="token function">listFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>files <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å‡åº</span>
            Arrays<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// éå†</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>File file <span class="token operator">:</span> files<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å¤§å°ä¸å¯¹</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// åˆ›å»ºMappedFileæ˜ å°„æ–‡ä»¶</span>
                    MappedFile mappedFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MappedFile</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mappedFileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// åˆå§‹æŒ‡é’ˆéƒ½è®¾ä¸ºæœ€å¤§å€¼ï¼Œä¼šåœ¨å¯åŠ¨æ¢å¤æ—¶é‡ç½®</span>
                    mappedFile<span class="token punctuation">.</span><span class="token function">setWrotePosition</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mappedFile<span class="token punctuation">.</span><span class="token function">setFlushedPosition</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mappedFile<span class="token punctuation">.</span><span class="token function">setCommittedPosition</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// åŠ å…¥åˆ—è¡¨</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFiles<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>mappedFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>MappedFile#init</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">final</span> String fileName<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> fileSize<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fileName <span class="token operator">=</span> fileName<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fileSize <span class="token operator">=</span> fileSize<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ–‡ä»¶çš„èµ·å§‹åç§»å°±æ˜¯æ–‡ä»¶å</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fileFromOffset <span class="token operator">=</span> Long<span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>file<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> ok <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token function">ensureDirOK</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>file<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// NIOçš„FileChannel</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>fileChannel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RandomAccessFile</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>file<span class="token punctuation">,</span> <span class="token string">"rw"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ–‡ä»¶åœ¨å†…å­˜ä¸­çš„æ˜ å°„ï¼ŒPageCache</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>mappedByteBuffer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fileChannel<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>MapMode<span class="token punctuation">.</span>READ_WRITE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> fileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// é™æ€ç±»å˜é‡ï¼Œæ‰€æœ‰MappedFileå®ä¾‹æ˜ å°„çš„å­—èŠ‚æ€»æ•°</span>
            TOTAL_MAPPED_VIRTUAL_MEMORY<span class="token punctuation">.</span><span class="token function">addAndGet</span><span class="token punctuation">(</span>fileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// é™æ€ç±»å˜é‡ï¼ŒMappedFileå®ä¾‹æ•°</span>
            TOTAL_MAPPED_FILES<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ok <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">FileNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>DefaultMessageStore#loadConsumeQueue</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">loadConsumeQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ${user.home}/store/consumequeueç›®å½•</span>
        <span class="token comment" spellcheck="true">// ç»“æ„æ˜¯${user.home}/store/consumequeue/{topic}/{queueid}/{filename}</span>
        File dirLogic <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>StorePathConfigHelper<span class="token punctuation">.</span><span class="token function">getStorePathConsumeQueue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messageStoreConfig<span class="token punctuation">.</span><span class="token function">getStorePathRootDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Topicç›®å½•åˆ—è¡¨</span>
        File<span class="token punctuation">[</span><span class="token punctuation">]</span> fileTopicList <span class="token operator">=</span> dirLogic<span class="token punctuation">.</span><span class="token function">listFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fileTopicList <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// éå†Topicç›®å½•åˆ—è¡¨</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>File fileTopic <span class="token operator">:</span> fileTopicList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Topicåç§°ä¸ºç›®å½•å</span>
                String topic <span class="token operator">=</span> fileTopic<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// è¯¥Topicç›®å½•ä¸‹çš„Queueç›®å½•åˆ—è¡¨</span>
                File<span class="token punctuation">[</span><span class="token punctuation">]</span> fileQueueIdList <span class="token operator">=</span> fileTopic<span class="token punctuation">.</span><span class="token function">listFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>fileQueueIdList <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// éå†è¯¥Topicç›®å½•ä¸‹çš„Queueç›®å½•åˆ—è¡¨</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span>File fileQueueId <span class="token operator">:</span> fileQueueIdList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">int</span> queueId<span class="token punctuation">;</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// é˜Ÿåˆ—Idä¸ºç›®å½•å</span>
                            queueId <span class="token operator">=</span> Integer<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>fileQueueId<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NumberFormatException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">continue</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment" spellcheck="true">// æ ¹æ®Topicå’ŒQueueIdåˆ›å»ºConsumeQueue</span>
                        ConsumeQueue logic <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConsumeQueue</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> StorePathConfigHelper<span class="token punctuation">.</span><span class="token function">getStorePathConsumeQueue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messageStoreConfig<span class="token punctuation">.</span><span class="token function">getStorePathRootDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMappedFileSizeConsumeQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// åŠ å…¥this.consumeQueueTable</span>
                        <span class="token comment" spellcheck="true">// ç»“æ„ä¸ºConcurrentMap&lt;String, ConcurrentMap&lt;Integer, ConsumeQueue>></span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">putConsumeQueue</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> logic<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// åŠ è½½ConsumeQueueï¼Œç±»ä¼¼CommitLogçš„åŠ è½½æ–¹å¼</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>logic<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ConsumeQueue</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token function">ConsumeQueue</span><span class="token punctuation">(</span><span class="token keyword">final</span> String topic<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> queueId<span class="token punctuation">,</span> <span class="token keyword">final</span> String storePath<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> mappedFileSize<span class="token punctuation">,</span> <span class="token keyword">final</span> DefaultMessageStore defaultMessageStore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ConsumeQueueæ–‡ä»¶è·¯å¾„</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>storePath <span class="token operator">=</span> storePath<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ConsumeQueueæ–‡ä»¶å¤§å°</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileSize <span class="token operator">=</span> mappedFileSize<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore <span class="token operator">=</span> defaultMessageStore<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ‰€å±Topic</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>topic <span class="token operator">=</span> topic<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ConsumeQueueçš„Id</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>queueId <span class="token operator">=</span> queueId<span class="token punctuation">;</span>
        String queueDir <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>storePath <span class="token operator">+</span> File<span class="token punctuation">.</span>separator <span class="token operator">+</span> topic <span class="token operator">+</span> File<span class="token punctuation">.</span>separator <span class="token operator">+</span> queueId<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ç±»ä¼¼CommitLogï¼ŒConsumeQueueä¹Ÿæ˜¯è¿ç»­çš„æ–‡ä»¶ï¼Œä¸€ä¸ªConsumeQueueå¯èƒ½åˆ†å¤šä¸ªæ–‡ä»¶å­˜å‚¨ï¼Œå·®åˆ«å°±æ˜¯ConsumeQueueçš„å•å…ƒå†…å®¹æ˜¯å®šé•¿çš„</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MappedFileQueue</span><span class="token punctuation">(</span>queueDir<span class="token punctuation">,</span> mappedFileSize<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>byteBufferIndex <span class="token operator">=</span> ByteBuffer<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>CQ_STORE_UNIT_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEnableConsumeQueueExt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>consumeQueueExt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConsumeQueueExt</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> StorePathConfigHelper<span class="token punctuation">.</span><span class="token function">getStorePathConsumeQueueExt</span><span class="token punctuation">(</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStorePathRootDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMappedFileSizeConsumeQueueExt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBitMapLengthConsumeQueueExt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>ConsumeQueue#load</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//</span>
        <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileQueue<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isExtReadEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            result <span class="token operator">&amp;=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>consumeQueueExt<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>IndexService#load</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">boolean</span> lastExitOK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ${user.home}/store/indexç›®å½•</span>
        File dir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>storePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ç›®å½•ä¸‹çš„IndexFileæ–‡ä»¶åˆ—è¡¨</span>
        File<span class="token punctuation">[</span><span class="token punctuation">]</span> files <span class="token operator">=</span> dir<span class="token punctuation">.</span><span class="token function">listFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>files <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ascending order</span>
            Arrays<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>File file <span class="token operator">:</span> files<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    IndexFile f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexFile</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hashSlotNum<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>indexNum<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// åŠ è½½IndexFileï¼Œæ¢å¤ç´¢å¼•</span>
                    f<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// ä¸Šæ¬¡æ˜¯éæ­£å¸¸é€€å‡º</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>lastExitOK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// IndexFileçš„æœ€æ–°ä¸€æ¡æ¶ˆæ¯çš„æ—¶é—´ > æ£€æŸ¥ç‚¹çš„æ—¶é—´ </span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token punctuation">.</span><span class="token function">getEndTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getStoreCheckpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIndexMsgTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// é”€æ¯å¹¶è·³è¿‡</span>
                            f<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">continue</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// åŠ å…¥æ–‡ä»¶åˆ—è¡¨</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>indexFileList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NumberFormatException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<ul>
<li><p>IndexFileçš„åŠŸèƒ½æ˜¯é€šè¿‡Keyæˆ–æ—¶é—´æ¥æŸ¥è¯¢æ¶ˆæ¯</p>
</li>
<li><p>é»˜è®¤ä½ç½®${user.home}/store/index/{fileName}ï¼Œæ–‡ä»¶åä¸ºåˆ›å»ºæ—¶é—´æˆ³</p>
</li>
<li><p>ä¸€ä¸ªIndexFileå¤§å°ä¸º40 + 5000000 * 4 + 20000000 * 20 = 420000040ï¼Œä¾æ¬¡åŒ…æ‹¬ï¼š</p>
</li>
<li><p>IndexHeaderï¼šå…±40å­—èŠ‚</p>
<ul>
<li><p>BeginTimestampï¼šç¬¬ä¸€ä¸ªIndexçš„æ—¶é—´æˆ³ï¼Œ8å­—èŠ‚</p>
</li>
<li><p>EndTimestampï¼šæœ€åä¸€ä¸ªIndexçš„æ—¶é—´æˆ³ï¼Œ8å­—èŠ‚</p>
</li>
<li><p>BeginPhyOffsetï¼šç¬¬ä¸€ä¸ªIndexå¯¹åº”çš„æ¶ˆæ¯åœ¨CommitLogçš„ç‰©ç†åç§»ï¼Œ8å­—èŠ‚</p>
</li>
<li><p>EndPhyOffsetï¼šæœ€åä¸€ä¸ªIndexå¯¹åº”çš„æ¶ˆæ¯åœ¨CommitLogçš„ç‰©ç†åç§»ï¼Œ8å­—èŠ‚</p>
</li>
<li><p>HashSlotCountï¼šå½“å‰Slotçš„æ•°é‡ï¼Œ4å­—èŠ‚</p>
</li>
<li><p>IndexCountï¼šå½“å‰Indexçš„æ•°é‡ï¼Œ4å­—èŠ‚</p>
</li>
</ul>
</li>
<li><p>SlotTableï¼šSlotåˆ—è¡¨ï¼Œå­˜æ”¾è¯¥Slotå¯¹åº”çš„æœ€æ–°çš„Indexçš„åºå·ï¼Œæ¯ä¸ªSlotå…±4å­—èŠ‚ï¼Œé»˜è®¤å…±5000000ä¸ªSlot</p>
</li>
<li><p>IndexLinkedListï¼šIndexåˆ—è¡¨ï¼Œæ¯ä¸ªIndexéƒ½æœ‰åŒSlotçš„å‰ä¸€ä¸ªIndexçš„ä½ç½®åç§»ï¼Œå½¢æˆä¸€ä¸ªé“¾è¡¨ï¼Œæ¯ä¸ªIndexå…±20å­—èŠ‚ï¼Œé»˜è®¤å…±20000000ä¸ªIndex</p>
</li>
</ul>
<p>IndexFile</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token function">IndexFile</span><span class="token punctuation">(</span><span class="token keyword">final</span> String fileName<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> hashSlotNum<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> indexNum<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> endPhyOffset<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> endTimestamp<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>

        <span class="token comment" spellcheck="true">// ä¸€ä¸ªIndexFileå¤§å°ä¸ºï¼š40 + 5000000 * 4 + 20000000 * 20 = 420000040</span>
        <span class="token keyword">int</span> fileTotalSize <span class="token operator">=</span> IndexHeader<span class="token punctuation">.</span>INDEX_HEADER_SIZE <span class="token operator">+</span> <span class="token punctuation">(</span>hashSlotNum <span class="token operator">*</span> hashSlotSize<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>indexNum <span class="token operator">*</span> indexSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// MappedFile</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MappedFile</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span> fileTotalSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fileChannel <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFile<span class="token punctuation">.</span><span class="token function">getFileChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>mappedByteBuffer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFile<span class="token punctuation">.</span><span class="token function">getMappedByteBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Slotæ•°é‡ï¼Œé»˜è®¤5000000</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>hashSlotNum <span class="token operator">=</span> hashSlotNum<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Indexæ•°é‡</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>indexNum <span class="token operator">=</span> indexNum<span class="token punctuation">;</span>
        ByteBuffer byteBuffer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedByteBuffer<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å°†æ˜ å°„çš„å­ç¼“å†²ä¼ å…¥IndexHeader</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>indexHeader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IndexHeader</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>endPhyOffset <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>indexHeader<span class="token punctuation">.</span><span class="token function">setBeginPhyOffset</span><span class="token punctuation">(</span>endPhyOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>indexHeader<span class="token punctuation">.</span><span class="token function">setEndPhyOffset</span><span class="token punctuation">(</span>endPhyOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>endTimestamp <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>indexHeader<span class="token punctuation">.</span><span class="token function">setBeginTimestamp</span><span class="token punctuation">(</span>endTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>indexHeader<span class="token punctuation">.</span><span class="token function">setEndTimestamp</span><span class="token punctuation">(</span>endTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>IndexFile#load</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ä»æ–‡ä»¶ä¸­æ¢å¤å¤´éƒ¨çš„å„é¡¹æ•°æ®åˆ°IndexHeader</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>indexHeader<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>IndexHeader#load</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>beginTimestamp<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span>beginTimestampIndex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>endTimestamp<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span>endTimestampIndex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>beginPhyOffset<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span>beginPhyoffsetIndex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>endPhyOffset<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span>endPhyoffsetIndex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>hashSlotCount<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>hashSlotcountIndex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>indexCount<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>byteBuffer<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>indexCountIndex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>indexCount<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>indexCount<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>DefaultMessageStore#recover</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">boolean</span> lastExitOK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// æ¢å¤ConsumeQueueçš„åˆ·ç›˜æŒ‡é’ˆï¼Œè¿”å›æœ€å¤§çš„ç‰©ç†åç§»</span>
        <span class="token keyword">long</span> maxPhyOffsetOfConsumeQueue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">recoverConsumeQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lastExitOK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ­£å¸¸æ¢å¤CommitLogçš„åˆ·ç›˜æŒ‡é’ˆï¼Œå’Œä¸Šé¢å·®ä¸å¤šï¼Œä¹Ÿæ˜¯ä»æœ€åä¸‰ä¸ªæ–‡ä»¶å¼€å§‹éå†æ£€æŸ¥</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>commitLog<span class="token punctuation">.</span><span class="token function">recoverNormally</span><span class="token punctuation">(</span>maxPhyOffsetOfConsumeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>commitLog<span class="token punctuation">.</span><span class="token function">recoverAbnormally</span><span class="token punctuation">(</span>maxPhyOffsetOfConsumeQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// æ¢å¤TopicQueue</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">recoverTopicQueueTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>DefaultMessageStore#recoverConsumeQueue</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">long</span> <span class="token function">recoverConsumeQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> maxPhysicOffset <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// éå†æ‰€æœ‰çš„Topic</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>ConcurrentMap<span class="token operator">&lt;</span>Integer<span class="token punctuation">,</span> ConsumeQueue<span class="token operator">></span> maps <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>consumeQueueTable<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// éå†æ‰€æœ‰çš„ConsumeQueue</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>ConsumeQueue logic <span class="token operator">:</span> maps<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æ£€æŸ¥ConsumeQueueå†…å®¹ï¼Œå¹¶æ¢å¤åˆ·ç›˜æŒ‡é’ˆ</span>
                logic<span class="token punctuation">.</span><span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>logic<span class="token punctuation">.</span><span class="token function">getMaxPhysicOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> maxPhysicOffset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// æ›´æ–°æœ€å¤§åç§»</span>
                    maxPhysicOffset <span class="token operator">=</span> logic<span class="token punctuation">.</span><span class="token function">getMaxPhysicOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// è¿”å›ConsumeQueueçš„æœ€å¤§ç‰©ç†åç§»</span>
        <span class="token keyword">return</span> maxPhysicOffset<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ConsumeQueue#recover</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ä¸€ä¸ªConsumeQueueä¸‹æœ‰å¤šä¸ªæ–‡ä»¶ï¼Œå…ˆè·å–MappedFileæ˜ å°„åˆ—è¡¨</span>
        <span class="token keyword">final</span> List<span class="token operator">&lt;</span>MappedFile<span class="token operator">></span> mappedFiles <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileQueue<span class="token punctuation">.</span><span class="token function">getMappedFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mappedFiles<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ä»å€’æ•°ç¬¬ä¸‰ä¸ªæ–‡ä»¶å¼€å§‹</span>
            <span class="token keyword">int</span> index <span class="token operator">=</span> mappedFiles<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> mappedFileSizeLogics <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileSize<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è·å–å¯¹åº”ä½ç½®çš„MappedFile</span>
            MappedFile mappedFile <span class="token operator">=</span> mappedFiles<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// åˆ†å‡ºä¸ªå­ç¼“å†²ï¼Œç»´æŠ¤ç‹¬ç«‹ç´¢å¼•</span>
            ByteBuffer byteBuffer <span class="token operator">=</span> mappedFile<span class="token punctuation">.</span><span class="token function">sliceByteBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ–‡ä»¶å/èµ·å§‹åç§»</span>
            <span class="token keyword">long</span> processOffset <span class="token operator">=</span> mappedFile<span class="token punctuation">.</span><span class="token function">getFileFromOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//</span>
            <span class="token keyword">long</span> mappedFileOffset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">long</span> maxExtAddr <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// éå†æ£€éªŒConsumeQueueæ‰€æœ‰å•å…ƒï¼Œæ¯æ¬¡éå†å•ä½ä¸ºä¸€ä¸ªå•å…ƒå¤§å°ï¼Œ20å­—èŠ‚</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> mappedFileSizeLogics<span class="token punctuation">;</span> i <span class="token operator">+=</span> CQ_STORE_UNIT_SIZE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// æ¶ˆæ¯åœ¨CommitLogçš„åç§»ï¼Œ8å­—èŠ‚</span>
                    <span class="token keyword">long</span> offset <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// æ¶ˆæ¯æ€»é•¿åº¦ï¼Œ4å­—èŠ‚</span>
                    <span class="token keyword">int</span> size <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// æ¶ˆæ¯çš„TagsCodeï¼Œ8å­—èŠ‚</span>
                    <span class="token keyword">long</span> tagsCode <span class="token operator">=</span> byteBuffer<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// è¯´æ˜ä¸æ˜¯ç©ºç™½</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>offset <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> size <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ç´¯è®¡æ‰€æœ‰å•å…ƒçš„å¤§å°</span>
                        mappedFileOffset <span class="token operator">=</span> i <span class="token operator">+</span> CQ_STORE_UNIT_SIZE<span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// ç´¯è®¡æœ€å¤§ç‰©ç†åç§»</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>maxPhysicOffset <span class="token operator">=</span> offset <span class="token operator">+</span> size<span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isExtAddr</span><span class="token punctuation">(</span>tagsCode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            maxExtAddr <span class="token operator">=</span> tagsCode<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// æ–‡ä»¶æœ‰å¼‚å¸¸ï¼Œæˆ–è€…å½“å‰æ–‡ä»¶åˆ°äº†ç»“å°¾</span>
                    <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// forå¾ªç¯ç»“æŸï¼Œå½“å‰æ–‡ä»¶æ£€éªŒç»“æŸ</span>
                <span class="token comment" spellcheck="true">// è¯´æ˜è¯¥æ–‡ä»¶æ‰€æœ‰å•å…ƒéƒ½åˆæ³•</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mappedFileOffset <span class="token operator">==</span> mappedFileSizeLogics<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ç»§ç»­ä¸‹ä¸€ä¸ªMappedFile</span>
                    index<span class="token operator">++</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// æ‰€æœ‰MappedFileæ£€æŸ¥å®Œæ¯•</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">>=</span> mappedFiles<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// å†è§</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ä¸‹ä¸€ä¸ªMappedFileï¼Œç»§ç»­å¾ªç¯</span>
                        mappedFile <span class="token operator">=</span> mappedFiles<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        byteBuffer <span class="token operator">=</span> mappedFile<span class="token punctuation">.</span><span class="token function">sliceByteBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        processOffset <span class="token operator">=</span> mappedFile<span class="token punctuation">.</span><span class="token function">getFileFromOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        mappedFileOffset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// æ–‡ä»¶æœ‰å¼‚å¸¸ï¼Œä¸ç”¨ç»§ç»­æ£€æŸ¥äº†</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// whileå¾ªç¯ç»“æŸï¼Œæ‰€æœ‰æ–‡ä»¶æ£€éªŒç»“æŸ</span>
            <span class="token comment" spellcheck="true">// æœ€åä¸€ä¸ªæœ‰æ•ˆçš„ConsumeQueueæ–‡ä»¶çš„æœ€å¤§åç§»</span>
            processOffset <span class="token operator">+=</span> mappedFileOffset<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ¢å¤æŒ‡é’ˆ</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileQueue<span class="token punctuation">.</span><span class="token function">setFlushedWhere</span><span class="token punctuation">(</span>processOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileQueue<span class="token punctuation">.</span><span class="token function">setCommittedWhere</span><span class="token punctuation">(</span>processOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æˆªæ–­åé¢æ— æ•ˆçš„æ–‡ä»¶</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileQueue<span class="token punctuation">.</span><span class="token function">truncateDirtyFiles</span><span class="token punctuation">(</span>processOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isExtReadEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>consumeQueueExt<span class="token punctuation">.</span><span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">//</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>consumeQueueExt<span class="token punctuation">.</span><span class="token function">truncateByMaxAddress</span><span class="token punctuation">(</span>maxExtAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>ConsumeQueue#recoverTopicQueueTable</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">recoverTopicQueueTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        HashMap<span class="token operator">&lt;</span>String<span class="token comment" spellcheck="true">/* topic-queueid */</span><span class="token punctuation">,</span> Long<span class="token comment" spellcheck="true">/* offset */</span><span class="token operator">></span> table <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Long<span class="token operator">></span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// CommitLogçš„æœ€å°ç‰©ç†åç§»</span>
        <span class="token keyword">long</span> minPhyOffset <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>commitLog<span class="token punctuation">.</span><span class="token function">getMinOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// éå†æ‰€æœ‰Topic</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>ConcurrentMap<span class="token operator">&lt;</span>Integer<span class="token punctuation">,</span> ConsumeQueue<span class="token operator">></span> maps <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>consumeQueueTable<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// éå†Topicä¸‹æ‰€æœ‰ConsumeQueue</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>ConsumeQueue logic <span class="token operator">:</span> maps<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Topic + "-" + QueueId</span>
                String key <span class="token operator">=</span> logic<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"-"</span> <span class="token operator">+</span> logic<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å€¼ä¸ºConsumeQueueå†…æ¶ˆæ¯çš„æ•°é‡ï¼ŒMaxOffset / CQ_STORE_UNIT_SIZE</span>
                table<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> logic<span class="token punctuation">.</span><span class="token function">getMaxOffsetInQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// æ‰©å±•ç›¸å…³ï¼Œå¿½ç•¥</span>
                logic<span class="token punctuation">.</span><span class="token function">correctMinOffset</span><span class="token punctuation">(</span>minPhyOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// è®¾å›å»</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>commitLog<span class="token punctuation">.</span><span class="token function">setTopicQueueTable</span><span class="token punctuation">(</span>table<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>BrokerController#registerProcessor</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">/**
         * SendMessageProcessor
         */</span>
        SendMessageProcessor sendProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SendMessageProcessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sendProcessor<span class="token punctuation">.</span><span class="token function">registerSendMessageHook</span><span class="token punctuation">(</span>sendMessageHookList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        sendProcessor<span class="token punctuation">.</span><span class="token function">registerConsumeMessageHook</span><span class="token punctuation">(</span>consumeMessageHookList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¤„ç†Producerå‘é€çš„æ¶ˆæ¯</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>remotingServer<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>SEND_MESSAGE<span class="token punctuation">,</span> sendProcessor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sendMessageExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>remotingServer<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>SEND_MESSAGE_V2<span class="token punctuation">,</span> sendProcessor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sendMessageExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¤„ç†Producerå‘é€çš„æ‰¹é‡æ¶ˆæ¯</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>remotingServer<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>SEND_BATCH_MESSAGE<span class="token punctuation">,</span> sendProcessor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sendMessageExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¤„ç†Consumerå°†æ¶ˆæ¯å‘å›Brokerçš„æ¶ˆæ¯ï¼Œè¦æ±‚é‡æ–°æ¶ˆè´¹</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>remotingServer<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>CONSUMER_SEND_MSG_BACK<span class="token punctuation">,</span> sendProcessor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sendMessageExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// VIPChannelå…±ç”¨å¤„ç†å™¨å’Œä¸šåŠ¡çº¿ç¨‹æ± ï¼Œåªæ˜¯ç›‘å¬çš„ç«¯å£ä¸åŒ</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fastRemotingServer<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>SEND_MESSAGE<span class="token punctuation">,</span> sendProcessor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sendMessageExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fastRemotingServer<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>SEND_MESSAGE_V2<span class="token punctuation">,</span> sendProcessor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sendMessageExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fastRemotingServer<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>SEND_BATCH_MESSAGE<span class="token punctuation">,</span> sendProcessor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sendMessageExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fastRemotingServer<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>CONSUMER_SEND_MSG_BACK<span class="token punctuation">,</span> sendProcessor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sendMessageExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">/**
         * PullMessageProcessor
         */</span>
        <span class="token comment" spellcheck="true">// å¤„ç†Consumeræ‹‰å–æ¶ˆæ¯è¯·æ±‚ï¼ŒVIPChannelæ²¡æœ‰è¿™ä¸ª</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>remotingServer<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>PULL_MESSAGE<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pullMessageProcessor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pullMessageExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ä¸€äº›Hook</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>pullMessageProcessor<span class="token punctuation">.</span><span class="token function">registerConsumeMessageHook</span><span class="token punctuation">(</span>consumeMessageHookList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">/**
         * QueryMessageProcessor
         */</span>
        <span class="token comment" spellcheck="true">// æŸ¥è¯¢æ¶ˆæ¯æ¥å£ï¼ŒIndex</span>
        NettyRequestProcessor queryProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QueryMessageProcessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>remotingServer<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>QUERY_MESSAGE<span class="token punctuation">,</span> queryProcessor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>queryMessageExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>remotingServer<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>VIEW_MESSAGE_BY_ID<span class="token punctuation">,</span> queryProcessor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>queryMessageExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fastRemotingServer<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>QUERY_MESSAGE<span class="token punctuation">,</span> queryProcessor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>queryMessageExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fastRemotingServer<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>VIEW_MESSAGE_BY_ID<span class="token punctuation">,</span> queryProcessor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>queryMessageExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">/**
         * ClientManageProcessor
         */</span>
        ClientManageProcessor clientProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClientManageProcessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¤„ç†å®¢æˆ·ç«¯å¦‚Producerå’ŒConsumerçš„å¿ƒè·³</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>remotingServer<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>HEART_BEAT<span class="token punctuation">,</span> clientProcessor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>heartbeatExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>remotingServer<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>UNREGISTER_CLIENT<span class="token punctuation">,</span> clientProcessor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clientManageExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>remotingServer<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>CHECK_CLIENT_CONFIG<span class="token punctuation">,</span> clientProcessor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clientManageExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fastRemotingServer<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>HEART_BEAT<span class="token punctuation">,</span> clientProcessor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>heartbeatExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fastRemotingServer<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>UNREGISTER_CLIENT<span class="token punctuation">,</span> clientProcessor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clientManageExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fastRemotingServer<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>CHECK_CLIENT_CONFIG<span class="token punctuation">,</span> clientProcessor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clientManageExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">/**
         * ConsumerManageProcessor
         */</span>
        ConsumerManageProcessor consumerManageProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConsumerManageProcessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¤„ç†Consumerå‘é€çš„æ ¹æ®ConsumerGroupæŸ¥è¯¢Consumeråˆ—è¡¨è¯·æ±‚</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>remotingServer<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>GET_CONSUMER_LIST_BY_GROUP<span class="token punctuation">,</span> consumerManageProcessor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>consumerManageExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¤„ç†Consumerå‘é€çš„æ›´æ–°Consumeræ¶ˆè´¹è¿›åº¦åç§»è¯·æ±‚</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>remotingServer<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>UPDATE_CONSUMER_OFFSET<span class="token punctuation">,</span> consumerManageProcessor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>consumerManageExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¤„ç†Consumerå‘é€çš„æŸ¥è¯¢Consumeræ¶ˆè´¹è¿›åº¦åç§»è¯·æ±‚</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>remotingServer<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>QUERY_CONSUMER_OFFSET<span class="token punctuation">,</span> consumerManageProcessor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>consumerManageExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fastRemotingServer<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>GET_CONSUMER_LIST_BY_GROUP<span class="token punctuation">,</span> consumerManageProcessor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>consumerManageExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fastRemotingServer<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>UPDATE_CONSUMER_OFFSET<span class="token punctuation">,</span> consumerManageProcessor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>consumerManageExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fastRemotingServer<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>QUERY_CONSUMER_OFFSET<span class="token punctuation">,</span> consumerManageProcessor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>consumerManageExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">/**
         * EndTransactionProcessor
         */</span>
        <span class="token comment" spellcheck="true">// å¤„ç†ç»“æŸäº‹åŠ¡æ¶ˆæ¯</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>remotingServer<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>END_TRANSACTION<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">EndTransactionProcessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>endTransactionExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fastRemotingServer<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>END_TRANSACTION<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">EndTransactionProcessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>endTransactionExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">/**
         * Default
         */</span>
        AdminBrokerProcessor adminProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AdminBrokerProcessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Fallbackçš„å¤„ç†å™¨ï¼Œå¤„ç†å…¶å®ƒè¯·æ±‚</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>remotingServer<span class="token punctuation">.</span><span class="token function">registerDefaultProcessor</span><span class="token punctuation">(</span>adminProcessor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>adminBrokerExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fastRemotingServer<span class="token punctuation">.</span><span class="token function">registerDefaultProcessor</span><span class="token punctuation">(</span>adminProcessor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>adminBrokerExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


        <footer>
             
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

        </footer>
    </div>
    <!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
    <script>
        var timeEnd = new Date();
        console.log('è€—æ—¶ï¼š' + (timeEnd - timeStart));
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre').forEach((block) => {
                block.classList.add("line-numbers");
            });
        });
    </script>
    <!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
    <!-- material design -->
    <!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
    <!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
    <!-- toc -->
    <!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
    <!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
    <!-- <script src="/js/main.js"></script> -->
    <script src="/js/prism.js"></script>
</body>
</html>
