<!DOCTYPE HTML>
<html>
	<head><meta name="generator" content="Hexo 3.9.0">
		<meta charset="utf-8">
		<script src="/js/highlight.js"></script>
				<script>hljs.initHighlightingOnLoad();var timeStart = new Date();</script>
		
		<title>[笔记]-RocketMQ-Broker-Initialize | 学而时习之</title>
		
		<meta name="author" content="Huangzhike">
		
		
		<meta name="description" content="K.I.S.S">
		
		
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		
		<meta property="og:title" content="[笔记]-RocketMQ-Broker-Initialize">
		
		<meta property="og:site_name" content="学而时习之">
		
		
		<!-- favicon -->
		<link rel="icon" type="image/ico" href="/ok.ico" sizes="32x32">
 


		<meta name="msapplication-TileColor" content="#009688">
		<meta name="msapplication-TileImage" content="/mstile-144x144.ico">
		<meta name="theme-color" content="#009688">

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Didact+Gothic"> 

		<!-- favicon end -->
		<!-- <link href="//ok.ico" rel="icon"> -->
		
		<!-- toc -->
		<!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
		<!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
		<!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
		<!-- material design -->
		<!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
		<!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
		<!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
		<!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
		<!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
		<link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
		 
		 
		<!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
		<!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
	</head>
</html>
<body>
	<nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">菜单</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" href="/">学而时习之</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

	<div class="container" >
		<div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[笔记]-RocketMQ-Broker-Initialize</h2>
				
				<div>
					<div class="post-time">2019-10-21</div>
				</div>
				
				<div class="article-content">
				<p>BrokerController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">BrokerController</span><span class="params">(<span class="keyword">final</span> BrokerConfig brokerConfig, <span class="keyword">final</span> NettyServerConfig nettyServerConfig, <span class="keyword">final</span> NettyClientConfig nettyClientConfig, <span class="keyword">final</span> MessageStoreConfig messageStoreConfig)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 创建一些内置Topic</span></span><br><span class="line">    <span class="keyword">this</span>.topicConfigManager = <span class="keyword">new</span> TopicConfigManager(<span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>TopicConfigManager</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">TopicConfigManager</span><span class="params">(BrokerController brokerController)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.brokerController = brokerController;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// MixAll.SELF_TEST_TOPIC</span></span><br><span class="line">        <span class="comment">// 创建一个自我测试主题SELF_TEST_TOPIC</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// MixAll.AUTO_CREATE_TOPIC_KEY_TOPIC</span></span><br><span class="line">        <span class="comment">// 如果允许自动创建Topic，添加一个默认的主题TBW102</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.brokerController.getBrokerConfig().isAutoCreateTopicEnable()) &#123;</span><br><span class="line">            String topic = MixAll.AUTO_CREATE_TOPIC_KEY_TOPIC;</span><br><span class="line">            TopicConfig topicConfig = <span class="keyword">new</span> TopicConfig(topic);</span><br><span class="line">            <span class="keyword">this</span>.systemTopicList.add(topic);</span><br><span class="line">            <span class="comment">// 默认8</span></span><br><span class="line">            topicConfig.setReadQueueNums(<span class="keyword">this</span>.brokerController.getBrokerConfig().getDefaultTopicQueueNums());</span><br><span class="line">            <span class="comment">// 默认8</span></span><br><span class="line">            topicConfig.setWriteQueueNums(<span class="keyword">this</span>.brokerController.getBrokerConfig().getDefaultTopicQueueNums());</span><br><span class="line">            <span class="keyword">int</span> perm = PermName.PERM_INHERIT | PermName.PERM_READ | PermName.PERM_WRITE;</span><br><span class="line">            topicConfig.setPerm(perm);</span><br><span class="line">            <span class="keyword">this</span>.topicConfigTable.put(topicConfig.getTopicName(), topicConfig);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// MixAll.BENCHMARK_TOPIC</span></span><br><span class="line">        <span class="comment">// 创建一个跑分主题BenchmarkTest</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 创建一个Broker集群名主题，默认DefaultCluster</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 创建一个Broker名主题，默认为Broker所在的主机名</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// MixAll.OFFSET_MOVED_EVENT</span></span><br><span class="line">        <span class="comment">// 创建一个OFFSET_MOVED_EVENT主题</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// MixAll.RMQ_SYS_TRACE_TOPIC</span></span><br><span class="line">        <span class="comment">// 如果Broker启用了主题跟踪，创建一个RMQ_SYS_TRACE_TOPIC主题，默认不启用</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>BrokerController#initialize</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">initialize</span><span class="params">()</span> <span class="keyword">throws</span> CloneNotSupportedException </span>&#123;</span><br><span class="line">    <span class="comment">// Broker启动时不从NameServer请求Topic配置，从本地JSON文件加载，默认$&#123;user.home&#125;/store/config/topics.json</span></span><br><span class="line">    <span class="keyword">boolean</span> result = <span class="keyword">this</span>.topicConfigManager.load();</span><br><span class="line">    <span class="comment">// 从本地文件加载Consumer的消费进度偏移，默认$&#123;user.home&#125;/store/config/consumerOffset.json</span></span><br><span class="line">    result = result &amp;&amp; <span class="keyword">this</span>.consumerOffsetManager.load();</span><br><span class="line">    <span class="comment">// 从本地文件加载订阅组，默认$&#123;user.home&#125;/store/config/subscriptionGroup.json</span></span><br><span class="line">    result = result &amp;&amp; <span class="keyword">this</span>.subscriptionGroupManager.load();</span><br><span class="line">    <span class="comment">// 默认$&#123;user.home&#125;/store/config/consumerFilter.json</span></span><br><span class="line">    result = result &amp;&amp; <span class="keyword">this</span>.consumerFilterManager.load();</span><br><span class="line">    <span class="keyword">if</span> (result) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 用于管理消息存储等</span></span><br><span class="line">            <span class="keyword">this</span>.messageStore = <span class="keyword">new</span> DefaultMessageStore(<span class="keyword">this</span>.messageStoreConfig, <span class="keyword">this</span>.brokerStatsManager, <span class="keyword">this</span>.messageArrivingListener, <span class="keyword">this</span>.brokerConfig);</span><br><span class="line">            <span class="comment">// 默认不启用</span></span><br><span class="line">            <span class="keyword">if</span> (messageStoreConfig.isEnableDLegerCommitLog()) &#123;</span><br><span class="line">                DLedgerRoleChangeHandler roleChangeHandler = <span class="keyword">new</span> DLedgerRoleChangeHandler(<span class="keyword">this</span>, (DefaultMessageStore) messageStore);</span><br><span class="line">                ((DLedgerCommitLog) ((DefaultMessageStore) messageStore).getCommitLog()).getdLedgerServer().getdLedgerLeaderElector().addRoleChangeHandler(roleChangeHandler);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 用于统计数据</span></span><br><span class="line">            <span class="keyword">this</span>.brokerStats = <span class="keyword">new</span> BrokerStats((DefaultMessageStore) <span class="keyword">this</span>.messageStore);</span><br><span class="line">            <span class="comment">// 上下文</span></span><br><span class="line">            MessageStorePluginContext context = <span class="keyword">new</span> MessageStorePluginContext(messageStoreConfig, brokerStatsManager, messageArrivingListener, brokerConfig);</span><br><span class="line">            <span class="comment">// 包装MessageStore，没发现有什么用，直接忽略</span></span><br><span class="line">            <span class="keyword">this</span>.messageStore = MessageStoreFactory.build(context, <span class="keyword">this</span>.messageStore);</span><br><span class="line">            <span class="keyword">this</span>.messageStore.getDispatcherList().addFirst(<span class="keyword">new</span> CommitLogDispatcherCalcBitMap(<span class="keyword">this</span>.brokerConfig, <span class="keyword">this</span>.consumerFilterManager));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 从持久化文件加载CommitLog、ConsumeQueue、IndexFile，并恢复进度</span></span><br><span class="line">    result = result &amp;&amp; <span class="keyword">this</span>.messageStore.load();</span><br><span class="line">    <span class="keyword">if</span> (result) &#123;</span><br><span class="line">        <span class="comment">// 远程通讯服务器，ClientHousekeepingService监听通道变化，处理Producer和Consumer的连接存活情况</span></span><br><span class="line">        <span class="keyword">this</span>.remotingServer = <span class="keyword">new</span> NettyRemotingServer(<span class="keyword">this</span>.nettyServerConfig, <span class="keyword">this</span>.clientHousekeepingService);</span><br><span class="line">        NettyServerConfig fastConfig = (NettyServerConfig) <span class="keyword">this</span>.nettyServerConfig.clone();</span><br><span class="line">        <span class="comment">// VIP通道，不处理Consumer的PullRequest</span></span><br><span class="line">        fastConfig.setListenPort(nettyServerConfig.getListenPort() - <span class="number">2</span>);</span><br><span class="line">        <span class="comment">// 远程通讯服务器，和上面的共用业务处理器和业务线程池，只是端口和IO线程池不一样</span></span><br><span class="line">        <span class="keyword">this</span>.fastRemotingServer = <span class="keyword">new</span> NettyRemotingServer(fastConfig, <span class="keyword">this</span>.clientHousekeepingService);</span><br><span class="line">        <span class="comment">// 处理Producer消息的线程池</span></span><br><span class="line">        <span class="keyword">this</span>.sendMessageExecutor = <span class="keyword">new</span> BrokerFixedThreadPoolExecutor(<span class="keyword">this</span>.brokerConfig.getSendMessageThreadPoolNums(), <span class="keyword">this</span>.brokerConfig.getSendMessageThreadPoolNums(), <span class="number">1000</span> * <span class="number">60</span>, TimeUnit.MILLISECONDS, <span class="keyword">this</span>.sendThreadPoolQueue, <span class="keyword">new</span> ThreadFactoryImpl(<span class="string">"SendMessageThread_"</span>));</span><br><span class="line">        <span class="comment">// 处理Consumer消息的线程池</span></span><br><span class="line">        <span class="keyword">this</span>.pullMessageExecutor = <span class="keyword">new</span> BrokerFixedThreadPoolExecutor(<span class="keyword">this</span>.brokerConfig.getPullMessageThreadPoolNums(), <span class="keyword">this</span>.brokerConfig.getPullMessageThreadPoolNums(), <span class="number">1000</span> * <span class="number">60</span>, TimeUnit.MILLISECONDS, <span class="keyword">this</span>.pullThreadPoolQueue, <span class="keyword">new</span> ThreadFactoryImpl(<span class="string">"PullMessageThread_"</span>));</span><br><span class="line">        <span class="comment">// 处理消息查询的线程池</span></span><br><span class="line">        <span class="keyword">this</span>.queryMessageExecutor = <span class="keyword">new</span> BrokerFixedThreadPoolExecutor(<span class="keyword">this</span>.brokerConfig.getQueryMessageThreadPoolNums(), <span class="keyword">this</span>.brokerConfig.getQueryMessageThreadPoolNums(), <span class="number">1000</span> * <span class="number">60</span>, TimeUnit.MILLISECONDS, <span class="keyword">this</span>.queryThreadPoolQueue, <span class="keyword">new</span> ThreadFactoryImpl(<span class="string">"QueryMessageThread_"</span>));</span><br><span class="line">        <span class="comment">// 处理Broker管理的线程池</span></span><br><span class="line">        <span class="keyword">this</span>.adminBrokerExecutor = Executors.newFixedThreadPool(<span class="keyword">this</span>.brokerConfig.getAdminBrokerThreadPoolNums(), <span class="keyword">new</span> ThreadFactoryImpl(<span class="string">"AdminBrokerThread_"</span>));</span><br><span class="line">        <span class="comment">// 处理Client管理的线程池</span></span><br><span class="line">        <span class="keyword">this</span>.clientManageExecutor = <span class="keyword">new</span> ThreadPoolExecutor(<span class="keyword">this</span>.brokerConfig.getClientManageThreadPoolNums(), <span class="keyword">this</span>.brokerConfig.getClientManageThreadPoolNums(), <span class="number">1000</span> * <span class="number">60</span>, TimeUnit.MILLISECONDS, <span class="keyword">this</span>.clientManagerThreadPoolQueue, <span class="keyword">new</span> ThreadFactoryImpl(<span class="string">"ClientManageThread_"</span>));</span><br><span class="line">        <span class="comment">// 处理心跳的线程池</span></span><br><span class="line">        <span class="keyword">this</span>.heartbeatExecutor = <span class="keyword">new</span> BrokerFixedThreadPoolExecutor(<span class="keyword">this</span>.brokerConfig.getHeartbeatThreadPoolNums(), <span class="keyword">this</span>.brokerConfig.getHeartbeatThreadPoolNums(), <span class="number">1000</span> * <span class="number">60</span>, TimeUnit.MILLISECONDS, <span class="keyword">this</span>.heartbeatThreadPoolQueue, <span class="keyword">new</span> ThreadFactoryImpl(<span class="string">"HeartbeatThread_"</span>, <span class="keyword">true</span>));</span><br><span class="line">        <span class="comment">// 处理事务的线程池</span></span><br><span class="line">        <span class="keyword">this</span>.endTransactionExecutor = <span class="keyword">new</span> BrokerFixedThreadPoolExecutor(<span class="keyword">this</span>.brokerConfig.getEndTransactionThreadPoolNums(), <span class="keyword">this</span>.brokerConfig.getEndTransactionThreadPoolNums(), <span class="number">1000</span> * <span class="number">60</span>, TimeUnit.MILLISECONDS, <span class="keyword">this</span>.endTransactionThreadPoolQueue, <span class="keyword">new</span> ThreadFactoryImpl(<span class="string">"EndTransactionThread_"</span>));</span><br><span class="line">        <span class="comment">// 处理Consumer管理的线程池</span></span><br><span class="line">        <span class="keyword">this</span>.consumerManageExecutor = Executors.newFixedThreadPool(<span class="keyword">this</span>.brokerConfig.getConsumerManageThreadPoolNums(), <span class="keyword">new</span> ThreadFactoryImpl(<span class="string">"ConsumerManageThread_"</span>));</span><br><span class="line">        <span class="comment">// 注册消息处理器，及处理的线程池</span></span><br><span class="line">        <span class="keyword">this</span>.registerProcessor();</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="comment">// 计划任务，每日一次，打印Broker统计数据相关</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="comment">// 计划任务，每五秒一次，持久化Consumer消费偏移</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="comment">// 计划任务，每十秒一次，持久化ConsumerFilter</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="comment">// 计划任务，每三分钟一次，如果Consumer消费延时太大，禁用该Consumer，不再向它投递消息</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="comment">// 计划任务，每一秒一次，打印生产消费队列信息</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="comment">// 计划任务，每分钟一次，打印Dispatch落后情况</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="comment">// 如果系统变量、环境变量、程序指定了NameServer地址</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.brokerConfig.getNamesrvAddr() != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 更新本地NameServer地址列表缓存</span></span><br><span class="line">            <span class="keyword">this</span>.brokerOuterAPI.updateNameServerAddressList(<span class="keyword">this</span>.brokerConfig.getNamesrvAddr());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 没有指定NameServer地址，如果设置从远程获取NameServer地址</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.brokerConfig.isFetchNamesrvAddrByAddressServer()) &#123;</span><br><span class="line">            <span class="comment">// 计划任务，每两分钟一次，从指定的HTTP接口更新NameServer地址信息</span></span><br><span class="line">            <span class="keyword">this</span>.scheduledExecutorService.scheduleAtFixedRate(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    BrokerController.<span class="keyword">this</span>.brokerOuterAPI.fetchNameServerAddr();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    <span class="comment">// ...</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="number">1000</span> * <span class="number">10</span>, <span class="number">1000</span> * <span class="number">60</span> * <span class="number">2</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 默认</span></span><br><span class="line">        <span class="keyword">if</span> (!messageStoreConfig.isEnableDLegerCommitLog()) &#123;</span><br><span class="line">            <span class="comment">// SLAVE</span></span><br><span class="line">            <span class="keyword">if</span> (BrokerRole.SLAVE == <span class="keyword">this</span>.messageStoreConfig.getBrokerRole()) &#123;</span><br><span class="line">                <span class="comment">// 配置了高可用Master地址</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.messageStoreConfig.getHaMasterAddress() != <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.messageStoreConfig.getHaMasterAddress().length() &gt;= <span class="number">6</span>) &#123;</span><br><span class="line">                    <span class="comment">// 更新本地Master地址缓存</span></span><br><span class="line">                    <span class="keyword">this</span>.messageStore.updateHaMasterAddress(<span class="keyword">this</span>.messageStoreConfig.getHaMasterAddress());</span><br><span class="line">                    <span class="comment">// 不需要周期性更新Master地址</span></span><br><span class="line">                    <span class="keyword">this</span>.updateMasterHAServerAddrPeriodically = <span class="keyword">false</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">this</span>.updateMasterHAServerAddrPeriodically = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// MASTER</span></span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 计划任务，打印Slave落后的信息Diff</span></span><br><span class="line">                <span class="comment">// ...</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (TlsSystemConfig.tlsMode != TlsMode.DISABLED) &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 初始化事务消息服务</span></span><br><span class="line">        initialTransaction();</span><br><span class="line">        <span class="comment">// Access Control List</span></span><br><span class="line">        initialAcl();</span><br><span class="line">        <span class="comment">// 注册一些钩子</span></span><br><span class="line">        initialRpcHooks();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p>DefaultMessageStore</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DefaultMessageStore</span><span class="params">(<span class="keyword">final</span> MessageStoreConfig messageStoreConfig, <span class="keyword">final</span> BrokerStatsManager brokerStatsManager, <span class="keyword">final</span> MessageArrivingListener messageArrivingListener, <span class="keyword">final</span> BrokerConfig brokerConfig)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// 消息到达监听器</span></span><br><span class="line">    <span class="keyword">this</span>.messageArrivingListener = messageArrivingListener;</span><br><span class="line">    <span class="keyword">this</span>.brokerConfig = brokerConfig;</span><br><span class="line">    <span class="keyword">this</span>.messageStoreConfig = messageStoreConfig;</span><br><span class="line">    <span class="comment">// Broker统计管理</span></span><br><span class="line">    <span class="keyword">this</span>.brokerStatsManager = brokerStatsManager;</span><br><span class="line">    <span class="keyword">this</span>.allocateMappedFileService = <span class="keyword">new</span> AllocateMappedFileService(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">if</span> (messageStoreConfig.isEnableDLegerCommitLog()) &#123;</span><br><span class="line">        <span class="keyword">this</span>.commitLog = <span class="keyword">new</span> DLedgerCommitLog(<span class="keyword">this</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// CommitLog</span></span><br><span class="line">        <span class="keyword">this</span>.commitLog = <span class="keyword">new</span> CommitLog(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 所有消息都存储在CommitLog中，但是Consumer按Topic和Queue消费消息</span></span><br><span class="line"><span class="comment">     * 所以每个Topic下的每个Queue都会生成ConsumeQueue，存储消息在CommitLog中的偏移</span></span><br><span class="line"><span class="comment">     * 结构为ConcurrentMap&lt;String, ConcurrentMap&lt;Integer, ConsumeQueue&gt;&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">this</span>.consumeQueueTable = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">32</span>);</span><br><span class="line">    <span class="comment">// ConsumeQueue的刷盘服务</span></span><br><span class="line">    <span class="keyword">this</span>.flushConsumeQueueService = <span class="keyword">new</span> FlushConsumeQueueService();</span><br><span class="line">    <span class="comment">// 清除过期的CommitLog文件的服务</span></span><br><span class="line">    <span class="keyword">this</span>.cleanCommitLogService = <span class="keyword">new</span> CleanCommitLogService();</span><br><span class="line">    <span class="comment">// 清除过期的ConsumeQueue文件的服务</span></span><br><span class="line">    <span class="keyword">this</span>.cleanConsumeQueueService = <span class="keyword">new</span> CleanConsumeQueueService();</span><br><span class="line">    <span class="comment">// 存储统计服务</span></span><br><span class="line">    <span class="keyword">this</span>.storeStatsService = <span class="keyword">new</span> StoreStatsService();</span><br><span class="line">    <span class="comment">// 索引服务，负责读写IndexFile</span></span><br><span class="line">    <span class="keyword">this</span>.indexService = <span class="keyword">new</span> IndexService(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">if</span> (!messageStoreConfig.isEnableDLegerCommitLog()) &#123;</span><br><span class="line">        <span class="comment">// 高可用服务，负责Master-Slave间的CommitLog同步</span></span><br><span class="line">        <span class="keyword">this</span>.haService = <span class="keyword">new</span> HAService(<span class="keyword">this</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.haService = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 消息存储到CommitLog后，MessageStore的接口调用就返回了</span></span><br><span class="line">    <span class="comment">// 后续由ReputMessageService负责将消息分发到ConsumeQueue和IndexService</span></span><br><span class="line">    <span class="keyword">this</span>.reputMessageService = <span class="keyword">new</span> ReputMessageService();</span><br><span class="line">    <span class="comment">// 延迟消息服务</span></span><br><span class="line">    <span class="keyword">this</span>.scheduleMessageService = <span class="keyword">new</span> ScheduleMessageService(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">this</span>.transientStorePool = <span class="keyword">new</span> TransientStorePool(messageStoreConfig);</span><br><span class="line">    <span class="keyword">if</span> (messageStoreConfig.isTransientStorePoolEnable()) &#123;</span><br><span class="line">        <span class="keyword">this</span>.transientStorePool.init();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 负责分配MappedFile</span></span><br><span class="line">    <span class="keyword">this</span>.allocateMappedFileService.start();</span><br><span class="line">    <span class="comment">// 空的，啥也没干</span></span><br><span class="line">    <span class="keyword">this</span>.indexService.start();</span><br><span class="line">    <span class="keyword">this</span>.dispatcherList = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 分发CommitLog，创建ConsumeQueue</span></span><br><span class="line">    <span class="keyword">this</span>.dispatcherList.addLast(<span class="keyword">new</span> CommitLogDispatcherBuildConsumeQueue());</span><br><span class="line">    <span class="comment">// 分发CommitLog，创建ConsumeIndex</span></span><br><span class="line">    <span class="keyword">this</span>.dispatcherList.addLast(<span class="keyword">new</span> CommitLogDispatcherBuildIndex());</span><br><span class="line">    <span class="comment">// $&#123;user.home&#125;/store/lock</span></span><br><span class="line">    File file = <span class="keyword">new</span> File(StorePathConfigHelper.getLockFile(messageStoreConfig.getStorePathRootDir()));</span><br><span class="line">    MappedFile.ensureDirOK(file.getParent());</span><br><span class="line">    <span class="comment">// 锁文件，大概是用来标志整个存储目录</span></span><br><span class="line">    lockFile = <span class="keyword">new</span> RandomAccessFile(file, <span class="string">"rw"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>CommitLog</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">CommitLog</span><span class="params">(<span class="keyword">final</span> DefaultMessageStore defaultMessageStore)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 目录：$&#123;user.home&#125;/store/commitlog/</span></span><br><span class="line">    <span class="comment">// 单个文件默认大小：1024 * 1024 * 1024</span></span><br><span class="line">    <span class="keyword">this</span>.mappedFileQueue = <span class="keyword">new</span> MappedFileQueue(defaultMessageStore.getMessageStoreConfig().getStorePathCommitLog(), defaultMessageStore.getMessageStoreConfig().getMappedFileSizeCommitLog(), defaultMessageStore.getAllocateMappedFileService());</span><br><span class="line">    <span class="keyword">this</span>.defaultMessageStore = defaultMessageStore;</span><br><span class="line">    <span class="comment">// 同步刷盘</span></span><br><span class="line">    <span class="keyword">if</span> (FlushDiskType.SYNC_FLUSH == defaultMessageStore.getMessageStoreConfig().getFlushDiskType()) &#123;</span><br><span class="line">        <span class="keyword">this</span>.flushCommitLogService = <span class="keyword">new</span> GroupCommitService();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 异步刷盘</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.flushCommitLogService = <span class="keyword">new</span> FlushRealTimeService();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 异步刷盘，这个默认是不启动的</span></span><br><span class="line">    <span class="keyword">this</span>.commitLogService = <span class="keyword">new</span> CommitRealTimeService();</span><br><span class="line">    <span class="comment">// 在回调中执行</span></span><br><span class="line">    <span class="keyword">this</span>.appendMessageCallback = <span class="keyword">new</span> DefaultAppendMessageCallback(defaultMessageStore.getMessageStoreConfig().getMaxMessageSize());</span><br><span class="line">    batchEncoderThreadLocal = ThreadLocal.withInitial(() -&gt; <span class="keyword">new</span> MessageExtBatchEncoder(defaultMessageStore.getMessageStoreConfig().getMaxMessageSize()));</span><br><span class="line">    <span class="keyword">this</span>.putMessageLock = defaultMessageStore.getMessageStoreConfig().isUseReentrantLockWhenPutMessage() ? <span class="keyword">new</span> PutMessageReentrantLock() : <span class="keyword">new</span> PutMessageSpinLock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p>DefaultMessageStore#load</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">load</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> result = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 判断$&#123;user.home&#125;/store/abort文件是否存在</span></span><br><span class="line">        <span class="comment">// 此文件在DefaultMessageStore启动时创建，关闭时删除，如果存在，说明不是正常关闭</span></span><br><span class="line">        <span class="keyword">boolean</span> lastExitOK = !<span class="keyword">this</span>.isTempFileExist();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != scheduleMessageService) &#123;</span><br><span class="line">            <span class="comment">// 从$&#123;user.home&#125;/store/config/delayOffset.json加载延迟消息的消费进度</span></span><br><span class="line">            result = result &amp;&amp; <span class="keyword">this</span>.scheduleMessageService.load();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 从$&#123;user.home&#125;/store/commitlog目录下加载CommitLog</span></span><br><span class="line">        result = result &amp;&amp; <span class="keyword">this</span>.commitLog.load();</span><br><span class="line">        <span class="comment">// 再从$&#123;user.home&#125;/store/consumequeue目录下加载ConsumeQueue</span></span><br><span class="line">        result = result &amp;&amp; <span class="keyword">this</span>.loadConsumeQueue();</span><br><span class="line">        <span class="keyword">if</span> (result) &#123;</span><br><span class="line">            <span class="comment">// 再从$&#123;user.home&#125;/store/checkpoint加载检查点</span></span><br><span class="line">            <span class="keyword">this</span>.storeCheckpoint = <span class="keyword">new</span> StoreCheckpoint(StorePathConfigHelper.getStoreCheckpoint(<span class="keyword">this</span>.messageStoreConfig.getStorePathRootDir()));</span><br><span class="line">            <span class="comment">// 根据上次是否正常退出，从$&#123;user.home&#125;/store/index目录下加载IndexFile</span></span><br><span class="line">            <span class="keyword">this</span>.indexService.load(lastExitOK);</span><br><span class="line">            <span class="comment">// 根据上次是否正常退出，恢复ConsumeQueue，CommitLog的指针和TopicQueue目录</span></span><br><span class="line">            <span class="keyword">this</span>.recover(lastExitOK);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<ul>
<li><p>CommitLog由MappedFile队列组成，每个MappedFile文件大小固定，默认1024 <em> 1024 </em> 1024 = 1073741824 = 1G</p>
</li>
<li><p>Message不定长，顺序写入CommitLog，写满后自动生成下一个文件，文件名为存储的第一条消息的偏移，长度20位，左边补零，剩余为起始偏移量</p>
</li>
<li><p>第一个文件名为00000000000000000000，第二个文件名为00000000001073741824，以此类推</p>
</li>
<li><p>1 CommitLog -&gt; 1 MappedFileQueue -&gt; N MappedFile</p>
</li>
<li><p>简单地说，MappedFileQueue代表了文件夹下的MappedFile文件队列，在这里就是CommitLog的映射，ConsumeQueue也是类似</p>
</li>
<li><p>MappedFile是存储消息的文件的映射，FileName[n] = FileName[n - 1] + MappedFileSize</p>
</li>
</ul>
<p>CommitLog#load</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">load</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">boolean</span> result = <span class="keyword">this</span>.mappedFileQueue.load();</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>MappedFileQueue#load</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">load</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 持久化文件目录</span></span><br><span class="line">    File dir = <span class="keyword">new</span> File(<span class="keyword">this</span>.storePath);</span><br><span class="line">    <span class="comment">// 目录下文件列表</span></span><br><span class="line">    File[] files = dir.listFiles();</span><br><span class="line">    <span class="keyword">if</span> (files != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 升序</span></span><br><span class="line">        Arrays.sort(files);</span><br><span class="line">        <span class="comment">// 遍历</span></span><br><span class="line">        <span class="keyword">for</span> (File file : files) &#123;</span><br><span class="line">            <span class="comment">// 大小不对</span></span><br><span class="line">            <span class="keyword">if</span> (file.length() != <span class="keyword">this</span>.mappedFileSize) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 创建MappedFile映射文件</span></span><br><span class="line">                MappedFile mappedFile = <span class="keyword">new</span> MappedFile(file.getPath(), mappedFileSize);</span><br><span class="line">                <span class="comment">// 初始指针都设为最大值，会在启动恢复时重置</span></span><br><span class="line">                mappedFile.setWrotePosition(<span class="keyword">this</span>.mappedFileSize);</span><br><span class="line">                mappedFile.setFlushedPosition(<span class="keyword">this</span>.mappedFileSize);</span><br><span class="line">                mappedFile.setCommittedPosition(<span class="keyword">this</span>.mappedFileSize);</span><br><span class="line">                <span class="comment">// 加入列表</span></span><br><span class="line">                <span class="keyword">this</span>.mappedFiles.add(mappedFile);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>MappedFile#init</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(<span class="keyword">final</span> String fileName, <span class="keyword">final</span> <span class="keyword">int</span> fileSize)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.fileName = fileName;</span><br><span class="line">    <span class="keyword">this</span>.fileSize = fileSize;</span><br><span class="line">    <span class="keyword">this</span>.file = <span class="keyword">new</span> File(fileName);</span><br><span class="line">    <span class="comment">// 文件的起始偏移就是文件名</span></span><br><span class="line">    <span class="keyword">this</span>.fileFromOffset = Long.parseLong(<span class="keyword">this</span>.file.getName());</span><br><span class="line">    <span class="keyword">boolean</span> ok = <span class="keyword">false</span>;</span><br><span class="line">    ensureDirOK(<span class="keyword">this</span>.file.getParent());</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// NIO的FileChannel</span></span><br><span class="line">        <span class="keyword">this</span>.fileChannel = <span class="keyword">new</span> RandomAccessFile(<span class="keyword">this</span>.file, <span class="string">"rw"</span>).getChannel();</span><br><span class="line">        <span class="comment">// 文件在内存中的映射，PageCache</span></span><br><span class="line">        <span class="keyword">this</span>.mappedByteBuffer = <span class="keyword">this</span>.fileChannel.map(MapMode.READ_WRITE, <span class="number">0</span>, fileSize);</span><br><span class="line">        <span class="comment">// 静态类变量，所有MappedFile实例映射的字节总数</span></span><br><span class="line">        TOTAL_MAPPED_VIRTUAL_MEMORY.addAndGet(fileSize);</span><br><span class="line">        <span class="comment">// 静态类变量，MappedFile实例数</span></span><br><span class="line">        TOTAL_MAPPED_FILES.incrementAndGet();</span><br><span class="line">        ok = <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p>DefaultMessageStore#loadConsumeQueue</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">loadConsumeQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// $&#123;user.home&#125;/store/consumequeue目录</span></span><br><span class="line">    <span class="comment">// 结构是$&#123;user.home&#125;/store/consumequeue/&#123;topic&#125;/&#123;queueid&#125;/&#123;filename&#125;</span></span><br><span class="line">    File dirLogic = <span class="keyword">new</span> File(StorePathConfigHelper.getStorePathConsumeQueue(<span class="keyword">this</span>.messageStoreConfig.getStorePathRootDir()));</span><br><span class="line">    <span class="comment">// Topic目录列表</span></span><br><span class="line">    File[] fileTopicList = dirLogic.listFiles();</span><br><span class="line">    <span class="keyword">if</span> (fileTopicList != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 遍历Topic目录列表</span></span><br><span class="line">        <span class="keyword">for</span> (File fileTopic : fileTopicList) &#123;</span><br><span class="line">            <span class="comment">// Topic名称为目录名</span></span><br><span class="line">            String topic = fileTopic.getName();</span><br><span class="line">            <span class="comment">// 该Topic目录下的Queue目录列表</span></span><br><span class="line">            File[] fileQueueIdList = fileTopic.listFiles();</span><br><span class="line">            <span class="keyword">if</span> (fileQueueIdList != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 遍历该Topic目录下的Queue目录列表</span></span><br><span class="line">                <span class="keyword">for</span> (File fileQueueId : fileQueueIdList) &#123;</span><br><span class="line">                    <span class="keyword">int</span> queueId;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">// 队列Id为目录名</span></span><br><span class="line">                        queueId = Integer.parseInt(fileQueueId.getName());</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 根据Topic和QueueId创建ConsumeQueue</span></span><br><span class="line">                    ConsumeQueue logic = <span class="keyword">new</span> ConsumeQueue(topic, queueId, StorePathConfigHelper.getStorePathConsumeQueue(<span class="keyword">this</span>.messageStoreConfig.getStorePathRootDir()), <span class="keyword">this</span>.getMessageStoreConfig().getMappedFileSizeConsumeQueue(), <span class="keyword">this</span>);</span><br><span class="line">                    <span class="comment">// 加入this.consumeQueueTable</span></span><br><span class="line">                    <span class="comment">// 结构为ConcurrentMap&lt;String, ConcurrentMap&lt;Integer, ConsumeQueue&gt;&gt;</span></span><br><span class="line">                    <span class="keyword">this</span>.putConsumeQueue(topic, queueId, logic);</span><br><span class="line">                    <span class="comment">// 加载ConsumeQueue，类似CommitLog的加载方式</span></span><br><span class="line">                    <span class="keyword">if</span> (!logic.load()) &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ConsumeQueue</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConsumeQueue</span><span class="params">(<span class="keyword">final</span> String topic, <span class="keyword">final</span> <span class="keyword">int</span> queueId, <span class="keyword">final</span> String storePath, <span class="keyword">final</span> <span class="keyword">int</span> mappedFileSize, <span class="keyword">final</span> DefaultMessageStore defaultMessageStore)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ConsumeQueue文件路径</span></span><br><span class="line">    <span class="keyword">this</span>.storePath = storePath;</span><br><span class="line">    <span class="comment">// ConsumeQueue文件大小</span></span><br><span class="line">    <span class="keyword">this</span>.mappedFileSize = mappedFileSize;</span><br><span class="line">    <span class="keyword">this</span>.defaultMessageStore = defaultMessageStore;</span><br><span class="line">    <span class="comment">// 所属Topic</span></span><br><span class="line">    <span class="keyword">this</span>.topic = topic;</span><br><span class="line">    <span class="comment">// ConsumeQueue的Id</span></span><br><span class="line">    <span class="keyword">this</span>.queueId = queueId;</span><br><span class="line">    String queueDir = <span class="keyword">this</span>.storePath + File.separator + topic + File.separator + queueId;</span><br><span class="line">    <span class="comment">// 类似CommitLog，ConsumeQueue也是连续的文件，一个ConsumeQueue可能分多个文件存储，差别就是ConsumeQueue的单元内容是定长的</span></span><br><span class="line">    <span class="keyword">this</span>.mappedFileQueue = <span class="keyword">new</span> MappedFileQueue(queueDir, mappedFileSize, <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">this</span>.byteBufferIndex = ByteBuffer.allocate(CQ_STORE_UNIT_SIZE);</span><br><span class="line">    <span class="keyword">if</span> (defaultMessageStore.getMessageStoreConfig().isEnableConsumeQueueExt()) &#123;</span><br><span class="line">        <span class="keyword">this</span>.consumeQueueExt = <span class="keyword">new</span> ConsumeQueueExt(topic, queueId, StorePathConfigHelper.getStorePathConsumeQueueExt(defaultMessageStore.getMessageStoreConfig().getStorePathRootDir()), defaultMessageStore.getMessageStoreConfig().getMappedFileSizeConsumeQueueExt(), defaultMessageStore.getMessageStoreConfig().getBitMapLengthConsumeQueueExt());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ConsumeQueue#load</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">load</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">boolean</span> result = <span class="keyword">this</span>.mappedFileQueue.load();</span><br><span class="line">    <span class="keyword">if</span> (isExtReadEnable()) &#123;</span><br><span class="line">        result &amp;= <span class="keyword">this</span>.consumeQueueExt.load();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p>IndexService#load</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">load</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> lastExitOK)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// $&#123;user.home&#125;/store/index目录</span></span><br><span class="line">    File dir = <span class="keyword">new</span> File(<span class="keyword">this</span>.storePath);</span><br><span class="line">    <span class="comment">// 目录下的IndexFile文件列表</span></span><br><span class="line">    File[] files = dir.listFiles();</span><br><span class="line">    <span class="keyword">if</span> (files != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// ascending order</span></span><br><span class="line">        Arrays.sort(files);</span><br><span class="line">        <span class="keyword">for</span> (File file : files) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                IndexFile f = <span class="keyword">new</span> IndexFile(file.getPath(), <span class="keyword">this</span>.hashSlotNum, <span class="keyword">this</span>.indexNum, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">                <span class="comment">// 加载IndexFile，恢复索引</span></span><br><span class="line">                f.load();</span><br><span class="line">                <span class="comment">// 上次是非正常退出</span></span><br><span class="line">                <span class="keyword">if</span> (!lastExitOK) &#123;</span><br><span class="line">                    <span class="comment">// IndexFile的最新一条消息的时间 &gt; 检查点的时间 </span></span><br><span class="line">                    <span class="keyword">if</span> (f.getEndTimestamp() &gt; <span class="keyword">this</span>.defaultMessageStore.getStoreCheckpoint().getIndexMsgTimestamp()) &#123;</span><br><span class="line">                        <span class="comment">// 销毁并跳过</span></span><br><span class="line">                        f.destroy(<span class="number">0</span>);</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 加入文件列表</span></span><br><span class="line">                <span class="keyword">this</span>.indexFileList.add(f);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="comment">// ...</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">                <span class="comment">// ...</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>IndexFile的功能是通过Key或时间来查询消息</p>
</li>
<li><p>默认位置${user.home}/store/index/{fileName}，文件名为创建时间戳</p>
</li>
<li><p>一个IndexFile大小为40 + 5000000 <em> 4 + 20000000 </em> 20 = 420000040，依次包括：</p>
</li>
<li><p>IndexHeader：共40字节</p>
<ul>
<li><p>BeginTimestamp：第一个Index的时间戳，8字节</p>
</li>
<li><p>EndTimestamp：最后一个Index的时间戳，8字节</p>
</li>
<li><p>BeginPhyOffset：第一个Index对应的消息在CommitLog的物理偏移，8字节</p>
</li>
<li><p>EndPhyOffset：最后一个Index对应的消息在CommitLog的物理偏移，8字节</p>
</li>
<li><p>HashSlotCount：当前Slot的数量，4字节</p>
</li>
<li><p>IndexCount：当前Index的数量，4字节</p>
</li>
</ul>
</li>
<li><p>SlotTable：Slot列表，存放该Slot对应的最新的Index的序号，每个Slot共4字节，默认共5000000个Slot</p>
</li>
<li><p>IndexLinkedList：Index列表，每个Index都有同Slot的前一个Index的位置偏移，形成一个链表，每个Index共20字节，默认共20000000个Index</p>
</li>
</ul>
<p>IndexFile</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">IndexFile</span><span class="params">(<span class="keyword">final</span> String fileName, <span class="keyword">final</span> <span class="keyword">int</span> hashSlotNum, <span class="keyword">final</span> <span class="keyword">int</span> indexNum, <span class="keyword">final</span> <span class="keyword">long</span> endPhyOffset, <span class="keyword">final</span> <span class="keyword">long</span> endTimestamp)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 一个IndexFile大小为：40 + 5000000 * 4 + 20000000 * 20 = 420000040</span></span><br><span class="line">    <span class="keyword">int</span> fileTotalSize = IndexHeader.INDEX_HEADER_SIZE + (hashSlotNum * hashSlotSize) + (indexNum * indexSize);</span><br><span class="line">    <span class="comment">// MappedFile</span></span><br><span class="line">    <span class="keyword">this</span>.mappedFile = <span class="keyword">new</span> MappedFile(fileName, fileTotalSize);</span><br><span class="line">    <span class="keyword">this</span>.fileChannel = <span class="keyword">this</span>.mappedFile.getFileChannel();</span><br><span class="line">    <span class="keyword">this</span>.mappedByteBuffer = <span class="keyword">this</span>.mappedFile.getMappedByteBuffer();</span><br><span class="line">    <span class="comment">// Slot数量，默认5000000</span></span><br><span class="line">    <span class="keyword">this</span>.hashSlotNum = hashSlotNum;</span><br><span class="line">    <span class="comment">// Index数量</span></span><br><span class="line">    <span class="keyword">this</span>.indexNum = indexNum;</span><br><span class="line">    ByteBuffer byteBuffer = <span class="keyword">this</span>.mappedByteBuffer.slice();</span><br><span class="line">    <span class="comment">// 将映射的子缓冲传入IndexHeader</span></span><br><span class="line">    <span class="keyword">this</span>.indexHeader = <span class="keyword">new</span> IndexHeader(byteBuffer);</span><br><span class="line">    <span class="keyword">if</span> (endPhyOffset &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.indexHeader.setBeginPhyOffset(endPhyOffset);</span><br><span class="line">        <span class="keyword">this</span>.indexHeader.setEndPhyOffset(endPhyOffset);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (endTimestamp &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.indexHeader.setBeginTimestamp(endTimestamp);</span><br><span class="line">        <span class="keyword">this</span>.indexHeader.setEndTimestamp(endTimestamp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>IndexFile#load</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">load</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 从文件中恢复头部的各项数据到IndexHeader</span></span><br><span class="line">    <span class="keyword">this</span>.indexHeader.load();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>IndexHeader#load</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">load</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.beginTimestamp.set(byteBuffer.getLong(beginTimestampIndex));</span><br><span class="line">    <span class="keyword">this</span>.endTimestamp.set(byteBuffer.getLong(endTimestampIndex));</span><br><span class="line">    <span class="keyword">this</span>.beginPhyOffset.set(byteBuffer.getLong(beginPhyoffsetIndex));</span><br><span class="line">    <span class="keyword">this</span>.endPhyOffset.set(byteBuffer.getLong(endPhyoffsetIndex));</span><br><span class="line">    <span class="keyword">this</span>.hashSlotCount.set(byteBuffer.getInt(hashSlotcountIndex));</span><br><span class="line">    <span class="keyword">this</span>.indexCount.set(byteBuffer.getInt(indexCountIndex));</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.indexCount.get() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.indexCount.set(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p>DefaultMessageStore#recover</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">recover</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> lastExitOK)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 恢复ConsumeQueue的刷盘指针，返回最大的物理偏移</span></span><br><span class="line">    <span class="keyword">long</span> maxPhyOffsetOfConsumeQueue = <span class="keyword">this</span>.recoverConsumeQueue();</span><br><span class="line">    <span class="keyword">if</span> (lastExitOK) &#123;</span><br><span class="line">        <span class="comment">// 正常恢复CommitLog的刷盘指针，和上面差不多，也是从最后三个文件开始遍历检查</span></span><br><span class="line">        <span class="keyword">this</span>.commitLog.recoverNormally(maxPhyOffsetOfConsumeQueue);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.commitLog.recoverAbnormally(maxPhyOffsetOfConsumeQueue);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 恢复TopicQueue</span></span><br><span class="line">    <span class="keyword">this</span>.recoverTopicQueueTable();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>DefaultMessageStore#recoverConsumeQueue</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">recoverConsumeQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> maxPhysicOffset = -<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 遍历所有的Topic</span></span><br><span class="line">    <span class="keyword">for</span> (ConcurrentMap&lt;Integer, ConsumeQueue&gt; maps : <span class="keyword">this</span>.consumeQueueTable.values()) &#123;</span><br><span class="line">        <span class="comment">// 遍历所有的ConsumeQueue</span></span><br><span class="line">        <span class="keyword">for</span> (ConsumeQueue logic : maps.values()) &#123;</span><br><span class="line">            <span class="comment">// 检查ConsumeQueue内容，并恢复刷盘指针</span></span><br><span class="line">            logic.recover();</span><br><span class="line">            <span class="keyword">if</span> (logic.getMaxPhysicOffset() &gt; maxPhysicOffset) &#123;</span><br><span class="line">                <span class="comment">// 更新最大偏移</span></span><br><span class="line">                maxPhysicOffset = logic.getMaxPhysicOffset();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 返回ConsumeQueue的最大物理偏移</span></span><br><span class="line">    <span class="keyword">return</span> maxPhysicOffset;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ConsumeQueue#recover</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">recover</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 一个ConsumeQueue下有多个文件，先获取MappedFile映射列表</span></span><br><span class="line">    <span class="keyword">final</span> List&lt;MappedFile&gt; mappedFiles = <span class="keyword">this</span>.mappedFileQueue.getMappedFiles();</span><br><span class="line">    <span class="keyword">if</span> (!mappedFiles.isEmpty()) &#123;</span><br><span class="line">        <span class="comment">// 从倒数第三个文件开始</span></span><br><span class="line">        <span class="keyword">int</span> index = mappedFiles.size() - <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">if</span> (index &lt; <span class="number">0</span>)</span><br><span class="line">            index = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> mappedFileSizeLogics = <span class="keyword">this</span>.mappedFileSize;</span><br><span class="line">        <span class="comment">// 获取对应位置的MappedFile</span></span><br><span class="line">        MappedFile mappedFile = mappedFiles.get(index);</span><br><span class="line">        <span class="comment">// 分出个子缓冲，维护独立索引</span></span><br><span class="line">        ByteBuffer byteBuffer = mappedFile.sliceByteBuffer();</span><br><span class="line">        <span class="comment">// 文件名/起始偏移</span></span><br><span class="line">        <span class="keyword">long</span> processOffset = mappedFile.getFileFromOffset();</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="keyword">long</span> mappedFileOffset = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">long</span> maxExtAddr = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="comment">// 遍历检验ConsumeQueue所有单元，每次遍历单位为一个单元大小，20字节</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mappedFileSizeLogics; i += CQ_STORE_UNIT_SIZE) &#123;</span><br><span class="line">                <span class="comment">// 消息在CommitLog的偏移，8字节</span></span><br><span class="line">                <span class="keyword">long</span> offset = byteBuffer.getLong();</span><br><span class="line">                <span class="comment">// 消息总长度，4字节</span></span><br><span class="line">                <span class="keyword">int</span> size = byteBuffer.getInt();</span><br><span class="line">                <span class="comment">// 消息的TagsCode，8字节</span></span><br><span class="line">                <span class="keyword">long</span> tagsCode = byteBuffer.getLong();</span><br><span class="line">                <span class="comment">// 说明不是空白</span></span><br><span class="line">                <span class="keyword">if</span> (offset &gt;= <span class="number">0</span> &amp;&amp; size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// 累计所有单元的大小</span></span><br><span class="line">                    mappedFileOffset = i + CQ_STORE_UNIT_SIZE;</span><br><span class="line">                    <span class="comment">// 累计最大物理偏移</span></span><br><span class="line">                    <span class="keyword">this</span>.maxPhysicOffset = offset + size;</span><br><span class="line">                    <span class="keyword">if</span> (isExtAddr(tagsCode)) &#123;</span><br><span class="line">                        maxExtAddr = tagsCode;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 文件有异常，或者当前文件到了结尾</span></span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="comment">// for循环结束，当前文件检验结束</span></span><br><span class="line">            <span class="comment">// 说明该文件所有单元都合法</span></span><br><span class="line">            <span class="keyword">if</span> (mappedFileOffset == mappedFileSizeLogics) &#123;</span><br><span class="line">                <span class="comment">// 继续下一个MappedFile</span></span><br><span class="line">                index++;</span><br><span class="line">                <span class="comment">// 所有MappedFile检查完毕</span></span><br><span class="line">                <span class="keyword">if</span> (index &gt;= mappedFiles.size()) &#123;</span><br><span class="line">                    <span class="comment">// 再见</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 下一个MappedFile，继续循环</span></span><br><span class="line">                    mappedFile = mappedFiles.get(index);</span><br><span class="line">                    byteBuffer = mappedFile.sliceByteBuffer();</span><br><span class="line">                    processOffset = mappedFile.getFileFromOffset();</span><br><span class="line">                    mappedFileOffset = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 文件有异常，不用继续检查了</span></span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="comment">// while循环结束，所有文件检验结束</span></span><br><span class="line">        <span class="comment">// 最后一个有效的ConsumeQueue文件的最大偏移</span></span><br><span class="line">        processOffset += mappedFileOffset;</span><br><span class="line">        <span class="comment">// 恢复指针</span></span><br><span class="line">        <span class="keyword">this</span>.mappedFileQueue.setFlushedWhere(processOffset);</span><br><span class="line">        <span class="keyword">this</span>.mappedFileQueue.setCommittedWhere(processOffset);</span><br><span class="line">        <span class="comment">// 截断后面无效的文件</span></span><br><span class="line">        <span class="keyword">this</span>.mappedFileQueue.truncateDirtyFiles(processOffset);</span><br><span class="line">        <span class="keyword">if</span> (isExtReadEnable()) &#123;</span><br><span class="line">            <span class="keyword">this</span>.consumeQueueExt.recover();</span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="keyword">this</span>.consumeQueueExt.truncateByMaxAddress(maxExtAddr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ConsumeQueue#recoverTopicQueueTable</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">recoverTopicQueueTable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    HashMap&lt;String<span class="comment">/* topic-queueid */</span>, Long<span class="comment">/* offset */</span>&gt; table = <span class="keyword">new</span> HashMap&lt;String, Long&gt;(<span class="number">1024</span>);</span><br><span class="line">    <span class="comment">// CommitLog的最小物理偏移</span></span><br><span class="line">    <span class="keyword">long</span> minPhyOffset = <span class="keyword">this</span>.commitLog.getMinOffset();</span><br><span class="line">    <span class="comment">// 遍历所有Topic</span></span><br><span class="line">    <span class="keyword">for</span> (ConcurrentMap&lt;Integer, ConsumeQueue&gt; maps : <span class="keyword">this</span>.consumeQueueTable.values()) &#123;</span><br><span class="line">        <span class="comment">// 遍历Topic下所有ConsumeQueue</span></span><br><span class="line">        <span class="keyword">for</span> (ConsumeQueue logic : maps.values()) &#123;</span><br><span class="line">            <span class="comment">// Topic + "-" + QueueId</span></span><br><span class="line">            String key = logic.getTopic() + <span class="string">"-"</span> + logic.getQueueId();</span><br><span class="line">            <span class="comment">// 值为ConsumeQueue内消息的数量，MaxOffset / CQ_STORE_UNIT_SIZE</span></span><br><span class="line">            table.put(key, logic.getMaxOffsetInQueue());</span><br><span class="line">            <span class="comment">// 扩展相关，忽略</span></span><br><span class="line">            logic.correctMinOffset(minPhyOffset);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设回去</span></span><br><span class="line">    <span class="keyword">this</span>.commitLog.setTopicQueueTable(table);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p>BrokerController#registerProcessor</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerProcessor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * SendMessageProcessor</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    SendMessageProcessor sendProcessor = <span class="keyword">new</span> SendMessageProcessor(<span class="keyword">this</span>);</span><br><span class="line">    sendProcessor.registerSendMessageHook(sendMessageHookList);</span><br><span class="line">    sendProcessor.registerConsumeMessageHook(consumeMessageHookList);</span><br><span class="line">    <span class="comment">// 处理Producer发送的消息</span></span><br><span class="line">    <span class="keyword">this</span>.remotingServer.registerProcessor(RequestCode.SEND_MESSAGE, sendProcessor, <span class="keyword">this</span>.sendMessageExecutor);</span><br><span class="line">    <span class="keyword">this</span>.remotingServer.registerProcessor(RequestCode.SEND_MESSAGE_V2, sendProcessor, <span class="keyword">this</span>.sendMessageExecutor);</span><br><span class="line">    <span class="comment">// 处理Producer发送的批量消息</span></span><br><span class="line">    <span class="keyword">this</span>.remotingServer.registerProcessor(RequestCode.SEND_BATCH_MESSAGE, sendProcessor, <span class="keyword">this</span>.sendMessageExecutor);</span><br><span class="line">    <span class="comment">// 处理Consumer将消息发回Broker的消息，要求重新消费</span></span><br><span class="line">    <span class="keyword">this</span>.remotingServer.registerProcessor(RequestCode.CONSUMER_SEND_MSG_BACK, sendProcessor, <span class="keyword">this</span>.sendMessageExecutor);</span><br><span class="line">    <span class="comment">// VIPChannel共用处理器和业务线程池，只是监听的端口不同</span></span><br><span class="line">    <span class="keyword">this</span>.fastRemotingServer.registerProcessor(RequestCode.SEND_MESSAGE, sendProcessor, <span class="keyword">this</span>.sendMessageExecutor);</span><br><span class="line">    <span class="keyword">this</span>.fastRemotingServer.registerProcessor(RequestCode.SEND_MESSAGE_V2, sendProcessor, <span class="keyword">this</span>.sendMessageExecutor);</span><br><span class="line">    <span class="keyword">this</span>.fastRemotingServer.registerProcessor(RequestCode.SEND_BATCH_MESSAGE, sendProcessor, <span class="keyword">this</span>.sendMessageExecutor);</span><br><span class="line">    <span class="keyword">this</span>.fastRemotingServer.registerProcessor(RequestCode.CONSUMER_SEND_MSG_BACK, sendProcessor, <span class="keyword">this</span>.sendMessageExecutor);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * PullMessageProcessor</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// 处理Consumer拉取消息请求，VIPChannel没有这个</span></span><br><span class="line">    <span class="keyword">this</span>.remotingServer.registerProcessor(RequestCode.PULL_MESSAGE, <span class="keyword">this</span>.pullMessageProcessor, <span class="keyword">this</span>.pullMessageExecutor);</span><br><span class="line">    <span class="comment">// 一些Hook</span></span><br><span class="line">    <span class="keyword">this</span>.pullMessageProcessor.registerConsumeMessageHook(consumeMessageHookList);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * QueryMessageProcessor</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// 查询消息接口，Index</span></span><br><span class="line">    NettyRequestProcessor queryProcessor = <span class="keyword">new</span> QueryMessageProcessor(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">this</span>.remotingServer.registerProcessor(RequestCode.QUERY_MESSAGE, queryProcessor, <span class="keyword">this</span>.queryMessageExecutor);</span><br><span class="line">    <span class="keyword">this</span>.remotingServer.registerProcessor(RequestCode.VIEW_MESSAGE_BY_ID, queryProcessor, <span class="keyword">this</span>.queryMessageExecutor);</span><br><span class="line">    <span class="keyword">this</span>.fastRemotingServer.registerProcessor(RequestCode.QUERY_MESSAGE, queryProcessor, <span class="keyword">this</span>.queryMessageExecutor);</span><br><span class="line">    <span class="keyword">this</span>.fastRemotingServer.registerProcessor(RequestCode.VIEW_MESSAGE_BY_ID, queryProcessor, <span class="keyword">this</span>.queryMessageExecutor);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ClientManageProcessor</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ClientManageProcessor clientProcessor = <span class="keyword">new</span> ClientManageProcessor(<span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">// 处理客户端如Producer和Consumer的心跳</span></span><br><span class="line">    <span class="keyword">this</span>.remotingServer.registerProcessor(RequestCode.HEART_BEAT, clientProcessor, <span class="keyword">this</span>.heartbeatExecutor);</span><br><span class="line">    <span class="keyword">this</span>.remotingServer.registerProcessor(RequestCode.UNREGISTER_CLIENT, clientProcessor, <span class="keyword">this</span>.clientManageExecutor);</span><br><span class="line">    <span class="keyword">this</span>.remotingServer.registerProcessor(RequestCode.CHECK_CLIENT_CONFIG, clientProcessor, <span class="keyword">this</span>.clientManageExecutor);</span><br><span class="line">    <span class="keyword">this</span>.fastRemotingServer.registerProcessor(RequestCode.HEART_BEAT, clientProcessor, <span class="keyword">this</span>.heartbeatExecutor);</span><br><span class="line">    <span class="keyword">this</span>.fastRemotingServer.registerProcessor(RequestCode.UNREGISTER_CLIENT, clientProcessor, <span class="keyword">this</span>.clientManageExecutor);</span><br><span class="line">    <span class="keyword">this</span>.fastRemotingServer.registerProcessor(RequestCode.CHECK_CLIENT_CONFIG, clientProcessor, <span class="keyword">this</span>.clientManageExecutor);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ConsumerManageProcessor</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ConsumerManageProcessor consumerManageProcessor = <span class="keyword">new</span> ConsumerManageProcessor(<span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">// 处理Consumer发送的根据ConsumerGroup查询Consumer列表请求</span></span><br><span class="line">    <span class="keyword">this</span>.remotingServer.registerProcessor(RequestCode.GET_CONSUMER_LIST_BY_GROUP, consumerManageProcessor, <span class="keyword">this</span>.consumerManageExecutor);</span><br><span class="line">    <span class="comment">// 处理Consumer发送的更新Consumer消费进度偏移请求</span></span><br><span class="line">    <span class="keyword">this</span>.remotingServer.registerProcessor(RequestCode.UPDATE_CONSUMER_OFFSET, consumerManageProcessor, <span class="keyword">this</span>.consumerManageExecutor);</span><br><span class="line">    <span class="comment">// 处理Consumer发送的查询Consumer消费进度偏移请求</span></span><br><span class="line">    <span class="keyword">this</span>.remotingServer.registerProcessor(RequestCode.QUERY_CONSUMER_OFFSET, consumerManageProcessor, <span class="keyword">this</span>.consumerManageExecutor);</span><br><span class="line">    <span class="keyword">this</span>.fastRemotingServer.registerProcessor(RequestCode.GET_CONSUMER_LIST_BY_GROUP, consumerManageProcessor, <span class="keyword">this</span>.consumerManageExecutor);</span><br><span class="line">    <span class="keyword">this</span>.fastRemotingServer.registerProcessor(RequestCode.UPDATE_CONSUMER_OFFSET, consumerManageProcessor, <span class="keyword">this</span>.consumerManageExecutor);</span><br><span class="line">    <span class="keyword">this</span>.fastRemotingServer.registerProcessor(RequestCode.QUERY_CONSUMER_OFFSET, consumerManageProcessor, <span class="keyword">this</span>.consumerManageExecutor);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * EndTransactionProcessor</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// 处理结束事务消息</span></span><br><span class="line">    <span class="keyword">this</span>.remotingServer.registerProcessor(RequestCode.END_TRANSACTION, <span class="keyword">new</span> EndTransactionProcessor(<span class="keyword">this</span>), <span class="keyword">this</span>.endTransactionExecutor);</span><br><span class="line">    <span class="keyword">this</span>.fastRemotingServer.registerProcessor(RequestCode.END_TRANSACTION, <span class="keyword">new</span> EndTransactionProcessor(<span class="keyword">this</span>), <span class="keyword">this</span>.endTransactionExecutor);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Default</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    AdminBrokerProcessor adminProcessor = <span class="keyword">new</span> AdminBrokerProcessor(<span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">// Fallback的处理器，处理其它请求</span></span><br><span class="line">    <span class="keyword">this</span>.remotingServer.registerDefaultProcessor(adminProcessor, <span class="keyword">this</span>.adminBrokerExecutor);</span><br><span class="line">    <span class="keyword">this</span>.fastRemotingServer.registerDefaultProcessor(adminProcessor, <span class="keyword">this</span>.adminBrokerExecutor);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


		<footer>
			 
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

		</footer>
	</div>
	<!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->

	<script>var timeEnd = new Date();console.log('耗时：' + (timeEnd - timeStart));</script>
	<!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
	<!-- material design -->
	<!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
	<!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
	<!-- toc -->
	<!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
	<!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
	<!-- <script src="/js/main.js"></script> -->
</body>
</html>
