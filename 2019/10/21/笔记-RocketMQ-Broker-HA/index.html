<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
        <script>
            var timeStart = new Date();
        </script>
        
        <title>[ç¬”è®°]-RocketMQ-Broker-HA | ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜</title>
        
        <meta name="author" content="huangzhike">
        
        
        <meta name="description" content="ä¸ªäººè§‰å¾—è¿™éƒ¨åˆ†ä¸ä¼˜é›…ã€‚

BrokerController#start -&amp;gt; DefaultMessageStore#start -&amp;gt; HAService#start
HAService#start
    public void start() throws Exception {
 ">
        
        
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        
        <meta property="og:title" content="[ç¬”è®°]-RocketMQ-Broker-HA"/>
        
        <meta property="og:site_name" content="ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜"/>
        
        
        <!-- favicon -->
        <link rel="icon" type="image/ico" href="/ok.ico" sizes="32x32">
        <meta name="msapplication-TileColor" content="#009688">
        <meta name="msapplication-TileImage" content="/mstile-144x144.ico">
        <meta name="theme-color" content="#009688">
        <!-- favicon end -->
        <!-- <link href="//ok.ico" rel="icon"> -->
        
        <!-- toc -->
        <!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
        <!-- material design -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
        <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
        
        <!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
        <!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
    <meta name="generator" content="Hexo 4.2.1"></head>

<body>
    <nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">èœå•</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" title="ä¸‹ä¸€å¥æ˜¯ï¼šå®¢æœ‰å¯äººæœŸä¸æ¥ã€‚å°æ—¶å€™ï¼Œå–œæ¬¢é åœ¨é˜³å°ä¸Šï¼Œä¸€è¾¹å¹é£ï¼Œä¸€è¾¹çœ‹ä¹¦ï¼Œå–œæ¬¢è¯»ä¹¦å—ï¼Œéªšå¹´ï¼Ÿ" href="/">ä¹¦å½“å¿«æ„è¯»æ˜“å°½</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" target="_blank" rel="noopener" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

    <div class="container" >
        <div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[ç¬”è®°]-RocketMQ-Broker-HA</h2>
				
				<div>
					<div class="post-time">2019-10-21</div>
				</div>
				
				<div class="article-content">
				<p>ä¸ªäººè§‰å¾—è¿™éƒ¨åˆ†ä¸ä¼˜é›…ã€‚</p>
<hr>
<p>BrokerController#start -&gt; DefaultMessageStore#start -&gt; HAService#start</p>
<p>HAService#start</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// æ‰“å¼€ServerSocketChannelï¼Œç›‘å¬ç«¯å£ï¼Œæ³¨å†ŒOP_ACCEPTäº‹ä»¶</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>acceptSocketService<span class="token punctuation">.</span><span class="token function">beginAccept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¯åŠ¨AcceptSocketServiceï¼Œæ¥æ”¶Slaveçš„è¿æ¥è¯·æ±‚</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>acceptSocketService<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¯åŠ¨GroupTransferServiceï¼Œå¤„ç†åŒæ­¥Masteræƒ…å†µä¸‹çš„ä¸»ä»åŒæ­¥ï¼Œåªæ˜¯èµ·æ£€æŸ¥é€šçŸ¥çš„ä½œç”¨</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>groupTransferService<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¯åŠ¨HAClientï¼Œä¸»åŠ¨è¿æ¥Master</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>haClient<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>HAService$AcceptSocketService#beginAccept</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">beginAccept</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>serverSocketChannel <span class="token operator">=</span> ServerSocketChannel<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>selector <span class="token operator">=</span> RemotingUtil<span class="token punctuation">.</span><span class="token function">openSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>serverSocketChannel<span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setReuseAddress</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>serverSocketChannel<span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>socketAddressListen<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>serverSocketChannel<span class="token punctuation">.</span><span class="token function">configureBlocking</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>serverSocketChannel<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>selector<span class="token punctuation">,</span> SelectionKey<span class="token punctuation">.</span>OP_ACCEPT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>HAService$AcceptSocketService#run</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// é˜»å¡è‡³æ¥å—äº‹ä»¶å°±ç»ªæˆ–è€…è¶…æ—¶</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>selector<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// è·å¾—å°±ç»ªçš„äº‹ä»¶</span>
                    Set<span class="token operator">&lt;</span>SelectionKey<span class="token operator">></span> selected <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>selector<span class="token punctuation">.</span><span class="token function">selectedKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>selected <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// éå†å°±ç»ªäº‹ä»¶</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span>SelectionKey k <span class="token operator">:</span> selected<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// æ¥å—äº‹ä»¶å°±ç»ª</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span><span class="token function">readyOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> SelectionKey<span class="token punctuation">.</span>OP_ACCEPT<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token comment" spellcheck="true">// æ¥å—è¿æ¥è¯·æ±‚ï¼Œè¿”å›Slaveçš„SocketChannel</span>
                                SocketChannel sc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ServerSocketChannel<span class="token punctuation">)</span> k<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>sc <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    <span class="token comment" spellcheck="true">// ...</span>
                                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                                        <span class="token comment" spellcheck="true">// ç”Ÿæˆé«˜å¯ç”¨è¿æ¥å¯¹è±¡ï¼ŒåŒ…å«äº†SocketChannel</span>
                                        HAConnection conn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HAConnection</span><span class="token punctuation">(</span>HAService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">,</span> sc<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                        <span class="token comment" spellcheck="true">// å¯åŠ¨è¯¥SocketChannelçš„è¯»å†™æœåŠ¡</span>
                                        conn<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                        <span class="token comment" spellcheck="true">// åŠ å…¥é›†åˆ</span>
                                        HAService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addConnection</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                        <span class="token comment" spellcheck="true">// ...</span>
                                    <span class="token punctuation">}</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                                <span class="token comment" spellcheck="true">// ...</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment" spellcheck="true">// å¤„ç†å®Œåæ¸…é™¤å°±ç»ªäº‹ä»¶</span>
                        selected<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span></code></pre>
<p>HAConnection#start</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// å¤„ç†æ¥è‡ªSlaveçš„è¯»</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>readSocketService<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¤„ç†å‘ç»™Slaveçš„å†™</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>writeSocketService<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>HAConnection$ReadSocketService#run</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// é˜»å¡è¶…æ—¶è‡³å¯è¯»äº‹ä»¶å°±ç»ª</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>selector<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// å¤„ç†è¯»äº‹ä»¶</span>
                    <span class="token keyword">boolean</span> ok <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">processReadEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ok<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// å…³é—­</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">long</span> interval <span class="token operator">=</span> HAConnection<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>haService<span class="token punctuation">.</span><span class="token function">getDefaultMessageStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSystemClock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lastReadTimestamp<span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// è¶…æ—¶æ²¡æ”¶åˆ°Slaveæ•°æ®</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>interval <span class="token operator">></span> HAConnection<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>haService<span class="token punctuation">.</span><span class="token function">getDefaultMessageStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHaHousekeepingInterval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// å…³é—­</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å…³é—­é€»è¾‘ï¼Œç•¥</span>
        <span class="token punctuation">}</span></code></pre>
<p>HAConnection$ReadSocketService#processReadEvent</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">processReadEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> readSizeZeroTimes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è¯»ç¼“å†²å·²è¯»å®Œ</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>byteBufferRead<span class="token punctuation">.</span><span class="token function">hasRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// é‡ç½®ç´¢å¼•</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>byteBufferRead<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>processPosition <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ç›´åˆ°è¯»å®Œè¯»ç¼“å†²</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>byteBufferRead<span class="token punctuation">.</span><span class="token function">hasRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ä»SocketChannelè¯»å–æ•°æ®åˆ°è¯»ç¼“å†²</span>
                    <span class="token keyword">int</span> readSize <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>socketChannel<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>byteBufferRead<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// è¯»å–åˆ°äº†æ•°æ®</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>readSize <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        readSizeZeroTimes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// æ›´æ–°ä¸Šæ¬¡è¯»çš„æ—¶é—´æˆ³</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>lastReadTimestamp <span class="token operator">=</span> HAConnection<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>haService<span class="token punctuation">.</span><span class="token function">getDefaultMessageStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSystemClock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// è¯»ç¼“å†²çš„å†™ç´¢å¼• - ä¸Šæ¬¡å¤„ç†ä½ç½® >= 8å­—èŠ‚çš„Slaveçš„åç§»</span>
                        <span class="token comment" spellcheck="true">// è¯´æ˜æ”¶åˆ°äº†è¶³å¤Ÿçš„æ•°æ®åŒ…</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>byteBufferRead<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>processPosition<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// å¯èƒ½ç´¯ç§¯äº†å¤šä¸ªåŒ…ï¼Œä»ç¬¬ä¸€ä¸ªæœªå¤„ç†çš„åŒ…å¼€å§‹</span>
                            <span class="token keyword">int</span> pos <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>byteBufferRead<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>byteBufferRead<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// ä»è¯»ç¼“å†²è¯»å–Slaveçš„CommitLogåŒæ­¥åç§»ï¼Œ8å­—èŠ‚</span>
                            <span class="token keyword">long</span> readOffset <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>byteBufferRead<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span>pos <span class="token operator">-</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// æ›´æ–°å¤„ç†ä½ç½®</span>
                            <span class="token keyword">this</span><span class="token punctuation">.</span>processPosition <span class="token operator">=</span> pos<span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// åº”è¯¥å“åº”çš„Slaveçš„CommitLogåç§»</span>
                            HAConnection<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>slaveAckOffset <span class="token operator">=</span> readOffset<span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// ç¬¬ä¸€æ¬¡æ¥æ”¶åˆ°Slaveçš„åŒæ­¥åç§»</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>HAConnection<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>slaveRequestOffset <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token comment" spellcheck="true">// æ›´æ–°Slaveå‘é€è¯·æ±‚æ—¶CommitLogçš„åç§»</span>
                                HAConnection<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>slaveRequestOffset <span class="token operator">=</span> readOffset<span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            <span class="token comment" spellcheck="true">// æ ¹æ®Slaveå“åº”çš„åŒæ­¥åç§»è¿›åº¦ï¼Œé€šçŸ¥HAServiceçš„GroupTransferServiceåˆ¤æ–­åŒæ­¥è¿›åº¦ï¼Œæ˜¯å¦è§£é™¤Brokerçš„SlaveåŒæ­¥è¯·æ±‚çš„é˜»å¡</span>
                            <span class="token comment" spellcheck="true">// å®è¯è¯´ï¼ŒHAéƒ¨åˆ†å†™å¾—ï¼Œemmm</span>
                            HAConnection<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>haService<span class="token punctuation">.</span><span class="token function">notifyTransferSome</span><span class="token punctuation">(</span>HAConnection<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>slaveAckOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>readSize <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// æœ€å¤šé‡è¯•ä¸‰æ¬¡</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>readSizeZeroTimes <span class="token operator">>=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<hr>
<p>HAConnection$WriteSocketService#run</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// é˜»å¡è‡³å¯å†™äº‹ä»¶å°±ç»ªæˆ–è¶…æ—¶</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>selector<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// åˆå§‹å€¼ï¼Œæœªæ”¶åˆ°Slaveçš„åŒæ­¥è¯·æ±‚</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> HAConnection<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>slaveRequestOffset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// åˆå§‹å€¼</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>nextTransferFromWhere<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// å¤§æ¦‚æ˜¯æ–°çš„Slaveï¼Œä¹‹å‰å®Œå…¨æ²¡åŒæ­¥è¿‡</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> HAConnection<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>slaveRequestOffset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// è·å–å½“å‰Masterçš„CommitLogçš„æœ€å¤§ç‰©ç†åç§»</span>
                            <span class="token keyword">long</span> masterOffset <span class="token operator">=</span> HAConnection<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>haService<span class="token punctuation">.</span><span class="token function">getDefaultMessageStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCommitLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// æˆªæ‰åé¢çš„ä¸å¤Ÿå•ä¸ªCommitLogå¤§å°çš„åç§»</span>
                            masterOffset <span class="token operator">=</span> masterOffset <span class="token operator">-</span> <span class="token punctuation">(</span>masterOffset <span class="token operator">%</span> HAConnection<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>haService<span class="token punctuation">.</span><span class="token function">getDefaultMessageStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMappedFileSizeCommitLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>masterOffset <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                masterOffset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            <span class="token comment" spellcheck="true">// æ›´æ–°ä¸‹æ¬¡ä¼ è¾“çš„åç§»èµ·ç‚¹ä¸ºæœ€åä¸€ä¸ªCommitLogæ–‡ä»¶çš„èµ·å§‹åç§»</span>
                            <span class="token keyword">this</span><span class="token punctuation">.</span>nextTransferFromWhere <span class="token operator">=</span> masterOffset<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// æ›´æ–°ä¸‹æ¬¡ä¼ è¾“çš„åç§»èµ·ç‚¹ä¸ºSlaveå‘é€è¯·æ±‚æ—¶çš„åç§»è®¾ç½®</span>
                            <span class="token keyword">this</span><span class="token punctuation">.</span>nextTransferFromWhere <span class="token operator">=</span> HAConnection<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>slaveRequestOffset<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// ä¸Šæ¬¡å‘Slaveå†™å®Œäº†æ•°æ®</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>lastWriteOver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// å†™é—´éš”æ—¶é—´</span>
                        <span class="token keyword">long</span> interval <span class="token operator">=</span> HAConnection<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>haService<span class="token punctuation">.</span><span class="token function">getDefaultMessageStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSystemClock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lastWriteTimestamp<span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// åˆ°æ—¶å€™å‘Slaveå†™äº†</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>interval <span class="token operator">></span> HAConnection<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>haService<span class="token punctuation">.</span><span class="token function">getDefaultMessageStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHaSendHeartbeatInterval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// é‡ç½®Headerçš„å†™ç´¢å¼•</span>
                            <span class="token keyword">this</span><span class="token punctuation">.</span>byteBufferHeader<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// Headerå¤§å°ï¼Œ8 + 4 = 12å­—èŠ‚</span>
                            <span class="token keyword">this</span><span class="token punctuation">.</span>byteBufferHeader<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>headerSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// ä¼ è¾“çš„CommitLogç‰‡æ®µçš„èµ·å§‹åç§»ï¼Œ8å­—èŠ‚</span>
                            <span class="token keyword">this</span><span class="token punctuation">.</span>byteBufferHeader<span class="token punctuation">.</span><span class="token function">putLong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>nextTransferFromWhere<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// æ¶ˆæ¯ä½“å¤§å°ï¼Œ4å­—èŠ‚</span>
                            <span class="token keyword">this</span><span class="token punctuation">.</span>byteBufferHeader<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// åˆ‡ä¸ºè¯»æ¨¡å¼</span>
                            <span class="token keyword">this</span><span class="token punctuation">.</span>byteBufferHeader<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// å‘Slaveä¼ è¾“æ•°æ®/å¿ƒè·³</span>
                            <span class="token keyword">this</span><span class="token punctuation">.</span>lastWriteOver <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">transferData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// å†™å®Œæ‰èƒ½ç»§ç»­</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>lastWriteOver<span class="token punctuation">)</span>
                                <span class="token keyword">continue</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// è¿˜æœ‰å‰©ä½™æ²¡å†™å®Œ</span>
                    <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ç»§ç»­å‘é€ç»™Slave</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>lastWriteOver <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">transferData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// åªæœ‰å†™å®Œæ‰èƒ½ç»§ç»­ä¸‹ä¸€ä¸ªåŠ¨ä½œ</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>lastWriteOver<span class="token punctuation">)</span>
                            <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// æ ¹æ®èµ·å§‹åç§»è·å–CommitLogæ•°æ®</span>
                    SelectMappedBufferResult selectResult <span class="token operator">=</span> HAConnection<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>haService<span class="token punctuation">.</span><span class="token function">getDefaultMessageStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCommitLogData</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>nextTransferFromWhere<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>selectResult <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// CommitLogæ•°æ®çš„å¤§å°</span>
                        <span class="token keyword">int</span> size <span class="token operator">=</span> selectResult<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// å¤§äºä¼ è¾“çš„å¤§å°é™åˆ¶</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">></span> HAConnection<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>haService<span class="token punctuation">.</span><span class="token function">getDefaultMessageStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHaTransferBatchSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// æˆªæ–­</span>
                            size <span class="token operator">=</span> HAConnection<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>haService<span class="token punctuation">.</span><span class="token function">getDefaultMessageStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHaTransferBatchSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment" spellcheck="true">// æœ¬æ¬¡ä¼ è¾“çš„èµ·å§‹åç§»</span>
                        <span class="token keyword">long</span> thisOffset <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>nextTransferFromWhere<span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// ä¸‹æ¬¡ä¼ è¾“çš„èµ·å§‹åç§»</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>nextTransferFromWhere <span class="token operator">+=</span> size<span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// è®¾ç½®è¯»é™åˆ¶</span>
                        selectResult<span class="token punctuation">.</span><span class="token function">getByteBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>selectMappedBufferResult <span class="token operator">=</span> selectResult<span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// Build Header</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>byteBufferHeader<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>byteBufferHeader<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>headerSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>byteBufferHeader<span class="token punctuation">.</span><span class="token function">putLong</span><span class="token punctuation">(</span>thisOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>byteBufferHeader<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>byteBufferHeader<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// å‘Slaveä¼ è¾“æ•°æ®</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>lastWriteOver <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">transferData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// æ²¡æœ‰æ–°çš„æ¶ˆæ¯</span>
                    <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ç­‰å¾…CommitLogæœ‰æ¶ˆæ¯å”¤é†’æˆ–è¶…æ—¶</span>
                        HAConnection<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>haService<span class="token punctuation">.</span><span class="token function">getWaitNotifyObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">allWaitForRunning</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// å†™æœåŠ¡ç»“æŸ</span>
            <span class="token comment" spellcheck="true">// å…³é—­é€»è¾‘ï¼Œç•¥</span>
        <span class="token punctuation">}</span></code></pre>
<p>HAConnection$WriteSocketService#transferData</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">transferData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
            <span class="token keyword">int</span> writeSizeZeroTimes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å‘SocketChannelå†™å…¥Headerï¼Œç›´åˆ°å†™å®Œ</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>byteBufferHeader<span class="token punctuation">.</span><span class="token function">hasRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> writeSize <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>socketChannel<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>byteBufferHeader<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>writeSize <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    writeSizeZeroTimes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>lastWriteTimestamp <span class="token operator">=</span> HAConnection<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>haService<span class="token punctuation">.</span><span class="token function">getDefaultMessageStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSystemClock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>writeSize <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// æœ€å¤šé‡è¯•ä¸‰æ¬¡</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>writeSizeZeroTimes <span class="token operator">>=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// æ²¡æœ‰æ•°æ®å°±ä¸ç”¨å†™æ¶ˆæ¯ä½“äº†</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>selectMappedBufferResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>byteBufferHeader<span class="token punctuation">.</span><span class="token function">hasRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            writeSizeZeroTimes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å¦‚æœHeaderå·²ç»è¯»å®Œ</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>byteBufferHeader<span class="token punctuation">.</span><span class="token function">hasRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ç›´åˆ°è¦ä¼ è¾“çš„CommitLogæ•°æ®å…¨éƒ¨è¯»å®Œ</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>selectMappedBufferResult<span class="token punctuation">.</span><span class="token function">getByteBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å‘SocketChannelå†™å…¥æ•°æ®</span>
                    <span class="token keyword">int</span> writeSize <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>socketChannel<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>selectMappedBufferResult<span class="token punctuation">.</span><span class="token function">getByteBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>writeSize <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        writeSizeZeroTimes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>lastWriteTimestamp <span class="token operator">=</span> HAConnection<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>haService<span class="token punctuation">.</span><span class="token function">getDefaultMessageStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSystemClock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>writeSize <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>writeSizeZeroTimes <span class="token operator">>=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// æ¶ˆæ¯å¤´å’Œæ¶ˆæ¯ä½“å·²ç»å…¨éƒ¨è¯»å®Œï¼Œå³å‘é€æˆåŠŸ</span>
            <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>byteBufferHeader<span class="token punctuation">.</span><span class="token function">hasRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>selectMappedBufferResult<span class="token punctuation">.</span><span class="token function">getByteBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ¶ˆæ¯ä½“å·²ç»è¯»å®Œ</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>selectMappedBufferResult<span class="token punctuation">.</span><span class="token function">getByteBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// é‡Šæ”¾</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>selectMappedBufferResult<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>selectMappedBufferResult <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<hr>
<p>HAService$HAClient#run</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// è¿æ¥MasteræˆåŠŸ</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">connectMaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ç¦»ä¸Šæ¬¡å‘Masterä¸ŠæŠ¥è¿›åº¦çš„é—´éš”åˆ°æœŸäº†ï¼Œé»˜è®¤5s</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isTimeToReportOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// å‘Masterå‘é€å½“å‰Slaveçš„CommitLogçš„æœ€å¤§åç§»ï¼ŒåŒæ—¶ä¹Ÿæ˜¯å¿ƒè·³</span>
                            <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reportSlaveMaxOffset</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currentReportedOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">closeMaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment" spellcheck="true">// é˜»å¡è¶…æ—¶è‡³å¯è¯»äº‹ä»¶å°±ç»ª</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>selector<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// å¤„ç†è¯»äº‹ä»¶ï¼Œå³Masterä¼ è¾“çš„CommitLogæ•°æ®</span>
                        <span class="token keyword">boolean</span> ok <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">processReadEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ok<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">closeMaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment" spellcheck="true">// å¦‚æœå½“å‰Slaveçš„CommitLogæœ€å¤§ç‰©ç†åç§»å¤§äºä¸Šæ¬¡ä¸ŠæŠ¥çš„åç§»ï¼Œè¯´æ˜æœ¬æ¬¡åŒæ­¥æˆåŠŸï¼Œç»§ç»­å‘Masterä¸ŠæŠ¥</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">reportSlaveMaxOffsetPlus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">continue</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment" spellcheck="true">// ä¸Šæ¬¡å‘Masterå‘é€æ•°æ®çš„æ—¶é—´é—´éš”</span>
                        <span class="token keyword">long</span> interval <span class="token operator">=</span> HAService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getDefaultMessageStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSystemClock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lastWriteTimestamp<span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// è®¤ä¸ºè¿æ¥è¶…æ—¶ï¼Œå…³é—­è¿æ¥</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>interval <span class="token operator">></span> HAService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getDefaultMessageStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHaHousekeepingInterval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">closeMaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// å”¤é†’åå†å°è¯•</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">waitForRunning</span><span class="token punctuation">(</span><span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">waitForRunning</span><span class="token punctuation">(</span><span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span></code></pre>
<p>HAService$HAClient#connectMaster</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">connectMaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> ClosedChannelException <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">==</span> socketChannel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                String addr <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>masterAddress<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>addr <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    SocketAddress socketAddress <span class="token operator">=</span> RemotingUtil<span class="token punctuation">.</span><span class="token function">string2SocketAddress</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>socketAddress <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// è¿æ¥Masterï¼Œè¿”å›SocketAddress</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>socketChannel <span class="token operator">=</span> RemotingUtil<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>socketAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>socketChannel <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// å…³å¿ƒå¯è¯»äº‹ä»¶</span>
                            <span class="token keyword">this</span><span class="token punctuation">.</span>socketChannel<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>selector<span class="token punctuation">,</span> SelectionKey<span class="token punctuation">.</span>OP_READ<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// å½“å‰Slaveçš„CommitLogæœ€å¤§ç‰©ç†åç§»</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>currentReportedOffset <span class="token operator">=</span> HAService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMaxPhyOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>lastWriteTimestamp <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>socketChannel <span class="token operator">!=</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>HAService$HAClient#reportSlaveMaxOffset</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">reportSlaveMaxOffset</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">long</span> maxOffset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// é‡ç½®å†™ç´¢å¼•</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>reportOffset<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>reportOffset<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 8å­—èŠ‚CommitLogåŒæ­¥åç§»</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>reportOffset<span class="token punctuation">.</span><span class="token function">putLong</span><span class="token punctuation">(</span>maxOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// é‡ç½®è¯»ç´¢å¼•</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>reportOffset<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>reportOffset<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// é‡è¯•3æ¬¡ï¼Œæˆ–è€…ç¼“å†²å…¨éƒ¨è¯»å®Œ</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reportOffset<span class="token punctuation">.</span><span class="token function">hasRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å‘é€</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>socketChannel<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reportOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// æ›´æ–°æ—¶é—´æˆ³</span>
            lastWriteTimestamp <span class="token operator">=</span> HAService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getSystemClock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è¿”å›ç¼“å†²æœ‰æ²¡æœ‰å‘å®Œ</span>
            <span class="token keyword">return</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>reportOffset<span class="token punctuation">.</span><span class="token function">hasRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>HAService$HAClient#processReadEvent</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">processReadEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> readSizeZeroTimes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è¯»ç¼“å†²å¯å†™</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>byteBufferRead<span class="token punctuation">.</span><span class="token function">hasRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å°†æ•°æ®ä»SocketChannelå†™å…¥è¯»ç¼“å†²</span>
                    <span class="token keyword">int</span> readSize <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>socketChannel<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>byteBufferRead<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// è¯»å–åˆ°äº†æ•°æ®</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>readSize <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        readSizeZeroTimes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// åˆ†å‘è¯»è¯·æ±‚</span>
                        <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">dispatchReadRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// æ²¡è¯»åˆ°æ•°æ®</span>
                    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>readSize <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// é‡è¯•ä¸‰æ¬¡æ²¡è¯»åˆ°æ•°æ®å°±é€€å‡º</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>readSizeZeroTimes <span class="token operator">>=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>HAService$HAClient#dispatchReadRequest</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">dispatchReadRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ¶ˆæ¯å¤´åŒ…å«äº†8å­—èŠ‚çš„ç‰©ç†åç§»å’Œ4å­—èŠ‚çš„æ¶ˆæ¯ä½“å¤§å°</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> msgHeaderSize <span class="token operator">=</span> <span class="token number">8</span> <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// phyoffset + size</span>
            <span class="token comment" spellcheck="true">// å…ˆä¿å­˜è¯»ç¼“å†²çš„å†™ç´¢å¼•</span>
            <span class="token keyword">int</span> readSocketPos <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>byteBufferRead<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// dispatchPositionåˆå§‹ä¸º0ï¼Œå¯ç†è§£ä¸ºå½“å‰æ¶ˆæ¯åŒ…çš„åœ¨è¯»ç¼“å†²çš„èµ·å§‹åç§»ï¼Œå› ä¸ºå¤šæ¡æ¶ˆæ¯åŒ…æ˜¯ç´¯åŠ åˆ°è¯»ç¼“å†²ä¸Šçš„ï¼Œè€Œä¸æ˜¯è¯»å®Œä¸€æ¡æ¸…ä¸€æ¡</span>
                <span class="token comment" spellcheck="true">// ä¸Šæ¡æ¶ˆæ¯å¤„ç†åï¼Œè¯»ç¼“å†²æœ‰æ–°çš„æ•°æ®è¿›æ¥</span>
                <span class="token keyword">int</span> diff <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>byteBufferRead<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dispatchPosition<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// åŒ…å«äº†ä¸€ä¸ªå®Œæ•´çš„Header</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>diff <span class="token operator">>=</span> msgHeaderSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ä»è¯»ç¼“å†²çš„æŒ‡å®šä½ç½®è¯»å–8å­—èŠ‚çš„Masterä¼ è¾“çš„CommitLogç‰‡æ®µçš„èµ·å§‹ç‰©ç†åç§»</span>
                    <span class="token keyword">long</span> masterPhyOffset <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>byteBufferRead<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>dispatchPosition<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// ä»è¯»ç¼“å†²çš„æŒ‡å®šä½ç½®è¯»å–4å­—èŠ‚çš„CommitLogæ¶ˆæ¯ä½“å¤§å°</span>
                    <span class="token keyword">int</span> bodySize <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>byteBufferRead<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>dispatchPosition <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// Slaveå½“å‰CommitLogçš„æœ€å¤§ç‰©ç†åç§»</span>
                    <span class="token keyword">long</span> slavePhyOffset <span class="token operator">=</span> HAService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMaxPhyOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>slavePhyOffset <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// å¢é‡åŒæ­¥ï¼Œå¦‚æœSlaveçš„CommitLogæœ€å¤§ç‰©ç†åç§»å’Œæœ¬æ¬¡MasteråŒæ­¥çš„CommitLogç‰‡æ®µèµ·å§‹åç§»ä¸ä¸€è‡´</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>slavePhyOffset <span class="token operator">!=</span> masterPhyOffset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// åé¢ä¼šå…³é—­è¿æ¥</span>
                            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// åŒ…å«äº†ä¸€ä¸ªå®Œæ•´çš„æ¶ˆæ¯å¤´å’Œæ¶ˆæ¯ä½“</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>diff <span class="token operator">>=</span> <span class="token punctuation">(</span>msgHeaderSize <span class="token operator">+</span> bodySize<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bodyData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span>bodySize<span class="token punctuation">]</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// è®¾ç½®è¯»ç´¢å¼•</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>byteBufferRead<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>dispatchPosition <span class="token operator">+</span> msgHeaderSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// ä»è¯»ç¼“å†²å¡«å……æ¶ˆæ¯ä½“æ•°æ®</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>byteBufferRead<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>bodyData<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// æŠŠMasteråŒæ­¥è¿‡æ¥çš„CommitLogæ·»åŠ åˆ°Slaveçš„CommitLog</span>
                        HAService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">appendToCommitLog</span><span class="token punctuation">(</span>masterPhyOffset<span class="token punctuation">,</span> bodyData<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// æ¢å¤è¯»ç¼“å†²çš„å†™ç´¢å¼•</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>byteBufferRead<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span>readSocketPos<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// æ›´æ–°å¤„ç†åç§»</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>dispatchPosition <span class="token operator">+=</span> msgHeaderSize <span class="token operator">+</span> bodySize<span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// å¦‚æœå½“å‰Slaveçš„CommitLogæœ€å¤§ç‰©ç†åç§»å¤§äºä¸Šæ¬¡ä¸ŠæŠ¥çš„åç§»ï¼Œè¯´æ˜æœ¬æ¬¡åŒæ­¥æˆåŠŸï¼Œç»§ç»­å‘Masterä¸ŠæŠ¥</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">reportSlaveMaxOffsetPlus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// å‘é€ä¸æˆåŠŸï¼Œå…³é—­è¿æ¥</span>
                            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// è¯»ç¼“å†²å†™æ»¡äº†</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>byteBufferRead<span class="token punctuation">.</span><span class="token function">hasRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// é‡æ–°åˆ†é…ç©ºé—´</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reallocateByteBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>HAService$HAClient#reportSlaveMaxOffsetPlus</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">reportSlaveMaxOffsetPlus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">boolean</span> result <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">long</span> currentPhyOffset <span class="token operator">=</span> HAService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMaxPhyOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å½“å‰Slaveçš„CommitLogçš„æœ€å¤§ç‰©ç†åç§» > ä¸Šæ¬¡å‘Masterä¸ŠæŠ¥çš„åç§»</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>currentPhyOffset <span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>currentReportedOffset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// è¯´æ˜æœ¬æ¬¡åŒæ­¥æˆåŠŸï¼Œæ›´æ–°ä¸‹æ¬¡å‘Masterä¸ŠæŠ¥çš„åç§»</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>currentReportedOffset <span class="token operator">=</span> currentPhyOffset<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ç»§ç»­ä¸ŠæŠ¥Master</span>
                result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reportSlaveMaxOffset</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>currentReportedOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">closeMaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<hr>
<p>åŒæ­¥Masteræƒ…å†µä¸‹çš„ä¸»ä»åŒæ­¥</p>
<p>CommitLog#putMessage</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> PutMessageResult <span class="token function">putMessage</span><span class="token punctuation">(</span><span class="token keyword">final</span> MessageExtBrokerInner msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// æ¶ˆæ¯å†™å…¥CommitLogçš„MappedFileï¼Œç•¥</span>
        <span class="token comment" spellcheck="true">// å¤„ç†åˆ·ç›˜</span>
        <span class="token function">handleDiskFlush</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> putMessageResult<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¤„ç†é«˜å¯ç”¨ï¼Œå¦‚æœBrokeræ˜¯SYNC_MASTERï¼Œåˆ™ç­‰SLAVEæ¥æ”¶åˆ°æ•°æ®åæ‰è¿”å›ï¼Œå¦‚æœæ˜¯ASYNC_MASTERï¼Œäº¤ç»™HAServiceçº¿ç¨‹æ‰§è¡ŒåŒæ­¥</span>
        <span class="token function">handleHA</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> putMessageResult<span class="token punctuation">,</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> putMessageResult<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>CommitLog#handleHA</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleHA</span><span class="token punctuation">(</span>AppendMessageResult result<span class="token punctuation">,</span> PutMessageResult putMessageResult<span class="token punctuation">,</span> MessageExt messageExt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// åŒæ­¥Master</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>BrokerRole<span class="token punctuation">.</span>SYNC_MASTER <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBrokerRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            HAService service <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getHaService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å¦‚æœè¦ç­‰å¾…å­˜å‚¨ç»“æœæ˜¯å¦OK</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>messageExt<span class="token punctuation">.</span><span class="token function">isWaitStoreMsgOK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å­˜åœ¨Slaveè¿æ¥ &amp;&amp; Slaveå’ŒMasterè¿›åº¦å·®ä¸è¶…è¿‡1024 * 1024 * 256 = 256MB</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>service<span class="token punctuation">.</span><span class="token function">isSlaveOK</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getWroteOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> result<span class="token punctuation">.</span><span class="token function">getWroteBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// åˆ›å»ºæäº¤è¯·æ±‚</span>
                    GroupCommitRequest request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GroupCommitRequest</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getWroteOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> result<span class="token punctuation">.</span><span class="token function">getWroteBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// åŠ å…¥HAServiceçš„GroupTransferServiceçš„é˜Ÿåˆ—</span>
                    service<span class="token punctuation">.</span><span class="token function">putRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// å”¤é†’HAConnectionçš„WriteSocketServiceçº¿ç¨‹ï¼Œå‘SlaveåŒæ­¥æ–°çš„CommitLog</span>
                    service<span class="token punctuation">.</span><span class="token function">getWaitNotifyObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">wakeupAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// é˜»å¡ç­‰åŒæ­¥å®Œæˆè¢«HAServiceçš„GroupTransferServiceçº¿ç¨‹å”¤é†’æˆ–è¶…æ—¶</span>
                    <span class="token keyword">boolean</span> flushOK <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">waitForFlush</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMessageStore<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSyncFlushTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// ç•¥</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// æ²¡æœ‰Slaveï¼Œä½†æ˜¯è®¾ç½®äº†åŒæ­¥Master</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// é€šçŸ¥ç”Ÿäº§è€…ï¼ŒSlaveä¸å¯ç”¨</span>
                    putMessageResult<span class="token punctuation">.</span><span class="token function">setPutMessageStatus</span><span class="token punctuation">(</span>PutMessageStatus<span class="token punctuation">.</span>SLAVE_NOT_AVAILABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span></code></pre>
<p>HAService$GroupTransferService#putRequest</p>
<pre class=" language-java"><code class="language-java">        <span class="token comment" spellcheck="true">/**
         * è¯·æ±‚å…ˆæäº¤åˆ°å†™é˜Ÿåˆ—ï¼Œæ¯æ¬¡å¤„ç†å‰ï¼Œå…ˆäº¤æ¢è¯»å†™é˜Ÿåˆ—ï¼Œç„¶åä»è¯»é˜Ÿåˆ—è·å–è¯·æ±‚ï¼Œæäº¤åå†æ¸…ç©ºè¯»é˜Ÿåˆ—ï¼Œé¿å…å¤šçº¿ç¨‹æ“ä½œé—®é¢˜
         * CommitLogçš„å†…éƒ¨ç±»GroupCommitServiceä¹Ÿæ˜¯åŒæ ·çš„å¤„ç†
         */</span>
        <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">putRequest</span><span class="token punctuation">(</span><span class="token keyword">final</span> CommitLog<span class="token punctuation">.</span>GroupCommitRequest request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è·å–å†™é˜Ÿåˆ—çš„åŒæ­¥é”ï¼Œå› ä¸ºswapRequestsæ–¹æ³•ä¼šäº¤æ¢å†™é˜Ÿåˆ—å’Œè¯»é˜Ÿåˆ—</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>requestsWrite<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æ·»åŠ åˆ°å†™é˜Ÿåˆ—</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>requestsWrite<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// æ–°è¯·æ±‚åŠ å…¥æ—¶ï¼Œæ²¡å”¤é†’å°±å”¤é†’GroupTransferServiceçº¿ç¨‹</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>hasNotified<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                waitPoint<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// notify</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span></code></pre>
<p>HAService$GroupTransferService#run</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å¦‚æœå”¤é†’æ ‡å¿—ä¸ºå·²å”¤é†’ï¼ˆæœ‰è¯·æ±‚åŠ å…¥ï¼‰ï¼Œé‡ç½®æ ‡è®°ä¸ºæœªå”¤é†’ï¼Œå¹¶äº¤æ¢è¯»å†™é˜Ÿåˆ—</span>
                    <span class="token comment" spellcheck="true">// å¦‚æœå”¤é†’æ ‡è®°ä¸ºæœªå”¤é†’ï¼Œåˆ™é˜»å¡è¶…æ—¶ç­‰å¾…å”¤é†’ï¼Œæœ€åé‡ç½®æ ‡è®°ä¸ºæœªå”¤é†’ï¼Œå¹¶äº¤æ¢è¯»å†™é˜Ÿåˆ—</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">waitForRunning</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// æ‰§è¡Œç­‰å¾…ä¼ è¾“</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doWaitTransfer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span></code></pre>
<p>HAService$GroupTransferService#doWaitTransfer</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doWaitTransfer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è·å–è¯»é˜Ÿåˆ—çš„åŒæ­¥é”</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>requestsRead<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>requestsRead<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// éå†Slaveçš„åŒæ­¥è¯·æ±‚</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span>CommitLog<span class="token punctuation">.</span>GroupCommitRequest req <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>requestsRead<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// Slaveå›å¤ç¡®è®¤çš„CommitLogæœ€å¤§åç§» > è¯·æ±‚çš„æ¶ˆæ¯åœ¨CommitLogçš„ç»“æŸä½ç½®</span>
                        <span class="token comment" spellcheck="true">// è¯´æ˜åŒæ­¥ä¼ è¾“æˆåŠŸ</span>
                        <span class="token keyword">boolean</span> transferOK <span class="token operator">=</span> HAService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>push2SlaveMaxOffset<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> req<span class="token punctuation">.</span><span class="token function">getNextOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// é‡è¯•5æ¬¡æˆ–åŒæ­¥ä¼ è¾“æˆåŠŸ</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">!</span>transferOK <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// å…ˆé˜»å¡1ç§’ï¼Œæˆ–è€…HAConnectionçš„ReadSocketServiceçº¿ç¨‹æ”¶åˆ°Slaveçš„åŒæ­¥åç§»ç¡®è®¤æ—¶å”¤é†’</span>
                            <span class="token keyword">this</span><span class="token punctuation">.</span>notifyTransferObject<span class="token punctuation">.</span><span class="token function">waitForRunning</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// å†æ£€æŸ¥ä¸€æ¬¡</span>
                            transferOK <span class="token operator">=</span> HAService<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>push2SlaveMaxOffset<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> req<span class="token punctuation">.</span><span class="token function">getNextOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                        <span class="token comment" spellcheck="true">// å”¤é†’æäº¤åŒæ­¥Slaveè¯·æ±‚çš„Brokerçº¿ç¨‹ï¼Œæ˜¯å¦åŒæ­¥æˆåŠŸ</span>
                        req<span class="token punctuation">.</span><span class="token function">wakeupCustomer</span><span class="token punctuation">(</span>transferOK<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// å¤„ç†å®Œå°±æ¸…ç©ºè¯»é˜Ÿåˆ—</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>requestsRead<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span></code></pre>
<p>HAConnection$ReadSocketService#processReadEvent</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">processReadEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// ç›´åˆ°è¯»å®Œè¯»ç¼“å†²</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>byteBufferRead<span class="token punctuation">.</span><span class="token function">hasRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ä»SocketChannelè¯»å–æ•°æ®åˆ°è¯»ç¼“å†²</span>
                    <span class="token keyword">int</span> readSize <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>socketChannel<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>byteBufferRead<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// è¯»å–åˆ°äº†æ•°æ®</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>readSize <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>byteBufferRead<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>processPosition<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// ...</span>
                            <span class="token comment" spellcheck="true">// ä»è¯»ç¼“å†²è¯»å–Slaveçš„CommitLogåŒæ­¥åç§»ï¼Œ8å­—èŠ‚</span>
                            <span class="token keyword">long</span> readOffset <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>byteBufferRead<span class="token punctuation">.</span><span class="token function">getLong</span><span class="token punctuation">(</span>pos <span class="token operator">-</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// ...</span>
                            HAConnection<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>slaveAckOffset <span class="token operator">=</span> readOffset<span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// ...</span>
                            HAConnection<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>haService<span class="token punctuation">.</span><span class="token function">notifyTransferSome</span><span class="token punctuation">(</span>HAConnection<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>slaveAckOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>readSize <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>HAService#notifyTransferSome</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">notifyTransferSome</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">long</span> offset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Slaveå›å¤ç¡®è®¤çš„CommitLogåç§» > ä¸Šæ¬¡Slaveå›å¤ç¡®è®¤çš„CommitLogæœ€å¤§åç§»</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">long</span> value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>push2SlaveMaxOffset<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> offset <span class="token operator">></span> value<span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å°è¯•æ›´æ–°åç§»</span>
            <span class="token keyword">boolean</span> ok <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>push2SlaveMaxOffset<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ok<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// é€šçŸ¥å·²ç»ä¼ è¾“äº†æ•°æ®</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>groupTransferService<span class="token punctuation">.</span><span class="token function">notifyTransferSome</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å†æ¬¡è·å–å½“å‰å·²å‘Slaveä¼ è¾“çš„CommitLogæœ€å¤§åç§»</span>
                value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>push2SlaveMaxOffset<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>HAService$GroupTransferService#notifyTransferSome</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">notifyTransferSome</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>notifyTransferObject<span class="token punctuation">.</span><span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


        <footer>
             
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

        </footer>
    </div>
    <!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
    <script>
        var timeEnd = new Date();
        console.log('è€—æ—¶ï¼š' + (timeEnd - timeStart));
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre').forEach((block) => {
                block.classList.add("line-numbers");
            });
        });
    </script>
    <!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
    <!-- material design -->
    <!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
    <!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
    <!-- toc -->
    <!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
    <!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
    <!-- <script src="/js/main.js"></script> -->
    <script src="/js/prism.js"></script>
</body>
</html>
