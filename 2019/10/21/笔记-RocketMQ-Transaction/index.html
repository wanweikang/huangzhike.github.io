<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
        <script>
            var timeStart = new Date();
        </script>
        
        <title>[ç¬”è®°]-RocketMQ-Transaction | ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜</title>
        
        <meta name="author" content="huangzhike">
        
        
        <meta name="description" content="ä¸äº†è§£åˆ†å¸ƒå¼äº‹åŠ¡çš„ï¼Œå¯ä»¥å…ˆçœ‹çœ‹è¿™ç¯‡æ–‡ç« å’Œè¿™ç¯‡æ–‡ç« ã€‚
è¿˜æœ‰è¿™ç¯‡ã€‚
æ‡’å¾—æ‰“å­—ï¼Œç®—äº†ï¼Œè¿˜æ˜¯ç®€å•æ€»ç»“ä¸€ä¸‹å§ã€‚

å¤ä¹ ä¸€ä¸‹ï¼Œäº‹åŠ¡çš„ACIDç‰¹æ€§ï¼š

Atomicityï¼ˆåŸå­æ€§ï¼‰ï¼šäº‹åŠ¡æ˜¯ä¸å¯åˆ†å‰²çš„å•å…ƒï¼Œå¯¹äºä¸€ä¸ªäº‹åŠ¡ï¼Œæ‰€æœ‰çš„æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ã€‚

Consistencyï¼ˆä¸€è‡´æ€§ï¼‰ï¼šäº‹åŠ¡å‰åï¼Œæ•°æ®å¿…é¡»ä¿">
        
        
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        
        <meta property="og:title" content="[ç¬”è®°]-RocketMQ-Transaction"/>
        
        <meta property="og:site_name" content="ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜"/>
        
        
        <!-- favicon -->
        <link rel="icon" type="image/ico" href="/ok.ico" sizes="32x32">
        <meta name="msapplication-TileColor" content="#009688">
        <meta name="msapplication-TileImage" content="/mstile-144x144.ico">
        <meta name="theme-color" content="#009688">
        <!-- favicon end -->
        <!-- <link href="//ok.ico" rel="icon"> -->
        
        <!-- toc -->
        <!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
        <!-- material design -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
        <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
        
        <!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
        <!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
    <meta name="generator" content="Hexo 4.2.1"></head>

<body>
    <nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">èœå•</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" title="ä¸‹ä¸€å¥æ˜¯ï¼šå®¢æœ‰å¯äººæœŸä¸æ¥ã€‚å°æ—¶å€™ï¼Œå–œæ¬¢é åœ¨é˜³å°ä¸Šï¼Œä¸€è¾¹å¹é£ï¼Œä¸€è¾¹çœ‹ä¹¦ï¼Œå–œæ¬¢è¯»ä¹¦å—ï¼Œéªšå¹´ï¼Ÿ" href="/">ä¹¦å½“å¿«æ„è¯»æ˜“å°½</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" target="_blank" rel="noopener" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

    <div class="container" >
        <div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[ç¬”è®°]-RocketMQ-Transaction</h2>
				
				<div>
					<div class="post-time">2019-10-21</div>
				</div>
				
				<div class="article-content">
				<p>ä¸äº†è§£åˆ†å¸ƒå¼äº‹åŠ¡çš„ï¼Œå¯ä»¥å…ˆçœ‹çœ‹<a href="https://www.jianshu.com/p/cc5c10221aa1" target="_blank" rel="noopener">è¿™ç¯‡æ–‡ç« </a>å’Œ<a href="https://www.cnblogs.com/wudimanong/p/10340948.html" target="_blank" rel="noopener">è¿™ç¯‡æ–‡ç« </a>ã€‚</p>
<p>è¿˜æœ‰<a href="https://www.cnblogs.com/jajian/p/10014145.html" target="_blank" rel="noopener">è¿™ç¯‡</a>ã€‚</p>
<p><del>æ‡’å¾—æ‰“å­—</del>ï¼Œç®—äº†ï¼Œè¿˜æ˜¯ç®€å•æ€»ç»“ä¸€ä¸‹å§ã€‚</p>
<hr>
<p>å¤ä¹ ä¸€ä¸‹ï¼Œäº‹åŠ¡çš„ACIDç‰¹æ€§ï¼š</p>
<ul>
<li><p>Atomicityï¼ˆåŸå­æ€§ï¼‰ï¼šäº‹åŠ¡æ˜¯ä¸å¯åˆ†å‰²çš„å•å…ƒï¼Œå¯¹äºä¸€ä¸ªäº‹åŠ¡ï¼Œæ‰€æœ‰çš„æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ã€‚</p>
</li>
<li><p>Consistencyï¼ˆä¸€è‡´æ€§ï¼‰ï¼šäº‹åŠ¡å‰åï¼Œæ•°æ®å¿…é¡»ä¿æŒä¸€è‡´ï¼Œå¦‚Aå‘Bè½¬è´¦ï¼ŒAå’ŒBçš„æ€»é‡‘é¢å°±æ˜¯ä¸ªä¸€è‡´æ€§çŠ¶æ€ã€‚</p>
</li>
<li><p>Isolationï¼ˆéš”ç¦»æ€§ï¼‰ï¼šå¤šä¸ªå¹¶å‘äº‹åŠ¡ä¹‹é—´ç›¸äº’éš”ç¦»ï¼Œæ“ä½œä¸èƒ½äº’ç›¸å¹²æ‰°ã€‚å¸¸ç”¨çš„æ–¹å¼æ˜¯åŠ é”ã€‚</p>
</li>
<li><p>Durablityï¼ˆæŒä¹…æ€§ï¼‰ï¼šäº‹åŠ¡æäº¤åï¼Œæ›´æ”¹æ˜¯æ°¸ä¹…çš„ã€‚</p>
</li>
</ul>
<p>äº‹åŠ¡å¹¶å‘çš„è„è¯»ã€å¹»è¯»é—®é¢˜ã€äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼šå¾…å¤ä¹ ã€‚</p>
<hr>
<p>ä¸¤é˜¶æ®µæäº¤åè®®ï¼ˆTwo Phase Commitï¼Œ2PCï¼‰ï¼š</p>
<ul>
<li><p>Clientå‘Coordinatorï¼ˆä¸­å¿ƒåè°ƒèŠ‚ç‚¹ï¼‰å‘èµ·ä¸€ä¸ªäº‹åŠ¡è¯·æ±‚ï¼›</p>
</li>
<li><p>Coordinatorå‘Nä¸ªPartcipantï¼ˆå‚ä¸è€…èŠ‚ç‚¹ï¼‰å‘é€PrepareRequestï¼ˆäº‹åŠ¡é¢„å¤„ç†è¯·æ±‚ï¼‰ï¼›</p>
</li>
<li><p>Partcipantæ”¶åˆ°PrepareRequeståï¼Œå¦‚æœå¯ä»¥å¤„ç†ï¼Œåˆ™æ‰§è¡Œæœ¬åœ°äº‹åŠ¡ï¼Œä½†ä¸æäº¤ï¼Œè€Œç»™Coordinatorå›å¤YESï¼Œå¦‚æœä¸èƒ½å¤„ç†ï¼Œå›å¤NOï¼›</p>
</li>
<li><p>Coordinatoræ”¶åˆ°æ‰€æœ‰çš„Partcipantçš„YESåï¼Œå†å‘Partcipantå‘é€æäº¤è¯·æ±‚ï¼ŒPartcipantå†æäº¤æœ¬åœ°äº‹åŠ¡ï¼›</p>
</li>
<li><p>å¦åˆ™ï¼ŒCoordinatorå‘æ‰€æœ‰çš„Partcipantå‘èµ·å›æ»šï¼ŒPartcipantæ‰§è¡Œå›æ»šåè¿”å›ç¡®è®¤ã€‚</p>
</li>
</ul>
<p>é—®é¢˜ï¼š</p>
<ul>
<li><p>Coordinatorå‘é€PrepareRequeståï¼Œå¦‚æœå®•æœºï¼ŒPartcipantäº‹åŠ¡ä¼šä¸€ç›´æŒ‚èµ·ç›´åˆ°è¶…æ—¶ï¼›</p>
</li>
<li><p>Partcipantç›´åˆ°æ”¶åˆ°æäº¤è¯·æ±‚åï¼Œæ‰ä¼šé‡Šæ”¾ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯é˜»å¡çš„ï¼›</p>
</li>
<li><p>å¦‚æœå› ä¸ºç½‘ç»œåŸå› ï¼Œåªæœ‰éƒ¨åˆ†Partcipantæ”¶åˆ°äº†æäº¤è¯·æ±‚ï¼Œå°±ä¼šå¯¼è‡´ä¸ä¸€è‡´çš„é—®é¢˜ã€‚</p>
</li>
</ul>
<hr>
<p>ä¸‰é˜¶æ®µæäº¤åè®®ï¼ˆThree Phase Commitï¼Œ3PCï¼‰ï¼š</p>
<ul>
<li><p>CanCommitï¼šClientå‘Coordinatorå‘èµ·ä¸€ä¸ªäº‹åŠ¡è¯·æ±‚ï¼ŒCoordinatorå‘Nä¸ªPartcipantå‘é€CanCommitè¯¢é—®ï¼Œæ˜¯å¦å¯ä»¥å®Œæˆäº‹åŠ¡ï¼Œæ¯”å¦‚å°è¯•è·å–æ•°æ®åº“é”ï¼Œå¯ä»¥åˆ™å›å¤YESï¼Œå¦åˆ™NOï¼›</p>
</li>
<li><p>PreCommitï¼š</p>
<ul>
<li><p>å¦‚æœæ‰€æœ‰çš„Partcipantéƒ½è¿”å›YESï¼ŒCoordinatoråˆ™å‘æ‰€æœ‰Partcipantå‘é€PreCommitè¯·æ±‚ï¼ŒPartcipantæ”¶åˆ°åæ‰§è¡Œäº‹åŠ¡ï¼Œä½†ä¸æäº¤ï¼Œå¹¶è®°å½•Undoå’ŒRedoä¿¡æ¯åˆ°æ—¥å¿—ï¼Œå‘Coordinatorå›å¤YESï¼ŒåŒæ—¶ç­‰å¾…æŒ‡ä»¤ï¼›</p>
</li>
<li><p>å¦‚æœæœ‰Partcipantå›å¤NOï¼Œæˆ–Coordinatorç­‰å¾…Partcipantå›å¤è¶…æ—¶ï¼Œåˆ™å‘æ‰€æœ‰Partcipantå‘é€Abortè¯·æ±‚ï¼Œä¸­æ–­äº‹åŠ¡ï¼›</p>
</li>
</ul>
</li>
<li><p>DoCommitï¼š</p>
<ul>
<li><p>å¦‚æœæ‰€æœ‰çš„Partcipantéƒ½è¿”å›YESï¼ŒCoordinatoråˆ™å‘æ‰€æœ‰Partcipantå‘é€DoCommitè¯·æ±‚ï¼ŒPartcipantæ”¶åˆ°åæäº¤äº‹åŠ¡ï¼Œå‘Coordinatorå›å¤YESï¼ŒCoordinatoræ”¶åˆ°æ‰€æœ‰çš„Partcipantçš„YESåå®Œæˆäº‹åŠ¡ï¼›</p>
</li>
<li><p>å¦‚æœæœ‰Partcipantå›å¤NOï¼Œæˆ–Coordinatorç­‰å¾…Partcipantå›å¤è¶…æ—¶ï¼Œåˆ™å‘æ‰€æœ‰Partcipantå‘é€Abortè¯·æ±‚ï¼Œä¸­æ–­äº‹åŠ¡ï¼ŒPartcipantæ”¶åˆ°åæ ¹æ®Undoä¿¡æ¯æ‰§è¡Œå›æ»šï¼Œå‘Coordinatorå›å¤YESã€‚</p>
</li>
</ul>
</li>
</ul>
<p>åœ¨DoCommité˜¶æ®µï¼Œå‡å¦‚å› ä¸ºç½‘ç»œåŸå› æˆ–è€…Coordinatorå®•æœºï¼ŒPartcipantæ²¡æœ‰æ”¶åˆ°DoCommitæˆ–Abortè¯·æ±‚ï¼Œéƒ½ä¼šåœ¨ç­‰å¾…è¶…æ—¶ä¹‹åï¼Œç»§ç»­è¿›è¡Œäº‹åŠ¡æäº¤ï¼Œæ‰€ä»¥å¯èƒ½ä¼šå‡ºç°ä¸ä¸€è‡´çš„æƒ…å†µã€‚</p>
<hr>
<p>è¡¥å¿äº‹åŠ¡ï¼ˆTry Confirm Cancelï¼ŒTCCï¼‰ï¼š</p>
<p>å¯¹æ¯ä¸ªäº‹åŠ¡åˆ†æ”¯æ“ä½œéƒ½è¦æ³¨å†Œä¸€ä¸ªå¯¹åº”çš„ç¡®è®¤å’Œè¡¥å¿ï¼ˆæ’¤é”€ï¼‰æ“ä½œï¼ˆTry Confirm Cancelï¼‰ã€‚</p>
<ul>
<li><p>Tryï¼šä¸»è¦æ˜¯å¯¹ä¸šåŠ¡ç³»ç»Ÿåšæ£€æµ‹åŠèµ„æºé¢„ç•™ï¼›</p>
</li>
<li><p>Confirmï¼šç¡®è®¤æ‰§è¡Œä¸šåŠ¡æ“ä½œï¼Œè¦æ±‚TryæˆåŠŸConfirmä¸€å®šè¦èƒ½æˆåŠŸï¼›</p>
</li>
<li><p>Cancelï¼šå–æ¶ˆæ‰§è¡Œä¸šåŠ¡æ“ä½œã€‚</p>
</li>
</ul>
<p>ä»¥æ‰£é’±ä¸ºä¾‹ï¼Œåœ¨æ¥å…¥TCCå‰ï¼Œå¯¹Aè´¦æˆ·çš„æ‰£é’±ï¼Œåªéœ€ä¸€æ¡æ›´æ–°è´¦æˆ·ä½™é¢çš„SQLã€‚</p>
<p>åœ¨æ¥å…¥TCCä¹‹åï¼Œéœ€è¦å°†åŸæ¥ä¸€æ­¥å®Œæˆçš„æ‰£é’±æ“ä½œï¼Œæ‹†æˆä¸¤é˜¶æ®µï¼Œå®ç°æˆä¸‰ä¸ªæ–¹æ³•ï¼Œå¹¶ä¸”ä¿è¯ä¸€é˜¶æ®µTryæˆåŠŸçš„è¯äºŒé˜¶æ®µConfirmä¸€å®šèƒ½æˆåŠŸã€‚</p>
<p>Tryå°±æ˜¯æ£€æŸ¥è´¦æˆ·ä½™é¢æ˜¯å¦å……è¶³ï¼Œé”å®šè½¬è´¦èµ„é‡‘ï¼ˆåŠ ä¸ªé”æˆ–æ‰“ä¸ªæ ‡è®°ï¼‰ï¼Œæ­¤æ—¶è´¦å·Aä½™é¢è™½ç„¶è¿˜æ˜¯100ï¼Œä½†æ˜¯å…¶ä¸­30å…ƒå·²ç»è¢«å†»ç»“äº†ï¼Œä¸èƒ½è¢«å…¶ä»–äº‹åŠ¡ä½¿ç”¨ã€‚</p>
<p>Confirmæ‰§è¡ŒçœŸæ­£çš„æ‰£é’±æ“ä½œï¼Œä½¿ç”¨Tryé˜¶æ®µé”å®šçš„èµ„é‡‘ï¼Œæ‰§è¡Œæ‰£æ¬¾ï¼Œåˆ™è´¦å·Aä½™é¢å˜æˆ70å…ƒã€‚</p>
<p>å¦‚æœäºŒé˜¶æ®µæ˜¯å›æ»šçš„è¯ï¼Œéœ€è¦åœ¨Cancelæ–¹æ³•å†…é‡Šæ”¾ä¸€é˜¶æ®µTryå†»ç»“çš„30å…ƒï¼Œä½¿è´¦å·Aå›åˆ°åˆå§‹çŠ¶æ€ï¼Œ100å…ƒå…¨éƒ¨å¯ç”¨ã€‚</p>
<p>åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ï¼Œå°±æ˜¯Coordinatorä¾æ¬¡è°ƒç”¨æ‰€æœ‰Partcipantçš„Tryæ–¹æ³•ï¼Œæ‰€æœ‰éƒ½æ­£å¸¸çš„è¯ï¼Œå†ä¾æ¬¡è°ƒç”¨Partcipantçš„Confirmæ–¹æ³•ï¼Œå¦åˆ™è°ƒç”¨Cancelæ–¹æ³•ã€‚</p>
<p>å‡è®¾æŸä¸ªPartcipantæ„å¤–å®•æœºç„¶åé‡å¯ï¼Œå¯ä»¥ä»æŒä¹…åŒ–æ—¥å¿—ä¸­æ¢å¤è¿è¡Œçš„é˜¶æ®µå’ŒçŠ¶æ€ã€‚</p>
<p>å‡è®¾æŸä¸ªPartcipantçš„Cancelæˆ–Confirmæ–¹æ³•è°ƒç”¨å¤±è´¥ï¼Œåˆ™Coordinatorä¸æ–­é‡è¯•ï¼Œç›´åˆ°æˆåŠŸã€‚</p>
<hr>
<p>RocketMQçš„äº‹åŠ¡æ¶ˆæ¯</p>
<ul>
<li><p>Produceræ‰§è¡Œæœ¬åœ°äº‹åŠ¡ä¹‹å‰ï¼Œå‘Brokerå‘é€PREPAREDæ¶ˆæ¯ï¼Œå¹¶ä¸”æ¶ˆæ¯å‘é€æˆåŠŸï¼ˆç¡®è®¤ï¼‰ï¼Œå£°æ˜äº‹åŠ¡å¼€å§‹ï¼Œä½†æ­¤æ¶ˆæ¯ä¸ä¼šç»™Consumeræ¶ˆè´¹ï¼›</p>
</li>
<li><p>Produceræ‰§è¡Œæœ¬åœ°äº‹åŠ¡ï¼Œæ ¹æ®äº‹åŠ¡ç»“æœCommitæˆ–Rollbackæœ¬åœ°äº‹åŠ¡ï¼›</p>
</li>
<li><p>Produceræ ¹æ®äº‹åŠ¡ç»“æœå‘Brokerå‘é€COMMITæˆ–ROLLBACKæ¶ˆæ¯ï¼Œæ›´æ–°æ¶ˆæ¯çŠ¶æ€ï¼Œå¹¶ç»“æŸäº‹åŠ¡ï¼Œå‘é€æ˜¯å•å‘çš„ï¼Œä¸ä¿è¯æˆåŠŸï¼›</p>
</li>
<li><p>Brokeræ”¶åˆ°æ¶ˆæ¯åï¼Œå¦‚æœæ˜¯COMMITæ¶ˆæ¯ï¼Œåˆ™å¯ä»¥æŠ•é€’ç»™Consumeræ¶ˆè´¹ï¼Œå¦‚æœæ˜¯ROLLBACKæ¶ˆæ¯ï¼Œåˆ™åºŸå¼ƒæ¶ˆæ¯ï¼›</p>
</li>
<li><p>å¯¹äºProduceræ‰§è¡Œäº‹åŠ¡è¶…æ—¶ï¼Œæˆ–è€…å‘é€äº‹åŠ¡çŠ¶æ€æ¶ˆæ¯å¤±è´¥æˆ–ä¸¢å¤±ç­‰æƒ…å†µï¼ŒBrokerå®šæ—¶å‘Producerå›æŸ¥äº‹åŠ¡çŠ¶æ€ï¼Œå¹¶æ›´æ–°æ¶ˆæ¯çŠ¶æ€ã€‚</p>
</li>
</ul>
<p>å› ä¸ºMQæ˜¯å¼‚æ­¥çš„ï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯æœ€ç»ˆä¸€è‡´ï¼Œè€Œä¸æ˜¯å¼ºä¸€è‡´ã€‚</p>
<p>Put simplyï¼Œäº‹åŠ¡æ¶ˆæ¯çš„ç”¨å¤„å°±æ˜¯Produceræ‰§è¡Œæœ¬åœ°äº‹åŠ¡æˆåŠŸæäº¤åï¼ŒConsumerå†ä»Brokeræ‹‰å–æ¶ˆæ¯ï¼Œç„¶åç»§ç»­æ‰§è¡Œæœ¬åœ°äº‹åŠ¡ï¼Œå›å¤æ¶ˆè´¹ç¡®è®¤ã€‚</p>
<p>é‚£å¦‚æœConsumeræ‰§è¡Œæœ¬åœ°äº‹åŠ¡å¤±è´¥åï¼Œå¦‚ä½•å›æ»šProducerçš„äº‹åŠ¡å‘¢ï¼Ÿå®˜æ–¹çš„æ„è§æ˜¯ï¼Œè‡ªå·±æ‰‹åŠ¨è§£å†³ï¼Œæ¡†æ¶ä¸æä¾›æ­¤åŠŸèƒ½ã€‚</p>
<p>æœ¬åœ°äº‹åŠ¡çŠ¶æ€</p>
<ul>
<li><p>COMMITï¼šæˆåŠŸ</p>
</li>
<li><p>ROLLBACKï¼šå¤±è´¥</p>
</li>
<li><p>UNKNOWNï¼šæœªçŸ¥ï¼Œå¯èƒ½æ˜¯äº‹åŠ¡æ­£åœ¨æ‰§è¡Œï¼Œä¹Ÿå¯èƒ½æ˜¯æˆåŠŸæˆ–å¤±è´¥</p>
</li>
</ul>
<hr>
<p>DefaultMQProducerImpl#sendMessageInTransaction</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> TransactionSendResult <span class="token function">sendMessageInTransaction</span><span class="token punctuation">(</span><span class="token keyword">final</span> Message msg<span class="token punctuation">,</span> <span class="token keyword">final</span> LocalTransactionExecuter localTransactionExecuter<span class="token punctuation">,</span> <span class="token keyword">final</span> Object arg<span class="token punctuation">)</span> <span class="token keyword">throws</span> MQClientException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// æ£€æŸ¥TransactionListener</span>
        TransactionListener transactionListener <span class="token operator">=</span> <span class="token function">getCheckListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">==</span> localTransactionExecuter <span class="token operator">&amp;&amp;</span> null <span class="token operator">==</span> transactionListener<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ...</span>
        SendResult sendResult <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è®¾ç½®ä¸ºPREPAREDæ¶ˆæ¯</span>
        MessageAccessor<span class="token punctuation">.</span><span class="token function">putProperty</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> MessageConst<span class="token punctuation">.</span>PROPERTY_TRANSACTION_PREPARED<span class="token punctuation">,</span> <span class="token string">"true"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è®¾ç½®ProducerGroupï¼Œç”¨äºäº‹åŠ¡å›æŸ¥</span>
        MessageAccessor<span class="token punctuation">.</span><span class="token function">putProperty</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> MessageConst<span class="token punctuation">.</span>PROPERTY_PRODUCER_GROUP<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQProducer<span class="token punctuation">.</span><span class="token function">getProducerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// åŒæ­¥å‘é€æ¶ˆæ¯</span>
            sendResult <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// æœ¬åœ°äº‹åŠ¡åˆå§‹çŠ¶æ€ï¼ŒUNKNOW</span>
        LocalTransactionState localTransactionState <span class="token operator">=</span> LocalTransactionState<span class="token punctuation">.</span>UNKNOW<span class="token punctuation">;</span>
        Throwable localException <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å‘é€ç»“æœ</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>sendResult<span class="token punctuation">.</span><span class="token function">getSendStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å‘é€æˆåŠŸï¼Œåˆ™åŒæ­¥Masterå·²åˆ·ç›˜ï¼Œå¼‚æ­¥Masterå¯èƒ½æœªåˆ·ç›˜</span>
            <span class="token keyword">case</span> SEND_OK<span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                    String transactionId <span class="token operator">=</span> msg<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span>MessageConst<span class="token punctuation">.</span>PROPERTY_UNIQ_CLIENT_MESSAGE_ID_KEYIDX<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">!=</span> transactionId <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token string">""</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>transactionId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        msg<span class="token punctuation">.</span><span class="token function">setTransactionId</span><span class="token punctuation">(</span>transactionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">!=</span> localTransactionExecuter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        localTransactionState <span class="token operator">=</span> localTransactionExecuter<span class="token punctuation">.</span><span class="token function">executeLocalTransactionBranch</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>transactionListener <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// é€šè¿‡TransactionListeneræ‰§è¡Œæœ¬åœ°äº‹åŠ¡ï¼Œè¿”å›æœ¬åœ°äº‹åŠ¡çŠ¶æ€</span>
                        localTransactionState <span class="token operator">=</span> transactionListener<span class="token punctuation">.</span><span class="token function">executeLocalTransaction</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">==</span> localTransactionState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        localTransactionState <span class="token operator">=</span> LocalTransactionState<span class="token punctuation">.</span>UNKNOW<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å‘é€æˆåŠŸï¼Œä½†æ˜¯BrokeræŒä¹…åŒ–æ¶ˆæ¯è¶…æ—¶</span>
            <span class="token keyword">case</span> FLUSH_DISK_TIMEOUT<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// å‘é€æˆåŠŸï¼Œä½†æ˜¯åŒæ­¥Masterå°†æ¶ˆæ¯åŒæ­¥åˆ°Slaveè¶…æ—¶</span>
            <span class="token keyword">case</span> FLUSH_SLAVE_TIMEOUT<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// å‘é€æˆåŠŸï¼Œä½†æ˜¯åŒæ­¥Masteræœªæ‰¾åˆ°å¯ç”¨Slave</span>
            <span class="token keyword">case</span> SLAVE_NOT_AVAILABLE<span class="token operator">:</span>
                <span class="token comment" spellcheck="true">// éƒ½è¦å›æ»š</span>
                localTransactionState <span class="token operator">=</span> LocalTransactionState<span class="token punctuation">.</span>ROLLBACK_MESSAGE<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ç»“æŸäº‹åŠ¡ï¼Œå›æ»šæˆ–æäº¤ï¼Œæˆ–æœªçŸ¥</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">endTransaction</span><span class="token punctuation">(</span>sendResult<span class="token punctuation">,</span> localTransactionState<span class="token punctuation">,</span> localException<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        TransactionSendResult transactionSendResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransactionSendResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">return</span> transactionSendResult<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>DefaultMQProducerImpl#endTransaction</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">endTransaction</span><span class="token punctuation">(</span><span class="token keyword">final</span> SendResult sendResult<span class="token punctuation">,</span> <span class="token keyword">final</span> LocalTransactionState localTransactionState<span class="token punctuation">,</span> <span class="token keyword">final</span> Throwable localException<span class="token punctuation">)</span> <span class="token keyword">throws</span> RemotingException<span class="token punctuation">,</span> MQBrokerException<span class="token punctuation">,</span> InterruptedException<span class="token punctuation">,</span> UnknownHostException <span class="token punctuation">{</span>
        <span class="token keyword">final</span> MessageId id<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sendResult<span class="token punctuation">.</span><span class="token function">getOffsetMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            id <span class="token operator">=</span> MessageDecoder<span class="token punctuation">.</span><span class="token function">decodeMessageId</span><span class="token punctuation">(</span>sendResult<span class="token punctuation">.</span><span class="token function">getOffsetMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            id <span class="token operator">=</span> MessageDecoder<span class="token punctuation">.</span><span class="token function">decodeMessageId</span><span class="token punctuation">(</span>sendResult<span class="token punctuation">.</span><span class="token function">getMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Brokerè¿”å›çš„äº‹åŠ¡Id</span>
        String transactionId <span class="token operator">=</span> sendResult<span class="token punctuation">.</span><span class="token function">getTransactionId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ¥æ”¶PREPAREDæ¶ˆæ¯çš„Brokeråœ°å€</span>
        <span class="token keyword">final</span> String brokerAddr <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">.</span><span class="token function">findBrokerAddressInPublish</span><span class="token punctuation">(</span>sendResult<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBrokerName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        EndTransactionRequestHeader requestHeader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EndTransactionRequestHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// äº‹åŠ¡Id</span>
        requestHeader<span class="token punctuation">.</span><span class="token function">setTransactionId</span><span class="token punctuation">(</span>transactionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ¶ˆæ¯åœ¨CommitLogçš„åç§»</span>
        requestHeader<span class="token punctuation">.</span><span class="token function">setCommitLogOffset</span><span class="token punctuation">(</span>id<span class="token punctuation">.</span><span class="token function">getOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æœ¬åœ°äº‹åŠ¡çŠ¶æ€</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>localTransactionState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æäº¤</span>
            <span class="token keyword">case</span> COMMIT_MESSAGE<span class="token operator">:</span>
                requestHeader<span class="token punctuation">.</span><span class="token function">setCommitOrRollback</span><span class="token punctuation">(</span>MessageSysFlag<span class="token punctuation">.</span>TRANSACTION_COMMIT_TYPE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å›æ»š</span>
            <span class="token keyword">case</span> ROLLBACK_MESSAGE<span class="token operator">:</span>
                requestHeader<span class="token punctuation">.</span><span class="token function">setCommitOrRollback</span><span class="token punctuation">(</span>MessageSysFlag<span class="token punctuation">.</span>TRANSACTION_ROLLBACK_TYPE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// äº‹åŠ¡çŠ¶æ€ä¸æ˜</span>
            <span class="token keyword">case</span> UNKNOW<span class="token operator">:</span>
                requestHeader<span class="token punctuation">.</span><span class="token function">setCommitOrRollback</span><span class="token punctuation">(</span>MessageSysFlag<span class="token punctuation">.</span>TRANSACTION_NOT_TYPE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        requestHeader<span class="token punctuation">.</span><span class="token function">setProducerGroup</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQProducer<span class="token punctuation">.</span><span class="token function">getProducerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Queueçš„åç§»</span>
        requestHeader<span class="token punctuation">.</span><span class="token function">setTranStateTableOffset</span><span class="token punctuation">(</span>sendResult<span class="token punctuation">.</span><span class="token function">getQueueOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        requestHeader<span class="token punctuation">.</span><span class="token function">setMsgId</span><span class="token punctuation">(</span>sendResult<span class="token punctuation">.</span><span class="token function">getMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// å•å‘å‘é€ç»“æŸäº‹åŠ¡æ¶ˆæ¯ï¼ŒEND_TRANSACTIONè¯·æ±‚ï¼Œåç»­ç”±Brokerè´Ÿè´£å›æŸ¥</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">.</span><span class="token function">getMQClientAPIImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">endTransactionOneway</span><span class="token punctuation">(</span>brokerAddr<span class="token punctuation">,</span> requestHeader<span class="token punctuation">,</span> remark<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQProducer<span class="token punctuation">.</span><span class="token function">getSendMsgTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>SendMessageProcessor#sendMessage</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> RemotingCommand <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token keyword">final</span> ChannelHandlerContext ctx<span class="token punctuation">,</span> <span class="token keyword">final</span> RemotingCommand request<span class="token punctuation">,</span> <span class="token keyword">final</span> SendMessageContext sendMessageContext<span class="token punctuation">,</span> <span class="token keyword">final</span> SendMessageRequestHeader requestHeader<span class="token punctuation">)</span> <span class="token keyword">throws</span> RemotingCommandException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        String traFlag <span class="token operator">=</span> oriProps<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>MessageConst<span class="token punctuation">.</span>PROPERTY_TRANSACTION_PREPARED<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// äº‹åŠ¡æ¶ˆæ¯</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>traFlag <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> Boolean<span class="token punctuation">.</span><span class="token function">parseBoolean</span><span class="token punctuation">(</span>traFlag<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token comment" spellcheck="true">// åŠæ¶ˆæ¯ï¼ŒæŒä¹…åŒ–PREPAREDæ¶ˆæ¯è¿›CommitLog</span>
            putMessageResult <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getTransactionalMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">prepareMessage</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æŒä¹…åŒ–æ™®é€šæ¶ˆæ¯è¿›CommitLog</span>
            putMessageResult <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getMessageStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putMessage</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// è®¾ç½®å“åº”ç ï¼Œæ‰§è¡ŒHookç­‰</span>
        <span class="token keyword">return</span> <span class="token function">handlePutMessageResult</span><span class="token punctuation">(</span>putMessageResult<span class="token punctuation">,</span> response<span class="token punctuation">,</span> request<span class="token punctuation">,</span> msgInner<span class="token punctuation">,</span> responseHeader<span class="token punctuation">,</span> sendMessageContext<span class="token punctuation">,</span> ctx<span class="token punctuation">,</span> queueIdInt<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span></code></pre>
<p>TransactionalMessageServiceImpl#prepareMessage</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> PutMessageResult <span class="token function">prepareMessage</span><span class="token punctuation">(</span>MessageExtBrokerInner messageInner<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> transactionalMessageBridge<span class="token punctuation">.</span><span class="token function">putHalfMessage</span><span class="token punctuation">(</span>messageInner<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>TransactionalMessageBridge#putHalfMessage</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> PutMessageResult <span class="token function">putHalfMessage</span><span class="token punctuation">(</span>MessageExtBrokerInner messageInner<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ç”ŸæˆåŠæ¶ˆæ¯ï¼Œå¹¶å†™å…¥CommitLog</span>
        <span class="token keyword">return</span> store<span class="token punctuation">.</span><span class="token function">putMessage</span><span class="token punctuation">(</span><span class="token function">parseHalfMessageInner</span><span class="token punctuation">(</span>messageInner<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>TransactionalMessageBridge#parseHalfMessageInner</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> MessageExtBrokerInner <span class="token function">parseHalfMessageInner</span><span class="token punctuation">(</span>MessageExtBrokerInner msgInner<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// å¤‡ä»½åŸTopic</span>
        MessageAccessor<span class="token punctuation">.</span><span class="token function">putProperty</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">,</span> MessageConst<span class="token punctuation">.</span>PROPERTY_REAL_TOPIC<span class="token punctuation">,</span> msgInner<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¤‡ä»½åŸQueueId</span>
        MessageAccessor<span class="token punctuation">.</span><span class="token function">putProperty</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">,</span> MessageConst<span class="token punctuation">.</span>PROPERTY_REAL_QUEUE_ID<span class="token punctuation">,</span> String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// é‡ç½®ç³»ç»Ÿæ ‡è®°ä¸­çš„äº‹åŠ¡æ¶ˆæ¯çŠ¶æ€ä½ï¼Œæ”¹ä¸ºéäº‹åŠ¡æ¶ˆæ¯</span>
        msgInner<span class="token punctuation">.</span><span class="token function">setSysFlag</span><span class="token punctuation">(</span>MessageSysFlag<span class="token punctuation">.</span><span class="token function">resetTransactionValue</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getSysFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> MessageSysFlag<span class="token punctuation">.</span>TRANSACTION_NOT_TYPE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æŠŠPREPAREDæ¶ˆæ¯çš„Topicæ”¹ä¸ºRMQ_SYS_TRANS_HALF_TOPIC</span>
        msgInner<span class="token punctuation">.</span><span class="token function">setTopic</span><span class="token punctuation">(</span>TransactionalMessageUtil<span class="token punctuation">.</span><span class="token function">buildHalfTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è¿™æ ·æ‰€æœ‰çš„PREPAREDäº‹åŠ¡æ¶ˆæ¯éƒ½å‘åˆ°åŒä¸€ä¸ªTopicå’ŒQueueï¼Œå¹¶ä¸”ä¸ä¼šè¢«Consumeræ¶ˆè´¹</span>
        msgInner<span class="token punctuation">.</span><span class="token function">setQueueId</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        msgInner<span class="token punctuation">.</span><span class="token function">setPropertiesString</span><span class="token punctuation">(</span>MessageDecoder<span class="token punctuation">.</span><span class="token function">messageProperties2String</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">.</span><span class="token function">getProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> msgInner<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>EndTransactionProcessor#processRequest</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> RemotingCommand <span class="token function">processRequest</span><span class="token punctuation">(</span>ChannelHandlerContext ctx<span class="token punctuation">,</span> RemotingCommand request<span class="token punctuation">)</span> <span class="token keyword">throws</span> RemotingCommandException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// Slaveä¸æ¥å—äº‹åŠ¡æ¶ˆæ¯</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>BrokerRole<span class="token punctuation">.</span>SLAVE <span class="token operator">==</span> brokerController<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBrokerRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getFromTransactionCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getCommitOrRollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// Producerå‘é€ç»“æŸäº‹åŠ¡è¯·æ±‚æ—¶æœ¬åœ°äº‹åŠ¡çŠ¶æ€å¤„äºå¾…å†³PendingçŠ¶æ€ï¼Œç›´æ¥è¿”å›</span>
                <span class="token keyword">case</span> MessageSysFlag<span class="token punctuation">.</span>TRANSACTION_NOT_TYPE<span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// Producerå‘é€ç»“æŸäº‹åŠ¡è¯·æ±‚æ—¶æœ¬åœ°äº‹åŠ¡çŠ¶æ€å¤„äºCommitçŠ¶æ€ï¼Œå¯ä»¥ç»§ç»­</span>
                <span class="token keyword">case</span> MessageSysFlag<span class="token punctuation">.</span>TRANSACTION_COMMIT_TYPE<span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// Producerå‘é€ç»“æŸäº‹åŠ¡è¯·æ±‚æ—¶æœ¬åœ°äº‹åŠ¡çŠ¶æ€å¤„äºRollbackçŠ¶æ€ï¼Œå¯ä»¥ç»§ç»­</span>
                <span class="token keyword">case</span> MessageSysFlag<span class="token punctuation">.</span>TRANSACTION_ROLLBACK_TYPE<span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">default</span><span class="token operator">:</span>
                    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// åŒä¸Š</span>
        <span class="token punctuation">}</span>

        OperationResult result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OperationResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Produceræäº¤äº‹åŠ¡æ¶ˆæ¯</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>MessageSysFlag<span class="token punctuation">.</span>TRANSACTION_COMMIT_TYPE <span class="token operator">==</span> requestHeader<span class="token punctuation">.</span><span class="token function">getCommitOrRollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ ¹æ®è¯·æ±‚å¤´æºå¸¦çš„åç§»ä»CommitLogè·å–å¯¹åº”çš„PREPAREDæ¶ˆæ¯</span>
            result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getTransactionalMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">commitMessage</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getResponseCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> ResponseCode<span class="token punctuation">.</span>SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æ£€æŸ¥PREPAREDæ¶ˆæ¯</span>
                RemotingCommand res <span class="token operator">=</span> <span class="token function">checkPrepareMessage</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getPrepareMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> ResponseCode<span class="token punctuation">.</span>SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// æ¢å¤åŸæœ¬çš„æ¶ˆæ¯çš„Topicç­‰å±æ€§ï¼Œç»™Consumeræ¶ˆè´¹</span>
                    MessageExtBrokerInner msgInner <span class="token operator">=</span> <span class="token function">endMessageTransaction</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getPrepareMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token comment" spellcheck="true">// å°†æ¢å¤åçš„Preparedæ¶ˆæ¯å†æ¬¡æŒä¹…åŒ–åˆ°CommitLogï¼Œç”Ÿæˆå“åº”ç»“æœè¿”å›</span>
                    RemotingCommand sendResult <span class="token operator">=</span> <span class="token function">sendFinalMessage</span><span class="token punctuation">(</span>msgInner<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>sendResult<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> ResponseCode<span class="token punctuation">.</span>SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">/*
                         * ä¸ºæ¢å¤åçš„Preparedæ¶ˆæ¯ç”ŸæˆOPæ¶ˆæ¯ï¼Œå†™å…¥CommitLog
                         * OPæ¶ˆæ¯çš„æ¶ˆæ¯ä½“å†…å®¹ä¸ºæ¢å¤Topicå’ŒQueueIdçš„Preparedæ¶ˆæ¯åœ¨ConsumeQueueçš„ä½ç½®åç§»ï¼Œå›æŸ¥æ—¶ä¼šæ¶‰åŠåˆ°
                         * OPæ¶ˆæ¯æ ‡è®°è¯¥Preparedæ¶ˆæ¯çš„äº‹åŠ¡å·²ç»“æŸï¼Œå·²ç»Commitæˆ–Rollbackï¼Œå¦‚æœPreparedæ¶ˆæ¯æ²¡æœ‰OPæ¶ˆæ¯ï¼Œè¯´æ˜äº‹åŠ¡çŠ¶æ€è¿˜æœªç¡®å®š
                         */</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getTransactionalMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">deletePrepareMessage</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getPrepareMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">return</span> sendResult<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> res<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å›æ»šäº‹åŠ¡æ¶ˆæ¯</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>MessageSysFlag<span class="token punctuation">.</span>TRANSACTION_ROLLBACK_TYPE <span class="token operator">==</span> requestHeader<span class="token punctuation">.</span><span class="token function">getCommitOrRollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ ¹æ®è¯·æ±‚å¤´æºå¸¦çš„åç§»ä»CommitLogè·å–å¯¹åº”çš„PREPAREDæ¶ˆæ¯</span>
            result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getTransactionalMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rollbackMessage</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getResponseCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> ResponseCode<span class="token punctuation">.</span>SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æ£€æŸ¥PREPAREDæ¶ˆæ¯</span>
                RemotingCommand res <span class="token operator">=</span> <span class="token function">checkPrepareMessage</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getPrepareMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å› ä¸ºPREPAREDæ¶ˆæ¯æœ¬æ¥æ˜¯å¯¹Consumerä¸å¯è§çš„ï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯ä»€ä¹ˆä¹Ÿä¸ç”¨å¹²ï¼Œå› ä¸ºCommitLogæ˜¯é¡ºåºå†™å…¥çš„ï¼Œæ‰€ä»¥åˆ é™¤æ¶ˆæ¯ä¹Ÿæ²¡æœ‰æ„ä¹‰</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> ResponseCode<span class="token punctuation">.</span>SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ä¸ºPREPAREDæ¶ˆæ¯ç”ŸæˆOPæ¶ˆæ¯ï¼Œå†™å…¥CommitLog</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getTransactionalMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">deletePrepareMessage</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getPrepareMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> res<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        response<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getResponseCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setRemark</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getResponseRemark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> response<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>TransactionalMessageServiceImpl#deletePrepareMessage</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">deletePrepareMessage</span><span class="token punctuation">(</span>MessageExt msgExt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// è®¾ç½®OPæ¶ˆæ¯</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>transactionalMessageBridge<span class="token punctuation">.</span><span class="token function">putOpMessage</span><span class="token punctuation">(</span>msgExt<span class="token punctuation">,</span> TransactionalMessageUtil<span class="token punctuation">.</span>REMOVETAG<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>TransactionalMessageBridge#putOpMessage</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">putOpMessage</span><span class="token punctuation">(</span>MessageExt messageExt<span class="token punctuation">,</span> String opType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// åˆ›å»ºMessageQueueï¼Œå’ŒPREPAREDæ¶ˆæ¯ç›¸åŒçš„QueueIdå’ŒTopic</span>
        MessageQueue messageQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageQueue</span><span class="token punctuation">(</span>messageExt<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBrokerName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> messageExt<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>TransactionalMessageUtil<span class="token punctuation">.</span>REMOVETAG<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>opType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//</span>
            <span class="token keyword">return</span> <span class="token function">addRemoveTagInTransactionOp</span><span class="token punctuation">(</span>messageExt<span class="token punctuation">,</span> messageQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>TransactionalMessageBridge#addRemoveTagInTransactionOp</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">addRemoveTagInTransactionOp</span><span class="token punctuation">(</span>MessageExt messageExt<span class="token punctuation">,</span> MessageQueue messageQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// OPæ¶ˆæ¯</span>
        <span class="token comment" spellcheck="true">// Topicä¸ºRMQ_SYS_TRANS_OP_HALF_TOPICï¼Œæ ‡è®°ä¸ºåˆ é™¤ï¼Œæ¶ˆæ¯ä½“ä¸ºæ¢å¤Topicå’ŒQueueIdçš„Preparedæ¶ˆæ¯åœ¨ConsumeQueueçš„ä½ç½®åç§»</span>
        Message message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span>TransactionalMessageUtil<span class="token punctuation">.</span><span class="token function">buildOpTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> TransactionalMessageUtil<span class="token punctuation">.</span>REMOVETAG<span class="token punctuation">,</span> String<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>messageExt<span class="token punctuation">.</span><span class="token function">getQueueOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span>TransactionalMessageUtil<span class="token punctuation">.</span>charset<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å†™å…¥OPæ¶ˆæ¯è¿›CommitLog</span>
        <span class="token function">writeOp</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> messageQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>TransactionalMessageBridge#writeOp</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">writeOp</span><span class="token punctuation">(</span>Message message<span class="token punctuation">,</span> MessageQueue mq<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        MessageQueue opQueue<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æœ¬åœ°ç¼“å­˜å·²ç»æœ‰è¯¥QueueIdå’ŒTopicçš„OpMessageQueue</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>opQueueMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>mq<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            opQueue <span class="token operator">=</span> opQueueMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>mq<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// æ²¡æœ‰</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// åˆ›å»ºä¸€ä¸ªOpMessageQueueï¼ŒTopicä¸ºRMQ_SYS_TRANS_OP_HALF_TOPICï¼ŒBrokerNameå’ŒQueueIdå’Œä¼ å…¥çš„ä¸€æ ·</span>
            opQueue <span class="token operator">=</span> <span class="token function">getOpQueueByHalf</span><span class="token punctuation">(</span>mq<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// åŠ å…¥</span>
            MessageQueue oldQueue <span class="token operator">=</span> opQueueMap<span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span>mq<span class="token punctuation">,</span> opQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// åŒé‡æ£€æŸ¥ï¼Œå·²å­˜åœ¨</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>oldQueue <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ç”¨å·²ç»å­˜åœ¨çš„</span>
                opQueue <span class="token operator">=</span> oldQueue<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// åŠ å…¥æ—¶ä¸å­˜åœ¨</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>opQueue <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å’ŒgetOpQueueByHalfä¸€æ¨¡ä¸€æ ·</span>
            opQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageQueue</span><span class="token punctuation">(</span>TransactionalMessageUtil<span class="token punctuation">.</span><span class="token function">buildOpTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mq<span class="token punctuation">.</span><span class="token function">getBrokerName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mq<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å°†è¯¥OPæ¶ˆæ¯å†™å…¥CommitLog</span>
        <span class="token function">putMessage</span><span class="token punctuation">(</span><span class="token function">makeOpMessageInner</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> opQueue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>TransactionalMessageCheckService#onWaitEnd</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onWaitEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// æ£€æŸ¥è¶…æ—¶ï¼Œé»˜è®¤5ç§’</span>
        <span class="token keyword">long</span> timeout <span class="token operator">=</span> brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTransactionTimeOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æœ€å¤§æ£€æŸ¥æ¬¡æ•°ï¼Œé»˜è®¤15æ¬¡</span>
        <span class="token keyword">int</span> checkMax <span class="token operator">=</span> brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTransactionCheckMax</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ£€æŸ¥</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getTransactionalMessageService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> checkMax<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getTransactionalMessageCheckListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>TransactionalMessageServiceImpl#check</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token keyword">long</span> transactionTimeout<span class="token punctuation">,</span> <span class="token keyword">int</span> transactionCheckMax<span class="token punctuation">,</span> AbstractTransactionalMessageCheckListener listener<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// åŠæ¶ˆæ¯çš„Topicï¼ŒRMQ_SYS_TRANS_HALF_TOPIC</span>
            String topic <span class="token operator">=</span> MixAll<span class="token punctuation">.</span>RMQ_SYS_TRANS_HALF_TOPIC<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è·å–Preparedæ¶ˆæ¯çš„MessageQueueåˆ—è¡¨</span>
            Set<span class="token operator">&lt;</span>MessageQueue<span class="token operator">></span> msgQueues <span class="token operator">=</span> transactionalMessageBridge<span class="token punctuation">.</span><span class="token function">fetchMessageQueues</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>msgQueues <span class="token operator">==</span> null <span class="token operator">||</span> msgQueues<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// éå†Preparedæ¶ˆæ¯çš„MessageQueueï¼Œè²Œä¼¼ç°åœ¨å›ºå®šåªæœ‰ä¸€ä¸ªQueueï¼Ÿ</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>MessageQueue messageQueue <span class="token operator">:</span> msgQueues<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">long</span> startTime <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">/*
                 * ä»æœ¬åœ°ç¼“å­˜è·å–è¯¥Preparedæ¶ˆæ¯çš„MessageQueueæ˜ å°„çš„Opæ¶ˆæ¯çš„MessageQueueï¼Œæ²¡æœ‰å°±åˆ›å»ºå¹¶åŠ å…¥ï¼ŒMessageQueueæ˜¯æœ‰é‡å†™equalsæ–¹æ³•çš„
                 * Preparedæ¶ˆæ¯çš„MessageQueueçš„Topicæ˜¯RMQ_SYS_TRANS_HALF_TOPICï¼ŒOpæ¶ˆæ¯çš„MessageQueueæ˜¯RMQ_SYS_TRANS_OP_HALF_TOPIC
                 * RMQ_SYS_TRANS_HALF_TOPICï¼šPreparedæ¶ˆæ¯çš„Topic
                 * RMQ_SYS_TRANS_OP_HALF_TOPICï¼šBrokeræ”¶åˆ°äº‹åŠ¡æ¶ˆæ¯çš„Commitæˆ–Rollbackè¯·æ±‚åï¼Œå°†æ¶ˆæ¯å­˜å‚¨åœ¨è¯¥Topic
                 */</span>
                MessageQueue opQueue <span class="token operator">=</span> <span class="token function">getOpQueue</span><span class="token punctuation">(</span>messageQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ä»æœ¬åœ°ç¼“å­˜è·å–Preparedé˜Ÿåˆ—çš„å¤„ç†åç§»ï¼Œæ²¡æ‰¾åˆ°å°±ä½¿ç”¨ConsumeQueueé‡Œçš„æœ€å°åç§»æ›¿ä»£</span>
                <span class="token keyword">long</span> halfOffset <span class="token operator">=</span> transactionalMessageBridge<span class="token punctuation">.</span><span class="token function">fetchConsumeOffset</span><span class="token punctuation">(</span>messageQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ä»æœ¬åœ°ç¼“å­˜è·å–Opé˜Ÿåˆ—çš„å¤„ç†åç§»ï¼Œæ²¡æ‰¾åˆ°å°±ä½¿ç”¨ConsumeQueueé‡Œçš„æœ€å°åç§»æ›¿ä»£</span>
                <span class="token keyword">long</span> opOffset <span class="token operator">=</span> transactionalMessageBridge<span class="token punctuation">.</span><span class="token function">fetchConsumeOffset</span><span class="token punctuation">(</span>opQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// éæ³•åç§»ï¼Œè·³è¿‡è¯¥MessageQueue</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>halfOffset <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> opOffset <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                List<span class="token operator">&lt;</span>Long<span class="token operator">></span> doneOpOffset <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                HashMap<span class="token operator">&lt;</span>Long<span class="token punctuation">,</span> Long<span class="token operator">></span> removeMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">/*
                 * æ ¹æ®OPæ¶ˆæ¯çš„é˜Ÿåˆ—å¤„ç†åç§»ä»CommitLogè·å–32æ¡OPæ¶ˆæ¯
                 * å¹¶éå†æ‹‰å–åˆ°çš„OPæ¶ˆæ¯ï¼Œæ ¹æ®æ¶ˆæ¯ä½“è·å–OPæ¶ˆæ¯å¯¹åº”çš„Preparedæ¶ˆæ¯åœ¨é˜Ÿåˆ—çš„åç§»
                 * å†æ ¹æ®ä¼ å…¥çš„Preparedæ¶ˆæ¯çš„é˜Ÿåˆ—å¤„ç†åç§»ï¼Œå¡«å……å·²æ£€æŸ¥çš„OPæ¶ˆæ¯é˜Ÿåˆ—åç§»doneOpOffsetå’Œå¾…ç§»é™¤çš„Preparedæ¶ˆæ¯çš„é˜Ÿåˆ—åç§»æ˜ å°„
                 */</span>
                PullResult pullResult <span class="token operator">=</span> <span class="token function">fillOpRemoveMap</span><span class="token punctuation">(</span>removeMap<span class="token punctuation">,</span> opQueue<span class="token punctuation">,</span> opOffset<span class="token punctuation">,</span> halfOffset<span class="token punctuation">,</span> doneOpOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// åªæœ‰MessageStoreå·²å…³é—­æˆ–ä¸å¯è¯»æ‰è¿”å›Nullï¼Œè·³è¿‡è¯¥MessageQueue</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">==</span> pullResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">int</span> getMessageNullCount <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å½“å‰åŠæ¶ˆæ¯é˜Ÿåˆ—çš„å¤„ç†åç§»ï¼ŒRMQ_SYS_TRANS_HALF_TOPIC@QueueId</span>
                <span class="token keyword">long</span> newOffset <span class="token operator">=</span> halfOffset<span class="token punctuation">;</span>
                <span class="token keyword">long</span> i <span class="token operator">=</span> halfOffset<span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å¤„ç†æ—¶é—´è¶…è¿‡60ç§’</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime <span class="token operator">></span> MAX_PROCESS_TIME_LIMIT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// è¯´æ˜è¯¥Preparedæ¶ˆæ¯å·²ç»Commitæˆ–Rollback</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>removeMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        removeMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// è·³è¿‡ä¸‹é¢çš„æ“ä½œï¼Œä¸å¤„ç†</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// Preparedæ¶ˆæ¯å¯èƒ½ç»“æŸäº†ï¼Œä¹Ÿå¯èƒ½æ²¡æœ‰</span>
                    <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// æ ¹æ®Preparedé˜Ÿåˆ—çš„å¤„ç†åç§»ä»CommitLogè·å–Preparedæ¶ˆæ¯</span>
                        GetResult getResult <span class="token operator">=</span> <span class="token function">getHalfMsg</span><span class="token punctuation">(</span>messageQueue<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        MessageExt msgExt <span class="token operator">=</span> getResult<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// Preparedæ¶ˆæ¯ä¸å­˜åœ¨</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>msgExt <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// é»˜è®¤é‡è¯•ä¸€æ¬¡</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>getMessageNullCount<span class="token operator">++</span> <span class="token operator">></span> MAX_RETRY_COUNT_WHEN_HALF_NULL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token comment" spellcheck="true">// è¶…è¿‡é‡è¯•æ¬¡æ•°ï¼Œç›´æ¥è·³å‡ºï¼Œç»“æŸè¯¥é˜Ÿåˆ—çš„äº‹åŠ¡å›æŸ¥</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            <span class="token comment" spellcheck="true">// æ²¡æœ‰æ–°çš„Preparedæ¶ˆæ¯ï¼Œå¯èƒ½æ˜¯å¤„ç†å®Œäº†</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>getResult<span class="token punctuation">.</span><span class="token function">getPullResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPullStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> PullStatus<span class="token punctuation">.</span>NO_NEW_MSG<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token comment" spellcheck="true">// ç»“æŸè¯¥é˜Ÿåˆ—çš„äº‹åŠ¡å›æŸ¥</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                                <span class="token comment" spellcheck="true">// åç§»éæ³•ï¼Œæ ¹æ®æ ¡æ­£çš„åç§»ï¼Œä¸‹ä¸ªå¾ªç¯é‡æ–°æ‹‰å–</span>
                                i <span class="token operator">=</span> getResult<span class="token punctuation">.</span><span class="token function">getPullResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getNextBeginOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                newOffset <span class="token operator">=</span> i<span class="token punctuation">;</span>
                                <span class="token keyword">continue</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment" spellcheck="true">// è¯¥Preparedæ¶ˆæ¯è¶…è¿‡å›æŸ¥æ¬¡æ•°ï¼Œæ–¹æ³•å†…éƒ¨æœ‰è®¡æ•°ï¼Œéœ€è¦ä¸¢å¼ƒ || å­˜å‚¨æ—¶é—´è¿‡ä¹…ï¼Œéœ€è¦è·³è¿‡</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">needDiscard</span><span class="token punctuation">(</span>msgExt<span class="token punctuation">,</span> transactionCheckMax<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">needSkip</span><span class="token punctuation">(</span>msgExt<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// æŠŠè¯¥Preparedæ¶ˆæ¯Topicè®¾ç½®ä¸ºTRANS_CHECK_MAX_TIME_TOPICï¼Œå†æ¬¡å†™å…¥CommitLog</span>
                            listener<span class="token punctuation">.</span><span class="token function">resolveDiscardMsg</span><span class="token punctuation">(</span>msgExt<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// ä¸‹ä¸ªå¾ªç¯å¤„ç†ä¸‹ä¸€æ¡æ¶ˆæ¯</span>
                            newOffset <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                            i<span class="token operator">++</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// è·³è¿‡è¯¥æ¶ˆæ¯</span>
                            <span class="token keyword">continue</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment" spellcheck="true">// è¯¥Preparedæ¶ˆæ¯å­˜å‚¨æ—¶é—´å¤§äºæœ¬æ¬¡å¤„ç†çš„å¼€å§‹æ—¶é—´ï¼Œè¯´æ˜æ˜¯åœ¨å¤„ç†è¿‡ç¨‹ä¸­æ–°åŠ å…¥çš„æ¶ˆæ¯</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>msgExt<span class="token punctuation">.</span><span class="token function">getStoreTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> startTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// ç»“æŸè¯¥é˜Ÿåˆ—çš„äº‹åŠ¡å›æŸ¥ï¼Œç•™ç»™ä¸‹æ¬¡å†æ£€æŸ¥</span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment" spellcheck="true">// è¯¥Preparedæ¶ˆæ¯å‡ºç”Ÿåç»è¿‡çš„æ—¶é—´ = å½“å‰æ—¶é—´ - æ¶ˆæ¯å‡ºç”Ÿçš„æ—¶é—´æˆ³</span>
                        <span class="token keyword">long</span> valueOfCurrentMinusBorn <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> msgExt<span class="token punctuation">.</span><span class="token function">getBornTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// æ£€æŸ¥è±å…æ—¶é—´ï¼Œå› ä¸ºProducerå‘é€Preparedæ¶ˆæ¯åï¼Œåˆ°å‘é€Commitæˆ–Rollbackæ¶ˆæ¯ç»“æŸäº‹åŠ¡è¿™æ®µæ—¶é—´å†…ï¼Œå°±æ˜¯äº‹åŠ¡çš„è¶…æ—¶æ—¶é—´ï¼Œè¿™æ®µæ—¶é—´ä¸éœ€è¦å›æŸ¥</span>
                        <span class="token keyword">long</span> checkImmunityTime <span class="token operator">=</span> transactionTimeout<span class="token punctuation">;</span>
                        String checkImmunityTimeStr <span class="token operator">=</span> msgExt<span class="token punctuation">.</span><span class="token function">getUserProperty</span><span class="token punctuation">(</span>MessageConst<span class="token punctuation">.</span>PROPERTY_CHECK_IMMUNITY_TIME_IN_SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// å¦‚æœPreparedæ¶ˆæ¯æŒ‡å®šäº†äº‹åŠ¡æ¶ˆæ¯è¿‡æœŸæ—¶é—´çš„å±æ€§</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">!=</span> checkImmunityTimeStr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// æ›´æ–°è±å…æ—¶é—´</span>
                            checkImmunityTime <span class="token operator">=</span> <span class="token function">getImmunityTime</span><span class="token punctuation">(</span>checkImmunityTimeStr<span class="token punctuation">,</span> transactionTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// æ¶ˆæ¯è¿˜æ²¡åˆ°å›æŸ¥çš„æ—¶é—´</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>valueOfCurrentMinusBorn <span class="token operator">&lt;</span> checkImmunityTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token comment" spellcheck="true">// å°†æ¶ˆæ¯é‡æ–°å†™å…¥CommitLog</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">checkPrepareQueueOffset</span><span class="token punctuation">(</span>removeMap<span class="token punctuation">,</span> doneOpOffset<span class="token punctuation">,</span> msgExt<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    <span class="token comment" spellcheck="true">// å¦‚æœå†™å…¥CommitLogæˆåŠŸï¼Œè·³è¿‡è¯¥æ¡Preparedæ¶ˆæ¯</span>
                                    newOffset <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                                    i<span class="token operator">++</span><span class="token punctuation">;</span>
                                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                                <span class="token comment" spellcheck="true">// å¦‚æœå†™å…¥CommitLogä¸æˆåŠŸï¼Œåˆ™ä¸èƒ½è·³è¿‡è¯¥æ¶ˆæ¯</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// Preparedæ¶ˆæ¯æ²¡æŒ‡å®šè¿‡æœŸæ—¶é—´ï¼ŒåŒæ—¶ä¹Ÿæ²¡åˆ°å›æŸ¥çš„æ—¶é—´ï¼Œå¯èƒ½æ˜¯æ–°çš„æ¶ˆæ¯</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">&lt;=</span> valueOfCurrentMinusBorn<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>valueOfCurrentMinusBorn <span class="token operator">&lt;</span> checkImmunityTime<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token comment" spellcheck="true">// ç»“æŸè¯¥é˜Ÿåˆ—çš„äº‹åŠ¡å›æŸ¥ï¼Œç•™ç»™ä¸‹æ¬¡å†æ£€æŸ¥</span>
                                <span class="token comment" spellcheck="true">// å› ä¸ºæ˜¯é¡ºåºå†™å…¥ï¼Œæ‰€ä»¥åé¢çš„æ¶ˆæ¯éƒ½æ˜¯æ›´æ–°çš„æ¶ˆæ¯ï¼Œæˆ–è€…æ˜¯æ”¾å›çš„æ¶ˆæ¯</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment" spellcheck="true">// æœ¬æ¬¡è·å–çš„OPæ¶ˆæ¯åˆ—è¡¨</span>
                        List<span class="token operator">&lt;</span>MessageExt<span class="token operator">></span> opMsg <span class="token operator">=</span> pullResult<span class="token punctuation">.</span><span class="token function">getMsgFoundList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">/*
                         * åˆ¤æ–­æ˜¯å¦éœ€è¦å‘é€äº‹åŠ¡å›æŸ¥æ¶ˆæ¯
                         * å¦‚æœä»OPé˜Ÿåˆ—æ²¡æœ‰æ‹‰å–åˆ°æ¶ˆæ¯ &amp;&amp; Preparedæ¶ˆæ¯å‡ºç”Ÿåå·²ç»è¿‡äº†äº‹åŠ¡è¶…æ—¶ï¼ˆæ²¡æ‹‰å–åˆ°æ–°çš„OPæ¶ˆæ¯è¯´æ˜ç›®å‰å·²æ”¶åˆ°çš„OPæ¶ˆæ¯å·²ç»å¤„ç†å®Œï¼Œè¿˜æ²¡æ‰¾åˆ°å¯¹åº”çš„äº‹åŠ¡ç»“æŸæ¶ˆæ¯ï¼‰
                         * å¦‚æœä»OPé˜Ÿåˆ—æ‹‰å–åˆ°æ¶ˆæ¯ &amp;&amp; æ‹‰å–çš„æœ€åä¸€æ¡OPæ¶ˆæ¯çš„å‡ºç”Ÿæ—¶é—´å’Œæœ¬æ¬¡é˜Ÿåˆ—å¤„ç†çš„å¼€å§‹æ—¶é—´çš„æ—¶é—´å·®å¤§äºäº‹åŠ¡è¶…æ—¶æ—¶é—´ï¼ˆæš‚æ—¶æ²¡çœ‹æ‡‚ï¼‰
                         * å¦‚æœè¯¥Preparedæ¶ˆæ¯çš„ï¼Ÿï¼Œè¿™ä¸ªæ˜¯åœ¨ä»€ä¹ˆæƒ…å†µä¸‹å‘ç”Ÿï¼Ÿ
                         */</span>
                        <span class="token keyword">boolean</span> isNeedCheck <span class="token operator">=</span> <span class="token punctuation">(</span>opMsg <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> valueOfCurrentMinusBorn <span class="token operator">></span> checkImmunityTime<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>opMsg <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>opMsg<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>opMsg<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBornTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime <span class="token operator">></span> transactionTimeout<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>valueOfCurrentMinusBorn <span class="token operator">&lt;=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// å¦‚æœéœ€è¦å‘é€äº‹åŠ¡å›æŸ¥æ¶ˆæ¯</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>isNeedCheck<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// å°†è¯¥Preparedæ¶ˆæ¯é‡æ–°å†™å…¥CommitLog</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">putBackHalfMsgQueue</span><span class="token punctuation">(</span>msgExt<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token comment" spellcheck="true">// å¦‚æœé‡æ–°å†™å…¥ä¸æˆåŠŸï¼Œä¸èƒ½å‘é€å›æŸ¥æ¶ˆæ¯ï¼Œä¸‹ä¸ªå¾ªç¯ç»§ç»­å°è¯•</span>
                                <span class="token keyword">continue</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            <span class="token comment" spellcheck="true">// å¦‚æœé‡æ–°å†™å…¥CommitLogæˆåŠŸ</span>
                            <span class="token comment" spellcheck="true">// æŠŠPreparedæ¶ˆæ¯æ¢å¤åŸæœ¬Topicå’ŒQueueIdï¼Œå¹¶æ ¹æ®ProducerGroupè·å–ä¸€ä¸ªProducer</span>
                            <span class="token comment" spellcheck="true">// å‘é€CHECK_TRANSACTION_STATEçš„å•å‘è¯·æ±‚ç»™Producerå›æŸ¥</span>
                            listener<span class="token punctuation">.</span><span class="token function">resolveHalfMsg</span><span class="token punctuation">(</span>msgExt<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment" spellcheck="true">// ä¸ç¡®å®šæ˜¯å¦éœ€è¦å‘é€å›æŸ¥æ¶ˆæ¯</span>
                        <span class="token keyword">else</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// ç»§ç»­åŠ è½½å32æ¡OPæ¶ˆæ¯</span>
                            pullResult <span class="token operator">=</span> <span class="token function">fillOpRemoveMap</span><span class="token punctuation">(</span>removeMap<span class="token punctuation">,</span> opQueue<span class="token punctuation">,</span> pullResult<span class="token punctuation">.</span><span class="token function">getNextBeginOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> halfOffset<span class="token punctuation">,</span> doneOpOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// ä¸‹ä¸ªå¾ªç¯ç»§ç»­æ£€æŸ¥</span>
                            <span class="token keyword">continue</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// è¯¥Preparedæ¶ˆæ¯å·²ç»ç¡®è®¤äº‹åŠ¡ç»“æŸæˆ–è€…å·²ç»å‘é€å›æŸ¥æ¶ˆæ¯ï¼Œæ›´æ–°åŠæ¶ˆæ¯é˜Ÿåˆ—çš„å¤„ç†åç§»</span>
                    newOffset <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
                    i<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// è¯¥MessageQueueçš„Preparedæ¶ˆæ¯å¾ªç¯å¤„ç†ç»“æŸ</span>
                <span class="token comment" spellcheck="true">// è¯´æ˜å¾ªç¯ä¸­å¤„ç†äº†æ¶ˆæ¯</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>newOffset <span class="token operator">!=</span> halfOffset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// æ›´æ–°Preparedé˜Ÿåˆ—çš„å›æŸ¥å¤„ç†åç§»</span>
                    transactionalMessageBridge<span class="token punctuation">.</span><span class="token function">updateConsumeOffset</span><span class="token punctuation">(</span>messageQueue<span class="token punctuation">,</span> newOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// è®¡ç®—Opé˜Ÿåˆ—çš„å¤„ç†åç§»</span>
                <span class="token keyword">long</span> newOpOffset <span class="token operator">=</span> <span class="token function">calculateOpOffset</span><span class="token punctuation">(</span>doneOpOffset<span class="token punctuation">,</span> opOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>newOpOffset <span class="token operator">!=</span> opOffset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// æ›´æ–°Opé˜Ÿåˆ—çš„å¤„ç†åç§»</span>
                    transactionalMessageBridge<span class="token punctuation">.</span><span class="token function">updateConsumeOffset</span><span class="token punctuation">(</span>opQueue<span class="token punctuation">,</span> newOpOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span></code></pre>
<p>TransactionalMessageServiceImpl#fillOpRemoveMap</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> PullResult <span class="token function">fillOpRemoveMap</span><span class="token punctuation">(</span>HashMap<span class="token operator">&lt;</span>Long<span class="token punctuation">,</span> Long<span class="token operator">></span> removeMap<span class="token punctuation">,</span> MessageQueue opQueue<span class="token punctuation">,</span> <span class="token keyword">long</span> pullOffsetOfOp<span class="token punctuation">,</span> <span class="token keyword">long</span> miniOffset<span class="token punctuation">,</span> List<span class="token operator">&lt;</span>Long<span class="token operator">></span> doneOpOffset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// æ ¹æ®OPæ¶ˆæ¯çš„é˜Ÿåˆ—åç§»ä»CommitLogè·å–32æ¡OPæ¶ˆæ¯</span>
        <span class="token comment" spellcheck="true">// è¿™é‡Œçš„æ¶ˆè´¹æ˜¯æŒ‡äº‹åŠ¡å¤„ç†ï¼Œå› ä¸ºæ¶ˆæ¯æ²¡æœ‰Consumerï¼Œæˆ–è€…è¯´Brokeræ‰æ˜¯Consumer</span>
        PullResult pullResult <span class="token operator">=</span> <span class="token function">pullOpMsg</span><span class="token punctuation">(</span>opQueue<span class="token punctuation">,</span> pullOffsetOfOp<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// åªæœ‰MessageStoreå·²å…³é—­æˆ–ä¸å¯è¯»æ‰è¿”å›Null</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">==</span> pullResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// éå†æ‹‰å–åˆ°çš„OPæ¶ˆæ¯</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>MessageExt opMessageExt <span class="token operator">:</span> opMsg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ä»OPæ¶ˆæ¯çš„æ¶ˆæ¯ä½“è·å–å¯¹åº”çš„Preparedæ¶ˆæ¯åœ¨ConsumeQueueçš„ä½ç½®åç§»</span>
            Long queueOffset <span class="token operator">=</span> <span class="token function">getLong</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>opMessageExt<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> TransactionalMessageUtil<span class="token punctuation">.</span>charset<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>TransactionalMessageUtil<span class="token punctuation">.</span>REMOVETAG<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>opMessageExt<span class="token punctuation">.</span><span class="token function">getTags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å¦‚æœè¯¥Preparedæ¶ˆæ¯åœ¨é˜Ÿåˆ—çš„åç§»å°äºå½“å‰å·²å¤„ç†çš„Preparedæ¶ˆæ¯åœ¨é˜Ÿåˆ—çš„åç§»</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>queueOffset <span class="token operator">&lt;</span> miniOffset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// è¯´æ˜å½“å‰OPæ¶ˆæ¯å·²å¤„ç†/æ£€æŸ¥ï¼ŒæŠŠé˜Ÿåˆ—åç§»åŠ å…¥</span>
                    doneOpOffset<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>opMessageExt<span class="token punctuation">.</span><span class="token function">getQueueOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// è¯´æ˜Preparedæ¶ˆæ¯å¾…ç§»é™¤</span>
                    <span class="token comment" spellcheck="true">// Preparedæ¶ˆæ¯åœ¨é˜Ÿåˆ—çš„åç§» - å¯¹åº”çš„OPæ¶ˆæ¯åœ¨é˜Ÿåˆ—çš„åç§»</span>
                    removeMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>queueOffset<span class="token punctuation">,</span> opMessageExt<span class="token punctuation">.</span><span class="token function">getQueueOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> pullResult<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>TransactionalMessageServiceImpl#checkPrepareQueueOffset</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">checkPrepareQueueOffset</span><span class="token punctuation">(</span>HashMap<span class="token operator">&lt;</span>Long<span class="token punctuation">,</span> Long<span class="token operator">></span> removeMap<span class="token punctuation">,</span> List<span class="token operator">&lt;</span>Long<span class="token operator">></span> doneOpOffset<span class="token punctuation">,</span> MessageExt msgExt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        String prepareQueueOffsetStr <span class="token operator">=</span> msgExt<span class="token punctuation">.</span><span class="token function">getUserProperty</span><span class="token punctuation">(</span>MessageConst<span class="token punctuation">.</span>PROPERTY_TRANSACTION_PREPARED_QUEUE_OFFSET<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è¿™ä¸ªå±æ€§ï¼Œåªæœ‰putImmunityMsgBackToHalfQueueå°†æ¶ˆæ¯é‡æ–°å†™å…¥CommitLogåæ‰æœ‰</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">==</span> prepareQueueOffsetStr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å°†æ¶ˆæ¯é‡æ–°å†™å…¥CommitLogï¼Œè¿”å›æ˜¯å¦å†™å…¥æˆåŠŸ</span>
            <span class="token comment" spellcheck="true">// è¿™é‡Œä¼šè®¾ç½®é‡å†™æ¶ˆæ¯çš„TRAN_PREPARED_QUEUE_OFFSETå±æ€§ä¸ºåŸæœ¬çš„Preparedæ¶ˆæ¯åœ¨é˜Ÿåˆ—çš„åç§»</span>
            <span class="token comment" spellcheck="true">// æ‰€ä»¥æ— è®ºæ¶ˆæ¯é‡æ–°å†™å…¥å¤šå°‘æ¬¡ï¼Œè¿™ä¸ªå±æ€§å€¼éƒ½æ˜¯æœ€åˆçš„æ¶ˆæ¯çš„é˜Ÿåˆ—åç§»</span>
            <span class="token keyword">return</span> <span class="token function">putImmunityMsgBackToHalfQueue</span><span class="token punctuation">(</span>msgExt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// æ¶ˆæ¯æ˜¯é‡æ–°å†™å…¥CommitLogçš„æ¶ˆæ¯</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è·å–æœ€åˆçš„æ¶ˆæ¯åœ¨é˜Ÿåˆ—çš„åç§»</span>
            <span class="token keyword">long</span> prepareQueueOffset <span class="token operator">=</span> <span class="token function">getLong</span><span class="token punctuation">(</span>prepareQueueOffsetStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">==</span> prepareQueueOffset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// è¯´æ˜æœ€åˆçš„Preparedæ¶ˆæ¯å·²ç»æ”¶åˆ°OPæ¶ˆæ¯ï¼Œäº‹åŠ¡å·²ç»ç»“æŸ</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>removeMap<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>prepareQueueOffset<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">long</span> tmpOpOffset <span class="token operator">=</span> removeMap<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>prepareQueueOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    doneOpOffset<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>tmpOpOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// ä¸éœ€è¦å†å›æŸ¥</span>
                    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// ä¸çŸ¥é“äº‹åŠ¡æœ‰æ²¡æœ‰ç»“æŸ</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å°†æ¶ˆæ¯é‡æ–°å†™å…¥CommitLogï¼Œè¿”å›æ˜¯å¦å†™å…¥æˆåŠŸ</span>
                    <span class="token keyword">return</span> <span class="token function">putImmunityMsgBackToHalfQueue</span><span class="token punctuation">(</span>msgExt<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>TransactionalMessageServiceImpl#putBackHalfMsgQueue</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">putBackHalfMsgQueue</span><span class="token punctuation">(</span>MessageExt msgExt<span class="token punctuation">,</span> <span class="token keyword">long</span> offset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// å°†è¯¥åŠæ¶ˆæ¯é‡æ–°å†™å…¥CommitLog</span>
        PutMessageResult putMessageResult <span class="token operator">=</span> <span class="token function">putBackToHalfQueueReturnResult</span><span class="token punctuation">(</span>msgExt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>putMessageResult <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> putMessageResult<span class="token punctuation">.</span><span class="token function">getPutMessageStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> PutMessageStatus<span class="token punctuation">.</span>PUT_OK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">/*
             * å°†é‡æ–°å†™å…¥çš„Preparedæ¶ˆæ¯çš„QueueOffsetã€CommitLogOffsetè®¾ç½®ä¸ºé‡æ–°å­˜å…¥çš„åç§»ï¼Œåé¢ä¼šå‘ç»™Producerå›æŸ¥
             * åªè¦æ¶ˆæ¯é‡æ–°å†™å…¥CommitLogæˆåŠŸï¼Œåé¢å°±ä¼šå‘é€å›æŸ¥æ¶ˆæ¯ï¼Œåªè¦å‘é€äº†å›æŸ¥æ¶ˆæ¯ï¼Œè¿›åº¦å°±ä¼šå‘å‰
             * å¦‚æœå›æŸ¥å¤±è´¥ï¼Œå¯ä»¥é€šè¿‡æ”¾å›çš„Preparedæ¶ˆæ¯å†æ¬¡å‘é€å›æŸ¥æ¶ˆæ¯
             * å¦‚æœå›æŸ¥æˆåŠŸï¼Œå¯ä»¥é€šè¿‡Opé˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯åˆ¤æ–­æ˜¯å¦å·²ç»ç¡®è®¤
             */</span>
            msgExt<span class="token punctuation">.</span><span class="token function">setQueueOffset</span><span class="token punctuation">(</span>putMessageResult<span class="token punctuation">.</span><span class="token function">getAppendMessageResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLogicsOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            msgExt<span class="token punctuation">.</span><span class="token function">setCommitLogOffset</span><span class="token punctuation">(</span>putMessageResult<span class="token punctuation">.</span><span class="token function">getAppendMessageResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getWroteOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            msgExt<span class="token punctuation">.</span><span class="token function">setMsgId</span><span class="token punctuation">(</span>putMessageResult<span class="token punctuation">.</span><span class="token function">getAppendMessageResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMsgId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>TransactionalMessageServiceImpl#calculateOpOffset</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">long</span> <span class="token function">calculateOpOffset</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>Long<span class="token operator">></span> doneOffset<span class="token punctuation">,</span> <span class="token keyword">long</span> oldOffset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Collections<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>doneOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ä¸Šæ¬¡æ›´æ–°çš„Opé˜Ÿåˆ—çš„å¤„ç†åç§»</span>
        <span class="token keyword">long</span> newOffset <span class="token operator">=</span> oldOffset<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// éå†å·²ç»å¤„ç†çš„Opæ¶ˆæ¯çš„é˜Ÿåˆ—åç§»</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> doneOffset<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>doneOffset<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">==</span> newOffset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å¯ä»¥å¤„ç†ä¸‹ä¸€ä¸ª</span>
                newOffset<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> newOffset<span class="token punctuation">;</span>

    <span class="token punctuation">}</span></code></pre>
<hr>
<p>MQClientAPIImpl</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token function">MQClientAPIImpl</span><span class="token punctuation">(</span><span class="token keyword">final</span> NettyClientConfig nettyClientConfig<span class="token punctuation">,</span> <span class="token keyword">final</span> ClientRemotingProcessor clientRemotingProcessor<span class="token punctuation">,</span> RPCHook rpcHook<span class="token punctuation">,</span> <span class="token keyword">final</span> ClientConfig clientConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>clientConfig <span class="token operator">=</span> clientConfig<span class="token punctuation">;</span>
        topAddressing <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TopAddressing</span><span class="token punctuation">(</span>MixAll<span class="token punctuation">.</span><span class="token function">getWSAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> clientConfig<span class="token punctuation">.</span><span class="token function">getUnitName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>remotingClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NettyRemotingClient</span><span class="token punctuation">(</span>nettyClientConfig<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>clientRemotingProcessor <span class="token operator">=</span> clientRemotingProcessor<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>remotingClient<span class="token punctuation">.</span><span class="token function">registerRPCHook</span><span class="token punctuation">(</span>rpcHook<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// äº‹åŠ¡æ£€æŸ¥å¤„ç†å™¨</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>remotingClient<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>CHECK_TRANSACTION_STATE<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clientRemotingProcessor<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>remotingClient<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>NOTIFY_CONSUMER_IDS_CHANGED<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clientRemotingProcessor<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>remotingClient<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>RESET_CONSUMER_CLIENT_OFFSET<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clientRemotingProcessor<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>remotingClient<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>GET_CONSUMER_STATUS_FROM_CLIENT<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clientRemotingProcessor<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>remotingClient<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>GET_CONSUMER_RUNNING_INFO<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clientRemotingProcessor<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>remotingClient<span class="token punctuation">.</span><span class="token function">registerProcessor</span><span class="token punctuation">(</span>RequestCode<span class="token punctuation">.</span>CONSUME_MESSAGE_DIRECTLY<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clientRemotingProcessor<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ClientRemotingProcessor#checkTransactionState</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> RemotingCommand <span class="token function">checkTransactionState</span><span class="token punctuation">(</span>ChannelHandlerContext ctx<span class="token punctuation">,</span> RemotingCommand request<span class="token punctuation">)</span> <span class="token keyword">throws</span> RemotingCommandException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>messageExt <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>group <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æ ¹æ®ProducerGroupè·å–Producer</span>
                MQProducerInner producer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mqClientFactory<span class="token punctuation">.</span><span class="token function">selectProducer</span><span class="token punctuation">(</span>group<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>producer <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> String addr <span class="token operator">=</span> RemotingHelper<span class="token punctuation">.</span><span class="token function">parseChannelRemoteAddr</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// æ£€æµ‹äº‹åŠ¡çŠ¶æ€</span>
                    producer<span class="token punctuation">.</span><span class="token function">checkTransactionState</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> messageExt<span class="token punctuation">,</span> requestHeader<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>DefaultMQProducerImpl#checkTransactionState</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">checkTransactionState</span><span class="token punctuation">(</span><span class="token keyword">final</span> String addr<span class="token punctuation">,</span> <span class="token keyword">final</span> MessageExt msg<span class="token punctuation">,</span> <span class="token keyword">final</span> CheckTransactionStateRequestHeader header<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// æ–°å»ºä¸€ä¸ªä»»åŠ¡</span>
        Runnable request <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å·²åºŸå¼ƒ</span>
                TransactionCheckListener transactionCheckListener <span class="token operator">=</span> DefaultMQProducerImpl<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å…ˆè·å–äº‹åŠ¡ç›‘å¬å™¨</span>
                TransactionListener transactionListener <span class="token operator">=</span> <span class="token function">getCheckListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>transactionCheckListener <span class="token operator">!=</span> null <span class="token operator">||</span> transactionListener <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>transactionCheckListener <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            localTransactionState <span class="token operator">=</span> transactionCheckListener<span class="token punctuation">.</span><span class="token function">checkLocalTransactionState</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>transactionListener <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// æ‰§è¡Œæœ¬åœ°äº‹åŠ¡æ£€æŸ¥</span>
                            localTransactionState <span class="token operator">=</span> transactionListener<span class="token punctuation">.</span><span class="token function">checkLocalTransaction</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// å‘é€END_TRANSACTIONçš„å•å‘è¯·æ±‚ç»™Broker</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">processTransactionState</span><span class="token punctuation">(</span>localTransactionState<span class="token punctuation">,</span> group<span class="token punctuation">,</span> exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processTransactionState</span><span class="token punctuation">(</span><span class="token keyword">final</span> LocalTransactionState localTransactionState<span class="token punctuation">,</span> <span class="token keyword">final</span> String producerGroup<span class="token punctuation">,</span> <span class="token keyword">final</span> Throwable exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
                <span class="token keyword">switch</span> <span class="token punctuation">(</span>localTransactionState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                String remark <span class="token operator">=</span> null<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>exception <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    DefaultMQProducerImpl<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">.</span><span class="token function">getMQClientAPIImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">endTransactionOneway</span><span class="token punctuation">(</span>brokerAddr<span class="token punctuation">,</span> thisHeader<span class="token punctuation">,</span> remark<span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æäº¤ç»™äº‹åŠ¡å›æŸ¥çº¿ç¨‹æ± æ‰§è¡Œ</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>checkExecutor<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


        <footer>
             
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

        </footer>
    </div>
    <!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
    <script>
        var timeEnd = new Date();
        console.log('è€—æ—¶ï¼š' + (timeEnd - timeStart));
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre').forEach((block) => {
                block.classList.add("line-numbers");
            });
        });
    </script>
    <!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
    <!-- material design -->
    <!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
    <!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
    <!-- toc -->
    <!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
    <!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
    <!-- <script src="/js/main.js"></script> -->
    <script src="/js/prism.js"></script>
</body>
</html>
