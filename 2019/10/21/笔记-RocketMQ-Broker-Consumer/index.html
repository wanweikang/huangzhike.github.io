<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
        <script>
            var timeStart = new Date();
        </script>
        
        <title>[ç¬”è®°]-RocketMQ-Broker-Consumer | ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜</title>
        
        <meta name="author" content="huangzhike">
        
        
        <meta name="description" content="è¿™ä¸ªæ–¹æ³•ä¸‰ç™¾å¤šè¡Œï¼Œåº”è¯¥æ‹†åˆ†çš„ã€‚
PullMessageProcessor#processRequest
    private RemotingCommand processRequest(final Channel channel, RemotingCommand request, boolean">
        
        
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        
        <meta property="og:title" content="[ç¬”è®°]-RocketMQ-Broker-Consumer"/>
        
        <meta property="og:site_name" content="ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜"/>
        
        
        <!-- favicon -->
        <link rel="icon" type="image/ico" href="/ok.ico" sizes="32x32">
        <meta name="msapplication-TileColor" content="#009688">
        <meta name="msapplication-TileImage" content="/mstile-144x144.ico">
        <meta name="theme-color" content="#009688">
        <!-- favicon end -->
        <!-- <link href="//ok.ico" rel="icon"> -->
        
        <!-- toc -->
        <!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
        <!-- material design -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
        <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
        
        <!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
        <!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
    <meta name="generator" content="Hexo 4.2.1"></head>

<body>
    <nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">èœå•</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" title="ä¸‹ä¸€å¥æ˜¯ï¼šå®¢æœ‰å¯äººæœŸä¸æ¥ã€‚å°æ—¶å€™ï¼Œå–œæ¬¢é åœ¨é˜³å°ä¸Šï¼Œä¸€è¾¹å¹é£ï¼Œä¸€è¾¹çœ‹ä¹¦ï¼Œå–œæ¬¢è¯»ä¹¦å—ï¼Œéªšå¹´ï¼Ÿ" href="/">ä¹¦å½“å¿«æ„è¯»æ˜“å°½</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" target="_blank" rel="noopener" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

    <div class="container" >
        <div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[ç¬”è®°]-RocketMQ-Broker-Consumer</h2>
				
				<div>
					<div class="post-time">2019-10-21</div>
				</div>
				
				<div class="article-content">
				<p>è¿™ä¸ªæ–¹æ³•ä¸‰ç™¾å¤šè¡Œï¼Œåº”è¯¥æ‹†åˆ†çš„ã€‚</p>
<p>PullMessageProcessor#processRequest</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> RemotingCommand <span class="token function">processRequest</span><span class="token punctuation">(</span><span class="token keyword">final</span> Channel channel<span class="token punctuation">,</span> RemotingCommand request<span class="token punctuation">,</span> <span class="token keyword">boolean</span> brokerAllowSuspend<span class="token punctuation">)</span> <span class="token keyword">throws</span> RemotingCommandException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token comment" spellcheck="true">// Brokerä¸å¯è¯»</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>PermName<span class="token punctuation">.</span><span class="token function">isReadable</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBrokerPermission</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è¿”å›</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ä»æœ¬åœ°ç¼“å­˜è·å–è¯¥ConsumerGroupçš„SubscriptionGroupConfigï¼Œå¦‚æœæ²¡æœ‰å¹¶ä¸”å¼€å¯äº†è‡ªåŠ¨åˆ›å»ºï¼Œåˆ™è‡ªåŠ¨åˆ›å»ºSubscriptionGroupConfigå¹¶åŠ å…¥ç¼“å­˜è¿”å›</span>
        SubscriptionGroupConfig subscriptionGroupConfig <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getSubscriptionGroupManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findSubscriptionGroupConfig</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ConsumerGroupçš„SubscriptionGroupConfigä¸å­˜åœ¨</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">==</span> subscriptionGroupConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è¿”å›</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// SubscriptionGroupConfigä¸å…è®¸æ¶ˆè´¹</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>subscriptionGroupConfig<span class="token punctuation">.</span><span class="token function">isConsumeEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è¿”å›</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> hasSuspendFlag <span class="token operator">=</span> PullSysFlag<span class="token punctuation">.</span><span class="token function">hasSuspendFlag</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getSysFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> hasCommitOffsetFlag <span class="token operator">=</span> PullSysFlag<span class="token punctuation">.</span><span class="token function">hasCommitOffsetFlag</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getSysFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span> hasSubscriptionFlag <span class="token operator">=</span> PullSysFlag<span class="token punctuation">.</span><span class="token function">hasSubscriptionFlag</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getSysFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> suspendTimeoutMillisLong <span class="token operator">=</span> hasSuspendFlag <span class="token operator">?</span> requestHeader<span class="token punctuation">.</span><span class="token function">getSuspendTimeoutMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ ¹æ®Topicä»æœ¬åœ°ç¼“å­˜è·å–TopicConfig</span>
        TopicConfig topicConfig <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getTopicConfigManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">selectTopicConfig</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// TopicConfigä¸å­˜åœ¨</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">==</span> topicConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è¿”å›</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// Topicä¸å¯è¯»</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>PermName<span class="token punctuation">.</span><span class="token function">isReadable</span><span class="token punctuation">(</span>topicConfig<span class="token punctuation">.</span><span class="token function">getPerm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è¿”å›</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// QueueIdä¸åˆæ³•ï¼Œä¸èƒ½å°äº0æˆ–è€…å¤§äºé…ç½®çš„è¯»é˜Ÿåˆ—æ•°é‡</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> requestHeader<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> topicConfig<span class="token punctuation">.</span><span class="token function">getReadQueueNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ•°é‡</span>
        <span class="token punctuation">}</span>
        SubscriptionData subscriptionData <span class="token operator">=</span> null<span class="token punctuation">;</span>
        ConsumerFilterData consumerFilterData <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æœ‰è®¢é˜…æ ‡è®°ï¼Œå¯èƒ½æ˜¯ç¬¬ä¸€æ¬¡Pull</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hasSubscriptionFlag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// åˆ›å»ºTopicçš„SubscriptionData</span>
                subscriptionData <span class="token operator">=</span> FilterAPI<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getSubscription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getExpressionType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// æ˜¯å¦ä½¿ç”¨äº†è¡¨è¾¾å¼è¿‡æ»¤</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ExpressionType<span class="token punctuation">.</span><span class="token function">isTagType</span><span class="token punctuation">(</span>subscriptionData<span class="token punctuation">.</span><span class="token function">getExpressionType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// è¿”å›</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ä¹‹å‰å·²è®¢é˜…</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ä»æœ¬åœ°ç¼“å­˜è·å–ConsumerGroupçš„ConsumerGroupInfo</span>
            ConsumerGroupInfo consumerGroupInfo <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getConsumerManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConsumerGroupInfo</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ConsumerGroupInfoä¸å­˜åœ¨</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">==</span> consumerGroupInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// è¿”å›</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// SubscriptionGroupConfigä¸å…è®¸å¹¿æ’­æ¶ˆè´¹ &amp;&amp; ConsumerGroupInfoçš„æ¶ˆè´¹æ¨¡å¼æ˜¯å¹¿æ’­æ¨¡å¼</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>subscriptionGroupConfig<span class="token punctuation">.</span><span class="token function">isConsumeBroadcastEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> consumerGroupInfo<span class="token punctuation">.</span><span class="token function">getMessageModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> MessageModel<span class="token punctuation">.</span>BROADCASTING<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// è¿”å›</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ä»æœ¬åœ°ç¼“å­˜è·å–Topicçš„SubscriptionData</span>
            subscriptionData <span class="token operator">=</span> consumerGroupInfo<span class="token punctuation">.</span><span class="token function">findSubscriptionData</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// SubscriptionDataä¸å­˜åœ¨</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">==</span> subscriptionData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// è¿”å›</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// PullRequestçš„Versionå’ŒSubscriptionDataçš„Versionä¸ä¸€è‡´</span>
            <span class="token comment" spellcheck="true">// ä¸€ä¸ªConsumerGroupä¸‹çš„å¤šä¸ªConsumerï¼Œè®¢é˜…å‚æ•°å¿…é¡»ä¸€è‡´ï¼Œæ¯”å¦‚é‡‡ç”¨é›†ç¾¤æ¨¡å¼æ¶ˆè´¹ï¼Œå¦‚æœä¸¤ä¸ªConsumerè®¾ç½®çš„æ¶ˆæ¯è¿‡æ»¤æ¡ä»¶ä¸ä¸€æ ·ï¼Œé‚£ä¹ˆæ¶ˆæ¯å°±æ— æ³•è¢«æ¶ˆè´¹</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>subscriptionData<span class="token punctuation">.</span><span class="token function">getSubVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> requestHeader<span class="token punctuation">.</span><span class="token function">getSubVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// è¿”å›</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// è¡¨è¾¾å¼ç±»å‹æœ‰TAGã€SQL92ä¸¤ç§ï¼Œå¦‚æœä¸æ˜¯TAGç±»å‹</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ExpressionType<span class="token punctuation">.</span><span class="token function">isTagType</span><span class="token punctuation">(</span>subscriptionData<span class="token punctuation">.</span><span class="token function">getExpressionType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                consumerFilterData <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getConsumerFilterManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>consumerFilterData <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// è¿”å›</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>consumerFilterData<span class="token punctuation">.</span><span class="token function">getClientVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> requestHeader<span class="token punctuation">.</span><span class="token function">getSubVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// è¿”å›</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// è¡¨è¾¾å¼ç±»å‹ä¸æ˜¯TAGç±»å‹ &amp;&amp; Brokerä¸å…è®¸PropertyFilter</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ExpressionType<span class="token punctuation">.</span><span class="token function">isTagType</span><span class="token punctuation">(</span>subscriptionData<span class="token punctuation">.</span><span class="token function">getExpressionType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEnablePropertyFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è¿”å›</span>
        <span class="token punctuation">}</span>
        MessageFilter messageFilter<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¦‚æœè¿‡æ»¤%RETRY%æ¶ˆæ¯</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isFilterSupportRetry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            messageFilter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ExpressionForRetryMessageFilter</span><span class="token punctuation">(</span>subscriptionData<span class="token punctuation">,</span> consumerFilterData<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getConsumerFilterManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// é»˜è®¤ä¸è¿‡æ»¤</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            messageFilter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ExpressionMessageFilter</span><span class="token punctuation">(</span>subscriptionData<span class="token punctuation">,</span> consumerFilterData<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getConsumerFilterManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å§”æ‰˜ç»™MessageStoreè¯»å–æ¶ˆæ¯</span>
        <span class="token keyword">final</span> GetMessageResult getMessageResult <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getMessageStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getQueueOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getMaxMsgNums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> messageFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>getMessageResult <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            response<span class="token punctuation">.</span><span class="token function">setRemark</span><span class="token punctuation">(</span>getMessageResult<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å›å¤ä¸‹æ¬¡æ‹‰å–çš„èµ·å§‹åç§»</span>
            responseHeader<span class="token punctuation">.</span><span class="token function">setNextBeginOffset</span><span class="token punctuation">(</span>getMessageResult<span class="token punctuation">.</span><span class="token function">getNextBeginOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            responseHeader<span class="token punctuation">.</span><span class="token function">setMinOffset</span><span class="token punctuation">(</span>getMessageResult<span class="token punctuation">.</span><span class="token function">getMinOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            responseHeader<span class="token punctuation">.</span><span class="token function">setMaxOffset</span><span class="token punctuation">(</span>getMessageResult<span class="token punctuation">.</span><span class="token function">getMaxOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å¦‚æœGetMessageResultå»ºè®®ä¸‹æ¬¡ä»Slaveæ‹‰å–æ¶ˆæ¯</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>getMessageResult<span class="token punctuation">.</span><span class="token function">isSuggestPullingFromSlave</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æ¨èä¸€ä¸ªSlave</span>
                responseHeader<span class="token punctuation">.</span><span class="token function">setSuggestWhichBrokerId</span><span class="token punctuation">(</span>subscriptionGroupConfig<span class="token punctuation">.</span><span class="token function">getWhichBrokerWhenConsumeSlowly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// é»˜è®¤è¿˜æ˜¯Master</span>
                responseHeader<span class="token punctuation">.</span><span class="token function">setSuggestWhichBrokerId</span><span class="token punctuation">(</span>MixAll<span class="token punctuation">.</span>MASTER_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBrokerRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> ASYNC_MASTER<span class="token operator">:</span>
                <span class="token keyword">case</span> SYNC_MASTER<span class="token operator">:</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å½“å‰Brokeræ˜¯Slave</span>
                <span class="token keyword">case</span> SLAVE<span class="token operator">:</span>
                    <span class="token comment" spellcheck="true">// å½“å‰Brokerä¸æ”¯æŒè¯»</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isSlaveReadEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        response<span class="token punctuation">.</span><span class="token function">setCode</span><span class="token punctuation">(</span>ResponseCode<span class="token punctuation">.</span>PULL_RETRY_IMMEDIATELY<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// æ¨èä»Masterè¯»</span>
                        responseHeader<span class="token punctuation">.</span><span class="token function">setSuggestWhichBrokerId</span><span class="token punctuation">(</span>MixAll<span class="token punctuation">.</span>MASTER_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å¦‚æœå…è®¸ä»Slaveæ‹‰å–æ¶ˆæ¯ï¼Œé»˜è®¤ä¸å…è®¸</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isSlaveReadEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å¦‚æœGetMessageResultå»ºè®®ä¸‹æ¬¡ä»Slaveæ‹‰å–æ¶ˆæ¯ï¼Œå¯èƒ½æ˜¯å› ä¸ºæ¶ˆè´¹å¤ªæ…¢</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>getMessageResult<span class="token punctuation">.</span><span class="token function">isSuggestPullingFromSlave</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// æ¨èä¸€ä¸ªSlave</span>
                    responseHeader<span class="token punctuation">.</span><span class="token function">setSuggestWhichBrokerId</span><span class="token punctuation">(</span>subscriptionGroupConfig<span class="token punctuation">.</span><span class="token function">getWhichBrokerWhenConsumeSlowly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// æ¶ˆè´¹æ­£å¸¸</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    responseHeader<span class="token punctuation">.</span><span class="token function">setSuggestWhichBrokerId</span><span class="token punctuation">(</span>subscriptionGroupConfig<span class="token punctuation">.</span><span class="token function">getBrokerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                responseHeader<span class="token punctuation">.</span><span class="token function">setSuggestWhichBrokerId</span><span class="token punctuation">(</span>MixAll<span class="token punctuation">.</span>MASTER_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>getMessageResult<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å›è°ƒHook</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hasConsumeMessageHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æˆåŠŸ</span>
                <span class="token keyword">case</span> ResponseCode<span class="token punctuation">.</span>SUCCESS<span class="token operator">:</span>
                    <span class="token comment" spellcheck="true">// æ›´æ–°ç»Ÿè®¡æ•°æ®</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token comment" spellcheck="true">// é»˜è®¤</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isTransferMsgByHeap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">final</span> <span class="token keyword">long</span> beginTimeMills <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getMessageStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// å°†æ¶ˆæ¯å­—èŠ‚ä»MappedFileçš„ç¼“å†²å¤åˆ¶åˆ°æ–°çš„ç¼“å†²æ•°ç»„å¹¶è¿”å›ï¼Œé‡Šæ”¾MappedFileçš„ç¼“å†²è®¡æ•°</span>
                        <span class="token comment" spellcheck="true">// MappedFileå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªå¼•ç”¨è®¡æ•°ï¼Œä¼°è®¡æ˜¯ç”¨äºæ¸…é™¤è¿‡æœŸèµ„æºæ—¶ç”¨çš„ï¼Œå¦‚æœMappedFileè¢«å¼•ç”¨ï¼Œåˆ™ä¸èƒ½è¢«æ¸…é™¤</span>
                        <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> r <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">readGetMessageResult</span><span class="token punctuation">(</span>getMessageResult<span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerStatsManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">incGroupGetLatency</span><span class="token punctuation">(</span>requestHeader<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getMessageStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> beginTimeMills<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// è®¾ç½®æ¶ˆæ¯åˆ—è¡¨å­—èŠ‚</span>
                        response<span class="token punctuation">.</span><span class="token function">setBody</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// ç›´æ¥è¯»å–å†…å­˜æ˜ å°„æ–‡ä»¶ï¼Œç”¨Nettyå°è£…çš„FileRegion</span>
                    <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// æ²¡æœ‰è¯»å–åˆ°æ¶ˆæ¯</span>
                <span class="token keyword">case</span> ResponseCode<span class="token punctuation">.</span>PULL_NOT_FOUND<span class="token operator">:</span>
                    <span class="token comment" spellcheck="true">// Brokerå…è®¸ä¸­æ–­ï¼Œä¸€èˆ¬å…è®¸ &amp;&amp; æ‹‰å–è¯·æ±‚ä¸­åŒ…å«ä¸­æ–­æ ‡è®°</span>
                    <span class="token comment" spellcheck="true">// ä¸å…è®¸ä¸­æ–­çš„æƒ…å†µæ˜¯æ”¶åˆ°Consumerå‘é€çš„æ‹‰å–è¯·æ±‚è¯·æ±‚åæ²¡è¯»å–åˆ°æ¶ˆæ¯ï¼Œç”ŸæˆPullRequestï¼Œç”±PullRequestHoldServiceé‡æ–°æäº¤å†æ¬¡æ‰§è¡Œæ‹‰å–</span>
                    <span class="token comment" spellcheck="true">// å¦‚æœè¿˜æ²¡æ‹‰å–åˆ°ï¼Œè¿™é‡Œä¸ä¼šå†æ¬¡æäº¤ï¼Œè€Œæ˜¯ç›´æ¥è¿”å›å“åº”ï¼Œç”±Consumerå†æ¬¡å‘é€æ‹‰å–è¯·æ±‚</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>brokerAllowSuspend <span class="token operator">&amp;&amp;</span> hasSuspendFlag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">long</span> pollingTimeMills <span class="token operator">=</span> suspendTimeoutMillisLong<span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// å¦‚æœä¸å…è®¸é•¿è½®è¯¢ï¼Œé»˜è®¤éƒ½å…è®¸</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isLongPollingEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            pollingTimeMills <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getShortPollingTimeMills</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        String topic <span class="token operator">=</span> requestHeader<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">long</span> offset <span class="token operator">=</span> requestHeader<span class="token punctuation">.</span><span class="token function">getQueueOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">int</span> queueId <span class="token operator">=</span> requestHeader<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// ç”ŸæˆPullRequest</span>
                        PullRequest pullRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PullRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> channel<span class="token punctuation">,</span> pollingTimeMills<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getMessageStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> offset<span class="token punctuation">,</span> subscriptionData<span class="token punctuation">,</span> messageFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// å°†PullRequeståŠ å…¥PullRequestHoldServiceçš„ç¼“å­˜ï¼Œç”±PullRequestHoldServiceå†æ¬¡è°ƒç”¨å›å¤æ¶ˆæ¯</span>
                        <span class="token comment" spellcheck="true">// æ‰€ä»¥è¿™é‡Œçš„é•¿è½®è¯¢å’ŒHTTPçš„é•¿è½®è¯¢æ˜¯ä¸ä¸€æ ·çš„ï¼Œè¿™é‡Œä¸é˜»å¡ç›´æ¥è¿”å›ï¼Œæ¯•ç«ŸRPCæ˜¯åŸºäºRequestIdçš„</span>
                        <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getPullRequestHoldService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">suspendPullRequest</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> pullRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// æ²¡æœ‰æ”¶åˆ°å¯¹åº”çš„å“åº”ï¼Œæ‰€ä»¥Consumerçº¿ç¨‹ä¼šä¸€ç›´é˜»å¡</span>
                        response <span class="token operator">=</span> null<span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token keyword">case</span> ResponseCode<span class="token punctuation">.</span>PULL_RETRY_IMMEDIATELY<span class="token operator">:</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> ResponseCode<span class="token punctuation">.</span>PULL_OFFSET_MOVED<span class="token operator">:</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token keyword">default</span><span class="token operator">:</span>
                    <span class="token keyword">assert</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">boolean</span> storeOffsetEnable <span class="token operator">=</span> brokerAllowSuspend<span class="token punctuation">;</span>
        storeOffsetEnable <span class="token operator">=</span> storeOffsetEnable <span class="token operator">&amp;&amp;</span> hasCommitOffsetFlag<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Slaveçš„è¿›åº¦æ˜¯é MasteråŒæ­¥è¿‡æ¥çš„</span>
        storeOffsetEnable <span class="token operator">=</span> storeOffsetEnable <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getMessageStoreConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBrokerRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> BrokerRole<span class="token punctuation">.</span>SLAVE<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>storeOffsetEnable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è®°å½•è¯¥ConsumerGroupçš„è¯¥Consumerçš„è¯¥Topicçš„è¯¥Queueçš„æ¶ˆæ¯æ¶ˆè´¹ä½ç½®</span>
            <span class="token comment" spellcheck="true">// å°±æ˜¯ä¿å­˜æ¶ˆè´¹è¿›åº¦ï¼ŒConsumeræ‹‰å–æ¶ˆæ¯æ—¶ä¼šæºå¸¦æ¶ˆè´¹è¿›åº¦</span>
            <span class="token comment" spellcheck="true">// ç»“æ„ä¸ºï¼šConcurrentMap&lt;String, ConcurrentMap&lt;Integer, Long>></span>
            <span class="token comment" spellcheck="true">// Topic@ConsumerGroup - QueueId - QueueOffset</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getConsumerOffsetManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">commitOffset</span><span class="token punctuation">(</span>RemotingHelper<span class="token punctuation">.</span><span class="token function">parseChannelRemoteAddr</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getQueueId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> requestHeader<span class="token punctuation">.</span><span class="token function">getCommitOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> response<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>PullRequestHoldService#suspendPullRequest</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">suspendPullRequest</span><span class="token punctuation">(</span><span class="token keyword">final</span> String topic<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> queueId<span class="token punctuation">,</span> <span class="token keyword">final</span> PullRequest pullRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ç”ŸæˆKeyï¼ŒTopic + @ + QueueId</span>
        String key <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildKey</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> queueId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ä¸€ä¸ªTopicå’ŒQueueIdä¸‹å¯èƒ½æœ‰å¤šä¸ªConsumerçš„PullRequestï¼Œæš‚æ—¶æ²¡æŸ¥åˆ°æ¶ˆæ¯å°±åŠ å…¥</span>
        ManyPullRequest mpr <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pullRequestTable<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">==</span> mpr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mpr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ManyPullRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// åŠ å…¥</span>
            ManyPullRequest prev <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pullRequestTable<span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> mpr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>prev <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mpr <span class="token operator">=</span> prev<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        mpr<span class="token punctuation">.</span><span class="token function">addPullRequest</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>PullRequestHoldService#run</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å¯ç”¨äº†é•¿è½®è¯¢ï¼Œé»˜è®¤å¯ç”¨</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isLongPollingEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å…ˆé˜»å¡5ç§’</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">waitForRunning</span><span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">waitForRunning</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getBrokerConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getShortPollingTimeMills</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// é˜»å¡è¶…æ—¶æˆ–è¢«å”¤é†’ï¼Œæ£€æŸ¥</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkHoldRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>PullRequestHoldService#checkHoldRequest</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">checkHoldRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// éå†åŠ å…¥çš„PullRequest</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>String key <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pullRequestTable<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// Topic + @ + QueueId</span>
            String<span class="token punctuation">[</span><span class="token punctuation">]</span> kArray <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span>TOPIC_QUEUEID_SEPARATOR<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">==</span> kArray<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                String topic <span class="token operator">=</span> kArray<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> queueId <span class="token operator">=</span> Integer<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>kArray<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ä»CommitLogè·å–è¯¥Topicä¸‹è¯¥QueueIdçš„é˜Ÿåˆ—çš„æ¶ˆæ¯æ•°é‡/åç§»</span>
                <span class="token keyword">final</span> <span class="token keyword">long</span> offset <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getMessageStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxOffsetInQueue</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> queueId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// é€šçŸ¥PullMessageProcessoræ–°æ¶ˆæ¯åˆ°è¾¾</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">notifyMessageArriving</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> queueId<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>DefaultMessageStore#getMaxOffsetInQueue</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getMaxOffsetInQueue</span><span class="token punctuation">(</span>String topic<span class="token punctuation">,</span> <span class="token keyword">int</span> queueId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ConsumeQueue logic <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">findConsumeQueue</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> queueId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>logic <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">long</span> offset <span class="token operator">=</span> logic<span class="token punctuation">.</span><span class="token function">getMaxOffsetInQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> offset<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ConsumeQueue#getMaxOffsetInQueue</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getMaxOffsetInQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// é˜Ÿåˆ—çš„æ¶ˆæ¯æ•°é‡</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mappedFileQueue<span class="token punctuation">.</span><span class="token function">getMaxOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> CQ_STORE_UNIT_SIZE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ConsumeQueue#notifyMessageArriving</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">notifyMessageArriving</span><span class="token punctuation">(</span><span class="token keyword">final</span> String topic<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> queueId<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> maxOffset<span class="token punctuation">,</span> <span class="token keyword">final</span> Long tagsCode<span class="token punctuation">,</span> <span class="token keyword">long</span> msgStoreTime<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> filterBitMap<span class="token punctuation">,</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> properties<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Topic + @ + QueueId</span>
        String key <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildKey</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> queueId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è¯¥é˜Ÿåˆ—ä¸‹çš„PullRequeståˆ—è¡¨</span>
        ManyPullRequest mpr <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pullRequestTable<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mpr <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å¤åˆ¶Listï¼Œç„¶åæ¸…ç©º</span>
            <span class="token comment" spellcheck="true">// å› ä¸ºè¯¥æ–¹æ³•å¯èƒ½æ˜¯PullRequestHoldServiceçº¿ç¨‹è‡ªèº«å”¤é†’è°ƒç”¨ï¼Œä¹Ÿå¯èƒ½ç”±ReputMessageServiceçº¿ç¨‹æ„å»ºå¥½ConsumeQueueåï¼Œç›´æ¥è°ƒç”¨ï¼Œå­˜åœ¨å¤šçº¿ç¨‹é—®é¢˜</span>
            <span class="token comment" spellcheck="true">// ä¸è¿‡ä¸ºä»€ä¹ˆä¸å”¤é†’PullRequestHoldServiceçº¿ç¨‹ï¼Œè€Œæ˜¯ç”±ReputMessageServiceçº¿ç¨‹ç›´æ¥è°ƒç”¨å‘¢ï¼Ÿ</span>
            List<span class="token operator">&lt;</span>PullRequest<span class="token operator">></span> requestList <span class="token operator">=</span> mpr<span class="token punctuation">.</span><span class="token function">cloneListAndClear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>requestList <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                List<span class="token operator">&lt;</span>PullRequest<span class="token operator">></span> replayList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>PullRequest<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// éå†PullRequest</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>PullRequest request <span class="token operator">:</span> requestList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// é€šçŸ¥ä¼ å…¥çš„é˜Ÿåˆ—æ¶ˆæ¯æ•°/æœ€å¤§åç§»</span>
                    <span class="token keyword">long</span> newestOffset <span class="token operator">=</span> maxOffset<span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// é˜Ÿåˆ—çš„æœ€å¤§åç§» &lt;= PullRequestè¯·æ±‚çš„å¾…æ‹‰å–åç§»</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>newestOffset <span class="token operator">&lt;=</span> request<span class="token punctuation">.</span><span class="token function">getPullFromThisOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// å†æ¬¡è·å–ä¸€æ¬¡</span>
                        newestOffset <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getMessageStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxOffsetInQueue</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> queueId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// è¯´æ˜æœ‰æ–°æ¶ˆæ¯</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>newestOffset <span class="token operator">></span> request<span class="token punctuation">.</span><span class="token function">getPullFromThisOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// æ¶ˆæ¯ç¬¦åˆè¿‡æ»¤æ¡ä»¶</span>
                        <span class="token keyword">boolean</span> match <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getMessageFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isMatchedByConsumeQueue</span><span class="token punctuation">(</span>tagsCode<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ConsumeQueueExt<span class="token punctuation">.</span>CqExtUnit</span><span class="token punctuation">(</span>tagsCode<span class="token punctuation">,</span> msgStoreTime<span class="token punctuation">,</span> filterBitMap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// match by bit map, need eval again when properties is not null.</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>match <span class="token operator">&amp;&amp;</span> properties <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            match <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getMessageFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isMatchedByCommitLog</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>match<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                                <span class="token comment" spellcheck="true">// é‡æ–°æäº¤ä»»åŠ¡ï¼Œé€šè¿‡PullRequestProcessoræ‰§è¡Œæ¶ˆæ¯è¯»å–ï¼Œè¿™é‡Œçš„brokerAllowSuspendæ ‡è®°ä¸ºfalseï¼Œè‹¥è¿˜æ²¡æ‹‰å–åˆ°æ¶ˆæ¯ï¼Œä¼šç›´æ¥è¿”å›å“åº”</span>
                                <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getPullMessageProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">executeRequestWhenWakeup</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getClientChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getRequestCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token comment" spellcheck="true">// ...</span>
                            <span class="token punctuation">}</span>
                            <span class="token comment" spellcheck="true">// ç»§ç»­ä¸‹ä¸€ä¸ª</span>
                            <span class="token keyword">continue</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// è¶…æ—¶</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getSuspendTimestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> request<span class="token punctuation">.</span><span class="token function">getTimeoutMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// é‡æ–°æäº¤ä»»åŠ¡ï¼Œé€šè¿‡PullRequestProcessoræ‰§è¡Œæ¶ˆæ¯è¯»å–ï¼Œè¿™é‡Œçš„brokerAllowSuspendæ ‡è®°ä¸ºfalseï¼Œè‹¥è¿˜æ²¡æ‹‰å–åˆ°æ¶ˆæ¯ï¼Œä¼šç›´æ¥è¿”å›å“åº”</span>
                            <span class="token keyword">this</span><span class="token punctuation">.</span>brokerController<span class="token punctuation">.</span><span class="token function">getPullMessageProcessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">executeRequestWhenWakeup</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getClientChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getRequestCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// ...</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment" spellcheck="true">// ç»§ç»­ä¸‹ä¸€ä¸ª</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// æœªè¶…æ—¶ï¼Œé‡æ–°åŠ å…¥</span>
                    replayList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">//</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>replayList<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// é‡æ–°åŠ å…¥æ‹‰å–ä»»åŠ¡</span>
                    mpr<span class="token punctuation">.</span><span class="token function">addPullRequest</span><span class="token punctuation">(</span>replayList<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


        <footer>
             
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

        </footer>
    </div>
    <!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
    <script>
        var timeEnd = new Date();
        console.log('è€—æ—¶ï¼š' + (timeEnd - timeStart));
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre').forEach((block) => {
                block.classList.add("line-numbers");
            });
        });
    </script>
    <!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
    <!-- material design -->
    <!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
    <!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
    <!-- toc -->
    <!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
    <!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
    <!-- <script src="/js/main.js"></script> -->
    <script src="/js/prism.js"></script>
</body>
</html>
