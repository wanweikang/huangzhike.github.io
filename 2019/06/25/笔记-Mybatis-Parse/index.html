<!DOCTYPE HTML>
<html>
	<head>
		<meta charset="utf-8">
				<script>var timeStart = new Date();</script>
		
		<title>[笔记]-Mybatis-Parse | 一个放笔记的地方而已</title>
		
		<meta name="author" content="Huangzhike">
		
		
		<meta name="description" content="没有鸡汤，只有笔记">
		
		
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		
		<meta property="og:title" content="[笔记]-Mybatis-Parse"/>
		
		<meta property="og:site_name" content="一个放笔记的地方而已"/>
		
		
		<!-- favicon -->
		<link rel="icon" type="image/ico" href="/ok.ico" sizes="32x32">
 


		<meta name="msapplication-TileColor" content="#009688">
		<meta name="msapplication-TileImage" content="/mstile-144x144.ico">
		<meta name="theme-color" content="#009688">

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Didact+Gothic"> 

		<!-- favicon end -->
		<!-- <link href="//ok.ico" rel="icon"> -->
		
		<!-- toc -->
		<!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
		<!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
		<!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
		<!-- material design -->
		<!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
		<!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
		<!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
		<!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
		<!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
		<link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
		 
		 
		<!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
		<!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
	</head>

<body>
	<nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">菜单</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" href="/">一个放笔记的地方而已</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/" title="">
						<i class="fa fa-home"></i>Index
					</a>
				</li>
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

	<div class="container" >
		<div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[笔记]-Mybatis-Parse</h2>
				
				<div>
					<span class="post-time">2019-06-25 00:23:17</span>
				</div>	
				
				<div class="article-content">
				<p>本来以为MyBatis只是一个封装了JDBC操作的轻量级框架，结果看得我好难受，一是对框架的一些概念和操作不熟悉，二是对数据库这方面了解不深，也没太大兴趣，所以，最后其实也是不求甚解地看完了。</p>
<p>XML解析这部分没仔细看（XML IS SHIT），最终会汇总在Configuration对象里，这里以注解方式为入口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">PooledDataSource dataSource = <span class="keyword">new</span> PooledDataSource();</div><div class="line">TransactionFactory transactionFactory = <span class="keyword">new</span> JdbcTransactionFactory();</div><div class="line">Environment environment = <span class="keyword">new</span> Environment(<span class="string">"development"</span>, transactionFactory, dataSource);</div><div class="line">Configuration configuration = <span class="keyword">new</span> Configuration(environment);</div><div class="line">configuration.getTypeAliasRegistry().registerAlias(Blog.class);</div><div class="line">configuration.addMapper(BlogMapper.class);</div><div class="line">SqlSessionFactory sqlSessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(configuration);</div><div class="line"><span class="keyword">try</span> (SqlSession session = sqlSessionFactory.openSession()) &#123;</div><div class="line">	BlogMapper mapper = session.getMapper(BlogMapper.class);</div><div class="line">	Blog blog = mapper.selectBlog(<span class="number">101</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>MapperRegistry#addMapper<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">addMapper</span><span class="params">(Class&lt;T&gt; type)</span> </span>&#123;</div><div class="line">    <span class="comment">// 必须是interface</span></div><div class="line">    <span class="keyword">if</span> (type.isInterface()) &#123;</div><div class="line">        <span class="comment">// 确保只会加载一次</span></div><div class="line">        <span class="keyword">if</span> (hasMapper(type)) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BindingException(<span class="string">"Type "</span> + type + <span class="string">" is already known to the MapperRegistry."</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">boolean</span> loadCompleted = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// 为Mapper接口创建一个MapperProxyFactory代理</span></div><div class="line">            knownMappers.put(type, <span class="keyword">new</span> MapperProxyFactory&lt;&gt;(type));</div><div class="line"></div><div class="line">            MapperAnnotationBuilder parser = <span class="keyword">new</span> MapperAnnotationBuilder(config, type);</div><div class="line">            <span class="comment">// 具体的Mapper接口文件加载与解析</span></div><div class="line">            parser.parse();</div><div class="line">            loadCompleted = <span class="keyword">true</span>;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            <span class="keyword">if</span> (!loadCompleted) &#123;</div><div class="line">                <span class="comment">// 剔移除解析异常的接口</span></div><div class="line">                knownMappers.remove(type);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>MapperAnnotationBuilder#parse<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parse</span><span class="params">()</span> </span>&#123;</div><div class="line">    String resource = type.toString();</div><div class="line">    <span class="comment">// 根据Mapper接口的字符串判断是否已经加载</span></div><div class="line">    <span class="keyword">if</span> (!configuration.isResourceLoaded(resource)) &#123;</div><div class="line">        <span class="comment">// 加载XML</span></div><div class="line">        loadXmlResource();</div><div class="line">        configuration.addLoadedResource(resource);</div><div class="line">        <span class="comment">// 每个Mapper一个namespace</span></div><div class="line">        assistant.setCurrentNamespace(type.getName());</div><div class="line">        parseCache();</div><div class="line">        parseCacheRef();</div><div class="line">        Method[] methods = type.getMethods();</div><div class="line">        <span class="keyword">for</span> (Method method : methods) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="comment">/*</span></div><div class="line">                 * 桥接方法：使Java的泛型方法生成的字节码和1.5版本前的字节码兼容，由编译器自动生成的方法</div><div class="line">                 */</div><div class="line">                <span class="keyword">if</span> (!method.isBridge()) &#123;</div><div class="line">                    <span class="comment">// 解析接口方法（参数等）</span></div><div class="line">                    parseStatement(method);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">catch</span> (IncompleteElementException e) &#123;</div><div class="line">                configuration.addIncompleteMethod(<span class="keyword">new</span> MethodResolver(<span class="keyword">this</span>, method));</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    parsePendingMethods();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>MapperAnnotationBuilder#parseStatement<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">parseStatement</span><span class="params">(Method method)</span> </span>&#123;</div><div class="line">    <span class="comment">// 参数类型，多个参数就返回org.apache.ibatis.binding.MapperMethod.ParamMap，否则返回实际类型</span></div><div class="line">    Class&lt;?&gt; parameterTypeClass = getParameterType(method);</div><div class="line">    <span class="comment">// 语言驱动器</span></div><div class="line">    LanguageDriver languageDriver = getLanguageDriver(method);</div><div class="line">    <span class="comment">// 方法的SqlSource对象，只有指定了@Select/@Insert/@Update/@Delete或对应的Provider的方法才会被当作mapper</span></div><div class="line">    SqlSource sqlSource = getSqlSourceFromAnnotations(method, parameterTypeClass, languageDriver);</div><div class="line">    <span class="keyword">if</span> (sqlSource != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// 方法的属性设置，对应&lt;select&gt;中的各种属性</span></div><div class="line">        Options options = method.getAnnotation(Options.class);</div><div class="line">        <span class="comment">// id</span></div><div class="line">        <span class="keyword">final</span> String mappedStatementId = type.getName() + <span class="string">"."</span> + method.getName();</div><div class="line">        Integer fetchSize = <span class="keyword">null</span>;</div><div class="line">        Integer timeout = <span class="keyword">null</span>;</div><div class="line">        StatementType statementType = StatementType.PREPARED;</div><div class="line">        ResultSetType resultSetType = <span class="keyword">null</span>;</div><div class="line">        <span class="comment">// 语句的CRUD类型</span></div><div class="line">        SqlCommandType sqlCommandType = getSqlCommandType(method);</div><div class="line">        <span class="keyword">boolean</span> isSelect = sqlCommandType == SqlCommandType.SELECT;</div><div class="line">        <span class="keyword">boolean</span> flushCache = !isSelect;</div><div class="line">        <span class="keyword">boolean</span> useCache = isSelect;</div><div class="line">        <span class="comment">// 自增</span></div><div class="line">        KeyGenerator keyGenerator;</div><div class="line">        <span class="comment">// 主键属性名</span></div><div class="line">        String keyProperty = <span class="keyword">null</span>;</div><div class="line">        <span class="comment">// 主键列名</span></div><div class="line">        String keyColumn = <span class="keyword">null</span>;</div><div class="line">        <span class="comment">// 只有INSERT/UPDATE才解析SelectKey选项</span></div><div class="line">        <span class="keyword">if</span> (SqlCommandType.INSERT.equals(sqlCommandType) || SqlCommandType.UPDATE.equals(sqlCommandType)) &#123;</div><div class="line"></div><div class="line">            SelectKey selectKey = method.getAnnotation(SelectKey.class);</div><div class="line">            <span class="keyword">if</span> (selectKey != <span class="keyword">null</span>) &#123;</div><div class="line">                keyGenerator = handleSelectKeyAnnotation(selectKey, mappedStatementId, getParameterType(method), languageDriver);</div><div class="line">                keyProperty = selectKey.keyProperty();</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (options == <span class="keyword">null</span>) &#123;</div><div class="line">                keyGenerator = configuration.isUseGeneratedKeys() ? Jdbc3KeyGenerator.INSTANCE : NoKeyGenerator.INSTANCE;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                keyGenerator = options.useGeneratedKeys() ? Jdbc3KeyGenerator.INSTANCE : NoKeyGenerator.INSTANCE;</div><div class="line">                keyProperty = options.keyProperty();</div><div class="line">                keyColumn = options.keyColumn();</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            keyGenerator = NoKeyGenerator.INSTANCE;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (options != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (FlushCachePolicy.TRUE.equals(options.flushCache())) &#123;</div><div class="line">                flushCache = <span class="keyword">true</span>;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (FlushCachePolicy.FALSE.equals(options.flushCache())) &#123;</div><div class="line">                flushCache = <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">            useCache = options.useCache();</div><div class="line">            fetchSize = options.fetchSize() &gt; -<span class="number">1</span> || options.fetchSize() == Integer.MIN_VALUE ? options.fetchSize() : <span class="keyword">null</span>;</div><div class="line">            timeout = options.timeout() &gt; -<span class="number">1</span> ? options.timeout() : <span class="keyword">null</span>;</div><div class="line">            statementType = options.statementType();</div><div class="line">            resultSetType = options.resultSetType();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        String resultMapId = <span class="keyword">null</span>;</div><div class="line">        <span class="comment">// 解析@ResultMap注解，如果有就用它</span></div><div class="line">        ResultMap resultMapAnnotation = method.getAnnotation(ResultMap.class);</div><div class="line">        <span class="keyword">if</span> (resultMapAnnotation != <span class="keyword">null</span>) &#123;</div><div class="line">            resultMapId = String.join(<span class="string">","</span>, resultMapAnnotation.value());</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isSelect) &#123;</div><div class="line">            <span class="comment">// 如果是查询，且没有@ResultMap，则解析生成ResultMap</span></div><div class="line">            resultMapId = parseResultMap(method);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 生成MappedStatement并添加到Configuration</span></div><div class="line">        assistant.addMappedStatement(mappedStatementId, sqlSource, statementType, sqlCommandType, fetchSize, timeout,</div><div class="line"></div><div class="line">                <span class="keyword">null</span>, parameterTypeClass, resultMapId, getReturnType(method), resultSetType, flushCache, useCache,</div><div class="line"></div><div class="line">                <span class="keyword">false</span>, keyGenerator, keyProperty, keyColumn,</div><div class="line"></div><div class="line">                <span class="keyword">null</span>, languageDriver,</div><div class="line"></div><div class="line">                options != <span class="keyword">null</span> ? nullOrEmpty(options.resultSets()) : <span class="keyword">null</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>MapperAnnotationBuilder#getSqlSourceFromAnnotations<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 返回SqlSource</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> SqlSource <span class="title">getSqlSourceFromAnnotations</span><span class="params">(Method method, Class&lt;?&gt; parameterType, LanguageDriver languageDriver)</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">// 方法的注解类如@Select</span></div><div class="line">        Class&lt;? extends Annotation&gt; sqlAnnotationType = getSqlAnnotationType(method);</div><div class="line">        <span class="comment">// 方法的Provider注解类如@SelectProvider</span></div><div class="line">        Class&lt;? extends Annotation&gt; sqlProviderAnnotationType = getSqlProviderAnnotationType(method);</div><div class="line">        <span class="keyword">if</span> (sqlAnnotationType != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (sqlProviderAnnotationType != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="comment">// 不能共存</span></div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> BindingException(<span class="string">"You cannot supply both a static SQL and SqlProvider to method named "</span> + method.getName());</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// 获得注解对象</span></div><div class="line">            Annotation sqlAnnotation = method.getAnnotation(sqlAnnotationType);</div><div class="line">            <span class="comment">// 获得注解值的sql语句 value()方法</span></div><div class="line">            <span class="keyword">final</span> String[] strings = (String[]) sqlAnnotation.getClass().getMethod(<span class="string">"value"</span>).invoke(sqlAnnotation);</div><div class="line">            <span class="comment">// parameterType 参数类型，ParamMap或Bean类</span></div><div class="line">            <span class="keyword">return</span> buildSqlSourceFromStrings(strings, parameterType, languageDriver);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sqlProviderAnnotationType != <span class="keyword">null</span>) &#123;</div><div class="line">            Annotation sqlProviderAnnotation = method.getAnnotation(sqlProviderAnnotationType);</div><div class="line">            <span class="comment">// type mapper类对象</span></div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ProviderSqlSource(assistant.getConfiguration(), sqlProviderAnnotation, type, method);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">"Could not find value method on SQL annotation.  Cause: "</span> + e, e);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>MapperAnnotationBuilder#buildSqlSourceFromStrings</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> SqlSource <span class="title">buildSqlSourceFromStrings</span><span class="params">(String[] strings, Class&lt;?&gt; parameterTypeClass, LanguageDriver languageDriver)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> StringBuilder sql = <span class="keyword">new</span> StringBuilder();</div><div class="line">    <span class="keyword">for</span> (String fragment : strings) &#123;</div><div class="line">        sql.append(fragment);</div><div class="line">        sql.append(<span class="string">" "</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> languageDriver.createSqlSource(configuration, sql.toString().trim(), parameterTypeClass);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>XMLLanguageDriver#createSqlSource<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> SqlSource <span class="title">createSqlSource</span><span class="params">(Configuration configuration, String script, Class&lt;?&gt; parameterType)</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (script.startsWith(<span class="string">"&lt;script&gt;"</span>)) &#123;</div><div class="line">        XPathParser parser = <span class="keyword">new</span> XPathParser(script, <span class="keyword">false</span>, configuration.getVariables(), <span class="keyword">new</span> XMLMapperEntityResolver());</div><div class="line">        <span class="keyword">return</span> createSqlSource(configuration, parser.evalNode(<span class="string">"/script"</span>), parameterType);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line"></div><div class="line">        script = PropertyParser.parse(script, configuration.getVariables());</div><div class="line">        TextSqlNode textSqlNode = <span class="keyword">new</span> TextSqlNode(script);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (textSqlNode.isDynamic()) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> DynamicSqlSource(configuration, textSqlNode);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// StaticSqlSource</span></div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> RawSqlSource(configuration, script, parameterType);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>TextSqlNode#isDynamic<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isDynamic</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// $&#123;$&#123;xxx&#125;&#125; -&gt; $&#123;xxx&#125;</span></div><div class="line">    DynamicCheckerTokenParser checker = <span class="keyword">new</span> DynamicCheckerTokenParser();</div><div class="line">    GenericTokenParser parser = createParser(checker);</div><div class="line">    parser.parse(text);</div><div class="line">    <span class="keyword">return</span> checker.isDynamic();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>RawSqlSource<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 原始静态SQL语句的封装，在加载时就已经确定了SQL语句，没有动态标签和$&#123;&#125;SQL拼接</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">RawSqlSource</span><span class="params">(Configuration configuration, String sql, Class&lt;?&gt; parameterType)</span> </span>&#123;</div><div class="line">    SqlSourceBuilder sqlSourceParser = <span class="keyword">new</span> SqlSourceBuilder(configuration);</div><div class="line">    Class&lt;?&gt; clazz = parameterType == <span class="keyword">null</span> ? Object.class : parameterType;</div><div class="line">    <span class="comment">// StaticSqlSource</span></div><div class="line">    sqlSource = sqlSourceParser.parse(sql, clazz, <span class="keyword">new</span> HashMap&lt;&gt;());</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>SqlSourceBuilder#parse</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> SqlSource <span class="title">parse</span><span class="params">(String originalSql, Class&lt;?&gt; parameterType, Map&lt;String, Object&gt; additionalParameters)</span> </span>&#123;</div><div class="line">    <span class="comment">// 解析sql参数</span></div><div class="line">    ParameterMappingTokenHandler handler = <span class="keyword">new</span> ParameterMappingTokenHandler(configuration, parameterType, additionalParameters);</div><div class="line">    GenericTokenParser parser = <span class="keyword">new</span> GenericTokenParser(<span class="string">"#&#123;"</span>, <span class="string">"&#125;"</span>, handler);</div><div class="line">    <span class="comment">// #&#123;&#125; 转为 ? 并生成ParameterMapping</span></div><div class="line">    String sql = parser.parse(originalSql);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> StaticSqlSource(configuration, sql, handler.getParameterMappings());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>MapperAnnotationBuilder#parseResultMap<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> String <span class="title">parseResultMap</span><span class="params">(Method method)</span> </span>&#123;</div><div class="line">    <span class="comment">// 获取方法的返回类型</span></div><div class="line">    Class&lt;?&gt; returnType = getReturnType(method);</div><div class="line">    <span class="comment">// 获取构造器参数</span></div><div class="line">    ConstructorArgs args = method.getAnnotation(ConstructorArgs.class);</div><div class="line">    <span class="comment">// 获取ResultMap</span></div><div class="line">    Results results = method.getAnnotation(Results.class);</div><div class="line">    <span class="comment">// 获取鉴别器</span></div><div class="line">    TypeDiscriminator typeDiscriminator = method.getAnnotation(TypeDiscriminator.class);</div><div class="line">    <span class="comment">// 产生resultMapId</span></div><div class="line">    String resultMapId = generateResultMapName(method);</div><div class="line">    applyResultMap(resultMapId, returnType, argsIf(args), resultsIf(results), typeDiscriminator);</div><div class="line">    <span class="keyword">return</span> resultMapId;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>MapperAnnotationBuilder#applyResultMap</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 应用ResultMap</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">applyResultMap</span><span class="params">(String resultMapId, Class&lt;?&gt; returnType, Arg[] args, Result[] results, TypeDiscriminator discriminator)</span> </span>&#123;</div><div class="line">    <span class="comment">// ResultMapping，放入List</span></div><div class="line">    List&lt;ResultMapping&gt; resultMappings = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">    applyConstructorArgs(args, returnType, resultMappings);</div><div class="line">    applyResults(results, returnType, resultMappings);</div><div class="line">    Discriminator disc = applyDiscriminator(resultMapId, returnType, discriminator);</div><div class="line">    <span class="comment">// 生成添加ResultMap到Configuration</span></div><div class="line">    assistant.addResultMap(resultMapId, returnType, <span class="keyword">null</span>, disc, resultMappings, <span class="keyword">null</span>);</div><div class="line">    createDiscriminatorResultMaps(resultMapId, returnType, discriminator);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>MapperBuilderAssistant#addResultMap</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> ResultMap <span class="title">addResultMap</span><span class="params">(String id, Class&lt;?&gt; type, String extend, Discriminator discriminator, List&lt;ResultMapping&gt; resultMappings, Boolean autoMapping)</span> </span>&#123;</div><div class="line">    id = applyCurrentNamespace(id, <span class="keyword">false</span>);</div><div class="line">    extend = applyCurrentNamespace(extend, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (extend != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// ...</span></div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 生成ResultMap</span></div><div class="line">    ResultMap resultMap = <span class="keyword">new</span> ResultMap.Builder(configuration, id, type, resultMappings, autoMapping).discriminator(discriminator).build();</div><div class="line">    <span class="comment">// 添加</span></div><div class="line">    configuration.addResultMap(resultMap);</div><div class="line">    <span class="keyword">return</span> resultMap;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ResultMap#Builder#build</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> ResultMap <span class="title">build</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (resultMap.id == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"ResultMaps must have an id"</span>);</div><div class="line">    &#125;</div><div class="line">    resultMap.mappedColumns = <span class="keyword">new</span> HashSet&lt;&gt;();</div><div class="line">    resultMap.mappedProperties = <span class="keyword">new</span> HashSet&lt;&gt;();</div><div class="line">    resultMap.idResultMappings = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">    resultMap.constructorResultMappings = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">    resultMap.propertyResultMappings = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">    <span class="keyword">final</span> List&lt;String&gt; constructorArgNames = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">    <span class="keyword">for</span> (ResultMapping resultMapping : resultMap.resultMappings) &#123;</div><div class="line">        <span class="comment">// 是否有嵌套查询</span></div><div class="line">        resultMap.hasNestedQueries = resultMap.hasNestedQueries || resultMapping.getNestedQueryId() != <span class="keyword">null</span>;</div><div class="line">        <span class="comment">// 是否嵌套了association或collection</span></div><div class="line">        resultMap.hasNestedResultMaps = resultMap.hasNestedResultMaps || (resultMapping.getNestedResultMapId() != <span class="keyword">null</span> &amp;&amp; resultMapping.getResultSet() == <span class="keyword">null</span>);</div><div class="line"></div><div class="line">        <span class="keyword">final</span> String column = resultMapping.getColumn();</div><div class="line">        <span class="keyword">if</span> (column != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// 添加到resultMap.mappedColumns</span></div><div class="line">            resultMap.mappedColumns.add(column.toUpperCase(Locale.ENGLISH));</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (resultMapping.isCompositeResult()) &#123;</div><div class="line">            <span class="keyword">for</span> (ResultMapping compositeResultMapping : resultMapping.getComposites()) &#123;</div><div class="line">                <span class="keyword">final</span> String compositeColumn = compositeResultMapping.getColumn();</div><div class="line">                <span class="keyword">if</span> (compositeColumn != <span class="keyword">null</span>) &#123;</div><div class="line">                    resultMap.mappedColumns.add(compositeColumn.toUpperCase(Locale.ENGLISH));</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> String property = resultMapping.getProperty();</div><div class="line">        <span class="keyword">if</span> (property != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// 添加到resultMap.mappedProperties</span></div><div class="line">            resultMap.mappedProperties.add(property);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (resultMapping.getFlags().contains(ResultFlag.CONSTRUCTOR)) &#123;</div><div class="line">            resultMap.constructorResultMappings.add(resultMapping);</div><div class="line">            <span class="keyword">if</span> (resultMapping.getProperty() != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="comment">// 添加到resultMap.constructorResultMappings</span></div><div class="line">                constructorArgNames.add(resultMapping.getProperty());</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// 添加到resultMap.propertyResultMappings</span></div><div class="line">            resultMap.propertyResultMappings.add(resultMapping);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 添加到resultMap.idResultMappings</span></div><div class="line">        <span class="keyword">if</span> (resultMapping.getFlags().contains(ResultFlag.ID)) &#123;</div><div class="line">            resultMap.idResultMappings.add(resultMapping);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 如果没有声明Id属性，所有属性都作为Id属性</span></div><div class="line">    <span class="keyword">if</span> (resultMap.idResultMappings.isEmpty()) &#123;</div><div class="line">        resultMap.idResultMappings.addAll(resultMap.resultMappings);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 根据声明的构造器参数名和类型，反射检查其中是否包含对应参数名和类型的构造器</span></div><div class="line">    <span class="keyword">if</span> (!constructorArgNames.isEmpty()) &#123;</div><div class="line">        <span class="keyword">final</span> List&lt;String&gt; actualArgNames = argNamesOfMatchingConstructor(constructorArgNames);</div><div class="line">        <span class="keyword">if</span> (actualArgNames == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BuilderException(<span class="string">"Error in result map '"</span> + resultMap.id + <span class="string">"'. Failed to find a constructor in '"</span> + resultMap.getType().getName() + <span class="string">"' by arg names "</span> + constructorArgNames + <span class="string">". There might be more info in debug log."</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 构造器参数排序</span></div><div class="line">        resultMap.constructorResultMappings.sort((o1, o2) -&gt; &#123;</div><div class="line">            <span class="keyword">int</span> paramIdx1 = actualArgNames.indexOf(o1.getProperty());</div><div class="line">            <span class="keyword">int</span> paramIdx2 = actualArgNames.indexOf(o2.getProperty());</div><div class="line">            <span class="keyword">return</span> paramIdx1 - paramIdx2;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    resultMap.resultMappings = Collections.unmodifiableList(resultMap.resultMappings);</div><div class="line">    resultMap.idResultMappings = Collections.unmodifiableList(resultMap.idResultMappings);</div><div class="line">    resultMap.constructorResultMappings = Collections.unmodifiableList(resultMap.constructorResultMappings);</div><div class="line">    resultMap.propertyResultMappings = Collections.unmodifiableList(resultMap.propertyResultMappings);</div><div class="line">    resultMap.mappedColumns = Collections.unmodifiableSet(resultMap.mappedColumns);</div><div class="line">    <span class="keyword">return</span> resultMap;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>MapperBuilderAssistant#addMappedStatement</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> MappedStatement <span class="title">addMappedStatement</span><span class="params">(String id, SqlSource sqlSource, StatementType statementType, SqlCommandType sqlCommandType, Integer fetchSize, Integer timeout, String parameterMap, Class&lt;?&gt; parameterType, String resultMap, Class&lt;?&gt; resultType, ResultSetType resultSetType, <span class="keyword">boolean</span> flushCache, <span class="keyword">boolean</span> useCache, <span class="keyword">boolean</span> resultOrdered, KeyGenerator keyGenerator, String keyProperty, String keyColumn, String databaseId, LanguageDriver lang, String resultSets)</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (unresolvedCacheRef) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IncompleteElementException(<span class="string">"Cache-ref not yet resolved"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    id = applyCurrentNamespace(id, <span class="keyword">false</span>);</div><div class="line">    <span class="keyword">boolean</span> isSelect = sqlCommandType == SqlCommandType.SELECT;</div><div class="line"></div><div class="line">    MappedStatement.Builder statementBuilder = <span class="keyword">new</span> MappedStatement.Builder(configuration, id, sqlSource, sqlCommandType).resource(resource).fetchSize(fetchSize).timeout(timeout).statementType(statementType).keyGenerator(keyGenerator).keyProperty(keyProperty).keyColumn(keyColumn).databaseId(databaseId).lang(lang).resultOrdered(resultOrdered).resultSets(resultSets).resultMaps(getStatementResultMaps(resultMap, resultType, id)).resultSetType(resultSetType).flushCacheRequired(valueOrDefault(flushCache, !isSelect)).useCache(valueOrDefault(useCache, isSelect)).cache(currentCache);</div><div class="line"></div><div class="line">    ParameterMap statementParameterMap = getStatementParameterMap(parameterMap, parameterType, id);</div><div class="line">    <span class="keyword">if</span> (statementParameterMap != <span class="keyword">null</span>) &#123;</div><div class="line">        statementBuilder.parameterMap(statementParameterMap);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    MappedStatement statement = statementBuilder.build();</div><div class="line">    configuration.addMappedStatement(statement);</div><div class="line">    <span class="keyword">return</span> statement;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


		<footer>
			 
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

		</footer>
	</div>
	<!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
	<script src="/js/highlight.js"></script> 
	<script>hljs.initHighlightingOnLoad();var timeEnd = new Date();console.log('耗时：' + (timeEnd - timeStart));</script>
	<!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
	<!-- material design -->
	<!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
	<!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
	<!-- toc -->
	<!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
	<!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
	<!-- <script src="/js/main.js"></script> -->
</body>
</html>
