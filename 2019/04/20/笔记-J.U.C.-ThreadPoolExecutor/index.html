<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
        <script>
            var timeStart = new Date();
        </script>
        
        <title>[ç¬”è®°]-J.U.C.-ThreadPoolExecutor | ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜</title>
        
        <meta name="author" content="huangzhike">
        
        
        <meta name="description" content="2019-12-09æ›´æ–°
æƒ³åšä¸€æ¡å®‰é™çš„å’¸é±¼ã€‚

ThreadPoolExecutor
public class ThreadPoolExecutor extends AbstractExecutorService {
    /**
     * é«˜3ä½è¡¨ç¤ºçº¿ç¨‹æ± çŠ¶æ€ï¼Œä½29ä½è¡¨ç¤ºçº¿ç¨‹æ± çº¿ç¨‹ä¸ªæ•°
">
        
        
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        
        <meta property="og:title" content="[ç¬”è®°]-J.U.C.-ThreadPoolExecutor"/>
        
        <meta property="og:site_name" content="ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜"/>
        
        
        <!-- favicon -->
        <link rel="icon" type="image/ico" href="/ok.ico" sizes="32x32">
        <meta name="msapplication-TileColor" content="#009688">
        <meta name="msapplication-TileImage" content="/mstile-144x144.ico">
        <meta name="theme-color" content="#009688">
        <!-- favicon end -->
        <!-- <link href="//ok.ico" rel="icon"> -->
        
        <!-- toc -->
        <!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
        <!-- material design -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
        <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
        
        <!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
        <!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
    <meta name="generator" content="Hexo 4.2.1"></head>

<body>
    <nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">èœå•</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" title="ä¸‹ä¸€å¥æ˜¯ï¼šå®¢æœ‰å¯äººæœŸä¸æ¥ã€‚å°æ—¶å€™ï¼Œå–œæ¬¢é åœ¨é˜³å°ä¸Šï¼Œä¸€è¾¹å¹é£ï¼Œä¸€è¾¹çœ‹ä¹¦ï¼Œå–œæ¬¢è¯»ä¹¦å—ï¼Œéªšå¹´ï¼Ÿ" href="/">ä¹¦å½“å¿«æ„è¯»æ˜“å°½</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" target="_blank" rel="noopener" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

    <div class="container" >
        <div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[ç¬”è®°]-J.U.C.-ThreadPoolExecutor</h2>
				
				<div>
					<div class="post-time">2019-04-20</div>
				</div>
				
				<div class="article-content">
				<p>2019-12-09æ›´æ–°</p>
<p>æƒ³åšä¸€æ¡å®‰é™çš„å’¸é±¼ã€‚</p>
<hr>
<p>ThreadPoolExecutor</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadPoolExecutor</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractExecutorService</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/**
     * é«˜3ä½è¡¨ç¤ºçº¿ç¨‹æ± çŠ¶æ€ï¼Œä½29ä½è¡¨ç¤ºçº¿ç¨‹æ± çº¿ç¨‹ä¸ªæ•°
     * workerCountï¼šå½“å‰æœ‰æ•ˆçš„çº¿ç¨‹æ•°ï¼Œæœ€å¤§çº¿ç¨‹æ•°æ˜¯2^29-1=536870911
     * runStateï¼šçº¿ç¨‹æ± çš„äº”ç§çŠ¶æ€ï¼ŒRunningã€Shutdownã€Stopã€Tidyingã€Terminate
     * åˆå§‹åŒ–ä¸ºRUNNINGçŠ¶æ€ï¼Œå¹¶ä¸”ä»»åŠ¡æ•°é‡åˆå§‹åŒ–ä¸º0
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> AtomicInteger ctl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token function">ctlOf</span><span class="token punctuation">(</span>RUNNING<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * æ­£åœ¨è¿è¡Œï¼Œèƒ½å¤Ÿæ¥æ”¶æ–°ä»»åŠ¡ï¼Œå¤„ç†å·²æ·»åŠ çš„ä»»åŠ¡
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> RUNNING <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> COUNT_BITS<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * shutdownï¼Œä¸æ¥æ”¶æ–°ä»»åŠ¡ï¼Œä½†èƒ½å¤„ç†å·²æ·»åŠ çš„ä»»åŠ¡
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SHUTDOWN <span class="token operator">=</span> <span class="token number">0</span> <span class="token operator">&lt;&lt;</span> COUNT_BITS<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * shutdownNowï¼Œä¸æ¥æ”¶æ–°ä»»åŠ¡ï¼Œä¸å¤„ç†å·²æ·»åŠ çš„ä»»åŠ¡ï¼Œä¸­æ–­æ­£åœ¨å¤„ç†çš„ä»»åŠ¡
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> STOP <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> COUNT_BITS<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * æ‰€æœ‰ä»»åŠ¡å·²åœæ­¢ï¼Œå‡†å¤‡æ¸…ç†
     * å˜ä¸ºTIDYINGçŠ¶æ€æ—¶ï¼Œæ‰§è¡ŒThreadPoolExecutor#terminated
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> TIDYING <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">&lt;&lt;</span> COUNT_BITS<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * å·²ç»ˆæ­¢ï¼ŒTIDYINGçŠ¶æ€æ—¶ï¼Œæ‰§è¡Œå®ŒThreadPoolExecutor#terminatedå
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> TERMINATED <span class="token operator">=</span> <span class="token number">3</span> <span class="token operator">&lt;&lt;</span> COUNT_BITS<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * é˜»å¡å·¥ä½œé˜Ÿåˆ—ï¼Œä¸€èˆ¬ç”¨ArrayBlockingQueueæˆ–LinkedBlockingQueue
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> BlockingQueue<span class="token operator">&lt;</span>Runnable<span class="token operator">></span> workQueue<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * äº’æ–¥é”
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> ReentrantLock mainLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * çº¿ç¨‹é›†åˆï¼Œä¸€ä¸ªWorkerå¯¹åº”ä¸€ä¸ªçº¿ç¨‹
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> HashSet<span class="token operator">&lt;</span>Worker<span class="token operator">></span> workers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token operator">&lt;</span>Worker<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * ç»ˆæ­¢æ¡ä»¶
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> Condition termination <span class="token operator">=</span> mainLock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * çº¿ç¨‹æ± ä¸­çº¿ç¨‹æ•°é‡æ›¾ç»è¾¾åˆ°è¿‡çš„æœ€å¤§å€¼
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> largestPoolSize<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * ThreadFactoryå¯¹è±¡ï¼Œç”¨äºåˆ›å»ºçº¿ç¨‹
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> ThreadFactory threadFactory<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * æ‹’ç»ç­–ç•¥
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> RejectedExecutionHandler handler<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * çº¿ç¨‹å­˜æ´»æ—¶é—´
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">long</span> keepAliveTime<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> allowCoreThreadTimeOut<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * å·²å®Œæˆä»»åŠ¡æ•°é‡
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> completedTaskCount<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * æ ¸å¿ƒæ± å¤§å°
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> corePoolSize<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * æœ€å¤§æ± å¤§å°
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> maximumPoolSize<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * é»˜è®¤æ‹’ç»ç­–ç•¥
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> RejectedExecutionHandler defaultHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AbortPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span></code></pre>
<hr>
<p>AbstractExecutorService#submit</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * å‘çº¿ç¨‹æ± æäº¤ä»»åŠ¡çš„æ—¶å€™ï¼Œä¼šåˆ›å»ºä¸€ä¸ªFutureTaskè¿”å›
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> Future<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> <span class="token function">submit</span><span class="token punctuation">(</span>Runnable task<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>task <span class="token operator">==</span> null<span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        RunnableFuture<span class="token operator">&lt;</span>Void<span class="token operator">></span> ftask <span class="token operator">=</span> <span class="token function">newTaskFor</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">execute</span><span class="token punctuation">(</span>ftask<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ftask<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ThreadPoolExecutor#execute</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * ä¼˜å…ˆçº§ä¸ºæ ¸å¿ƒçº¿ç¨‹ -> å·¥ä½œé˜Ÿåˆ— -> éæ ¸å¿ƒçº¿ç¨‹
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span>Runnable command<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>command <span class="token operator">==</span> null<span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¦‚æœçº¿ç¨‹æ•°é‡å°äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œåˆ™åˆ›å»ºçº¿ç¨‹</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">workerCountOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">&lt;</span> corePoolSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ·»åŠ æˆåŠŸåˆ™ç›´æ¥è¿”å›</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">addWorker</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å¦åˆ™å†æ¬¡è·å–çº¿ç¨‹æ± çŠ¶æ€</span>
            c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å¦åˆ™è¯´æ˜æ ¸å¿ƒçº¿ç¨‹æ•°å·²æ»¡</span>
        <span class="token comment" spellcheck="true">// çº¿ç¨‹æ± æ­£åœ¨è¿è¡Œ &amp;&amp; ä»»åŠ¡é˜Ÿåˆ—æœªæ»¡ï¼Œæ·»åŠ è¿›é˜Ÿåˆ—æˆåŠŸ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRunning</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> workQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å†æ¬¡æ£€æŸ¥çº¿ç¨‹æ± çŠ¶æ€ï¼Œå› ä¸ºä¸Šé¢æ·»åŠ äº†ä»»åŠ¡åˆ°å·¥ä½œé˜Ÿåˆ—ï¼Œå¯èƒ½è¦åˆ›å»ºæ–°çš„çº¿ç¨‹</span>
            <span class="token keyword">int</span> recheck <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å¦‚æœçº¿ç¨‹æ± ä¸æ˜¯è¿è¡ŒçŠ¶æ€ï¼Œé‚£ä¹ˆä»é˜Ÿåˆ—åˆ é™¤è¯¥ä»»åŠ¡ï¼Œå¹¶å°è¯•åœæ­¢çº¿ç¨‹æ± ï¼Œæ‹’ç»ä»»åŠ¡</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isRunning</span><span class="token punctuation">(</span>recheck<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">remove</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token function">reject</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å¦åˆ™å¦‚æœæ˜¯è¿è¡ŒçŠ¶æ€ï¼Œä½†æ˜¯å½“å‰å·¥ä½œçº¿ç¨‹æ•°é‡ä¸º0ï¼Œé‚£ä¹ˆæ·»åŠ ä¸€ä¸ªç©ºä»»åŠ¡ï¼Œå³åˆ›å»ºæ–°çš„çº¿ç¨‹</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">workerCountOf</span><span class="token punctuation">(</span>recheck<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token function">addWorker</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å¦åˆ™å¦‚æœæ ¸å¿ƒçº¿ç¨‹æ•°å·²æ»¡ï¼Œå¹¶ä¸”é˜Ÿåˆ—å·²æ»¡ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªä»»åŠ¡çº¿ç¨‹ï¼Œå¦‚æœå¤±è´¥ï¼Œè¯´æ˜çº¿ç¨‹æ•°å·²ç»è¾¾åˆ°æœ€å¤§ï¼Œé‚£ä¹ˆæ‹’ç»ä»»åŠ¡</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">addWorker</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ThreadPoolExecutor#addWorker</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * åˆ›å»ºçº¿ç¨‹
     * ç¬¬ä¸€ä¸ªå‚æ•°firstTaskï¼Œå¦‚æœä¸ä¸ºç©ºé‚£å°±æ˜¯åŒ…å«æ–°ä»»åŠ¡ï¼Œå¦åˆ™åªæ˜¯åˆ›å»ºæ–°çº¿ç¨‹ï¼Œä»å·¥ä½œé˜Ÿåˆ—é‡Œæ‹¿ä»»åŠ¡æ‰§è¡Œ
     * å¦‚æœcoreä¸ºtrueï¼Œè¦åˆ¤æ–­çº¿ç¨‹æ•°æ˜¯å¦è¾¾åˆ°æ ¸å¿ƒçº¿ç¨‹æ•°
     * å¦‚æœcoreä¸ºfalseï¼Œè¦åˆ¤æ–­çº¿ç¨‹æ•°æ˜¯å¦è¾¾åˆ°æœ€å¤§çº¿ç¨‹æ•°
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">addWorker</span><span class="token punctuation">(</span>Runnable firstTask<span class="token punctuation">,</span> <span class="token keyword">boolean</span> core<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        retry<span class="token operator">:</span>
        <span class="token comment" spellcheck="true">// çŠ¶æ€çš„æ£€æµ‹å’Œæ›´æ–°</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> rs <span class="token operator">=</span> <span class="token function">runStateOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å¦‚æœçº¿ç¨‹æ± ä¸ºSTOPï¼ŒTIDYINGï¼ŒTERMINATEDçŠ¶æ€ï¼Œç›´æ¥æ‹’ç»</span>
            <span class="token comment" spellcheck="true">// å¦‚æœçº¿ç¨‹æ± ä¸ºSHUTDOWNçŠ¶æ€ï¼Œè™½ç„¶ä¸å…è®¸æäº¤æ–°ä»»åŠ¡ï¼Œä½†æ˜¯å·²æäº¤çš„ä»»åŠ¡è¦å®Œæˆï¼Œæ‰€ä»¥æ˜¯å…è®¸åˆ›å»ºçº¿ç¨‹çš„</span>
            <span class="token comment" spellcheck="true">// å½“ä¸ºSHUTDOWNæ—¶ï¼ŒfirstTaskå¿…é¡»ä¸ºç©ºï¼Œå› ä¸ºä¸å…è®¸æäº¤æ–°ä»»åŠ¡ï¼Œå¦å¤–workQueueå¦‚æœä¸ºç©ºçš„è¯ï¼Œé‚£å°±æ²¡äº‹å¯å¹²äº†ï¼Œä¸å…è®¸åˆ›å»ºæ–°çº¿ç¨‹</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>rs <span class="token operator">>=</span> SHUTDOWN <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>rs <span class="token operator">==</span> SHUTDOWN <span class="token operator">&amp;&amp;</span> firstTask <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>workQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è‡ªæ—‹é‡è¯•</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// çº¿ç¨‹çš„æ•°é‡</span>
                <span class="token keyword">int</span> wc <span class="token operator">=</span> <span class="token function">workerCountOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å¦‚æœçº¿ç¨‹æ•°é‡å·²ç»æº¢å‡ºé‚£å°±ç›´æ¥è¿”å›</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>wc <span class="token operator">>=</span> CAPACITY <span class="token operator">||</span> wc <span class="token operator">>=</span> <span class="token punctuation">(</span>core <span class="token operator">?</span> corePoolSize <span class="token operator">:</span> maximumPoolSize<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å¦‚æœCASå°†çº¿ç¨‹æ•°è‡ªå¢æˆåŠŸï¼Œåˆ™é€€å‡ºå¤–å¾ªç¯ï¼Œå¦åˆ™é‡è¯•</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndIncrementWorkerCount</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">break</span> retry<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// CASä¸æˆåŠŸï¼Œè¯´æ˜å­˜åœ¨ç«äº‰ï¼Œé‡æ–°è·å–çº¿ç¨‹çŠ¶æ€</span>
                c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// Re-read ctl</span>
                <span class="token comment" spellcheck="true">// æ£€æŸ¥çº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€ï¼Œå¦‚æœä¸ä¹‹å‰çš„çŠ¶æ€ä¸åŒï¼Œåˆ™ä»å¤–å¾ªç¯é‡æ–°å¼€å§‹</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">runStateOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">!=</span> rs<span class="token punctuation">)</span>
                    <span class="token keyword">continue</span> retry<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// else CAS failed due to workerCount change; retry inner loop</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ•°è‡ªå¢æˆåŠŸååˆ™å‡†å¤‡åˆ›å»ºçº¿ç¨‹ï¼ŒåŒ…è£…æˆWorker</span>
        <span class="token keyword">boolean</span> workerStarted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> workerAdded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        ThreadPoolExecutor<span class="token punctuation">.</span>Worker w <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ·»åŠ ä»»åŠ¡åˆ°çº¿ç¨‹æ± ï¼Œå¹¶å¯åŠ¨ä»»åŠ¡æ‰€åœ¨çš„çº¿ç¨‹</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// åˆ›å»ºWorkerï¼ŒåŒæ—¶ä¹Ÿåˆ›å»ºäº†çº¿ç¨‹ï¼Œå¹¶ä¸”æŒ‡å®šfirstTaskä¸ºWorkerçš„ç¬¬ä¸€ä¸ªä»»åŠ¡</span>
            w <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor<span class="token punctuation">.</span>Worker</span><span class="token punctuation">(</span>firstTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è·å–Workerå¯¹åº”çš„çº¿ç¨‹</span>
            <span class="token keyword">final</span> Thread t <span class="token operator">=</span> w<span class="token punctuation">.</span>thread<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> ReentrantLock mainLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mainLock<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// è·å–é”</span>
                mainLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">int</span> rs <span class="token operator">=</span> <span class="token function">runStateOf</span><span class="token punctuation">(</span>ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// RUNNING || SHUTDOWNçŠ¶æ€ï¼Œä½†æ˜¯éœ€è¦å®Œæˆå·¥ä½œé˜Ÿåˆ—é‡Œçš„ä»»åŠ¡</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>rs <span class="token operator">&lt;</span> SHUTDOWN <span class="token operator">||</span> <span class="token punctuation">(</span>rs <span class="token operator">==</span> SHUTDOWN <span class="token operator">&amp;&amp;</span> firstTask <span class="token operator">==</span> null<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalThreadStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// å°†Workerå¯¹è±¡æ·»åŠ åˆ°çº¿ç¨‹æ± çš„Workeré›†åˆä¸­</span>
                        workers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">int</span> s <span class="token operator">=</span> workers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// è®°å½•çº¿ç¨‹æ± çš„çº¿ç¨‹æ•°æœ€å¤§å€¼</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">></span> largestPoolSize<span class="token punctuation">)</span>
                            largestPoolSize <span class="token operator">=</span> s<span class="token punctuation">;</span>
                        workerAdded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// é‡Šæ”¾é”</span>
                    mainLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// å¦‚æœæˆåŠŸå°†ä»»åŠ¡æ·»åŠ åˆ°çº¿ç¨‹æ± ä¸­ï¼Œåˆ™å¯åŠ¨çº¿ç¨‹</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>workerAdded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    t<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    workerStarted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// åœ¨å¯åŠ¨å·¥ä½œçº¿ç¨‹å¤±è´¥åï¼Œå°†å·¥ä½œçº¿ç¨‹ä»é›†åˆä¸­ç§»é™¤ï¼Œå¹¶å°†çº¿ç¨‹æ•°é€’å‡ï¼Œå½“ç„¶æ˜¯æœ‰é”çš„</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>workerStarted<span class="token punctuation">)</span>
                <span class="token function">addWorkerFailed</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// è¿”å›ä»»åŠ¡æ˜¯å¦å¯åŠ¨</span>
        <span class="token keyword">return</span> workerStarted<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ThreadPoolExecutor$Worker</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * ç»§æ‰¿äº†AQSï¼Œå®ç°äº†Runnableï¼Œæ‰€ä»¥æ˜¯çº¿ç¨‹ï¼Œä¹Ÿæ˜¯é”ï¼Œä½†æ˜¯ä¸å¯é‡å…¥
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Worker</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractQueuedSynchronizer</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>

        <span class="token comment" spellcheck="true">/**
         * å·¥ä½œçš„çº¿ç¨‹
         */</span>
        <span class="token keyword">final</span> Thread thread<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * åˆ›å»ºWorkeræ—¶æŒ‡å®šçš„ä»»åŠ¡ï¼Œå¦‚æœæœ‰çš„è¯
         */</span>
        Runnable firstTask<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * å®Œæˆçš„ä»»åŠ¡æ•°
         */</span>
        <span class="token keyword">volatile</span> <span class="token keyword">long</span> completedTasks<span class="token punctuation">;</span>

        <span class="token function">Worker</span><span class="token punctuation">(</span>Runnable firstTask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è®¾ç½®AQSçš„åŒæ­¥çŠ¶æ€ä¸º-1ï¼Œé˜²æ­¢runWorkerå‰ï¼Œçº¿ç¨‹æ²¡å¯åŠ¨å°±è¢«interruptä¸­æ–­ï¼Œç›´åˆ°è°ƒç”¨runWorkerï¼Œæ‰è®¾ä¸º0</span>
            <span class="token comment" spellcheck="true">// å¦å¤–å¦‚æœå¤§äº0ï¼Œè¯´æ˜é”è¢«è·å–</span>
            <span class="token function">setState</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// inhibit interrupts until runWorker</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>firstTask <span class="token operator">=</span> firstTask<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// é€šè¿‡çº¿ç¨‹å·¥å‚æ¥åˆ›å»ºçº¿ç¨‹</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>thread <span class="token operator">=</span> <span class="token function">getThreadFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newThread</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>ThreadPoolExecutor$Worker#run</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">runWorker</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>ThreadPoolExecutor$Worker#runWorker</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">runWorker</span><span class="token punctuation">(</span>ThreadPoolExecutor<span class="token punctuation">.</span>Worker w<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Thread wt <span class="token operator">=</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Runnable task <span class="token operator">=</span> w<span class="token punctuation">.</span>firstTask<span class="token punctuation">;</span>
        w<span class="token punctuation">.</span>firstTask <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å…è®¸ä¸­æ–­</span>
        w<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// allow interrupts</span>
        <span class="token keyword">boolean</span> completedAbruptly <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ä¸æ–­ä»å·¥ä½œé˜Ÿåˆ—é‡Œå–å‡ºä»»åŠ¡æ‰§è¡Œ</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>task <span class="token operator">!=</span> null <span class="token operator">||</span> <span class="token punctuation">(</span>task <span class="token operator">=</span> <span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// è·å–Workerçš„é”ï¼Œä¸æ˜¯å› ä¸ºå¹¶å‘ï¼Œè€Œæ˜¯é¿å…è¿è¡Œä¸­è¢«shutdown</span>
                w<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å¦‚æœçº¿ç¨‹æ± çŠ¶æ€ä¸ºSTOPï¼ŒTIDYINGï¼ŒTERMINATEDï¼Œé‚£ä¹ˆä¸­æ–­å½“å‰çº¿ç¨‹</span>
                <span class="token comment" spellcheck="true">// å¦åˆ™ï¼Œåˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦è¢«æ ‡è®°ä¸ºä¸­æ–­ï¼ŒåŒæ—¶ä¼šæ¸…é™¤ä¸­æ–­æ ‡è®°ï¼Œå¦‚æœè¢«æ ‡è®°ä¸ºä¸­æ–­ï¼Œé‚£ä¹ˆå†æ¬¡åˆ¤æ–­çŠ¶æ€ï¼Œå¦‚æœå¤§äºç­‰äºSTOPï¼Œå¹¶ä¸”æ²¡æœ‰ä¸­æ–­æ ‡è®°ï¼Œé‚£ä¹ˆå°±ä¸­æ–­å½“å‰çº¿ç¨‹</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">runStateAtLeast</span><span class="token punctuation">(</span>ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> STOP<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">runStateAtLeast</span><span class="token punctuation">(</span>ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> STOP<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>wt<span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    wt<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ä»»ä½•ä¸ŠæŠ›çš„å¼‚å¸¸éƒ½ä¼šå¯¼è‡´å½“å‰çº¿ç¨‹é€€å‡ºæ­»äº¡</span>
                    <span class="token function">beforeExecute</span><span class="token punctuation">(</span>wt<span class="token punctuation">,</span> task<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    Throwable thrown <span class="token operator">=</span> null<span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// æ‰§è¡Œä»»åŠ¡</span>
                        task<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        thrown <span class="token operator">=</span> x<span class="token punctuation">;</span>
                        <span class="token keyword">throw</span> x<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Error</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        thrown <span class="token operator">=</span> x<span class="token punctuation">;</span>
                        <span class="token keyword">throw</span> x<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        thrown <span class="token operator">=</span> x<span class="token punctuation">;</span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">//</span>
                        <span class="token function">afterExecute</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> thrown<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å‡†å¤‡ä¸‹ä¸€ä¸ª</span>
                    task <span class="token operator">=</span> null<span class="token punctuation">;</span>
                    w<span class="token punctuation">.</span>completedTasks<span class="token operator">++</span><span class="token punctuation">;</span>
                    w<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// whileå¾ªç¯ç»“æŸ</span>
            <span class="token comment" spellcheck="true">// æ˜¯æ­£å¸¸å®Œæˆï¼Œè€Œä¸æ˜¯å› ä¸ºçº¿ç¨‹è¿è¡Œæ—¶æŠ›å‡ºå¼‚å¸¸è€Œçªç„¶è·³å‡º</span>
            completedAbruptly <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å¯èƒ½æ˜¯é˜Ÿåˆ—ä»»åŠ¡å…¨éƒ¨å®Œæˆæˆ–è€…çº¿ç¨‹è¿è¡Œä¸­æŠ›å‡ºäº†å¼‚å¸¸ï¼Œé‚£ä¹ˆé€€å‡ºå½“å‰Workerï¼Œå½“å‰çº¿ç¨‹å°±æ²¡äº†</span>
            <span class="token function">processWorkerExit</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> completedAbruptly<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>ThreadPoolExecutor#getTask</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> Runnable <span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> timedOut <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Did the last poll() time out?</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> rs <span class="token operator">=</span> <span class="token function">runStateOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// æ»¡è¶³æ¡ä»¶æ‰èƒ½å–å‡ºä»»åŠ¡æ‰§è¡Œ</span>
            <span class="token comment" spellcheck="true">// å¦‚æœçº¿ç¨‹æ± çŠ¶æ€ä¸ºSHUTDOWNï¼Œå½“å·¥ä½œé˜Ÿåˆ—ä¸ºç©ºæ—¶æ‰ä¸ç»§ç»­æ‰§è¡Œ</span>
            <span class="token comment" spellcheck="true">// å¦‚æœçº¿ç¨‹æ± çŠ¶æ€ä¸ºSTOPï¼Œé‚£ä¹ˆä¸ç®¡å·¥ä½œé˜Ÿåˆ—é‡Œè¿˜æœ‰æ²¡æœ‰ä»»åŠ¡ï¼Œéƒ½ä¸æ‰§è¡Œ</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>rs <span class="token operator">>=</span> SHUTDOWN <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>rs <span class="token operator">>=</span> STOP <span class="token operator">||</span> workQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">decrementWorkerCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">int</span> wc <span class="token operator">=</span> <span class="token function">workerCountOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å¦‚æœå…è®¸æ ¸å¿ƒçº¿ç¨‹è¶…æ—¶æˆ–è€…å½“å‰çº¿ç¨‹æ•°å·²ç»è¶…è¿‡æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œé‚£ä¹ˆæœ‰è¶…æ—¶è¦æ±‚</span>
            <span class="token keyword">boolean</span> timed <span class="token operator">=</span> allowCoreThreadTimeOut <span class="token operator">||</span> wc <span class="token operator">></span> corePoolSize<span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// å¦‚æœçº¿ç¨‹æ•°é‡è¶…å‡ºæœ€å¤§é™åˆ¶ï¼Œé‚£ä¹ˆCASå°è¯•å‡å°‘çº¿ç¨‹æ•°é‡ï¼Œè¿”å›årunWorkerçš„processWorkerExitä¸­Workerçº¿ç¨‹å°±ä¼šé€€å‡º</span>
            <span class="token comment" spellcheck="true">// å¦‚æœæ•°é‡æ²¡æœ‰è¶…å‡ºé™åˆ¶ï¼Œä½†æ˜¯è¶…å‡ºäº†æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œä¸Šæ¬¡ä»å·¥ä½œé˜Ÿåˆ—è·å–ä»»åŠ¡è¶…æ—¶çš„è¯ï¼Œä¹Ÿæ˜¯ä¸€æ ·çš„</span>
            <span class="token comment" spellcheck="true">// å¦å¤–ä¸Šé¢ä¸¤ä¸ªè¿˜æœ‰é™„åŠ æ¡ä»¶ï¼Œå³ï¼Œå½“å‰å­˜åœ¨å·¥ä½œçº¿ç¨‹ï¼Œæˆ–è€…ä¸å­˜åœ¨å·¥ä½œçº¿ç¨‹ï¼Œä½†æ˜¯å·¥ä½œé˜Ÿåˆ—ä¸ºç©º</span>
            <span class="token comment" spellcheck="true">// è¿™ä¸ªæ¡ä»¶çŸ­è·¯çœ‹å¾—æˆ‘å¤´å¤§ï¼Œä¸€èˆ¬è¿™é‡Œæ˜¯ä¸ä¼šè¶…å‡ºmaximumPoolSizeçš„ï¼Œé™¤éåæ¥åˆæ‰‹åŠ¨è°ƒæ•´äº†maximumPoolSizeå¤§å°</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>wc <span class="token operator">></span> maximumPoolSize <span class="token operator">||</span> <span class="token punctuation">(</span>timed <span class="token operator">&amp;&amp;</span> timedOut<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>wc <span class="token operator">></span> <span class="token number">1</span> <span class="token operator">||</span> workQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndDecrementWorkerCount</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æ ¹æ®æœ‰æ— è¶…æ—¶é™åˆ¶ï¼Œä»å·¥ä½œé˜Ÿåˆ—é˜»å¡è·å–ä»»åŠ¡</span>
                Runnable r <span class="token operator">=</span> timed <span class="token operator">?</span> workQueue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span>keepAliveTime<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>NANOSECONDS<span class="token punctuation">)</span> <span class="token operator">:</span> workQueue<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// æœ‰å°±è¿”å›</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> null<span class="token punctuation">)</span>
                    <span class="token keyword">return</span> r<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// è¶…æ—¶è¿˜æ²¡æœ‰</span>
                timedOut <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> retry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æ•æ‰Workerçº¿ç¨‹çš„ä¸­æ–­å¼‚å¸¸ï¼Œä¸ç®—è¶…æ—¶ï¼Œç»§ç»­</span>
                timedOut <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>ThreadPoolExecutor#processWorkerExit</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processWorkerExit</span><span class="token punctuation">(</span>ThreadPoolExecutor<span class="token punctuation">.</span>Worker w<span class="token punctuation">,</span> <span class="token keyword">boolean</span> completedAbruptly<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// å¦‚æœæ˜¯çº¿ç¨‹è¿è¡Œä¸­æŠ›å‡ºå¼‚å¸¸è€Œé€€å‡ºï¼Œé‚£ä¹ˆè¦æŠŠçº¿ç¨‹æ•°é‡å‡ä¸€ï¼Œè€Œå¦‚æœæ˜¯å› ä¸ºæ²¡ä»»åŠ¡è€Œé€€å‡ºçš„è¯ï¼Œåœ¨getTaské‡Œè¾¹å°±å·²ç»å‡äº†</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>completedAbruptly<span class="token punctuation">)</span>
            <span class="token function">decrementWorkerCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> ReentrantLock mainLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mainLock<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è·å–é”</span>
        mainLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            completedTaskCount <span class="token operator">+=</span> w<span class="token punctuation">.</span>completedTasks<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ç§»é™¤å½“å‰Worker</span>
            workers<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            mainLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// æ¯ä¸ªWorkeré€€å‡ºæ—¶éƒ½ä¼šå°è¯•ç»ˆæ­¢çº¿ç¨‹æ± ï¼Œå½“ç„¶ä¸ä¸€å®šä¼šç»ˆæ­¢</span>
        <span class="token function">tryTerminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¦‚æœå½“å‰çº¿ç¨‹æ± çŠ¶æ€æ˜¯Runningæˆ–Shutdownï¼Œæ‰€ä»¥Shutdownä¹Ÿå¯èƒ½ä¼šåˆ›å»ºæ–°çš„çº¿ç¨‹</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">runStateLessThan</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> STOP<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å¦‚æœæ˜¯å› ä¸ºæ²¡æœ‰ä»»åŠ¡è€Œé€€å‡ºçš„ï¼Œè¿˜è¦è®¡ç®—è¦ä¸è¦å¢å†åŠ ä¸€ä¸ªæ–°çš„Workerçº¿ç¨‹</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>completedAbruptly<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> min <span class="token operator">=</span> allowCoreThreadTimeOut <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> corePoolSize<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å¦‚æœä¸éœ€è¦ç»´æŒæ ¸å¿ƒçº¿ç¨‹ï¼Œä½†æ˜¯å·¥ä½œçº¿ç¨‹è¿˜æœ‰ä»»åŠ¡ï¼Œé‚£ä¹ˆè‡³å°‘å¾—ç•™ä¸€ä¸ªçº¿ç¨‹</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>min <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>workQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    min <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// çº¿ç¨‹æ•°è¶³å¤Ÿï¼Œä¸ç”¨å¢åŠ </span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">workerCountOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">>=</span> min<span class="token punctuation">)</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// åˆ›å»ºä¸€ä¸ªæ–°çš„Workerçº¿ç¨‹</span>
            <span class="token function">addWorker</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>ThreadPoolExecutor#shutdown</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * ä¸æ¥å—æ–°ä»»åŠ¡ï¼Œä½†æ˜¯ä¼šæŠŠä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡å…¨éƒ¨æ‰§è¡Œå®Œ
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> ReentrantLock mainLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mainLock<span class="token punctuation">;</span>
        mainLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">checkShutdownAccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// æ£€æµ‹æƒé™</span>
            <span class="token function">advanceRunState</span><span class="token punctuation">(</span>SHUTDOWN<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// è‡ªæ—‹CASä¿®æ”¹è¿è¡ŒçŠ¶æ€ä¸ºSHUTDOWN</span>
            <span class="token function">interruptIdleWorkers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// éå†åœæ­¢æœªå¼€å¯çš„çº¿ç¨‹</span>
            <span class="token function">onShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// hook for ScheduledThreadPoolExecutor</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            mainLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">tryTerminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ThreadPoolExecutor#interruptIdleWorkers</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">interruptIdleWorkers</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> onlyOne<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> ReentrantLock mainLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mainLock<span class="token punctuation">;</span>
        mainLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// éå†æ‰€æœ‰çº¿ç¨‹</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>ThreadPoolExecutor<span class="token punctuation">.</span>Worker w <span class="token operator">:</span> workers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Thread t <span class="token operator">=</span> w<span class="token punctuation">.</span>thread<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// åªæœ‰ç©ºé—²çš„Workeræ‰èƒ½è·å–é”ï¼Œè·å–ä¸åˆ°å°±è·³è¿‡</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>t<span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> w<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        t<span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SecurityException</span> ignore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                        w<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>onlyOne<span class="token punctuation">)</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            mainLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>ThreadPoolExecutor#tryTerminate</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">tryTerminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// RunningçŠ¶æ€ä¸ç»ˆæ­¢</span>
            <span class="token comment" spellcheck="true">// TIDYINGæˆ–TERMINATEDï¼Œå·²ç»ç»ˆæ­¢è¿‡äº†ä¸å†ç»ˆæ­¢</span>
            <span class="token comment" spellcheck="true">// SHUTDOWNä¸”å·¥ä½œé˜Ÿåˆ—è¿˜æœ‰ä»»åŠ¡ä¹Ÿä¸èƒ½ç»ˆæ­¢</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRunning</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">runStateAtLeast</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> TIDYING<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token function">runStateOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">==</span> SHUTDOWN <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>workQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// è¿›è¡Œåˆ°è¿™é‡Œï¼Œè¯´æ˜çŠ¶æ€ä¸ºSTOPï¼Œæˆ–è€…SHUTDOWNå¹¶ä¸”å·¥ä½œé˜Ÿåˆ—ä¸ºç©º</span>

            <span class="token comment" spellcheck="true">// è¿˜æœ‰æ­£åœ¨å·¥ä½œçš„çº¿ç¨‹</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">workerCountOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å°è¯•ä¸­æ–­ä¸€ä¸ªç©ºé—²çš„çº¿ç¨‹ï¼Œå› ä¸ºæ¯ä¸ªWorkerçº¿ç¨‹é€€å‡ºæ—¶éƒ½ä¼šè°ƒç”¨ThreadPoolExecutor#tryTerminateæ–¹æ³•ï¼Œæ‰€ä»¥ä¸ç”¨æ‹…å¿ƒ</span>
                <span class="token function">interruptIdleWorkers</span><span class="token punctuation">(</span>ONLY_ONE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">// åˆ°è¿™é‡Œè¯´æ˜çº¿ç¨‹æ± å·²ç»æ²¡æœ‰çº¿ç¨‹äº†</span>

            <span class="token keyword">final</span> ReentrantLock mainLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mainLock<span class="token punctuation">;</span>
            mainLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// CASä¿®æ”¹çŠ¶æ€ä¸ºTIDYINGæˆåŠŸ</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ctl<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token function">ctlOf</span><span class="token punctuation">(</span>TIDYING<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// æ‰§è¡Œç»ˆæ­¢å›è°ƒï¼Œé»˜è®¤ä¸ºç©ºæ–¹æ³•</span>
                        <span class="token function">terminated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ä¿®æ”¹çŠ¶æ€ä¸ºTERMINATED</span>
                        ctl<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token function">ctlOf</span><span class="token punctuation">(</span>TERMINATED<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        termination<span class="token punctuation">.</span><span class="token function">signalAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                mainLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// else retry on failed CAS</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>çº¿ç¨‹æ± çš„ä½œç”¨ï¼š</p>
<ul>
<li><p>å‡å°‘äº†åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹çš„æ¬¡æ•°ï¼Œæ¯ä¸ªå·¥ä½œçº¿ç¨‹éƒ½å¯ä»¥è¢«é‡å¤åˆ©ç”¨</p>
</li>
<li><p>è°ƒæ•´çº¿ç¨‹æ± ä¸­å·¥ä½œçº¿ç¨‹çš„æ•°é‡ï¼Œé™æµä½œç”¨</p>
</li>
</ul>
<p>å»ºè®®ï¼š</p>
<ul>
<li><p>CPUå¯†é›†å‹ï¼šé¿å…çº¿ç¨‹äº‰æŠ¢èµ„æºï¼Œæ— ç”¨çš„åˆ‡æ¢çº¿ç¨‹ä¸Šä¸‹æ–‡ï¼Œé…ç½®å°½é‡å°‘çš„çº¿ç¨‹ï¼Œæ¯”å¦‚CPUä¸ªæ•°ï¼›</p>
</li>
<li><p>IOå¯†é›†å‹ï¼šéœ€è¦é•¿æ—¶é—´ç­‰å¾…ï¼Œå¯ä»¥é…ç½®å¤šä¸€äº›çº¿ç¨‹ï¼Œæ¯”å¦‚CPUæ•°çš„ä¸¤å€ã€‚</p>
</li>
</ul>
<p>è·å–CPUæ ¸å¿ƒæ•°ï¼š<code>Runtime.getRuntime().availableProcessors()</code>ã€‚</p>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


        <footer>
             
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

        </footer>
    </div>
    <!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
    <script>
        var timeEnd = new Date();
        console.log('è€—æ—¶ï¼š' + (timeEnd - timeStart));
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre').forEach((block) => {
                block.classList.add("line-numbers");
            });
        });
    </script>
    <!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
    <!-- material design -->
    <!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
    <!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
    <!-- toc -->
    <!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
    <!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
    <!-- <script src="/js/main.js"></script> -->
    <script src="/js/prism.js"></script>
</body>
</html>
