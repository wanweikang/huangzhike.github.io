<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
        <script>
            var timeStart = new Date();
        </script>
        
        <title>[ç¬”è®°]-J.U.C.-ReentrantLock | ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜</title>
        
        <meta name="author" content="huangzhike">
        
        
        <meta name="description" content="2019-12-12æ›´æ–°

ReentrantLock
public class ReentrantLock implements Lock {

    private final Sync sync;

    public ReentrantLock() {
        // é»˜è®¤éå…¬å¹³é”">
        
        
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        
        <meta property="og:title" content="[ç¬”è®°]-J.U.C.-ReentrantLock"/>
        
        <meta property="og:site_name" content="ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜"/>
        
        
        <!-- favicon -->
        <link rel="icon" type="image/ico" href="/ok.ico" sizes="32x32">
        <meta name="msapplication-TileColor" content="#009688">
        <meta name="msapplication-TileImage" content="/mstile-144x144.ico">
        <meta name="theme-color" content="#009688">
        <!-- favicon end -->
        <!-- <link href="//ok.ico" rel="icon"> -->
        
        <!-- toc -->
        <!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
        <!-- material design -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
        <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
        
        <!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
        <!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
    <meta name="generator" content="Hexo 4.2.1"></head>

<body>
    <nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">èœå•</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" title="ä¸‹ä¸€å¥æ˜¯ï¼šå®¢æœ‰å¯äººæœŸä¸æ¥ã€‚å°æ—¶å€™ï¼Œå–œæ¬¢é åœ¨é˜³å°ä¸Šï¼Œä¸€è¾¹å¹é£ï¼Œä¸€è¾¹çœ‹ä¹¦ï¼Œå–œæ¬¢è¯»ä¹¦å—ï¼Œéªšå¹´ï¼Ÿ" href="/">ä¹¦å½“å¿«æ„è¯»æ˜“å°½</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" target="_blank" rel="noopener" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

    <div class="container" >
        <div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[ç¬”è®°]-J.U.C.-ReentrantLock</h2>
				
				<div>
					<div class="post-time">2019-04-20</div>
				</div>
				
				<div class="article-content">
				<p>2019-12-12æ›´æ–°</p>
<hr>
<p>ReentrantLock</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReentrantLock</span> <span class="token keyword">implements</span> <span class="token class-name">Lock</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> Sync sync<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// é»˜è®¤éå…¬å¹³é”</span>
        sync <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NonfairSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">ReentrantLock</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> fair<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sync <span class="token operator">=</span> fair <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">FairSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">NonfairSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>ReentrantLock$Sync</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">abstract</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Sync</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractQueuedSynchronizer</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span></code></pre>
<p>ReentrantLock$NonfairSync</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">NonfairSync</span> <span class="token keyword">extends</span> <span class="token class-name">Sync</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span></code></pre>
<p>ReentrantLock$FairSync</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">FairSync</span> <span class="token keyword">extends</span> <span class="token class-name">Sync</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>ReentrantLock#lock</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * é˜»å¡è·å–é”
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sync<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>å…ˆä»¥å…¬å¹³ä¸ºä¾‹</p>
<p>ReentrantLock$FairSync#lock</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å…¬å¹³é”ç›´æ¥è°ƒç”¨AbstractQueuedSynchronizer#acquireï¼ŒæŒ‰AQSé˜Ÿåˆ—å…ˆåè·å–</span>
            <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>AbstractQueuedSynchronizer#acquire</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * å°è¯•è·å–ç‹¬å é”ï¼Œå¦‚æœè·å–ä¸åˆ°ï¼ŒåŠ å…¥ç­‰å¾…é˜Ÿåˆ—ç­‰å¾…è¢«å”¤é†’ï¼Œå¦‚æœè¢«ä¸­æ–­åˆ™ä¸­æ­¢
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// é¦–å…ˆå°è¯•è·å–é”ï¼Œè·å–æˆåŠŸç›´æ¥è¿”å›ï¼Œé”ç©ºé—²å¹¶ä¸”æ²¡æœ‰ç«äº‰çš„è¯ä¸€èˆ¬éƒ½ä¼šæˆåŠŸï¼Œä¸éœ€è¦å…¥é˜Ÿåˆ—</span>
        <span class="token comment" spellcheck="true">// å‡å¦‚è·å–å¤±è´¥ï¼Œåˆ™å°†å½“å‰çº¿ç¨‹åŠ å…¥åˆ°AQSé˜Ÿåˆ—å°¾ï¼Œç„¶ååœ¨AQSé˜Ÿåˆ—ä¸­é˜»å¡ç­‰å¾…è·å–é”ï¼Œç›´åˆ°è·å–é”äº†æ‰è¿”å›</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">acquireQueued</span><span class="token punctuation">(</span><span class="token function">addWaiter</span><span class="token punctuation">(</span>Node<span class="token punctuation">.</span>EXCLUSIVE<span class="token punctuation">)</span><span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment" spellcheck="true">// å¦‚æœçº¿ç¨‹åœ¨é˜»å¡è¿‡ç¨‹ä¸­è¢«ä¸­æ–­è¿‡ï¼Œåˆ™å†ä¸­æ–­ä¸€æ¬¡ï¼ˆä¹‹å‰çš„è¢«æ¸…é™¤äº†ï¼‰</span>
            <span class="token function">selfInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ReentrantLock$FairSync#tryAcquire</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> acquires<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> Thread current <span class="token operator">=</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å¦‚æœé”ç©ºé—²</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å¦‚æœæ²¡æœ‰å‰é©±èŠ‚ç‚¹æ’é˜Ÿï¼ˆå…¬å¹³ï¼ŒFCFSï¼‰ &amp;&amp; CASæ›´æ–°stateæˆåŠŸ</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">hasQueuedPredecessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> acquires<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// è®¾ç½®å½“å‰çº¿ç¨‹ä¸ºé”çš„æŒæœ‰çº¿ç¨‹</span>
                    <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// è·å–é”æˆåŠŸ</span>
                    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å¦‚æœé”ä¸ç©ºé—²ï¼Œä½†å½“å‰çº¿ç¨‹å°±æ˜¯é”çš„æŒæœ‰çº¿ç¨‹ï¼Œè¯´æ˜æ˜¯é‡å…¥</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">==</span> <span class="token function">getExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// é‡å…¥æ¬¡æ•°å¢åŠ </span>
                <span class="token keyword">int</span> nextc <span class="token operator">=</span> c <span class="token operator">+</span> acquires<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ä½æ•°æº¢å‡ºäº†</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>nextc <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"Maximum lock count exceeded"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ä¸ç”¨CASï¼Œå› ä¸ºç‹¬å é”æ˜¯å½“å‰çº¿ç¨‹æŒæœ‰ï¼Œæ²¡æœ‰ç«äº‰</span>
                <span class="token function">setState</span><span class="token punctuation">(</span>nextc<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// è·å–é”æˆåŠŸ</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>AbstractQueuedSynchronizer#addWaiter</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * å°†å½“å‰çº¿ç¨‹æ·»åŠ åˆ°AQSé˜Ÿå°¾ï¼Œç­‰å¾…è·å–é”
     */</span>
    <span class="token keyword">private</span> Node <span class="token function">addWaiter</span><span class="token punctuation">(</span>Node mode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// å°†çº¿ç¨‹åŒ…è£…æˆèŠ‚ç‚¹</span>
        Node node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Node pred <span class="token operator">=</span> tail<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¦‚æœé˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œå°è¯•ç›´æ¥æŒ‚åˆ°AQSåŒæ­¥é˜Ÿåˆ—é˜Ÿå°¾</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pred <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            node<span class="token punctuation">.</span>prev <span class="token operator">=</span> pred<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// CASæ›´æ–°å°¾èŠ‚ç‚¹çš„å¼•ç”¨</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetTail</span><span class="token punctuation">(</span>pred<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                pred<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span>
                <span class="token keyword">return</span> node<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œæˆ–è€…åŒæ—¶æœ‰å¤šä¸ªçº¿ç¨‹éƒ½æŠŠè‡ªå·±æŒ‚åˆ°é˜Ÿå°¾ï¼ŒCASå°±ä¼šå¤±è´¥ï¼Œé‚£ä¹ˆå¾ªç¯è‡³æˆåŠŸ</span>
        <span class="token function">enq</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> node<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>AbstractQueuedSynchronizer#enq</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * è‡ªæ—‹ç›´åˆ°æˆåŠŸåŠ åˆ°AQSé˜Ÿå°¾ï¼Œè¿”å›å‰ç»§èŠ‚ç‚¹ï¼Œå³åŸæœ¬çš„å°¾èŠ‚ç‚¹
     * å…³äºAQSé˜Ÿåˆ—çš„å¤´èŠ‚ç‚¹ï¼Œå®ƒæ˜¯ä¸€ä¸ªç©ºèŠ‚ç‚¹ï¼Œä»£è¡¨å½“å‰æŒæœ‰é”çš„çº¿ç¨‹ï¼Œå¯ä»¥é˜²æ­¢é‡å¤é‡Šæ”¾é”
     * æ¯ä¸ªèŠ‚ç‚¹åœ¨é˜»å¡å‰ï¼Œéƒ½è¦å°†å‰é©±èŠ‚ç‚¹è®¾æˆSIGNALï¼Œè¡¨ç¤ºï¼Œå½“è¯¥å‰é©±èŠ‚ç‚¹é‡Šæ”¾é”çš„æ—¶å€™ï¼Œéœ€è¦å”¤é†’åç»§èŠ‚ç‚¹ï¼Œå¦åˆ™ä¼šå¯¼è‡´æ­»é”
     * ä½†æ˜¯ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ²¡æœ‰å‰é©±èŠ‚ç‚¹ï¼Œæ‰€ä»¥ä¼šåˆ›å»ºä¸€ä¸ªç©ºèŠ‚ç‚¹
     */</span>
    <span class="token keyword">private</span> Node <span class="token function">enq</span><span class="token punctuation">(</span><span class="token keyword">final</span> Node node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// è‡ªæ—‹</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Node t <span class="token operator">=</span> tail<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// åŸæœ¬çš„å°¾èŠ‚ç‚¹ä¸ºnullï¼Œè¯´æ˜è¿˜æ²¡åˆå§‹åŒ–ï¼Œé‚£ä¹ˆå°±åˆ›å»ºä¸€ä¸ªç©ºèŠ‚ç‚¹ï¼ŒCASè®¾ä¸ºå¤´èŠ‚ç‚¹ï¼ŒæˆåŠŸå°±å°†å°¾èŠ‚ç‚¹ä¹ŸæŒ‡å‘å®ƒ</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// Must initialize</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetHead</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    tail <span class="token operator">=</span> head<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å¦åˆ™ï¼Œå°†å½“å‰èŠ‚ç‚¹ä½œä¸ºæ–°çš„å°¾èŠ‚ç‚¹åŠ å…¥åˆ°AQSé˜Ÿå°¾</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                node<span class="token punctuation">.</span>prev <span class="token operator">=</span> t<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// CASå°†è¯¥èŠ‚ç‚¹è®¾ç½®ä¸ºæ–°çš„å°¾èŠ‚ç‚¹</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetTail</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    t<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span>
                    <span class="token keyword">return</span> t<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">/*
                 * æ³¨æ„è¿™ä¸ªå…¥é˜Ÿå°¾çš„æ“ä½œé¡ºåºï¼Œå› ä¸ºè¿™äº›æ“ä½œä¸æ˜¯åŸå­çš„ï¼Œåœ¨åˆ«çš„çº¿ç¨‹å¹¶å‘éå†çš„æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼šè¯»åˆ°è¢«ç ´åçš„é˜Ÿåˆ—ç»“æ„
                 * æ‰€ä»¥è¿™é‡Œæ˜¯å…ˆæŠŠæ–°å…¥é˜Ÿçš„èŠ‚ç‚¹çš„å‰æŒ‡é’ˆæŒ‡å‘åŸé˜Ÿå°¾ï¼Œå†CASæ›´æ–°ä¸ºæ–°çš„å°¾èŠ‚ç‚¹ï¼Œè€Œéå†æ—¶åˆ™æ˜¯ä»åå‘å‰ï¼Œè¿™æ ·å°±æ²¡é—®é¢˜äº†
                 * å…·ä½“å¯ä»¥çœ‹AbstractQueuedSynchronizer#unparkSuccessorçš„é€»è¾‘
                 */</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>AbstractQueuedSynchronizer#acquireQueued</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * ä»é˜Ÿåˆ—ä¸­é˜»å¡è‡³è·å–é”ï¼Œå¹¶è¿”å›å½“å‰çº¿ç¨‹åœ¨ç­‰å¾…è¿‡ç¨‹ä¸­æœ‰æ²¡æœ‰ä¸­æ–­è¿‡
     * å¦‚æœè·å–åˆ°äº†é”ï¼Œè¿”å›ï¼Œå¦åˆ™ï¼Œå…¬å¹³é˜»å¡ç­‰å¾…ï¼Œç›´åˆ°è¢«å”¤é†’å¹¶è·å–é”äº†æ‰è¿”å›
     */</span>
    <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">acquireQueued</span><span class="token punctuation">(</span><span class="token keyword">final</span> Node node<span class="token punctuation">,</span> <span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> failed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è¡¨ç¤ºåœ¨çº¿ç¨‹é˜»å¡æ—¶ï¼Œæœ‰æ²¡æœ‰è¢«ä¸­æ–­è¿‡</span>
            <span class="token keyword">boolean</span> interrupted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è‡ªæ—‹</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å½“å‰èŠ‚ç‚¹æ˜¯é€šè¿‡å®ƒçš„å‰é©±èŠ‚ç‚¹å”¤é†’çš„</span>
                <span class="token keyword">final</span> Node p <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">predecessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å…¬å¹³é”ï¼Œå¦‚æœèŠ‚ç‚¹çš„å‰é©±æ˜¯å¤´èŠ‚ç‚¹ï¼ˆç©ºèŠ‚ç‚¹ï¼‰ï¼Œå°±å¯ä»¥å°è¯•è·å–é”</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> head <span class="token operator">&amp;&amp;</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å¦‚æœè·å–åˆ°é”ï¼Œåˆ™å°†è‡ªå·±è®¾ç½®ä¸ºæ–°çš„å¤´èŠ‚ç‚¹ï¼Œå¹¶æ¸…é™¤æ— ç”¨çš„å¼•ç”¨</span>
                    <span class="token function">setHead</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// æ¸…é™¤åŸæœ¬çš„å¤´èŠ‚ç‚¹å¯¹è‡ªå·±çš„å¼•ç”¨</span>
                    p<span class="token punctuation">.</span>next <span class="token operator">=</span> null<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// help GC</span>
                    failed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// è¿”å›æœ‰æ²¡æœ‰ä¸­æ–­</span>
                    <span class="token keyword">return</span> interrupted<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// åˆ°è¿™é‡Œè¯´æ˜å½“å‰èŠ‚ç‚¹çš„å‰é¢è¿˜æœ‰èŠ‚ç‚¹æ’é˜Ÿï¼Œæˆ–è€…æ˜¯è·å–é”å¤±è´¥</span>

                <span class="token comment" spellcheck="true">// æ£€æŸ¥æ˜¯å¦å¯ä»¥é˜»å¡å½“å‰çº¿ç¨‹ï¼Œè¿˜æ˜¯ç»§ç»­è‡ªæ—‹ï¼Œå¦‚æœé˜»å¡ï¼Œé‚£ä¹ˆå”¤é†’åå†ç»§ç»­ï¼Œè¿˜å¾—è·å–é”</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldParkAfterFailedAcquire</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> node<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">parkAndCheckInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token comment" spellcheck="true">// å½“å‰èŠ‚ç‚¹æ˜¯å› ä¸ºä¸­æ–­è€Œå”¤é†’ï¼Œè€Œä¸æ˜¯è¢«å‰é©±èŠ‚ç‚¹å”¤é†’</span>
                    interrupted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">/*
                 * å¦‚æœè®¾ç½®å¥½å‰ç»§SIGNALäº†ï¼Œé‚£ä¹ˆå¯ä»¥é˜»å¡ï¼Œå”¤é†’åè¿”å›çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€å¹¶å¤ä½ä¸­æ–­çŠ¶æ€ï¼Œç»§ç»­è‡ªæ—‹
                 * ä¹‹æ‰€ä»¥æ¢å¤ä¸­æ–­çŠ¶æ€ï¼Œæ˜¯å› ä¸ºå‡å¦‚å½“å‰çº¿ç¨‹æ˜¯å› ä¸ºä¸­æ–­è€Œè¢«å”¤é†’ï¼Œå¦‚æœä¸æ¸…é™¤ä¸­æ–­çŠ¶æ€ï¼Œä¸‹æ¬¡è‡ªæ—‹æ—¶LockSupport#parkä¸ä¼šé˜»å¡ï¼Œé‚£æ ·å°±å¯èƒ½ä¼šä¸€ç›´è‡ªæ—‹ç©ºè½¬
                 */</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æŠ›å‡ºå¼‚å¸¸ï¼Œé‚£ä¹ˆå°±æ˜¯å­ç±»å®ç°çš„tryAcquireæ–¹æ³•æŠ›å‡ºçš„ï¼Œé‚£ä¹ˆå–æ¶ˆå½“å‰èŠ‚ç‚¹</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>failed<span class="token punctuation">)</span>
                <span class="token function">cancelAcquire</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>AbstractQueuedSynchronizer#shouldParkAfterFailedAcquire</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * è¿”å›å½“å‰çº¿ç¨‹æ˜¯å¦åº”è¯¥é˜»å¡
     * æŒ‚èµ·è‡ªå·±ä¹‹å‰ï¼Œéœ€è¦å°†å‰é©±èŠ‚ç‚¹è®¾æˆSIGNALï¼Œè®©å‰é©±é‡Šæ”¾é”çš„æ—¶å€™å”¤é†’è‡ªå·±
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">shouldParkAfterFailedAcquire</span><span class="token punctuation">(</span>Node pred<span class="token punctuation">,</span> Node node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> ws <span class="token operator">=</span> pred<span class="token punctuation">.</span>waitStatus<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¦‚æœå‰é©±èŠ‚ç‚¹å·²ç»æ˜¯SIGNALï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹å¯ä»¥è¢«é˜»å¡</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ws <span class="token operator">==</span> Node<span class="token punctuation">.</span>SIGNAL<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¦‚æœå‰é©±èŠ‚ç‚¹æ˜¯CANCELLEDï¼Œé‚£ä¹ˆæ˜¯ä¸ªæ— æ•ˆçš„èŠ‚ç‚¹ï¼Œè·³è¿‡å¹¶é‡è¯•</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ws <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">do</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å‰é©±èŠ‚ç‚¹å·²å–æ¶ˆï¼ŒæŠŠå‰é©±èŠ‚ç‚¹ä»AQSé˜Ÿåˆ—ç§»é™¤</span>
                node<span class="token punctuation">.</span>prev <span class="token operator">=</span> pred <span class="token operator">=</span> pred<span class="token punctuation">.</span>prev<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>pred<span class="token punctuation">.</span>waitStatus <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// é‡æ–°è¿æ¥é“¾è¡¨</span>
            pred<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å¦‚æœå‰é©±èŠ‚ç‚¹çŠ¶æ€ä¸º 0 | CONDITION | PROPAGATE</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// CASå°è¯•æ›´æ–°å‰é©±èŠ‚ç‚¹ä¸ºSIGNAL</span>
            <span class="token function">compareAndSetWaitStatus</span><span class="token punctuation">(</span>pred<span class="token punctuation">,</span> ws<span class="token punctuation">,</span> Node<span class="token punctuation">.</span>SIGNAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// æ„æ€æ˜¯ä¸‹æ¬¡è‡ªæ—‹ç»§ç»­</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>AbstractQueuedSynchronizer#parkAndCheckInterrupt</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * é˜»å¡å½“å‰çº¿ç¨‹ï¼Œå¹¶è¿”å›çº¿ç¨‹è¢«å”¤é†’ä¹‹åçš„ä¸­æ–­çŠ¶æ€
     * çº¿ç¨‹è¢«é˜»å¡åå”¤é†’ä¸€èˆ¬æœ‰ä¸¤ç§ï¼š
     * å‰é©±èŠ‚ç‚¹é‡Šæ”¾é”åï¼Œé€šè¿‡LockSupport#unparkå”¤é†’å½“å‰çº¿ç¨‹
     * çº¿ç¨‹ä¸­æ–­ï¼Œå…¶å®ƒçº¿ç¨‹é€šè¿‡Thread#interruptä¸­æ–­å½“å‰çº¿ç¨‹
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">parkAndCheckInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        LockSupport<span class="token punctuation">.</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// å¯å“åº”ä¸­æ–­ï¼Œæœ‰ä¸­æ–­æ ‡è®°ï¼Œä½†æ˜¯ä¸ä¼šæŠ›å‡ºInterruptedException</span>
        <span class="token keyword">return</span> Thread<span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// è¿”å›çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€ï¼ŒåŒæ—¶å¤ä½ä¸­æ–­çŠ¶æ€</span>
    <span class="token punctuation">}</span></code></pre>
<p>AbstractQueuedSynchronizer#cancelAcquire</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">cancelAcquire</span><span class="token punctuation">(</span>Node node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> null<span class="token punctuation">)</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        node<span class="token punctuation">.</span>thread <span class="token operator">=</span> null<span class="token punctuation">;</span>
        Node pred <span class="token operator">=</span> node<span class="token punctuation">.</span>prev<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¦‚æœè¦å–æ¶ˆçš„èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹ä¹Ÿæ˜¯ä¸€ä¸ªå–æ¶ˆçš„èŠ‚ç‚¹ï¼Œå‘å‰éå†æ‰¾åˆ°ä¸€ä¸ªæœ‰æ•ˆçš„èŠ‚ç‚¹ï¼ŒåŒæ—¶æ›´æ–°èŠ‚ç‚¹å‘å‰çš„æŒ‡é’ˆï¼Œä¹Ÿå°±æ˜¯è¯´æ­¤æ—¶ä»åå‘å‰çš„éå†ä¸­ï¼Œä¼šè·³è¿‡å–æ¶ˆçš„èŠ‚ç‚¹</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>pred<span class="token punctuation">.</span>waitStatus <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
            node<span class="token punctuation">.</span>prev <span class="token operator">=</span> pred <span class="token operator">=</span> pred<span class="token punctuation">.</span>prev<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// æœ‰æ•ˆçš„å‰é©±èŠ‚ç‚¹çš„åé¢çš„ç¬¬ä¸€ä¸ªè¢«å–æ¶ˆçš„æ— æ•ˆèŠ‚ç‚¹</span>
        Node predNext <span class="token operator">=</span> pred<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ›´æ–°èŠ‚ç‚¹çš„çŠ¶æ€ä¸ºå–æ¶ˆ</span>
        node<span class="token punctuation">.</span>waitStatus <span class="token operator">=</span> Node<span class="token punctuation">.</span>CANCELLED<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// å¦‚æœè¦å–æ¶ˆçš„èŠ‚ç‚¹æ˜¯å°¾èŠ‚ç‚¹ &amp;&amp; CASæ›´æ–°å°¾èŠ‚ç‚¹ä¸ºå‰ä¸€ä¸ªæœ‰æ•ˆèŠ‚ç‚¹æˆåŠŸ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> tail <span class="token operator">&amp;&amp;</span> <span class="token function">compareAndSetTail</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> pred<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// CASç½®ç©ºå°¾èŠ‚ç‚¹çš„åæŒ‡é’ˆï¼ŒçœŸæ­£æ–­å¼€é“¾è¡¨</span>
            <span class="token function">compareAndSetNext</span><span class="token punctuation">(</span>pred<span class="token punctuation">,</span> predNext<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å¦åˆ™å¦‚æœè¦å–æ¶ˆçš„èŠ‚ç‚¹ä¸æ˜¯å°¾èŠ‚ç‚¹ï¼Œæˆ–è€…ä¸Šé¢çš„CASå¤±è´¥</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> ws<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ€»ä¹‹å°±æ˜¯è¦ä¿è¯æœ‰æ•ˆçš„å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€ä¸ºSIGNALï¼Œæ‰èƒ½ç»§ç»­</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pred <span class="token operator">!=</span> head <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ws <span class="token operator">=</span> pred<span class="token punctuation">.</span>waitStatus<span class="token punctuation">)</span> <span class="token operator">==</span> Node<span class="token punctuation">.</span>SIGNAL <span class="token operator">||</span> <span class="token punctuation">(</span>ws <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">compareAndSetWaitStatus</span><span class="token punctuation">(</span>pred<span class="token punctuation">,</span> ws<span class="token punctuation">,</span> Node<span class="token punctuation">.</span>SIGNAL<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> pred<span class="token punctuation">.</span>thread <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Node next <span class="token operator">=</span> node<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å½“å‰å–æ¶ˆçš„èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹å¤„äºæœ‰æ•ˆçŠ¶æ€ï¼Œå³æ²¡å–æ¶ˆ</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>next <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> next<span class="token punctuation">.</span>waitStatus <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token comment" spellcheck="true">// è¿æ¥é“¾è¡¨</span>
                    <span class="token function">compareAndSetNext</span><span class="token punctuation">(</span>pred<span class="token punctuation">,</span> predNext<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å…¶å®ƒæƒ…å†µ</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å”¤é†’åç»§èŠ‚ç‚¹ï¼Œæ„ä¹‰å°±æ˜¯è®©åç»§èŠ‚ç‚¹å”¤é†’åç»§ç»­è‡ªæ—‹ï¼Œä¿è¯å°†å®ƒçš„å‰é©±èŠ‚ç‚¹è®¾ä¸ºSIGNALåå†é˜»å¡ï¼Œé¿å…å‡ºç°æ— æ³•å”¤é†’çš„æƒ…å†µ</span>
                <span class="token function">unparkSuccessor</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            node<span class="token punctuation">.</span>next <span class="token operator">=</span> node<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// help GC</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>éå…¬å¹³é”çš„æƒ…å†µ</p>
<p>ReentrantLock$NonfairSync#lock</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// CASè®¾ç½®åŒæ­¥çŠ¶æ€ï¼ŒæˆåŠŸå°±è®¾ç½®é”çš„æŒæœ‰çº¿ç¨‹ä¸ºè‡ªå·±ï¼Œå› ä¸ºæ­¤æ—¶AQSé˜Ÿåˆ—å¯èƒ½è¿˜æœ‰èŠ‚ç‚¹åœ¨æ’é˜Ÿï¼Œè¿™ç§æ’é˜Ÿè¡Œä¸ºæ˜¯ä¸å…¬å¹³çš„</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// CASæ›´æ–°å¤±è´¥ï¼Œè¿˜ä¼šå†å°è¯•ä¸€æ¬¡ï¼Œè¿˜å¤±è´¥åˆ™è¿›å…¥AQSåŒæ­¥é˜Ÿåˆ—æ’é˜Ÿ</span>
            <span class="token keyword">else</span>
                <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>ReentrantLock$NonfairSync#tryAcquire</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> acquires<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">nonfairTryAcquire</span><span class="token punctuation">(</span>acquires<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>ReentrantLock$Sync#nonfairTryAcquire</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">nonfairTryAcquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> acquires<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> Thread current <span class="token operator">=</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å¦‚æœé”ç©ºé—²</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ç›¸æ¯”å…¬å¹³é”çš„FairSync#tryAcquireæ–¹æ³•ï¼Œå°‘äº†AbstractQueuedSynchronizer#hasQueuedPredecessorsï¼Œä¸ç®¡é˜Ÿåˆ—è¿˜æœ‰æ²¡äººæ’é˜Ÿï¼Œç›´æ¥CAS</span>
                <span class="token comment" spellcheck="true">// CASæ›´æ–°æˆåŠŸï¼Œå¤±è´¥åˆ™å¯èƒ½æ˜¯å› ä¸ºé˜Ÿåˆ—çœŸæ­£çš„å¤´èŠ‚ç‚¹çº¿ç¨‹å”¤é†’åï¼Œç«äº‰å¤±è´¥</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> acquires<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// è®¾ç½®å½“å‰çº¿ç¨‹å æœ‰é”</span>
                    <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// é‡å…¥</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">==</span> <span class="token function">getExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> nextc <span class="token operator">=</span> c <span class="token operator">+</span> acquires<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>nextc <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"Maximum lock count exceeded"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">setState</span><span class="token punctuation">(</span>nextc<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<hr>
<p>ReentrantLock#unlock</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * é‡Šæ”¾é”
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sync<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>AbstractQueuedSynchronizer#release</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * é‡Šæ”¾é”
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">release</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// å°è¯•é‡Šæ”¾é”ï¼Œå¦‚æœæˆåŠŸ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tryRelease</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Node h <span class="token operator">=</span> head<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// é‡Šæ”¾æˆåŠŸåï¼Œå”¤é†’å¤´èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ï¼Œ0è¯´æ˜å·²ç»é‡Šæ”¾è¿‡äº†ï¼Œä¸éœ€è¦é‡å¤é‡Šæ”¾</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>h <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> h<span class="token punctuation">.</span>waitStatus <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token function">unparkSuccessor</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// é‡Šæ”¾å¤±è´¥</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ReentrantLock$Sync#tryRelease</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">tryRelease</span><span class="token punctuation">(</span><span class="token keyword">int</span> releases<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å¯¹äºç‹¬å é”ï¼Œreleasesæ˜¯1</span>
            <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> releases<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// å¯é‡å…¥ï¼Œè¦é‡Šæ”¾é‡å…¥è·å–çš„é”</span>
            <span class="token comment" spellcheck="true">// å¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯è¯¥é”çš„æŒæœ‰è€…ï¼ŒæŠ›å¼‚å¸¸</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token function">getExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalMonitorStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> free <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// é‡å…¥é”å…¨éƒ¨é‡Šæ”¾æ‰è¡Œ</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// åªæœ‰å…¨éƒ¨é‡Šæ”¾æ‰è¿”å›true</span>
                free <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// è®¾ç½®é”çš„æŒæœ‰è€…ä¸ºnullï¼ŒåŒæ­¥é˜Ÿåˆ—çš„èŠ‚ç‚¹å¯ä»¥è·å–äº†</span>
                <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// æ›´æ–°é”çŠ¶æ€</span>
            <span class="token function">setState</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> free<span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>AbstractQueuedSynchronizer#unparkSuccessor</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * å¤´èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹è¢«å”¤é†’ï¼Œåç»§èŠ‚ç‚¹å°±ä¼šå°è¯•å»è·å–é”
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">unparkSuccessor</span><span class="token punctuation">(</span>Node node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// å¤´èŠ‚ç‚¹ï¼Œä»£è¡¨è¦é‡Šæ”¾é”çš„èŠ‚ç‚¹</span>
        <span class="token keyword">int</span> ws <span class="token operator">=</span> node<span class="token punctuation">.</span>waitStatus<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¦‚æœå¤´èŠ‚ç‚¹çŠ¶æ€ä¸ä¸ºCANCELLEDï¼Œé‚£ä¹ˆCASæ›´æ–°ä¸º0ï¼Œè¡¨ç¤ºå·²é‡Šæ”¾ï¼Œä¸èƒ½é‡å¤é‡Šæ”¾</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ws <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token function">compareAndSetWaitStatus</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> ws<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ä»å¤´ç»“ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹å¼€å§‹å¯»æ‰¾åç»§èŠ‚ç‚¹</span>
        Node s <span class="token operator">=</span> node<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è¯´æ˜æ˜¯ä¸ªæ— æ•ˆçš„èŠ‚ç‚¹ï¼ŒCANCELLED</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> null <span class="token operator">||</span> s<span class="token punctuation">.</span>waitStatus <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// è¿™ä¸ªå˜é‡æ˜¯ç”¨æ¥åˆ¤æ–­æœ‰æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆèŠ‚ç‚¹çš„</span>
            s <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// é‚£ä¹ˆä»é˜Ÿåˆ—å°¾å¼€å§‹ï¼Œå‘å‰å¯»æ‰¾æœ‰æ•ˆçš„èŠ‚ç‚¹ï¼Œç›´åˆ°å¤´èŠ‚ç‚¹</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>Node t <span class="token operator">=</span> tail<span class="token punctuation">;</span> t <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> t <span class="token operator">!=</span> node<span class="token punctuation">;</span> t <span class="token operator">=</span> t<span class="token punctuation">.</span>prev<span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span>waitStatus <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    s <span class="token operator">=</span> t<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">/*
             * å…³äºä»å°¾éƒ¨æŸ¥æ‰¾çš„é€»è¾‘
             * å¯ä»¥å‚è€ƒAbstractQueuedSynchronizer#enqçš„é€»è¾‘ï¼Œä»åå‘å‰éå†å¯ä»¥é¿å…è¯»åˆ°è¢«ç ´åçš„é˜Ÿåˆ—ç»“æ„
             * å¦å¤–ï¼ŒLock#lockInterruptiblyçš„çº¿ç¨‹è¢«ä¸­æ–­ï¼Œå°†CANCELLEDçš„èŠ‚ç‚¹ç§»å‡ºé˜Ÿåˆ—ä¹Ÿæ˜¯ç±»ä¼¼
             */</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// åˆ°è¿™é‡Œè¯´æ˜æ‰¾åˆ°äº†æœ‰æ•ˆçš„åç»§èŠ‚ç‚¹ï¼Œå³waitStatus&lt;=0ï¼Œä¸€èˆ¬æ˜¯å¤´èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹</span>

        <span class="token comment" spellcheck="true">// å¦‚æœæ‰¾åˆ°ä¸€ä¸ªæœ‰æ•ˆçš„åç»§èŠ‚ç‚¹ï¼Œå°±å”¤é†’æ­¤èŠ‚ç‚¹</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">!=</span> null<span class="token punctuation">)</span>
            LockSupport<span class="token punctuation">.</span><span class="token function">unpark</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


        <footer>
             
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

        </footer>
    </div>
    <!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
    <script>
        var timeEnd = new Date();
        console.log('è€—æ—¶ï¼š' + (timeEnd - timeStart));
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre').forEach((block) => {
                block.classList.add("line-numbers");
            });
        });
    </script>
    <!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
    <!-- material design -->
    <!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
    <!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
    <!-- toc -->
    <!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
    <!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
    <!-- <script src="/js/main.js"></script> -->
    <script src="/js/prism.js"></script>
</body>
</html>
