<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
        <script>
            var timeStart = new Date();
        </script>
        
        <title>[ç¬”è®°]-ThreadLocal | ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜</title>
        
        <meta name="author" content="huangzhike">
        
        
        <meta name="description" content="2019-12-09æ›´æ–°

Thread
public class Thread implements Runnable {
    /**
     * æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªè‡ªå·±çš„ThreadLocal.ThreadLocalMapå¯¹è±¡ï¼Œé‡Œé¢æ˜¯Entryæ•°ç»„
     * Entryçš„keyä¸ºä¸€ä¸ªTh">
        
        
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        
        <meta property="og:title" content="[ç¬”è®°]-ThreadLocal"/>
        
        <meta property="og:site_name" content="ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜"/>
        
        
        <!-- favicon -->
        <link rel="icon" type="image/ico" href="/ok.ico" sizes="32x32">
        <meta name="msapplication-TileColor" content="#009688">
        <meta name="msapplication-TileImage" content="/mstile-144x144.ico">
        <meta name="theme-color" content="#009688">
        <!-- favicon end -->
        <!-- <link href="//ok.ico" rel="icon"> -->
        
        <!-- toc -->
        <!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
        <!-- material design -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
        <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
        
        <!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
        <!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
    <meta name="generator" content="Hexo 4.2.1"></head>

<body>
    <nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">èœå•</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" title="ä¸‹ä¸€å¥æ˜¯ï¼šå®¢æœ‰å¯äººæœŸä¸æ¥ã€‚å°æ—¶å€™ï¼Œå–œæ¬¢é åœ¨é˜³å°ä¸Šï¼Œä¸€è¾¹å¹é£ï¼Œä¸€è¾¹çœ‹ä¹¦ï¼Œå–œæ¬¢è¯»ä¹¦å—ï¼Œéªšå¹´ï¼Ÿ" href="/">ä¹¦å½“å¿«æ„è¯»æ˜“å°½</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" target="_blank" rel="noopener" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

    <div class="container" >
        <div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[ç¬”è®°]-ThreadLocal</h2>
				
				<div>
					<div class="post-time">2019-04-20</div>
				</div>
				
				<div class="article-content">
				<p>2019-12-09æ›´æ–°</p>
<hr>
<p>Thread</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Thread</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/**
     * æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªè‡ªå·±çš„ThreadLocal.ThreadLocalMapå¯¹è±¡ï¼Œé‡Œé¢æ˜¯Entryæ•°ç»„
     * Entryçš„keyä¸ºä¸€ä¸ªThreadLocalå®ä¾‹ï¼ŒEntryç»§æ‰¿äº†å¼±å¼•ç”¨ï¼Œä¸è¿‡å¼±å¼•ç”¨åªæŒ‡å‘ThreadLocalå®ä¾‹
     */</span>
    ThreadLocal<span class="token punctuation">.</span>ThreadLocalMap threadLocals <span class="token operator">=</span> null<span class="token punctuation">;</span>

<span class="token punctuation">}</span></code></pre>
<hr>
<p>ThreadLocal#set</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span>T value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Thread t <span class="token operator">=</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å½“å‰çº¿ç¨‹çš„ThreadLocalMap</span>
        ThreadLocalMap map <span class="token operator">=</span> <span class="token function">getMap</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">!=</span> null<span class="token punctuation">)</span>
            map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token function">createMap</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ThreadLocal$ThreadLocalMap</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ThreadLocalMap</span> <span class="token punctuation">{</span>

        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> INITIAL_CAPACITY <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * å¤§å°å¿…é¡»æ˜¯2çš„Næ¬¡å¹‚
         */</span>
        <span class="token keyword">private</span> Entry<span class="token punctuation">[</span><span class="token punctuation">]</span> table<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * æ‰©å®¹é˜ˆå€¼
         */</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> threshold<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Default to 0</span>

    <span class="token punctuation">}</span></code></pre>
<p>ThreadLocal$ThreadLocalMap</p>
<pre class=" language-java"><code class="language-java">        <span class="token function">ThreadLocalMap</span><span class="token punctuation">(</span>ThreadLocal<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> firstKey<span class="token punctuation">,</span> Object firstValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// åˆå§‹åŒ–ä¸€ä¸ªé•¿åº¦16çš„Entryæ•°ç»„</span>
            table <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Entry</span><span class="token punctuation">[</span>INITIAL_CAPACITY<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> i <span class="token operator">=</span> firstKey<span class="token punctuation">.</span>threadLocalHashCode <span class="token operator">&amp;</span> <span class="token punctuation">(</span>INITIAL_CAPACITY <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ’å…¥æ•°ç»„</span>
            table<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Entry</span><span class="token punctuation">(</span>firstKey<span class="token punctuation">,</span> firstValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
            size <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ‰©å®¹é˜ˆå€¼0.67</span>
            <span class="token function">setThreshold</span><span class="token punctuation">(</span>INITIAL_CAPACITY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>ThreadLocalMap$Entry</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Entry</span> <span class="token keyword">extends</span> <span class="token class-name">WeakReference</span><span class="token operator">&lt;</span>ThreadLocal<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>></span> <span class="token punctuation">{</span>

            Object value<span class="token punctuation">;</span>

            <span class="token function">Entry</span><span class="token punctuation">(</span>ThreadLocal<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> k<span class="token punctuation">,</span> Object v<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// keyæ˜¯å¼±å¼•ç”¨</span>
                <span class="token keyword">super</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>
                value <span class="token operator">=</span> v<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span></code></pre>
<p>ThreadLocal$ThreadLocalMap#set</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span>ThreadLocal<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> key<span class="token punctuation">,</span> Object value<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            Entry<span class="token punctuation">[</span><span class="token punctuation">]</span> tab <span class="token operator">=</span> table<span class="token punctuation">;</span>
            <span class="token keyword">int</span> len <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ ¹æ®ThreadLocalçš„å“ˆå¸Œå€¼å¾—åˆ°æ•°ç»„å¯¹åº”çš„ä½ç½®</span>
            <span class="token keyword">int</span> i <span class="token operator">=</span> key<span class="token punctuation">.</span>threadLocalHashCode <span class="token operator">&amp;</span> <span class="token punctuation">(</span>len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// é€šè¿‡ä¸‹æ ‡æ‰¾Entryå¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„Entryå¯¹è±¡ï¼Œå¦‚æœæœ‰ï¼Œä½†keyå†²çªäº†ï¼Œåˆ™å°†ä¸‹æ ‡åŠ ä¸€ï¼ŒæŸ¥æ‰¾ä¸‹ä¸€ä¸ªä½ç½®</span>
            <span class="token comment" spellcheck="true">// ç®€å•åœ°è¯´å°±æ˜¯çº¿æ€§æŸ¥æ‰¾ï¼Œä¸€ä¸ªä½ç½®è¢«å äº†ï¼Œå°±å‘åæŸ¥æ‰¾ä¸‹ä¸€ä¸ªç©ºä½ï¼Œåœ¨æ²¡æœ‰å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œæ•°ç»„åœ¨æ»¡ä¹‹å‰å°±ä¼šæ‰©å®¹ï¼Œæ‰€ä»¥æ€»æ˜¯ä¼šæœ‰ç©ºä½çš„</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>Entry e <span class="token operator">=</span> tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span> e <span class="token operator">!=</span> null<span class="token punctuation">;</span> e <span class="token operator">=</span> tab<span class="token punctuation">[</span>i <span class="token operator">=</span> <span class="token function">nextIndex</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ThreadLocal<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> k <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// keyç›¸åŒï¼Œè¦†ç›–valueï¼Œå¹¶è¿”å›</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">==</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// å¦‚æœEntryå­˜åœ¨ï¼Œä½†æ˜¯keyä¸ºnullï¼Œè¯´æ˜keyè¢«GCäº†ï¼ˆThreadLocalæ˜¯å¼±å¼•ç”¨ï¼‰ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„Entryå¯¹è±¡æ›¿ä»£ï¼Œå¹¶è¿”å›</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">replaceStaleEntry</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å¦‚æœéå†åˆ°ç©ºä½ï¼Œæ’å…¥ä¸€ä¸ªæ–°çš„entryå¯¹è±¡</span>
            tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Entry</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// é•¿åº¦åŠ ä¸€</span>
            <span class="token keyword">int</span> sz <span class="token operator">=</span> <span class="token operator">++</span>size<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ä»ä¸Šé¢å¾ªç¯ç»“æŸçš„ç©ºçš„Entryå‘åéå†æ¸…é™¤æ— æ•ˆçš„Entryï¼Œå¦‚æœæ²¡æœ‰å¯æ¸…é™¤çš„ï¼Œå¹¶ä¸”æ•°ç»„é•¿åº¦è¾¾åˆ°äº†é˜€å€¼ï¼Œåˆ™å°è¯•æ‰©å®¹</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">cleanSomeSlots</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> sz<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> sz <span class="token operator">>=</span> threshold<span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// å…ˆæ¸…ç†æ•´ä¸ªæ•°ç»„ï¼Œæ¸…ç†å®Œåå¦‚æœè¿˜è¶…å‡ºé˜ˆå€¼ï¼Œæ‰çœŸæ­£æ‰©å®¹</span>
                <span class="token function">rehash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>ThreadLocal$ThreadLocalMap#replaceStaleEntry</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">replaceStaleEntry</span><span class="token punctuation">(</span>ThreadLocal<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> key<span class="token punctuation">,</span> Object value<span class="token punctuation">,</span> <span class="token keyword">int</span> staleSlot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Entry<span class="token punctuation">[</span><span class="token punctuation">]</span> tab <span class="token operator">=</span> table<span class="token punctuation">;</span>
            <span class="token keyword">int</span> len <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
            Entry e<span class="token punctuation">;</span>
            <span class="token keyword">int</span> slotToExpunge <span class="token operator">=</span> staleSlot<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ç”±ä¼ å…¥çš„æ— æ•ˆçš„Entryä½ç½®å‘å‰æœç´¢ï¼Œæ‰¾åˆ°å‰é¢ä¸€ä¸ªæ— æ•ˆçš„Entry</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token function">prevIndex</span><span class="token punctuation">(</span>staleSlot<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">(</span>e <span class="token operator">=</span> tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">;</span> i <span class="token operator">=</span> <span class="token function">prevIndex</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span>
                    slotToExpunge <span class="token operator">=</span> i<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å†ç”±ä¼ å…¥çš„æ— æ•ˆçš„Entryä½ç½®å‘åæœç´¢</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token function">nextIndex</span><span class="token punctuation">(</span>staleSlot<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">(</span>e <span class="token operator">=</span> tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">;</span> i <span class="token operator">=</span> <span class="token function">nextIndex</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ThreadLocal<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> k <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å¦‚æœkeyç›¸ç­‰ï¼Œåˆ™ç›´æ¥æ›¿æ¢</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">==</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
                    tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> tab<span class="token punctuation">[</span>staleSlot<span class="token punctuation">]</span><span class="token punctuation">;</span>
                    tab<span class="token punctuation">[</span>staleSlot<span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// å¦‚æœä¹‹å‰æ‰¾åˆ°çš„æ— æ•ˆEntryä½ç½®å°±æ˜¯æ–¹æ³•ä¼ å…¥çš„èµ·å§‹ä½ç½®ï¼Œè¯´æ˜è¯¥ä½ç½®å‰é¢æ²¡æœ‰åˆ«çš„æ— æ•ˆEntry</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>slotToExpunge <span class="token operator">==</span> staleSlot<span class="token punctuation">)</span>
                        slotToExpunge <span class="token operator">=</span> i<span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// ä»è¯¥ä½ç½®å¼€å§‹æ‰«æï¼Œå¹¶æ¸…é™¤æ— æ•ˆEntry</span>
                    <span class="token function">cleanSomeSlots</span><span class="token punctuation">(</span><span class="token function">expungeStaleEntry</span><span class="token punctuation">(</span>slotToExpunge<span class="token punctuation">)</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// å¦åˆ™å¦‚æœæ˜¯ä¸€ä¸ªæ— æ•ˆçš„Entryï¼Œå¹¶ä¸”ä¹‹å‰çš„å‘å‰æœç´¢æ²¡æœ‰æ‰¾åˆ°æ— æ•ˆçš„Entry</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> slotToExpunge <span class="token operator">==</span> staleSlot<span class="token punctuation">)</span>
                    <span class="token comment" spellcheck="true">// æ¸…ç†ä½ç½®æ”¹ä¸ºå½“å‰éå†çš„ä½ç½®ï¼Œè€Œæ–¹æ³•ä¼ å…¥çš„ä½ç½®åˆ™è¦è¢«æ›¿æ¢æˆæ–°çš„Entryï¼Œæ‰€ä»¥ä¸ç®—ä¸Š</span>
                    slotToExpunge <span class="token operator">=</span> i<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// æ²¡æ‰¾åˆ°çš„è¯ï¼Œå°±æ›¿æ¢æ–¹æ³•å¼€å§‹ä¼ å…¥çš„æ— æ•ˆEntryä½ç½®</span>
            tab<span class="token punctuation">[</span>staleSlot<span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">=</span> null<span class="token punctuation">;</span>
            tab<span class="token punctuation">[</span>staleSlot<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Entry</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å¦‚æœä¸Šé¢çš„éå†è¿‡ç¨‹ä¸­å‘ç°äº†åˆ«çš„æ— æ•ˆEntryï¼Œè¿˜è¦ä»è¯¥ä½ç½®å¼€å§‹æ¸…é™¤</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>slotToExpunge <span class="token operator">!=</span> staleSlot<span class="token punctuation">)</span>
                <span class="token function">cleanSomeSlots</span><span class="token punctuation">(</span><span class="token function">expungeStaleEntry</span><span class="token punctuation">(</span>slotToExpunge<span class="token punctuation">)</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>ThreadLocal$ThreadLocalMap#expungeStaleEntry</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">expungeStaleEntry</span><span class="token punctuation">(</span><span class="token keyword">int</span> staleSlot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Entry<span class="token punctuation">[</span><span class="token punctuation">]</span> tab <span class="token operator">=</span> table<span class="token punctuation">;</span>
            <span class="token keyword">int</span> len <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ç½®ç©ºEntryçš„valueï¼Œé˜²æ­¢å†…å­˜æ³„æ¼</span>
            tab<span class="token punctuation">[</span>staleSlot<span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ç½®ç©ºEntry</span>
            tab<span class="token punctuation">[</span>staleSlot<span class="token punctuation">]</span> <span class="token operator">=</span> null<span class="token punctuation">;</span>
            size<span class="token operator">--</span><span class="token punctuation">;</span>
            Entry e<span class="token punctuation">;</span>
            <span class="token keyword">int</span> i<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å‘åéå†æ•°ç»„ï¼Œç›´åˆ°é‡åˆ°ä¸€ä¸ªEntryä¸ºç©ºçš„ä½ç½®</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token function">nextIndex</span><span class="token punctuation">(</span>staleSlot<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">(</span>e <span class="token operator">=</span> tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">;</span> i <span class="token operator">=</span> <span class="token function">nextIndex</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ThreadLocal<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> k <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å¦‚æœEntryä¸ä¸ºnullï¼Œä½†æ˜¯keyä¸ºnull</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ç½®ç©ºè¯¥Entryçš„value</span>
                    e<span class="token punctuation">.</span>value <span class="token operator">=</span> null<span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// ç½®ç©ºè¯¥Entry</span>
                    tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> null<span class="token punctuation">;</span>
                    size<span class="token operator">--</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// å¦‚æœé‡åˆ°ä¸€ä¸ªæœ‰æ•ˆçš„Entry</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// è¯¥Entryçš„å“ˆå¸Œæœ¬è¯¥å®šä½çš„ä½ç½®</span>
                    <span class="token keyword">int</span> h <span class="token operator">=</span> k<span class="token punctuation">.</span>threadLocalHashCode <span class="token operator">&amp;</span> <span class="token punctuation">(</span>len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// è¯´æ˜è¯¥EntryåŸæœ¬çš„ä½ç½®å‘ç”Ÿäº†å†²çªï¼Œä½ç½®åç§»äº†ï¼Œä½†æ˜¯ä¹‹å‰å› ä¸ºåˆ é™¤ï¼Œæ‰€ä»¥å¤šä¸€ä¸ªç©ºä½ï¼Œç°åœ¨è¦æŠŠå®ƒå‰ç§»</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>h <span class="token operator">!=</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// å…ˆæŠŠå½“å‰çš„ä½ç½®ç½®ç©º</span>
                        tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> null<span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// ç”±å“ˆå¸Œå®šä½åˆ°çš„ä½ç½®å‘åæŸ¥æ‰¾ï¼Œç¬¬ä¸€ä¸ªç©ºä½</span>
                        <span class="token keyword">while</span> <span class="token punctuation">(</span>tab<span class="token punctuation">[</span>h<span class="token punctuation">]</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span>
                            h <span class="token operator">=</span> <span class="token function">nextIndex</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// æŠŠEntryæ¬åˆ°è¯¥ç©ºä½</span>
                        tab<span class="token punctuation">[</span>h<span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// è¿”å›ä¸Šé¢å¾ªç¯ç»“æŸçš„æ—¶å€™ï¼ŒEntryä¸ºç©ºçš„ä½ç½®ï¼Œä¹‹å‰çš„éƒ¨åˆ†åˆ™æ˜¯å·²å¤„ç†çš„äº†</span>
            <span class="token keyword">return</span> i<span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>ThreadLocal$ThreadLocalMap#cleanSomeSlots</p>
<pre class=" language-java"><code class="language-java">        <span class="token comment" spellcheck="true">/**
         * æ¸…é™¤keyä¸ºnullçš„Entry
         */</span>
        <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">cleanSomeSlots</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token keyword">int</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">boolean</span> removed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            Entry<span class="token punctuation">[</span><span class="token punctuation">]</span> tab <span class="token operator">=</span> table<span class="token punctuation">;</span>
            <span class="token keyword">int</span> len <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ä»è¯¥ä½ç½®å‘åéå†æ•°ç»„</span>
            <span class="token keyword">do</span> <span class="token punctuation">{</span>
                i <span class="token operator">=</span> <span class="token function">nextIndex</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
                Entry e <span class="token operator">=</span> tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// Entryä¸ä¸ºnullï¼Œä½†æ˜¯keyä¸ºnull</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> e<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    n <span class="token operator">=</span> len<span class="token punctuation">;</span>
                    removed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// åˆ é™¤è¯¥Entryï¼ŒåŒæ—¶å‘åæ‰«ææ¸…ç†ï¼Œè¿”å›å¤„ç†ç»“æŸçš„ä½ç½®ï¼Œç„¶åä»è¯¥ä½ç½®ç»§ç»­å¾ªç¯</span>
                    i <span class="token operator">=</span> <span class="token function">expungeStaleEntry</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å³ç§»åèµ‹å€¼ï¼Œå¦‚æœn>1åˆ™ç»§ç»­ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯æ¬¡å¾ªç¯å¦‚æœæ²¡é‡åˆ°æ— æ•ˆçš„Entryï¼Œnä¼šè¶Šæ¥è¶Šå°</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>n <span class="token operator">>>>=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> removed<span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>ThreadLocal$ThreadLocalMap#rehash</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">rehash</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// éå†æ•°ç»„ï¼Œæ¸…é™¤æ‰€æœ‰æ— æ•ˆçš„Entry</span>
            <span class="token function">expungeStaleEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ¸…é™¤åè¿˜æ˜¯è¶…å‡ºé˜ˆå€¼ï¼Œé‚£å°±æ‰©å®¹</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">>=</span> threshold <span class="token operator">-</span> threshold <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">)</span>
                <span class="token function">resize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>ThreadLocal$ThreadLocalMap#expungeStaleEntries</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">expungeStaleEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Entry<span class="token punctuation">[</span><span class="token punctuation">]</span> tab <span class="token operator">=</span> table<span class="token punctuation">;</span>
            <span class="token keyword">int</span> len <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// éå†æ•°ç»„</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Entry e <span class="token operator">=</span> tab<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// æ¸…ç†keyä¸ºnullçš„Entry</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> e<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span>
                    <span class="token function">expungeStaleEntry</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span></code></pre>
<p>ThreadLocal$ThreadLocalMap#resize</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">resize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Entry<span class="token punctuation">[</span><span class="token punctuation">]</span> oldTab <span class="token operator">=</span> table<span class="token punctuation">;</span>
            <span class="token keyword">int</span> oldLen <span class="token operator">=</span> oldTab<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ç›´æ¥æ‰©å®¹ä¸ºåŸæ¥çš„2å€</span>
            <span class="token keyword">int</span> newLen <span class="token operator">=</span> oldLen <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ–°æ•°ç»„</span>
            Entry<span class="token punctuation">[</span><span class="token punctuation">]</span> newTab <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Entry</span><span class="token punctuation">[</span>newLen<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ¬è¿æ•°æ®</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> oldLen<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Entry e <span class="token operator">=</span> oldTab<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    ThreadLocal<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> k <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// å¤åˆ¶æ•°ç»„çš„åŒæ—¶ä¹Ÿä¼šé¡ºä¾¿æ¸…ç†æ— æ•ˆçš„Entry</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        e<span class="token punctuation">.</span>value <span class="token operator">=</span> null<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Help the GC</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// æœ‰æ•ˆçš„Entry</span>
                    <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// è¯¥Entryçš„å“ˆå¸Œåº”è¯¥å®šä½åˆ°çš„ä½ç½®</span>
                        <span class="token keyword">int</span> h <span class="token operator">=</span> k<span class="token punctuation">.</span>threadLocalHashCode <span class="token operator">&amp;</span> <span class="token punctuation">(</span>newLen <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// å¦‚æœè¯¥ä½ç½®è¢«å äº†ï¼Œå°±å‘åæ‰¾ä¸€ä¸ªç©ºä½</span>
                        <span class="token keyword">while</span> <span class="token punctuation">(</span>newTab<span class="token punctuation">[</span>h<span class="token punctuation">]</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span>
                            h <span class="token operator">=</span> <span class="token function">nextIndex</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> newLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// æ’å…¥æ–°æ•°ç»„</span>
                        newTab<span class="token punctuation">[</span>h<span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">;</span>
                        count<span class="token operator">++</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token function">setThreshold</span><span class="token punctuation">(</span>newLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
            size <span class="token operator">=</span> count<span class="token punctuation">;</span>
            table <span class="token operator">=</span> newTab<span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<hr>
<p>å› ä¸ºæœ‰çº¿ç¨‹æ± ï¼Œçº¿ç¨‹ä¼šä¸€ç›´å¤ç”¨å­˜åœ¨ï¼Œå¦‚æœåœ¨çº¿ç¨‹ä¸­æ”¾ç½®äº†ä¸€ä¸ªå¯¹è±¡ï¼Œæ²¡æœ‰æ¸…é™¤ï¼Œä¼šä¸€ç›´ç•™åœ¨çº¿ç¨‹ä¸­ï¼Œé€ æˆå†…å­˜æ³„æ¼ã€‚</p>
<p>ThreadLocalä½œä¸ºThreadLocalMapçš„Keyï¼Œæ˜¯è¢«å¼±å¼•ç”¨çš„å¯¹è±¡ã€‚</p>
<p>å½“ä¸€ä¸ªå¯¹è±¡ä»…è¢«å¼±å¼•ç”¨æ‰€å¼•ç”¨ï¼Œè€Œæ²¡æœ‰è¢«å…¶å®ƒå¼ºå¼•ç”¨æŒ‡å‘æ—¶ï¼Œå¦‚æœå‘ç”ŸGCï¼Œè¿™ä¸ªå¯¹è±¡å°±ä¼šè¢«å›æ”¶ã€‚</p>
<p>ThreadLocalä¸ä½œä¸ºå¼ºå¼•ç”¨çš„åŸå› æ˜¯ï¼Œå‡å¦‚ThreadLocalå®ä¾‹ä½¿ç”¨å®Œåé‡Šæ”¾å®ƒçš„å¼•ç”¨ï¼Œä½†æ˜¯åˆæ²¡æœ‰æ‰‹åŠ¨åˆ é™¤ThreadLocalMapå®ä¾‹çš„å¯¹åº”Entryï¼Œè¿™æ—¶ä¼šæœ‰ä¸€æ¡å¼ºå¼•ç”¨é“¾ï¼š</p>
<p>Threadå®ä¾‹ -&gt; ThreadLocalMapå®ä¾‹ -&gt; Entryå®ä¾‹ -&gt; Keyï¼ˆå³ThreadLocalå®ä¾‹ï¼‰å’ŒValue</p>
<p>å‡å¦‚çº¿ç¨‹ä¸€ç›´å­˜åœ¨ï¼Œæ­¤æ—¶å¤–éƒ¨å·²ç»æ²¡æœ‰åŠæ³•è·å–ThreadLocalå®ä¾‹å¼•ç”¨ï¼Œä¹Ÿå°±æ˜¯æ— æ³•æ‰‹åŠ¨åˆ é™¤Entryï¼Œä½†æ˜¯å¼•ç”¨é“¾åˆä¸€ç›´å­˜åœ¨ï¼Œå¯¼è‡´Keyå’ŒValueæ— æ³•è¢«GCå›æ”¶ï¼Œé€ æˆå†…å­˜æ³„æ¼ã€‚</p>
<p>ä½†æ˜¯å‡å¦‚ThreadLocalæ˜¯å¼±å¼•ç”¨ï¼Œå½“å¤–éƒ¨å¯¹ThreadLocalå®ä¾‹çš„å¼ºå¼•ç”¨é‡Šæ”¾æ—¶ï¼Œåªä¼šå‰©ä¸‹Entryå®ä¾‹å¯¹ThreadLocalå®ä¾‹çš„å¼±å¼•ç”¨ï¼Œæ­¤æ—¶ThreadLocalå®ä¾‹å°±å¯ä»¥è¢«å›æ”¶ã€‚</p>
<p>ä½†æ˜¯è¿™æ ·è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼ŒThreadLocalå®ä¾‹è¢«å›æ”¶äº†ï¼Œé‚£ä¹ˆKeyå°±å˜æˆäº†nullï¼Œä½†æ˜¯Valueå’ŒEntryè¿˜å­˜åœ¨ï¼Œæ‰€ä»¥è¿˜æ˜¯ä¼šæœ‰å†…å­˜æ³„æ¼çš„é£é™©ã€‚</p>
<p>æ‰€ä»¥ThreadLocalMapåœ¨éå†çš„æ—¶å€™å¦‚æœå‘ç°Keyä¸ºnullçš„Entryï¼Œé‚£ä¹ˆå°±ä¼šé¡ºä¾¿ç½®ç©ºå®ƒçš„å¼•ç”¨ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼ã€‚</p>
<p>ä½†æ˜¯è¿™ä¸ªé¡ºä¾¿æ˜¯æœ‰æ¡ä»¶çš„ï¼Œå¹¶ä¸”ä¸æ˜¯æ¯æ¬¡éƒ½ä¼šéå†æ•´ä¸ªæ•°ç»„ï¼Œæ‰€ä»¥é£é™©ä¾ç„¶å­˜åœ¨ã€‚</p>
<p>JDKçš„å»ºè®®æ˜¯ï¼Œå°†ThreadLocalå®ä¾‹è®¾ä¸ºé™æ€ç±»å˜é‡ï¼Œè¿™æ ·ç”Ÿå‘½å‘¨æœŸå°±è¶³å¤Ÿé•¿ï¼Œå¯ä»¥éšæ—¶è·å–å¯¹ThreadLocalå®ä¾‹çš„å¼•ç”¨ã€‚</p>
<p>ä½†æ˜¯è¿™æ ·å¯¹ThreadLocalå®ä¾‹çš„å¼ºå¼•ç”¨å°±ä¼šä¸€ç›´å­˜åœ¨ï¼Œä¹Ÿå°±æ˜¯è¯´ThreadLocalMap.Entryå®ä¾‹ä¸ä¼šè‡ªåŠ¨å›æ”¶Keyï¼Œæ‰€ä»¥ç”¨å®Œåå¿…é¡»æ‰‹åŠ¨è°ƒç”¨åˆ é™¤æ–¹æ³•ï¼Œä¸ç„¶ä¸€æ ·ä¼šå†…å­˜æ³„æ¼æ³„æ¼ã€‚</p>
<p>ä½†æ˜¯è¿™æ ·èµ·ç æœ‰äº†æ‰‹åŠ¨åˆ é™¤çš„æ–¹æ³•ï¼Œå½“ç„¶å¦‚æœçº¿ç¨‹é€€å‡ºäº†ï¼Œé‚£å°±ä»€ä¹ˆé—®é¢˜éƒ½æ²¡äº†ã€‚</p>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


        <footer>
             
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

        </footer>
    </div>
    <!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
    <script>
        var timeEnd = new Date();
        console.log('è€—æ—¶ï¼š' + (timeEnd - timeStart));
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre').forEach((block) => {
                block.classList.add("line-numbers");
            });
        });
    </script>
    <!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
    <!-- material design -->
    <!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
    <!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
    <!-- toc -->
    <!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
    <!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
    <!-- <script src="/js/main.js"></script> -->
    <script src="/js/prism.js"></script>
</body>
</html>
