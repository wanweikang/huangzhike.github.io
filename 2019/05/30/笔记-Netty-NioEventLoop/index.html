<!DOCTYPE HTML>
<html>
	<head>
		<meta charset="utf-8">
				<script>var timeStart = new Date();</script>
		
		<title>[笔记]-Netty-NioEventLoop | 一个放笔记的地方而已</title>
		
		<meta name="author" content="Huangzhike">
		
		
		<meta name="description" content="没有鸡汤，只有笔记">
		
		
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		
		<meta property="og:title" content="[笔记]-Netty-NioEventLoop"/>
		
		<meta property="og:site_name" content="一个放笔记的地方而已"/>
		
		
		<!-- favicon -->
		<link rel="icon" type="image/ico" href="/ok.ico" sizes="32x32">
 


		<meta name="msapplication-TileColor" content="#009688">
		<meta name="msapplication-TileImage" content="/mstile-144x144.ico">
		<meta name="theme-color" content="#009688">

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Didact+Gothic"> 

		<!-- favicon end -->
		<!-- <link href="//ok.ico" rel="icon"> -->
		
		<!-- toc -->
		<!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
		<!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
		<!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
		<!-- material design -->
		<!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
		<!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
		<!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
		<!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
		<!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
		<link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
		 
		 
		<!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
		<!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
	</head>

<body>
	<nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">菜单</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" href="/">一个放笔记的地方而已</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/" title="">
						<i class="fa fa-home"></i>Index
					</a>
				</li>
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

	<div class="container" >
		<div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[笔记]-Netty-NioEventLoop</h2>
				
				<div>
					<span class="post-time">2019-05-30 19:56:17</span>
				</div>	
				
				<div class="article-content">
				<ul>
<li>NioEventLoop</li>
<li>SingleThreadEventLoop</li>
<li>SingleThreadEventExecutor</li>
<li>AbstractScheduledEventExecutor</li>
<li>AbstractEventExecutor</li>
<li>AbstractExecutorService</li>
</ul>
<p>NioEventLoop：实现模板方法run。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line">public <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">NioEventLoop</span> <span class="keyword">extends</span> <span class="title">SingleThreadEventLoop</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * SelectorProvider</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">SelectorProvider</span> provider;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 唤醒标记，select()方法会阻塞</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicBoolean</span> wakenUp = <span class="keyword">new</span> <span class="type">AtomicBoolean</span>();</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 选择策略</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">SelectStrategy</span> selectStrategy;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Selector</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="type">Selector</span> selector;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">IntSupplier</span> selectNowSupplier = <span class="keyword">new</span> <span class="type">IntSupplier</span>() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        public int get() <span class="keyword">throws</span> <span class="type">Exception</span> &#123;</div><div class="line">            <span class="keyword">return</span> selectNow();</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="type">Selector</span> unwrappedSelector;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 就绪事件的集合，优化时使用</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="type">SelectedSelectionKeySet</span> selectedKeys;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * IO任务占总任务比例</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> volatile int ioRatio = <span class="number">50</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 取消的键数目</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> int cancelledKeys;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> boolean needsToSelectAgain;</div><div class="line"></div><div class="line">    <span class="type">NioEventLoop</span>(<span class="type">NioEventLoopGroup</span> parent, <span class="type">Executor</span> executor, <span class="type">SelectorProvider</span> selectorProvider, <span class="type">SelectStrategy</span> strategy, <span class="type">RejectedExecutionHandler</span> rejectedExecutionHandler) &#123;</div><div class="line">        <span class="keyword">super</span>(parent, executor, <span class="literal">false</span>, <span class="type">DEFAULT_MAX_PENDING_TASKS</span>, rejectedExecutionHandler);</div><div class="line">        <span class="keyword">if</span> (selectorProvider == <span class="literal">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">NullPointerException</span>(<span class="string">"selectorProvider"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (strategy == <span class="literal">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">NullPointerException</span>(<span class="string">"selectStrategy"</span>);</div><div class="line">        &#125;</div><div class="line">        provider = selectorProvider;</div><div class="line">        <span class="comment">// 可能优化处理</span></div><div class="line">        <span class="keyword">final</span> <span class="type">SelectorTuple</span> selectorTuple = openSelector();</div><div class="line">        selector = selectorTuple.selector;</div><div class="line">        unwrappedSelector = selectorTuple.unwrappedSelector;</div><div class="line">        selectStrategy = strategy;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>直接看重点</p>
<p>NioEventLoop#run</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 1. 轮询Channel选择就绪的IO事件</div><div class="line"> * 2. 处理就绪的IO事件</div><div class="line"> * 3. 处理任务队列中的任务</div><div class="line"> */</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (; ; ) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="comment">// 如果有任务待执行，返回selectNow()；否则返回SelectStrategy.SELECT</span></div><div class="line">                <span class="keyword">switch</span> (selectStrategy.calculateStrategy(selectNowSupplier, hasTasks())) &#123;</div><div class="line">                    <span class="keyword">case</span> SelectStrategy.CONTINUE:</div><div class="line">                        <span class="keyword">continue</span>;</div><div class="line">                    <span class="keyword">case</span> SelectStrategy.BUSY_WAIT:</div><div class="line">                    <span class="keyword">case</span> SelectStrategy.SELECT:</div><div class="line">                        // select查询是否有就绪的IO事件，进入前设置唤醒标记wakenUp为<span class="keyword">false</span></div><div class="line">                        select(wakenUp.getAndSet(<span class="keyword">false</span>));</div><div class="line">                        <span class="comment">// select之后，如果需要唤醒</span></div><div class="line">                        <span class="keyword">if</span> (wakenUp.get()) &#123;</div><div class="line">                            <span class="comment">// 唤醒一个阻塞在select上的线程，使其继续运行</span></div><div class="line">                            <span class="comment">// 如果先wakeUp，下一个select会立即返回，wakeUp消耗大，尽量少调用</span></div><div class="line">                            selector.wakeup();</div><div class="line">                        &#125;</div><div class="line"></div><div class="line">                    <span class="keyword">default</span>:</div><div class="line">                        // select()阻塞直到就绪</div><div class="line">                        // select(<span class="keyword">long</span> timeout)阻塞的最长时间为timeout</div><div class="line">                        // selectNow()不阻塞，直接返回而不管是否就绪</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                rebuildSelector0();</div><div class="line">                handleLoopException(e);</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            cancelledKeys = <span class="number">0</span>;</div><div class="line">            needsToSelectAgain = <span class="keyword">false</span>;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> ioRatio = <span class="keyword">this</span>.ioRatio;</div><div class="line">            <span class="keyword">if</span> (ioRatio == <span class="number">100</span>) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    <span class="comment">// 处理就绪的IO事件</span></div><div class="line">                    processSelectedKeys();</div><div class="line">                &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                    <span class="comment">// 执行任务队列</span></div><div class="line">                    runAllTasks();</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">final</span> <span class="keyword">long</span> ioStartTime = System.nanoTime();</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    <span class="comment">// 处理就绪的IO事件</span></div><div class="line">                    processSelectedKeys();</div><div class="line">                &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                    <span class="keyword">final</span> <span class="keyword">long</span> ioTime = System.nanoTime() - ioStartTime;</div><div class="line">                    <span class="comment">// 给定时间内执行任务</span></div><div class="line">                    runAllTasks(ioTime * (<span class="number">100</span> - ioRatio) / ioRatio);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">            <span class="comment">// 防止连续异常消耗CPU</span></div><div class="line">            handleLoopException(t);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">if</span> (isShuttingDown()) &#123;</div><div class="line">                closeAll();</div><div class="line">                <span class="keyword">if</span> (confirmShutdown()) &#123;</div><div class="line">                    <span class="keyword">return</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">            handleLoopException(t);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">void</span> <span class="title">processSelectedKeys</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (selectedKeys != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// 使用优化</span></div><div class="line">        processSelectedKeysOptimized();</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// 普通处理</span></div><div class="line">        processSelectedKeysPlain(selector.selectedKeys());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">void</span> processSelectedKeysPlain(Set&lt;SelectionKey&gt; selectedKeys) &#123;</div><div class="line"></div><div class="line">    <span class="comment">// 选择键的集合为空直接返回</span></div><div class="line">    <span class="keyword">if</span> (selectedKeys.isEmpty()) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Iterator&lt;SelectionKey&gt; i = selectedKeys.iterator();</div><div class="line">    <span class="keyword">for</span> (; ; ) &#123;</div><div class="line">        <span class="keyword">final</span> SelectionKey k = i.<span class="keyword">next</span>();</div><div class="line">        <span class="keyword">final</span> Object a = k.attachment();</div><div class="line">        i.remove();</div><div class="line"></div><div class="line">        <span class="comment">// IO事件由Netty处理</span></div><div class="line">        <span class="keyword">if</span> (a <span class="keyword">instanceof</span> AbstractNioChannel) &#123;</div><div class="line">            processSelectedKey(k, (AbstractNioChannel) a);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// IO事件由自定义任务处理</span></div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            @SuppressWarnings(<span class="string">"unchecked"</span>) NioTask&lt;SelectableChannel&gt; <span class="keyword">task</span> = (NioTask&lt;SelectableChannel&gt;) a;</div><div class="line">            processSelectedKey(k, <span class="keyword">task</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!i.hasNext()) &#123;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 取消的选择键达到CLEANUP_INTERVAL时，重新执行一个selectAgain</span></div><div class="line">        <span class="keyword">if</span> (needsToSelectAgain) &#123;</div><div class="line">            <span class="comment">// 使用selectNow()并将needsToSelectAgain标记设置为false</span></div><div class="line">            selectAgain();</div><div class="line">            selectedKeys = selector.selectedKeys();</div><div class="line">            <span class="keyword">if</span> (selectedKeys.isEmpty()) &#123;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                i = selectedKeys.iterator();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processSelectedKey</span>(<span class="params">SelectionKey k, AbstractNioChannel ch</span>) </span>&#123;</div><div class="line">    final AbstractNioChannel.NioUnsafe <span class="keyword">unsafe</span> = ch.<span class="keyword">unsafe</span>();</div><div class="line">    <span class="comment">// 选择键无效</span></div><div class="line">    <span class="keyword">if</span> (!k.isValid()) &#123;</div><div class="line">        final EventLoop eventLoop;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            eventLoop = ch.eventLoop();</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable ignored) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Channel已不在该EventLoop，直接返回</span></div><div class="line">        <span class="keyword">if</span> (eventLoop != <span class="keyword">this</span> || eventLoop == <span class="literal">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// Channel还在EventLoop，关闭Channel</span></div><div class="line">        <span class="keyword">unsafe</span>.close(<span class="keyword">unsafe</span>.voidPromise());</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">int</span> readyOps = k.readyOps();</div><div class="line">        <span class="comment">// 客户端连接事件</span></div><div class="line">        <span class="keyword">if</span> ((readyOps &amp; SelectionKey.OP_CONNECT) != <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">int</span> ops = k.interestOps();</div><div class="line">            <span class="comment">// 连接完成后客户端除了连接事件都感兴趣</span></div><div class="line">            ops &amp;= ~SelectionKey.OP_CONNECT;</div><div class="line">            k.interestOps(ops);</div><div class="line">            <span class="comment">// 完成连接</span></div><div class="line">            <span class="keyword">unsafe</span>.finishConnect();</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 写事件</span></div><div class="line">        <span class="keyword">if</span> ((readyOps &amp; SelectionKey.OP_WRITE) != <span class="number">0</span>) &#123;</div><div class="line">            ch.<span class="keyword">unsafe</span>().forceFlush();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// readyOps == 0为对epoll bug的处理，防止死循环</span></div><div class="line">        <span class="keyword">if</span> ((readyOps &amp; (SelectionKey.OP_READ | SelectionKey.OP_ACCEPT)) != <span class="number">0</span> || readyOps == <span class="number">0</span>) &#123;</div><div class="line">            <span class="comment">// OP_READ及OP_ACCEPT都抽象为read事件</span></div><div class="line">            <span class="comment">// Server NioMessageUnsafe#read</span></div><div class="line">            <span class="comment">// Client NioByteUnsafe#read</span></div><div class="line">            <span class="keyword">unsafe</span>.read();</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">catch</span> (CancelledKeyException ignored) &#123;</div><div class="line">        <span class="keyword">unsafe</span>.close(<span class="keyword">unsafe</span>.voidPromise());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>一个NioEventLoopGroup下包含多个NioEventLoop。</p>
<p>一个NioEventLoop中包含一个Selector，一个任务队列，一个调度任务队列。</p>
<p>一个NioEventLoop的Selector上可以注册多个Channel。</p>
<p>对于Boss NioEventLoop，轮询到的是基本是连接事件（OP_ACCEPT）。</p>
<p>对于Worker NioEventLoop，轮询到的基本是IO读写事件。</p>
<p>当用户在非IO线程调用Channel的各种方法时，将相关操作封装成一个任务并放入任务队列中，保证相关操作在IO线程中串行执行。</p>
<p>SingleThreadEventLoop：实现对Channel的注册。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleThreadEventLoop</span> <span class="keyword">extends</span> <span class="title">SingleThreadEventExecutor</span> <span class="keyword">implements</span> <span class="title">EventLoop</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Queue&lt;Runnable&gt; tailTasks;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">SingleThreadEventLoop</span><span class="params">(EventLoopGroup parent, Executor executor, <span class="keyword">boolean</span> addTaskWakesUp, <span class="keyword">int</span> maxPendingTasks, RejectedExecutionHandler rejectedExecutionHandler)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(parent, executor, addTaskWakesUp, maxPendingTasks, rejectedExecutionHandler);</div><div class="line">        tailTasks = newTaskQueue(maxPendingTasks);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> EventLoopGroup <span class="title">parent</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> (EventLoopGroup) <span class="keyword">super</span>.parent();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> EventLoop <span class="title">next</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> (EventLoop) <span class="keyword">super</span>.next();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> ChannelFuture <span class="title">register</span><span class="params">(Channel channel)</span> </span>&#123;</div><div class="line">        <span class="comment">// 绑定EventLoop到Channel</span></div><div class="line">        <span class="keyword">return</span> register(<span class="keyword">new</span> DefaultChannelPromise(channel, <span class="keyword">this</span>));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> ChannelFuture <span class="title">register</span><span class="params">(<span class="keyword">final</span> ChannelPromise promise)</span> </span>&#123;</div><div class="line">        ObjectUtil.checkNotNull(promise, <span class="string">"promise"</span>);</div><div class="line">        <span class="comment">// 委托给AbstractUnsafe</span></div><div class="line">        promise.channel().unsafe().register(<span class="keyword">this</span>, promise);</div><div class="line">        <span class="keyword">return</span> promise;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>SingleThreadEventExecutor：实现了任务执行器，覆盖execute方法，提交任务到队列。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleThreadEventExecutor</span> <span class="keyword">extends</span> <span class="title">AbstractScheduledEventExecutor</span> <span class="keyword">implements</span> <span class="title">OrderedEventExecutor</span> </span>&#123;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">SingleThreadEventExecutor</span><span class="params">(EventExecutorGroup parent, Executor executor, <span class="keyword">boolean</span> addTaskWakesUp, <span class="keyword">int</span> maxPendingTasks, RejectedExecutionHandler rejectedHandler)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(parent);</div><div class="line">        <span class="keyword">this</span>.addTaskWakesUp = addTaskWakesUp;</div><div class="line">        <span class="keyword">this</span>.maxPendingTasks = Math.max(<span class="number">16</span>, maxPendingTasks);</div><div class="line">        <span class="comment">// 包装一下</span></div><div class="line">        <span class="keyword">this</span>.executor = ThreadExecutorMap.apply(executor, <span class="keyword">this</span>);</div><div class="line">        taskQueue = newTaskQueue(<span class="keyword">this</span>.maxPendingTasks);</div><div class="line">        rejectedExecutionHandler = ObjectUtil.checkNotNull(rejectedHandler, <span class="string">"rejectedHandler"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Runnable task)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (task == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"task"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">boolean</span> inEventLoop = inEventLoop();</div><div class="line">        <span class="comment">// 直接添加到队列</span></div><div class="line">        addTask(task);</div><div class="line"></div><div class="line">        <span class="comment">// 第一次是在主线程中运行的，会启动线程</span></div><div class="line">        <span class="keyword">if</span> (!inEventLoop) &#123;</div><div class="line">            <span class="comment">// 延迟启动，只有当提交第一个任务时线程才启动</span></div><div class="line">            startThread();</div><div class="line">            <span class="keyword">if</span> (isShutdown()) &#123;</div><div class="line">                <span class="keyword">boolean</span> reject = <span class="keyword">false</span>;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    <span class="keyword">if</span> (removeTask(task)) &#123;</div><div class="line">                        reject = <span class="keyword">true</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">catch</span> (UnsupportedOperationException e) &#123;</div><div class="line"></div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (reject) &#123;</div><div class="line">                    <span class="comment">// 线程关闭时则阻止添加，抛出异常</span></div><div class="line">                    reject();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// addTaskWakesUp是否唤醒线程，构造方法配置，wakesUpForTask()可由子类覆盖，默认唤醒</span></div><div class="line">        <span class="keyword">if</span> (!addTaskWakesUp &amp;&amp; wakesUpForTask(task)) &#123;</div><div class="line">            wakeup(inEventLoop);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>AbstractScheduledEventExecutor：将任务封装为ScheduledFutureTask提交给调度任务队列。</p>
<p>AbstractEventExecutor：实现newTaskFor，使用PromiseTask表示待执行的任务。</p>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


		<footer>
			 
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

		</footer>
	</div>
	<!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
	<script src="/js/highlight.js"></script> 
	<script>hljs.initHighlightingOnLoad();var timeEnd = new Date();console.log('耗时：' + (timeEnd - timeStart));</script>
	<!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
	<!-- material design -->
	<!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
	<!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
	<!-- toc -->
	<!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
	<!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
	<!-- <script src="/js/main.js"></script> -->
</body>
</html>
