<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
        <script>
            var timeStart = new Date();
        </script>
        
        <title>[ç¬”è®°]-Netty-NioEventLoop | ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜</title>
        
        <meta name="author" content="huangzhike">
        
        
        <meta name="description" content="å®è¯è¯´ï¼ŒNettyçš„è®¾è®¡å’Œç»“æ„å¤ªç¹çäº†ï¼Œå¯èƒ½æˆ‘æ²¡ç†è§£ä½œè€…çš„æƒ³æ³•å§ã€‚


NioEventLoop
SingleThreadEventLoop
SingleThreadEventExecutor
AbstractScheduledEventExecutor
AbstractEventExecutor
">
        
        
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        
        <meta property="og:title" content="[ç¬”è®°]-Netty-NioEventLoop"/>
        
        <meta property="og:site_name" content="ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜"/>
        
        
        <!-- favicon -->
        <link rel="icon" type="image/ico" href="/ok.ico" sizes="32x32">
        <meta name="msapplication-TileColor" content="#009688">
        <meta name="msapplication-TileImage" content="/mstile-144x144.ico">
        <meta name="theme-color" content="#009688">
        <!-- favicon end -->
        <!-- <link href="//ok.ico" rel="icon"> -->
        
        <!-- toc -->
        <!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
        <!-- material design -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
        <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
        
        <!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
        <!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
    <meta name="generator" content="Hexo 4.2.1"></head>

<body>
    <nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">èœå•</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" title="ä¸‹ä¸€å¥æ˜¯ï¼šå®¢æœ‰å¯äººæœŸä¸æ¥ã€‚å°æ—¶å€™ï¼Œå–œæ¬¢é åœ¨é˜³å°ä¸Šï¼Œä¸€è¾¹å¹é£ï¼Œä¸€è¾¹çœ‹ä¹¦ï¼Œå–œæ¬¢è¯»ä¹¦å—ï¼Œéªšå¹´ï¼Ÿ" href="/">ä¹¦å½“å¿«æ„è¯»æ˜“å°½</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" target="_blank" rel="noopener" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

    <div class="container" >
        <div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[ç¬”è®°]-Netty-NioEventLoop</h2>
				
				<div>
					<div class="post-time">2019-05-30</div>
				</div>
				
				<div class="article-content">
				<p>å®è¯è¯´ï¼ŒNettyçš„è®¾è®¡å’Œç»“æ„å¤ªç¹çäº†ï¼Œå¯èƒ½æˆ‘æ²¡ç†è§£ä½œè€…çš„æƒ³æ³•å§ã€‚</p>
<hr>
<ul>
<li>NioEventLoop</li>
<li>SingleThreadEventLoop</li>
<li>SingleThreadEventExecutor</li>
<li>AbstractScheduledEventExecutor</li>
<li>AbstractEventExecutor</li>
<li>AbstractExecutorService</li>
</ul>
<p>NioEventLoop</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">NioEventLoop</span> <span class="token keyword">extends</span> <span class="token class-name">SingleThreadEventLoop</span> <span class="token punctuation">{</span>

    <span class="token comment" spellcheck="true">/**
     * SelectorProvider
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> SelectorProvider provider<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * å”¤é†’æ ‡è®°ï¼Œselect()æ–¹æ³•ä¼šé˜»å¡
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> AtomicBoolean wakenUp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicBoolean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * é€‰æ‹©ç­–ç•¥
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> SelectStrategy selectStrategy<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * Selector
     */</span>
    <span class="token keyword">private</span> Selector selector<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> IntSupplier selectNowSupplier <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntSupplier</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">selectNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> Selector unwrappedSelector<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * å°±ç»ªäº‹ä»¶çš„é›†åˆï¼Œä¼˜åŒ–æ—¶ä½¿ç”¨
     */</span>
    <span class="token keyword">private</span> SelectedSelectionKeySet selectedKeys<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * IOä»»åŠ¡å æ€»ä»»åŠ¡æ¯”ä¾‹
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> ioRatio <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * å–æ¶ˆçš„é”®æ•°ç›®
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> cancelledKeys<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">boolean</span> needsToSelectAgain<span class="token punctuation">;</span>

    <span class="token function">NioEventLoop</span><span class="token punctuation">(</span>NioEventLoopGroup parent<span class="token punctuation">,</span> Executor executor<span class="token punctuation">,</span> SelectorProvider selectorProvider<span class="token punctuation">,</span> SelectStrategy strategy<span class="token punctuation">,</span> RejectedExecutionHandler rejectedExecutionHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> executor<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> DEFAULT_MAX_PENDING_TASKS<span class="token punctuation">,</span> rejectedExecutionHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ...</span>
        provider <span class="token operator">=</span> selectorProvider<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¯èƒ½ä¼˜åŒ–å¤„ç†</span>
        <span class="token keyword">final</span> SelectorTuple selectorTuple <span class="token operator">=</span> <span class="token function">openSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        selector <span class="token operator">=</span> selectorTuple<span class="token punctuation">.</span>selector<span class="token punctuation">;</span>
        unwrappedSelector <span class="token operator">=</span> selectorTuple<span class="token punctuation">.</span>unwrappedSelector<span class="token punctuation">;</span>
        selectStrategy <span class="token operator">=</span> strategy<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span></code></pre>
<hr>
<p>NioEventLoop#run</p>
<ul>
<li>è½®è¯¢Channelé€‰æ‹©å°±ç»ªçš„IOäº‹ä»¶</li>
<li>å¤„ç†å°±ç»ªçš„IOäº‹ä»¶</li>
<li>å¤„ç†ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡</li>
</ul>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å¦‚æœæœ‰ä»»åŠ¡å¾…æ‰§è¡Œï¼Œè¿”å›selectNow()ï¼›å¦åˆ™è¿”å›SelectStrategy.SELECT</span>
                    <span class="token keyword">switch</span> <span class="token punctuation">(</span>selectStrategy<span class="token punctuation">.</span><span class="token function">calculateStrategy</span><span class="token punctuation">(</span>selectNowSupplier<span class="token punctuation">,</span> <span class="token function">hasTasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">case</span> SelectStrategy<span class="token punctuation">.</span>CONTINUE<span class="token operator">:</span>
                            <span class="token keyword">continue</span><span class="token punctuation">;</span>
                        <span class="token keyword">case</span> SelectStrategy<span class="token punctuation">.</span>BUSY_WAIT<span class="token operator">:</span>
                        <span class="token keyword">case</span> SelectStrategy<span class="token punctuation">.</span>SELECT<span class="token operator">:</span>
                            <span class="token comment" spellcheck="true">// selectæŸ¥è¯¢æ˜¯å¦æœ‰å°±ç»ªçš„IOäº‹ä»¶ï¼Œè¿›å…¥å‰è®¾ç½®å”¤é†’æ ‡è®°wakenUpä¸ºfalseï¼Œæ ‡æ˜çº¿ç¨‹å°†è¦è¢«é˜»å¡</span>
                            <span class="token function">select</span><span class="token punctuation">(</span>wakenUp<span class="token punctuation">.</span><span class="token function">getAndSet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// å”¤é†’æ ‡è®°wakenUpä¸ºtrueï¼Œè¯´æ˜å½“å‰ä»»åŠ¡é˜Ÿåˆ—æœ‰ä»»åŠ¡</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>wakenUp<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token comment" spellcheck="true">// å”¤é†’ä¸€ä¸ªé˜»å¡åœ¨selectä¸Šçš„çº¿ç¨‹ï¼Œä¸è¿‡åªæœ‰NioEventLoopä¸€ä¸ªçº¿ç¨‹ï¼Œæ‰€ä»¥å½“å‰åº”è¯¥æ²¡æœ‰çº¿ç¨‹è¢«é˜»å¡ï¼Ÿ</span>
                                <span class="token comment" spellcheck="true">// è¿™é‡ŒwakeUpï¼Œä¸‹ä¸ªselectä¼šç«‹å³è¿”å›ï¼Œæ‰€ä»¥ç›®çš„æ˜¯ï¼Ÿ</span>
                                selector<span class="token punctuation">.</span><span class="token function">wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token keyword">default</span><span class="token operator">:</span>
                            <span class="token comment" spellcheck="true">// selectNowåè¿›æ¥</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">rebuildSelector0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">handleLoopException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                cancelledKeys <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                needsToSelectAgain <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// IOæ—¶é—´ / ä»»åŠ¡æ—¶é—´</span>
                <span class="token keyword">final</span> <span class="token keyword">int</span> ioRatio <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ioRatio<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ioRatio <span class="token operator">==</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// å…ˆå¤„ç†å°±ç»ªçš„IOäº‹ä»¶</span>
                        <span class="token function">processSelectedKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// æœ€åå†æ‰§è¡Œä»»åŠ¡é˜Ÿåˆ—</span>
                        <span class="token function">runAllTasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">final</span> <span class="token keyword">long</span> ioStartTime <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// å¤„ç†å°±ç»ªçš„IOäº‹ä»¶</span>
                        <span class="token function">processSelectedKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                        <span class="token keyword">final</span> <span class="token keyword">long</span> ioTime <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> ioStartTime<span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// ç»™å®šæ—¶é—´å†…æ‰§è¡Œä»»åŠ¡</span>
                        <span class="token function">runAllTasks</span><span class="token punctuation">(</span>ioTime <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">-</span> ioRatio<span class="token punctuation">)</span> <span class="token operator">/</span> ioRatio<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// é˜²æ­¢è¿ç»­å¼‚å¸¸æ¶ˆè€—CPU</span>
                <span class="token function">handleLoopException</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isShuttingDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ...</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">handleLoopException</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>NioEventLoop#select</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> oldWakenUp<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        Selector selector <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>selector<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> selectCnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">long</span> currentTimeNanos <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ¯æ¬¡selectçš„æˆªæ­¢æ—¶é—´æˆ³ï¼ŒdelayNanosè¿”å›æœ€è¿‘çš„ä¸€ä¸ªè°ƒåº¦ä»»åŠ¡çš„åˆ°æœŸæ—¶é—´ï¼Œæ²¡æœ‰è°ƒåº¦ä»»åŠ¡è¿”å›1ç§’</span>
            <span class="token keyword">long</span> selectDeadLineNanos <span class="token operator">=</span> currentTimeNanos <span class="token operator">+</span> <span class="token function">delayNanos</span><span class="token punctuation">(</span>currentTimeNanos<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å°†è¶…æ—¶æ—¶é—´æ¢ç®—ä¸ºæ¯«ç§’</span>
                <span class="token keyword">long</span> timeoutMillis <span class="token operator">=</span> <span class="token punctuation">(</span>selectDeadLineNanos <span class="token operator">-</span> currentTimeNanos <span class="token operator">+</span> 500000L<span class="token punctuation">)</span> <span class="token operator">/</span> 1000000L<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ä¸è¶³1msï¼Œä¸å†selecté˜»å¡</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>timeoutMillis <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å¦‚æœä¸€æ¬¡selectæ“ä½œéƒ½æ²¡æœ‰è¿›è¡Œ</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>selectCnt <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// selectNowåé©¬ä¸Šè¿”å›</span>
                        selector<span class="token punctuation">.</span><span class="token function">selectNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        selectCnt <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// å¦‚æœä»»åŠ¡é˜Ÿåˆ—éç©ºï¼Œå¹¶ä¸”å”¤é†’æ ‡å¿—ä¸ºfalseï¼Œé‚£ä¹ˆéœ€è¦CASæ›´æ–°ä¸ºtrueï¼Œå¦‚æœæˆåŠŸ</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasTasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> wakenUp<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// selectNowè¿”å›ï¼Œä¸è€½è¯¯ä»»åŠ¡æ‰§è¡Œ</span>
                    selector<span class="token punctuation">.</span><span class="token function">selectNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    selectCnt <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// çº¿ç¨‹å°†é˜»å¡è‡³è¶…æ—¶æˆ–è€…äº‹ä»¶å°±ç»ªæˆ–è€…è¢«å”¤é†’</span>
                <span class="token comment" spellcheck="true">// é˜»å¡æœŸé—´å¦‚æœä½¿ç”¨å¤–éƒ¨çº¿ç¨‹æäº¤ä¸€ä¸ªä»»åŠ¡ï¼Œä¼šè°ƒç”¨NioEventLoop#wakeupï¼Œçº¿ç¨‹å”¤é†’è·³å‡ºï¼Œæ‰§è¡Œæäº¤ä»»åŠ¡</span>
                <span class="token comment" spellcheck="true">// å¦‚æœæäº¤å¤šä¸ªä»»åŠ¡ï¼Œä½¿ç”¨wakenUpå”¤é†’æ ‡è®°å¯ä»¥ä½¿selector.wakeupåªæ‰§è¡Œä¸€æ¬¡ï¼ŒwakeUpæ¶ˆè€—å¤§ï¼Œå°½é‡å°‘è°ƒç”¨</span>
                <span class="token keyword">int</span> selectedKeys <span class="token operator">=</span> selector<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>timeoutMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>
                selectCnt<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// æœ‰å°±ç»ªçš„IOäº‹ä»¶ || selectå‰å°±éœ€è¦å”¤é†’ || å¤–éƒ¨è®¾ç½®wakenUpä¸ºçœŸ || æœ‰å¾…æ‰§è¡Œä»»åŠ¡ || æœ‰å¾…æ‰§è¡Œè°ƒåº¦ä»»åŠ¡</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>selectedKeys <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> oldWakenUp <span class="token operator">||</span> wakenUp<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">hasTasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">hasScheduledTasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// è·³å‡ºå¾ªç¯</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// å¦‚æœçº¿ç¨‹è¢«ä¸­æ–­ï¼Œé‚£ä¹ˆé€€å‡º</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    selectCnt <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">long</span> time <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>time <span class="token operator">-</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">toNanos</span><span class="token punctuation">(</span>timeoutMillis<span class="token punctuation">)</span> <span class="token operator">>=</span> currentTimeNanos<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    selectCnt <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>SELECTOR_AUTO_REBUILD_THRESHOLD <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> selectCnt <span class="token operator">>=</span> SELECTOR_AUTO_REBUILD_THRESHOLD<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å¤„ç†JDKçš„BUG</span>
                    selector <span class="token operator">=</span> <span class="token function">selectRebuildSelector</span><span class="token punctuation">(</span>selectCnt<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    selectCnt <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                currentTimeNanos <span class="token operator">=</span> time<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">CancelledKeyException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>NioEventLoop#selectRebuildSelector</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> Selector <span class="token function">selectRebuildSelector</span><span class="token punctuation">(</span><span class="token keyword">int</span> selectCnt<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">/*
         * EPOLLçš„BUGå¯¼è‡´selectæ–¹æ³•ä¸é˜»å¡è€Œç›´æ¥è¿”å›ä¸”è¿”å›å€¼ä¸º0ï¼Œå‡ºç°ç©ºè½®è¯¢ï¼Œè§£å†³åŠæ³•ï¼š
         * å¯¹selectè¿”å›0çš„æ“ä½œè®¡æ•°ï¼Œå¦‚æœæ¬¡æ•°å¤§äºé˜ˆå€¼SELECTOR_AUTO_REBUILD_THRESHOLDå°±æ–°å»ºä¸€ä¸ªSelector
         * å°†æ³¨å†Œåˆ°æ—§çš„Selectorä¸Šçš„Channelé‡æ–°æ³¨å†Œåˆ°æ–°çš„Selectorä¸Š
         */</span>
        <span class="token function">rebuildSelector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Selector selector <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>selector<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// é‡å»ºSelectorä¹‹åç«‹å³selectNow</span>
        selector<span class="token punctuation">.</span><span class="token function">selectNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> selector<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>NioEventLoop#processSelectedKeys</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processSelectedKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>selectedKeys <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ä½¿ç”¨ä¼˜åŒ–</span>
            <span class="token function">processSelectedKeysOptimized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ™®é€šå¤„ç†</span>
            <span class="token function">processSelectedKeysPlain</span><span class="token punctuation">(</span>selector<span class="token punctuation">.</span><span class="token function">selectedKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>NioEventLoop#processSelectedKeysPlain</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processSelectedKeysPlain</span><span class="token punctuation">(</span>Set<span class="token operator">&lt;</span>SelectionKey<span class="token operator">></span> selectedKeys<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// é€‰æ‹©é”®çš„é›†åˆä¸ºç©ºç›´æ¥è¿”å›</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>selectedKeys<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        Iterator<span class="token operator">&lt;</span>SelectionKey<span class="token operator">></span> i <span class="token operator">=</span> selectedKeys<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> SelectionKey k <span class="token operator">=</span> i<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> Object a <span class="token operator">=</span> k<span class="token punctuation">.</span><span class="token function">attachment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å¤„ç†å‰å…ˆç§»é™¤</span>
            i<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// IOäº‹ä»¶ç”±Nettyå¤„ç†ï¼Œé»˜è®¤</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token keyword">instanceof</span> <span class="token class-name">AbstractNioChannel</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">processSelectedKey</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> <span class="token punctuation">(</span>AbstractNioChannel<span class="token punctuation">)</span> a<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// IOäº‹ä»¶ç”±è‡ªå®šä¹‰ä»»åŠ¡å¤„ç†ï¼Œåœ¨æ³¨å†Œäº†è‡ªå®šä¹‰çš„SelectableChannelåä½¿ç”¨</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span> NioTask<span class="token operator">&lt;</span>SelectableChannel<span class="token operator">></span> task <span class="token operator">=</span> <span class="token punctuation">(</span>NioTask<span class="token operator">&lt;</span>SelectableChannel<span class="token operator">></span><span class="token punctuation">)</span> a<span class="token punctuation">;</span>
                <span class="token function">processSelectedKey</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> task<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>i<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å–æ¶ˆçš„é€‰æ‹©é”®è¾¾åˆ°CLEANUP_INTERVALæ—¶ï¼ŒselectAgain</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>needsToSelectAgain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// selectNowå¹¶å°†needsToSelectAgainæ ‡è®°è®¾ç½®ä¸ºfalse</span>
                <span class="token function">selectAgain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                selectedKeys <span class="token operator">=</span> selector<span class="token punctuation">.</span><span class="token function">selectedKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>selectedKeys<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    i <span class="token operator">=</span> selectedKeys<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>NioEventLoop#processSelectedKey</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">processSelectedKey</span><span class="token punctuation">(</span>SelectionKey k<span class="token punctuation">,</span> AbstractNioChannel ch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> AbstractNioChannel<span class="token punctuation">.</span>NioUnsafe unsafe <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">unsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// é€‰æ‹©é”®æ— æ•ˆ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>k<span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> EventLoop eventLoop<span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                eventLoop <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">eventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// Channelå·²ä¸åœ¨è¯¥EventLoopï¼Œç›´æ¥è¿”å›</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>eventLoop <span class="token operator">!=</span> <span class="token keyword">this</span> <span class="token operator">||</span> eventLoop <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// Channelè¿˜åœ¨EventLoopï¼Œå…³é—­Channel</span>
            unsafe<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">voidPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> readyOps <span class="token operator">=</span> k<span class="token punctuation">.</span><span class="token function">readyOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å®¢æˆ·ç«¯è¿æ¥å°±ç»ª</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>readyOps <span class="token operator">&amp;</span> SelectionKey<span class="token punctuation">.</span>OP_CONNECT<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> ops <span class="token operator">=</span> k<span class="token punctuation">.</span><span class="token function">interestOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// è¿æ¥å®Œæˆåå®¢æˆ·ç«¯é™¤äº†è¿æ¥äº‹ä»¶éƒ½æ„Ÿå…´è¶£</span>
                ops <span class="token operator">&amp;=</span> <span class="token operator">~</span>SelectionKey<span class="token punctuation">.</span>OP_CONNECT<span class="token punctuation">;</span>
                k<span class="token punctuation">.</span><span class="token function">interestOps</span><span class="token punctuation">(</span>ops<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å®Œæˆè¿æ¥</span>
                unsafe<span class="token punctuation">.</span><span class="token function">finishConnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å¯å†™å°±ç»ª</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>readyOps <span class="token operator">&amp;</span> SelectionKey<span class="token punctuation">.</span>OP_WRITE<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ch<span class="token punctuation">.</span><span class="token function">unsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forceFlush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// readyOps == 0ä¸ºå¯¹epollçš„bugçš„å¤„ç†ï¼Œé˜²æ­¢æ­»å¾ªç¯</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>readyOps <span class="token operator">&amp;</span> <span class="token punctuation">(</span>SelectionKey<span class="token punctuation">.</span>OP_READ <span class="token operator">|</span> SelectionKey<span class="token punctuation">.</span>OP_ACCEPT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> readyOps <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// OP_READåŠOP_ACCEPTéƒ½æŠ½è±¡ä¸ºreadäº‹ä»¶</span>
                <span class="token comment" spellcheck="true">// Server NioMessageUnsafe#read</span>
                <span class="token comment" spellcheck="true">// Client NioByteUnsafe#read</span>
                unsafe<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">CancelledKeyException</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            unsafe<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">voidPromise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>ä¸€ä¸ªNioEventLoopGroupä¸‹åŒ…å«å¤šä¸ªNioEventLoopã€‚</p>
<p>ä¸€ä¸ªNioEventLoopä¸­åŒ…å«ä¸€ä¸ªSelectorï¼Œä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ï¼Œä¸€ä¸ªè°ƒåº¦ä»»åŠ¡é˜Ÿåˆ—ã€‚</p>
<p>ä¸€ä¸ªNioEventLoopçš„Selectorä¸Šå¯ä»¥æ³¨å†Œå¤šä¸ªChannelã€‚</p>
<p>å¯¹äºBossï¼Œè½®è¯¢åˆ°çš„æ˜¯åŸºæœ¬æ˜¯è¿æ¥äº‹ä»¶ï¼ˆOP_ACCEPTï¼‰ã€‚</p>
<p>å¯¹äºWorkerï¼Œè½®è¯¢åˆ°çš„åŸºæœ¬æ˜¯IOè¯»å†™äº‹ä»¶ã€‚</p>
<p>åœ¨éIOçº¿ç¨‹è°ƒç”¨Channelçš„å„ç§æ–¹æ³•æ—¶ï¼Œå°†ç›¸å…³æ“ä½œå°è£…æˆä¸€ä¸ªä»»åŠ¡å¹¶æ”¾å…¥ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œä¿è¯ç›¸å…³æ“ä½œåœ¨IOçº¿ç¨‹ä¸­ä¸²è¡Œæ‰§è¡Œã€‚</p>
<p>SingleThreadEventExecutor#execute</p>
<pre class=" language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span>Runnable task<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// ...</span>
        <span class="token keyword">boolean</span> inEventLoop <span class="token operator">=</span> <span class="token function">inEventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ç›´æ¥æ·»åŠ åˆ°é˜Ÿåˆ—</span>
        <span class="token function">addTask</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// ç¬¬ä¸€æ¬¡æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­è¿è¡Œçš„ï¼Œä¼šå¯åŠ¨çº¿ç¨‹</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inEventLoop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å»¶è¿Ÿå¯åŠ¨ï¼Œåªæœ‰å½“æäº¤ç¬¬ä¸€ä¸ªä»»åŠ¡æ—¶çº¿ç¨‹æ‰å¯åŠ¨</span>
            <span class="token function">startThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ...</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// addTaskWakesUpæ˜¯å¦å”¤é†’çº¿ç¨‹ï¼Œæ„é€ æ–¹æ³•é…ç½®ï¼ŒwakesUpForTaskç”±å­ç±»è¦†ç›–ï¼Œé»˜è®¤å”¤é†’</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>addTaskWakesUp <span class="token operator">&amp;&amp;</span> <span class="token function">wakesUpForTask</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">wakeup</span><span class="token punctuation">(</span>inEventLoop<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


        <footer>
             
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

        </footer>
    </div>
    <!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
    <script>
        var timeEnd = new Date();
        console.log('è€—æ—¶ï¼š' + (timeEnd - timeStart));
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre').forEach((block) => {
                block.classList.add("line-numbers");
            });
        });
    </script>
    <!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
    <!-- material design -->
    <!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
    <!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
    <!-- toc -->
    <!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
    <!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
    <!-- <script src="/js/main.js"></script> -->
    <script src="/js/prism.js"></script>
</body>
</html>
