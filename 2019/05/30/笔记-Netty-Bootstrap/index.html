<!DOCTYPE HTML>
<html>
	<head>
		<meta charset="utf-8">
				<script>var timeStart = new Date();</script>
		
		<title>[笔记]-Netty-Bootstrap | 一个放笔记的地方而已</title>
		
		<meta name="author" content="Huangzhike">
		
		
		<meta name="description" content="没有鸡汤，只有笔记">
		
		
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		
		<meta property="og:title" content="[笔记]-Netty-Bootstrap"/>
		
		<meta property="og:site_name" content="一个放笔记的地方而已"/>
		
		
		<!-- favicon -->
		<link rel="icon" type="image/ico" href="/ok.ico" sizes="32x32">
 


		<meta name="msapplication-TileColor" content="#009688">
		<meta name="msapplication-TileImage" content="/mstile-144x144.ico">
		<meta name="theme-color" content="#009688">

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Didact+Gothic"> 

		<!-- favicon end -->
		<!-- <link href="//ok.ico" rel="icon"> -->
		
		<!-- toc -->
		<!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
		<!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
		<!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
		<!-- material design -->
		<!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
		<!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
		<!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
		<!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
		<!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
		<link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
		 
		 
		<!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
		<!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
	</head>

<body>
	<nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">菜单</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" href="/">一个放笔记的地方而已</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/" title="">
						<i class="fa fa-home"></i>Index
					</a>
				</li>
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

	<div class="container" >
		<div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[笔记]-Netty-Bootstrap</h2>
				
				<div>
					<span class="post-time">2019-05-30 19:56:17</span>
				</div>	
				
				<div class="article-content">
				<p>AbstractBootstrap</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">public <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractBootstrap&lt;B</span> <span class="keyword">extends</span> <span class="title">AbstractBootstrap&lt;B</span>, <span class="title">C&gt;</span>, <span class="title">C</span> <span class="keyword">extends</span> <span class="title">Channel&gt;</span> <span class="title">implements</span> <span class="title">Cloneable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 线程池</div><div class="line">     */</div><div class="line">    volatile <span class="type">EventLoopGroup</span> group;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 一般是HandlerInitializer</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> volatile <span class="type">ChannelHandler</span> handler;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Bootstrap#doResolveAndConnect</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="function">ChannelFuture <span class="title">doResolveAndConnect</span><span class="params">(<span class="keyword">final</span> SocketAddress remoteAddress, <span class="keyword">final</span> SocketAddress localAddress)</span> </span>&#123;</div><div class="line">    <span class="comment">// 父类方法，初始化Channel并注册到EventLoop，注册Selector，返回Future</span></div><div class="line">    <span class="keyword">final</span> ChannelFuture regFuture = initAndRegister();</div><div class="line"></div><div class="line">    <span class="keyword">final</span> Channel channel = regFuture.channel();</div><div class="line">    <span class="comment">// 异步注册完成</span></div><div class="line">    <span class="keyword">if</span> (regFuture.isDone()) &#123;</div><div class="line">        <span class="keyword">if</span> (!regFuture.isSuccess()) &#123;</div><div class="line">            <span class="keyword">return</span> regFuture;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 异步注册完成且成功，异步连接</span></div><div class="line">        <span class="keyword">return</span> doResolveAndConnect0(channel, remoteAddress, localAddress, channel.newPromise());</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 异步注册未完成，完成时提交异步连接任务</span></div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">final</span> PendingRegistrationPromise promise = <span class="keyword">new</span> PendingRegistrationPromise(channel);</div><div class="line">        regFuture.addListener(<span class="keyword">new</span> ChannelFutureListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">operationComplete</span><span class="params">(ChannelFuture future)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">                Throwable cause = future.cause();</div><div class="line">                <span class="keyword">if</span> (cause != <span class="keyword">null</span>) &#123;</div><div class="line">                    promise.setFailure(cause);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    promise.registered();</div><div class="line">                    doResolveAndConnect0(channel, remoteAddress, localAddress, promise);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        <span class="keyword">return</span> promise;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>AbstractBootstrap#initAndRegister</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">final ChannelFuture initAndRegister() &#123;</div><div class="line">    Channel channel = <span class="literal">null</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">// 初始化Channel，初始化Pipeline</span></div><div class="line">        channel = channelFactory.<span class="keyword">new</span><span class="type">Channel</span>();</div><div class="line">        <span class="comment">// 模板方法，子类实现</span></div><div class="line">        init(channel);</div><div class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">        <span class="keyword">if</span> (channel != <span class="literal">null</span>) &#123;</div><div class="line">            channel.unsafe().closeForcibly();</div><div class="line">            <span class="comment">// 还没有注册到EventLoop，使用默认线程GlobalEventExecutor</span></div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="type">DefaultChannelPromise</span>(channel, GlobalEventExecutor.INSTANCE).setFailure(t);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="type">DefaultChannelPromise</span>(<span class="keyword">new</span> <span class="type">FailedChannel</span>(), GlobalEventExecutor.INSTANCE).setFailure(t);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 将Channel注册到EventLoopGroup的某个EventLoop，注册NIO Channel到Selector</span></div><div class="line">    ChannelFuture regFuture = config().group().register(channel);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (regFuture.cause() != <span class="literal">null</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (channel.isRegistered()) &#123;</div><div class="line">            channel.close();</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            channel.unsafe().closeForcibly();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> regFuture;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Bootstrap#init</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line"><span class="keyword">void</span> init(Channel channel) throws Exception &#123;</div><div class="line">    ChannelPipeline p = channel.pipeline();</div><div class="line"></div><div class="line">    <span class="comment">// 设置Handler，一般是ChannelInitializer，实现了ChannelInboundHandler</span></div><div class="line">    p.addLast(config.handler());</div><div class="line"></div><div class="line">    <span class="comment">// 设置Channel的选项参数</span></div><div class="line">    <span class="keyword">final</span> <span class="built_in">Map</span>&lt;ChannelOption&lt;?&gt;, <span class="built_in">Object</span>&gt; options = options0();</div><div class="line">    synchronized (options) &#123;</div><div class="line">        setChannelOptions(channel, options, logger);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 设置Channel的属性键值对</span></div><div class="line">    <span class="keyword">final</span> <span class="built_in">Map</span>&lt;AttributeKey&lt;?&gt;, <span class="built_in">Object</span>&gt; attrs = attrs0();</div><div class="line">    synchronized (attrs) &#123;</div><div class="line">        <span class="keyword">for</span> (Entry&lt;AttributeKey&lt;?&gt;, <span class="built_in">Object</span>&gt; e : attrs.entrySet()) &#123;</div><div class="line">            channel.attr((AttributeKey&lt;<span class="built_in">Object</span>&gt;) e.getKey()).<span class="keyword">set</span>(e.getValue());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>SingleThreadEventLoop#register<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="keyword">public</span> ChannelFuture register(<span class="keyword">final</span> ChannelPromise promise) &#123;</div><div class="line">    ObjectUtil.checkNotNull(promise, <span class="string">"promise"</span>);</div><div class="line">    <span class="comment">// 委托给AbstractUnsafe</span></div><div class="line">    promise.channel().unsafe().register(<span class="keyword">this</span>, promise);</div><div class="line">    <span class="keyword">return</span> promise;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>AbstractUnsafe#register<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 注册</div><div class="line"> */</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="function"><span class="keyword">void</span> <span class="title">register</span><span class="params">(EventLoop eventLoop, <span class="keyword">final</span> ChannelPromise promise)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (eventLoop == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"eventLoop"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (isRegistered()) &#123;</div><div class="line">        <span class="comment">// 已经注册则失败</span></div><div class="line">        promise.setFailure(<span class="keyword">new</span> IllegalStateException(<span class="string">"registered to an event loop already"</span>));</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// EventLoop不兼容当前Channel</span></div><div class="line">    <span class="keyword">if</span> (!isCompatible(eventLoop)) &#123;</div><div class="line">        promise.setFailure(<span class="keyword">new</span> IllegalStateException(<span class="string">"incompatible event loop type: "</span> + eventLoop.getClass().getName()));</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 注册Channel到EventLoop</span></div><div class="line">    AbstractChannel.<span class="keyword">this</span>.eventLoop = eventLoop;</div><div class="line">    <span class="comment">// 当前线程为EventLoop线程直接执行，比如unregister再register</span></div><div class="line">    <span class="keyword">if</span> (eventLoop.inEventLoop()) &#123;</div><div class="line">        register0(promise);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 否则提交任务给EventLoop线程执行（异步）</span></div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// 由Channel绑定的EventLoop执行，这里会启动EventLoop线程</span></div><div class="line">            eventLoop.execute(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                    register0(promise);</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">            logger.warn(<span class="string">"Force-closing a channel whose registration task was not accepted by an event loop: &#123;&#125;"</span>, AbstractChannel.<span class="keyword">this</span>, t);</div><div class="line">            <span class="comment">// 异常时关闭Channel</span></div><div class="line">            closeForcibly();</div><div class="line">            closeFuture.setClosed();</div><div class="line">            safeSetFailure(promise, t);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>AbstractUnsafe#register0<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">void</span> <span class="title">register0</span><span class="params">(ChannelPromise promise)</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line"></div><div class="line">        <span class="comment">// 确保Channel没有关闭</span></div><div class="line">        <span class="keyword">if</span> (!promise.setUncancellable() || !ensureOpen(promise)) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">boolean</span> firstRegistration = neverRegistered;</div><div class="line">        <span class="comment">// JDK Channel注册到Selector，模板方法</span></div><div class="line">        <span class="comment">// AbstractNioChannel#doRegister</span></div><div class="line">        doRegister();</div><div class="line">        neverRegistered = <span class="keyword">false</span>;</div><div class="line">        registered = <span class="keyword">true</span>;</div><div class="line">        <span class="comment">// 完成ChannelInitializer的回调，执行initChannel，将处理业务逻辑的用户Handler添加到ChannelPipeline</span></div><div class="line">        pipeline.invokeHandlerAddedIfNeeded();</div><div class="line">        <span class="comment">// 设置异步注册成功，触发回调</span></div><div class="line">        safeSetSuccess(promise);</div><div class="line">        <span class="comment">// 传播Channel注册事件，head开始</span></div><div class="line">        pipeline.fireChannelRegistered();</div><div class="line"></div><div class="line">        <span class="comment">// 服务端ServerSocketChannel接受的客户端Channel此时已被激活</span></div><div class="line">        <span class="keyword">if</span> (isActive()) &#123;</div><div class="line">            <span class="keyword">if</span> (firstRegistration) &#123;</div><div class="line">                <span class="comment">// 首次注册且激活触发Channel激活事件</span></div><div class="line">                pipeline.fireChannelActive();</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// 已设置autoRead</span></div><div class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (config().isAutoRead()) &#123;</div><div class="line">                <span class="comment">// 读取数据，模板方法</span></div><div class="line">                beginRead();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">        <span class="comment">// 模板方法</span></div><div class="line">        closeForcibly();</div><div class="line">        closeFuture.setClosed();</div><div class="line">        safeSetFailure(promise, t);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>AbstractNioChannel#doRegister<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">void</span> <span class="title">doRegister</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    <span class="keyword">boolean</span> selected = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">for</span> (; ; ) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// 将Channel注册到EventLoop的Selector上，0表示注册时不关心任何事件，attachment为Netty的Channel对象本身</span></div><div class="line">            selectionKey = javaChannel().register(eventLoop().unwrappedSelector(), <span class="number">0</span>, <span class="keyword">this</span>);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125; <span class="keyword">catch</span> (CancelledKeyException e) &#123;</div><div class="line">            <span class="keyword">if</span> (!selected) &#123;</div><div class="line">                <span class="comment">// 选择键取消重新selectNow()，刷新因取消而缓存的选择键</span></div><div class="line">                eventLoop().selectNow();</div><div class="line">                selected = <span class="keyword">true</span>;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">throw</span> e;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>DefaultChannelPipeline#invokeHandlerAddedIfNeeded</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 两种情况（但是只执行一次）：</div><div class="line"> * AbstractUnsafe#register，fireChannelRegistered前被调用，异步注册完成就将所有Handler全部加入</div><div class="line"> * head节点的channelRegistered()方法</div><div class="line"> */</div><div class="line"><span class="keyword">final</span> <span class="function"><span class="keyword">void</span> <span class="title">invokeHandlerAddedIfNeeded</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">assert</span> channel.eventLoop().inEventLoop();</div><div class="line">    <span class="comment">// 只执行一次</span></div><div class="line">    <span class="keyword">if</span> (firstRegistration) &#123;</div><div class="line">        firstRegistration = <span class="keyword">false</span>;</div><div class="line">        <span class="comment">// 可能是异步操作，不过基本不是</span></div><div class="line">        callHandlerAddedForAllHandlers();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>DefaultChannelPipeline#callHandlerAddedForAllHandlers<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">void</span> callHandlerAddedForAllHandlers() &#123;</div><div class="line">    <span class="keyword">final</span> PendingHandlerCallback pendingHandlerCallbackHead;</div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">        <span class="comment">// Pipeline，不是Channel</span></div><div class="line">        assert !registered;</div><div class="line">        <span class="comment">// Pipeline已完成注册</span></div><div class="line">        registered = <span class="keyword">true</span>;</div><div class="line">        pendingHandlerCallbackHead = <span class="keyword">this</span>.pendingHandlerCallbackHead;</div><div class="line">        <span class="comment">// 帮助垃圾回收</span></div><div class="line">        <span class="keyword">this</span>.pendingHandlerCallbackHead = <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 不在synchronized块内</span></div><div class="line">    PendingHandlerCallback <span class="keyword">task</span> = pendingHandlerCallbackHead;</div><div class="line">    <span class="keyword">while</span> (<span class="keyword">task</span> != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// 遍历链表依次执行</span></div><div class="line">        <span class="keyword">task</span>.execute();</div><div class="line">        <span class="keyword">task</span> = <span class="keyword">task</span>.<span class="keyword">next</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Bootstrap#doResolveAndConnect0</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="function">ChannelFuture <span class="title">doResolveAndConnect0</span><span class="params">(<span class="keyword">final</span> Channel channel, SocketAddress remoteAddress, <span class="keyword">final</span> SocketAddress localAddress, <span class="keyword">final</span> ChannelPromise promise)</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">// 获取绑定的EventLoop</span></div><div class="line">        <span class="keyword">final</span> EventLoop eventLoop = channel.eventLoop();</div><div class="line">        <span class="comment">// 地址解析</span></div><div class="line">        <span class="keyword">final</span> AddressResolver&lt;SocketAddress&gt; resolver = <span class="keyword">this</span>.resolver.getResolver(eventLoop);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!resolver.isSupported(remoteAddress) || resolver.isResolved(remoteAddress)) &#123;</div><div class="line">            <span class="comment">// 向Channel注册的EventLoop提交异步连接任务</span></div><div class="line">            doConnect(remoteAddress, localAddress, promise);</div><div class="line">            <span class="keyword">return</span> promise;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> Future&lt;SocketAddress&gt; resolveFuture = resolver.resolve(remoteAddress);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (resolveFuture.isDone()) &#123;</div><div class="line">            <span class="keyword">final</span> Throwable resolveFailureCause = resolveFuture.cause();</div><div class="line">            <span class="keyword">if</span> (resolveFailureCause != <span class="keyword">null</span>) &#123;</div><div class="line">                channel.close();</div><div class="line">                promise.setFailure(resolveFailureCause);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                doConnect(resolveFuture.getNow(), localAddress, promise);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> promise;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 回调</span></div><div class="line">        resolveFuture.addListener(<span class="keyword">new</span> FutureListener&lt;SocketAddress&gt;() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">operationComplete</span><span class="params">(Future&lt;SocketAddress&gt; future)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">                <span class="keyword">if</span> (future.cause() != <span class="keyword">null</span>) &#123;</div><div class="line">                    channel.close();</div><div class="line">                    promise.setFailure(future.cause());</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    doConnect(future.getNow(), localAddress, promise);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125; <span class="keyword">catch</span> (Throwable cause) &#123;</div><div class="line">        promise.tryFailure(cause);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> promise;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Bootstrap#doConnect</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="function"><span class="keyword">void</span> <span class="title">doConnect</span><span class="params">(<span class="keyword">final</span> SocketAddress remoteAddress, <span class="keyword">final</span> SocketAddress localAddress, <span class="keyword">final</span> ChannelPromise connectPromise)</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> Channel channel = connectPromise.channel();</div><div class="line">    <span class="comment">// 由Channel绑定的EventLoop执行</span></div><div class="line">    channel.eventLoop().execute(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (localAddress == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="comment">// AbstractChannel#connect</span></div><div class="line">                <span class="comment">// Pipeline#connect</span></div><div class="line">                <span class="comment">// Tail#connect(AbstractChannelHandlerContext#connect)</span></div><div class="line">                <span class="comment">// --&gt;</span></div><div class="line">                <span class="comment">// Head#connect(AbstractNioUnsafe#connect)</span></div><div class="line">                channel.connect(remoteAddress, connectPromise);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                channel.connect(remoteAddress, localAddress, connectPromise);</div><div class="line">            &#125;</div><div class="line">            connectPromise.addListener(ChannelFutureListener.CLOSE_ON_FAILURE);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>AbstractNioUnsafe#connect</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="function"><span class="keyword">void</span> <span class="title">connect</span><span class="params">(<span class="keyword">final</span> SocketAddress remoteAddress, <span class="keyword">final</span> SocketAddress localAddress, <span class="keyword">final</span> ChannelPromise promise)</span> </span>&#123;</div><div class="line">    <span class="comment">// Channel已被关闭</span></div><div class="line">    <span class="keyword">if</span> (!promise.setUncancellable() || !ensureOpen(promise)) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">// 已经在连接</span></div><div class="line">        <span class="keyword">if</span> (connectPromise != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ConnectionPendingException();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">boolean</span> wasActive = isActive();</div><div class="line">        <span class="comment">// 模板方法</span></div><div class="line">        <span class="comment">// NioSocketChannel#doConnect</span></div><div class="line">        <span class="keyword">if</span> (doConnect(remoteAddress, localAddress)) &#123;</div><div class="line">            <span class="comment">// 连接已完成，设置异步结果为成功并触发Channel的Active事件</span></div><div class="line">            fulfillConnectPromise(promise, wasActive);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 连接可能未完成</span></div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            connectPromise = promise;</div><div class="line">            requestedRemoteAddress = remoteAddress;</div><div class="line"></div><div class="line">            <span class="comment">// Netty的连接超时</span></div><div class="line">            <span class="keyword">int</span> connectTimeoutMillis = config().getConnectTimeoutMillis();</div><div class="line">            <span class="keyword">if</span> (connectTimeoutMillis &gt; <span class="number">0</span>) &#123;</div><div class="line">                <span class="comment">// 向EventLoop提交一个调度任务，超时时间已到，则设置异步结果失败然后关闭连接</span></div><div class="line">                connectTimeoutFuture = eventLoop().schedule(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                        ChannelPromise connectPromise = AbstractNioChannel.<span class="keyword">this</span>.connectPromise;</div><div class="line">                        ConnectTimeoutException cause = <span class="keyword">new</span> ConnectTimeoutException(<span class="string">"connection timed out: "</span> + remoteAddress);</div><div class="line">                        <span class="keyword">if</span> (connectPromise != <span class="keyword">null</span> &amp;&amp; connectPromise.tryFailure(cause)) &#123;</div><div class="line">                            close(voidPromise());</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;, connectTimeoutMillis, TimeUnit.MILLISECONDS);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            promise.addListener(<span class="keyword">new</span> ChannelFutureListener() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">operationComplete</span><span class="params">(ChannelFuture future)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">                    <span class="comment">// 连接操作取消，则连接超时检测任务取消</span></div><div class="line">                    <span class="keyword">if</span> (future.isCancelled()) &#123;</div><div class="line">                        <span class="keyword">if</span> (connectTimeoutFuture != <span class="keyword">null</span>) &#123;</div><div class="line">                            connectTimeoutFuture.cancel(<span class="keyword">false</span>);</div><div class="line">                        &#125;</div><div class="line">                        connectPromise = <span class="keyword">null</span>;</div><div class="line">                        close(voidPromise());</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">        promise.tryFailure(annotateConnectException(t, remoteAddress));</div><div class="line">        closeIfClosed();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>NioSocketChannel#doConnect</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">boolean</span> <span class="title">doConnect</span><span class="params">(SocketAddress remoteAddress, SocketAddress localAddress)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    <span class="keyword">if</span> (localAddress != <span class="keyword">null</span>) &#123;</div><div class="line">        doBind0(localAddress);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> success = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">boolean</span> connected = SocketUtils.connect(javaChannel(), remoteAddress);</div><div class="line">        <span class="keyword">if</span> (!connected) &#123;</div><div class="line">            <span class="comment">// 关心OP_CONNECT事件，就绪时调用AbstractNioUnsafe#finishConnect</span></div><div class="line">            <span class="comment">// JDK中的Channel在非阻塞模式下调用connect()方法时，会立即返回</span></div><div class="line">            selectionKey().interestOps(SelectionKey.OP_CONNECT);</div><div class="line">        &#125;</div><div class="line">        success = <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">return</span> connected;</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        <span class="keyword">if</span> (!success) &#123;</div><div class="line">            doClose();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>AbstractNioUnsafe#finishConnect</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">finishConnect</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// 只由EventLoop处理就绪SelectionKey的OP_CONNECT事件时调用，完成连接，连接被取消或超时不会调用</span></div><div class="line">    <span class="function"><span class="keyword">assert</span> <span class="title">eventLoop</span><span class="params">()</span>.<span class="title">inEventLoop</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">boolean</span> wasActive = isActive();</div><div class="line">        <span class="comment">// 模板方法</span></div><div class="line">        doFinishConnect();</div><div class="line">        <span class="comment">// 首次Active触发Active事件</span></div><div class="line">        fulfillConnectPromise(connectPromise, wasActive);</div><div class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">        fulfillConnectPromise(connectPromise, annotateConnectException(t, requestedRemoteAddress));</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (connectTimeoutFuture != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// 连接完成，取消超时检测任务</span></div><div class="line">            connectTimeoutFuture.cancel(<span class="keyword">false</span>);</div><div class="line">        &#125;</div><div class="line">        connectPromise = <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>AbstractNioUnsafe#fulfillConnectPromise</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">void</span> <span class="title">fulfillConnectPromise</span><span class="params">(ChannelPromise promise, <span class="keyword">boolean</span> wasActive)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (promise == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> active = isActive();</div><div class="line"></div><div class="line">    <span class="comment">// false表示取消操作</span></div><div class="line">    <span class="keyword">boolean</span> promiseSet = promise.trySuccess();</div><div class="line"></div><div class="line">    <span class="comment">// 调用前没激活 &amp;&amp; 现在已激活</span></div><div class="line">    <span class="keyword">if</span> (!wasActive &amp;&amp; active) &#123;</div><div class="line">        <span class="comment">// 触发Active事件</span></div><div class="line">        pipeline().fireChannelActive();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!promiseSet) &#123;</div><div class="line">        <span class="comment">// 操作已被取消，关闭Channel</span></div><div class="line">        close(voidPromise());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>HeadContext#channelActive</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> </span>&#123;</div><div class="line">    ctx.fireChannelActive();</div><div class="line">    <span class="comment">// 自动读取</span></div><div class="line">    readIfIsAutoRead();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>HeadContext#readIfIsAutoRead<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">private void readIfIsAutoRead() &#123;</div><div class="line">    <span class="regexp">//</span> Channel激活后，如果配置了自动读取，则会调用channel.read()</div><div class="line">    <span class="regexp">//</span> 由tail开始，调用unsafe.beginRead()设置关心底层read事件，激活后自动读取数据</div><div class="line">    <span class="regexp">//</span> 当读取完一组数据后，channelReadComplete()方法中继续下一组数据的自动读取</div><div class="line">    <span class="keyword">if</span> (channel.config().isAutoRead()) &#123;</div><div class="line">        <span class="regexp">//</span> AbstractChannel<span class="comment">#read</span></div><div class="line">        <span class="regexp">//</span> Pipeline<span class="comment">#read</span></div><div class="line">        <span class="regexp">//</span> Tail<span class="comment">#read</span></div><div class="line">        <span class="regexp">//</span> AbstractChannelHandlerContext<span class="comment">#read</span></div><div class="line">        <span class="regexp">//</span> --&gt; Head<span class="comment">#read</span></div><div class="line">        <span class="regexp">//</span> AbstractUnsafe<span class="comment">#beginRead</span></div><div class="line">        channel.read();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>AbstractUnsafe#beginRead<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="function"><span class="keyword">void</span> <span class="title">beginRead</span><span class="params">()</span> </span>&#123;</div><div class="line">    assertEventLoop();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!isActive()) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">// AbstractNioChannel#doBeginRead</span></div><div class="line">        <span class="comment">// AbstractNioMessageChannel#doBeginRead</span></div><div class="line">        doBeginRead();</div><div class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception e) &#123;</div><div class="line">        invokeLater(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                pipeline.fireExceptionCaught(e);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        close(voidPromise());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>AbstractNioChannel#doBeginRead</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">void</span> <span class="title">doBeginRead</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> SelectionKey selectionKey = <span class="keyword">this</span>.selectionKey;</div><div class="line">    <span class="keyword">if</span> (!selectionKey.isValid()) &#123;</div><div class="line">        <span class="comment">// 选择键被取消</span></div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 设置底层读事件正在进行</span></div><div class="line">    readPending = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> interestOps = selectionKey.interestOps();</div><div class="line">    <span class="keyword">if</span> ((interestOps &amp; readInterestOp) == <span class="number">0</span>) &#123;</div><div class="line">        <span class="comment">// 关心Read事件</span></div><div class="line">        selectionKey.interestOps(interestOps | readInterestOp);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>NioByteUnsafe#read</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> ChannelConfig config = config();</div><div class="line">    <span class="keyword">if</span> (shouldBreakReadReady(config)) &#123;</div><div class="line">        clearReadPending();</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">final</span> ChannelPipeline pipeline = pipeline();</div><div class="line">    <span class="keyword">final</span> ByteBufAllocator allocator = config.getAllocator();</div><div class="line">    <span class="keyword">final</span> RecvByteBufAllocator.Handle allocHandle = recvBufAllocHandle();</div><div class="line">    allocHandle.reset(config);</div><div class="line"></div><div class="line">    ByteBuf byteBuf = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">boolean</span> close = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">do</span> &#123;</div><div class="line">            <span class="comment">// 创建一个ByteBuf</span></div><div class="line">            byteBuf = allocHandle.allocate(allocator);</div><div class="line">            <span class="comment">// 模板方法</span></div><div class="line">            allocHandle.lastBytesRead(doReadBytes(byteBuf));</div><div class="line">            <span class="comment">// 没有数据可读</span></div><div class="line">            <span class="keyword">if</span> (allocHandle.lastBytesRead() &lt;= <span class="number">0</span>) &#123;</div><div class="line"></div><div class="line">                byteBuf.release();</div><div class="line">                byteBuf = <span class="keyword">null</span>;</div><div class="line">                <span class="comment">// 读取数据量为负，对端已关闭</span></div><div class="line">                close = allocHandle.lastBytesRead() &lt; <span class="number">0</span>;</div><div class="line">                <span class="keyword">if</span> (close) &#123;</div><div class="line">                    readPending = <span class="keyword">false</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            allocHandle.incMessagesRead(<span class="number">1</span>);</div><div class="line">            readPending = <span class="keyword">false</span>;</div><div class="line">            <span class="comment">// 触发ChannelRead事件，用户处理</span></div><div class="line">            pipeline.fireChannelRead(byteBuf);</div><div class="line">            byteBuf = <span class="keyword">null</span>;</div><div class="line">        &#125; <span class="keyword">while</span> (allocHandle.continueReading());</div><div class="line"></div><div class="line">        allocHandle.readComplete();</div><div class="line">        <span class="comment">// ReadComplete结束时，如果开启autoRead则会调用beginRead，继续read</span></div><div class="line">        pipeline.fireChannelReadComplete();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (close) &#123;</div><div class="line">            closeOnRead(pipeline);</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">        handleReadException(pipeline, byteBuf, t, close, allocHandle);</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line"></div><div class="line">        <span class="comment">// 读事件没在进行 &amp;&amp; 没有配置autoRead</span></div><div class="line">        <span class="keyword">if</span> (!readPending &amp;&amp; !config.isAutoRead()) &#123;</div><div class="line">            <span class="comment">// 移除</span></div><div class="line">            removeReadOp();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>HeadContext#channelRead</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> </span>&#123;</div><div class="line">    ctx.fireChannelRead(msg);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>HeadContext#channelReadComplete<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">channelReadComplete</span><span class="params">(ChannelHandlerContext ctx)</span> </span>&#123;</div><div class="line">    ctx.fireChannelReadComplete();</div><div class="line">    <span class="comment">// 自动读取下一组数据</span></div><div class="line">    readIfIsAutoRead();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>AbstractChannelHandlerContext#write</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="keyword">write</span>(Object msg, <span class="keyword">boolean</span> flush, ChannelPromise promise) &#123;</div><div class="line">    ObjectUtil.checkNotNull(msg, <span class="string">"msg"</span>);</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">if</span> (isNotValidPromise(promise, <span class="keyword">true</span>)) &#123;</div><div class="line">            ReferenceCountUtil.release(msg);</div><div class="line"></div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</div><div class="line">        ReferenceCountUtil.release(msg);</div><div class="line">        <span class="keyword">throw</span> e;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> AbstractChannelHandlerContext <span class="keyword">next</span> = findContextOutbound(flush ? (MASK_WRITE | MASK_FLUSH) : MASK_WRITE);</div><div class="line">    <span class="keyword">final</span> Object m = pipeline.touch(msg, <span class="keyword">next</span>);</div><div class="line">    EventExecutor executor = <span class="keyword">next</span>.executor();</div><div class="line">    <span class="keyword">if</span> (executor.inEventLoop()) &#123;</div><div class="line">        <span class="keyword">if</span> (flush) &#123;</div><div class="line">            <span class="keyword">next</span>.invokeWriteAndFlush(m, promise);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">next</span>.invokeWrite(m, promise);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 不在EventLoop线程执行的就提交执行</span></div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> AbstractWriteTask <span class="keyword">task</span>;</div><div class="line">        <span class="keyword">if</span> (flush) &#123;</div><div class="line">            <span class="keyword">task</span> = WriteAndFlushTask.newInstance(<span class="keyword">next</span>, m, promise);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">task</span> = WriteTask.newInstance(<span class="keyword">next</span>, m, promise);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (!safeExecute(executor, <span class="keyword">task</span>, promise, m)) &#123;</div><div class="line"></div><div class="line">            <span class="keyword">task</span>.cancel();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>HeadContext#write</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="built_in">write</span>(ChannelHandlerContext ctx, Object msg, ChannelPromise promise) &#123;</div><div class="line">    <span class="comment">// AbstractUnsafe#write</span></div><div class="line">    unsafe.<span class="built_in">write</span>(msg, promise);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>AbstractUnsafe#write</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line"><span class="keyword">public</span> final <span class="keyword">void</span> <span class="built_in">write</span>(Object msg, ChannelPromise promise) &#123;</div><div class="line">    assertEventLoop();</div><div class="line"></div><div class="line">    ChannelOutboundBuffer outboundBuffer = <span class="keyword">this</span>.outboundBuffer;</div><div class="line">    <span class="built_in">if</span> (outboundBuffer == null) &#123;</div><div class="line">        <span class="comment">// 见close，outboundBuffer为空表示Channel正在关闭，禁止写数据</span></div><div class="line">        safeSetFailure(promise, newWriteException(initialCloseCause));</div><div class="line">        <span class="comment">// 释放</span></div><div class="line">        ReferenceCountUtil.<span class="built_in">release</span>(msg);</div><div class="line">        <span class="built_in">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> <span class="built_in">size</span>;</div><div class="line">    <span class="built_in">try</span> &#123;</div><div class="line">        <span class="comment">// 可对消息进行过滤整理，例如把HeapBuffer转为DirectBuffer，具体实现由子类负责</span></div><div class="line">        msg = filterOutboundMessage(msg);</div><div class="line">        <span class="built_in">size</span> = pipeline.estimatorHandle().<span class="built_in">size</span>(msg);</div><div class="line">        <span class="built_in">if</span> (<span class="built_in">size</span> &lt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="built_in">size</span> = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="built_in">catch</span> (Throwable t) &#123;</div><div class="line">        safeSetFailure(promise, t);</div><div class="line">        ReferenceCountUtil.<span class="built_in">release</span>(msg);</div><div class="line">        <span class="built_in">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    outboundBuffer.addMessage(msg, <span class="built_in">size</span>, promise);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>HeadContext#flush<br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="built_in">flush</span>(ChannelHandlerContext ctx) &#123;</div><div class="line">    <span class="comment">// AbstractUnsafe#flush</span></div><div class="line">    unsafe.<span class="built_in">flush</span>();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>AbstractUnsafe#flush</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="function"><span class="keyword">void</span> <span class="title">flush</span><span class="params">()</span> </span>&#123;</div><div class="line">    assertEventLoop();</div><div class="line">    <span class="comment">// 引入了一个写缓冲区ChannelOutboundBuffer，由该缓冲区控制Channel的可写状态</span></div><div class="line">    ChannelOutboundBuffer outboundBuffer = <span class="keyword">this</span>.outboundBuffer;</div><div class="line">    <span class="keyword">if</span> (outboundBuffer == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// Channel正在关闭直接返回</span></div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    outboundBuffer.addFlush();</div><div class="line">    <span class="comment">// 执行真正的底层写操作</span></div><div class="line">    flush0();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>AbstractUnsafe#flush0</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@SuppressWarnings(<span class="meta-string">"deprecation"</span>)</span></div><div class="line"><span class="keyword">protected</span> void flush0() &#123;</div><div class="line">    <span class="comment">// 正在flush</span></div><div class="line">    <span class="keyword">if</span> (inFlush0) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> ChannelOutboundBuffer outboundBuffer = <span class="keyword">this</span>.outboundBuffer;</div><div class="line">    <span class="comment">// Channel正在关闭或者已没有需要写的数据</span></div><div class="line">    <span class="keyword">if</span> (outboundBuffer == <span class="literal">null</span> || outboundBuffer.isEmpty()) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    inFlush0 = <span class="literal">true</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!isActive()) &#123;</div><div class="line">        <span class="comment">// Channel已经非激活，将所有进行中的写请求标记为失败</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">if</span> (isOpen()) &#123;</div><div class="line">                outboundBuffer.failFlushed(FLUSH0_NOT_YET_CONNECTED_EXCEPTION, <span class="literal">true</span>);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line"></div><div class="line">                outboundBuffer.failFlushed(newFlush0Exception(initialCloseCause), <span class="literal">false</span>);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            inFlush0 = <span class="literal">false</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">// 模板方法</span></div><div class="line">        <span class="comment">// AbstractNioByteChannel#doWrite</span></div><div class="line">        <span class="comment">// AbstractNioMessageChannel#doWrite</span></div><div class="line">        doWrite(outboundBuffer);</div><div class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">        <span class="keyword">if</span> (t instanceof IOException &amp;&amp; config().isAutoClose()) &#123;</div><div class="line"></div><div class="line">            initialCloseCause = t;</div><div class="line">            close(voidPromise(), t, newFlush0Exception(t), <span class="literal">false</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                shutdownOutput(voidPromise(), t);</div><div class="line">            &#125; <span class="keyword">catch</span> (Throwable t2) &#123;</div><div class="line">                initialCloseCause = t;</div><div class="line">                close(voidPromise(), t2, newFlush0Exception(t), <span class="literal">false</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        inFlush0 = <span class="literal">false</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>AbstractNioByteChannel#doWrite<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">@<span class="function">Override</span></div><div class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doWrite</span>(<span class="params">ChannelOutboundBuffer <span class="keyword">in</span></span>) throws Exception &#123;</div><div class="line">    <span class="keyword">int</span> writeSpinCount = config().getWriteSpinCount();</div><div class="line">    <span class="keyword">do</span> &#123;</div><div class="line">        Object msg = <span class="keyword">in</span>.current();</div><div class="line">        <span class="comment">// 数据已全部写完</span></div><div class="line">        <span class="keyword">if</span> (msg == <span class="literal">null</span>) &#123;</div><div class="line">            <span class="comment">// 清除OP_WRITE事件</span></div><div class="line">            clearOpWrite();</div><div class="line"></div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        writeSpinCount -= doWriteInternal(<span class="keyword">in</span>, msg);</div><div class="line">    &#125; <span class="keyword">while</span> (writeSpinCount &gt; <span class="number">0</span>);</div><div class="line">    <span class="comment">// 将ByteBuf的数据写入Channel，NIO写操作返回已写入的数据量，非阻塞模式下可能为0，此时调用incompleteWrite()方法</span></div><div class="line">    incompleteWrite(writeSpinCount &lt; <span class="number">0</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>AbstractNioByteChannel#doWriteInternal<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">doWriteInternal</span>(<span class="params">ChannelOutboundBuffer <span class="keyword">in</span>, Object msg</span>) throws Exception </span>&#123;</div><div class="line">    <span class="keyword">if</span> (msg instanceof ByteBuf) &#123;</div><div class="line">        ByteBuf buf = (ByteBuf) msg;</div><div class="line">        <span class="comment">// ByteBuf不可读，此时数据已写完</span></div><div class="line">        <span class="keyword">if</span> (!buf.isReadable()) &#123;</div><div class="line">            <span class="comment">// 完成时，清理缓冲区</span></div><div class="line">            <span class="keyword">in</span>.<span class="keyword">remove</span>();</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 模板方法</span></div><div class="line">        final <span class="keyword">int</span> localFlushedAmount = doWriteBytes(buf);</div><div class="line">        <span class="comment">// 返回已写入的数据量，NIO在非阻塞模式下写操作可能返回0表示未写入数据</span></div><div class="line">        <span class="keyword">if</span> (localFlushedAmount &gt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">in</span>.progress(localFlushedAmount);</div><div class="line">            <span class="keyword">if</span> (!buf.isReadable()) &#123;</div><div class="line">                <span class="keyword">in</span>.<span class="keyword">remove</span>();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// FileRegion是Netty对NIO底层的FileChannel的封装，负责将File中的数据写入到WritableChannel中</span></div><div class="line">    <span class="function"><span class="keyword">else</span> <span class="title">if</span> (<span class="params">msg instanceof FileRegion</span>) </span>&#123;</div><div class="line">        FileRegion region = (FileRegion) msg;</div><div class="line">        <span class="keyword">if</span> (region.transferred() &gt;= region.count()) &#123;</div><div class="line">            <span class="keyword">in</span>.<span class="keyword">remove</span>();</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">long</span> localFlushedAmount = doWriteFileRegion(region);</div><div class="line">        <span class="keyword">if</span> (localFlushedAmount &gt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">in</span>.progress(localFlushedAmount);</div><div class="line">            <span class="keyword">if</span> (region.transferred() &gt;= region.count()) &#123;</div><div class="line">                <span class="keyword">in</span>.<span class="keyword">remove</span>();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// 其他类型不支持</span></div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Error();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> WRITE_STATUS_SNDBUF_FULL;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>AbstractNioByteChannel#incompleteWrite<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="function"><span class="keyword">void</span> <span class="title">incompleteWrite</span><span class="params">(<span class="keyword">boolean</span> setOpWrite)</span> </span>&#123;</div><div class="line">    <span class="comment">// 未写入数据：设置SelectionKey继续关心OP_WRITE事件，继续进行写操作</span></div><div class="line">    <span class="keyword">if</span> (setOpWrite) &#123;</div><div class="line">        <span class="comment">// 设置继续关心OP_WRITE事件</span></div><div class="line">        setOpWrite();</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 写操作次数达到writeSpinCount但没写完</span></div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// 清除</span></div><div class="line">        clearOpWrite();</div><div class="line">        <span class="comment">// 向EventLoop提交一个新的flush任务，此时可以响应其他请求，不会占用全部资源使其他请求得不到响应</span></div><div class="line">        eventLoop().execute(flushTask);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


		<footer>
			 
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

		</footer>
	</div>
	<!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
	<script src="/js/highlight.js"></script> 
	<script>hljs.initHighlightingOnLoad();var timeEnd = new Date();console.log('耗时：' + (timeEnd - timeStart));</script>
	<!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
	<!-- material design -->
	<!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
	<!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
	<!-- toc -->
	<!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
	<!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
	<!-- <script src="/js/main.js"></script> -->
</body>
</html>
