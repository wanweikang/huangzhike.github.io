<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
        <script>
            var timeStart = new Date();
        </script>
        
        <title>[ç¬”è®°]-J.U.C.-å¹¶å‘å®¹å™¨-ConcurrentHashMap | ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜</title>
        
        <meta name="author" content="huangzhike">
        
        
        <meta name="description" content="jdk1.8.0_211
é¦–å…ˆå…ˆæ¨èä¸€ç¯‡æ–‡ç« ï¼Œé‡Œé¢æœ‰å¾ˆå¤šå¸®åˆ°æˆ‘çš„åœ°æ–¹ï¼Œç‰¹åˆ«æ˜¯å…³äºä½è¿ç®—çš„éƒ¨åˆ†ï¼Œè¦ä¸æˆ‘æƒ³ç ´è„‘è¢‹ä¹Ÿçœ‹ä¸æ˜ç™½ã€‚
åƒConcurrentHashMapè¿™ç§classicï¼Œç½‘ä¸Šæœ‰å¾ˆå¤šç›¸å…³çš„æ–‡ç« ï¼Œå¤šçœ‹ä¸€äº›èµ„æ–™ï¼Œæ€»ä¼šæœ‰æ”¶è·ï¼Œä½†æ˜¯çœ‹æºç æœ€åè¿˜æ˜¯è¦è‡ªå·±èµ°ä¸€éæµç¨‹ï¼Œæ€è€ƒæ¯ä¸€æ­¥æ“ä½œçš„åŸå› ï¼Œè¿™æ ·æ‰æœ‰æ„ä¹‰ã€‚
">
        
        
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        
        <meta property="og:title" content="[ç¬”è®°]-J.U.C.-å¹¶å‘å®¹å™¨-ConcurrentHashMap"/>
        
        <meta property="og:site_name" content="ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜"/>
        
        
        <!-- favicon -->
        <link rel="icon" type="image/ico" href="/ok.ico" sizes="32x32">
        <meta name="msapplication-TileColor" content="#009688">
        <meta name="msapplication-TileImage" content="/mstile-144x144.ico">
        <meta name="theme-color" content="#009688">
        <!-- favicon end -->
        <!-- <link href="//ok.ico" rel="icon"> -->
        
        <!-- toc -->
        <!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
        <!-- material design -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
        <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
        
        <!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
        <!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
    <meta name="generator" content="Hexo 4.2.1"></head>

<body>
    <nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">èœå•</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" title="ä¸‹ä¸€å¥æ˜¯ï¼šå®¢æœ‰å¯äººæœŸä¸æ¥ã€‚å°æ—¶å€™ï¼Œå–œæ¬¢é åœ¨é˜³å°ä¸Šï¼Œä¸€è¾¹å¹é£ï¼Œä¸€è¾¹çœ‹ä¹¦ï¼Œå–œæ¬¢è¯»ä¹¦å—ï¼Œéªšå¹´ï¼Ÿ" href="/">ä¹¦å½“å¿«æ„è¯»æ˜“å°½</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" target="_blank" rel="noopener" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

    <div class="container" >
        <div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[ç¬”è®°]-J.U.C.-å¹¶å‘å®¹å™¨-ConcurrentHashMap</h2>
				
				<div>
					<div class="post-time">2019-12-06</div>
				</div>
				
				<div class="article-content">
				<p>jdk1.8.0_211</p>
<p>é¦–å…ˆå…ˆæ¨è<a href="https://sylvanassun.github.io/2018/03/16/2018-03-16-map_family/#æ‰©å®¹" target="_blank" rel="noopener">ä¸€ç¯‡æ–‡ç« </a>ï¼Œé‡Œé¢æœ‰å¾ˆå¤šå¸®åˆ°æˆ‘çš„åœ°æ–¹ï¼Œç‰¹åˆ«æ˜¯å…³äºä½è¿ç®—çš„éƒ¨åˆ†ï¼Œè¦ä¸æˆ‘æƒ³ç ´è„‘è¢‹ä¹Ÿçœ‹ä¸æ˜ç™½ã€‚</p>
<p>åƒConcurrentHashMapè¿™ç§classicï¼Œç½‘ä¸Šæœ‰å¾ˆå¤šç›¸å…³çš„æ–‡ç« ï¼Œå¤šçœ‹ä¸€äº›èµ„æ–™ï¼Œæ€»ä¼šæœ‰æ”¶è·ï¼Œä½†æ˜¯çœ‹æºç æœ€åè¿˜æ˜¯è¦è‡ªå·±èµ°ä¸€éæµç¨‹ï¼Œæ€è€ƒæ¯ä¸€æ­¥æ“ä½œçš„åŸå› ï¼Œè¿™æ ·æ‰æœ‰æ„ä¹‰ã€‚</p>
<p>å…¶å®å¹¶å‘åŒ…æˆ‘æ˜¯åŠå¹´å‰çœ‹çš„ï¼Œå½“æ—¶å°±é¿å¼€äº†ConcurrentHashMapï¼Œè¿™æ¬¡çœ‹ConcurrentHashMapï¼Œä¹Ÿæ˜¯ä¸ºäº†å‡†å¤‡é¢è¯•ï¼Œä¸è¿‡çœ‹å®Œåä¹Ÿæ˜¯æ”¶è·å¾ˆå¤šã€‚ã€‚ã€‚ä¸äºã€‚ã€‚ã€‚</p>
<p>è¿™é‡Œåªå…³æ³¨ConcurrentHashMapçš„å¹¶å‘å¤„ç†ï¼Œç•¥è¿‡HashMapçš„ç›¸ä¼¼å†…å®¹ã€‚</p>
<hr>
<p>ConcurrentHashMap</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcurrentHashMap</span><span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractMap</span><span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span> <span class="token keyword">implements</span> <span class="token class-name">ConcurrentMap</span><span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span><span class="token punctuation">,</span> Serializable <span class="token punctuation">{</span>

    <span class="token comment" spellcheck="true">/**
     * æ•°ç»„
     */</span>
    <span class="token keyword">transient</span> <span class="token keyword">volatile</span> ConcurrentHashMap<span class="token punctuation">.</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> table<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * æš‚å­˜æ‰©å®¹ä¸­çš„æ–°æ•°ç»„ï¼Œæ‰©å®¹å®Œæˆåç”¨è¯¥æ•°ç»„æ›¿ä»£
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token keyword">volatile</span> ConcurrentHashMap<span class="token punctuation">.</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> nextTable<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token keyword">volatile</span> <span class="token keyword">long</span> baseCount<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/**
     * volatileä¿®é¥°ï¼Œä¿®æ”¹ç«‹å³å¯è§ï¼Œä¸ºä»€ä¹ˆä¸ä½¿ç”¨Atomicç±»ï¼Œè¿˜è¦Unsafeæ‰‹åŠ¨CASï¼Œå¯èƒ½æ˜¯æ€§èƒ½æ›´å¥½ï¼Ÿ
     * ç”¨äºæ•°ç»„åˆå§‹åŒ–å’Œæ‰©å®¹çš„æ§åˆ¶ï¼Œä½16ä½ä»£è¡¨æ­£åœ¨æ‰©å®¹çš„çº¿ç¨‹æ•°åŠ ä¸€
     * 0ä¸ºåˆå§‹å€¼ï¼Œè¡¨ç¤ºæ•°ç»„æœªåˆå§‹åŒ–
     * è´Ÿæ•°çš„æƒ…å†µï¼š
     * 1ï¼ˆä½16ä½ï¼‰è¡¨ç¤ºæ­£åœ¨åˆå§‹åŒ–ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æ‰§è¡Œåˆå§‹åŒ–ï¼Œå…¶å®ƒThread#yield
     * nï¼ˆä½16ä½ï¼‰è¡¨ç¤ºæœ‰n-1ä¸ªçº¿ç¨‹æ­£åœ¨æ‰©å®¹
     * æ­£æ•°çš„æƒ…å†µï¼š
     * å¦‚æœæ•°ç»„æœªåˆå§‹åŒ–ï¼Œè¡¨ç¤ºæ•°ç»„åˆå§‹åŒ–åçš„å¤§å°
     * å¦‚æœæ•°ç»„åˆå§‹åŒ–å®Œæˆï¼Œè¡¨ç¤ºä¸‹æ¬¡æ‰©å®¹çš„é˜ˆå€¼ï¼ŒMapçš„å…ƒç´ æ•°é‡è¶…è¿‡åå°±ä¼šæ‰©å®¹
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> sizeCtl<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * å¹¶å‘æ‰©å®¹æ—¶ï¼Œæ•°ç»„å·²è¢«åˆ†é…çš„æœ€æ–°ç´¢å¼•
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> transferIndex<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> cellsBusy<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token keyword">volatile</span> ConcurrentHashMap<span class="token punctuation">.</span>CounterCell<span class="token punctuation">[</span><span class="token punctuation">]</span> counterCells<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<hr>
<p>ConcurrentHashMap#putVal</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">final</span> V <span class="token function">putVal</span><span class="token punctuation">(</span>K key<span class="token punctuation">,</span> V value<span class="token punctuation">,</span> <span class="token keyword">boolean</span> onlyIfAbsent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// é”®å€¼éƒ½ä¸å…è®¸ä¸ºç©º</span>
        <span class="token comment" spellcheck="true">// ç™¾åº¦äº†ä¸€ä¸‹ï¼Œå¯¹äºvalueä¸å…è®¸ä¸ºnullï¼Œæ˜¯å› ä¸ºå¦‚æœgetè¿”å›äº†nullï¼Œé‚£ä¹ˆæ— æ³•åˆ¤æ–­æ˜¯keyä¸å­˜åœ¨è¿˜æ˜¯valueå°±æ˜¯nullï¼Œåœ¨å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œå¦‚æœå†æ¬¡è°ƒç”¨containsKeyåˆ¤æ–­ï¼Œå¯èƒ½åœ¨è¿™æœŸé—´Mapå·²ç»å‘ç”Ÿäº†æ”¹å˜</span>
        <span class="token comment" spellcheck="true">// å¯¹äºkeyä¸å…è®¸ä¸ºnullï¼Œè¿˜æ²¡æ‰¾åˆ°åˆç†çš„è§£é‡Šï¼Œæ— æ³•åˆ¤æ–­keyä¸ºnullæˆ–ä¸å­˜åœ¨ï¼Ÿ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> null <span class="token operator">||</span> value <span class="token operator">==</span> null<span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è®¡ç®—å“ˆå¸Œå€¼ï¼Œä¼šä¿è¯å“ˆå¸Œå€¼ä¸ºæ­£</span>
        <span class="token keyword">int</span> hash <span class="token operator">=</span> <span class="token function">spread</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> binCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// é‡è¯•ç›´åˆ°æˆåŠŸ</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>ConcurrentHashMap<span class="token punctuation">.</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab <span class="token operator">=</span> table<span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ConcurrentHashMap<span class="token punctuation">.</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span> f<span class="token punctuation">;</span>
            <span class="token keyword">int</span> n<span class="token punctuation">,</span> i<span class="token punctuation">,</span> fh<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ç¬¬ä¸€æ¬¡putï¼Œåˆå§‹åŒ–æ•°ç»„ï¼Œæ‰€ä»¥æ•°ç»„æ˜¯å»¶è¿Ÿåˆå§‹åŒ–çš„</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>tab <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                tab <span class="token operator">=</span> <span class="token function">initTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å¦‚æœæ•°ç»„å¯¹åº”ä½ç½®æ— èŠ‚ç‚¹ï¼ŒCASå°è¯•æ’å…¥ï¼ŒæˆåŠŸå°±é€€å‡ºï¼Œå¦åˆ™ä¸‹ä¸ªå¾ªç¯ç»§ç»­</span>
                <span class="token comment" spellcheck="true">// tabAtå®é™…æ˜¯è°ƒç”¨çš„Unsafe#getObjectVolatileç›´æ¥è·å–æŒ‡å®šä½ç½®çš„æ•°æ®</span>
                <span class="token comment" spellcheck="true">// å› ä¸ºè™½ç„¶tableæ˜¯volatileçš„ï¼Œä½†æ˜¯tableä¸­çš„å…ƒç´ ä¸æ˜¯volatileçš„ï¼Œä¸èƒ½ä¿è¯çº¿ç¨‹æ¯æ¬¡éƒ½æ‹¿åˆ°æœ€æ–°å…ƒç´ </span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>f <span class="token operator">=</span> <span class="token function">tabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i <span class="token operator">=</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> hash<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ä½¿ç”¨Unsafe#compareAndSwapObjectï¼ŒåŸå­æ“ä½œtable[i]ä½ç½®ï¼Œå¦‚æœä¸ºnullï¼Œåˆ™æ’å…¥ï¼Œä¸éœ€è¦é”</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">casTabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap<span class="token punctuation">.</span>Node</span><span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ForwardingNodeèŠ‚ç‚¹ï¼Œæ˜¯ä¸€ä¸ªæ ‡è®°ï¼Œè¯´æ˜æœ‰å…¶å®ƒçº¿ç¨‹åœ¨æ‰©å®¹ï¼Œè€ŒåŸæœ¬çš„èŠ‚ç‚¹è¢«æ¬åˆ°äº†æ‰©å®¹åçš„æ–°æ•°ç»„</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fh <span class="token operator">=</span> f<span class="token punctuation">.</span>hash<span class="token punctuation">)</span> <span class="token operator">==</span> MOVED<span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// ååŠ©æ‰©å®¹ï¼Œç›´åˆ°æ‰©å®¹å®Œæˆæ‰èƒ½æ’å…¥æ–°æ•°ç»„</span>
                tab <span class="token operator">=</span> <span class="token function">helpTransfer</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// æœ‰å“ˆå¸Œå†²çªçš„æƒ…å†µ</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                V oldVal <span class="token operator">=</span> null<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// åŠ é”ï¼Œæ²¡æœ‰ç”¨ReentrantLockæ˜¯å› ä¸ºJDK8ä¸‹synchronizedæ€§èƒ½å·²ç»è¶³å¤Ÿå¥½ï¼Œæ¨èå“¦</span>
                <span class="token comment" spellcheck="true">// è¿™é‡Œåªé”ä½äº†ä¸€æ¡é“¾è¡¨æˆ–æ ‘ï¼Œç¼©å°äº†é”çš„èŒƒå›´</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å†æ¬¡æ£€æŸ¥ä¸€æ¬¡è¯¥ä½ç½®åŠ é”çš„èŠ‚ç‚¹ï¼ŒDCL</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token operator">==</span> f<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// å“ˆå¸Œå€¼å¤§äºé›¶ï¼Œè¯´æ˜æ˜¯é“¾è¡¨èŠ‚ç‚¹</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>fh <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            binCount <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// éå†é“¾è¡¨</span>
                            <span class="token keyword">for</span> <span class="token punctuation">(</span>ConcurrentHashMap<span class="token punctuation">.</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span> e <span class="token operator">=</span> f<span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token operator">++</span>binCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                K ek<span class="token punctuation">;</span>
                                <span class="token comment" spellcheck="true">// æ‰¾åˆ°äº†keyå¯¹åº”çš„èŠ‚ç‚¹ï¼Œç„¶åå†³å®šæ˜¯å¦è¦†ç›–æ›´æ–°</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash <span class="token operator">==</span> hash <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ek <span class="token operator">=</span> e<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">||</span> <span class="token punctuation">(</span>ek <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>ek<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    oldVal <span class="token operator">=</span> e<span class="token punctuation">.</span>val<span class="token punctuation">;</span>
                                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>onlyIfAbsent<span class="token punctuation">)</span>
                                        e<span class="token punctuation">.</span>val <span class="token operator">=</span> value<span class="token punctuation">;</span>
                                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                                ConcurrentHashMap<span class="token punctuation">.</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span> pred <span class="token operator">=</span> e<span class="token punctuation">;</span>
                                <span class="token comment" spellcheck="true">// åˆ°äº†é“¾è¡¨å°¾è¿˜æ²¡æ‰¾åˆ°</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    <span class="token comment" spellcheck="true">// è¿½åŠ åˆ°é“¾è¡¨å°¾</span>
                                    pred<span class="token punctuation">.</span>next <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap<span class="token punctuation">.</span>Node</span><span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment" spellcheck="true">// çº¢é»‘æ ‘ä»¥TreeBinå½¢å¼å­˜æ”¾ï¼Œå“ˆå¸Œå€¼ä¸ºTREEBINï¼Œå³-2</span>
                        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>f <span class="token keyword">instanceof</span> <span class="token class-name">ConcurrentHashMap<span class="token punctuation">.</span>TreeBin</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            ConcurrentHashMap<span class="token punctuation">.</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span> p<span class="token punctuation">;</span>
                            binCount <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// çº¢é»‘æ ‘ä¸­æ‰¾åˆ°èŠ‚ç‚¹å°±è¿”å›ï¼Œæ²¡æœ‰æ‰¾åˆ°å°±ç›´æ¥è¿½åŠ ï¼Œè¿™é‡Œæ’å…¥æ–°èŠ‚ç‚¹åçº¢é»‘æ ‘é‡å¹³è¡¡è¿˜ä¼šå¦å¤–åŠ é”</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ConcurrentHashMap<span class="token punctuation">.</span>TreeBin<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span><span class="token punctuation">)</span> f<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putTreeVal</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                oldVal <span class="token operator">=</span> p<span class="token punctuation">.</span>val<span class="token punctuation">;</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>onlyIfAbsent<span class="token punctuation">)</span>
                                    p<span class="token punctuation">.</span>val <span class="token operator">=</span> value<span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>binCount <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// é“¾è¡¨è¿‡é•¿ï¼Œå°±è½¬æ¢ä¸ºçº¢é»‘æ ‘</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>binCount <span class="token operator">>=</span> TREEIFY_THRESHOLD<span class="token punctuation">)</span>
                        <span class="token comment" spellcheck="true">// å¦‚æœæ•°ç»„å®¹é‡å¤ªå°ï¼Œåˆ™ä¸è½¬åŒ–ï¼Œä¼˜å…ˆæ‰©å®¹ï¼Œå¦åˆ™DCLå¯¹å¤´èŠ‚ç‚¹åŠ é”è½¬åŒ–ä¸ºçº¢é»‘æ ‘</span>
                        <span class="token function">treeifyBin</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVal <span class="token operator">!=</span> null<span class="token punctuation">)</span>
                        <span class="token keyword">return</span> oldVal<span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// æ’å…¥å®Œæˆåï¼Œæ›´æ–°Mapå¤§å°ï¼Œæ£€æŸ¥æ•°ç»„æ˜¯å¦éœ€è¦æ‰©å®¹</span>
        <span class="token function">addCount</span><span class="token punctuation">(</span>1L<span class="token punctuation">,</span> binCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ConcurrentHashMap#initTable</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">final</span> ConcurrentHashMap<span class="token punctuation">.</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">initTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ConcurrentHashMap<span class="token punctuation">.</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab<span class="token punctuation">;</span>
        <span class="token keyword">int</span> sc<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ•°ç»„è¿˜æ²¡åˆå§‹åŒ–</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tab <span class="token operator">=</span> table<span class="token punctuation">)</span> <span class="token operator">==</span> null <span class="token operator">||</span> tab<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å°äº0è¯´æ˜æœ‰åˆ«çš„çº¿ç¨‹åœ¨åˆå§‹åŒ–æˆ–æ‰©å®¹æ•°ç»„ï¼Œä½†è¿˜æ²¡å®Œæˆï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹å°±è®©ä¸€è®©ï¼Œé¿å…å¹¶å‘ä¿®æ”¹</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sc <span class="token operator">=</span> sizeCtl<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                Thread<span class="token punctuation">.</span><span class="token function">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// CASå°†sizeCtlæ”¹ä¸º-1æˆåŠŸæ‰èƒ½åˆå§‹åŒ–ï¼Œç±»ä¼¼è·å¾—äº†é”ï¼Œé¿å…å¤šæ¬¡åˆå§‹åŒ–</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>U<span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> SIZECTL<span class="token punctuation">,</span> sc<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å†æ¬¡æ£€æŸ¥æ•°ç»„æœ‰æ²¡æœ‰åˆå§‹åŒ–ï¼Œç±»ä¼¼DCLï¼Œå¦‚ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è¿›å…¥äº†whileå¾ªç¯çš„ä»£ç ï¼Œç„¶åçº¿ç¨‹1åœ¨æ‰§è¡ŒCASå‰è¢«æŒ‚èµ·ï¼Œçº¿ç¨‹2å®Œæˆäº†æ•°ç»„åˆå§‹åŒ–ï¼Œç„¶åçº¿ç¨‹1å”¤é†’ï¼Œæ‰§è¡ŒCASï¼Œéœ€è¦å†æ¬¡åˆ¤æ–­</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tab <span class="token operator">=</span> table<span class="token punctuation">)</span> <span class="token operator">==</span> null <span class="token operator">||</span> tab<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// æ•°ç»„çš„åˆå§‹å®¹é‡ï¼Œæœ‰è®¾ç½®å°±ä½¿ç”¨è®¾ç½®çš„ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤</span>
                        <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token punctuation">(</span>sc <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> sc <span class="token operator">:</span> DEFAULT_CAPACITY<span class="token punctuation">;</span>
                        <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span> ConcurrentHashMap<span class="token punctuation">.</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> nt <span class="token operator">=</span> <span class="token punctuation">(</span>ConcurrentHashMap<span class="token punctuation">.</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap<span class="token punctuation">.</span>Node</span><span class="token operator">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// ç”¨æ–°çš„æ•°ç»„æ›¿æ¢</span>
                        table <span class="token operator">=</span> tab <span class="token operator">=</span> nt<span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// sc == n - (n / 2^2) == 0.75 * n</span>
                        sc <span class="token operator">=</span> n <span class="token operator">-</span> <span class="token punctuation">(</span>n <span class="token operator">>>></span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// æ‰©å®¹å®Œæˆåå°†sizeCtlæ›´æ–°ä¸ºä¸‹æ¬¡æ‰©å®¹çš„é˜ˆå€¼</span>
                    <span class="token comment" spellcheck="true">// è¿™é‡Œæ²¡æœ‰ç«äº‰ï¼Œå› ä¸ºæ•°ç»„åªä¼šåˆå§‹åŒ–ä¸€æ¬¡ï¼Œä¸éœ€è¦CAS</span>
                    sizeCtl <span class="token operator">=</span> sc<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> tab<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ConcurrentHashMap$TreeBin#putTreeVal</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">final</span> ConcurrentHashMap<span class="token punctuation">.</span>TreeNode<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span> <span class="token function">putTreeVal</span><span class="token punctuation">(</span><span class="token keyword">int</span> h<span class="token punctuation">,</span> K k<span class="token punctuation">,</span> V v<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> kc <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> searched <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ç”±æ ¹èŠ‚ç‚¹å¼€å§‹å‘ä¸‹éå†</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>ConcurrentHashMap<span class="token punctuation">.</span>TreeNode<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span> p <span class="token operator">=</span> root<span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> dir<span class="token punctuation">,</span> ph<span class="token punctuation">;</span>
                K pk<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ...</span>
                <span class="token comment" spellcheck="true">// éå†æ¯”è¾ƒå¤§å°</span>
                ConcurrentHashMap<span class="token punctuation">.</span>TreeNode<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span> xp <span class="token operator">=</span> p<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å¦‚æœæœ€ç»ˆè¿˜æ²¡æ‰¾åˆ°keyå¯¹åº”èŠ‚ç‚¹ï¼Œé‚£å°±æ’å…¥æ–°çš„èŠ‚ç‚¹</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p <span class="token operator">=</span> <span class="token punctuation">(</span>dir <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> p<span class="token punctuation">.</span>left <span class="token operator">:</span> p<span class="token punctuation">.</span>right<span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    ConcurrentHashMap<span class="token punctuation">.</span>TreeNode<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span> x<span class="token punctuation">,</span> f <span class="token operator">=</span> first<span class="token punctuation">;</span>
                    first <span class="token operator">=</span> x <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap<span class="token punctuation">.</span>TreeNode</span><span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> k<span class="token punctuation">,</span> v<span class="token punctuation">,</span> f<span class="token punctuation">,</span> xp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>f <span class="token operator">!=</span> null<span class="token punctuation">)</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>dir <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token keyword">else</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>xp<span class="token punctuation">.</span>red<span class="token punctuation">)</span>
                        <span class="token comment" spellcheck="true">// ...</span>
                    <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// è¿™é‡Œè¦CASä¿®æ”¹æˆåŠŸæ‰èƒ½æ‰§è¡Œé‡å¹³è¡¡ï¼Œå¦åˆ™å¯èƒ½ä¼šæŒ‚èµ·å½“å‰çº¿ç¨‹</span>
                        <span class="token function">lockRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// æ‰§è¡Œçº¢é»‘æ ‘çš„å¹³è¡¡ï¼Œè¿”å›å¹³è¡¡åçš„æ–°çš„æ ¹èŠ‚ç‚¹</span>
                            root <span class="token operator">=</span> <span class="token function">balanceInsertion</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// å°†çº¢é»‘æ ‘çš„é”çŠ¶æ€é‡ç½®ä¸º0</span>
                            <span class="token function">unlockRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å¹³è¡¡å®Œåè¿˜è¦é€’å½’æ£€æŸ¥ä¸€éæ˜¯å¦ç¬¦åˆçº¢é»‘æ ‘çš„è§„åˆ™</span>
            <span class="token keyword">assert</span> <span class="token function">checkInvariants</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>ConcurrentHashMap$TreeBin</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * å¯¹çº¢é»‘æ ‘çš„åŒ…è£…ï¼Œä»£æ›¿æ ¹èŠ‚ç‚¹TreeNodeï¼Œå­˜æ”¾åœ¨æ•°ç»„
     */</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">TreeBin</span><span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span> <span class="token keyword">extends</span> <span class="token class-name">ConcurrentHashMap<span class="token punctuation">.</span>Node</span><span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span> <span class="token punctuation">{</span>
        ConcurrentHashMap<span class="token punctuation">.</span>TreeNode<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span> root<span class="token punctuation">;</span>

        <span class="token keyword">volatile</span> ConcurrentHashMap<span class="token punctuation">.</span>TreeNode<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span> first<span class="token punctuation">;</span>

        <span class="token keyword">volatile</span> Thread waiter<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * é”çŠ¶æ€
         */</span>
        <span class="token keyword">volatile</span> <span class="token keyword">int</span> lockState<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ConcurrentHashMap$TreeBin#lockRoot</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">lockRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// CASå°†çº¢é»‘æ ‘çš„é”çŠ¶æ€ç”±ç©ºé—²æ”¹ä¸ºå†™æ‰èƒ½æ‰§è¡Œé‡å¹³è¡¡ï¼Œå¦åˆ™è¯´æ˜æœ‰çº¿ç¨‹åœ¨è¯»æˆ–å†™è¿™æ£µçº¢é»‘æ ‘ï¼Œè‡ªæ—‹é‡è¯•</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>U<span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> LOCKSTATE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> WRITER<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token function">contendedLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>ConcurrentHashMap$TreeBin#contendedLock</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">contendedLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">boolean</span> waiting <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è‡ªæ—‹é‡è¯•ç›´åˆ°æˆåŠŸ</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> s<span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å¦‚æœå½“å‰æ ‘ä»…å¤„äºç­‰å¾…çŠ¶æ€ï¼Œå†æ¬¡CASå°è¯•ï¼Œå¤±è´¥åˆ™ç»§ç»­ï¼ŒæˆåŠŸåˆ™è¿”å›</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>s <span class="token operator">=</span> lockState<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">~</span>WAITER<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å°è¯•CASä¿®æ”¹ä¸ºå†™çŠ¶æ€ï¼ŒæˆåŠŸåˆ™è¡¨æ˜è·å–å†™é”æˆåŠŸï¼Œå¦åˆ™è¯´æ˜çŠ¶æ€å‘ç”Ÿäº†æ”¹å˜æˆ–è€…æœ‰ç«äº‰ï¼Œä¸‹æ¬¡è‡ªæ—‹ç»§ç»­</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>U<span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> LOCKSTATE<span class="token punctuation">,</span> s<span class="token punctuation">,</span> WRITER<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// å¦‚æœä¸Šæ¬¡è‡ªæ—‹åè¦è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œç°åœ¨å·²ç»ä¸éœ€è¦äº†ï¼Œç½®ç©ºç­‰å¾…çº¿ç¨‹å¹¶è¿”å›</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>waiting<span class="token punctuation">)</span>
                            waiter <span class="token operator">=</span> null<span class="token punctuation">;</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// å¦‚æœå½“å‰æ ‘ä¸æ˜¯ç­‰å¾…çŠ¶æ€ï¼Œå³æ²¡æœ‰ç­‰å¾…çº¿ç¨‹ï¼Œå°è¯•ä¿®æ”¹ä¸ºç­‰å¾…çŠ¶æ€ï¼Œå‡†å¤‡æŠŠå½“å‰çº¿ç¨‹æŒ‚èµ·</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>s <span class="token operator">&amp;</span> WAITER<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// CASæ·»åŠ ç­‰å¾…çŠ¶æ€æˆåŠŸ</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>U<span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> LOCKSTATE<span class="token punctuation">,</span> s<span class="token punctuation">,</span> s <span class="token operator">|</span> WAITER<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// å‡†å¤‡ä¸‹ä¸ªå¾ªç¯æŠŠçº¿ç¨‹æŒ‚èµ·ï¼Œå½“ç„¶ä¹Ÿå¯èƒ½ä¸‹æ¬¡è‡ªæ—‹CASæˆåŠŸ</span>
                        waiting <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// å°†å½“å‰çº¿ç¨‹è®¾ä¸ºç­‰å¾…çº¿ç¨‹ï¼Œå…¶å®ƒçš„å°±CASç«äº‰å»å§ï¼Œåªèƒ½æœ‰ä¸€ä¸ªè¢«park</span>
                        waiter <span class="token operator">=</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// æŒ‚èµ·å½“å‰å†™çº¿ç¨‹ï¼Œç­‰å¾…è¯»çº¿ç¨‹å®Œæˆåå°†å®ƒå”¤é†’</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>waiting<span class="token punctuation">)</span>
                    LockSupport<span class="token punctuation">.</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span></code></pre>
<p>ConcurrentHashMap#treeifyBin</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">treeifyBin</span><span class="token punctuation">(</span>ConcurrentHashMap<span class="token punctuation">.</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab<span class="token punctuation">,</span> <span class="token keyword">int</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ConcurrentHashMap<span class="token punctuation">.</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span> b<span class="token punctuation">;</span>
        <span class="token keyword">int</span> n<span class="token punctuation">,</span> sc<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tab <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// æ•°ç»„å®¹é‡è¿‡å°ï¼Œåˆ™æ‰©å®¹</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>n <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">&lt;</span> MIN_TREEIFY_CAPACITY<span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// æ‰©å®¹ï¼Œå®¹é‡ç¿»å€</span>
                <span class="token function">tryPresize</span><span class="token punctuation">(</span>n <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å¦åˆ™ï¼Œå¦‚æœè¯¥ä½ç½®æœ‰å…ƒç´ ï¼Œå¹¶ä¸”æ˜¯ä¸ªé“¾è¡¨èŠ‚ç‚¹</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>b <span class="token operator">=</span> <span class="token function">tabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> b<span class="token punctuation">.</span>hash <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// é”å®šè¯¥å¤´èŠ‚ç‚¹</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// DCL</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token operator">==</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        ConcurrentHashMap<span class="token punctuation">.</span>TreeNode<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span> hd <span class="token operator">=</span> null<span class="token punctuation">,</span> tl <span class="token operator">=</span> null<span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// éå†é“¾è¡¨ï¼Œè½¬åŒ–ä¸ºçº¢é»‘æ ‘èŠ‚ç‚¹ç»„æˆçš„é“¾è¡¨</span>
                        <span class="token keyword">for</span> <span class="token punctuation">(</span>ConcurrentHashMap<span class="token punctuation">.</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span> e <span class="token operator">=</span> b<span class="token punctuation">;</span> e <span class="token operator">!=</span> null<span class="token punctuation">;</span> e <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            ConcurrentHashMap<span class="token punctuation">.</span>TreeNode<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap<span class="token punctuation">.</span>TreeNode</span><span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash<span class="token punctuation">,</span> e<span class="token punctuation">.</span>key<span class="token punctuation">,</span> e<span class="token punctuation">.</span>val<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>prev <span class="token operator">=</span> tl<span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span>
                                hd <span class="token operator">=</span> p<span class="token punctuation">;</span>
                            <span class="token keyword">else</span>
                                tl<span class="token punctuation">.</span>next <span class="token operator">=</span> p<span class="token punctuation">;</span>
                            tl <span class="token operator">=</span> p<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment" spellcheck="true">// å’ŒHashMapä¸ä¸€æ ·ï¼Œæ’å…¥çš„æ˜¯TreeBinï¼Œä»£è¡¨äº†è¿™æ£µçº¢é»‘æ ‘ï¼Œä¸æ˜¯TreeNodeï¼ŒTreeBinçš„æ„é€ å‡½æ•°å†…åŒ…å«äº†çº¢é»‘æ ‘çš„è½¬åŒ–è¿‡ç¨‹</span>
                        <span class="token comment" spellcheck="true">// åº”è¯¥æ˜¯ä¸ºäº†æ–¹ä¾¿åŠ é”ï¼Œå› ä¸ºçº¢é»‘æ ‘é‡å¹³è¡¡åæ ¹èŠ‚ç‚¹å¯èƒ½ä¼šå˜çš„ï¼Œä¸å¥½ç›´æ¥å¯¹æ ¹èŠ‚ç‚¹åŠ é”</span>
                        <span class="token function">setTabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> index<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap<span class="token punctuation">.</span>TreeBin</span><span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span><span class="token punctuation">(</span>hd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>ConcurrentHashMap#tryPresize</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">tryPresize</span><span class="token punctuation">(</span><span class="token keyword">int</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// è®¡ç®—æ‰©å®¹åçš„æ•°ç»„å¤§å°ï¼Œæœ€å°çš„2çš„å¹‚</span>
        <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token punctuation">(</span>size <span class="token operator">>=</span> <span class="token punctuation">(</span>MAXIMUM_CAPACITY <span class="token operator">>>></span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> MAXIMUM_CAPACITY <span class="token operator">:</span> <span class="token function">tableSizeFor</span><span class="token punctuation">(</span>size <span class="token operator">+</span> <span class="token punctuation">(</span>size <span class="token operator">>>></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> sc<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sc <span class="token operator">=</span> sizeCtl<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ConcurrentHashMap<span class="token punctuation">.</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab <span class="token operator">=</span> table<span class="token punctuation">;</span>
            <span class="token keyword">int</span> n<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ•°ç»„è¿˜æ²¡åˆå§‹åŒ–ï¼Œé‚£å°±å…ˆåˆå§‹åŒ–æ•°ç»„ï¼Œä¸‹ä¸ªå¾ªç¯å†æ£€æµ‹æ˜¯å¦éœ€è¦æ‰©å®¹</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>tab <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æ–°æ•°ç»„å¤§å°</span>
                n <span class="token operator">=</span> <span class="token punctuation">(</span>sc <span class="token operator">></span> c<span class="token punctuation">)</span> <span class="token operator">?</span> sc <span class="token operator">:</span> c<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// CASå°è¯•è·å–é”ï¼Œå°è¯•æ›´æ–°sizeCtlä¸º-1ï¼Œæ•°ç»„æ­£åœ¨åˆå§‹åŒ–</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>U<span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> SIZECTL<span class="token punctuation">,</span> sc<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// DCLï¼Œå†æ¬¡æ£€æŸ¥æ•°ç»„æ˜¯å¦å·²ç»åˆå§‹åŒ–è¿‡äº†</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>table <span class="token operator">==</span> tab<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span> ConcurrentHashMap<span class="token punctuation">.</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> nt <span class="token operator">=</span> <span class="token punctuation">(</span>ConcurrentHashMap<span class="token punctuation">.</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap<span class="token punctuation">.</span>Node</span><span class="token operator">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// æ›´æ–°æ•°ç»„</span>
                            table <span class="token operator">=</span> nt<span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// æ‰©å®¹é˜ˆå€¼ä¸ºæ•°ç»„å¤§å°çš„0.75å€</span>
                            sc <span class="token operator">=</span> n <span class="token operator">-</span> <span class="token punctuation">(</span>n <span class="token operator">>>></span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                        sizeCtl <span class="token operator">=</span> sc<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// æ•°ç»„è¿˜æ²¡è¾¾åˆ°æ‰©å®¹çš„é˜ˆå€¼æˆ–è€…è¶…è¿‡äº†æ•°ç»„çš„æœ€å¤§å®¹é‡é˜ˆå€¼é‚£å°±è·³å‡º</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">&lt;=</span> sc <span class="token operator">||</span> n <span class="token operator">>=</span> MAXIMUM_CAPACITY<span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// æ‰©å®¹å‰è¦å†æ¬¡æ£€æŸ¥å½“å‰è¦æ‰©å®¹çš„æ•°ç»„æ˜¯å¦è¿˜æ˜¯åŸæœ¬çš„æ•°ç»„ï¼Œå› ä¸ºæ‰©å®¹æ˜¯å¹¶å‘çš„ï¼Œå¯èƒ½æ­¤æ—¶æ‰©å®¹å·²ç»å®Œæˆäº†ï¼Œå¤§æ¦‚æ˜¯çº¿ç¨‹æŒ‚èµ·å†å”¤é†’çš„æƒ…å†µ</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>tab <span class="token operator">==</span> table<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> rs <span class="token operator">=</span> <span class="token function">resizeStamp</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// æ•°ç»„æ­£åœ¨æ‰©å®¹</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>sc <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    ConcurrentHashMap<span class="token punctuation">.</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> nt<span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// å‚è€ƒaddCountçš„æ³¨é‡Šï¼Œæ€»ä¹‹å°±æ˜¯ä¸éœ€è¦æ–°çš„çº¿ç¨‹å‚ä¸æ‰©å®¹äº†</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sc <span class="token operator">>>></span> RESIZE_STAMP_SHIFT<span class="token punctuation">)</span> <span class="token operator">!=</span> rs <span class="token operator">||</span> sc <span class="token operator">==</span> rs <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">||</span> sc <span class="token operator">==</span> rs <span class="token operator">+</span> MAX_RESIZERS <span class="token operator">||</span> <span class="token punctuation">(</span>nt <span class="token operator">=</span> nextTable<span class="token punctuation">)</span> <span class="token operator">==</span> null <span class="token operator">||</span> transferIndex <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// å¦åˆ™ï¼ŒCASå°è¯•æ›´æ–°sizeCtlï¼ŒååŠ©æ‰©å®¹çš„çº¿ç¨‹æ•°åŠ 1ï¼ŒæˆåŠŸæ‰èƒ½å‚ä¸æ‰©å®¹</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>U<span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> SIZECTL<span class="token punctuation">,</span> sc<span class="token punctuation">,</span> sc <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token function">transfer</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> nt<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// æ•°ç»„è¿˜æ²¡æ‰©å®¹ï¼Œé‚£å½“å‰çº¿ç¨‹å°±æ˜¯å‘èµ·æ‰©å®¹çš„çº¿ç¨‹ï¼ŒCASæ›´æ–°sizeCtlæˆåŠŸæ‰èƒ½æ‰©å®¹</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>U<span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> SIZECTL<span class="token punctuation">,</span> sc<span class="token punctuation">,</span> <span class="token punctuation">(</span>rs <span class="token operator">&lt;&lt;</span> RESIZE_STAMP_SHIFT<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token function">transfer</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>ConcurrentHashMap#addCount</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">addCount</span><span class="token punctuation">(</span><span class="token keyword">long</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> check<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ConcurrentHashMap<span class="token punctuation">.</span>CounterCell<span class="token punctuation">[</span><span class="token punctuation">]</span> as<span class="token punctuation">;</span>
        <span class="token keyword">long</span> b<span class="token punctuation">,</span> s<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¦‚æœcounterCellsä¸ä¸ºnullï¼Œè¯´æ˜å­˜åœ¨å¹¶å‘ä¿®æ”¹ || å¦‚æœCASæ›´æ–°baseCountå¤±è´¥ï¼Œè¯´æ˜å­˜åœ¨å¹¶å‘ä¿®æ”¹</span>
        <span class="token comment" spellcheck="true">// å³æ˜¯è¯´ï¼Œä¼˜å…ˆCASå°è¯•ä¿®æ”¹baseCountï¼Œåœ¨å­˜åœ¨å¹¶å‘ä¿®æ”¹çš„æƒ…å†µä¸‹ï¼Œé¿å…é›†ä¸­çš„CASæ“ä½œï¼Œè€Œæ˜¯å°†ä¿®æ”¹åˆ†æ•£åœ°æš‚å­˜åœ¨counterCells</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>as <span class="token operator">=</span> counterCells<span class="token punctuation">)</span> <span class="token operator">!=</span> null <span class="token operator">||</span> <span class="token operator">!</span>U<span class="token punctuation">.</span><span class="token function">compareAndSwapLong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> BASECOUNT<span class="token punctuation">,</span> b <span class="token operator">=</span> baseCount<span class="token punctuation">,</span> s <span class="token operator">=</span> b <span class="token operator">+</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ConcurrentHashMap<span class="token punctuation">.</span>CounterCell a<span class="token punctuation">;</span>
            <span class="token keyword">long</span> v<span class="token punctuation">;</span>
            <span class="token keyword">int</span> m<span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> uncontended <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å¦‚æœCounterCellæ•°ç»„ä¸å­˜åœ¨ || å¦‚æœCounterCellæ•°ç»„é•¿åº¦ä¸º0 || è¯¥çº¿ç¨‹çš„å“ˆå¸Œå®šä½åˆ°CounterCellæ•°ç»„çš„ä½ç½®ä¸ºç©º || è¯¥ä½ç½®ä¸ä¸ºç©ºï¼Œå¹¶ä¸”CASæ›´æ–°è¯¥CounterCellå¤±è´¥</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>as <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token punctuation">(</span>m <span class="token operator">=</span> as<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span>a <span class="token operator">=</span> as<span class="token punctuation">[</span>ThreadLocalRandom<span class="token punctuation">.</span><span class="token function">getProbe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> m<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token operator">!</span><span class="token punctuation">(</span>uncontended <span class="token operator">=</span> U<span class="token punctuation">.</span><span class="token function">compareAndSwapLong</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> CELLVALUE<span class="token punctuation">,</span> v <span class="token operator">=</span> a<span class="token punctuation">.</span>value<span class="token punctuation">,</span> v <span class="token operator">+</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å°è¯•è‡ªæ—‹æ›´æ–°CounterCellï¼Œuncontendedä¸ºfalse</span>
                <span class="token function">fullAddCount</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> uncontended<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// æˆåŠŸå°±è¿”å›ï¼Œä¹Ÿä¸ç»§ç»­æ£€æŸ¥è¦ä¸è¦æ‰©å®¹äº†</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// è¯´æ˜æ˜¯è¢«åˆ é™¤æ–¹æ³•è°ƒç”¨ï¼Œç›´æ¥è¿”å›</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>check <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å¦åˆ™è¯´æ˜æ˜¯è¢«æ·»åŠ æ–¹æ³•è°ƒç”¨ï¼Œéœ€è¦è®¡ç®—å…ƒç´ ä¸ªæ•°ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦æ‰©å®¹ï¼Œå¦å¤–Mapæ²¡æœ‰è‡ªåŠ¨ç¼©å®¹çš„åŠŸèƒ½</span>
            s <span class="token operator">=</span> <span class="token function">sumCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å¦‚æœéœ€è¦æ£€æŸ¥æ˜¯å¦éœ€è¦æ‰©å®¹</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>check <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ConcurrentHashMap<span class="token punctuation">.</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab<span class="token punctuation">,</span> nt<span class="token punctuation">;</span>
            <span class="token keyword">int</span> n<span class="token punctuation">,</span> sc<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å…ƒç´ æ•°é‡è¶…å‡ºæ‰©å®¹é˜ˆå€¼ &amp;&amp; æ•°ç»„ä¸ä¸ºç©º &amp;&amp; æ•°ç»„å®¹é‡å°äºæœ€å¤§é™åˆ¶</span>
            <span class="token comment" spellcheck="true">// é‚£ä¹ˆå°±æ‰©å®¹</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>s <span class="token operator">>=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>sc <span class="token operator">=</span> sizeCtl<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>tab <span class="token operator">=</span> table<span class="token punctuation">)</span> <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">&lt;</span> MAXIMUM_CAPACITY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å½“å‰æ•°ç»„çš„é•¿åº¦çš„äºŒè¿›åˆ¶å€¼ä¸­å¼€å¤´0çš„æ•°é‡</span>
                <span class="token keyword">int</span> rs <span class="token operator">=</span> <span class="token function">resizeStamp</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// è¯´æ˜æ­£åœ¨æ‰©å®¹</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>sc <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">/*
                     * æ‰©å®¹å·²ç»ç»“æŸçš„5ç§æƒ…å†µï¼Œé€€å‡ºå¾ªç¯ï¼š
                     * sizeCtlæ— ç¬¦å·å³ç§»16ä½ï¼Œå³é«˜16ä½ä¸ç­‰äºrsï¼Œè¯´æ˜æ‰©å®¹å·²ç»ç»“æŸï¼ŒsizeCtlå·²ç»è¢«æ›´æ–°
                     * ç¬¬ä¸€ä¸ªå¼€å§‹æ‰©å®¹çš„çº¿ç¨‹ä¼šå°†sizeCtlæ— ç¬¦å·å·¦ç§»16ä½å†åŠ 2ï¼Œå³æ‰€æœ‰çº¿ç¨‹é€€å‡ºæ—¶sc == rs + 1
                     * å¤§æ¦‚æ˜¯æ‰©å®¹çš„çº¿ç¨‹æ•°å·²ç»åˆ°äº†65535ï¼Œä¸èƒ½å†å¢åŠ æ‰©å®¹çš„çº¿ç¨‹äº†ï¼Œå› ä¸ºä½16ä½å·²ç»æº¢å‡ºäº†
                     * nextTableä¸ºç©ºè¯´æ˜æ‰©å®¹å·²ç»å®Œæˆï¼Œå¹¶ä¸”æ–°æ•°ç»„å·²ç»æ›´æ–°
                     * transferIndex &lt;= 0è¯´æ˜åŸæœ¬æ•°ç»„å…¨éƒ¨ä½ç½®å·²ç»åˆ†é…å¥½çº¿ç¨‹äº†ï¼Œä¸éœ€è¦æ–°çš„çº¿ç¨‹å‚ä¸
                     */</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sc <span class="token operator">>>></span> RESIZE_STAMP_SHIFT<span class="token punctuation">)</span> <span class="token operator">!=</span> rs <span class="token operator">||</span> sc <span class="token operator">==</span> rs <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">||</span> sc <span class="token operator">==</span> rs <span class="token operator">+</span> MAX_RESIZERS <span class="token operator">||</span> <span class="token punctuation">(</span>nt <span class="token operator">=</span> nextTable<span class="token punctuation">)</span> <span class="token operator">==</span> null <span class="token operator">||</span> transferIndex <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// å¦åˆ™è¯´æ˜æ‰©å®¹æœªå®Œæˆï¼Œéœ€è¦çº¿ç¨‹ååŠ©ï¼Œå¦‚æœCASå°†sizeCtlåŠ 1æˆåŠŸï¼Œåˆ™å¸®å¿™è¿›è¡Œæ‰©å®¹ï¼ŒåŠ 1æ˜¯ä»£è¡¨å‚ä¸æ‰©å®¹çš„çº¿ç¨‹å¢åŠ </span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>U<span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> SIZECTL<span class="token punctuation">,</span> sc<span class="token punctuation">,</span> sc <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token comment" spellcheck="true">// å¸®åŠ©æ‰©å®¹ï¼ŒnextTableæ˜¯æ‰©å®¹åçš„æ–°è¡¨</span>
                        <span class="token function">transfer</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> nt<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">/*
                 * å½“å‰æ²¡æœ‰æ‰©å®¹ï¼Œè¯´æ˜æ˜¯ç¬¬ä¸€ä¸ªæ‰©å®¹çš„çº¿ç¨‹ï¼Œé‚£ä¹ˆCASå°è¯•æ›´æ–°sizeCtlï¼ŒæˆåŠŸäº†å°±æ‰©å®¹
                 * è¿™é‡ŒæŠŠrsæœ‰ç¬¦å·å·¦ç§»16ä½ï¼Œé‚£ä¹ˆæœ€é«˜ä½å°±æ˜¯ç¬¦å·ä½1ï¼Œæ˜¯ä¸ªè´Ÿæ•°ï¼Œé«˜ä½å‰©ä¸‹çš„15ä½åˆ™ä¿å­˜äº†å½“å‰æ•°ç»„çš„é•¿åº¦çš„äºŒè¿›åˆ¶å€¼ä¸­å¼€å¤´0çš„æ•°é‡ï¼Œå› ä¸ºæ•°ç»„é•¿åº¦æ˜¯2çš„æŒ‡æ•°å¹‚ï¼Œæ‰€ä»¥äºŒè¿›åˆ¶å€¼è‚¯å®šæ˜¯0...010...0è¿™æ ·ï¼Œæ‰€ä»¥åªè¦çŸ¥é“å¼€å¤´å‡ ä¸ª0å°±è¡Œäº†
                 * ç„¶ååŠ 2ï¼Œæ‰€ä»¥æœ€å¼€å§‹æ‰©å®¹æ—¶æ˜¯åŠ 2çš„ï¼Œæ‰©å®¹å®Œæˆåæ˜¯å‡1ï¼Œå³sizeCtl == rs + 1
                 * å‡è®¾å½“å‰æ•°ç»„å®¹é‡ä¸º16ï¼Œé‚£ä¹ˆresizeStampæ–¹æ³•è¿”å›rs = 0000 0000 0000 0000 1000 0000 0001 0000
                 * resizeStamp(16) &lt;&lt; RESIZE_STAMP_SHIFT) + 2 == 10000000000100000000000000000010ï¼Œè¡¨ç¤ºæœ‰2-1=1ä¸ªçº¿ç¨‹æ­£åœ¨æ‰©å®¹
                 */</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>U<span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> SIZECTL<span class="token punctuation">,</span> sc<span class="token punctuation">,</span> <span class="token punctuation">(</span>rs <span class="token operator">&lt;&lt;</span> RESIZE_STAMP_SHIFT<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token comment" spellcheck="true">// å‘èµ·æ‰©å®¹ï¼Œè¿ç§»æ•°æ®</span>
                    <span class="token function">transfer</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å†æ¬¡ç»Ÿè®¡å…ƒç´ ä¸ªæ•°ï¼Œæ˜¯å¦è¿˜è¦ç»§ç»­æ‰©å®¹ï¼Œå¯èƒ½æ‰©å®¹æœŸé—´æœ‰æ–°çš„å…ƒç´ æ·»åŠ è¿›æ¥</span>
                s <span class="token operator">=</span> <span class="token function">sumCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>ConcurrentHashMap#fullAddCount</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">fullAddCount</span><span class="token punctuation">(</span><span class="token keyword">long</span> x<span class="token punctuation">,</span> <span class="token keyword">boolean</span> wasUncontended<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> h<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è¯´æ˜è¯¥çº¿ç¨‹ç¬¬ä¸€æ¬¡è¿›å…¥</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>h <span class="token operator">=</span> ThreadLocalRandom<span class="token punctuation">.</span><span class="token function">getProbe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å…ˆåˆå§‹åŒ–è¯¥çº¿ç¨‹çš„ThreadLocalRandom</span>
            ThreadLocalRandom<span class="token punctuation">.</span><span class="token function">localInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// çº¿ç¨‹çš„éšæœºæ•°ï¼Œå¯ä»¥ç†è§£ä¸ºæœ¬æ¬¡çš„å“ˆå¸Œå€¼</span>
            h <span class="token operator">=</span> ThreadLocalRandom<span class="token punctuation">.</span><span class="token function">getProbe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            wasUncontended <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">boolean</span> collide <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// è‡ªæ—‹é‡è¯•</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ConcurrentHashMap<span class="token punctuation">.</span>CounterCell<span class="token punctuation">[</span><span class="token punctuation">]</span> as<span class="token punctuation">;</span>
            ConcurrentHashMap<span class="token punctuation">.</span>CounterCell a<span class="token punctuation">;</span>
            <span class="token keyword">int</span> n<span class="token punctuation">;</span>
            <span class="token keyword">long</span> v<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å¦‚æœCounterCellæ•°ç»„å·²åˆå§‹åŒ–</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>as <span class="token operator">=</span> counterCells<span class="token punctuation">)</span> <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> as<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å¦‚æœå“ˆå¸Œå®šä½åˆ°çš„ä½ç½®æ²¡æœ‰CounterCell</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>a <span class="token operator">=</span> as<span class="token punctuation">[</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> h<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å¦‚æœå½“å‰çš„CounterCellæ•°ç»„ä¸å­˜åœ¨ç«äº‰</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>cellsBusy <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// åˆ›å»ºä¸€ä¸ªCounterCell</span>
                        ConcurrentHashMap<span class="token punctuation">.</span>CounterCell r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap<span class="token punctuation">.</span>CounterCell</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// DCL &amp;&amp; CASå°†cellsBusyç”±ç©ºé—²ä¿®æ”¹ä¸ºå¿™ç¢ŒçŠ¶æ€æˆåŠŸï¼Œç±»ä¼¼è·å–é”</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>cellsBusy <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> U<span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> CELLSBUSY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">boolean</span> created <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                                ConcurrentHashMap<span class="token punctuation">.</span>CounterCell<span class="token punctuation">[</span><span class="token punctuation">]</span> rs<span class="token punctuation">;</span>
                                <span class="token keyword">int</span> m<span class="token punctuation">,</span> j<span class="token punctuation">;</span>
                                <span class="token comment" spellcheck="true">// DCLï¼Œå†æ¬¡æ£€æŸ¥</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>rs <span class="token operator">=</span> counterCells<span class="token punctuation">)</span> <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>m <span class="token operator">=</span> rs<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> rs<span class="token punctuation">[</span>j <span class="token operator">=</span> <span class="token punctuation">(</span>m <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> h<span class="token punctuation">]</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    <span class="token comment" spellcheck="true">// æŠŠåˆ›å»ºçš„CounterCellåŠ å…¥æ•°ç»„</span>
                                    rs<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> r<span class="token punctuation">;</span>
                                    <span class="token comment" spellcheck="true">// æ ‡è®°æ“ä½œä¸ºæˆåŠŸ</span>
                                    created <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                                <span class="token comment" spellcheck="true">// é‡ç½®ä¸ºç©ºé—²çŠ¶æ€</span>
                                cellsBusy <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            <span class="token comment" spellcheck="true">// å¦‚æœæ“ä½œæˆåŠŸï¼Œä¸å†ç»§ç»­ï¼Œå¦åˆ™ä¸‹ä¸ªå¾ªç¯ç»§ç»­å°è¯•</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>created<span class="token punctuation">)</span>
                                <span class="token keyword">break</span><span class="token punctuation">;</span>
                            <span class="token keyword">continue</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    collide <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">/*
                 * ç¬¬ä¸€æ¬¡è¿›æ¥æ—¶ï¼Œå¦‚æœå‘ç”Ÿäº†å“ˆå¸Œå†²çªï¼Œé¦–å…ˆè¿›æ¥è¿™é‡Œï¼Œç„¶ååˆ°ä¸‹é¢æ¢ä¸€ä¸ªå“ˆå¸Œå€¼å°è¯•åˆ«çš„ä½ç½®ï¼Œè€Œä¸æ˜¯å°è¯•CAS
                 * å¦‚æœç¬¬äºŒæ¬¡å¾ªç¯è¿˜æ˜¯æœ‰å“ˆå¸Œå†²çªï¼Œæ‰å°è¯•CASæ›´æ–°CounterCellï¼Œå¤±è´¥åˆ™æ£€æŸ¥æ˜¯å¦æ‰©å®¹æ•°ç»„ï¼Œä¸èƒ½æ‰©å®¹åˆ™æ¢ä¸€ä¸ªå“ˆå¸Œä¸‹ä¸ªå¾ªç¯ç»§ç»­
                 */</span>
                <span class="token comment" spellcheck="true">// åˆ°è¿™é‡Œè¯´æ˜å‘ç”Ÿäº†å“ˆå¸Œå†²çª</span>
                <span class="token comment" spellcheck="true">// contendedè¡¨ç¤ºç«äº‰ï¼ŒåŒé‡å¦å®šå°±æ˜¯è‚¯å®š</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>wasUncontended<span class="token punctuation">)</span>
                    <span class="token comment" spellcheck="true">// æ ‡å¿—ä¸ºæ— ç«äº‰ï¼Œç„¶åä¸ä¼šå°è¯•CASæ›´æ–°ï¼Œè€Œæ˜¯ä¼šè·³åˆ°æœ€ä¸‹é¢ï¼Œæ¢ä¸€ä¸ªå“ˆå¸Œå€¼ï¼Œé‡æ–°æ‰§è¡Œå¾ªç¯</span>
                    wasUncontended <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// å°è¯•CASæ›´æ–°è¯¥CounterCellçš„å€¼ï¼Œå¦‚æœæˆåŠŸåˆ™ä¸éœ€ç»§ç»­</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>U<span class="token punctuation">.</span><span class="token function">compareAndSwapLong</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> CELLVALUE<span class="token punctuation">,</span> v <span class="token operator">=</span> a<span class="token punctuation">.</span>value<span class="token punctuation">,</span> v <span class="token operator">+</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// CASæ›´æ–°å¤±è´¥ï¼Œå†æ¬¡æ£€æŸ¥CounterCellæ•°ç»„æ˜¯å¦å·²ç»æ‰©å®¹æˆ–å®¹é‡è¾¾åˆ°æœ€å¤§å€¼ï¼Œå³CPUæ ¸å¿ƒæ•°</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>counterCells <span class="token operator">!=</span> as <span class="token operator">||</span> n <span class="token operator">>=</span> NCPU<span class="token punctuation">)</span>
                    <span class="token comment" spellcheck="true">// ä¸èƒ½æ‰©å®¹æ•°ç»„ï¼Œé‚£ä¹ˆå°±æ ‡è®°å†²çªä¸ºfalseï¼Œç»§ç»­åŒ¹é…ä¸‹ä¸ªåˆ†æ”¯ï¼Œä¸å†åŒ¹é…æ‰©å®¹åˆ†æ”¯ï¼Œç„¶ååˆ°ä¸‹é¢æ¢ä¸€ä¸ªå“ˆå¸Œå€¼</span>
                    collide <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// å¦‚æœå†²çªæ ‡è®°ä¸ºfalseï¼Œé‚£ä¹ˆè®¾ç½®ä¸ºtrueï¼Œä¸‹é¢å°±æ¢ä¸€ä¸ªå“ˆå¸Œï¼Œç»§ç»­ä¸‹ä¸€è½®å¾ªç¯åˆ¤æ–­ï¼Œåªæœ‰ä¸ºtrueæ‰ä¼šå°è¯•æ‰©å®¹</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>collide<span class="token punctuation">)</span>
                    collide <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// CASå°è¯•åŠ é”ï¼Œç„¶åæ‰èƒ½æ‰©å®¹CounterCellæ•°ç»„</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cellsBusy <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> U<span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> CELLSBUSY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// æ£€æŸ¥æ˜¯å¦å·²è¢«æ‰©å®¹</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>counterCells <span class="token operator">==</span> as<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// CounterCellæ•°ç»„æ‰©å®¹ï¼Œç¿»å€</span>
                            ConcurrentHashMap<span class="token punctuation">.</span>CounterCell<span class="token punctuation">[</span><span class="token punctuation">]</span> rs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap<span class="token punctuation">.</span>CounterCell</span><span class="token punctuation">[</span>n <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// æ•°æ®è¿ç§»</span>
                            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
                                rs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> as<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                            counterCells <span class="token operator">=</span> rs<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                        cellsBusy <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    collide <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// å¦‚æœä¸Šé¢çš„æ¡ä»¶éƒ½ä¸æ»¡è¶³ï¼Œé‚£ä¹ˆæ›´æ–°å½“å‰çº¿ç¨‹çš„å“ˆå¸Œå€¼ï¼Œä¸‹ä¸ªå¾ªç¯å°è¯•åˆ«çš„ä½ç½®</span>
                h <span class="token operator">=</span> ThreadLocalRandom<span class="token punctuation">.</span><span class="token function">advanceProbe</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å¦‚æœCounterCellæ•°ç»„æœªåˆå§‹åŒ–ï¼Œå°è¯•CASå°†cellsBusyç”±0æ›´æ–°ä¸º1ï¼ŒæˆåŠŸæ‰èƒ½åˆå§‹åŒ–</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cellsBusy <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> counterCells <span class="token operator">==</span> as <span class="token operator">&amp;&amp;</span> U<span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> CELLSBUSY<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">boolean</span> init <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ç±»ä¼¼DCLçš„åŒé‡æ£€æŸ¥ï¼Œåå¤å‡ºç°çš„è€å¥—è·¯äº†</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>counterCells <span class="token operator">==</span> as<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// åˆå§‹åŒ–CounterCellæ•°ç»„ï¼Œåˆå§‹å®¹é‡ä¸º2</span>
                        ConcurrentHashMap<span class="token punctuation">.</span>CounterCell<span class="token punctuation">[</span><span class="token punctuation">]</span> rs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap<span class="token punctuation">.</span>CounterCell</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// æ ¹æ®å“ˆå¸Œæ’å…¥CounterCell</span>
                        rs<span class="token punctuation">[</span>h <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap<span class="token punctuation">.</span>CounterCell</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        counterCells <span class="token operator">=</span> rs<span class="token punctuation">;</span>
                        init <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    cellsBusy <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>init<span class="token punctuation">)</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// è¯´æ˜å½“å‰CounterCellæ•°ç»„å­˜åœ¨ç«äº‰åˆå§‹åŒ–ï¼Œé‚£ä¹ˆCASå°è¯•æ›´æ–°baseCount</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>U<span class="token punctuation">.</span><span class="token function">compareAndSwapLong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> BASECOUNT<span class="token punctuation">,</span> v <span class="token operator">=</span> baseCount<span class="token punctuation">,</span> v <span class="token operator">+</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>ConcurrentHashMap$CounterCell</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * ä¼ªå…±äº«ï¼šç¼“å­˜æ˜¯ä»¥ç¼“å­˜è¡Œï¼ˆcache lineï¼‰ä¸ºå•ä½å­˜å‚¨çš„ï¼Œå½“å¤šçº¿ç¨‹ä¿®æ”¹äº’ç›¸ç‹¬ç«‹çš„å˜é‡æ—¶ï¼Œå¦‚æœè¿™äº›å˜é‡å…±äº«åŒä¸€ä¸ªç¼“å­˜è¡Œï¼Œå°±ä¼šè¿åŒå…¶å®ƒçš„å˜é‡ä¸€èµ·å¤±æ•ˆ
     * ä¸€èˆ¬çš„è§£å†³åŠæ³•æ˜¯å¯¹å˜é‡æ·»åŠ ä¸€äº›æ— æ„ä¹‰çš„å ä½Paddingï¼Œä½¿å®ƒç‹¬äº«ä¸€ä¸ªç¼“å­˜è¡Œï¼Œå¦‚@sun.misc.Contended
     * è¿™ä¸ªæ³¨è§£é»˜è®¤æ˜¯JDKåŒ…æ‰èƒ½ç”¨çš„ï¼Œè¦åœ¨è‡ªå·±çš„ä»£ç ä¸Šä½¿ç”¨ï¼Œéœ€è¦æ·»åŠ JVMå‚æ•°ï¼šâ€œ-XX:-RestrictContendedâ€
     */</span>
    <span class="token annotation punctuation">@sun</span><span class="token punctuation">.</span>misc<span class="token punctuation">.</span>Contended
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">CounterCell</span> <span class="token punctuation">{</span>
        <span class="token keyword">volatile</span> <span class="token keyword">long</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ConcurrentHashMap#sumCount</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">final</span> <span class="token keyword">long</span> <span class="token function">sumCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ConcurrentHashMap<span class="token punctuation">.</span>CounterCell<span class="token punctuation">[</span><span class="token punctuation">]</span> as <span class="token operator">=</span> counterCells<span class="token punctuation">;</span>
        ConcurrentHashMap<span class="token punctuation">.</span>CounterCell a<span class="token punctuation">;</span>
        <span class="token keyword">long</span> sum <span class="token operator">=</span> baseCount<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>as <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å¯èƒ½ä¸å‡†ç¡®ï¼Œæ¯”å¦‚ä¸€ä¸ªå·²ç»éå†è¿‡çš„CounterCellä½ç½®åˆå‘ç”Ÿäº†å˜åŒ–ï¼Œæ¯•ç«Ÿæ²¡æœ‰é”</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> as<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>a <span class="token operator">=</span> as<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span>
                    <span class="token comment" spellcheck="true">// baseCountå åŠ counterCells</span>
                    sum <span class="token operator">+=</span> a<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> sum<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ConcurrentHashMap#helpTransfer</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">final</span> ConcurrentHashMap<span class="token punctuation">.</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">helpTransfer</span><span class="token punctuation">(</span>ConcurrentHashMap<span class="token punctuation">.</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab<span class="token punctuation">,</span> ConcurrentHashMap<span class="token punctuation">.</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span> f<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ConcurrentHashMap<span class="token punctuation">.</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> nextTab<span class="token punctuation">;</span>
        <span class="token keyword">int</span> sc<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// æ•°ç»„ä¸ä¸ºç©º &amp;&amp; è¯¥ä½ç½®ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¸ºForwardingNode &amp;&amp; ForwardingNodeæŒ‡å‘çš„å½“å‰åœ¨æ‰©å®¹çš„æ–°æ•°ç»„ä¸ä¸ºç©º</span>
        <span class="token comment" spellcheck="true">// è¯´æ˜åŸæ•°ç»„è¯¥ä½ç½®çš„èŠ‚ç‚¹å·²ç»å®Œæˆè¿ç§»äº†ï¼Œå¹¶ä¸”è¿ç§»è¿˜æ²¡å®Œæˆï¼Œé‚£ä¹ˆå°±å¸®å¿™è¿ç§»åˆ«çš„ä½ç½®</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tab <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>f <span class="token keyword">instanceof</span> <span class="token class-name">ConcurrentHashMap<span class="token punctuation">.</span>ForwardingNode</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>nextTab <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ConcurrentHashMap<span class="token punctuation">.</span>ForwardingNode<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span><span class="token punctuation">)</span> f<span class="token punctuation">)</span><span class="token punctuation">.</span>nextTable<span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> rs <span class="token operator">=</span> <span class="token function">resizeStamp</span><span class="token punctuation">(</span>tab<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ‰©å®¹çš„æ–°æ•°ç»„æ˜¯åŒä¸€ä¸ª &amp;&amp; æ•°ç»„è¿˜æ²¡è¢«æ›¿æ¢ &amp;&amp; å½“å‰æ­£åœ¨æ‰©å®¹</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>nextTab <span class="token operator">==</span> nextTable <span class="token operator">&amp;&amp;</span> table <span class="token operator">==</span> tab <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>sc <span class="token operator">=</span> sizeCtl<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å‚è€ƒaddCountçš„æ³¨é‡Šï¼Œæ€»ä¹‹å°±æ˜¯ä¸éœ€è¦æ–°çš„çº¿ç¨‹å‚ä¸æ‰©å®¹äº†</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sc <span class="token operator">>>></span> RESIZE_STAMP_SHIFT<span class="token punctuation">)</span> <span class="token operator">!=</span> rs <span class="token operator">||</span> sc <span class="token operator">==</span> rs <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">||</span> sc <span class="token operator">==</span> rs <span class="token operator">+</span> MAX_RESIZERS <span class="token operator">||</span> transferIndex <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token comment" spellcheck="true">// è·³å‡ºå¾ªç¯</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å¦åˆ™ï¼ŒCASå°è¯•æ›´æ–°sizeCtlï¼ŒååŠ©æ‰©å®¹çš„çº¿ç¨‹æ•°åŠ 1ï¼ŒæˆåŠŸæ‰èƒ½å‚ä¸æ‰©å®¹</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>U<span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> SIZECTL<span class="token punctuation">,</span> sc<span class="token punctuation">,</span> sc <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å¸®å¿™æ‰©å®¹ï¼Œä¼ å…¥çš„æ–°æ•°ç»„ä¸ä¸ºç©º</span>
                    <span class="token function">transfer</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> nextTab<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> nextTab<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> table<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ConcurrentHashMap#transfer</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * æ”¯æŒå¤šçº¿ç¨‹å¹¶å‘å¤åˆ¶åŸæ•°ç»„çš„æ•°æ®åˆ°æ–°æ•°ç»„
     * å‡è®¾åŸæ•°ç»„é•¿åº¦ä¸ºnï¼Œæ¯ä¸ªçº¿ç¨‹æ¯æ¬¡å¯ä»¥è´Ÿè´£ä¸€æ‰¹ä»»åŠ¡ï¼Œå³æ­¥é•¿ï¼Œæ¯å®Œæˆä¸€æ‰¹ä»»åŠ¡å†æ£€æµ‹æ˜¯å¦æœ‰å…¶ä»–æ²¡å®Œæˆçš„ï¼Œå¸®åŠ©æ¬è¿
     * transferIndexæŒ‡å‘åŸæ•°ç»„åï¼Œä»åå¾€å‰çš„æ­¥é•¿ä¸ªå…ƒç´ åˆ†é…ä¸ºç¬¬ä¸€æ‰¹ä»»åŠ¡ï¼Œå†å°†transferIndexæŒ‡å‘æ–°çš„ä½ç½®ï¼Œå†å¾€å‰çš„æ­¥é•¿ä¸ªå…ƒç´ å±äºç¬¬äºŒæ‰¹ä»»åŠ¡ï¼Œä¾æ­¤ç±»æ¨
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">transfer</span><span class="token punctuation">(</span>ConcurrentHashMap<span class="token punctuation">.</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab<span class="token punctuation">,</span> ConcurrentHashMap<span class="token punctuation">.</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> nextTab<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> n <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">,</span> stride<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¤åˆ¶çš„æ­¥é•¿ï¼Œæœ€å°ä¸èƒ½å°äº16</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>stride <span class="token operator">=</span> <span class="token punctuation">(</span>NCPU <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">(</span>n <span class="token operator">>>></span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">/</span> NCPU <span class="token operator">:</span> n<span class="token punctuation">)</span> <span class="token operator">&lt;</span> MIN_TRANSFER_STRIDE<span class="token punctuation">)</span>
            stride <span class="token operator">=</span> MIN_TRANSFER_STRIDE<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å¦‚æœæ‰©å®¹çš„æ–°æ•°ç»„ä¸å­˜åœ¨ï¼Œè¯´æ˜è¿˜æ²¡å¼€å§‹è¿ç§»ï¼Œé‚£å°±åˆ›å»ºä¸€ä¸ªæ–°æ•°ç»„</span>
        <span class="token comment" spellcheck="true">// ä¸Šçº§è°ƒç”¨æ–¹æ³•ä¿è¯ç¬¬ä¸€æ¬¡ConcurrentHashMap#transferæ—¶ï¼ŒnextTabä¸ºnullï¼Œè€Œä¹‹åçš„çº¿ç¨‹è°ƒç”¨æ—¶ä¸ä¸ºnull</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nextTab <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æ‰©å®¹ï¼Œæ–°æ•°ç»„å®¹é‡ç¿»å€</span>
                <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span> ConcurrentHashMap<span class="token punctuation">.</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> nt <span class="token operator">=</span> <span class="token punctuation">(</span>ConcurrentHashMap<span class="token punctuation">.</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap<span class="token punctuation">.</span>Node</span><span class="token operator">&lt;</span><span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">[</span>n <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                nextTab <span class="token operator">=</span> nt<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                sizeCtl <span class="token operator">=</span> Integer<span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// volatileæ›´æ–°ï¼Œå¯¹åé¢çš„çº¿ç¨‹ç«‹å³å¯è§</span>
            nextTable <span class="token operator">=</span> nextTab<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ‰©å®¹ç”¨çš„ç´¢å¼•ï¼Œä»åå‘å‰çš„</span>
            transferIndex <span class="token operator">=</span> n<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// æ–°æ•°ç»„çš„å®¹é‡</span>
        <span class="token keyword">int</span> nextn <span class="token operator">=</span> nextTab<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">/*
         * åŸæ•°ç»„ä¸­ä½ç½®iå¤„çš„èŠ‚ç‚¹å…¨éƒ¨æ¬åˆ°æ‰©å®¹çš„æ–°æ•°ç»„ååï¼Œå°†è¯¥ä½ç½®è®¾ä¸ºForwardingNodeï¼Œå“ˆå¸Œå€¼ä¸ºMOVEDï¼Œæ ‡å¿—è¯¥ä½ç½®å·²ç»å¤„ç†äº†
         * åŒæ—¶ForwardingNodeä¹Ÿå­˜æ”¾æ–°æ•°ç»„ï¼Œå¦‚æœgetçš„æ—¶å€™æ‰©å®¹æ²¡å®Œæˆï¼Œå“ˆå¸Œåˆå®šä½åˆ°äº†åŸæ•°ç»„çš„è¯¥ä½ç½®ï¼Œé‚£ä¹ˆä»æ–°æ•°ç»„æŸ¥æ‰¾
         */</span>
        ConcurrentHashMap<span class="token punctuation">.</span>ForwardingNode<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span> fwd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap<span class="token punctuation">.</span>ForwardingNode</span><span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span><span class="token punctuation">(</span>nextTab<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> advance <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> finishing <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// ç›´åˆ°å®Œæˆ</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> bound <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ConcurrentHashMap<span class="token punctuation">.</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span> f<span class="token punctuation">;</span>
            <span class="token keyword">int</span> fh<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å½“ä¸€ä¸ªçº¿ç¨‹å®Œæˆäº†ä¸€ä¸ªä½ç½®çš„æ¬è¿åï¼Œç»§ç»­å‘å‰æ¨è¿›</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>advance<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> nextIndex<span class="token punctuation">,</span> nextBound<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ä»åå‘å‰ï¼Œç›´åˆ°é‡åˆ°æœ¬æ‰¹ä»»åŠ¡çš„è¾¹ç•Œæˆ–è€…æ‰©å®¹å·²ç»å®Œæˆï¼Œä¸è¿‡ä¸ºä»€ä¹ˆæ˜¯ä»åå¾€å‰è€Œä¸æ˜¯ä»å‰å¾€åï¼Ÿ</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>i <span class="token operator">>=</span> bound <span class="token operator">||</span> finishing<span class="token punctuation">)</span>
                    advance <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// è¯´æ˜åŸæ•°ç»„æ‰€æœ‰ä½ç½®éƒ½åˆ†é…äº†çº¿ç¨‹å¤„ç†äº†ï¼Œä¸éœ€è¦ç»§ç»­äº†</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>nextIndex <span class="token operator">=</span> transferIndex<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    i <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                    advance <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// CASå°è¯•æ›´æ–°transferIndexï¼Œä»£è¡¨å½“å‰æ•°ç»„å·²è¢«åˆ†é…ç»™çº¿ç¨‹çš„æœ€æ–°ç´¢å¼•</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>U<span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> TRANSFERINDEX<span class="token punctuation">,</span> nextIndex<span class="token punctuation">,</span> nextBound <span class="token operator">=</span> <span class="token punctuation">(</span>nextIndex <span class="token operator">></span> stride <span class="token operator">?</span> nextIndex <span class="token operator">-</span> stride <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// æœ¬æ‰¹ä»»åŠ¡çš„è¾¹ç•Œ</span>
                    bound <span class="token operator">=</span> nextBound<span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// æœ¬æ‰¹ä»»åŠ¡çš„å¼€å§‹ç´¢å¼•ï¼Œå³æ­¥é•¿èŒƒå›´ä¸º(bound, i)</span>
                    i <span class="token operator">=</span> nextIndex <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
                    advance <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å·²ç»å…¨éƒ¨æ¬è¿å®Œæˆ || å·²ç»æ¬è¿å®Œæˆï¼ŒtransferIndexè¢«åˆ«çš„çº¿ç¨‹CASé‡ç½®äº†ï¼Ÿ || æ²¡çœ‹æ‡‚</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> i <span class="token operator">>=</span> n <span class="token operator">||</span> i <span class="token operator">+</span> n <span class="token operator">>=</span> nextn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> sc<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å¦‚æœæ‰©å®¹å·²ç»å…¨éƒ¨å®Œæˆ</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>finishing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    nextTable <span class="token operator">=</span> null<span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// æ›¿æ¢æ•°ç»„</span>
                    table <span class="token operator">=</span> nextTab<span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// ä¸‹æ¬¡æ‰©å®¹é˜ˆå€¼ä¸ºåŸæ•°ç»„å®¹é‡çš„1.5å€ï¼Œå³æ–°æ•°ç»„çš„0.75å€</span>
                    sizeCtl <span class="token operator">=</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>n <span class="token operator">>>></span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// æ¯ä¸ªçº¿ç¨‹å¼€å§‹å¸®åŠ©æ¬è¿å‰å°†sizeCtlåŠ 1ï¼Œå®Œæˆåè¦å‡1</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>U<span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> SIZECTL<span class="token punctuation">,</span> sc <span class="token operator">=</span> sizeCtl<span class="token punctuation">,</span> sc <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ç¬¬ä¸€ä¸ªå‘èµ·æ‰©å®¹çš„çº¿ç¨‹å°†sizeCtlä¿®æ”¹ä¸º(resizeStamp(n) &lt;&lt; RESIZE_STAMP_SHIFT) + 2)</span>
                    <span class="token comment" spellcheck="true">// æ³¨æ„ä¸‹é¢çš„scæ˜¯ä¸Šé¢CASå‡1å‰çš„sizeCtlï¼Œå½“å½“å‰çº¿ç¨‹ä¸ºå”¯ä¸€çš„æ‰©å®¹çº¿ç¨‹æ—¶ï¼Œscçš„ä½16ä½å€¼åº”è¯¥ä¸º2</span>
                    <span class="token comment" spellcheck="true">// ä¸‹é¢çš„æ¡ä»¶æˆç«‹æ—¶è¯´æ˜å½“å‰è¿˜æœ‰å…¶ä»–çº¿ç¨‹æ­£åœ¨æ‰©å®¹</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sc <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token function">resizeStamp</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> RESIZE_STAMP_SHIFT<span class="token punctuation">)</span>
                        <span class="token comment" spellcheck="true">// æ‰©å®¹è¿˜æ²¡å®Œï¼Œåªæ˜¯å½“å‰çº¿ç¨‹å®Œäº†ï¼Œç›´æ¥è¿”å›</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// è¯´æ˜æ‰€æœ‰æ‰©å®¹çš„çº¿ç¨‹éƒ½å·²ç»å®Œæˆæ¬è¿</span>
                    finishing <span class="token operator">=</span> advance <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">/*
                     * ié‡ç½®ä¸ºnï¼Œå³æ•°ç»„çš„é•¿åº¦ï¼Œä¸‹æ¬¡å¾ªç¯æ—¶æœ€åé€€å‡ºçš„çº¿ç¨‹å°±ä¼šä»åŸæ•°ç»„ä»åå¾€å‰éå†ä¸€éæ£€æŸ¥æ‰€æœ‰çš„èŠ‚ç‚¹æ˜¯å¦éƒ½æ˜¯ForwardingNodeï¼Œç„¶åæ‰ç”¨æ‰©å®¹çš„æ–°æ•°ç»„æ›¿ä»£åŸæ•°ç»„å¹¶é€€å‡º
                     * å› ä¸ºåœ¨if (--i >= bound || finishing)è¿™ä¸ªåˆ¤æ–­åï¼Œiæ˜¯è‚¯å®šå°äºnçš„ï¼Œä¸ä¼šæ»¡è¶³if (i &lt; 0 || i >= n || i + n >= nextn)è¿™ä¸ªé€€å‡ºæ¡ä»¶
                     * mmpï¼ŒDoug Leaå¤ªé˜´é™©äº†
                     */</span>
                    i <span class="token operator">=</span> n<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å¦‚æœåŸæ•°ç»„çš„è¯¥ä½ç½®ä¸ºç©ºï¼Œè¯´æ˜æ²¡æœ‰å†™å…¥æ•°æ®</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>f <span class="token operator">=</span> <span class="token function">tabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// ç›´æ¥ç”¨ForwardingNodeæ ‡è®°å·²å¤„ç†</span>
                advance <span class="token operator">=</span> <span class="token function">casTabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i<span class="token punctuation">,</span> null<span class="token punctuation">,</span> fwd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ForwardingNodeï¼Œè¯´æ˜è¯¥ä½ç½®çš„èŠ‚ç‚¹å·²ç»è¢«æ¬èµ°äº†ï¼Œå¯èƒ½æ˜¯æœ€åé€€å‡ºçš„çº¿ç¨‹åœ¨éå†æ£€æŸ¥</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fh <span class="token operator">=</span> f<span class="token punctuation">.</span>hash<span class="token punctuation">)</span> <span class="token operator">==</span> MOVED<span class="token punctuation">)</span>
                advance <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// è¯¥èŠ‚ç‚¹åŠ é”ï¼Œæ‰€ä»¥putå’Œtransferä¼šæœ‰ç«äº‰ï¼Œå› ä¸ºåœ¨transferå¤åˆ¶çš„è¿‡ç¨‹ä¸­å‘ç”Ÿäº†putå¢åŠ äº†æ–°èŠ‚ç‚¹ï¼Œä½†æ˜¯å¤åˆ¶åçš„æ‰©å®¹æ•°ç»„æ²¡æœ‰ï¼Œè¿™æ˜¾ç„¶æ˜¯ä¸è¡Œçš„</span>
                <span class="token comment" spellcheck="true">// ä½†æ˜¯getæ²¡æœ‰ï¼Œå› ä¸ºtransferæ˜¯æ‹·è´å®Œæ‰æ›´æ–°æ•°ç»„ï¼Œæ“ä½œå®Œæˆå‰ä¸ä¼šè¢«getçº¿ç¨‹çœ‹åˆ°ï¼Œå¦‚æœä¸å·§getçš„èŠ‚ç‚¹åˆšå¥½è¢«æ¬èµ°äº†ï¼Œè¿˜å¯ä»¥åœ¨æ–°æ•°ç»„é‡Œè¾¹æŸ¥æ‰¾</span>
                <span class="token comment" spellcheck="true">// getå’Œputçš„è¯ï¼Œå¦‚æœè¿½åŠ åˆ°é“¾è¡¨å°¾ï¼Œé‚£ä¹ˆæ˜¯å¯¹getçº¿ç¨‹ç«‹å³å¯è§çš„ï¼Œå¦‚æœåŠ åˆ°çº¢é»‘æ ‘ï¼Œæ˜¯æœ‰ç«äº‰çš„ï¼Œgetçº¿ç¨‹ä¸ä¼šè¢«é˜»å¡ï¼Œä½†æ˜¯putçº¿ç¨‹å¯èƒ½ä¼šæŒ‚èµ·</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// DCLï¼Œå†æ¬¡æ£€æŸ¥</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token operator">==</span> f<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        ConcurrentHashMap<span class="token punctuation">.</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span> ln<span class="token punctuation">,</span> hn<span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// è¯´æ˜æ˜¯é“¾è¡¨çš„èŠ‚ç‚¹</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>fh <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// 0æ”¾åœ¨ä½ä½ï¼Œå³ä½ç½®ä¸å˜ï¼Œå¦åˆ™æ”¾åœ¨é«˜ä½ï¼Œå’ŒHashMapä¸€æ ·ï¼Œéƒ½æ˜¯åˆ†æˆä¸¤æ¡é“¾è¡¨</span>
                            <span class="token keyword">int</span> runBit <span class="token operator">=</span> fh <span class="token operator">&amp;</span> n<span class="token punctuation">;</span>
                            ConcurrentHashMap<span class="token punctuation">.</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span> lastRun <span class="token operator">=</span> f<span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// ä»å¤´åˆ°å°¾éå†é“¾è¡¨èŠ‚ç‚¹</span>
                            <span class="token keyword">for</span> <span class="token punctuation">(</span>ConcurrentHashMap<span class="token punctuation">.</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span> p <span class="token operator">=</span> f<span class="token punctuation">.</span>next<span class="token punctuation">;</span> p <span class="token operator">!=</span> null<span class="token punctuation">;</span> p <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">int</span> b <span class="token operator">=</span> p<span class="token punctuation">.</span>hash <span class="token operator">&amp;</span> n<span class="token punctuation">;</span>
                                <span class="token comment" spellcheck="true">// è®°å½•é“¾è¡¨æœ€åçš„runBitç›¸åŒçš„è¿ç»­èŠ‚ç‚¹çš„runBitï¼Œå³åˆ†é…åˆ°åŒä¸€æ¡é“¾è¡¨çš„æœ€åçš„è¿ç»­å‡ ä¸ªèŠ‚ç‚¹</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>b <span class="token operator">!=</span> runBit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    <span class="token comment" spellcheck="true">// å†³å®šè¯¥åˆ†é…åˆ°å“ªæ¡é“¾è¡¨</span>
                                    runBit <span class="token operator">=</span> b<span class="token punctuation">;</span>
                                    <span class="token comment" spellcheck="true">// è¯¥æ®µè¿ç»­å‡ ä¸ªèŠ‚ç‚¹çš„èµ·å§‹èŠ‚ç‚¹</span>
                                    lastRun <span class="token operator">=</span> p<span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span>
                            <span class="token comment" spellcheck="true">// è¯¥æ®µçš„èµ·å§‹èŠ‚ç‚¹ä¼šè¢«æ’åˆ°å¯¹åº”é“¾è¡¨çš„å°¾éƒ¨</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>runBit <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                ln <span class="token operator">=</span> lastRun<span class="token punctuation">;</span>
                                hn <span class="token operator">=</span> null<span class="token punctuation">;</span>
                            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                                hn <span class="token operator">=</span> lastRun<span class="token punctuation">;</span>
                                ln <span class="token operator">=</span> null<span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            <span class="token comment" spellcheck="true">// ä»å¤´åˆ°å°¾éå†é“¾è¡¨èŠ‚ç‚¹ï¼Œç›´åˆ°é‡åˆ°ä¸Šé¢æ‰¾åˆ°çš„è¿ç»­ç›¸åŒçš„èŠ‚ç‚¹çš„èµ·å§‹èŠ‚ç‚¹ï¼Œé¿å…äº†å¯¹é‚£æ®µçš„æ“ä½œï¼Œå› ä¸ºç›´æ¥æŠŠè¯¥æ®µçš„èµ·å§‹èŠ‚ç‚¹æ’åˆ°é“¾è¡¨å°¾å°±è¡Œäº†</span>
                            <span class="token comment" spellcheck="true">// è¿™ä¸ªä¼˜åŒ–çœŸæ˜¯ï¼Œå—¯ï¼Œæœ‰ç‚¹ç»†è‡´</span>
                            <span class="token keyword">for</span> <span class="token punctuation">(</span>ConcurrentHashMap<span class="token punctuation">.</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span> p <span class="token operator">=</span> f<span class="token punctuation">;</span> p <span class="token operator">!=</span> lastRun<span class="token punctuation">;</span> p <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">int</span> ph <span class="token operator">=</span> p<span class="token punctuation">.</span>hash<span class="token punctuation">;</span>
                                K pk <span class="token operator">=</span> p<span class="token punctuation">.</span>key<span class="token punctuation">;</span>
                                V pv <span class="token operator">=</span> p<span class="token punctuation">.</span>val<span class="token punctuation">;</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ph <span class="token operator">&amp;</span> n<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                                    <span class="token comment" spellcheck="true">// è¿™é‡Œé“¾è¡¨æ–¹å‘åè½¬äº†</span>
                                    ln <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap<span class="token punctuation">.</span>Node</span><span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span><span class="token punctuation">(</span>ph<span class="token punctuation">,</span> pk<span class="token punctuation">,</span> pv<span class="token punctuation">,</span> ln<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">else</span>
                                    hn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap<span class="token punctuation">.</span>Node</span><span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span><span class="token punctuation">(</span>ph<span class="token punctuation">,</span> pk<span class="token punctuation">,</span> pv<span class="token punctuation">,</span> hn<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            <span class="token comment" spellcheck="true">// é«˜ä½ä½ä¸¤æ¡é“¾è¡¨æ’å…¥æ–°æ•°ç»„</span>
                            <span class="token function">setTabAt</span><span class="token punctuation">(</span>nextTab<span class="token punctuation">,</span> i<span class="token punctuation">,</span> ln<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token function">setTabAt</span><span class="token punctuation">(</span>nextTab<span class="token punctuation">,</span> i <span class="token operator">+</span> n<span class="token punctuation">,</span> hn<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// åŸæ•°ç»„è¯¥ä½ç½®è®¾ä¸ºForwardingNodeï¼Œæ ‡è®°ä¸ºå·²å¤„ç†</span>
                            <span class="token function">setTabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i<span class="token punctuation">,</span> fwd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            advance <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment" spellcheck="true">// è¯´æ˜æ˜¯çº¢é»‘æ ‘èŠ‚ç‚¹</span>
                        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>f <span class="token keyword">instanceof</span> <span class="token class-name">ConcurrentHashMap<span class="token punctuation">.</span>TreeBin</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            ConcurrentHashMap<span class="token punctuation">.</span>TreeBin<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span> t <span class="token operator">=</span> <span class="token punctuation">(</span>ConcurrentHashMap<span class="token punctuation">.</span>TreeBin<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span><span class="token punctuation">)</span> f<span class="token punctuation">;</span>
                            ConcurrentHashMap<span class="token punctuation">.</span>TreeNode<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span> lo <span class="token operator">=</span> null<span class="token punctuation">,</span> loTail <span class="token operator">=</span> null<span class="token punctuation">;</span>
                            ConcurrentHashMap<span class="token punctuation">.</span>TreeNode<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span> hi <span class="token operator">=</span> null<span class="token punctuation">,</span> hiTail <span class="token operator">=</span> null<span class="token punctuation">;</span>
                            <span class="token keyword">int</span> lc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> hc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// å½“æˆé“¾è¡¨éå†</span>
                            <span class="token keyword">for</span> <span class="token punctuation">(</span>ConcurrentHashMap<span class="token punctuation">.</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span> e <span class="token operator">=</span> t<span class="token punctuation">.</span>first<span class="token punctuation">;</span> e <span class="token operator">!=</span> null<span class="token punctuation">;</span> e <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">int</span> h <span class="token operator">=</span> e<span class="token punctuation">.</span>hash<span class="token punctuation">;</span>
                                <span class="token comment" spellcheck="true">// åˆ›å»ºæ–°çš„çº¢é»‘æ ‘èŠ‚ç‚¹</span>
                                ConcurrentHashMap<span class="token punctuation">.</span>TreeNode<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap<span class="token punctuation">.</span>TreeNode</span><span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> e<span class="token punctuation">.</span>key<span class="token punctuation">,</span> e<span class="token punctuation">.</span>val<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token comment" spellcheck="true">// åˆ†å‰²ä¸ºé«˜ä½ä¸¤ä¸ªåŒå‘é“¾è¡¨</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>h <span class="token operator">&amp;</span> n<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    <span class="token comment" spellcheck="true">// ...</span>
                                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                                    <span class="token comment" spellcheck="true">// ...</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span>
                            <span class="token comment" spellcheck="true">// çº¢é»‘æ ‘é“¾è¡¨è¿‡çŸ­å°±è½¬ä¸ºæ™®é€šé“¾è¡¨ï¼Œå¦åˆ™åˆ›å»ºæ–°çš„çº¢é»‘æ ‘</span>
                            ln <span class="token operator">=</span> <span class="token punctuation">(</span>lc <span class="token operator">&lt;=</span> UNTREEIFY_THRESHOLD<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">untreeify</span><span class="token punctuation">(</span>lo<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span>hc <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap<span class="token punctuation">.</span>TreeBin</span><span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span><span class="token punctuation">(</span>lo<span class="token punctuation">)</span> <span class="token operator">:</span> t<span class="token punctuation">;</span>
                            hn <span class="token operator">=</span> <span class="token punctuation">(</span>hc <span class="token operator">&lt;=</span> UNTREEIFY_THRESHOLD<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">untreeify</span><span class="token punctuation">(</span>hi<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span>lc <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap<span class="token punctuation">.</span>TreeBin</span><span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span><span class="token punctuation">(</span>hi<span class="token punctuation">)</span> <span class="token operator">:</span> t<span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// æ’å…¥æ‰©å®¹åçš„æ–°æ•°ç»„</span>
                            <span class="token function">setTabAt</span><span class="token punctuation">(</span>nextTab<span class="token punctuation">,</span> i<span class="token punctuation">,</span> ln<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token function">setTabAt</span><span class="token punctuation">(</span>nextTab<span class="token punctuation">,</span> i <span class="token operator">+</span> n<span class="token punctuation">,</span> hn<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// åŸæ•°ç»„è¯¥ä½ç½®ç”¨ForwardingNodeæ ‡è®°</span>
                            <span class="token function">setTabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i<span class="token punctuation">,</span> fwd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            advance <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>ConcurrentHashMap#resizeStamp</p>
<pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">/**
     * è¿”å›å½“å‰æ•°ç»„çš„é•¿åº¦çš„äºŒè¿›åˆ¶å€¼ä¸­å¼€å¤´0çš„æ•°é‡
     */</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">resizeStamp</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Integer#numberOfLeadingZerosï¼šè®¡ç®—ä¸€ä¸ªIntegeré¦–éƒ¨çš„0çš„æ•°é‡</span>
        <span class="token comment" spellcheck="true">// 0000 0000 0000 0000 1000 0000 0000 0000</span>
        <span class="token comment" spellcheck="true">// 1æ˜¯ç¬¦å·ä½ï¼Œè¡¨ç¤ºè´Ÿæ•°ï¼Œç”¨äºåé¢çš„ä½ç§»æ“ä½œ</span>
        <span class="token comment" spellcheck="true">// å‡è®¾å½“å‰æ•°ç»„å®¹é‡ä¸º16ï¼Œé‚£ä¹ˆæ–¹æ³•è¿”å› 0000 0000 0000 0000 1000 0000 0001 0000</span>
        <span class="token keyword">return</span> Integer<span class="token punctuation">.</span><span class="token function">numberOfLeadingZeros</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>RESIZE_STAMP_BITS <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>ConcurrentHashMap#size</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> n <span class="token operator">=</span> <span class="token function">sumCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Mapå¤§å°æ˜¯æœ‰å¯èƒ½è¶…è¿‡Integer.MAX_VALUEçš„ï¼Œä½†æ˜¯å› ä¸ºæ–¹æ³•æ¥å£çš„é™åˆ¶ï¼Œæœ€å¤§åªèƒ½è¿”å›Integer.MAX_VALUE</span>
        <span class="token comment" spellcheck="true">// å¯ä»¥ç”¨ConcurrentHashMap#mappingCountæ›¿ä»£ï¼Œè¿”å›çš„æ˜¯Longç±»å‹</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>n <span class="token operator">&lt;</span> 0L<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token punctuation">(</span>n <span class="token operator">></span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> Integer<span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">)</span> <span class="token operator">?</span> Integer<span class="token punctuation">.</span>MAX_VALUE <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>ConcurrentHashMap#get</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> V <span class="token function">get</span><span class="token punctuation">(</span>Object key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ConcurrentHashMap<span class="token punctuation">.</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab<span class="token punctuation">;</span>
        ConcurrentHashMap<span class="token punctuation">.</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span> e<span class="token punctuation">,</span> p<span class="token punctuation">;</span>
        <span class="token keyword">int</span> n<span class="token punctuation">,</span> eh<span class="token punctuation">;</span>
        K ek<span class="token punctuation">;</span>
        <span class="token keyword">int</span> h <span class="token operator">=</span> <span class="token function">spread</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tab <span class="token operator">=</span> table<span class="token punctuation">)</span> <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>e <span class="token operator">=</span> <span class="token function">tabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> h<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// ç¬¬ä¸€ä¸ªå°±æ˜¯</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>eh <span class="token operator">=</span> e<span class="token punctuation">.</span>hash<span class="token punctuation">)</span> <span class="token operator">==</span> h<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ek <span class="token operator">=</span> e<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">||</span> <span class="token punctuation">(</span>ek <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>ek<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span> e<span class="token punctuation">.</span>val<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// ForwardingNodeæˆ–TreeBin</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>eh <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token punctuation">(</span>p <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null <span class="token operator">?</span> p<span class="token punctuation">.</span>val <span class="token operator">:</span> null<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å¦åˆ™éå†é“¾è¡¨</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash <span class="token operator">==</span> h <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ek <span class="token operator">=</span> e<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">||</span> <span class="token punctuation">(</span>ek <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>ek<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span> e<span class="token punctuation">.</span>val<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ConcurrentHashMap$ForwardingNode#find</p>
<pre class=" language-java"><code class="language-java">        <span class="token comment" spellcheck="true">/**
         * é‡å†™findæ–¹æ³•ï¼Œç”¨äºåœ¨æ‰©å®¹åçš„æ•°ç»„ä¸­æŸ¥æ‰¾
         */</span>
        ConcurrentHashMap<span class="token punctuation">.</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span> <span class="token function">find</span><span class="token punctuation">(</span><span class="token keyword">int</span> h<span class="token punctuation">,</span> Object k<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            outer<span class="token operator">:</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>ConcurrentHashMap<span class="token punctuation">.</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab <span class="token operator">=</span> nextTable<span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ConcurrentHashMap<span class="token punctuation">.</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span> e<span class="token punctuation">;</span>
                <span class="token keyword">int</span> n<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// æ‰©å®¹çš„æ–°æ•°ç»„çš„è¯¥å“ˆå¸Œçš„ä½ç½®çš„å…ƒç´ </span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">==</span> null <span class="token operator">||</span> tab <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span>e <span class="token operator">=</span> <span class="token function">tabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> h<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span>
                    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">int</span> eh<span class="token punctuation">;</span>
                    K ek<span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// åˆšå¥½æ‰¾åˆ°å°±ç›´æ¥è¿”å›</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>eh <span class="token operator">=</span> e<span class="token punctuation">.</span>hash<span class="token punctuation">)</span> <span class="token operator">==</span> h <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ek <span class="token operator">=</span> e<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> k <span class="token operator">||</span> <span class="token punctuation">(</span>ek <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> k<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>ek<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token keyword">return</span> e<span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// è¯´æ˜æ˜¯çº¢é»‘æ ‘TreeBinæˆ–ForwardingNode</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>eh <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// æ‰©å®¹ååˆå†æ¬¡æ‰©å®¹äº†</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">ConcurrentHashMap<span class="token punctuation">.</span>ForwardingNode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            tab <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ConcurrentHashMap<span class="token punctuation">.</span>ForwardingNode<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span><span class="token punctuation">)</span> e<span class="token punctuation">)</span><span class="token punctuation">.</span>nextTable<span class="token punctuation">;</span>
                            <span class="token keyword">continue</span> outer<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment" spellcheck="true">// ä»çº¢é»‘æ ‘æŸ¥æ‰¾</span>
                        <span class="token keyword">else</span>
                            <span class="token keyword">return</span> e<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// å¦åˆ™å‘åéå†é“¾è¡¨</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span>
                        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span></code></pre>
<p>ConcurrentHashMap$TreeBin#find</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">final</span> ConcurrentHashMap<span class="token punctuation">.</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span> <span class="token function">find</span><span class="token punctuation">(</span><span class="token keyword">int</span> h<span class="token punctuation">,</span> Object k<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>k <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>ConcurrentHashMap<span class="token punctuation">.</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span> e <span class="token operator">=</span> first<span class="token punctuation">;</span> e <span class="token operator">!=</span> null<span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">int</span> s<span class="token punctuation">;</span>
                    K ek<span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">/*
                     * å¦‚æœå½“å‰æ ‘æ˜¯ç­‰å¾…æˆ–è€…å†™çŠ¶æ€ï¼Œåˆ™æŠŠæ ‘å½“æˆé“¾è¡¨éå†æŸ¥æ‰¾
                     * å› ä¸ºå¦‚æœæœ‰çº¿ç¨‹åœ¨å†™çº¢é»‘æ ‘ï¼Œé“¾è¡¨çš„æŸ¥æ‰¾æ–¹å¼å¯ä»¥ç›´æ¥è¯»ï¼Œä¸ç”¨ç­‰çº¢é»‘æ ‘çš„å¹³è¡¡å®Œäº†æ‰äºŒåˆ†æŸ¥æ‰¾
                     * è€Œå¦‚æœæœ‰çº¿ç¨‹åœ¨ç­‰å¾…å†™ï¼Œé‚£ä¹ˆä¹Ÿä¸èƒ½ç”¨äºŒåˆ†æŸ¥æ‰¾ï¼Œå› ä¸ºäºŒåˆ†æœç´¢æ—¶ä¸èƒ½æ”¹å˜çº¢é»‘æ ‘çš„ç»“æ„ï¼Œä¸èƒ½å†™
                     * ä¸ªäººè§‰å¾—è¿™ä¸ªå¤„ç†éå¸¸å¥½ï¼Œè¯»å®Œå…¨ä¸ä¼šè¢«é˜»å¡
                     */</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>s <span class="token operator">=</span> lockState<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>WAITER <span class="token operator">|</span> WRITER<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash <span class="token operator">==</span> h <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ek <span class="token operator">=</span> e<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> k <span class="token operator">||</span> <span class="token punctuation">(</span>ek <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> k<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>ek<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token keyword">return</span> e<span class="token punctuation">;</span>
                        e <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// å¦åˆ™CASæ›´æ–°å½“å‰çŠ¶æ€ä¸ºè¯»ï¼ŒæˆåŠŸåˆ™é€šè¿‡äºŒå‰æ ‘æŸ¥æ‰¾</span>
                    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>U<span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> LOCKSTATE<span class="token punctuation">,</span> s<span class="token punctuation">,</span> s <span class="token operator">+</span> READER<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        ConcurrentHashMap<span class="token punctuation">.</span>TreeNode<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span> r<span class="token punctuation">,</span> p<span class="token punctuation">;</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{</span>
                            p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>r <span class="token operator">=</span> root<span class="token punctuation">)</span> <span class="token operator">==</span> null <span class="token operator">?</span> null <span class="token operator">:</span> r<span class="token punctuation">.</span><span class="token function">findTreeNode</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> k<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                            Thread w<span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// å¦‚æœæ ‘æ²¡æœ‰åˆ«çš„è¯»çº¿ç¨‹äº†ï¼Œå¹¶ä¸”å¤„äºç­‰å¾…çŠ¶æ€ï¼Œå¹¶ä¸”ç­‰å¾…çº¿ç¨‹ä¸ä¸ºç©ºï¼Œè¯´æ˜è¿˜è¦å”¤é†’ç­‰å¾…çš„å†™çº¿ç¨‹</span>
                            <span class="token comment" spellcheck="true">// å› ä¸ºå­˜åœ¨å¹¶å‘è¯»ï¼Œæ‰€ä»¥è¯»çº¿ç¨‹è¯»å®Œäº†è¿˜è¦æŠŠåŠ çš„å€¼å‡å›å»ï¼Œç±»ä¼¼é‡Šæ”¾è¯»é”</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>U<span class="token punctuation">.</span><span class="token function">getAndAddInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> LOCKSTATE<span class="token punctuation">,</span> <span class="token operator">-</span>READER<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span>READER <span class="token operator">|</span> WAITER<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>w <span class="token operator">=</span> waiter<span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span>
                                <span class="token comment" spellcheck="true">// æŸ¥æ‰¾å®Œæˆåˆ™å”¤é†’ç­‰å¾…çš„å†™çº¿ç¨‹ï¼Œå¯ä»¥å†™çº¢é»‘æ ‘äº†</span>
                                LockSupport<span class="token punctuation">.</span><span class="token function">unpark</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        <span class="token keyword">return</span> p<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<hr>
<p>åˆ é™¤æ“ä½œå’Œæ·»åŠ æ“ä½œåŸºæœ¬ç±»ä¼¼ã€‚</p>
<p>ConcurrentHashMap#replaceNode</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">final</span> V <span class="token function">replaceNode</span><span class="token punctuation">(</span>Object key<span class="token punctuation">,</span> V value<span class="token punctuation">,</span> Object cv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> hash <span class="token operator">=</span> <span class="token function">spread</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>ConcurrentHashMap<span class="token punctuation">.</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab <span class="token operator">=</span> table<span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ConcurrentHashMap<span class="token punctuation">.</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span> f<span class="token punctuation">;</span>
            <span class="token keyword">int</span> n<span class="token punctuation">,</span> i<span class="token punctuation">,</span> fh<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>tab <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span>f <span class="token operator">=</span> <span class="token function">tabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i <span class="token operator">=</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> hash<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fh <span class="token operator">=</span> f<span class="token punctuation">.</span>hash<span class="token punctuation">)</span> <span class="token operator">==</span> MOVED<span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// æ‰€ä»¥å¦‚æœè¦åˆ é™¤çš„å…ƒç´ åœ¨æ‰©å®¹åçš„æ–°æ•°ç»„ä¸­ï¼Œè¦ç­‰åˆ°æ‰©å®¹å®Œæˆåæ‰èƒ½åœ¨æ–°æ•°ç»„æŸ¥æ‰¾</span>
                tab <span class="token operator">=</span> <span class="token function">helpTransfer</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                V oldVal <span class="token operator">=</span> null<span class="token punctuation">;</span>
                <span class="token keyword">boolean</span> validated <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token operator">==</span> f<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// é“¾è¡¨èŠ‚ç‚¹</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>fh <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            validated <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// éå†é“¾è¡¨</span>
                            <span class="token keyword">for</span> <span class="token punctuation">(</span>ConcurrentHashMap<span class="token punctuation">.</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span> e <span class="token operator">=</span> f<span class="token punctuation">,</span> pred <span class="token operator">=</span> null<span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                K ek<span class="token punctuation">;</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash <span class="token operator">==</span> hash <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ek <span class="token operator">=</span> e<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">||</span> <span class="token punctuation">(</span>ek <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>ek<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    V ev <span class="token operator">=</span> e<span class="token punctuation">.</span>val<span class="token punctuation">;</span>
                                    <span class="token keyword">if</span> <span class="token punctuation">(</span>cv <span class="token operator">==</span> null <span class="token operator">||</span> cv <span class="token operator">==</span> ev <span class="token operator">||</span> <span class="token punctuation">(</span>ev <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> cv<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>ev<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                        oldVal <span class="token operator">=</span> ev<span class="token punctuation">;</span>
                                        <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">!=</span> null<span class="token punctuation">)</span>
                                            e<span class="token punctuation">.</span>val <span class="token operator">=</span> value<span class="token punctuation">;</span>
                                        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pred <span class="token operator">!=</span> null<span class="token punctuation">)</span>
                                            <span class="token comment" spellcheck="true">// åˆ é™¤</span>
                                            pred<span class="token punctuation">.</span>next <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
                                        <span class="token keyword">else</span>
                                            <span class="token comment" spellcheck="true">// åˆ é™¤çš„æ˜¯å¤´èŠ‚ç‚¹çš„è¯è¦é‡æ–°æ’å…¥æ•°ç»„</span>
                                            <span class="token function">setTabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i<span class="token punctuation">,</span> e<span class="token punctuation">.</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                    <span class="token punctuation">}</span>
                                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                                pred <span class="token operator">=</span> e<span class="token punctuation">;</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span>
                                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment" spellcheck="true">// çº¢é»‘æ ‘èŠ‚ç‚¹</span>
                        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>f <span class="token keyword">instanceof</span> <span class="token class-name">ConcurrentHashMap<span class="token punctuation">.</span>TreeBin</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            validated <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                            ConcurrentHashMap<span class="token punctuation">.</span>TreeBin<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span> t <span class="token operator">=</span> <span class="token punctuation">(</span>ConcurrentHashMap<span class="token punctuation">.</span>TreeBin<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span><span class="token punctuation">)</span> f<span class="token punctuation">;</span>
                            ConcurrentHashMap<span class="token punctuation">.</span>TreeNode<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span> r<span class="token punctuation">,</span> p<span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// æŸ¥æ‰¾ä¹Ÿæ˜¯å®Œå…¨æ— é”çš„</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>r <span class="token operator">=</span> t<span class="token punctuation">.</span>root<span class="token punctuation">)</span> <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>p <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">findTreeNode</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                V pv <span class="token operator">=</span> p<span class="token punctuation">.</span>val<span class="token punctuation">;</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>cv <span class="token operator">==</span> null <span class="token operator">||</span> cv <span class="token operator">==</span> pv <span class="token operator">||</span> <span class="token punctuation">(</span>pv <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> cv<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>pv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    oldVal <span class="token operator">=</span> pv<span class="token punctuation">;</span>
                                    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">!=</span> null<span class="token punctuation">)</span>
                                        p<span class="token punctuation">.</span>val <span class="token operator">=</span> value<span class="token punctuation">;</span>
                                    <span class="token comment" spellcheck="true">// è¿™é‡Œåˆ é™¤æ‰ä¼šç«äº‰çº¢é»‘æ ‘çš„é”</span>
                                    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">removeTreeNode</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span>
                                        <span class="token function">setTabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token function">untreeify</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>first<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>validated<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldVal <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> null<span class="token punctuation">)</span>
                            <span class="token function">addCount</span><span class="token punctuation">(</span><span class="token operator">-</span>1L<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> oldVal<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>è¿­ä»£æ“ä½œå…³é”®ä»£ç ï¼š</p>
<p>ConcurrentHashMap$Traverser#advance</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">final</span> ConcurrentHashMap<span class="token punctuation">.</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span> <span class="token function">advance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ConcurrentHashMap<span class="token punctuation">.</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span> e<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// HashMapçš„çº¢é»‘æ ‘åŒæ—¶ä¹Ÿæ˜¯é“¾è¡¨ï¼Œæ‰€ä»¥çº¢é»‘æ ‘æˆ–é“¾è¡¨éƒ½å½“æˆé“¾è¡¨éå†ï¼Œç›´åˆ°é“¾è¡¨å°¾</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> next<span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span>
                e <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ConcurrentHashMap<span class="token punctuation">.</span>Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> t<span class="token punctuation">;</span>
                <span class="token keyword">int</span> i<span class="token punctuation">,</span> n<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// æœ‰ä¸‹ä¸€ä½ç›´æ¥è¿”å›å°±å¥½</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> null<span class="token punctuation">)</span>
                    <span class="token keyword">return</span> next <span class="token operator">=</span> e<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å·²ç»æ²¡äº†</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>baseIndex <span class="token operator">>=</span> baseLimit <span class="token operator">||</span> <span class="token punctuation">(</span>t <span class="token operator">=</span> tab<span class="token punctuation">)</span> <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> t<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> index<span class="token punctuation">)</span> <span class="token operator">||</span> i <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span> next <span class="token operator">=</span> null<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// æ•°ç»„è¯¥ä½ç½®ä¸æ˜¯æ™®é€šé“¾è¡¨</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> <span class="token function">tabAt</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> e<span class="token punctuation">.</span>hash <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ForwardingNode</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">ConcurrentHashMap<span class="token punctuation">.</span>ForwardingNode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// ä»æ‰©å®¹çš„æ–°æ•°ç»„æŸ¥æ‰¾</span>
                        tab <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ConcurrentHashMap<span class="token punctuation">.</span>ForwardingNode<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span><span class="token punctuation">)</span> e<span class="token punctuation">)</span><span class="token punctuation">.</span>nextTable<span class="token punctuation">;</span>
                        e <span class="token operator">=</span> null<span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// å…¥æ ˆï¼Œä¿å­˜çŠ¶æ€ï¼Œå› ä¸ºæ–°æ•°ç»„æŸ¥æ‰¾å®Œä¹‹åè¿˜è¦ä»åŸæœ¬çš„æ•°ç»„ç»§ç»­æŸ¥æ‰¾</span>
                        <span class="token function">pushState</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> i<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// ä¸‹ä¸ªå¾ªç¯ç»§ç»­</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> 
                    <span class="token comment" spellcheck="true">// çº¢é»‘æ ‘</span>
                    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">ConcurrentHashMap<span class="token punctuation">.</span>TreeBin</span><span class="token punctuation">)</span>
                        <span class="token comment" spellcheck="true">// çº¢é»‘æ ‘å½“æˆé“¾è¡¨ç”¨ï¼Œä»é“¾è¡¨å¤´å¼€å§‹</span>
                        e <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ConcurrentHashMap<span class="token punctuation">.</span>TreeBin<span class="token operator">&lt;</span>K<span class="token punctuation">,</span> V<span class="token operator">></span><span class="token punctuation">)</span> e<span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">;</span>
                    <span class="token keyword">else</span>
                        e <span class="token operator">=</span> null<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>stack <span class="token operator">!=</span> null<span class="token punctuation">)</span>
                    <span class="token function">recoverState</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>index <span class="token operator">=</span> i <span class="token operator">+</span> baseSize<span class="token punctuation">)</span> <span class="token operator">>=</span> n<span class="token punctuation">)</span>
                    index <span class="token operator">=</span> <span class="token operator">++</span>baseIndex<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span></code></pre>
<hr>
<p>æ€»çš„æ¥è¯´ï¼ŒConcurrentHashMapè®¾è®¡å¾—ååˆ†ç²¾ç»†ï¼Œå°±æ˜¯ä¸æ˜ç™½ä¸ºä»€ä¹ˆå¹¶å‘åŒ…å¾ˆå¤šæ— é”ç®—æ³•è¦ç®€å†™åœ°é‚£ä¹ˆå‰å®³ï¼Œè®©é˜…è¯»è€…çœ‹å¾—æœ‰ç‚¹ç´¯ï¼Œè€Œä¸”çœä¸‹æ¥çš„é‚£å‡ ä¸ªå­—å¯ä»¥æé«˜æ€§èƒ½ä¹ˆã€‚ã€‚ã€‚@Doug Leaï¼Œå¿«å‡ºæ¥è§£é‡Šä¸€ä¸‹å•Šã€‚</p>
<p>å­ï¼Œç®€å•è¯´ä¸€ä¸‹ConcurrentHashMapè®©æˆ‘è€³ç›®ä¸€æ–°çš„åœ°æ–¹ï¼š</p>
<p>é™¤äº†å°‘éƒ¨åˆ†åœ°æ–¹ä½¿ç”¨äº†synchronizedå¤–ï¼Œå…¶å®ƒå¤§éƒ¨åˆ†åœ°æ–¹éƒ½æ˜¯ç”¨è‡ªæ—‹+CAS+volatile+DCLæ¨¡æ‹Ÿçš„è½»é‡çº§é”ï¼›</p>
<p>synchronizedåªä¼šé”ä½ä¸€ä¸ªèŠ‚ç‚¹ï¼Œç¼©å°äº†é”çš„èŒƒå›´ï¼Œè€Œå…¶å®ƒåœ°æ–¹å¤§é‡ä½¿ç”¨çš„CASå…¶å®ä¹Ÿæ˜¯ä¸€ä¸ªé“ç†ï¼Œå„å¸å…¶èŒï¼Œç»†åŒ–äº†èŒƒå›´ï¼Œè€Œä¸æ˜¯ç›´æ¥åŠ ä¸€ä¸ªå¤§é”ï¼›</p>
<p>åœ¨è®¡ç®—å…ƒç´ æ•°é‡çš„æ—¶å€™ï¼Œé¿å…å¤šä¸ªçº¿ç¨‹å¯¹baseCountçš„é›†ä¸­ç«äº‰ä¿®æ”¹ï¼Œè€Œæ˜¯å°è¯•åˆ†æ•£åˆ°å¤šä¸ªCounterCellä¸­ï¼Œæœ€åè®¡ç®—çš„æ—¶å€™å åŠ èµ·æ¥å°±è¡Œäº†ï¼Œè™½ç„¶å¯èƒ½ä¸å‡†ç¡®ï¼›</p>
<p>è¿˜ä½¿ç”¨äº†@sun.misc.Contendedæ³¨è§£é¿å…ä¼ªå…±äº«ï¼Œæ¶‰åŠæ“ä½œç³»ç»Ÿåº•å±‚çš„ä¸œè¥¿æˆ‘ä¹Ÿä¸äº†è§£ï¼Œå¤§æ¦‚å°±æ˜¯é‚£ä¸ªæ„æ€ï¼›</p>
<p>å¯¹äºæ‰©å®¹ï¼Œå°†åŸæ•°ç»„çš„å…ƒç´ åˆ’åˆ†ä¸ºå¤šæ‰¹ä»»åŠ¡ï¼Œåˆ†é…ç»™å¤šä¸ªå†™çº¿ç¨‹å¹¶å‘è¿›è¡Œï¼ŒåŸæœ¬å› ä¸ºç«äº‰è€Œé˜»å¡çš„çº¿ç¨‹è¿˜å¯ä»¥å‚ä¸å¤šçº¿ç¨‹æ‰©å®¹ï¼Œè¿™ä¸ªæƒ³æ³•ï¼Œåªèƒ½è¯´ï¼Œwowï¼›</p>
<p>å¯¹äºè¯»ï¼Œå®Œå…¨æ˜¯æ— é˜»å¡çš„ï¼Œå³ä½¿å­˜åœ¨å¹¶å‘çš„ä¿®æ”¹æˆ–æ‰©å®¹ï¼Œå¯¹äºé“¾è¡¨ï¼Œå› ä¸ºä½¿ç”¨äº†volatileä¿®é¥°ï¼Œä¿®æ”¹æ˜¯ç«‹å³å¯è§çš„ï¼Œå¯¹äºä¸€æ£µçº¢é»‘æ ‘ï¼Œå‡å¦‚æœ‰ä¿®æ”¹çš„çº¿ç¨‹ï¼Œé‚£å°±é€€åŒ–ä¸ºç”¨é“¾è¡¨çš„æ–¹å¼éå†æŸ¥æ‰¾ï¼Œå› ä¸ºäºŒå‰æ ‘çš„æœç´¢æ–¹å¼è¦æ±‚ç»“æ„ç¨³å®šï¼Œå¦‚æœæ²¡æœ‰ä¿®æ”¹çº¿ç¨‹å­˜åœ¨ï¼Œé‚£å°±ä½¿ç”¨æ›´é«˜æ•ˆçš„çº¢é»‘æ ‘æŸ¥æ‰¾ã€‚è€Œå‡å¦‚æœç´¢çš„ä½ç½®åˆšå¥½å› ä¸ºæ‰©å®¹è¢«æ¬èµ°äº†ï¼Œåˆ™é‡å®šå‘åˆ°æ‰©å®¹åçš„æ–°æ•°ç»„æŸ¥æ‰¾ï¼Œå®Œå…¨æ— é˜»å¡ï¼›</p>
<p>å†™å’Œæ‰©å®¹æ˜¯å¯èƒ½ä¼šæœ‰é”ç«äº‰çš„ï¼Œä¸è¿‡èŒƒå›´ç¼©å°åˆ°äº†èŠ‚ç‚¹ï¼Œä¸ºäº†é¿å…æ‰©å®¹æ—¶å¤åˆ¶éå†åˆ°æ–°æ•°ç»„çš„è¿‡ç¨‹ä¸­ï¼Œåˆ é™¤æˆ–æ’å…¥äº†æ–°çš„èŠ‚ç‚¹ï¼Œè€Œæ‰©å®¹åçš„æ–°æ•°ç»„ä¸­ï¼Œå·²ç»åˆ é™¤çš„èŠ‚ç‚¹è¿˜å­˜åœ¨ï¼Œæ’å…¥çš„èŠ‚ç‚¹å´ä¸¢å¤±è¿™ç§æƒ…å†µï¼›</p>
<p>å¦å¤–å†™çº¿ç¨‹æ˜¯å¯èƒ½è¢«é˜»å¡æŒ‚èµ·çš„ï¼Œä¸å¤šè¯´äº†ï¼Œè‡ªå·±çœ‹ä»£ç å§ã€‚</p>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


        <footer>
             
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

        </footer>
    </div>
    <!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
    <script>
        var timeEnd = new Date();
        console.log('è€—æ—¶ï¼š' + (timeEnd - timeStart));
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre').forEach((block) => {
                block.classList.add("line-numbers");
            });
        });
    </script>
    <!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
    <!-- material design -->
    <!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
    <!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
    <!-- toc -->
    <!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
    <!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
    <!-- <script src="/js/main.js"></script> -->
    <script src="/js/prism.js"></script>
</body>
</html>
