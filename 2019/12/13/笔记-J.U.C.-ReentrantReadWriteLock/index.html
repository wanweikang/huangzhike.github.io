<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
        <script>
            var timeStart = new Date();
        </script>
        
        <title>[ç¬”è®°]-J.U.C.-ReentrantReadWriteLock | ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜</title>
        
        <meta name="author" content="huangzhike">
        
        
        <meta name="description" content="ReentrantReadWriteLockå’ŒReentrantLockæŒºåƒçš„ï¼Œä½†æ˜¯å¤šäº†ä¸€ä¸ªè¯»é”ï¼Œå³å…±äº«é”çš„å¤„ç†ï¼Œè¿™é‡Œç•¥è¿‡ç‹¬å é”çš„AQSé‡å¤éƒ¨åˆ†ã€‚

ReentrantReadWriteLock
public class ReentrantReadWriteLock implements ReadW">
        
        
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        
        <meta property="og:title" content="[ç¬”è®°]-J.U.C.-ReentrantReadWriteLock"/>
        
        <meta property="og:site_name" content="ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜"/>
        
        
        <!-- favicon -->
        <link rel="icon" type="image/ico" href="/ok.ico" sizes="32x32">
        <meta name="msapplication-TileColor" content="#009688">
        <meta name="msapplication-TileImage" content="/mstile-144x144.ico">
        <meta name="theme-color" content="#009688">
        <!-- favicon end -->
        <!-- <link href="//ok.ico" rel="icon"> -->
        
        <!-- toc -->
        <!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
        <!-- material design -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
        <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
        
        <!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
        <!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
    <meta name="generator" content="Hexo 4.2.1"></head>

<body>
    <nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">èœå•</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" title="ä¸‹ä¸€å¥æ˜¯ï¼šå®¢æœ‰å¯äººæœŸä¸æ¥ã€‚å°æ—¶å€™ï¼Œå–œæ¬¢é åœ¨é˜³å°ä¸Šï¼Œä¸€è¾¹å¹é£ï¼Œä¸€è¾¹çœ‹ä¹¦ï¼Œå–œæ¬¢è¯»ä¹¦å—ï¼Œéªšå¹´ï¼Ÿ" href="/">ä¹¦å½“å¿«æ„è¯»æ˜“å°½</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" target="_blank" rel="noopener" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

    <div class="container" >
        <div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[ç¬”è®°]-J.U.C.-ReentrantReadWriteLock</h2>
				
				<div>
					<div class="post-time">2019-12-13</div>
				</div>
				
				<div class="article-content">
				<p>ReentrantReadWriteLockå’ŒReentrantLockæŒºåƒçš„ï¼Œä½†æ˜¯å¤šäº†ä¸€ä¸ªè¯»é”ï¼Œå³å…±äº«é”çš„å¤„ç†ï¼Œè¿™é‡Œç•¥è¿‡ç‹¬å é”çš„AQSé‡å¤éƒ¨åˆ†ã€‚</p>
<hr>
<p>ReentrantReadWriteLock</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReentrantReadWriteLock</span> <span class="token keyword">implements</span> <span class="token class-name">ReadWriteLock</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> ReentrantReadWriteLock<span class="token punctuation">.</span>ReadLock readerLock<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> ReentrantReadWriteLock<span class="token punctuation">.</span>WriteLock writerLock<span class="token punctuation">;</span>

    <span class="token keyword">final</span> Sync sync<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">ReentrantReadWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// é»˜è®¤éå…¬å¹³</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">ReentrantReadWriteLock</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> fair<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sync <span class="token operator">=</span> fair <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">FairSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">NonfairSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        readerLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReadLock</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        writerLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WriteLock</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span></code></pre>
<p>ReentrantReadWriteLock$Sync</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">abstract</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Sync</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractQueuedSynchronizer</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">/**
         * è¯»å†™é”ï¼Œé«˜16ä½è¡¨ç¤ºè¯»çŠ¶æ€ï¼Œä½16ä½è¡¨ç¤ºå†™çŠ¶æ€
         * å†™é”ï¼Œç‹¬å é”ï¼Œä½16ä½è¡¨ç¤ºå†™é”çš„é‡å…¥æ¬¡æ•°
         * è¯»é”ï¼Œå…±äº«é”ï¼Œå¯ä»¥åŒæ—¶è¢«å¤šä¸ªçº¿ç¨‹æŒæœ‰ï¼Œé«˜16ä½è¡¨ç¤ºè¯»é”è¢«è·å–çš„æ¬¡æ•°ï¼ŒåŒ…å«äº†é‡å…¥ï¼Œè€Œæ¯ä¸ªçº¿ç¨‹çš„é‡å…¥æ¬¡æ•°ä¿å­˜åœ¨ThreadLocal
         */</span>
        <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SHARED_SHIFT <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * è¯»çŠ¶æ€ = state >>> 16
         * è¯»çŠ¶æ€ + 1 = state + (1 &lt;&lt; 16)
         */</span>
        <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SHARED_UNIT <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> SHARED_SHIFT<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * æœ€å¤§é‡å…¥æ¬¡æ•°ï¼Œ2^16 - 1
         */</span>
        <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MAX_COUNT <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> SHARED_SHIFT<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * å†™çŠ¶æ€æ©ç 
         * å†™çŠ¶æ€ = state &amp; 0x0000FFFF
         * å†™çŠ¶æ€ + 1 = state + 1
         */</span>
        <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> EXCLUSIVE_MASK <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> SHARED_SHIFT<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>

        <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">HoldCounter</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">/**
             * å½“å‰çº¿ç¨‹è¯»é”çš„é‡å…¥æ¬¡æ•°
             */</span>
            <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// Use id, not reference, to avoid garbage retention</span>
            <span class="token comment" spellcheck="true">// ä½¿ç”¨çº¿ç¨‹Idï¼Œè€Œä¸æ˜¯Threadçš„å¼•ç”¨åˆ¤æ–­ï¼Œé¿å…HoldCounterå’ŒThreadç›¸äº’å¼•ç”¨</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> tid <span class="token operator">=</span> <span class="token function">getThreadId</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">/**
         * ThreadLocal
         */</span>
        <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ThreadLocalHoldCounter</span> <span class="token keyword">extends</span> <span class="token class-name">ThreadLocal</span><span class="token operator">&lt;</span>HoldCounter<span class="token operator">></span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> HoldCounter <span class="token function">initialValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HoldCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">/**
         * ThreadLocalï¼Œæ¯ä¸ªçº¿ç¨‹ä¸€ä»½ï¼Œä¿å­˜è¯¥çº¿ç¨‹è¯»é”çš„é‡å…¥æ¬¡æ•°
         */</span>
        <span class="token keyword">private</span> <span class="token keyword">transient</span> ThreadLocalHoldCounter readHolds<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * ç¼“å­˜ä¸Šä¸€ä¸ªè·å–è¯»é”çš„çº¿ç¨‹é‡å…¥æ¬¡æ•°ï¼Œå‡å°‘ThreadLocal#get
         * æ¯”å¦‚æŸçº¿ç¨‹è·å–è¯»é”ï¼Œå†é‡Šæ”¾è¯»é”ï¼Œå¦‚æœæ­¤æœŸé—´æ²¡æœ‰åˆ«çš„çº¿ç¨‹è·å–è¯»é”ï¼Œå°±å¯ä»¥ä½¿ç”¨ç¼“å­˜
         */</span>
        <span class="token keyword">private</span> <span class="token keyword">transient</span> HoldCounter cachedHoldCounter<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * ç¬¬ä¸€ä¸ªè·å–è¯»é”çš„çº¿ç¨‹
         * å³ï¼Œè·å–è¯»é”æ—¶è¯»é”ä¸ºç©ºé—²çŠ¶æ€ï¼Œè¿˜æ²¡è¢«è·å–çš„é‚£ä¸ªçº¿ç¨‹
         */</span>
        <span class="token keyword">private</span> <span class="token keyword">transient</span> Thread firstReader <span class="token operator">=</span> null<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/**
         * ç¬¬ä¸€ä¸ªè·å–è¯»é”çš„çº¿ç¨‹çš„è¯»é”é‡å…¥æ¬¡æ•°
         * å¯ä»¥æŠŠfirstReaderHoldCountå½“æˆä¸€çº§ç¼“å­˜ï¼ŒcachedHoldCounterå½“æˆäºŒçº§ç¼“å­˜ï¼ŒreadHoldså½“æˆä¸‰çº§ç¼“å­˜
         */</span>
        <span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token keyword">int</span> firstReaderHoldCount<span class="token punctuation">;</span>

        <span class="token function">Sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            readHolds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocalHoldCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ä¿è¯å¯è§æ€§ï¼Œstateæ˜¯volatileå˜é‡ï¼Œé¿å…é‡æ’åº</span>
            <span class="token function">setState</span><span class="token punctuation">(</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ensures visibility of readHolds</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>ReentrantReadWriteLock$NonfairSync</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">NonfairSync</span> <span class="token keyword">extends</span> <span class="token class-name">Sync</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span></code></pre>
<p>ReentrantReadWriteLock$FairSync</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">FairSync</span> <span class="token keyword">extends</span> <span class="token class-name">Sync</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span></code></pre>
<p>ReentrantReadWriteLock$ReadLock</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ReadLock</span> <span class="token keyword">implements</span> <span class="token class-name">Lock</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> Sync sync<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ReentrantReadWriteLock$WriteLock</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">WriteLock</span> <span class="token keyword">implements</span> <span class="token class-name">Lock</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">final</span> Sync sync<span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>ReentrantReadWriteLock$ReadLock#lock</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sync<span class="token punctuation">.</span><span class="token function">acquireShared</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>AbstractQueuedSynchronizer#acquireShared</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">acquireShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// å…ˆå°è¯•è·å–å…±äº«é”ï¼Œå¦‚æœè·å–å¤±è´¥ï¼Œåˆ™è¿›å…¥AQSé˜Ÿåˆ—é˜»å¡ç­‰å¾…</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tryAcquireShared</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token function">doAcquireShared</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ReentrantReadWriteLock$Sync#tryAcquireShared</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">tryAcquireShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> unused<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Thread current <span class="token operator">=</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å†™é”è¢«æŒæœ‰ &amp;&amp; æŒæœ‰è¯¥é”çš„çº¿ç¨‹ä¸æ˜¯å½“å‰çº¿ç¨‹ï¼Œé‚£ä¹ˆè·å–è¯»é”å¤±è´¥</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">exclusiveCount</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">getExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> current<span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™é‡Œå…è®¸å†™é”ä¸é‡Šæ”¾ï¼Œç›´æ¥é™çº§ä¸ºè¯»é”</span>

            <span class="token comment" spellcheck="true">// è¯»é”è¢«è·å–çš„æ¬¡æ•°</span>
            <span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token function">sharedCount</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">/*
             * è¿™é‡Œè¯»é”éœ€ä¸éœ€è¦é˜»å¡ï¼Œæ˜¯æ ¹æ®å…¬å¹³ç­–ç•¥å†³å®šçš„
             * å¯¹äºéå…¬å¹³ï¼Œåªè¦AQSé˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªç­‰å¾…çš„èŠ‚ç‚¹ä¸æ˜¯åœ¨ç­‰å¾…è·å–ç‹¬å é”ï¼Œé‚£å°±ä¸ç”¨é˜»å¡ï¼Œå› ä¸ºå†™é”æ˜¯ä¼˜å…ˆçš„ï¼Œä¸èƒ½è¢«è¯»é”é˜»å¡
             * è€Œå…¬å¹³çš„è¯ï¼Œåªè¦å­˜åœ¨é˜Ÿåˆ—å­˜åœ¨ç­‰å¾…çš„èŠ‚ç‚¹ï¼Œå°±è¦æ’é˜Ÿ
             */</span>
            <span class="token comment" spellcheck="true">// ä¸éœ€è¦é˜»å¡ç­‰å¾… &amp;&amp; è¯»é”è·å–çš„çº¿ç¨‹æ•°æ²¡è¶…å‡ºæœ€å¤§é™åˆ¶ &amp;&amp; CASæ›´æ–°è¯»é”çš„çº¿ç¨‹æ•°æˆåŠŸ</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">readerShouldBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> r <span class="token operator">&lt;</span> MAX_COUNT <span class="token operator">&amp;&amp;</span> <span class="token function">compareAndSetState</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> c <span class="token operator">+</span> SHARED_UNIT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å¦‚æœè¯»é”ç©ºé—²</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å½“å‰çº¿ç¨‹å°±æ˜¯ç¬¬ä¸€ä¸ªè·å–è¯»é”çš„çº¿ç¨‹</span>
                    firstReader <span class="token operator">=</span> current<span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// é‡å…¥æ¬¡æ•°ä¸º1</span>
                    firstReaderHoldCount <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// å¦‚æœå·²ç»æœ‰çº¿ç¨‹è·å–è¯»é”äº†ï¼Œå¹¶ä¸”æ˜¯ç¬¬ä¸€ä¸ªè·å–è¯»é”çš„çº¿ç¨‹é‡å…¥</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>firstReader <span class="token operator">==</span> current<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// è¯»é”é‡å…¥æ¬¡æ•°è‡ªå¢</span>
                    firstReaderHoldCount<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// ä¸æ˜¯ç¬¬ä¸€ä¸ªè·å–è¯»é”çš„çº¿ç¨‹ï¼Œå¯èƒ½æ˜¯é‡å…¥ï¼Œä¹Ÿå¯èƒ½æ˜¯ç¬¬ä¸€æ¬¡è·å–è¯»é”</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    HoldCounter rh <span class="token operator">=</span> cachedHoldCounter<span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// çº¿ç¨‹é‡å…¥ç¼“å­˜è¿˜æœªåˆå§‹åŒ– || ç¼“å­˜çš„ä¸æ˜¯å½“å‰çº¿ç¨‹ï¼Œè¿™é‡Œæ˜¯æ ¹æ®çº¿ç¨‹Idåˆ¤æ–­çš„</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>rh <span class="token operator">==</span> null <span class="token operator">||</span> rh<span class="token punctuation">.</span>tid <span class="token operator">!=</span> <span class="token function">getThreadId</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token comment" spellcheck="true">// æä¸€ä¸ª</span>
                        cachedHoldCounter <span class="token operator">=</span> rh <span class="token operator">=</span> readHolds<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// è¯´æ˜æ˜¯é‡å…¥ï¼Œå¹¶ä¸”ç¼“å­˜å‘½ä¸­ï¼Œä½†æ˜¯é‡å…¥æ¬¡æ•°ä¸º0ï¼Œè¿™ä¸ªæ˜¯æ€ä¹ˆå‘ç”Ÿçš„ï¼Ÿ</span>
                    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rh<span class="token punctuation">.</span>count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                        readHolds<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>rh<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// è¯»é”é‡å…¥æ¬¡æ•°è‡ªå¢</span>
                    rh<span class="token punctuation">.</span>count<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// è·å–è¯»é”æˆåŠŸ</span>
                <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// è¿™é‡Œæ˜¯ç»™ä¸ç”¨é˜»å¡ç­‰å¾…è¯»é”ï¼Œä½†æ˜¯å› ä¸ºåˆ«çš„çº¿ç¨‹ç«äº‰è¯»é”å¯¼è‡´CASå¤±è´¥çš„æƒ…å†µç”¨çš„ï¼Œä¸è¦ç›´æ¥è¿›å…¥AQSé˜Ÿåˆ—é˜»å¡ï¼Œè€Œæ˜¯è‡ªæ—‹é‡è¯•</span>
            <span class="token keyword">return</span> <span class="token function">fullTryAcquireShared</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>ReentrantReadWriteLock$Sync#fullTryAcquireShared</p>
<pre class=" language-java"><code class="language-java">        <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">fullTryAcquireShared</span><span class="token punctuation">(</span>Thread current<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            HoldCounter rh <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// æ¯æ¬¡è‡ªæ—‹å…ˆæ£€æŸ¥ï¼Œå¦‚æœå†™é”ä¸ç©ºé—²</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">exclusiveCount</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// æŒæœ‰å†™é”çš„ä¸æ˜¯å½“å‰çº¿ç¨‹</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> current<span class="token punctuation">)</span>
                        <span class="token comment" spellcheck="true">// è·å–å¤±è´¥</span>
                        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// å†™é”ç©ºé—²ï¼Œä½†æ˜¯æ ¹æ®å…¬å¹³ç­–ç•¥ï¼Œéœ€è¦é˜»å¡ç­‰å¾…å†™é”</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">readerShouldBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>firstReader <span class="token operator">==</span> current<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// assert firstReaderHoldCount > 0;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// å¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯æœ€æ—©è·å–è¯»é”çš„çº¿ç¨‹</span>
                    <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>rh <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// ç¼“å­˜çš„ä¸Šä¸€ä¸ªè·å–è¯»é”çš„çº¿ç¨‹çš„é‡å…¥è®¡æ•°</span>
                            rh <span class="token operator">=</span> cachedHoldCounter<span class="token punctuation">;</span>
                            <span class="token comment" spellcheck="true">// çº¿ç¨‹é‡å…¥ç¼“å­˜è¿˜æœªåˆå§‹åŒ– || ç¼“å­˜çš„ä¸æ˜¯å½“å‰çº¿ç¨‹</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>rh <span class="token operator">==</span> null <span class="token operator">||</span> rh<span class="token punctuation">.</span>tid <span class="token operator">!=</span> <span class="token function">getThreadId</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token comment" spellcheck="true">// ä»ThreadLocalä¸­è·å–å½“å‰çº¿ç¨‹çš„è¯»é”é‡å…¥è®¡æ•°</span>
                                rh <span class="token operator">=</span> readHolds<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token comment" spellcheck="true">// è¯´æ˜æ˜¯åˆšæ‰ThreadLocalHoldCounter#getçš„æ—¶å€™åˆå§‹åŒ–çš„</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>rh<span class="token punctuation">.</span>count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                                    <span class="token comment" spellcheck="true">// åˆ äº†</span>
                                    readHolds<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                        <span class="token comment" spellcheck="true">// è¯´æ˜ä¸æ˜¯é‡å…¥ï¼Œè·å–é”å¤±è´¥ï¼Œè¿”å›åè¿›å…¥AQSé˜Ÿåˆ—é˜»å¡æ’é˜Ÿ</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>rh<span class="token punctuation">.</span>count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// æ‰€ä»¥è¿™é‡Œæ˜¯å¤„ç†è¯»é”é‡å…¥çš„ï¼Œè™½ç„¶æ­¤æ—¶åº”è¯¥é˜»å¡æ’é˜Ÿï¼Œä½†æ˜¯å·²ç»è·å–è¯»é”çš„çº¿ç¨‹æ˜¯å…è®¸é‡å…¥çš„</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// å¦‚æœè¯»é”çš„è·å–æ¬¡æ•°æº¢å‡ºï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sharedCount</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">==</span> MAX_COUNT<span class="token punctuation">)</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"Maximum lock count exceeded"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å¦‚æœCASæ›´æ–°è¯»é”çš„çº¿ç¨‹æ•°æˆåŠŸ</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> c <span class="token operator">+</span> SHARED_UNIT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å¦‚æœè¯»é”ç©ºé—²</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sharedCount</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// å½“å‰çº¿ç¨‹å°±æ˜¯ç¬¬ä¸€ä¸ªè·å–è¯»é”çš„çº¿ç¨‹</span>
                        firstReader <span class="token operator">=</span> current<span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// é‡å…¥æ¬¡æ•°ä¸º1</span>
                        firstReaderHoldCount <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// å¦‚æœå·²ç»æœ‰çº¿ç¨‹è·å–è¯»é”äº†ï¼Œå¹¶ä¸”æ˜¯ç¬¬ä¸€ä¸ªè·å–è¯»é”çš„çº¿ç¨‹é‡å…¥</span>
                    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>firstReader <span class="token operator">==</span> current<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// è¯¥çº¿ç¨‹çš„è¯»é”é‡å…¥æ¬¡æ•°è‡ªå¢</span>
                        firstReaderHoldCount<span class="token operator">++</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// ä¸æ˜¯ç¬¬ä¸€ä¸ªè·å–è¯»é”çš„çº¿ç¨‹ï¼Œå¯èƒ½æ˜¯é‡å…¥ï¼Œä¹Ÿå¯èƒ½æ˜¯ç¬¬ä¸€æ¬¡è·å–è¯»é”</span>
                    <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>rh <span class="token operator">==</span> null<span class="token punctuation">)</span>
                            rh <span class="token operator">=</span> cachedHoldCounter<span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>rh <span class="token operator">==</span> null <span class="token operator">||</span> rh<span class="token punctuation">.</span>tid <span class="token operator">!=</span> <span class="token function">getThreadId</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">)</span>
                            rh <span class="token operator">=</span> readHolds<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rh<span class="token punctuation">.</span>count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                            readHolds<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>rh<span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token comment" spellcheck="true">// è¯¥çº¿ç¨‹çš„è¯»é”é‡å…¥æ¬¡æ•°è‡ªå¢</span>
                        rh<span class="token punctuation">.</span>count<span class="token operator">++</span><span class="token punctuation">;</span>
                        cachedHoldCounter <span class="token operator">=</span> rh<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// cache for release</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment" spellcheck="true">// è·å–è¯»é”æˆåŠŸ</span>
                    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span></code></pre>
<p>AbstractQueuedSynchronizer#doAcquireShared</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doAcquireShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// æ·»åŠ åˆ°AQSé˜Ÿåˆ—å°¾ï¼ŒèŠ‚ç‚¹ç±»å‹ä¸ºå…±äº«</span>
        <span class="token keyword">final</span> Node node <span class="token operator">=</span> <span class="token function">addWaiter</span><span class="token punctuation">(</span>Node<span class="token punctuation">.</span>SHARED<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">boolean</span> failed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">boolean</span> interrupted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è‡ªæ—‹</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> Node p <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">predecessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// èŠ‚ç‚¹å°±æ˜¯ç¬¬ä¸€ä¸ªæ’é˜Ÿç­‰å¾…çš„èŠ‚ç‚¹</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> head<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// å°è¯•è·å–å…±äº«é”</span>
                    <span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token function">tryAcquireShared</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// è·å–å…±äº«é”æˆåŠŸ</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment" spellcheck="true">// æ›´æ–°å½“å‰èŠ‚ç‚¹ä¸ºAQSé˜Ÿåˆ—çš„å¤´èŠ‚ç‚¹ï¼Œå¹¶å‘åä¼ æ’­å”¤é†’ç­‰å¾…å…±äº«é”çš„èŠ‚ç‚¹ï¼Œç›´åˆ°é‡åˆ°ç­‰å¾…ç‹¬å é”çš„èŠ‚ç‚¹</span>
                        <span class="token function">setHeadAndPropagate</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        p<span class="token punctuation">.</span>next <span class="token operator">=</span> null<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// help GC</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>interrupted<span class="token punctuation">)</span>
                            <span class="token function">selfInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        failed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// å‰é¢è¿˜æœ‰èŠ‚ç‚¹æ’é˜Ÿï¼Œé‚£å°±é˜»å¡</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldParkAfterFailedAcquire</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> node<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">parkAndCheckInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    interrupted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å­ç±»å®ç°çš„tryAcquireæ–¹æ³•æŠ›å‡ºå¼‚å¸¸ï¼Œé‚£ä¹ˆå–æ¶ˆå½“å‰èŠ‚ç‚¹ï¼Œå¹¶ä»AQSé˜Ÿåˆ—ç§»é™¤</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>failed<span class="token punctuation">)</span>
                <span class="token function">cancelAcquire</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>AbstractQueuedSynchronizer#setHeadAndPropagate</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setHeadAndPropagate</span><span class="token punctuation">(</span>Node node<span class="token punctuation">,</span> <span class="token keyword">int</span> propagate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Node h <span class="token operator">=</span> head<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Record old head for check below</span>
        <span class="token comment" spellcheck="true">// æ›´æ–°å¤´èŠ‚ç‚¹</span>
        <span class="token function">setHead</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å…±äº«é”è·å–æˆåŠŸ || åŸæœ¬çš„å¤´èŠ‚ç‚¹ä¸ºç©º || åŸæœ¬å¤´èŠ‚ç‚¹ä¸ºSIGNALã€CONDITIONæˆ–PROPAGATEçŠ¶æ€ || å½“å‰å¤´èŠ‚ç‚¹ä¸ºç©º || å½“å‰å¤´èŠ‚ç‚¹çŠ¶æ€ä¸º...</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>propagate <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">||</span> h <span class="token operator">==</span> null <span class="token operator">||</span> h<span class="token punctuation">.</span>waitStatus <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span>h <span class="token operator">=</span> head<span class="token punctuation">)</span> <span class="token operator">==</span> null <span class="token operator">||</span> h<span class="token punctuation">.</span>waitStatus <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Node s <span class="token operator">=</span> node<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å¦‚æœç¬¬ä¸€ä¸ªæ’é˜Ÿç­‰å¾…çš„èŠ‚ç‚¹åœ¨ç­‰å¾…è·å–å…±äº«é”</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> null <span class="token operator">||</span> s<span class="token punctuation">.</span><span class="token function">isShared</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// å‘åä¼ æ’­</span>
                <span class="token function">doReleaseShared</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<p>AbstractQueuedSynchronizer#doReleaseShared</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doReleaseShared</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// AQSé˜Ÿåˆ—çš„å¤´èŠ‚ç‚¹</span>
            Node h <span class="token operator">=</span> head<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å¦‚æœé˜Ÿåˆ—ä¸­å­˜åœ¨ç­‰å¾…é”çš„èŠ‚ç‚¹</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>h <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> h <span class="token operator">!=</span> tail<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å³å½“å‰æ‹¥æœ‰é”çš„èŠ‚ç‚¹çš„çŠ¶æ€</span>
                <span class="token keyword">int</span> ws <span class="token operator">=</span> h<span class="token punctuation">.</span>waitStatus<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å¦‚æœå¤´èŠ‚ç‚¹æ˜¯SIGNALçŠ¶æ€ï¼Œè¯´æ˜åç»§èŠ‚ç‚¹éœ€è¦è¢«å”¤é†’</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ws <span class="token operator">==</span> Node<span class="token punctuation">.</span>SIGNAL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// CASå°è¯•å°†å¤´èŠ‚ç‚¹çŠ¶æ€æ›´æ–°ä¸º0ï¼Œå¤±è´¥åˆ™ç»§ç»­é‡è¯•</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">compareAndSetWaitStatus</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> Node<span class="token punctuation">.</span>SIGNAL<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token comment" spellcheck="true">// å¯èƒ½è¯¥èŠ‚ç‚¹è¢«å–æ¶ˆï¼Œæˆ–è€…å¤šä¸ªçº¿ç¨‹åŒæ—¶é‡Šæ”¾å…±äº«é”</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">/*
                     * å¦‚æœCASæˆåŠŸï¼Œå”¤é†’å¤´èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ï¼Œå³æ’é˜Ÿç­‰å¾…çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹
                     * è¯¥èŠ‚ç‚¹è·å–å…±äº«é”åæˆä¸ºæ–°çš„å¤´ç»“ç‚¹ï¼Œç„¶åä¼šç»§ç»­å”¤é†’ä¸‹ä¸€ä¸ªï¼Œå°±æ˜¯ä¼ æ’­
                     * ç‹¬å é”çš„é‡Šæ”¾å°±ç®€å•å¤šäº†ï¼Œåªç”¨å”¤é†’åé¢ç¬¬ä¸€ä¸ªéå–æ¶ˆçš„èŠ‚ç‚¹å°±å¥½äº†
                     */</span>
                    <span class="token function">unparkSuccessor</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// ä¸Šæ¬¡è‡ªæ—‹æˆåŠŸCASæ›´æ–°å¤´èŠ‚ç‚¹çŠ¶æ€åï¼ŒCASå°è¯•å°†å¤´èŠ‚ç‚¹çš„çŠ¶æ€è®¾ç½®æˆPROPAGATEä¼ æ’­çŠ¶æ€ï¼Œå¤±è´¥åˆ™ç»§ç»­é‡è¯•</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ws <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">compareAndSetWaitStatus</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> Node<span class="token punctuation">.</span>PROPAGATE<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å¦‚æœå¤´èŠ‚ç‚¹æ²¡æœ‰å˜åŒ–ï¼Œè¯´æ˜è¢«å”¤é†’çš„èŠ‚ç‚¹è¿˜æ²¡è·å–å…±äº«é”ï¼Œé€€å‡ºå¾ªç¯ï¼Œè¢«å”¤é†’çš„èŠ‚ç‚¹è·å–å…±äº«é”åè¿˜ä¼šè¿›å…¥è¿™é‡Œï¼Œå‘åå”¤é†’</span>
            <span class="token comment" spellcheck="true">// å¦‚æœå¤´èŠ‚ç‚¹æ”¹å˜äº†ï¼Œè¯´æ˜è¢«å”¤é†’çš„èŠ‚ç‚¹è·å–äº†å…±äº«é”ï¼Œç»§ç»­å”¤é†’ä¸‹ä¸€ä¸ª</span>
            <span class="token comment" spellcheck="true">// è¿™é‡Œæˆ‘æ²¡çœ‹æ‡‚ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšï¼Œå› ä¸ºè¢«å”¤é†’çš„èŠ‚ç‚¹ä¹Ÿä¼šå”¤é†’åé¢çš„èŠ‚ç‚¹ï¼Œæœ‰å¿…è¦å¹¶å‘è¿›è¡Œå”¤é†’å—ï¼Ÿè¿˜æ˜¯è¯´æé«˜ååé‡ï¼Ÿ</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>h <span class="token operator">==</span> head<span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span></code></pre>
<hr>
<p>ReentrantReadWriteLock$ReadLock#unlock</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sync<span class="token punctuation">.</span><span class="token function">releaseShared</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>AbstractQueuedSynchronizer#releaseShared</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">releaseShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// å°è¯•é‡Šæ”¾å…±äº«é”</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tryReleaseShared</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// é‡Šæ”¾æˆåŠŸï¼Œå”¤é†’ç­‰å¾…é˜Ÿåˆ—ä¸­çš„èŠ‚ç‚¹</span>
            <span class="token function">doReleaseShared</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span></code></pre>
<p>ReentrantReadWriteLock$Sync#tryReleaseShared</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">tryReleaseShared</span><span class="token punctuation">(</span><span class="token keyword">int</span> unused<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Thread current <span class="token operator">=</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å½“å‰çº¿ç¨‹æ˜¯ç¬¬ä¸€ä¸ªè·å–è¯»é”çš„çº¿ç¨‹</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>firstReader <span class="token operator">==</span> current<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// æ²¡æœ‰é‡å…¥ï¼Œç›´æ¥æ¸…ç©º</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>firstReaderHoldCount <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
                    firstReader <span class="token operator">=</span> null<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// é‡å…¥æ¬¡æ•°å‡å°‘</span>
                <span class="token keyword">else</span>
                    firstReaderHoldCount<span class="token operator">--</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// å¦‚æœä¸æ˜¯</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// ä¸Šä¸ªè·å–è¯»é”çš„çº¿ç¨‹çš„è¯»é”é‡å…¥æ¬¡æ•°ç¼“å­˜</span>
                HoldCounter rh <span class="token operator">=</span> cachedHoldCounter<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// ç¼“å­˜ä¸ºç©º || ç¼“å­˜æœªå‘½ä¸­</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>rh <span class="token operator">==</span> null <span class="token operator">||</span> rh<span class="token punctuation">.</span>tid <span class="token operator">!=</span> <span class="token function">getThreadId</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token comment" spellcheck="true">// ä»ThreadLocalè·å–</span>
                    rh <span class="token operator">=</span> readHolds<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> count <span class="token operator">=</span> rh<span class="token punctuation">.</span>count<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å·²ç»æ²¡æœ‰é‡å…¥äº†</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// ç§»é™¤ThreadLocal</span>
                    readHolds<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">// å¤šæ¬¡ReadLock#unlock</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                        <span class="token keyword">throw</span> <span class="token function">unmatchedUnlockException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment" spellcheck="true">// é‡å…¥æ¬¡æ•°å‡å°‘</span>
                <span class="token operator">--</span>rh<span class="token punctuation">.</span>count<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// è‡ªæ—‹è‡³CASæˆåŠŸ</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// è¯»é”çš„è·å–æ¬¡æ•°å‡1</span>
                <span class="token keyword">int</span> nextc <span class="token operator">=</span> c <span class="token operator">-</span> SHARED_UNIT<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// CASæ›´æ–°é”çš„çŠ¶æ€</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> nextc<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token comment" spellcheck="true">// å¦‚æœæ˜¯0ï¼Œè¡¨ç¤ºè¯»é”å’Œå†™é”éƒ½ç©ºé—²ï¼Œå¯ä»¥å”¤é†’åé¢çš„ç­‰å¾…çº¿ç¨‹</span>
                    <span class="token keyword">return</span> nextc <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span></code></pre>
<hr>
<p>ReentrantReadWriteLock$WriteLock#lock</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// AQS</span>
            sync<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>ReentrantReadWriteLock$Sync#tryAcquire</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> acquires<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Thread current <span class="token operator">=</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> c <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å†™é”çš„é‡å…¥æ¬¡æ•°</span>
            <span class="token keyword">int</span> w <span class="token operator">=</span> <span class="token function">exclusiveCount</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// é”ä¸ç©ºé—²ï¼Œè¯»é”æˆ–å†™é”è¢«æŒæœ‰</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// å†™é”ç©ºé—²ï¼Œä½†è¯»é”ä¸ç©ºé—² || å†™é”ä¸ç©ºé—²ï¼Œä½†ä¸æ˜¯é‡å…¥</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>w <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> current <span class="token operator">!=</span> <span class="token function">getExclusiveOwnerThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token comment" spellcheck="true">// è·å–å†™é”å¤±è´¥</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// å†™é”é‡å…¥æ¬¡æ•°è¶…è¿‡æœ€å¤§å€¼</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>w <span class="token operator">+</span> <span class="token function">exclusiveCount</span><span class="token punctuation">(</span>acquires<span class="token punctuation">)</span> <span class="token operator">></span> MAX_COUNT<span class="token punctuation">)</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"Maximum lock count exceeded"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// æ›´æ–°é”çŠ¶æ€</span>
                <span class="token function">setState</span><span class="token punctuation">(</span>c <span class="token operator">+</span> acquires<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// é‡å…¥è·å–å†™é”æˆåŠŸ</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">// æ­¤æ—¶ä¸å­˜åœ¨è¯»é”æˆ–å†™é”</span>
            <span class="token comment" spellcheck="true">// æ ¹æ®å…¬å¹³ç­–ç•¥å†³å®šæ˜¯å¦éœ€è¦é˜»å¡ï¼Œéå…¬å¹³ï¼Œå®Œå…¨ä¸éœ€è¦é˜»å¡ï¼Œè€Œå…¬å¹³éœ€è¦åˆ¤æ–­AQSåŒæ­¥é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰èŠ‚ç‚¹ç­‰å¾…ï¼Œä¸èƒ½æ’é˜Ÿ</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">writerShouldBlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> c <span class="token operator">+</span> acquires<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å¦‚æœCASæ›´æ–°æˆåŠŸï¼Œé‚£ä¹ˆè·å–å†™é”æˆåŠŸï¼Œæ›´æ–°é”çš„æŒæœ‰çº¿ç¨‹</span>
            <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<hr>
<p>ReentrantReadWriteLock$WriteLock#unlock</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// AQS</span>
            sync<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<p>ReentrantReadWriteLock$Sync#tryRelease</p>
<pre class=" language-java"><code class="language-java">        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">tryRelease</span><span class="token punctuation">(</span><span class="token keyword">int</span> releases<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// å…ˆæ ¡éªŒæ˜¯å¦æŒæœ‰å†™é”</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isHeldExclusively</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalMonitorStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å†™é”é‡å…¥æ¬¡æ•°å‡å°‘</span>
            <span class="token keyword">int</span> nextc <span class="token operator">=</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> releases<span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å¯ä»¥é‡Šæ”¾å†™é”</span>
            <span class="token keyword">boolean</span> free <span class="token operator">=</span> <span class="token function">exclusiveCount</span><span class="token punctuation">(</span>nextc<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// å¦‚æœå¯ä»¥é‡Šæ”¾ï¼Œç½®ç©ºé”çš„æŒæœ‰çº¿ç¨‹</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>free<span class="token punctuation">)</span>
                <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// æ›´æ–°é”çŠ¶æ€</span>
            <span class="token function">setState</span><span class="token punctuation">(</span>nextc<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> free<span class="token punctuation">;</span>
        <span class="token punctuation">}</span></code></pre>
<hr>
<p>æ€»ç»“ï¼š</p>
<ul>
<li>Must release read lock before acquiring write lock.</li>
</ul>
<p>å¿…é¡»å…ˆé‡Šæ”¾è¯»é”ï¼Œæ‰èƒ½è·å–å†™é”ï¼Œä¸å…è®¸è¯»é”å‡çº§ä¸ºå†™é”ã€‚</p>
<p>å¦‚æœä¸é‡Šæ”¾è¯»é”å°±ç›´æ¥è·å–å†™é”ï¼Œä¼šå¯¼è‡´æ­»é”ã€‚</p>
<p>å› ä¸ºè¯»é”å­˜åœ¨æ—¶ï¼Œä¸èƒ½è·å–å†™é”ï¼Œä¼šç›´æ¥è¿›å…¥AQSé˜Ÿåˆ—é˜»å¡ï¼Œç­‰å¾…å‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå³è¯»é”é‡Šæ”¾åå”¤é†’ï¼Œä½†è¯»é”ä¸èƒ½è¢«é‡Šæ”¾ï¼Œå› ä¸ºçº¿ç¨‹å·²ç»é˜»å¡äº†ï¼Œè¿™å°±æ˜¯æ­»é”ã€‚</p>
<ul>
<li>Downgrade by acquiring read lock before releasing write lock.</li>
</ul>
<p>åœ¨é‡Šæ”¾å†™é”å‰ï¼Œå¯ä»¥è·å–è¯»é”ï¼Œå…è®¸å†™é”é™çº§ä¸ºè¯»é”ï¼Œæ­¤çº¿ç¨‹æ—¢æŒæœ‰å†™é”åˆæŒæœ‰è¯»é”ã€‚</p>
<p>ä¸è¿‡æˆ‘æ²¡çœ‹å‡ºè¿™ä¸ªè¡Œä¸ºæœ‰ä»€ä¹ˆæ„ä¹‰ã€‚</p>
<p>éš¾é“æ˜¯ä¸ºäº†ä¹‹åé‡Šæ”¾å†™é”ï¼Œåªæ‹¥æœ‰è¯»é”ï¼Ÿå› ä¸ºç›´æ¥é‡Šæ”¾å†™é”å¯èƒ½å¯¼è‡´å†™é”è¢«åˆ«çš„çº¿ç¨‹è·å–ï¼Œæ— æ³•è·å–è¯»é”ï¼Ÿ</p>
<hr>
<p>è¯è¯´åšå°¼ç‰¹çœŸå¹¸ç¦å•Šã€‚ã€‚ã€‚</p>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


        <footer>
             
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

        </footer>
    </div>
    <!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
    <script>
        var timeEnd = new Date();
        console.log('è€—æ—¶ï¼š' + (timeEnd - timeStart));
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre').forEach((block) => {
                block.classList.add("line-numbers");
            });
        });
    </script>
    <!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
    <!-- material design -->
    <!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
    <!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
    <!-- toc -->
    <!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
    <!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
    <!-- <script src="/js/main.js"></script> -->
    <script src="/js/prism.js"></script>
</body>
</html>
