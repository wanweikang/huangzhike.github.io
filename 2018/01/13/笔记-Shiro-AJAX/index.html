<!DOCTYPE HTML>
<html>
	<head>
		<meta charset="utf-8">
		
		<title>[笔记]-Shiro-AJAX | 一个放笔记的地方而已</title>
		
		<meta name="author" content="Huangzhike">
		
		
		<meta name="description" content="用手记笔记，用心记笔记，用脑记笔记">
		
		
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		
		<meta property="og:title" content="[笔记]-Shiro-AJAX"/>
		
		<meta property="og:site_name" content="一个放笔记的地方而已"/>
		
		
		<!-- favicon -->
		<link rel="icon" type="image/ico" href="/favicon.ico" sizes="32x32">
		<link rel="manifest" href="/manifest.json">
		<meta name="msapplication-TileColor" content="#009688">
		<meta name="msapplication-TileImage" content="/mstile-144x144.ico">
		<meta name="theme-color" content="#009688">
		<script>var timeStart = new Date();</script>
		<!-- favicon end -->
		<!-- <link href="//favicon.ico" rel="icon"> -->
		
		<!-- toc -->
		<!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
		<!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
		<!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
		<!-- material design -->
		<!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
		<!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
		<!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
		<!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
		<!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
		<link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
		
		
		<!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
		<!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
	</head>

<body>
	<nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">菜单</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" href="/">一个放笔记的地方而已</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/" title="">
						<i class="fa fa-home"></i>首页
					</a>
				</li>
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>存档
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" title="我的主页">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

	<div class="container" >
		<div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[笔记]-Shiro-AJAX</h2>
				
				<div>
					<span class="post-time">2018-01-13 9:00</span>
				</div>	
				
				<div class="article-content">
				<p>因为最近想把Shiro结合AJAX使用，查了查，有些解决方法太暴力我就不贴了。</p>
<p>不保证正确，只是看了一遍。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/login"</span>)</div><div class="line"><span class="meta">@ResponseBody</span></div><div class="line">public <span class="built_in">Object</span> ajaxLogin(<span class="meta">@RequestParam</span> <span class="built_in">String</span> username, </div><div class="line">		<span class="meta">@RequestParam</span> <span class="built_in">String</span> password, <span class="meta">@RequestParam</span> boolean rememberMe) &#123;</div><div class="line"></div><div class="line">	<span class="built_in">String</span> ret = <span class="string">""</span>;</div><div class="line">	Subject currentUser = SecurityUtils.getSubject();</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (!currentUser.isAuthenticated()) &#123;</div><div class="line">		UsernamePasswordToken token = <span class="keyword">new</span> UsernamePasswordToken(username, password);</div><div class="line">		token.setRememberMe(rememberMe);</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			currentUser.login(token);</div><div class="line">			ret = <span class="string">"&#123;success:true,message:'登陆成功'&#125;"</span>;</div><div class="line">		&#125; <span class="keyword">catch</span> (UnknownAccountException ex) &#123;</div><div class="line">			ret = <span class="string">"&#123;success:false,message:'账号错误'&#125;"</span>;</div><div class="line">		&#125; <span class="keyword">catch</span> (IncorrectCredentialsException ex) &#123;</div><div class="line">			ret = <span class="string">"&#123;success:false,message:'密码错误'&#125;"</span>;</div><div class="line">		&#125; <span class="keyword">catch</span> (LockedAccountException ex) &#123;</div><div class="line">			ret = <span class="string">"&#123;success:false,message:'账号已被锁定，请与管理员联系'&#125;"</span>;</div><div class="line">		&#125; <span class="keyword">catch</span> (AuthenticationException ex) &#123;</div><div class="line">			ret = <span class="string">"&#123;success:false,message:'您没有授权'&#125;"</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// 返回json</span></div><div class="line">	<span class="keyword">return</span> ret;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p>通过Controller解决：</p>
<p><code>@RequiresPermissions</code>有对应权限才可以访问</p>
<p><code>@RequiresUser</code>存在用户登录状态才可以访问</p>
<p>请求使用这些注解方式控制的方法时，如果没有通过权限校验，Shiro会抛出如下两组类型的异常。</p>
<ul>
<li>登录认证类异常<ul>
<li>UnauthenticatedException.class</li>
<li>AuthenticationException.class </li>
</ul>
</li>
<li>权限认证类异常<ul>
<li>UnauthorizedException.class</li>
<li>AuthorizationException.class </li>
</ul>
</li>
</ul>
<p>对于JSON和页面跳转，只需要做一个Ajax判断处理。</p>
<p>可以加一个标识参数，或者直接用<code>header</code>里面的<code>X-Requested-With</code>参数。</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> abstract <span class="keyword">class</span> BaseController &#123;</div><div class="line"></div><div class="line">	<span class="comment">// 登录认证异常</span></div><div class="line">	@ExceptionHandler(&#123;UnauthenticatedException.<span class="keyword">class</span>, AuthenticationException.<span class="keyword">class</span>&#125;)</div><div class="line">	<span class="keyword">public</span> <span class="keyword">String</span> authenticationException(HttpServletRequest request, HttpServletResponse response) &#123;</div><div class="line">		<span class="built_in">if</span> (WebUtils.isAjaxRequest(request)) &#123;</div><div class="line">			<span class="comment">// 输出JSON</span></div><div class="line">			Map&lt;<span class="keyword">String</span>, Object&gt; <span class="built_in">map</span> = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">			<span class="built_in">map</span>.<span class="built_in">put</span>(<span class="string">"code"</span>, <span class="string">"-999"</span>);</div><div class="line">			<span class="built_in">map</span>.<span class="built_in">put</span>(<span class="string">"message"</span>, <span class="string">"未登录"</span>);</div><div class="line">			WebUtils.writeJson(<span class="built_in">map</span>, response);</div><div class="line">			<span class="built_in">return</span> null;</div><div class="line">		&#125; <span class="built_in">else</span> &#123;</div><div class="line">			<span class="built_in">return</span> <span class="string">"redirect:/system/login"</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// 权限异常</span></div><div class="line">	@ExceptionHandler(&#123;UnauthorizedException.<span class="keyword">class</span>, AuthorizationException.<span class="keyword">class</span>&#125;)</div><div class="line">	<span class="keyword">public</span> <span class="keyword">String</span> authorizationException(HttpServletRequest request, HttpServletResponse response) &#123;</div><div class="line">		<span class="built_in">if</span> (WebUtils.isAjaxRequest(request)) &#123;</div><div class="line">			<span class="comment">// 输出JSON</span></div><div class="line">			Map&lt;<span class="keyword">String</span>, Object&gt; <span class="built_in">map</span> = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">			<span class="built_in">map</span>.<span class="built_in">put</span>(<span class="string">"code"</span>, <span class="string">"-998"</span>);</div><div class="line">			<span class="built_in">map</span>.<span class="built_in">put</span>(<span class="string">"message"</span>, <span class="string">"无权限"</span>);</div><div class="line">			WebUtils.writeJson(<span class="built_in">map</span>, response);</div><div class="line">			<span class="built_in">return</span> null;</div><div class="line">		&#125; <span class="built_in">else</span> &#123;</div><div class="line">			<span class="built_in">return</span> <span class="string">"redirect:/system/403"</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">WebUtils</span> &#123;</div><div class="line">	<span class="comment">// 是否是Ajax请求</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> boolean <span class="title">isAjaxRequest</span>(<span class="params">HttpServletRequest request</span>) </span>&#123;</div><div class="line">		String requestedWith = request.getHeader(<span class="string">"x-requested-with"</span>);</div><div class="line">		<span class="keyword">if</span> (requestedWith != <span class="literal">null</span> &amp;&amp; requestedWith.equalsIgnoreCase(<span class="string">"XMLHttpRequest"</span>)) &#123;</div><div class="line">			<span class="keyword">return</span> Boolean.TRUE;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">return</span> Boolean.FALSE;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// 输出JSON</span></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">writeJson</span>(<span class="params">Map&lt;String, Object&gt; map, HttpServletResponse response</span>) </span>&#123;</div><div class="line">		<span class="comment">// ResponseHeader responseHeader = new ResponseHeader();</span></div><div class="line">		<span class="comment">// responseHeader.setResponse(ResponseHeader.SC_FORBIDDEN, null);</span></div><div class="line">		PrintWriter <span class="keyword">out</span> = <span class="literal">null</span>;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			response.setCharacterEncoding(<span class="string">"UTF-8"</span>);</div><div class="line">			response.setContentType(<span class="string">"application/json; charset=utf-8"</span>);</div><div class="line">			<span class="keyword">out</span> = response.getWriter();</div><div class="line">			<span class="keyword">out</span>.write(JsonUtil.mapToJson(map));</div><div class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125; <span class="keyword">finally</span> &#123;</div><div class="line">			<span class="keyword">if</span> (<span class="keyword">out</span> != <span class="literal">null</span>) &#123;</div><div class="line">				<span class="keyword">out</span>.close();</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Controller</span></div><div class="line"><span class="meta">@RequestMapping</span></div><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">PageController</span> <span class="keyword">extends</span> <span class="title">BaseController</span></span>&#123;</div><div class="line">	<span class="comment">// AJAX请求时，没有登录返回对应没有登录的JSON，而不是暴力重定向到登录页面</span></div><div class="line">	<span class="meta">@RequiresUser</span></div><div class="line">	<span class="meta">@RequestMapping</span>(value=<span class="string">"/getData"</span>, method=<span class="type">RequestMethod</span>.<span class="type">POST</span>)</div><div class="line">	<span class="meta">@ResponseBody</span></div><div class="line">	public <span class="type">List</span>&lt;<span class="type">String</span>&gt; getData(<span class="type">Model</span> model)&#123;</div><div class="line">		<span class="type">List</span>&lt;<span class="type">String</span>&gt; list = <span class="keyword">new</span> <span class="type">ArrayList</span>&lt;&gt;();</div><div class="line">		list.add(<span class="string">"data1"</span>);</div><div class="line">		list.add(<span class="string">"data2"</span>);</div><div class="line">		<span class="keyword">return</span> list;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<p>改Filter，也有好几种Filter改法：</p>
<p>大体是：</p>
<ul>
<li><p>判断请求是否为Ajax请求</p>
</li>
<li><p>Response输出JSON数据</p>
</li>
</ul>
<p>AJAX不能重定向，需要返回指定格式的JSON。</p>
<ul>
<li><p>AJAX调用接口没有登录时，返回指定格式JSON</p>
<ul>
<li>AdviceFilter：访问Controller之前判断是否登录</li>
</ul>
</li>
<li><p>AJAX调用接口在登录的情况下，角色认证不通过，返回指定格式JSON</p>
<ul>
<li>RolesAuthorizationFilter：认证Roles失败时回调的onAccessDenied方法，用于返回JSON或是重定向</li>
</ul>
</li>
<li><p>AJAX调用接口在登录的情况下，资源认证不通过，返回指定格式JSON</p>
<ul>
<li>PermissionsAuthorizationFilter：认证资源，也是重写onAccessDenied方法</li>
</ul>
</li>
<li><p>普通请求调用接口则进行重定向处理</p>
</li>
</ul>
<p>先来个加强版：</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> class ShiroLoginFilter extends AdviceFilter &#123;</div><div class="line">	<span class="comment">// private Logger logger = Logger.getLogger(ShiroLoginFilter.class);</span></div><div class="line"></div><div class="line">	@Override</div><div class="line">	@SuppressWarnings(<span class="string">"unchecked"</span>)</div><div class="line">	<span class="keyword">protected</span> <span class="built_in">boolean</span> preHandle(ServletRequest request, ServletResponse response) <span class="keyword">throws</span> Exception &#123;</div><div class="line">		<span class="keyword">JSONObject</span> jsonObj = <span class="keyword">new</span> <span class="keyword">JSONObject</span>();</div><div class="line">		<span class="keyword">String</span> redirect_url = <span class="string">""</span>;</div><div class="line"></div><div class="line">		HttpServletRequest httpReq = (HttpServletRequest) request;</div><div class="line">		HttpServletResponse httpRes = (HttpServletResponse) response;</div><div class="line"></div><div class="line">		httpReq.setCharacterEncoding(<span class="string">"utf-8"</span>);</div><div class="line">		<span class="comment">// =====================判断是否清除缓存=============================</span></div><div class="line">		HttpSession session = httpReq.getSession();</div><div class="line">		<span class="keyword">String</span> jsessionid = session.getId();</div><div class="line">		<span class="comment">// logger.info("登录的sessionid:" + jsessionid);</span></div><div class="line">		<span class="keyword">Object</span> obj = session.getAttribute(<span class="string">"userId"</span>);</div><div class="line">		<span class="comment">// logger.info("userId数据:" + obj);</span></div><div class="line">		<span class="comment">// =====================获得get的地址和后面的参数=====================</span></div><div class="line">		<span class="keyword">String</span> urlStr = httpReq.getRequestURI();</div><div class="line">		<span class="keyword">String</span> reqQueryString = httpReq.getQueryString(); <span class="comment">// 获得问号后面的参数</span></div><div class="line">		<span class="keyword">if</span> (!IsEmptyUtil.empty(reqQueryString)) &#123;</div><div class="line">			redirect_url = urlStr + <span class="string">"?"</span> + reqQueryString;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			redirect_url = urlStr;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (obj == <span class="keyword">null</span>) &#123; <span class="comment">// 判断是否已经登录</span></div><div class="line">			<span class="keyword">String</span> ajaxFlag = httpReq.getHeader(<span class="string">"x-requested-with"</span>); <span class="comment">// 获得ajax标示 XMLHttpRequest</span></div><div class="line">			<span class="comment">// 去掉最后一个空格</span></div><div class="line">			<span class="keyword">if</span> (ajaxFlag != <span class="keyword">null</span>) &#123; </div><div class="line">				<span class="comment">// logger.info("ajax 提交");</span></div><div class="line">				<span class="keyword">String</span> acceptStr = httpReq.getHeader(<span class="string">"Accept"</span>);</div><div class="line">				<span class="keyword">String</span> method = httpReq.getMethod();</div><div class="line">				<span class="comment">// 获得post的参数，不需要编码</span></div><div class="line">				<span class="keyword">String</span> queryString = <span class="string">""</span>;</div><div class="line">				Map&lt;<span class="keyword">String</span>, <span class="keyword">String</span>[]&gt; params = httpReq.getParameterMap();</div><div class="line">				<span class="keyword">for</span> (<span class="keyword">String</span> <span class="built_in">key</span> : params.keySet()) &#123;</div><div class="line">					<span class="keyword">String</span>[] values = params.<span class="built_in">get</span>(<span class="built_in">key</span>);</div><div class="line">					<span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; values.length; i++) &#123;</div><div class="line">						<span class="keyword">String</span> value = values[i];</div><div class="line">						queryString += <span class="built_in">key</span> + <span class="string">"="</span> + value + <span class="string">"&amp;"</span>;</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">				<span class="comment">// 返回ajax的请求参数</span></div><div class="line">				<span class="keyword">if</span> (!IsEmptyUtil.empty(queryString)) &#123;</div><div class="line">					queryString = queryString.substring(<span class="number">0</span>, queryString.length() - <span class="number">1</span>);</div><div class="line">				&#125;</div><div class="line">				<span class="comment">// 获得请求datatype的类型</span></div><div class="line">				<span class="keyword">if</span> (acceptStr.contains(<span class="string">"json"</span>)) &#123;</div><div class="line">					jsonObj.put(<span class="string">"datatype_flag"</span>, <span class="string">"json"</span>);</div><div class="line">				&#125; <span class="keyword">else</span> <span class="keyword">if</span> (acceptStr.contains(<span class="string">"html"</span>)) &#123;</div><div class="line">					jsonObj.put(<span class="string">"datatype_flag"</span>, <span class="string">"html"</span>);</div><div class="line">				&#125;</div><div class="line">				<span class="comment">// 获得是post还是get方法</span></div><div class="line">				<span class="keyword">if</span> (method.equalsIgnoreCase(<span class="string">"post"</span>)) &#123;</div><div class="line">					jsonObj.put(<span class="string">"request_method"</span>, <span class="string">"post"</span>);</div><div class="line">				&#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equalsIgnoreCase(<span class="string">"get"</span>)) &#123;</div><div class="line">					jsonObj.put(<span class="string">"request_method"</span>, <span class="string">"get"</span>);</div><div class="line">				&#125;</div><div class="line">				jsonObj.put(<span class="string">"smallwin_flag"</span>, <span class="string">"Y"</span>);</div><div class="line">				jsonObj.put(<span class="string">"ajaxFlag"</span>, <span class="string">"Y"</span>);</div><div class="line">				jsonObj.put(<span class="string">"redirect_url"</span>, redirect_url);</div><div class="line">				jsonObj.put(<span class="string">"paramsStr"</span>, queryString);</div><div class="line">				jsonObj.put(<span class="string">"jsessionid"</span>, jsessionid);</div><div class="line">				response.setCharacterEncoding(<span class="string">"UTF-8"</span>);</div><div class="line">				response.getWriter().write(jsonObj.toString());</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				<span class="comment">// logger.info("form 提交");</span></div><div class="line">				<span class="keyword">String</span> queryString = <span class="string">""</span>;</div><div class="line">				Map&lt;<span class="keyword">String</span>, <span class="keyword">String</span>[]&gt; params = httpReq.getParameterMap();</div><div class="line">				<span class="keyword">for</span> (<span class="keyword">String</span> <span class="built_in">key</span> : params.keySet()) &#123;</div><div class="line">					<span class="keyword">String</span>[] values = params.<span class="built_in">get</span>(<span class="built_in">key</span>);</div><div class="line">					<span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; values.length; i++) &#123;</div><div class="line">						<span class="keyword">String</span> value = values[i];</div><div class="line">						queryString += <span class="string">"&#123;\'name\'"</span> + <span class="string">":"</span> + <span class="string">"\'"</span> + <span class="built_in">key</span> + <span class="string">"\'"</span> + <span class="string">","</span>;</div><div class="line">						queryString += <span class="string">"\'value\'"</span> + <span class="string">":"</span> + <span class="string">"\'"</span> + value + <span class="string">"\'"</span> + <span class="string">"&#125;,"</span>;</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">				<span class="comment">// 返回ajax的请求参数</span></div><div class="line">				<span class="keyword">if</span> (!IsEmptyUtil.empty(queryString)) &#123;</div><div class="line">					queryString = <span class="string">"["</span> + queryString.substring(<span class="number">0</span>, queryString.length() - <span class="number">1</span>) + <span class="string">"]"</span>;</div><div class="line">				&#125;</div><div class="line">				httpRes.sendRedirect(<span class="string">"/anon_login.jsp?redirect_url="</span> + redirect_url);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShiroLoginFilter</span> <span class="keyword">extends</span> <span class="title">AdviceFilter</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="keyword">protected</span> boolean preHandle(<span class="type">ServletRequest</span> request, <span class="type">ServletResponse</span> response) <span class="keyword">throws</span> <span class="type">Exception</span> &#123;</div><div class="line">		<span class="type">HttpServletRequest</span> httpServletRequest = (<span class="type">HttpServletRequest</span>) request;</div><div class="line">		<span class="type">HttpServletResponse</span> httpServletResponse = (<span class="type">HttpServletResponse</span>) response;</div><div class="line"></div><div class="line">		<span class="type">SysUser</span> sysUser = (<span class="type">SysUser</span>) httpServletRequest.getSession().getAttribute(<span class="string">"user"</span>);</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (<span class="literal">null</span> == sysUser &amp;&amp; !<span class="type">StringUtils</span>.contains(httpServletRequest.getRequestURI(), <span class="string">"/login"</span>)) &#123;</div><div class="line"></div><div class="line">			<span class="type">String</span> requestedWith = httpServletRequest.getHeader(<span class="string">"X-Requested-With"</span>);</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (<span class="type">StringUtils</span>.isNotEmpty(requestedWith) &amp;&amp; <span class="type">StringUtils</span>.equals(requestedWith, <span class="string">"XMLHttpRequest"</span>)) &#123;</div><div class="line">				<span class="comment">// 如果是ajax返回指定数据</span></div><div class="line">				httpServletResponse.setCharacterEncoding(<span class="string">"UTF-8"</span>);</div><div class="line">				httpServletResponse.setContentType(<span class="string">"application/json"</span>);</div><div class="line">				httpServletResponse.getWriter().write(<span class="type">JSONObject</span>.toJSONString(responseHeader));</div><div class="line">				<span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				<span class="comment">// 不是ajax进行重定向处理</span></div><div class="line">				httpServletResponse.sendRedirect(<span class="string">"/login/local"</span>);</div><div class="line">				<span class="comment">// false-该filter过滤器已经处理，不继续执行其他过滤器</span></div><div class="line">				<span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// true-继续往下执行</span></div><div class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">ShiroRolesFilter</span> <span class="keyword">extends</span> <span class="title">RolesAuthorizationFilter</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="keyword">protected</span> boolean onAccessDenied(<span class="type">ServletRequest</span> servletRequest, <span class="type">ServletResponse</span> servletResponse) </div><div class="line">			<span class="keyword">throws</span> <span class="type">IOException</span> &#123;</div><div class="line">		<span class="type">HttpServletRequest</span> httpServletRequest = (<span class="type">HttpServletRequest</span>) servletRequest;</div><div class="line">		<span class="type">HttpServletResponse</span> httpServletResponse = (<span class="type">HttpServletResponse</span>) servletResponse;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (<span class="type">WebUtils</span>.isAjaxRequest(request)) &#123;</div><div class="line">			<span class="comment">// ...</span></div><div class="line">			<span class="type">WebUtils</span>.writeJson(map, response);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (<span class="type">StringUtils</span>.isNotEmpty(requestedWith) &amp;&amp; <span class="type">StringUtils</span>.equals(requestedWith, <span class="string">"XMLHttpRequest"</span>)) &#123;</div><div class="line">			<span class="comment">// 如果是ajax返回指定格式数据</span></div><div class="line">			<span class="type">ResponseHeader</span> responseHeader = <span class="keyword">new</span> <span class="type">ResponseHeader</span>();</div><div class="line">			responseHeader.setResponse(<span class="type">ResponseHeader</span>.<span class="type">SC_FORBIDDEN</span>, <span class="literal">null</span>);</div><div class="line">			httpServletResponse.setCharacterEncoding(<span class="string">"UTF-8"</span>);</div><div class="line">			httpServletResponse.setContentType(<span class="string">"application/json"</span>);</div><div class="line">			httpServletResponse.getWriter().write(<span class="type">JSONObject</span>.toJSONString(responseHeader));</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="comment">// 如果是普通请求进行重定向</span></div><div class="line">			httpServletResponse.sendRedirect(<span class="string">"/403"</span>);</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// true-继续往下执行，false-该filter过滤器已经处理，不继续执行其他过滤器</span></div><div class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">ShiroPermsFilter</span> <span class="keyword">extends</span> <span class="title">PermissionsAuthorizationFilter</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="keyword">protected</span> boolean onAccessDenied(<span class="type">ServletRequest</span> servletRequest, <span class="type">ServletResponse</span> servletResponse) </div><div class="line">			<span class="keyword">throws</span> <span class="type">IOException</span> &#123;</div><div class="line"></div><div class="line">		<span class="comment">// 完全同上</span></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在实现自定义Filter的时候不要用Spring进行单例模式的bean初始化。</p>
<p>还有这种：</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> class CaptchaFormAuthenticationFilter extends FormAuthenticationFilter &#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger <span class="built_in">log</span> = LoggerFactory.getLogger(CaptchaFormAuthenticationFilter.class);</div><div class="line"></div><div class="line">	@Override</div><div class="line">	<span class="keyword">protected</span> <span class="built_in">boolean</span> onLoginSuccess(AuthenticationToken token, </div><div class="line">		Subject subject, ServletRequest request, ServletResponse response) </div><div class="line">			<span class="keyword">throws</span> Exception &#123;</div><div class="line"></div><div class="line">		HttpServletRequest httpServletRequest = (HttpServletRequest) request;</div><div class="line">		HttpServletResponse httpServletResponse = (HttpServletResponse) response;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (WebUtils.isAjaxRequest(request)) &#123;</div><div class="line">			Map&lt;<span class="keyword">String</span>, <span class="keyword">Object</span>&gt; <span class="built_in">map</span> = <span class="keyword">new</span> <span class="keyword">HashMap</span>&lt;&gt;();</div><div class="line">			<span class="built_in">map</span>.put(<span class="string">"code"</span>, <span class="string">"-999"</span>);</div><div class="line">			<span class="built_in">map</span>.put(<span class="string">"message"</span>, <span class="string">"未登录"</span>);</div><div class="line">			WebUtils.writeJson(<span class="built_in">map</span>, response);</div><div class="line"></div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			issueSuccessRedirect(request, response);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	@Override</div><div class="line">	<span class="keyword">protected</span> <span class="built_in">boolean</span> onLoginFailure(AuthenticationToken token, </div><div class="line">		AuthenticationException e, ServletRequest request, ServletResponse response) &#123;</div><div class="line"></div><div class="line">		HttpServletRequest httpServletRequest = (HttpServletRequest) request;</div><div class="line">		<span class="keyword">if</span> (!WebUtils.isAjaxRequest(request)) &#123;</div><div class="line">			setFailureAttribute(request, e);</div><div class="line">			<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			response.setCharacterEncoding(<span class="string">"UTF-8"</span>);</div><div class="line">			response.setContentType(<span class="string">"application/json; charset=utf-8"</span>);</div><div class="line">			PrintWriter out = response.getWriter();</div><div class="line">			<span class="keyword">String</span> message = e.getClass().getSimpleName();</div><div class="line">			<span class="keyword">if</span> (<span class="string">"IncorrectCredentialsException"</span>.equals(message)) &#123;</div><div class="line">				out.<span class="built_in">println</span>(<span class="string">"&#123;success:false,message:'密码错误'&#125;"</span>);</div><div class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"UnknownAccountException"</span>.equals(message)) &#123;</div><div class="line">				out.<span class="built_in">println</span>(<span class="string">"&#123;success:false,message:'账号不存在'&#125;"</span>);</div><div class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"LockedAccountException"</span>.equals(message)) &#123;</div><div class="line">				out.<span class="built_in">println</span>(<span class="string">"&#123;success:false,message:'账号被锁定'&#125;"</span>);</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				out.<span class="built_in">println</span>(<span class="string">"&#123;success:false,message:'未知错误'&#125;"</span>);</div><div class="line">			&#125;</div><div class="line">			out.flush();</div><div class="line">			out.close();</div><div class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line"></div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// 所有请求都会经过的方法</span></div><div class="line">	@Override</div><div class="line">	<span class="keyword">protected</span> <span class="built_in">boolean</span> onAccessDenied(ServletRequest request, ServletResponse response) <span class="keyword">throws</span> Exception &#123;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.isLoginRequest(request, response)) &#123;</div><div class="line">			<span class="keyword">if</span> (<span class="keyword">this</span>.isLoginSubmission(request, response)) &#123;</div><div class="line">				<span class="keyword">if</span> (<span class="built_in">log</span>.isTraceEnabled()) &#123;</div><div class="line">					<span class="built_in">log</span>.trace(<span class="string">"Login submission detected. Attempting to execute login."</span>);</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">if</span> (<span class="string">"XMLHttpRequest"</span>.equalsIgnoreCase(((HttpServletRequest) request).getHeader(<span class="string">"X-Requested-With"</span>))) &#123;</div><div class="line">					<span class="keyword">String</span> vcode = request.getParameter(<span class="string">"vcode"</span>);</div><div class="line">					HttpServletRequest httpservletrequest = (HttpServletRequest) request;</div><div class="line">					<span class="keyword">String</span> vvcode = (<span class="keyword">String</span>) httpservletrequest.getSession()</div><div class="line">							.getAttribute(com.google.code.kaptcha.Constants.KAPTCHA_SESSION_KEY);</div><div class="line">					<span class="keyword">if</span> (vvcode == <span class="keyword">null</span> || <span class="string">""</span>.equals(vvcode) || !vvcode.equals(vcode)) &#123;</div><div class="line">						response.setCharacterEncoding(<span class="string">"UTF-8"</span>);</div><div class="line">						PrintWriter out = response.getWriter();</div><div class="line">						out.<span class="built_in">println</span>(<span class="string">"&#123;success:false,message:'验证码错误'&#125;"</span>);</div><div class="line">						out.flush();</div><div class="line">						out.close();</div><div class="line">						<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">return</span> executeLogin(request, response);</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				<span class="keyword">if</span> (<span class="built_in">log</span>.isTraceEnabled()) &#123;</div><div class="line">					<span class="built_in">log</span>.trace(<span class="string">"Login page view."</span>);</div><div class="line">				&#125;</div><div class="line">				<span class="comment">// allow them to see the login page ;)  </span></div><div class="line">				<span class="comment">// 返回true表示需要继续处理</span></div><div class="line">				<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">if</span> (<span class="built_in">log</span>.isTraceEnabled()) &#123;</div><div class="line">				<span class="built_in">log</span>.trace(<span class="string">"Attempting to access a path which requires authentication. "</span> + </div><div class="line">					<span class="string">"Forwarding to the Authentication url ["</span> + getLoginUrl() + <span class="string">"]"</span>);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> (WebUtils.isAjaxRequest(request)) &#123;</div><div class="line">				<span class="comment">// ...</span></div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				<span class="keyword">this</span>.saveRequestAndRedirectToLogin(request, response);</div><div class="line">			&#125;</div><div class="line">			<span class="comment">// 返回false表示该拦截器实例已经处理了，将直接返回即可</span></div><div class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>前端处理返回值</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 判断是否登录，没登录刷新当前页，促使Shiro拦截后跳转登录页</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">isLogin</span><span class="params">(result)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (result &amp;&amp; result.login_status &amp;&amp; result.login_status == <span class="number">300</span>) &#123;</div><div class="line">		window.location.reload(<span class="keyword">true</span>); <span class="comment">// 刷新当前页</span></div><div class="line">	&#125;</div><div class="line">	<span class="comment">// 这么写除了炫技还有意义吗，节约字节？</span></div><div class="line">	<span class="keyword">return</span> !<span class="number">0</span>; <span class="comment">// 返回true</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 改变状态</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">changeSessionStatus</span><span class="params">(sessionIds, status, self)</span> </span>&#123;</div><div class="line">	status = !parseInt(status);</div><div class="line">	<span class="comment">// loading</span></div><div class="line">	<span class="keyword">var</span> load = layer.load();</div><div class="line">	$.post(<span class="string">"$&#123;basePath&#125;/member/changeSessionStatus.shtml"</span>, &#123;status: status, sessionIds: sessionIds&#125;, <span class="function"><span class="keyword">function</span> <span class="params">(result)</span> </span>&#123;</div><div class="line">		layer.close(load);</div><div class="line">		<span class="keyword">if</span> (isLogin(result)) &#123; <span class="comment">// 判断是否登录</span></div><div class="line">			<span class="keyword">if</span> (result &amp;&amp; result.status == <span class="number">200</span>) &#123;</div><div class="line">				<span class="comment">// 这个return简直</span></div><div class="line">				<span class="keyword">return</span> <span class="keyword">self</span>.text(result.sessionStatusText),</div><div class="line">					<span class="keyword">self</span>.attr(<span class="string">'status'</span>, result.sessionStatus),</div><div class="line">					<span class="keyword">self</span>.<span class="keyword">parent</span>().prev().text(result.sessionStatusTextTd);</div><div class="line">				<span class="comment">// 为什么return后面还有这东西？？？神马？？？</span></div><div class="line">				layer.msg(<span class="string">'操作成功'</span>), !<span class="number">1</span>;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				<span class="comment">// 还可以return多个值？还是说前面那个没有返回值？</span></div><div class="line">				<span class="keyword">return</span> layer.msg(result.message, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;&#125;), !<span class="number">1</span>;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;, <span class="string">'json'</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 这些写法简直</span></div><div class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">$</span>) </span>&#123;</div><div class="line">	<span class="comment">// 备份jquery的ajax方法  </span></div><div class="line">	<span class="keyword">var</span> _ajax = $.ajax;</div><div class="line">	<span class="comment">// 重写jquery的ajax方法  </span></div><div class="line">	$.ajax = <span class="function"><span class="keyword">function</span> (<span class="params">opt</span>) </span>&#123;</div><div class="line">		<span class="comment">// 备份opt中error和success方法  </span></div><div class="line">		<span class="keyword">var</span> fn = &#123;</div><div class="line">			<span class="attr">error</span>: <span class="function"><span class="keyword">function</span> (<span class="params">XMLHttpRequest, textStatus, errorThrown</span>) </span>&#123;</div><div class="line">			&#125;,</div><div class="line">			<span class="attr">success</span>: <span class="function"><span class="keyword">function</span> (<span class="params">data, textStatus</span>) </span>&#123;</div><div class="line">			&#125;</div><div class="line">		&#125;;</div><div class="line">		<span class="keyword">if</span> (opt.error) &#123;</div><div class="line">			fn.error = opt.error;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (opt.success) &#123;</div><div class="line">			fn.success = opt.success;</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// 扩展增强处理  </span></div><div class="line">		<span class="keyword">var</span> _opt = $.extend(opt, &#123;</div><div class="line">			<span class="attr">error</span>: <span class="function"><span class="keyword">function</span> (<span class="params">XMLHttpRequest, textStatus, errorThrown</span>) </span>&#123;</div><div class="line">				<span class="comment">// 错误方法增强处理  </span></div><div class="line">				fn.error(XMLHttpRequest, textStatus, errorThrown);</div><div class="line">			&#125;,</div><div class="line">			<span class="attr">success</span>: <span class="function"><span class="keyword">function</span> (<span class="params">data, textStatus, xhr</span>) </span>&#123;</div><div class="line">				<span class="comment">// 成功回调方法增强处理  </span></div><div class="line">				<span class="keyword">if</span> (data.code == <span class="string">'OSS.001'</span>) &#123;</div><div class="line">					parent.location.href = contextPath + <span class="string">'/sys/manager/index'</span>;</div><div class="line">					<span class="keyword">return</span>;</div><div class="line">				&#125;</div><div class="line">				fn.success(data, textStatus);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">		_ajax(_opt);</div><div class="line">	&#125;;</div><div class="line">&#125;)(jQuery);</div></pre></td></tr></table></figure>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


		<footer>
			
<p>Powered by <a href="https://hexo.io">Hexo</a> with <a href="https://github.com/wayou/hexo-theme-material">Material</a> theme modified by <b> Huangzhike </b></p>
<p>&copy; 2018 <a href="https://huangzhike.github.io"><b> Huangzhike </b></a></p>
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

		</footer>
	</div>
	<!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
	<script src="/js/highlight.js"></script> 
	<script>hljs.initHighlightingOnLoad();var timeEnd = new Date();console.log('耗时：' + (timeEnd - timeStart));</script>
	<!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
	<!-- material design -->
	<!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
	<!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
	<!-- toc -->
	<!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
	<!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
	<!-- <script src="/js/main.js"></script> -->
</body>
</html>
