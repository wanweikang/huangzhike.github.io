<!DOCTYPE HTML>
<html>
	<head>
		<meta charset="utf-8">
				<script>var timeStart = new Date();</script>
		
		<title>[笔记]-Shiro-源码 | 一个放笔记的地方而已</title>
		
		<meta name="author" content="Huangzhike">
		
		
		<meta name="description" content="用手记笔记，用心记笔记，用脑记笔记">
		
		
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		
		<meta property="og:title" content="[笔记]-Shiro-源码"/>
		
		<meta property="og:site_name" content="一个放笔记的地方而已"/>
		
		
		<!-- favicon -->
		<link rel="icon" type="image/ico" href="/ok.ico" sizes="32x32">
 


		<meta name="msapplication-TileColor" content="#009688">
		<meta name="msapplication-TileImage" content="/mstile-144x144.ico">
		<meta name="theme-color" content="#009688">

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Didact+Gothic"> 

		<!-- favicon end -->
		<!-- <link href="//ok.ico" rel="icon"> -->
		
		<!-- toc -->
		<!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
		<!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
		<!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
		<!-- material design -->
		<!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
		<!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
		<!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
		<!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
		<!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
		<link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
		 
		 
		<!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
		<!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
	</head>

<body>
	<nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">菜单</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" href="/">一个放笔记的地方而已</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/" title="">
						<i class="fa fa-home"></i>Index
					</a>
				</li>
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

	<div class="container" >
		<div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[笔记]-Shiro-源码</h2>
				
				<div>
					<span class="post-time">2018-01-30 12:55:17</span>
				</div>	
				
				<div class="article-content">
				<ul>
<li><a href="https://www.cnblogs.com/davidwang456/p/4428421.html" target="_blank" rel="external">来源</a></li>
</ul>
<p>用户根据表单信息填写用户名和密码，然后调用登陆按钮：</p>
<figure class="highlight pony"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="type">UsernamePasswordToken</span> token = <span class="function"><span class="keyword">new</span> <span class="title">UsernamePasswordToken</span>(loginForm.getUsername(), <span class="title">loginForm</span>.<span class="title">getPassphrase</span>());</span></div><div class="line"></div><div class="line"><span class="title">token</span>.<span class="title">setRememberMe</span>(true);</div><div class="line"></div><div class="line"><span class="title">Subject</span> <span class="title">currentUser</span> = <span class="title">SecurityUtils</span>.<span class="title">getSubject</span>();</div><div class="line"></div><div class="line"><span class="title">currentUser</span>.<span class="title">login</span>(token);</div></pre></td></tr></table></figure>
<p>代理DelegatingSubject继承Subject执行login：</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> login(AuthenticationToken token) <span class="keyword">throws</span> AuthenticationException &#123;</div><div class="line">	clearRunAsIdentitiesInternal();</div><div class="line">	Subject subject = securityManager.login(<span class="keyword">this</span>, token);</div><div class="line"></div><div class="line">	PrincipalCollection principals;</div><div class="line"></div><div class="line">	<span class="keyword">String</span> host = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (subject <span class="keyword">instanceof</span> DelegatingSubject) &#123;</div><div class="line">		DelegatingSubject delegating = (DelegatingSubject) subject;</div><div class="line">		<span class="comment">// we have to do this in case there are assumed identities - we don't want to lose the 'real' principals:</span></div><div class="line">		principals = delegating.principals;</div><div class="line">		host = delegating.host;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		principals = subject.getPrincipals();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (principals == <span class="keyword">null</span> || principals.isEmpty()) &#123;</div><div class="line">		<span class="keyword">String</span> msg = <span class="string">"Principals returned from securityManager.login( token ) returned a null or "</span> +</div><div class="line">				<span class="string">"empty value.  This value must be non null and populated with one or more elements."</span>;</div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(msg);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">this</span>.principals = principals;</div><div class="line">	<span class="keyword">this</span>.authenticated = <span class="keyword">true</span>;</div><div class="line">	<span class="keyword">if</span> (token <span class="keyword">instanceof</span> HostAuthenticationToken) &#123;</div><div class="line">		host = ((HostAuthenticationToken) token).getHost();</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (host != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">this</span>.host = host;</div><div class="line">	&#125;</div><div class="line">	Session session = subject.getSession(<span class="keyword">false</span>);</div><div class="line">	<span class="keyword">if</span> (session != <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">this</span>.session = decorate(session);</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="keyword">this</span>.session = <span class="keyword">null</span>;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>调用DefaultSecurityManager继承SessionsSecurityManager执行login方法：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Subject <span class="title">login</span><span class="params">(Subject subject, AuthenticationToken token)</span> throws AuthenticationException </span>&#123;</div><div class="line">	AuthenticationInfo info;</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		info = authenticate(token);</div><div class="line">	&#125; <span class="keyword">catch</span> (AuthenticationException ae) &#123;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			onFailedLogin(token, ae, subject);</div><div class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">			<span class="keyword">if</span> (<span class="built_in">log</span>.isInfoEnabled()) &#123;</div><div class="line">				<span class="built_in">log</span>.info(<span class="string">"onFailedLogin method threw an "</span> +</div><div class="line">						<span class="string">"exception.  Logging and propagating original AuthenticationException."</span>, e);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">throw</span> ae; <span class="comment">// propagate</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	Subject loggedIn = createSubject(token, info, subject);</div><div class="line"></div><div class="line">	onSuccessfulLogin(token, info, loggedIn);</div><div class="line"></div><div class="line">	<span class="keyword">return</span> loggedIn;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>认证管理器AuthenticatingSecurityManager继承RealmSecurityManager执行authenticate方法：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Delegates to the wrapped &#123;<span class="doctag">@link</span> org.apache.shiro.authc.Authenticator Authenticator&#125; for authentication.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="function">AuthenticationInfo <span class="title">authenticate</span><span class="params">(AuthenticationToken token)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">this</span>.authenticator.authenticate(token);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>抽象认证管理器AbstractAuthenticator继承Authenticator, LogoutAware 执行authenticate方法：</p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line">public final AuthenticationInfo authenticate(AuthenticationToken <span class="built_in">token</span>) throws AuthenticationException &#123;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (<span class="built_in">token</span> == <span class="built_in">null</span>) &#123;</div><div class="line">		throw <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Method argumet (authentication token) cannot be null."</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="built_in">log</span>.<span class="keyword">trace</span>(<span class="string">"Authentication attempt received for token [&#123;&#125;]"</span>, <span class="built_in">token</span>);</div><div class="line"></div><div class="line">	AuthenticationInfo info;</div><div class="line">	try &#123;</div><div class="line">		info = doAuthenticate(<span class="built_in">token</span>);</div><div class="line">		<span class="keyword">if</span> (info == <span class="built_in">null</span>) &#123;</div><div class="line">			<span class="keyword">String</span> msg = <span class="string">"No account information found for authentication token ["</span> + <span class="built_in">token</span> + <span class="string">"] by this "</span> +</div><div class="line">					<span class="string">"Authenticator instance.  Please check that it is configured correctly."</span>;</div><div class="line">			throw <span class="keyword">new</span> AuthenticationException(msg);</div><div class="line">		&#125;</div><div class="line">	&#125; catch (Throwable t) &#123;</div><div class="line">		AuthenticationException ae = <span class="built_in">null</span>;</div><div class="line">		<span class="keyword">if</span> (t instanceof AuthenticationException) &#123;</div><div class="line">			ae = (AuthenticationException) t;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (ae == <span class="built_in">null</span>) &#123;</div><div class="line">			<span class="comment">// Exception thrown was not an expected AuthenticationException.</span></div><div class="line">			<span class="comment">// Therefore it is probably a little more severe or unexpected.  </span></div><div class="line">			<span class="comment">// So, wrap in an AuthenticationException, log to warn, and propagate:</span></div><div class="line">			<span class="keyword">String</span> msg = <span class="string">"Authentication failed for token submission ["</span> + <span class="built_in">token</span> + <span class="string">"].  Possible unexpected "</span> +</div><div class="line">					<span class="string">"error? (Typical or expected login exceptions should extend from AuthenticationException)."</span>;</div><div class="line">			ae = <span class="keyword">new</span> AuthenticationException(msg, t);</div><div class="line">		&#125;</div><div class="line">		try &#123;</div><div class="line">			notifyFailure(<span class="built_in">token</span>, ae);</div><div class="line">		&#125; catch (Throwable t2) &#123;</div><div class="line">			<span class="keyword">if</span> (<span class="built_in">log</span>.isWarnEnabled()) &#123;</div><div class="line">				<span class="keyword">String</span> msg = <span class="string">"Unable to send notification for failed authentication attempt - listener error?.  "</span> +</div><div class="line">						<span class="string">"Please check your AuthenticationListener implementation(s).  Logging sending exception "</span> +</div><div class="line">						<span class="string">"and propagating original AuthenticationException instead..."</span>;</div><div class="line">				<span class="built_in">log</span>.warn(msg, t2);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line"></div><div class="line">		throw ae;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="built_in">log</span>.<span class="keyword">debug</span>(<span class="string">"Authentication successful for token [&#123;&#125;].  Returned account [&#123;&#125;]"</span>, <span class="built_in">token</span>, info);</div><div class="line"></div><div class="line">	notifySuccess(<span class="built_in">token</span>, info);</div><div class="line"></div><div class="line">	<span class="keyword">return</span> info;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ModularRealmAuthenticator继承AbstractAuthenticator执行doAuthenticate方法</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="function">AuthenticationInfo <span class="title">doAuthenticate</span><span class="params">(AuthenticationToken authenticationToken)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</div><div class="line">	assertRealmsConfigured();</div><div class="line">	Collection&lt;Realm&gt; realms = getRealms();</div><div class="line">	<span class="keyword">if</span> (realms.size() == <span class="number">1</span>) &#123;</div><div class="line">		<span class="keyword">return</span> doSingleRealmAuthentication(realms.iterator().next(), authenticationToken);</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="function"><span class="keyword">return</span> <span class="title">doMultiRealmAuthentication</span><span class="params">(realms, authenticationToken)</span></span>;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接着调用：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Performs the authentication attempt by interacting with the single configured realm, which is significantly</div><div class="line"> * simpler than performing multi-realm logic.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> realm the realm to consult for AuthenticationInfo.</div><div class="line"> * <span class="doctag">@param</span> token the submitted AuthenticationToken representing the subject's (user's) log-in principals and credentials.</div><div class="line"> * <span class="doctag">@return</span> the AuthenticationInfo associated with the user account corresponding to the specified &#123;<span class="doctag">@code</span> token&#125;</div><div class="line"> */</div><div class="line"><span class="keyword">protected</span> <span class="function">AuthenticationInfo <span class="title">doSingleRealmAuthentication</span><span class="params">(Realm realm, AuthenticationToken token)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (!realm.supports(token)) &#123;</div><div class="line">		String msg = <span class="string">"Realm ["</span> + realm + <span class="string">"] does not support authentication token ["</span> +</div><div class="line">				token + <span class="string">"].  Please ensure that the appropriate Realm implementation is "</span> +</div><div class="line">				<span class="string">"configured correctly or that the realm accepts AuthenticationTokens of this type."</span>;</div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedTokenException(msg);</div><div class="line">	&#125;</div><div class="line">	AuthenticationInfo info = realm.getAuthenticationInfo(token);</div><div class="line">	<span class="keyword">if</span> (info == <span class="keyword">null</span>) &#123;</div><div class="line">		String msg = <span class="string">"Realm ["</span> + realm + <span class="string">"] was unable to find account data for the "</span> +</div><div class="line">				<span class="string">"submitted AuthenticationToken ["</span> + token + <span class="string">"]."</span>;</div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> UnknownAccountException(msg);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> info;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>AuthenticatingRealm继承CachingRealm执行getAuthenticationInfo方法</p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">public final AuthenticationInfo getAuthenticationInfo(AuthenticationToken <span class="built_in">token</span>) throws AuthenticationException &#123;</div><div class="line"></div><div class="line">	AuthenticationInfo info = getCachedAuthenticationInfo(<span class="built_in">token</span>); <span class="comment">// 从缓存中读取</span></div><div class="line">	<span class="keyword">if</span> (info == <span class="built_in">null</span>) &#123;</div><div class="line">		<span class="comment">// otherwise not cached, perform the lookup:</span></div><div class="line">		info = doGetAuthenticationInfo(<span class="built_in">token</span>); <span class="comment">// 缓存中读不到，则到数据库或者ldap或者jndi等去读</span></div><div class="line">		<span class="built_in">log</span>.<span class="keyword">debug</span>(<span class="string">"Looked up AuthenticationInfo [&#123;&#125;] from doGetAuthenticationInfo"</span>, info);</div><div class="line">		<span class="keyword">if</span> (<span class="built_in">token</span> != <span class="built_in">null</span> &amp;&amp; info != <span class="built_in">null</span>) &#123;</div><div class="line">			cacheAuthenticationInfoIfPossible(<span class="built_in">token</span>, info);</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="built_in">log</span>.<span class="keyword">debug</span>(<span class="string">"Using cached authentication info [&#123;&#125;] to perform credentials matching."</span>, info);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (info != <span class="built_in">null</span>) &#123;</div><div class="line">		assertCredentialsMatch(<span class="built_in">token</span>, info);</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="built_in">log</span>.<span class="keyword">debug</span>(<span class="string">"No AuthenticationInfo found for submitted AuthenticationToken [&#123;&#125;].  Returning null."</span>, <span class="built_in">token</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> info;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从缓存中读取的方法：</p>
<figure class="highlight vbscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Checks <span class="keyword">to</span> see <span class="keyword">if</span> the authenticationCache <span class="keyword">class</span> attribute <span class="keyword">is</span> <span class="literal">null</span>, <span class="keyword">and</span> <span class="keyword">if</span> so, attempts <span class="keyword">to</span> acquire one from</div><div class="line"> * any configured &#123;@link #getCacheManager() cacheManager&#125;.  <span class="keyword">If</span> one <span class="keyword">is</span> acquired, it <span class="keyword">is</span> <span class="keyword">set</span> as the <span class="keyword">class</span> attribute.</div><div class="line"> * The <span class="keyword">class</span> attribute <span class="keyword">is</span> <span class="keyword">then</span> returned.</div><div class="line"> *</div><div class="line"> * @return an available cache instance <span class="keyword">to</span> be used <span class="keyword">for</span> authentication caching <span class="keyword">or</span> &#123;@code <span class="literal">null</span>&#125; <span class="keyword">if</span> one <span class="keyword">is</span> <span class="keyword">not</span> available.</div><div class="line"> * @since <span class="number">1.2</span></div><div class="line"> */</div><div class="line"><span class="keyword">private</span> Cache&lt;Object, AuthenticationInfo&gt; getAuthenticationCacheLazy() &#123;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> (this.authenticationCache == <span class="literal">null</span>) &#123;</div><div class="line"></div><div class="line">		<span class="built_in">log</span>.trace(<span class="string">"No authenticationCache instance set.  Checking for a cacheManager..."</span>);</div><div class="line"></div><div class="line">		CacheManager cacheManager = getCacheManager();</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (cacheManager != <span class="literal">null</span>) &#123;</div><div class="line">			<span class="built_in">String</span> cacheName = getAuthenticationCacheName();</div><div class="line">			<span class="built_in">log</span>.debug(<span class="string">"CacheManager [&#123;&#125;] configured.  Building authentication cache '&#123;&#125;'"</span>, cacheManager, cacheName);</div><div class="line">			this.authenticationCache = cacheManager.getCache(cacheName);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	return this.authenticationCache;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从数据库中读取的方法：<br>继承 AuthorizingRealm执行doGetAuthenticationInfo方法</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken token) <span class="keyword">throws</span> AuthenticationException &#123;</div><div class="line"></div><div class="line">	UsernamePasswordToken upToken = (UsernamePasswordToken) token;</div><div class="line">	<span class="keyword">String</span> username = upToken.getUsername();</div><div class="line"></div><div class="line">	<span class="comment">// Null username is invalid</span></div><div class="line">	<span class="keyword">if</span> (username == <span class="keyword">null</span>) &#123;</div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> AccountException(<span class="string">"Null usernames are not allowed by this realm."</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	Connection conn = <span class="keyword">null</span>;</div><div class="line">	SimpleAuthenticationInfo info = <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		conn = dataSource.getConnection();</div><div class="line"></div><div class="line">		<span class="keyword">String</span> password = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">String</span> salt = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">switch</span> (saltStyle) &#123;</div><div class="line">		<span class="keyword">case</span> NO_SALT:</div><div class="line">			password = getPasswordForUser(conn, username)[<span class="number">0</span>];</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> CRYPT:</div><div class="line">			<span class="comment">// <span class="doctag">TODO:</span> separate password and hash from getPasswordForUser[0]</span></div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> ConfigurationException(<span class="string">"Not implemented yet"</span>);</div><div class="line">			<span class="comment">// break;</span></div><div class="line">		<span class="keyword">case</span> COLUMN:</div><div class="line">			<span class="keyword">String</span>[] queryResults = getPasswordForUser(conn, username);</div><div class="line">			password = queryResults[<span class="number">0</span>];</div><div class="line">			salt = queryResults[<span class="number">1</span>];</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		<span class="keyword">case</span> EXTERNAL:</div><div class="line">			password = getPasswordForUser(conn, username)[<span class="number">0</span>];</div><div class="line">			salt = getSaltForUser(username);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> (password == <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> UnknownAccountException(<span class="string">"No account found for user ["</span> + username + <span class="string">"]"</span>);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		info = <span class="keyword">new</span> SimpleAuthenticationInfo(username, password.toCharArray(), getName());</div><div class="line">		</div><div class="line">		<span class="keyword">if</span> (salt != <span class="keyword">null</span>) &#123;</div><div class="line">			info.setCredentialsSalt(ByteSource.Util.bytes(salt));</div><div class="line">		&#125;</div><div class="line"></div><div class="line">	&#125; <span class="keyword">catch</span> (SQLException e) &#123;</div><div class="line">		<span class="keyword">final</span> <span class="keyword">String</span> message = <span class="string">"There was a SQL error while authenticating user ["</span> + username + <span class="string">"]"</span>;</div><div class="line">		<span class="keyword">if</span> (<span class="built_in">log</span>.isErrorEnabled()) &#123;</div><div class="line">			<span class="built_in">log</span>.error(message, e);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// Rethrow any SQL errors as an authentication exception</span></div><div class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> AuthenticationException(message, e);</div><div class="line">	&#125; <span class="keyword">finally</span> &#123;</div><div class="line">		JdbcUtils.closeConnection(conn);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> info;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接着调用sql语句：</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">String</span>[] getPasswordForUser(Connection conn, <span class="keyword">String</span> username) <span class="keyword">throws</span> SQLException &#123;</div><div class="line"></div><div class="line">	<span class="keyword">String</span>[] result;</div><div class="line">	<span class="built_in">boolean</span> returningSeparatedSalt = <span class="keyword">false</span>;</div><div class="line">	<span class="keyword">switch</span> (saltStyle) &#123;</div><div class="line">	<span class="keyword">case</span> NO_SALT:</div><div class="line">	<span class="keyword">case</span> CRYPT:</div><div class="line">	<span class="keyword">case</span> EXTERNAL:</div><div class="line">		result = <span class="keyword">new</span> <span class="keyword">String</span>[<span class="number">1</span>];</div><div class="line">		<span class="keyword">break</span>;</div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		result = <span class="keyword">new</span> <span class="keyword">String</span>[<span class="number">2</span>];</div><div class="line">		returningSeparatedSalt = <span class="keyword">true</span>;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	PreparedStatement ps = <span class="keyword">null</span>;</div><div class="line">	ResultSet rs = <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		ps = conn.prepareStatement(authenticationQuery);</div><div class="line">		ps.setString(<span class="number">1</span>, username);</div><div class="line"></div><div class="line">		<span class="comment">// Execute query</span></div><div class="line">		rs = ps.executeQuery();</div><div class="line"></div><div class="line">		<span class="comment">// Loop over results - although we are only expecting one result, since usernames should be unique</span></div><div class="line">		<span class="built_in">boolean</span> foundResult = <span class="keyword">false</span>;</div><div class="line">		<span class="keyword">while</span> (rs.next()) &#123;</div><div class="line"></div><div class="line">			<span class="comment">// Check to ensure only one row is processed</span></div><div class="line">			<span class="keyword">if</span> (foundResult) &#123;</div><div class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> AuthenticationException(<span class="string">"More than one user row found for user ["</span> + username + <span class="string">"]. Usernames must be unique."</span>);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			result[<span class="number">0</span>] = rs.getString(<span class="number">1</span>);</div><div class="line">			<span class="keyword">if</span> (returningSeparatedSalt) &#123;</div><div class="line">				result[<span class="number">1</span>] = rs.getString(<span class="number">2</span>);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			foundResult = <span class="keyword">true</span>;</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">finally</span> &#123;</div><div class="line">		JdbcUtils.closeResultSet(rs);</div><div class="line">		JdbcUtils.closeStatement(ps);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中authenticationQuery定义如下：<br><figure class="highlight processing"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="keyword">String</span> authenticationQuery = DEFAULT_AUTHENTICATION_QUERY;</div><div class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">String</span> DEFAULT_AUTHENTICATION_QUERY = <span class="string">"select password from users where username = ?"</span>;</div></pre></td></tr></table></figure></p>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


		<footer>
			 
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

		</footer>
	</div>
	<!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
	<script src="/js/highlight.js"></script> 
	<script>hljs.initHighlightingOnLoad();var timeEnd = new Date();console.log('耗时：' + (timeEnd - timeStart));</script>
	<!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
	<!-- material design -->
	<!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
	<!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
	<!-- toc -->
	<!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
	<!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
	<!-- <script src="/js/main.js"></script> -->
</body>
</html>
