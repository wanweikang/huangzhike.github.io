<!DOCTYPE HTML>
<html>
	<head>
		<meta charset="utf-8">
				<script>var timeStart = new Date();</script>
		
		<title>[笔记]-高性能代码及优化-DOM | 一个放笔记的地方而已</title>
		
		<meta name="author" content="Huangzhike">
		
		
		<meta name="description" content="用手记笔记，用心记笔记，用脑记笔记">
		
		
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		
		<meta property="og:title" content="[笔记]-高性能代码及优化-DOM"/>
		
		<meta property="og:site_name" content="一个放笔记的地方而已"/>
		
		
		<!-- favicon -->
		<link rel="icon" type="image/ico" href="/ok.ico" sizes="32x32">
 


		<meta name="msapplication-TileColor" content="#009688">
		<meta name="msapplication-TileImage" content="/mstile-144x144.ico">
		<meta name="theme-color" content="#009688">

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Didact+Gothic"> 

		<!-- favicon end -->
		<!-- <link href="//ok.ico" rel="icon"> -->
		
		<!-- toc -->
		<!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
		<!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
		<!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
		<!-- material design -->
		<!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
		<!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
		<!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
		<!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
		<!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
		<link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
		 
		 
		<!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
		<!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
	</head>

<body>
	<nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">菜单</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" href="/">一个放笔记的地方而已</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/" title="">
						<i class="fa fa-home"></i>Index
					</a>
				</li>
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

	<div class="container" >
		<div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[笔记]-高性能代码及优化-DOM</h2>
				
				<div>
					<span class="post-time">2016-11-01 18:20:07</span>
				</div>	
				
				<div class="article-content">
				<p><strong>2016-11-22重新整理更新</strong></p>
<ul>
<li><p>减少 DOM 元素数量</p>
<ul>
<li>DOM 元素过多导致元素定位缓慢。</li>
<li>大量的 DOM 接口调用。</li>
<li>JavaScript 和 DOM 之间的交互需要通过函数 API 完成，造成延时，尤其循环语句。</li>
<li>DOM 操作触发频繁的 reflow(layout) 和 repaint 。</li>
</ul>
</li>
<li><p>layout 在 repaint 之前，layout 造成更多性能损耗。</p>
</li>
<li>reflow(layout) 就是计算页面元素的几何信息。对 DOM 操作会导致浏览器回流 reflow 。</li>
<li><p>repaint 就是绘制页面元素。</p>
</li>
<li><p>回流 reflow 发生场景</p>
<ul>
<li>改变窗体大小。</li>
<li>更改字体。</li>
<li>添加移除stylesheet块。</li>
<li>内容改变哪怕是输入框输入文字。</li>
<li>CSS伪类被触发如 :hover。</li>
<li>更改元素的className。</li>
<li>对DOM节点执行新增或者删除操作或内容更改时。</li>
<li>动态设置style样式（比如element.style.width=”10px”）。</li>
<li>当获取一个必须经过计算的尺寸值时，比如访问offsetWidth、clientHeight或者其他需要经过计算的CSS值。</li>
</ul>
</li>
<li><p>每次修改元素的style属性都会触发回流。</p>
<ul>
<li>用 className 替换多个 style.xxx=xxx 语句。</li>
<li>用 style.cssText = ‘’; 一次写入样式。</li>
<li>避免设置过多的行内样式。</li>
<li>添加的结构外元素尽量设置它们的位置为 fixed 或 absolute 。</li>
<li>避免使用表格来布局。</li>
<li>设置该元素的display样式为“none”。</li>
<li>在对DOM操作之前，把要操作的元素，先从当前DOM结构中删除：removeChild()或replaceChild()</li>
<li>避免在 CSS 中使用 JavaScript expressions(IE only) 。</li>
<li>将获取的 DOM 数据缓存起来。这种方法，对获取那些会触发回流操作的属性（比如offsetWidth 等）尤为重要。</li>
<li>当对HTMLCollection对象进行操作时，应该将访问的次数尽可能的降至最低，最简单的，你可以将length属性缓存在一个本地变量中，这样就能大幅度的提高循环的效率。</li>
</ul>
</li>
<li><p>减少元素位置操作：一般浏览器用增量reflow方式将需要reflow的操作积累到一定程度再一起触发，如果脚本获取以下属性，reflow马上执行，以得到位置信息。</p>
<ul>
<li>offsetLeft</li>
<li>offsetTop</li>
<li>offsetHeight</li>
<li>offsetWidth</li>
<li>scrollTop/Left/Width/Height</li>
<li>clientTop/Left/Width/Height</li>
<li>getComputedStyle()</li>
</ul>
</li>
<li><p>避免过分重排，重排时，浏览器需要重新计算布局位置与大小，常见重排元素:</p>
<ul>
<li>width height</li>
<li>padding</li>
<li>margin</li>
<li>display</li>
<li>border-width</li>
<li>position</li>
<li>top left right bottom</li>
<li>font-size</li>
<li>float</li>
<li>text-align</li>
<li>font-weight</li>
<li>overflow</li>
<li>font-family</li>
<li>line-height</li>
<li>vertical-align</li>
<li>clear</li>
<li>white-space</li>
<li>min-height</li>
</ul>
</li>
<li><p>如需多次访问某 DOM 节点，使用局部变量存储对它的引用。</p>
</li>
<li>谨慎处理 HTML 集合，把集合的长度缓存到变量中，并在迭代中使用它，如需经常操作集合，建议把它拷贝到数组中。</li>
<li>使用速度更快的API，如 querySelectorAll 和 firstElementChild 。</li>
<li>批量修改样式时， 离线操作 DOM 树。</li>
<li>使用缓存，减少访问布局的次数。</li>
<li>动画使用绝对定位，使用拖放代理。</li>
<li>使用事件委托减少事件处理器的数量。</li>
<li><p>优化 DOM 交互， 当访问的 DOM 已被渲染为页面的一部分，DOM 操作和交互要消耗大量时间，因为需要重新渲染页面或某部分。</p>
</li>
<li><p>避免不必要的DOM操作，当出现多次时，将它保存在变量中</p>
  <figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Not recommended</span></div><div class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</div><div class="line">	<span class="built_in">document</span>.getElementById(<span class="string">"myList"</span>).innerHTML += <span class="string">"&lt;span&gt;"</span> + i + <span class="string">"&lt;/span&gt;"</span>;</div><div class="line">&#125;</div><div class="line"><span class="comment">// Recommended</span></div><div class="line"><span class="keyword">var</span> myList = <span class="string">""</span>, myListHTML = <span class="built_in">document</span>.getElementById(<span class="string">"myList"</span>).innerHTML;</div><div class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</div><div class="line">	myList += <span class="string">"&lt;span&gt;"</span> + i + <span class="string">"&lt;/span&gt;"</span>;</div><div class="line">&#125;</div><div class="line">myListHTML = myList;</div></pre></td></tr></table></figure>
  <figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> elements = <span class="built_in">document</span>.getElementsByTagName( <span class="string">'*'</span> );</div><div class="line"><span class="comment">// 避免对全局DOM遍历，如果parent已知可以指定特定范围查询</span></div><div class="line"><span class="keyword">var</span> elements = <span class="built_in">document</span>.getElementById( <span class="string">'canvas'</span> ).getElementsByTagName ( <span class="string">'*'</span> );</div></pre></td></tr></table></figure>
</li>
<li><p>使用 cloneNode 在外部更新节点然后再通过 replace 与原始节点互换。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> orig = document.getElementById(<span class="string">'container'</span>);</div><div class="line"><span class="keyword">var</span> <span class="keyword">clone</span> = orig.cloneNode(<span class="keyword">true</span>);</div><div class="line"><span class="keyword">var</span> <span class="keyword">list</span> = [<span class="string">'foo'</span>, <span class="string">'bar'</span>, <span class="string">'baz'</span>];</div><div class="line"><span class="keyword">var</span> content;</div><div class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="keyword">list</span>.length; i++) &#123;</div><div class="line">	content = document.createTextNode(<span class="keyword">list</span>[i]);</div><div class="line">	<span class="keyword">clone</span>.appendChild(content);</div><div class="line">&#125;</div><div class="line">orig.parentNode.replaceChild(<span class="keyword">clone</span>, orig);</div></pre></td></tr></table></figure>
</li>
<li><p>即使在外面设置节点的元素再插入，由于多个节点还是会多次reflow。</p>
</li>
<li><p>优化：创建 DocumentFragment ，在其中插入节点后再添加到页面。如 JQuery 所有添加节点操作如 append ，都是 DocumentFragment 实现的。</p>
<figure class="highlight qml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">createSafeFragment(<span class="built_in">document</span>) &#123;</div><div class="line">	<span class="built_in">var</span> <span class="built_in">list</span> = nodeNames.split( <span class="string">"|"</span> ),</div><div class="line">	safeFrag = <span class="built_in">document</span>.createDocumentFragment();</div><div class="line">	<span class="keyword">if</span> (safeFrag.createElement) &#123;</div><div class="line">		<span class="keyword">while</span> (<span class="built_in">list</span>.length) &#123;</div><div class="line">			safeFrag.createElement(<span class="built_in">list</span>.pop(););</div><div class="line">		&#125;;</div><div class="line">	&#125;;</div><div class="line">	<span class="keyword">return</span> safeFrag;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
</li>
<li><p>高消耗属性在绘制前需要浏览器大量计算：</p>
<ul>
<li>box-shadows</li>
<li>border-radius</li>
<li>transparency</li>
<li>transforms</li>
<li>CSS filters（性能杀手）</li>
</ul>
</li>
<li><p>Display 属性会影响页面渲染</p>
<ul>
<li>display: inline后不应用 width、height、margin、padding 及 float；</li>
<li>display: inline-block 后不应用 float；</li>
<li>display: block 后不应用 vertical-align；</li>
<li>display: table-* 后不应用 margin 或 float；</li>
</ul>
</li>
<li><p>不滥用 Float，Float在渲染时计算量比较大</p>
</li>
<li>尽量用 requestAnimationFrame，避免 setTimeout 等</li>
<li>避免 jQuery animate() 改变每帧的样式，用 CSS 声明动画</li>
<li>用 translate 取代 absolute 定位得到更好的 fps</li>
<li>用 translate3d 右移 500px 的流畅度明显优于使用 left</li>
<li>利用硬件能力，通过 3D 变形开启 GPU 加速</li>
<li><p>Chrome 中，3D或透视变换（perspective transform）CSS属性和对 opacity 进行 CSS 动画会创建新的图层，在硬件加速渲染的优化下，GPU 完成 3D 变形等操作后，将图层进行复合操作（Compesite Layers），避免触发浏览器大面积重绘和重排。</p>
</li>
<li><p>多用 innerHTML 。两类创建 DOM 节点方法：</p>
<ul>
<li>createElement() 和 appendChild()</li>
<li>innerHTML </li>
</ul>
</li>
<li>影响页面重绘的不仅是innerHTML，如改变元素样式，位置等都会触发页面重绘。</li>
</ul>
<ul>
<li><p>设置动画元素为absolute或fixed。</p>
<ul>
<li>position: static 或 position: relative 元素应用动画效果会造成频繁的 reflow 。</li>
<li>position: absolute 或 position: fixed 的元素应用动画效果只需要 repaint 。</li>
</ul>
</li>
<li><p>规定图片的宽和高：这样在浏览器布局时，会给元素留下空白。如果一开始不规定img的宽高，浏览器如果预留大小不对，只能通过重绘纠正。</p>
</li>
<li>不要使用表格布局：表格通常导致页面重绘，浏览器是一行一行显示表格的，如果有一行的列宽和行高和之前的不一样，必须重绘。如果用它来布局，在加载的时候，有时会发现内容跳跃。</li>
<li>定义字符集：大多数浏览器（除IE6~8）会暂停页面渲染，直到找到字符集定义。不同的字符集意味着完全不同的渲染，所以在head中定义字符集。</li>
<li>不要重组DOM：增加或移除一个DOM元素都会造成浏览器重绘。而移动DOM元素相当于在一个地方删除，然后在其他地方添加。如果有很多节点要添加，不要一次加一个，一次性添加。同样适用于样式，不要在style上多次修改，最好class一次性添加。</li>
</ul>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


		<footer>
			 
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

		</footer>
	</div>
	<!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
	<script src="/js/highlight.js"></script> 
	<script>hljs.initHighlightingOnLoad();var timeEnd = new Date();console.log('耗时：' + (timeEnd - timeStart));</script>
	<!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
	<!-- material design -->
	<!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
	<!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
	<!-- toc -->
	<!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
	<!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
	<!-- <script src="/js/main.js"></script> -->
</body>
</html>
