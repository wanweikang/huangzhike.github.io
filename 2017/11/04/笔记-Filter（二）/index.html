<!DOCTYPE HTML>
<html>
	<head>
		<meta charset="utf-8">
		
		<title>[笔记]-Filter（二） | 一个放笔记的地方而已</title>
		
		<meta name="author" content="Huangzhike">
		
		
		<meta name="description" content="用手记笔记，用心记笔记，用脑记笔记">
		
		
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		
		<meta property="og:title" content="[笔记]-Filter（二）"/>
		
		<meta property="og:site_name" content="一个放笔记的地方而已"/>
		
		
		<!-- favicon -->
		<link rel="icon" type="image/ico" href="/favicon.ico" sizes="32x32">
		<link rel="manifest" href="/manifest.json">
		<meta name="msapplication-TileColor" content="#009688">
		<meta name="msapplication-TileImage" content="/mstile-144x144.ico">
		<meta name="theme-color" content="#009688">
		<script>var timeStart = new Date();</script>
		<!-- favicon end -->
		<!-- <link href="//favicon.ico" rel="icon"> -->
		
		<!-- toc -->
		<!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
		<!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
		<!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
		<!-- material design -->
		<!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
		<!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
		<!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
		<!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
		<!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
		<link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
		
		
		<!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
		<!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
	</head>

<body>
	<nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">菜单</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" href="/">一个放笔记的地方而已</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/" title="">
						<i class="fa fa-home"></i>首页
					</a>
				</li>
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>存档
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" title="我的主页">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

	<div class="container" >
		<div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[笔记]-Filter（二）</h2>
				
				<div>
					<span class="post-time">2017-11-04 9:23</span>
				</div>	
				
				<div class="article-content">
				<p>压缩响应正文内容<br><figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">package me.mmp.web.filter;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GzipFilter</span> <span class="title">implements</span> <span class="title">Filter</span> &#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span>(<span class="params">ServletRequest req, ServletResponse resp, FilterChain chain</span>)</span></div><div class="line">			throws IOException, ServletException &#123;</div><div class="line"></div><div class="line">		HttpServletRequest request = (HttpServletRequest) req;</div><div class="line">		HttpServletResponse response = (HttpServletResponse) resp;</div><div class="line"></div><div class="line">		BufferResponse myresponse = <span class="keyword">new</span> BufferResponse(response);</div><div class="line">		chain.doFilter(request, myresponse);</div><div class="line">		<span class="comment">// 拿出缓存中的数据，压缩后再打给浏览器</span></div><div class="line">		<span class="keyword">byte</span> <span class="keyword">out</span>[] = myresponse.getBuffer();</div><div class="line">		System.<span class="keyword">out</span>.println(<span class="string">"原始大小:"</span> + <span class="keyword">out</span>.length);</div><div class="line"></div><div class="line">		ByteArrayOutputStream bout = <span class="keyword">new</span> ByteArrayOutputStream();</div><div class="line">		<span class="comment">// 压缩输出流中的数据</span></div><div class="line">		GZIPOutputStream gout = <span class="keyword">new</span> GZIPOutputStream(bout);</div><div class="line">		gout.write(<span class="keyword">out</span>);</div><div class="line">		gout.close();</div><div class="line"></div><div class="line">		<span class="keyword">byte</span> gzip[] = bout.toByteArray();</div><div class="line">		System.<span class="keyword">out</span>.println(<span class="string">"压缩后的大小:"</span> + gzip.length);</div><div class="line"></div><div class="line">		response.setHeader(<span class="string">"content-encoding"</span>, <span class="string">"gzip"</span>);</div><div class="line">		response.setContentLength(gzip.length);</div><div class="line">		response.getOutputStream().write(gzip);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span>(<span class="params">FilterConfig filterConfig</span>) throws ServletException </span>&#123;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// response对象的Decorator设计模式的默认实现类HttpServletResponseWrapper</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BufferResponse</span> <span class="keyword">extends</span> <span class="title">HttpServletResponseWrapper</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="type">ByteArrayOutputStream</span> bout = <span class="keyword">new</span> <span class="type">ByteArrayOutputStream</span>();</div><div class="line">	<span class="keyword">private</span> <span class="type">PrintWriter</span> pw;</div><div class="line">	<span class="keyword">private</span> <span class="type">HttpServletResponse</span> response;</div><div class="line"></div><div class="line">	public <span class="type">BufferResponse</span>(<span class="type">HttpServletResponse</span> response) &#123;</div><div class="line">		<span class="keyword">super</span>(response);</div><div class="line">		<span class="keyword">this</span>.response = response;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	public <span class="type">ServletOutputStream</span> getOutputStream() <span class="keyword">throws</span> <span class="type">IOException</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="type">MyServletOutputStream</span>(bout);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	public <span class="type">PrintWriter</span> getWriter() <span class="keyword">throws</span> <span class="type">IOException</span> &#123;</div><div class="line">		pw = <span class="keyword">new</span> <span class="type">PrintWriter</span>(<span class="keyword">new</span> <span class="type">OutputStreamWriter</span>(bout, <span class="keyword">this</span>.response.getCharacterEncoding()));</div><div class="line">		<span class="keyword">return</span> pw;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public byte[] getBuffer() &#123;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			<span class="keyword">if</span> (pw != <span class="literal">null</span>) &#123;</div><div class="line">				pw.close();</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> (bout != <span class="literal">null</span>) &#123;</div><div class="line">				bout.flush();</div><div class="line">				<span class="keyword">return</span> bout.toByteArray();</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			<span class="keyword">return</span> <span class="literal">null</span>;</div><div class="line">		&#125; <span class="keyword">catch</span> (<span class="type">Exception</span> e) &#123;</div><div class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">RuntimeException</span>(e);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyServletOutputStream</span> <span class="keyword">extends</span> <span class="title">ServletOutputStream</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="type">ByteArrayOutputStream</span> bout;</div><div class="line"></div><div class="line">	public <span class="type">MyServletOutputStream</span>(<span class="type">ByteArrayOutputStream</span> bout) &#123;</div><div class="line">		<span class="keyword">this</span>.bout = bout;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	public void write(int b) <span class="keyword">throws</span> <span class="type">IOException</span> &#123;</div><div class="line">		<span class="keyword">this</span>.bout.write(b);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">description</span>&gt;</span>配置压缩过滤器<span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>GzipFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>me.mmp.web.filter.GzipFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></div><div class="line"><span class="comment">&lt;!--jsp文件的输出的内容都经过压缩过滤器压缩后才输出 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>GzipFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>*.jsp<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></div><div class="line">	<span class="comment">&lt;!-- 通过request.getRequestDispatcher("").forward(request, response) 访问的Jsp进行拦截 --&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">dispatcher</span>&gt;</span>FORWARD<span class="tag">&lt;/<span class="name">dispatcher</span>&gt;</span></div><div class="line">	<span class="comment">&lt;!--对于直接以URL方式访问的jsp页面进行拦截--&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">dispatcher</span>&gt;</span>REQUEST<span class="tag">&lt;/<span class="name">dispatcher</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></div></pre></td></tr></table></figure>
<p>禁止浏览器缓存页面<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> me.mmp.web.filter;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NoCacheFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest req, ServletResponse resp, FilterChain chain)</span></span></div><div class="line">			<span class="keyword">throws</span> IOException, ServletException &#123;</div><div class="line">		<span class="comment">// 把ServletRequest强转成HttpServletRequest</span></div><div class="line">		HttpServletRequest request = (HttpServletRequest) req;</div><div class="line">		<span class="comment">// 把ServletResponse强转成HttpServletResponse</span></div><div class="line">		HttpServletResponse response = (HttpServletResponse) resp;</div><div class="line">		<span class="comment">// 禁止浏览器缓存所有动态页面</span></div><div class="line">		response.setDateHeader(<span class="string">"Expires"</span>, -<span class="number">1</span>);</div><div class="line">		response.setHeader(<span class="string">"Cache-Control"</span>, <span class="string">"no-cache"</span>);</div><div class="line">		response.setHeader(<span class="string">"Pragma"</span>, <span class="string">"no-cache"</span>);</div><div class="line"></div><div class="line">		chain.doFilter(request, response);</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// 略</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>控制浏览器缓存页面中的静态资源<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> me.mmp.web.filter;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CacheFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> FilterConfig filterConfig;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest req, ServletResponse resp, FilterChain chain)</span></span></div><div class="line">			<span class="keyword">throws</span> IOException, ServletException &#123;</div><div class="line"></div><div class="line">		HttpServletRequest request = (HttpServletRequest) req;</div><div class="line">		HttpServletResponse response = (HttpServletResponse) resp;</div><div class="line">		<span class="comment">// 获取想访问的资源</span></div><div class="line">		String uri = request.getRequestURI();</div><div class="line">		<span class="comment">// 得到想访问的资源的后缀名</span></div><div class="line">		String ext = uri.substring(uri.lastIndexOf(<span class="string">"."</span>) + <span class="number">1</span>);</div><div class="line">		<span class="comment">// 得到资源需要缓存的时间</span></div><div class="line">		String time = filterConfig.getInitParameter(ext);</div><div class="line">		<span class="keyword">if</span> (time != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="keyword">long</span> t = Long.parseLong(time) * <span class="number">3600</span> * <span class="number">1000</span>;</div><div class="line">			<span class="comment">// 设置缓存</span></div><div class="line">			response.setDateHeader(<span class="string">"expires"</span>, System.currentTimeMillis() + t);</div><div class="line">		&#125;</div><div class="line">		chain.doFilter(request, response);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</div><div class="line">		<span class="keyword">this</span>.filterConfig = filterConfig;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 配置缓存过滤器 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>CacheFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>me.mmp.web.filter.CacheFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></div><div class="line">	<span class="comment">&lt;!-- 配置要缓存的web资源以及缓存时间，以小时为单位 --&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">init-param</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">param-name</span>&gt;</span>jpg<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">param-value</span>&gt;</span>1<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></div><div class="line"><span class="comment">&lt;!-- 配置要缓存的web资源的后缀--&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>CacheFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>*.jpg<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></div></pre></td></tr></table></figure>
<p>缓存数据到内存<br>对于页面中很少更新的数据，例如商品分类，为避免每次都要从数据库查询，可把分类数据缓存在内存或文件中。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> me.mmp.web.filter;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebResourceCachedFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> Map&lt;String, <span class="keyword">byte</span>[]&gt; map = <span class="keyword">new</span> HashMap&lt;String, <span class="keyword">byte</span>[]&gt;();</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest req, ServletResponse resp, FilterChain chain)</span></span></div><div class="line">			<span class="keyword">throws</span> IOException, ServletException &#123;</div><div class="line">		HttpServletRequest request = (HttpServletRequest) req;</div><div class="line">		HttpServletResponse response = (HttpServletResponse) resp;</div><div class="line">		<span class="comment">// 得到请求的uri</span></div><div class="line">		String uri = request.getRequestURI();</div><div class="line">		<span class="comment">// 看缓存中有没有uri对应的数据</span></div><div class="line">		<span class="keyword">byte</span> b[] = map.get(uri);</div><div class="line">		<span class="comment">// 如果有，直接拿，程序返回</span></div><div class="line">		<span class="keyword">if</span> (b != <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="comment">// 根据字节数组和指定的字符编码构建字符串</span></div><div class="line">			String webResourceHtmlStr = <span class="keyword">new</span> String(b, response.getCharacterEncoding());</div><div class="line">			System.out.println(webResourceHtmlStr);</div><div class="line">			response.getOutputStream().write(b);</div><div class="line">			<span class="keyword">return</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// 如果没有，让目标资源执行，并捕获输出</span></div><div class="line">		BufferResponse myresponse = <span class="keyword">new</span> BufferResponse(response);</div><div class="line">		chain.doFilter(request, myresponse);</div><div class="line">		<span class="comment">// 获取缓冲流中的内容的字节数组</span></div><div class="line">		<span class="keyword">byte</span> out[] = myresponse.getBuffer();</div><div class="line">		<span class="comment">// 把资源的数据以用户请求的uri为关键字保存到缓存中</span></div><div class="line">		map.put(uri, out);</div><div class="line">		<span class="comment">// 把数据打给浏览器</span></div><div class="line">		response.getOutputStream().write(out);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="class"><span class="keyword">class</span> <span class="title">BufferResponse</span> <span class="keyword">extends</span> <span class="title">HttpServletResponseWrapper</span> </span>&#123;</div><div class="line">		<span class="keyword">private</span> ByteArrayOutputStream bout = <span class="keyword">new</span> ByteArrayOutputStream(); <span class="comment">// 捕获输出的缓存</span></div><div class="line">		<span class="keyword">private</span> PrintWriter pw;</div><div class="line">		<span class="keyword">private</span> HttpServletResponse response;</div><div class="line"></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="title">BufferResponse</span><span class="params">(HttpServletResponse response)</span> </span>&#123;</div><div class="line">			<span class="keyword">super</span>(response);</div><div class="line">			<span class="keyword">this</span>.response = response;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">public</span> ServletOutputStream <span class="title">getOutputStream</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">			<span class="keyword">return</span> <span class="keyword">new</span> MyServletOutputStream(bout);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">public</span> PrintWriter <span class="title">getWriter</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">			pw = <span class="keyword">new</span> PrintWriter(<span class="keyword">new</span> OutputStreamWriter(bout, <span class="keyword">this</span>.response.getCharacterEncoding()));</div><div class="line">			<span class="keyword">return</span> pw;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">public</span> <span class="keyword">byte</span>[] getBuffer() &#123;</div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				<span class="keyword">if</span> (pw != <span class="keyword">null</span>) &#123;</div><div class="line">					pw.close();</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">return</span> bout.toByteArray();</div><div class="line">			&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="class"><span class="keyword">class</span> <span class="title">MyServletOutputStream</span> <span class="keyword">extends</span> <span class="title">ServletOutputStream</span> </span>&#123;</div><div class="line">		<span class="keyword">private</span> ByteArrayOutputStream bout;</div><div class="line"></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="title">MyServletOutputStream</span><span class="params">(ByteArrayOutputStream bout)</span> </span>&#123;</div><div class="line">			<span class="keyword">this</span>.bout = bout;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(<span class="keyword">int</span> b)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">			bout.write(b);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


		<footer>
			
<p>Powered by <a href="https://hexo.io">Hexo</a> with <a href="https://github.com/wayou/hexo-theme-material">Material</a> theme modified by <b> Huangzhike </b></p>
<p>&copy; 2017 <a href="https://huangzhike.github.io"><b> Huangzhike </b></a></p>
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

		</footer>
	</div>
	<!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
	<script src="/js/highlight.js"></script> 
	<script>hljs.initHighlightingOnLoad();var timeEnd = new Date();console.log('耗时：' + (timeEnd - timeStart));</script>
	<!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
	<!-- material design -->
	<!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
	<!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
	<!-- toc -->
	<!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
	<!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
	<!-- <script src="/js/main.js"></script> -->
</body>
</html>
