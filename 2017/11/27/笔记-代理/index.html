<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
        <script>
            var timeStart = new Date();
        </script>
        
        <title>[ç¬”è®°]-ä»£ç† | ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜</title>
        
        <meta name="author" content="huangzhike">
        
        
        <meta name="description" content="é™æ€ä»£ç†ï¼šä»£ç†ç±»åœ¨è¿è¡Œå‰å°±å·²å®šä¹‰å¥½ï¼Œå…¶ä¸ç›®æ ‡ç±»çš„å…³ç³»åœ¨è¿è¡Œå‰å°±å·²ç¡®ç«‹ã€‚
public interface IAccountService {
    void transfer();
}
public class AccountServiceImpl implements IAccountServi">
        
        
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        
        <meta property="og:title" content="[ç¬”è®°]-ä»£ç†"/>
        
        <meta property="og:site_name" content="ğŸŒ‘ğŸŒ’ğŸŒ“ğŸŒ”ğŸŒ•ğŸŒ–ğŸŒ—ğŸŒ˜"/>
        
        
        <!-- favicon -->
        <link rel="icon" type="image/ico" href="/ok.ico" sizes="32x32">
        <meta name="msapplication-TileColor" content="#009688">
        <meta name="msapplication-TileImage" content="/mstile-144x144.ico">
        <meta name="theme-color" content="#009688">
        <!-- favicon end -->
        <!-- <link href="//ok.ico" rel="icon"> -->
        
        <!-- toc -->
        <!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
        <!-- material design -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
        <!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
        <!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
        <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
        <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
        
        <!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
        <!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
    <meta name="generator" content="Hexo 4.2.1"></head>

<body>
    <nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">èœå•</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" title="ä¸‹ä¸€å¥æ˜¯ï¼šå®¢æœ‰å¯äººæœŸä¸æ¥ã€‚å°æ—¶å€™ï¼Œå–œæ¬¢é åœ¨é˜³å°ä¸Šï¼Œä¸€è¾¹å¹é£ï¼Œä¸€è¾¹çœ‹ä¹¦ï¼Œå–œæ¬¢è¯»ä¹¦å—ï¼Œéªšå¹´ï¼Ÿ" href="/">ä¹¦å½“å¿«æ„è¯»æ˜“å°½</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" target="_blank" rel="noopener" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

    <div class="container" >
        <div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[ç¬”è®°]-ä»£ç†</h2>
				
				<div>
					<div class="post-time">2017-11-27</div>
				</div>
				
				<div class="article-content">
				<p>é™æ€ä»£ç†ï¼šä»£ç†ç±»åœ¨è¿è¡Œå‰å°±å·²å®šä¹‰å¥½ï¼Œå…¶ä¸ç›®æ ‡ç±»çš„å…³ç³»åœ¨è¿è¡Œå‰å°±å·²ç¡®ç«‹ã€‚</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IAccountService</span> <span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token function">transfer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccountServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">IAccountService</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">transfer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccountServiceImplProxy</span> <span class="token keyword">implements</span> <span class="token class-name">IAccountService</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> IAccountService target<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">AccountServiceImplProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// ä¸šåŠ¡æ¥å£å¯¹è±¡ä½œä¸ºæ„é€ å™¨å‚æ•°ï¼Œæ¥æ”¶ç›®æ ‡å¯¹è±¡</span>
    <span class="token keyword">public</span> <span class="token function">AccountServiceImplProxy</span><span class="token punctuation">(</span>IAccountService target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>target <span class="token operator">=</span> target<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">transfer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// do sth å¯¹ç›®æ ‡ç±»å¢å¼º</span>
        target<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<pre class=" language-java"><code class="language-java">IAccountService target <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AccountServiceImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
IAccountService service <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AccountServiceImplProxy</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
service<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>ç”¨ä¸€ä¸ªä»£ç†ç±»ï¼Œè®©å®ƒä¹Ÿå®ç°IAccountServiceæ¥å£ï¼Œç„¶ååœ¨å†…éƒ¨å£°æ˜ä¸€ä¸ªAccountServiceImplï¼Œè°ƒç”¨transferæ–¹æ³•ï¼Œåœ¨è°ƒç”¨å‰ååŠ ä¸Šå…¶ä»–æ“ä½œã€‚</p>
<p>è¿™æ ·æ˜¯å†™æ­»çš„ï¼Œä»£ç†ç±»è·Ÿè¢«ä»£ç†ç±»éƒ½è¦å®ç°åŒä¸€æ¥å£ã€‚</p>
<p>é™æ€ä»£ç†æ¨¡å¼åœ¨ç¼–è¯‘çš„æ—¶å€™å°±å·²ç»ç¡®å®šä»£ç†ç±»å°†è¦ä»£ç†è°ï¼Œè€ŒåŠ¨æ€ä»£ç†åœ¨è¿è¡Œçš„æ—¶å€™æ‰çŸ¥é“è‡ªå·±è¦ä»£ç†è°ã€‚</p>
<p>åŠ¨æ€ä»£ç†å°±æ˜¯åˆ©ç”¨åå°„å’ŒåŠ¨æ€ç¼–è¯‘ï¼ŒåŸç†è·ŸåŠ¨æ€æ³¨å…¥ä¸€æ ·ã€‚</p>
<p>åŠ¨æ€ä»£ç†å¸¸ç”¨å®ç°æ–¹å¼æœ‰ä¸¤ç§ï¼š</p>
<ul>
<li>JDKåŠ¨æ€ä»£ç†<br>é€šè¿‡<code>java.lang.reflect.Proxy</code>ç±»ï¼Œä½¿ç”¨å…¶é™æ€æ–¹æ³•<code>newProxyInstance(ClassLoader loader, Class&lt;?&gt;[] interfaces, InvocationHandler handler)</code>ï¼Œä¾æ®ç›®æ ‡å¯¹è±¡ã€ä¸šåŠ¡æ¥å£åŠä¸šåŠ¡å¢å¼ºé€»è¾‘ä¸‰è€…ï¼Œè‡ªåŠ¨ç”ŸæˆåŠ¨æ€ä»£ç†å¯¹è±¡ã€‚<ul>
<li>loaderï¼šç›®æ ‡ç±»çš„ç±»åŠ è½½å™¨ï¼Œé€šè¿‡ç›®æ ‡å¯¹è±¡çš„åå°„è·å–</li>
<li>interfacesï¼šç›®æ ‡ç±»å®ç°çš„æ¥å£æ•°ç»„ï¼Œé€šè¿‡ç›®æ ‡å¯¹è±¡çš„åå°„è·å–</li>
<li>handlerï¼šä¸šåŠ¡å¢å¼ºé€»è¾‘ï¼Œéœ€è¦å†å®šä¹‰ã€‚</li>
</ul>
</li>
</ul>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// å®ç°äº† InvocationHandler æ¥å£çš„ç±»ç”¨äºåŠ å¼ºç›®æ ‡ç±»çš„ä¸»ä¸šåŠ¡é€»è¾‘</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyExtension</span> <span class="token keyword">implements</span> <span class="token class-name">InvocationHandler</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> Object target<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">MyExtension</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">MyExtension</span><span class="token punctuation">(</span>Object target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>target <span class="token operator">=</span> target<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token comment" spellcheck="true">// è°ƒç”¨ä¸»ä¸šåŠ¡é€»è¾‘æ—¶ï¼Œè‡ªåŠ¨è°ƒç”¨ invoke()ï¼Œç”±ä»£ç†å¯¹è±¡è‡ªåŠ¨è°ƒç”¨ï¼Œä¸‰ä¸ªå‚æ•°ä¸ç”¨ç¨‹åºå‘˜ç»™å‡º</span>
    <span class="token comment" spellcheck="true">// proxyï¼šç”Ÿæˆçš„ä»£ç†å¯¹è±¡</span>
    <span class="token comment" spellcheck="true">// methodï¼šç›®æ ‡æ–¹æ³•</span>
    <span class="token comment" spellcheck="true">// argsï¼šç›®æ ‡æ–¹æ³•çš„å‚æ•°</span>
    <span class="token keyword">public</span> Object <span class="token function">invoke</span><span class="token punctuation">(</span>Object proxy<span class="token punctuation">,</span> Method method<span class="token punctuation">,</span> Object<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Throwable <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// åŠ å¼ºçš„ä»£ç é€»è¾‘å®šä¹‰åœ¨invoke()</span>
        <span class="token comment" spellcheck="true">// æ— è®ºä¸»ä¸šåŠ¡æ–¹æ³•æœ‰æ— å‚æ•°ï¼Œæœ‰æ— è¿”å›å€¼ï¼Œä¸‹é¢çš„å†™æ³•ok</span>
        <span class="token keyword">return</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// å®šä¹‰ç›®æ ‡å¯¹è±¡</span>
IAccountService target <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AccountServiceImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// è·å–ç›®æ ‡å¯¹è±¡çš„ç±»åŠ è½½å™¨</span>
ClassLoader loader <span class="token operator">=</span> target<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// ç›®æ ‡å¯¹è±¡å®ç°çš„æ‰€æœ‰æ¥å£</span>
Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> interfaces <span class="token operator">=</span> target<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInterfaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// å¢—å¼ºä¸šåŠ¡é€»è¾‘</span>
InvocationHandler handler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyExtension</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// ä»£ç†å¯¹è±¡ï¼Œå¹¶ä½¿ç”¨ç›®æ ‡å¯¹è±¡åˆå§‹åŒ–å®ƒ</span>
IAccountService service <span class="token operator">=</span> <span class="token punctuation">(</span>IAccountService<span class="token punctuation">)</span> Proxy<span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>loader<span class="token punctuation">,</span> interfaces<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// å¯¹ç›®æ ‡å¯¹è±¡å¢åŠ è¿‡çš„å†…å®¹</span>
service<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<ul>
<li>CGLIBåŠ¨æ€ä»£ç†ï¼ˆé€šè¿‡ä¿®æ”¹å­—èŠ‚ç ï¼‰<br>JDKçš„Proxyè¦æ±‚ç›®æ ‡ç±»ä¸ä»£ç†ç±»å®ç°ç›¸åŒçš„æ¥å£ï¼Œè‹¥ç›®æ ‡ç±»ä¸å­˜åœ¨æ¥å£ï¼Œè¦ç”¨CGLIBæ¥å®ç°ï¼šç”Ÿæˆç›®æ ‡ç±»çš„å­ç±»ï¼Œè€Œå­ç±»æ˜¯å¢å¼ºè¿‡çš„ï¼Œå­ç±»å¯¹è±¡å°±æ˜¯ä»£ç†å¯¹è±¡ï¼Œè¦æ±‚ç›®æ ‡ç±»å¿…é¡»èƒ½è¢«ç»§æ‰¿ã€‚</li>
</ul>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// ç›®æ ‡ç±»</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccountService</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">transfer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// ä»£ç†å·¥å‚</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AccountServiceCglibProxyFactory</span> <span class="token keyword">implements</span> <span class="token class-name">MethodInterceptor</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 1. å£°æ˜ç›®æ ‡ç±»çš„æˆå‘˜å˜é‡ï¼Œå¹¶åˆ›å»ºä»¥ç›®æ ‡ç±»å¯¹è±¡ä¸ºå‚æ•°çš„æ„é€ å™¨ï¼Œæ¥æ”¶ç›®æ ‡å¯¹è±¡</span>
    <span class="token comment" spellcheck="true">// 2. å®šä¹‰ä»£ç†çš„ç”Ÿæˆæ–¹æ³•ï¼Œç”¨äºåˆ›å»ºä»£ç†å¯¹è±¡ï¼Œä»£ç†å¯¹è±¡å³ç›®æ ‡ç±»çš„å­ç±»</span>
    <span class="token comment" spellcheck="true">// 3. å®šä¹‰å›è°ƒæ¥å£æ–¹æ³•ï¼Œå¯¹ç›®æ ‡ç±»çš„å¢å¼ºåœ¨è¿™é‡Œå®Œæˆ</span>
    <span class="token keyword">private</span> AccountService target<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">AccountServiceCgliProxyFactory</span><span class="token punctuation">(</span>AccountService target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>target <span class="token operator">=</span> target<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    AccountService <span class="token function">createProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Enhancer enhancer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Enhancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        enhancer<span class="token punctuation">.</span><span class="token function">setSuperClass</span><span class="token punctuation">(</span>AccountService<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// MethodInterceptor æ¥å£æ˜¯Callbackå­æ¥å£</span>
        enhancer<span class="token punctuation">.</span><span class="token function">setCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>AccountService<span class="token punctuation">)</span> enhancer<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token comment" spellcheck="true">// proxyï¼šä»£ç†å¯¹è±¡</span>
    <span class="token comment" spellcheck="true">// methodï¼šä»£ç†å¯¹è±¡çš„æ–¹æ³•ï¼Œå³å¢å¼ºè¿‡çš„ä¸šåŠ¡æ–¹æ³•</span>
    <span class="token comment" spellcheck="true">// args[]ï¼šæ–¹æ³•å‚æ•°</span>
    <span class="token comment" spellcheck="true">// methodProxyï¼šä»£ç†å¯¹è±¡æ–¹æ³•çš„ä»£ç†å¯¹è±¡</span>
    <span class="token keyword">public</span> Object <span class="token function">intercept</span><span class="token punctuation">(</span>Object proxy<span class="token punctuation">,</span> Method method<span class="token punctuation">,</span> Object<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">,</span> MethodProxy methodProxy<span class="token punctuation">)</span> 
            <span class="token keyword">throws</span> Throwable <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// è‹¥ä¸ºtransferæ–¹æ³•ï¼Œåˆ™è¿›è¡Œå¢—å¼º</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"transfer"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"å¼€å§‹"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// è°ƒç”¨ç›®æ ‡ç±»ä¸šåŠ¡æ–¹æ³•æ–¹å¼ä¸€ï¼šé€šè¿‡è°ƒç”¨ä»£ç†ç±»å³ç›®æ ‡ç±»çš„å­ç±»çš„çˆ¶ç±»æ–¹æ³•æ‰§è¡Œ</span>
            <span class="token comment" spellcheck="true">// Object result = methodProxy.invokeSuper(proxy, args);</span>
            <span class="token comment" spellcheck="true">// è°ƒç”¨ç›®æ ‡ç±»ä¸šåŠ¡æ–¹æ³•æ–¹å¼äºŒï¼šç›´æ¥è°ƒç”¨ç›®æ ‡å¯¹è±¡çš„ä¸šåŠ¡æ–¹æ³•æ‰§è¡Œã€‚</span>
            Object result <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ç»“æŸ"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// å…¶å®ƒæ–¹æ³•ä¸å¢—å¼ºï¼Œåˆ™æ‰§è¡Œç›®æ ‡ç±»çš„ä¸šåŠ¡æ–¹å¼ï¼Œå³ä»£ç†ç±»çš„çˆ¶ç±»ä¸šåŠ¡æ–¹æ³•</span>
        <span class="token comment" spellcheck="true">// return methodProxy.invokeSuper(proxy, args);</span>
        <span class="token keyword">return</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<pre class=" language-java"><code class="language-java">AccountService target <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AccountService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
AccountService service <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AccountServiceCglibProxyFactory</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
service<span class="token punctuation">.</span><span class="token function">transfer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>åŠ¨æ€ä»£ç†ï¼šæ•°æ®åº“è¿æ¥ï¼Œäº‹åŠ¡ç®¡ç†ï¼Œå•å…ƒæµ‹è¯•çš„åŠ¨æ€ Mock å¯¹è±¡ï¼ŒAOP ä¸­çš„æ–¹æ³•æ‹¦æˆªåŠŸèƒ½ç­‰ç­‰éƒ½ç”¨åˆ°äº†åŠ¨æ€ä»£ç†ã€‚</p>
<p>ç®€å•æ¨¡æ‹Ÿ</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> mmp<span class="token punctuation">.</span>proxy<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span>Method<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">InvocationHandler</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">invoke</span><span class="token punctuation">(</span>Object o<span class="token punctuation">,</span> Method m<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>é€šè¿‡ProxyåŠ¨æ€ç”Ÿæˆå…·ä½“çš„ä»£ç†ç±»</p>
<p>åŠ¨æ€ç»„è£…ä¸€ä¸ªä»£ç†ç±»ï¼Œç”Ÿæˆ<code>$Proxy1.java</code>ï¼Œç¼–è¯‘æˆ<code>$Proxy1.class</code>ï¼Œåœ¨è¿è¡Œæ—¶ï¼Œæ ¹æ®è¢«ä»£ç†å¯¹è±¡ç”Ÿæˆä»£ç†ç±»ã€‚</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">package</span> mmp<span class="token punctuation">.</span>proxy<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Proxy</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> Object <span class="token function">newProxyInstance</span><span class="token punctuation">(</span>Class <span class="token class-name">infce</span><span class="token punctuation">,</span> InvocationHandler h<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        String methodStr <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
        String rt <span class="token operator">=</span> <span class="token string">"\r\n"</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// åˆ©ç”¨åå°„å¾—åˆ°infceçš„æ‰€æœ‰æ–¹æ³•ï¼Œå¹¶é‡æ–°ç»„è£…</span>
        Method<span class="token punctuation">[</span><span class="token punctuation">]</span> methods <span class="token operator">=</span> infce<span class="token punctuation">.</span><span class="token function">getMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>Method m <span class="token operator">:</span> methods<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            methodStr <span class="token operator">+=</span> <span class="token string">" @Override"</span> <span class="token operator">+</span> rt <span class="token operator">+</span> <span class="token string">" public "</span> <span class="token operator">+</span> m<span class="token punctuation">.</span><span class="token function">getReturnType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> m<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"() {"</span> <span class="token operator">+</span> rt <span class="token operator">+</span> <span class="token string">" try {"</span>
                    <span class="token operator">+</span> rt <span class="token operator">+</span> <span class="token string">" Method md = "</span> <span class="token operator">+</span> infce<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">".class.getMethod(\""</span> <span class="token operator">+</span> m<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\");"</span> <span class="token operator">+</span> rt
                    <span class="token operator">+</span> <span class="token string">" h.invoke(this, md);"</span> <span class="token operator">+</span> rt <span class="token operator">+</span> <span class="token string">" } catch(Exception e) {e.printStackTrace();}"</span> <span class="token operator">+</span> rt <span class="token operator">+</span> <span class="token string">" }"</span> <span class="token operator">+</span> rt<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// ç”ŸæˆJavaæºæ–‡ä»¶</span>
        String srcCode <span class="token operator">=</span> <span class="token string">"package mmp.proxy;"</span> <span class="token operator">+</span> rt <span class="token operator">+</span> <span class="token string">"import java.lang.reflect.Method;"</span> <span class="token operator">+</span> rt
                <span class="token operator">+</span> <span class="token string">"public class $Proxy1 implements "</span> <span class="token operator">+</span> infce<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"{"</span> <span class="token operator">+</span> rt
                <span class="token operator">+</span> <span class="token string">" public $Proxy1(InvocationHandler h) {"</span> <span class="token operator">+</span> rt <span class="token operator">+</span> <span class="token string">" this.h = h;"</span> <span class="token operator">+</span> rt <span class="token operator">+</span> <span class="token string">" }"</span> <span class="token operator">+</span> rt
                <span class="token operator">+</span> <span class="token string">" mmp.proxy.InvocationHandler h;"</span> <span class="token operator">+</span> rt <span class="token operator">+</span> methodStr <span class="token operator">+</span> rt <span class="token operator">+</span> <span class="token string">"}"</span><span class="token punctuation">;</span>

        String fileName <span class="token operator">=</span> <span class="token string">"d:/src/mmp/proxy/$Proxy1.java"</span><span class="token punctuation">;</span>
        File f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        FileWriter fw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileWriter</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
        fw<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>srcCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        fw<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fw<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// å°†Javaæ–‡ä»¶ç¼–è¯‘æˆclassæ–‡ä»¶</span>
        JavaCompiler compiler <span class="token operator">=</span> ToolProvider<span class="token punctuation">.</span><span class="token function">getSystemJavaCompiler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        StandardJavaFileManager fileMgr <span class="token operator">=</span> compiler<span class="token punctuation">.</span><span class="token function">getStandardFileManager</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Iterable units <span class="token operator">=</span> fileMgr<span class="token punctuation">.</span><span class="token function">getJavaFileObjects</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        CompilationTask t <span class="token operator">=</span> compiler<span class="token punctuation">.</span><span class="token function">getTask</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> fileMgr<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">,</span> null<span class="token punctuation">,</span> units<span class="token punctuation">)</span><span class="token punctuation">;</span>
        t<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fileMgr<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// åŠ è½½åˆ°å†…å­˜ï¼Œå¹¶å®ä¾‹åŒ–</span>
        URL<span class="token punctuation">[</span><span class="token punctuation">]</span> urls <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token keyword">new</span> <span class="token class-name">URL</span><span class="token punctuation">(</span><span class="token string">"file:/"</span> <span class="token operator">+</span> <span class="token string">"d:/src/"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
        URLClassLoader ul <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLClassLoader</span><span class="token punctuation">(</span>urls<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Class <span class="token class-name">c</span> <span class="token operator">=</span> ul<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token string">"mmp.proxy.$Proxy1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Constructor ctr <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span>InvocationHandler<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Object m <span class="token operator">=</span> ctr<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> m<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


        <footer>
             
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

        </footer>
    </div>
    <!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
    <script>
        var timeEnd = new Date();
        console.log('è€—æ—¶ï¼š' + (timeEnd - timeStart));
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('pre').forEach((block) => {
                block.classList.add("line-numbers");
            });
        });
    </script>
    <!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
    <!-- material design -->
    <!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
    <!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
    <!-- toc -->
    <!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
    <!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
    <!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
    <!-- <script src="/js/main.js"></script> -->
    <script src="/js/prism.js"></script>
</body>
</html>
