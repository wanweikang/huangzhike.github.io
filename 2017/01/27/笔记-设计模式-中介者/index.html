<!DOCTYPE HTML>
<html>
	<head>
		<meta charset="utf-8">
				<script>var timeStart = new Date();</script>
		
		<title>[笔记]-设计模式-中介者 | 一个放笔记的地方而已</title>
		
		<meta name="author" content="Huangzhike">
		
		
		<meta name="description" content="没有鸡汤，只有笔记">
		
		
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		
		<meta property="og:title" content="[笔记]-设计模式-中介者"/>
		
		<meta property="og:site_name" content="一个放笔记的地方而已"/>
		
		
		<!-- favicon -->
		<link rel="icon" type="image/ico" href="/ok.ico" sizes="32x32">
 


		<meta name="msapplication-TileColor" content="#009688">
		<meta name="msapplication-TileImage" content="/mstile-144x144.ico">
		<meta name="theme-color" content="#009688">

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Didact+Gothic"> 

		<!-- favicon end -->
		<!-- <link href="//ok.ico" rel="icon"> -->
		
		<!-- toc -->
		<!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
		<!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
		<!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
		<!-- material design -->
		<!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
		<!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
		<!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
		<!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
		<!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
		<link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
		 
		 
		<!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
		<!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
	</head>

<body>
	<nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">菜单</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" href="/">一个放笔记的地方而已</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/" title="">
						<i class="fa fa-home"></i>Index
					</a>
				</li>
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

	<div class="container" >
		<div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[笔记]-设计模式-中介者</h2>
				
				<div>
					<span class="post-time">2017-01-27 18:18:37</span>
				</div>	
				
				<div class="article-content">
				<p>参考：<br>JavaScript设计模式与开发实践 曾探<br>深入理解JavaScript 汤姆大叔<br>其它<br><strong>Mediator—— 中介者模式</strong></p>
<p>中介者是一种行为设计模式， 允许公开统一的接口， 系统的不同部分通过这个接口进行通信。<br>Mediator模式本质上是Oberver模式的共享目标， 把中心控制点当做Subject， 而每个组件当做Observer：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> mediator = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	<span class="comment">// 保存事件和订阅者列表</span></div><div class="line">	<span class="keyword">var</span> events = &#123;&#125;;</div><div class="line">	<span class="comment">// 在事件上添加订阅者</span></div><div class="line">	<span class="function"><span class="keyword">function</span> <span class="title">subscribe</span>(<span class="params">eventName, callback</span>) </span>&#123;</div><div class="line">		events[eventName] = events[eventName] || [];</div><div class="line">		events[eventName].push(&#123;</div><div class="line">			<span class="attr">context</span>: <span class="keyword">this</span>,</div><div class="line">			<span class="attr">callback</span>: callback</div><div class="line">		&#125;);</div><div class="line">		<span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// 发布事件</span></div><div class="line">	<span class="function"><span class="keyword">function</span> <span class="title">publish</span>(<span class="params">eventName</span>) </span>&#123;</div><div class="line">		<span class="keyword">var</span> args = <span class="built_in">Array</span>.prototype.slice.call(<span class="built_in">arguments</span>, <span class="number">1</span>);</div><div class="line">		<span class="keyword">var</span> i;</div><div class="line">		<span class="keyword">var</span> subscribers = events[eventName];</div><div class="line">		<span class="keyword">var</span> subscriber;</div><div class="line">		<span class="keyword">if</span> (!subscribers) &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">for</span> (i = subscribers.length; i--;) &#123;</div><div class="line">			subscriber = subscribers[i];</div><div class="line">			subscriber.callback.call(subscriber.context, args);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> &#123;</div><div class="line">		<span class="attr">publish</span>: publish,</div><div class="line">		<span class="attr">subscribe</span>: subscribe,</div><div class="line">		<span class="attr">install</span>: <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</div><div class="line">			obj.publish = publish;</div><div class="line">			obj.subscribe = subscribe;</div><div class="line">			<span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;;</div><div class="line">&#125;());</div></pre></td></tr></table></figure></p>
<p>有三个模块, 分别是colleague1, colleague2, colleague3， 而1和2需要监听3的发送的数据， 而1和3需要监听2发送的数据， 可以这样实现：<br><figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 模块构造函数</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Colleague</span></span>(name) &#123;</div><div class="line">	<span class="built_in">this</span>.name = name;</div><div class="line">&#125;</div><div class="line"><span class="comment">// 创建三个模块</span></div><div class="line"><span class="keyword">var</span> colleague1 = <span class="keyword">new</span> <span class="type">Colleague</span>(<span class="string">"col1"</span>);</div><div class="line"><span class="keyword">var</span> colleague2 = <span class="keyword">new</span> <span class="type">Colleague</span>(<span class="string">"col2"</span>);</div><div class="line"><span class="keyword">var</span> colleague3 = <span class="keyword">new</span> <span class="type">Colleague</span>(<span class="string">"col3"</span>);</div><div class="line"></div><div class="line"><span class="comment">// 为每个模块创建获得数据后的处理，这里只要输出看结果就好</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">callback</span></span>() &#123;</div><div class="line">	console.log(<span class="built_in">this</span>.name + <span class="string">": "</span> + <span class="keyword">Array</span>.prototype.slice.call(arguments));</div><div class="line">&#125;</div><div class="line"><span class="comment">// 将中介者模式应用到三个模块上，使他们拥有订阅和发布的接口</span></div><div class="line">mediator.install(colleague1).install(colleague2).install(colleague3);</div><div class="line"><span class="comment">// 模块3发布消息，模块1和模块2获取消息并输出</span></div><div class="line">colleague1.subscribe(<span class="string">"pub3"</span>, <span class="keyword">callback</span>);</div><div class="line">colleague2.subscribe(<span class="string">"pub3"</span>, <span class="keyword">callback</span>);</div><div class="line">colleague3.publish(<span class="string">"pub3"</span>, <span class="string">"hzk"</span>, <span class="string">"求"</span>, <span class="string">"offer"</span>);</div><div class="line"><span class="comment">// 模块2发布消息，模块1和模块3获取消息并输出</span></div><div class="line">colleague1.subscribe(<span class="string">"pub2"</span>, <span class="keyword">callback</span>);</div><div class="line">colleague3.subscribe(<span class="string">"pub2"</span>, <span class="keyword">callback</span>);</div><div class="line">colleague2.publish(<span class="string">"pub2"</span>, <span class="string">"hzk"</span>, <span class="string">"想"</span>, <span class="string">"吃串"</span>);</div></pre></td></tr></table></figure></p>
<p>Mediator最大的好处就是将系统组件间的复杂的多对多关系简化到了一对多。<br>这样解耦程度较高， 添加发布者和订阅者也较为简单。<br>而缺点则是， Mediator本身在通信的中心， 其故障将导致所有组件瘫痪。<br>同时模块间间接的通信， 也会导致性能下降。<br>最大的缺点是系统中会新增一个中介者对象， 因为对象之间交互的复杂性， 转移成了中介者对象的复杂性， 使得中介者对象经常是巨大的。</p>
<p>Mediator与Observer<br>在Observer中， 不存在封装约束的单一对象。 Observer和Subject必须合作才能维持。<br>通信由观察者和目标互联的方式所决定： 单一目标通常有很多观察者， 又是一个目标的观察者是另一个观察者的目标Mediator和Observer都能促进松耦合，<br>但Mediator严格限定必须通过Mediator进行通信。</p>
<p>定义一个数组 players 保存所有的玩家， 创建玩家之后， 循环 players 给每个玩家设置队友和敌人<br><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">var players</span> = [];</div></pre></td></tr></table></figure></p>
<p>构造函数 Player， 使每个玩家对象都增加一些属性：<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">function Player(name, teamColor) &#123;</div><div class="line">	<span class="keyword">this</span>.partners = []; <span class="comment">// 队友列表</span></div><div class="line">	<span class="keyword">this</span>.enemies = []; <span class="comment">// 敌人列表</span></div><div class="line">	<span class="keyword">this</span>.state = <span class="string">'live'</span>; <span class="comment">// 玩家状态</span></div><div class="line">	<span class="keyword">this</span>.name = name; <span class="comment">// 角色名字</span></div><div class="line">	<span class="keyword">this</span>.teamColor = teamColor; <span class="comment">// 队伍颜色</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>玩家胜利和失败：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Player.prototype.win = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="comment">// 玩家团队胜利</span></div><div class="line">	<span class="built_in">console</span>.log(<span class="string">'winner: '</span> + <span class="keyword">this</span>.name);</div><div class="line">&#125;;</div><div class="line">Player.prototype.lose = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="comment">// 玩家团队失败</span></div><div class="line">	<span class="built_in">console</span>.log(<span class="string">'loser: '</span> + <span class="keyword">this</span>.name);</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>玩家死亡的时候， 遍历其他队友的生存状况， 如果队友全部死亡， 则这局游戏失败， 同时敌人队伍的所有玩家都取得胜利<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">Player.prototype.die = function() &#123; </div><div class="line">	<span class="comment">// 玩家死亡</span></div><div class="line">	<span class="keyword">var</span> all_dead = <span class="literal">true</span>;</div><div class="line">	<span class="keyword">this</span>.state = <span class="string">'dead'</span>; <span class="comment">// 设置玩家状态为死亡</span></div><div class="line">	<span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, partner; partner = <span class="keyword">this</span>.partners[i++];) &#123; <span class="comment">// 遍历队友列表</span></div><div class="line">		<span class="keyword">if</span> (partner.state !== <span class="string">'dead'</span>) &#123; <span class="comment">// 如果还有一个队友没有死亡，则游戏还未失败</span></div><div class="line">			all_dead = <span class="literal">false</span>;</div><div class="line">			<span class="keyword">break</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (all_dead === <span class="literal">true</span>) &#123; <span class="comment">// 如果队友全部死亡</span></div><div class="line">		<span class="keyword">this</span>.lose(); <span class="comment">// 通知自己游戏失败</span></div><div class="line">		<span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, partner; partner = <span class="keyword">this</span>.partners[i++];) &#123; <span class="comment">// 通知所有队友玩家游戏失败</span></div><div class="line">			partner.lose();</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, enemy; enemy = <span class="keyword">this</span>.enemies[i++];) &#123; <span class="comment">// 通知所有敌人游戏胜利</span></div><div class="line">			enemy.win();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>定义一个工厂来创建玩家：<br><figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> playerFactory = <span class="function"><span class="keyword">function</span></span>(name, teamColor) &#123;</div><div class="line">	<span class="keyword">var</span> <span class="keyword">new</span><span class="type">Player</span> = <span class="keyword">new</span> <span class="type">Player</span>(name, teamColor); <span class="comment">// 创建新玩家</span></div><div class="line">	<span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, player; player = players[i++];) &#123; <span class="comment">// 通知所有的玩家，有新角色加入</span></div><div class="line">		<span class="keyword">if</span> (player.teamColor === <span class="keyword">new</span><span class="type">Player</span>.teamColor) &#123; <span class="comment">// 如果是同一队的玩家</span></div><div class="line">			player.partners.push(<span class="keyword">new</span><span class="type">Player</span>); <span class="comment">// 相互添加到队友列表</span></div><div class="line">			<span class="keyword">new</span><span class="type">Player</span>.partners.push(player);</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			player.enemies.push(<span class="keyword">new</span><span class="type">Player</span>); <span class="comment">// 相互添加到敌人列表</span></div><div class="line">			<span class="keyword">new</span><span class="type">Player</span>.enemies.push(player);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	players.push(<span class="keyword">new</span><span class="type">Player</span>);</div><div class="line">	<span class="keyword">return</span> <span class="keyword">new</span><span class="type">Player</span>;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>现在已经可以随意地为游戏增加玩家或者队伍， 但每个玩家和其他玩家都是紧紧耦合在一起的。<br>每个玩家对象都有两个属性， this.partners 和 this.enemies，用来保存其他玩家对象的引用。<br>每个对象的状态发生改变， 比如角色移动、 吃到道具或者死亡时， 都必须要显式地遍历通知其他对象。<br>如果在一个大型网游中， 画面里有成百上千个玩家， 几十支队伍在互相厮杀。<br>如果有一个玩家掉线， 必须从所有其他玩家的队友列表和敌人列表中都移除这个玩家。<br>游戏也许还有解除队伍和添加到别的队伍的功能， 红色玩家可以变成蓝色玩家， 这就不再仅仅是循环能够解决的问题了。 </p>
<p>首先仍然是定义 Player 构造函数和 player 对象的原型方法， 在 player 对象的这些原型方法中， 不再负责具体的执行逻辑， 而是把操作转交给中介者对象， 把中介者对象命名为 playerDirector：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Player</span>(<span class="params">name, teamColor</span>) </span>&#123;</div><div class="line">	<span class="keyword">this</span>.name = name; <span class="comment">// 角色名字</span></div><div class="line">	<span class="keyword">this</span>.teamColor = teamColor; <span class="comment">// 队伍颜色</span></div><div class="line">	<span class="keyword">this</span>.state = <span class="string">'alive'</span>; <span class="comment">// 玩家生存状态</span></div><div class="line">&#125;;</div><div class="line">Player.prototype.win = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	<span class="built_in">console</span>.log(<span class="keyword">this</span>.name + <span class="string">' won '</span>);</div><div class="line">&#125;;</div><div class="line">Player.prototype.lose = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	<span class="built_in">console</span>.log(<span class="keyword">this</span>.name + <span class="string">' lost'</span>);</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment"><span class="markdown">/<span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">****玩家死亡**</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>/</span></span></div><div class="line">Player.prototype.die = function() &#123;</div><div class="line">	<span class="keyword">this</span>.state = <span class="string">'dead'</span>;</div><div class="line">	playerDirector.reciveMessage(<span class="string">'playerDead'</span>, <span class="keyword">this</span>); <span class="comment">// 给中介者发送消息，玩家死亡</span></div><div class="line">&#125;;</div><div class="line"><span class="comment"><span class="markdown">/<span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">****移除玩家**</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>/</span></span></div><div class="line">Player.prototype.remove = function() &#123;</div><div class="line">	playerDirector.reciveMessage(<span class="string">'removePlayer'</span>, <span class="keyword">this</span>); <span class="comment">// 给中介者发送消息，移除一个玩家</span></div><div class="line">&#125;;</div><div class="line"><span class="comment"><span class="markdown">/<span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">****玩家换队**</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>/</span></span></div><div class="line">Player.prototype.changeTeam = function(color) &#123;</div><div class="line">	playerDirector.reciveMessage(<span class="string">'changeTeam'</span>, <span class="keyword">this</span>, color); <span class="comment">// 给中介者发送消息，玩家换队</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>再改写之前创建玩家对象的工厂函数， 因为工厂函数里不再需要给创建的玩家对象设置队友和敌人， 这个工厂函数几乎失去了工厂的意义：<br><figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> playerFactory = <span class="function"><span class="keyword">function</span></span>(name, teamColor) &#123;</div><div class="line">	<span class="keyword">var</span> <span class="keyword">new</span><span class="type">Player</span> = <span class="keyword">new</span> <span class="type">Player</span>(name, teamColor); <span class="comment">// 创造一个新的玩家对象</span></div><div class="line">	playerDirector.reciveMessage(<span class="string">'addPlayer'</span>, <span class="keyword">new</span><span class="type">Player</span>); <span class="comment">// 给中介者发送消息，新增玩家</span></div><div class="line">	<span class="keyword">return</span> <span class="keyword">new</span><span class="type">Player</span>;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>最后， 实现这个中介者 playerDirector 对象， 一般有以下两种方式。<br>利用发布— 订阅模式。<br>将 playerDirector 实现为订阅者， 各 player 作为发布者， 一旦 player的状态发生改变， 便推送消息给 playerDirector， playerDirector 处理消息后将反馈发送给其他 player。<br>在 playerDirector 中开放一些接收消息的接口， 各 player 可以直接调用该接口来给playerDirector 发送消息， player 只需传递一个参数给 playerDirector， 这个参数的目的是使 playerDirector 可以识别发送者。 同样， playerDirector 接收到消息之后会将处理结果反馈给其他 player。<br>这里使用第二种方式， playerDirector 开放一个对外暴露的接口 reciveMessage，<br>负责接收 player 对象发送的消息， 而 player 对象发送消息的时候， 总是把自身 this 作为参数发送给 playerDirector， 以便 playerDirector 识别消息来自于哪个玩家对象：<br><figure class="highlight dart"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> playerDirector = (function() &#123;</div><div class="line">	<span class="keyword">var</span> players = &#123;&#125;, <span class="comment">// 保存所有玩家</span></div><div class="line">		operations = &#123;&#125;; <span class="comment">// 中介者可以执行的操作</span></div><div class="line">	<span class="comment"><span class="markdown">/<span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">*新增一个玩家*</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*/</span></span></div><div class="line">	operations.addPlayer = function(player) &#123;</div><div class="line">		<span class="keyword">var</span> teamColor = player.teamColor; <span class="comment">// 玩家的队伍颜色</span></div><div class="line">		players[teamColor] = players[teamColor] || []; <span class="comment">// 如果该颜色的玩家还没有成立队伍，则</span></div><div class="line">		新成立一个队伍</div><div class="line">		players[teamColor].push(player); <span class="comment">// 添加玩家进队伍</span></div><div class="line">	&#125;;</div><div class="line">	<span class="comment"><span class="markdown">/<span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">*移除一个玩家*</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*/</span></span></div><div class="line">	operations.removePlayer = function(player) &#123;</div><div class="line">		<span class="keyword">var</span> teamColor = player.teamColor, <span class="comment">// 玩家的队伍颜色</span></div><div class="line">			teamPlayers = players[teamColor] || []; <span class="comment">// 该队伍所有成员</span></div><div class="line">		<span class="keyword">for</span> (<span class="keyword">var</span> i = teamPlayers.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123; <span class="comment">// 遍历删除</span></div><div class="line">			<span class="keyword">if</span> (teamPlayers[i] === player) &#123;</div><div class="line">				teamPlayers.splice(i, <span class="number">1</span>);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;;</div><div class="line">	<span class="comment"><span class="markdown">/<span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="emphasis">*玩家换队*</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span>*/</span></span></div><div class="line">	operations.changeTeam = function(player, newTeamColor) &#123; <span class="comment">// 玩家换队</span></div><div class="line">		operations.removePlayer(player); <span class="comment">// 从原队伍中删除</span></div><div class="line">		player.teamColor = newTeamColor; <span class="comment">// 改变队伍颜色</span></div><div class="line">		operations.addPlayer(player); <span class="comment">// 增加到新队伍中</span></div><div class="line">	&#125;;</div><div class="line">	operations.playerDead = function(player) &#123; <span class="comment">// 玩家死亡</span></div><div class="line">		<span class="keyword">var</span> teamColor = player.teamColor,</div><div class="line">			teamPlayers = players[teamColor]; <span class="comment">// 玩家所在队伍</span></div><div class="line">		<span class="keyword">var</span> all_dead = <span class="keyword">true</span>;</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, player; player = teamPlayers[i++];) &#123;</div><div class="line">			<span class="keyword">if</span> (player.state !== <span class="string">'dead'</span>) &#123;</div><div class="line">				all_dead = <span class="keyword">false</span>;</div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (all_dead === <span class="keyword">true</span>) &#123; <span class="comment">// 全部死亡</span></div><div class="line">			<span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, player; player = teamPlayers[i++];) &#123;</div><div class="line">				player.lose(); <span class="comment">// 本队所有玩家 lose</span></div><div class="line">			&#125;</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">var</span> color <span class="keyword">in</span> players) &#123;</div><div class="line">				<span class="keyword">if</span> (color !== teamColor) &#123;</div><div class="line">					<span class="keyword">var</span> teamPlayers = players[color]; <span class="comment">// 其他队伍的玩家</span></div><div class="line">					<span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, player; player = teamPlayers[i++];) &#123;</div><div class="line">						player.win(); <span class="comment">// 其他队伍所有玩家 win</span></div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;;</div><div class="line">	<span class="keyword">var</span> reciveMessage = function() &#123;</div><div class="line">		<span class="keyword">var</span> message = Array.prototype.shift.call(arguments); <span class="comment">// arguments 的第一个参数为消息名称</span></div><div class="line">		operations[message].apply(<span class="keyword">this</span>, arguments);</div><div class="line">	&#125;;</div><div class="line">	<span class="keyword">return</span> &#123;</div><div class="line">		reciveMessage: reciveMessage</div><div class="line">	&#125;</div><div class="line">&#125;)();</div></pre></td></tr></table></figure></p>
<p>除了中介者本身，没有一个玩家知道其他任何玩家的存在，玩家与玩家之间的耦合关系已经完全解除，某个玩家的任何操作都不需要通知其他玩家，而只需要给中介者发送一个消息，中介者处理完消息之后会把处理结果反馈给其他的玩家对象。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">&lt;body&gt;</div><div class="line">	选择颜色:</div><div class="line">	<span class="xml"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"colorSelect"</span>&gt;</span></span></div><div class="line">		<span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">""</span>&gt;</span>请选择<span class="tag">&lt;/<span class="name">option</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">"red"</span>&gt;</span>红色<span class="tag">&lt;/<span class="name">option</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">"blue"</span>&gt;</span>蓝色<span class="tag">&lt;/<span class="name">option</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">select</span>&gt;</span></div><div class="line">	选择内存:</div><div class="line">	<span class="xml"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"memorySelect"</span>&gt;</span></span></div><div class="line">		<span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">""</span>&gt;</span>请选择<span class="tag">&lt;/<span class="name">option</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">"32G"</span>&gt;</span>32G<span class="tag">&lt;/<span class="name">option</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">"16G"</span>&gt;</span>16G<span class="tag">&lt;/<span class="name">option</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">select</span>&gt;</span></div><div class="line">	输入购买数量:</div><div class="line">	<span class="xml"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">id</span>=<span class="string">"numberInput"</span> /&gt;</span></span></div><div class="line">	<span class="tag">&lt;<span class="name">br</span>/&gt;</span> 您选择了颜色:</div><div class="line">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"colorInfo"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">br</span>/&gt;</span> 您选择了内存:</div><div class="line">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"memoryInfo"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">br</span>/&gt;</span> 您输入了数量:</div><div class="line">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"numberInfo"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">br</span>/&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"nextBtn"</span> <span class="attr">disabled</span>=<span class="string">"true"</span>&gt;</span>请选择手机颜色和购买数量<span class="tag">&lt;/<span class="name">button</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div></pre></td></tr></table></figure>
<figure class="highlight qml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line">&lt;script&gt;</div><div class="line"><span class="built_in">var</span> colorSelect = <span class="built_in">document</span>.getElementById(<span class="string">'colorSelect'</span>),</div><div class="line">	numberInput = <span class="built_in">document</span>.getElementById(<span class="string">'numberInput'</span>),</div><div class="line">	memorySelect = <span class="built_in">document</span>.getElementById(<span class="string">'memorySelect'</span>),</div><div class="line">	colorInfo = <span class="built_in">document</span>.getElementById(<span class="string">'colorInfo'</span>),</div><div class="line">	numberInfo = <span class="built_in">document</span>.getElementById(<span class="string">'numberInfo'</span>),</div><div class="line">	memoryInfo = <span class="built_in">document</span>.getElementById(<span class="string">'memoryInfo'</span>),</div><div class="line">	nextBtn = <span class="built_in">document</span>.getElementById(<span class="string">'nextBtn'</span>);</div><div class="line"></div><div class="line"><span class="built_in">var</span> goods = &#123; <span class="comment">// 手机库存</span></div><div class="line">	<span class="string">"red|32G"</span>: <span class="number">3</span>, <span class="comment">// 红色 32G，库存数量为 3</span></div><div class="line">	<span class="string">"red|16G"</span>: <span class="number">0</span>,</div><div class="line">	<span class="string">"blue|32G"</span>: <span class="number">1</span>,</div><div class="line">	<span class="string">"blue|16G"</span>: <span class="number">6</span></div><div class="line">&#125;;</div><div class="line">colorSelect.onchange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	<span class="built_in">var</span> <span class="built_in">color</span> = <span class="keyword">this</span>.value,</div><div class="line">		memory = memorySelect.value,</div><div class="line">		stock = goods[<span class="built_in">color</span> + <span class="string">'|'</span> + memory],</div><div class="line">		number = numberInput.value; <span class="comment">// 数量</span></div><div class="line">	colorInfo.innerHTML = <span class="built_in">color</span>;</div><div class="line">	<span class="keyword">if</span> (!<span class="built_in">color</span>) &#123;</div><div class="line">		nextBtn.disabled = <span class="literal">true</span>;</div><div class="line">		nextBtn.innerHTML = <span class="string">'请选择手机颜色'</span>;</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (!memory) &#123;</div><div class="line">		nextBtn.disabled = <span class="literal">true</span>;</div><div class="line">		nextBtn.innerHTML = <span class="string">'请选择内存大小'</span>;</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (((number - <span class="number">0</span>) | <span class="number">0</span>) !== number - <span class="number">0</span>) &#123; <span class="comment">// 输入购买数量是否为正整数</span></div><div class="line">		nextBtn.disabled = <span class="literal">true</span>;</div><div class="line">		nextBtn.innerHTML = <span class="string">'请输入正确的购买数量'</span>;</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (number &gt; stock) &#123; <span class="comment">// 当前选择数量没有超过库存量</span></div><div class="line">		nextBtn.disabled = <span class="literal">true</span>;</div><div class="line">		nextBtn.innerHTML = <span class="string">'库存不足'</span>;</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line">	nextBtn.disabled = <span class="literal">false</span>;</div><div class="line">	nextBtn.innerHTML = <span class="string">'放入购物车'</span>;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"></div><div class="line">memorySelect.onchange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	<span class="built_in">var</span> <span class="built_in">color</span> = colorSelect.value, <span class="comment">// 颜色</span></div><div class="line">		number = numberInput.value, <span class="comment">// 数量</span></div><div class="line">		memory = <span class="keyword">this</span>.value,</div><div class="line">		stock = goods[<span class="built_in">color</span> + <span class="string">'|'</span> + memory]; <span class="comment">// 该颜色手机对应的当前库存</span></div><div class="line">	memoryInfo.innerHTML = memory;</div><div class="line">	<span class="keyword">if</span> (!<span class="built_in">color</span>) &#123;</div><div class="line">		nextBtn.disabled = <span class="literal">true</span>;</div><div class="line">		nextBtn.innerHTML = <span class="string">'请选择手机颜色'</span>;</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (!memory) &#123;</div><div class="line">		nextBtn.disabled = <span class="literal">true</span>;</div><div class="line">		nextBtn.innerHTML = <span class="string">'请选择内存大小'</span>;</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (((number - <span class="number">0</span>) | <span class="number">0</span>) !== number - <span class="number">0</span>) &#123; <span class="comment">// 输入购买数量是否为正整数</span></div><div class="line">		nextBtn.disabled = <span class="literal">true</span>;</div><div class="line">		nextBtn.innerHTML = <span class="string">'请输入正确的购买数量'</span>;</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (number &gt; stock) &#123; <span class="comment">// 当前选择数量没有超过库存量</span></div><div class="line">		nextBtn.disabled = <span class="literal">true</span>;</div><div class="line">		nextBtn.innerHTML = <span class="string">'库存不足'</span>;</div><div class="line">		<span class="keyword">return</span>;</div><div class="line">	&#125;</div><div class="line">	nextBtn.disabled = <span class="literal">false</span>;</div><div class="line">	nextBtn.innerHTML = <span class="string">'放入购物车'</span>;</div><div class="line">&#125;;</div><div class="line"><span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></div></pre></td></tr></table></figure>
<p>仅仅是增加一个内存的选择条件，就要改变如此多的代码，这是因为在目前的实现中，每个节点对象都是耦合在一起的，改变或者增加任何一个节点对象，都要通知到与其相 关的对象。<br>现在引入中介者对象，所有的节点对象只跟中介者通信。当下拉选择框 colorSelect 、 memorySelect 和文本输入框 numberInput 发生了事件行为时，它们仅仅通知中介者它们被改变了， 同时把自身当作参数传入中介者，以便中介者辨别是谁发生了改变。剩下的所有事情都交给中介 者对象来完成，无论是修改还是新增节点，都只需要改动中介者对象里的代码。</p>
<figure class="highlight qml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">var</span> goods = &#123; </div><div class="line">	<span class="comment">// 手机库存 </span></div><div class="line">	<span class="string">"red|32G"</span>: <span class="number">3</span>,</div><div class="line">	<span class="string">"red|16G"</span>: <span class="number">0</span>,</div><div class="line">	<span class="string">"blue|32G"</span>: <span class="number">1</span>,</div><div class="line">	<span class="string">"blue|16G"</span>: <span class="number">6</span></div><div class="line">&#125;;</div><div class="line"><span class="built_in">var</span> mediator = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	<span class="built_in">var</span> colorSelect = <span class="built_in">document</span>.getElementById(<span class="string">'colorSelect'</span>),</div><div class="line">		memorySelect = <span class="built_in">document</span>.getElementById(<span class="string">'memorySelect'</span>),</div><div class="line">		numberInput = <span class="built_in">document</span>.getElementById(<span class="string">'numberInput'</span>),</div><div class="line">		colorInfo = <span class="built_in">document</span>.getElementById(<span class="string">'colorInfo'</span>),</div><div class="line">		memoryInfo = <span class="built_in">document</span>.getElementById(<span class="string">'memoryInfo'</span>),</div><div class="line">		numberInfo = <span class="built_in">document</span>.getElementById(<span class="string">'numberInfo'</span>),</div><div class="line">		nextBtn = <span class="built_in">document</span>.getElementById(<span class="string">'nextBtn'</span>);</div><div class="line">	<span class="keyword">return</span> &#123;</div><div class="line">		<span class="attribute">changed</span>: <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</div><div class="line">			<span class="built_in">var</span> <span class="built_in">color</span> = colorSelect.value, <span class="comment">// 颜色 </span></div><div class="line">				memory = memorySelect.value, <span class="comment">// </span></div><div class="line">				内存 number = numberInput.value, <span class="comment">// </span></div><div class="line">				数量 stock = goods[<span class="built_in">color</span> + <span class="string">'|'</span> + memory]; <span class="comment">// 颜色和内存对应的手机库存数量 </span></div><div class="line">			<span class="keyword">if</span> (obj === colorSelect) &#123; <span class="comment">// 如果改变的是选择颜色下拉框 </span></div><div class="line">				colorInfo.innerHTML = <span class="built_in">color</span>;</div><div class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (obj === memorySelect) &#123;</div><div class="line">				memoryInfo.innerHTML = memory;</div><div class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (obj === numberInput) &#123;</div><div class="line">				numberInfo.innerHTML = number;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> (!<span class="built_in">color</span>) &#123;</div><div class="line">				nextBtn.disabled = <span class="literal">true</span>;</div><div class="line">				nextBtn.innerHTML = <span class="string">'请选择手机颜色'</span>;</div><div class="line">				<span class="keyword">return</span>;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> (!memory) &#123;</div><div class="line">				nextBtn.disabled = <span class="literal">true</span>;</div><div class="line">				nextBtn.innerHTML = <span class="string">'请选择内存大小'</span>;</div><div class="line">				<span class="keyword">return</span>;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> (((number - <span class="number">0</span>) | <span class="number">0</span>) !== number - <span class="number">0</span>) &#123; <span class="comment">// 输入购买数量是否为正整数 </span></div><div class="line">				nextBtn.disabled = <span class="literal">true</span>;</div><div class="line">				nextBtn.innerHTML = <span class="string">'请输入正确的购买数量'</span>;</div><div class="line">				<span class="keyword">return</span>;</div><div class="line">			&#125;</div><div class="line">			nextBtn.disabled = <span class="literal">false</span>;</div><div class="line">			nextBtn.innerHTML = <span class="string">'放入购物车'</span>;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;)();</div><div class="line"> <span class="comment">// 事件函数： </span></div><div class="line">colorSelect.onchange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; mediator.changed(<span class="keyword">this</span>); &#125;;</div><div class="line">memorySelect.onchange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; mediator.changed(<span class="keyword">this</span>); &#125;;</div><div class="line">numberInput.oninput = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; mediator.changed(<span class="keyword">this</span>); &#125;;</div></pre></td></tr></table></figure>
<p>某天要新增一些跟需求相关的节点， 比如 CPU 型号， 那只需要稍稍 改动 mediator 对象即可：<br><figure class="highlight qml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">var</span> goods = &#123; </div><div class="line">	<span class="comment">// 手机库存 </span></div><div class="line">	<span class="string">"red|32G|800"</span>: <span class="number">3</span>, <span class="comment">// 颜色 red，内存 32G，cpu800，对应库存数量为 3 </span></div><div class="line">	<span class="string">"red|16G|801"</span>: <span class="number">0</span>,</div><div class="line">	<span class="string">"blue|32G|800"</span>: <span class="number">1</span>,</div><div class="line">	<span class="string">"blue|16G|801"</span>: <span class="number">6</span></div><div class="line">&#125;;</div><div class="line"><span class="built_in">var</span> mediator = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; </div><div class="line">	<span class="comment">// 略</span></div><div class="line">	<span class="built_in">var</span> cpuSelect = <span class="built_in">document</span>.getElementById(<span class="string">'cpuSelect'</span>);</div><div class="line">	<span class="keyword">return</span> &#123;</div><div class="line">		<span class="attribute">change</span>: <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123; </div><div class="line">			<span class="comment">// 略</span></div><div class="line">			<span class="built_in">var</span> cpu = cpuSelect.value,</div><div class="line">				stock = goods[<span class="built_in">color</span> + <span class="string">'|'</span> + memory + <span class="string">'|'</span> + cpu];</div><div class="line">			<span class="keyword">if</span> (obj === cpuSelect) &#123; cpuInfo.innerHTML = cpu; &#125; </div><div class="line">			<span class="comment">// 略</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;)();</div></pre></td></tr></table></figure></p>
<p>在JavaScript里， 中介者非常常见， 相当于观察者模式上的消息Bus， 只不过不像观察者那样通过调用pub / sub的形式来实现， 而是通过中介者统一来管理， 在观察者的基础上来给出一个例子：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> mediator = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="comment">// 订阅一个事件，并且提供一个事件触发以后的回调函数 </span></div><div class="line">	<span class="keyword">var</span> subscribe = <span class="function"><span class="keyword">function</span>(<span class="params">channel, fn</span>) </span>&#123;</div><div class="line">			<span class="keyword">if</span> (!mediator.channels[channel]) mediator.channels[channel] = [];</div><div class="line">			mediator.channels[channel].push(&#123; <span class="attr">context</span>: <span class="keyword">this</span>, <span class="attr">callback</span>: fn &#125;);</div><div class="line">			<span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">		&#125;, <span class="comment">// 广播事件   </span></div><div class="line">		publish = <span class="function"><span class="keyword">function</span>(<span class="params">channel</span>) </span>&#123;</div><div class="line">			<span class="keyword">if</span> (!mediator.channels[channel]) <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">			<span class="keyword">var</span> args = <span class="built_in">Array</span>.prototype.slice.call(<span class="built_in">arguments</span>, <span class="number">1</span>);</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, l = mediator.channels[channel].length; i &lt; l; i++) &#123;</div><div class="line">				<span class="keyword">var</span> subscription = mediator.channels[channel][i];</div><div class="line">				subscription.callback.apply(subscription.context, args);</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">		&#125;;</div><div class="line">	<span class="keyword">return</span> &#123;</div><div class="line">		<span class="attr">channels</span>: &#123;&#125;,</div><div class="line">		<span class="attr">publish</span>: publish,</div><div class="line">		<span class="attr">subscribe</span>: subscribe,</div><div class="line">		<span class="attr">installTo</span>: <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</div><div class="line">			obj.subscribe = subscribe;</div><div class="line">			obj.publish = publish;</div><div class="line">		&#125;</div><div class="line">	&#125;;</div><div class="line">&#125;());</div></pre></td></tr></table></figure>
<p>调用代码， 相对就简单了：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">(<span class="function"><span class="keyword">function</span>(<span class="params">Mediator</span>) </span>&#123;</div><div class="line">	<span class="function"><span class="keyword">function</span> <span class="title">initialize</span>(<span class="params"></span>) </span>&#123; <span class="comment">// 默认值    </span></div><div class="line">		mediator.name = <span class="string">"dudu"</span>; <span class="comment">// 订阅一个事件nameChange     </span></div><div class="line">		<span class="comment">// 回调函数显示修改前后的信息    </span></div><div class="line">		mediator.subscribe(<span class="string">'nameChange'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">arg</span>) </span>&#123;</div><div class="line">			<span class="built_in">console</span>.log(<span class="keyword">this</span>.name);</div><div class="line">			<span class="keyword">this</span>.name = arg;</div><div class="line">			<span class="built_in">console</span>.log(<span class="keyword">this</span>.name);</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">function</span> <span class="title">updateName</span>(<span class="params"></span>) </span>&#123; <span class="comment">// 广播触发事件，参数为新数据        </span></div><div class="line">		mediator.publish(<span class="string">'nameChange'</span>, <span class="string">'tom'</span>); <span class="comment">// dudu, tom   </span></div><div class="line">	&#125;</div><div class="line">	initialize(); <span class="comment">// 初始化  </span></div><div class="line">	updateName(); <span class="comment">// 调用</span></div><div class="line">&#125;)(mediator);</div></pre></td></tr></table></figure></p>
<p>中介者和观察者<br>观察者模式， 没有封装约束的单个对象， 相反， 观察者Observer和具体类Subject是一起配合来维护约束的， 沟通是通过多个观察者和多个具体类来交互的： 每个具体类通常包含多个观察者， 而有时候具体类里的一个观察者也是另一个观察者的具体类。<br>而中介者模式所做的不是简单的分发， 却是扮演着维护这些约束的职责。</p>
<p>中介者和外观模式<br>中介者和外观模式都是对现有各模块进行抽象， 但有一些微妙的区别。<br>中介者所做的是在模块之间进行通信， 是多向的， 但外观模式只是为某一个模块或系统定义简单的接口而不添加额外的功能。<br>系统中的其它模块和外观模式这个概念没有直接联系， 可以认为是单向性。</p>
<p>一个完整的例子：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;!doctypehtml&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">title</span>&gt;</span>JavaScriptPatterns <span class="tag">&lt;/<span class="name">title</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">metacharset="utf-8"</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"results"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></div><div class="line">	<span class="function"><span class="keyword">function</span> <span class="title">Player</span>(<span class="params">name</span>) </span>&#123;</div><div class="line">		<span class="keyword">this</span>.points = <span class="number">0</span>;</div><div class="line">		<span class="keyword">this</span>.name = name;</div><div class="line">	&#125;</div><div class="line">	Player.prototype.play = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">		<span class="keyword">this</span>.points += <span class="number">1</span>;</div><div class="line">		mediator.played();</div><div class="line">	&#125;;</div><div class="line">	<span class="keyword">var</span> scoreboard = &#123;</div><div class="line">		<span class="comment">// 显示内容的容器 </span></div><div class="line">		element: <span class="built_in">document</span>.getElementById(<span class="string">'results'</span>),</div><div class="line">		<span class="comment">// 更新分数显示 </span></div><div class="line">		update: <span class="function"><span class="keyword">function</span>(<span class="params">score</span>) </span>&#123;</div><div class="line">			<span class="keyword">var</span> i, msg = <span class="string">''</span>;</div><div class="line">			<span class="keyword">for</span> (i <span class="keyword">in</span> score) &#123;</div><div class="line">				<span class="keyword">if</span> (score.hasOwnProperty(i)) &#123;</div><div class="line">					msg += <span class="string">'&lt;p&gt;&lt;strong&gt;'</span> + i + <span class="string">'&lt;\/strong&gt;: '</span>;</div><div class="line">					msg += score[i];</div><div class="line">					msg += <span class="string">'&lt;\/p&gt;'</span>;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">this</span>.element.innerHTML = msg;</div><div class="line">		&#125;</div><div class="line">	&#125;;</div><div class="line">	<span class="keyword">var</span> mediator = &#123;</div><div class="line">		<span class="comment">// 所有的player     </span></div><div class="line">		players: &#123;&#125;,</div><div class="line">		<span class="comment">// 初始化           </span></div><div class="line">		setup: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">			<span class="keyword">var</span> players = <span class="keyword">this</span>.players;</div><div class="line">			players.home = <span class="keyword">new</span> Player(<span class="string">'Home'</span>);</div><div class="line">			players.guest = <span class="keyword">new</span> Player(<span class="string">'Guest'</span>);</div><div class="line">		&#125;,</div><div class="line">		<span class="comment">// play以后，更新分数      </span></div><div class="line">		played: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">			<span class="keyword">var</span> players = <span class="keyword">this</span>.players,</div><div class="line">				score = &#123;</div><div class="line">					<span class="attr">Home</span>: players.home.points,</div><div class="line">					<span class="attr">Guest</span>: players.guest.points</div><div class="line">				&#125;;</div><div class="line">			scoreboard.update(score);</div><div class="line">		&#125;,</div><div class="line">		<span class="comment">// 处理用户按键交互       </span></div><div class="line">		keypress: <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</div><div class="line">			e = e || <span class="built_in">window</span>.event; <span class="comment">// IE    </span></div><div class="line">			<span class="keyword">if</span> (e.which === <span class="number">49</span>) &#123; <span class="comment">// 数字键 "1"     </span></div><div class="line">				mediator.players.home.play();</div><div class="line">				<span class="keyword">return</span>;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> (e.which === <span class="number">48</span>) &#123; <span class="comment">// 数字键 "0"        </span></div><div class="line">				mediator.players.guest.play();</div><div class="line">				<span class="keyword">return</span>;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;;</div><div class="line">	<span class="comment">// go!        </span></div><div class="line">	mediator.setup();</div><div class="line">	<span class="built_in">window</span>.onkeypress = mediator.keypress;</div><div class="line">	<span class="comment">// 30秒以后结束     </span></div><div class="line">	setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">		<span class="built_in">window</span>.onkeypress = <span class="literal">null</span>;</div><div class="line">		<span class="built_in">console</span>.log(<span class="string">'Game over!'</span>);</div><div class="line">	&#125;, <span class="number">30000</span>);</div><div class="line">	<span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>中介者模式一般应用于一组对象已定义良好但是以复杂的方式进行通信的场合， 当系统出现了多对多交互复杂的对象群时， 先不要急于使用中介者模式， 而是要思考一下是不是系统设计有问题。<br>另外， 由于中介者模式把交互复杂性变成了中介者本身的复杂性， 中介者对象会比其它任何对象都复杂。</p>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


		<footer>
			 
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

		</footer>
	</div>
	<!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
	<script src="/js/highlight.js"></script> 
	<script>hljs.initHighlightingOnLoad();var timeEnd = new Date();console.log('耗时：' + (timeEnd - timeStart));</script>
	<!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
	<!-- material design -->
	<!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
	<!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
	<!-- toc -->
	<!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
	<!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
	<!-- <script src="/js/main.js"></script> -->
</body>
</html>
