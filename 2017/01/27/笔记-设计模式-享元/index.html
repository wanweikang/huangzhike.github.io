<!DOCTYPE HTML>
<html>
	<head>
		<meta charset="utf-8">
				<script>var timeStart = new Date();</script>
		
		<title>[笔记]-设计模式-享元 | 一个放笔记的地方而已</title>
		
		<meta name="author" content="Huangzhike">
		
		
		<meta name="description" content="用手记笔记，用心记笔记，用脑记笔记">
		
		
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
		
		<meta property="og:title" content="[笔记]-设计模式-享元"/>
		
		<meta property="og:site_name" content="一个放笔记的地方而已"/>
		
		
		<!-- favicon -->
		<link rel="icon" type="image/ico" href="/ok.ico" sizes="32x32">
 


		<meta name="msapplication-TileColor" content="#009688">
		<meta name="msapplication-TileImage" content="/mstile-144x144.ico">
		<meta name="theme-color" content="#009688">

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Didact+Gothic"> 

		<!-- favicon end -->
		<!-- <link href="//ok.ico" rel="icon"> -->
		
		<!-- toc -->
		<!-- <link rel="stylesheet" href="/libs/tocify/jquery.tocify.css" media="screen" type="text/css"> -->
		<!-- <link rel="stylesheet" href="/libs/bs/css/bootstrap.min.css" media="screen" type="text/css"> -->
		<!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.min.css" media="screen" type="text/css">-->
		<!-- material design -->
		<!-- <link rel="stylesheet" href="/libs/bs-material/css/ripples.min.css" media="screen" type="text/css"> -->
		<!-- <link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/ripples.min.css" media="screen" type="text/css"> -->
		<!-- <link rel="stylesheet" href="/libs/bs-material/css/material.min.css" media="screen" type="text/css"> -->
		<!--<link rel="stylesheet" href="//apps.bdimg.com/libs/bootstrap-material/0.3.0/css/material.min.css" media="screen" type="text/css"> -->
		<!--<link rel="stylesheet" href="/css/highlight.light.css" media="screen" type="text/css">-->
		<link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
		 
		 
		<!-- <script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script>-->
		<!-- <script>window.jQuery || document.write('<script src="/libs/jquery-3.1.1.slim.min.js" type="text/javascript"><\/script>')</script>-->
	</head>

<body>
	<nav class="navbar navbar-default">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
				<span class="sr-only">菜单</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" href="/">一个放笔记的地方而已</a>
           
		</div>
		<div id="navbar" class="collapse navbar-collapse">
			<ul class="nav navbar-nav navbar-right">
				
				<li>
					<a href="https://huangzhike.github.io/" title="">
						<i class="fa fa-home"></i>Index
					</a>
				</li>
				
				<li>
					<a href="https://huangzhike.github.io/archives" title="">
						<i class="fa fa-list"></i>Archives
					</a>
				</li>
				
				<li>
					<a href="https://github.com/huangzhike" title="">
						<i class="fa fa-github"></i>GitHub
					</a>
				</li>
				
			</ul>
		</div>
	</div>
</nav>

	<div class="container" >
		<div class="row">
	
		<div class="col-md-9 center-content">
			
			<div class="content">
				<!-- index -->
				
				<h2>[笔记]-设计模式-享元</h2>
				
				<div>
					<span class="post-time">2017-01-27 18:18:37</span>
				</div>	
				
				<div class="article-content">
				<p>参考：<br>JavaScript设计模式与开发实践 曾探<br>深入理解JavaScript 汤姆大叔<br><strong>Flyweight—— 享元模式</strong></p>
<p>共享一个类(元类)。<br>享元模式可以避免大量相似类的开销， 有时需要生产大量细粒度的类实例来表示数据， 如果能把参数移动到类实例的外面， 在方法调用的时候将他们传递进来， 就可以通过共享大幅度第减少单个实例 的数目。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> Model = <span class="function"><span class="keyword">function</span>(<span class="params">sex, underwear</span>) </span>&#123;</div><div class="line">	<span class="keyword">this</span>.sex = sex;</div><div class="line">	<span class="keyword">this</span>.underwear = underwear;</div><div class="line">&#125;;</div><div class="line">Model.prototype.takePhoto = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	<span class="built_in">console</span>.log(<span class="string">'sex= '</span> + <span class="keyword">this</span>.sex + <span class="string">' underwear='</span> + <span class="keyword">this</span>.underwear);</div><div class="line">&#125;;</div><div class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">1</span>; i &lt;= <span class="number">50</span>; i++) &#123;</div><div class="line">	<span class="keyword">var</span> maleModel = <span class="keyword">new</span> Model(<span class="string">'male'</span>, <span class="string">'underwear'</span> + i);</div><div class="line">	maleModel.takePhoto();</div><div class="line">&#125;;</div><div class="line"><span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">1</span>; j &lt;= <span class="number">50</span>; j++) &#123;</div><div class="line"></div><div class="line">	<span class="keyword">var</span> femaleModel = <span class="keyword">new</span> Model(<span class="string">'female'</span>, <span class="string">'underwear'</span> + j);</div><div class="line">	femaleModel.takePhoto();</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> Model = <span class="function"><span class="keyword">function</span>(<span class="params">sex</span>) </span>&#123;</div><div class="line">	<span class="keyword">this</span>.sex = sex;</div><div class="line">&#125;;</div><div class="line">Model.prototype.takePhoto = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	<span class="built_in">console</span>.log(<span class="string">'sex= '</span> + <span class="keyword">this</span>.sex + <span class="string">' underwear='</span> + <span class="keyword">this</span>.underwear);</div><div class="line">&#125;;</div><div class="line"><span class="comment">// 分别创建一个男模特对象和一个女模特对象：</span></div><div class="line"><span class="keyword">var</span> maleModel = <span class="keyword">new</span> Model(<span class="string">'male'</span>),</div><div class="line">	femaleModel = <span class="keyword">new</span> Model(<span class="string">'female'</span>);</div><div class="line"><span class="comment">// 给男模特依次穿上所有的男装， 并进行拍照：</span></div><div class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">1</span>; i &lt;= <span class="number">50</span>; i++) &#123;</div><div class="line">	maleModel.underwear = <span class="string">'underwear'</span> + i;</div><div class="line">	maleModel.takePhoto();</div><div class="line">&#125;;</div><div class="line"><span class="comment">// 同样， 给女模特依次穿上所有的女装， 并进行拍照：</span></div><div class="line"><span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">1</span>; j &lt;= <span class="number">50</span>; j++) &#123;</div><div class="line">	femaleModel.underwear = <span class="string">'underwear'</span> + j;</div><div class="line">	femaleModel.takePhoto();</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>改进之后的代码， 只需要两个对象便完成了同样的功能。</p>
<p>享元模式要求将对象的属性划分为内部状态与外部状态（ 状态在这里通常指属性）。<br>享元模式的目标是尽量减少共享对象的数量。<br>内部状态存储于对象内部。<br>内部状态可以被一些对象共享。<br>内部状态独立于具体的场景， 通常不会改变。<br>外部状态取决于具体的场景， 并根据场景而变化， 外部状态不能被共享。<br>把所有内部状态相同的对象都指定为同一个共享的对象。<br>而外部状态可以从对象身上剥离出来， 并储存在外部。<br>剥离了外部状态的对象成为共享对象， 外部状态在必要时被传入共享对象来组装成一个完整的对象。<br>在上面的例子中， 性别是内部状态， 内衣是外部状态， 通过区分这两种状态， 大大减少了系统中的对象数量。<br>通常来讲， 内部状态有多少种组合， 系统中便最多存在多少个对象， 因为性别通常只有男女两种， 所以该内衣厂商最多只需要 2 个对象。<br>使用享元模式的关键是如何区别内部状态和外部状态。<br>可以被对象共享的属性通常被划分为内部状态， 如同不管什么样式的衣服， 都可以按照性别不同， 穿在同一个男模特或者女模特身上，模特的性别就可以作为内部状态储存在共享对象的内部。<br>而外部状态取决于具体的场景， 并根据场景而变化， 就像例子中每件衣服都是不同的， 它们不能被一些对象共享， 因此只能被划分为外部状态。</p>
<p>享元模式是一种结构型解决方案， 用于优化重复、 缓慢及数据共享效率低的代码。<br>通过与相关对象共享尽可能多的数据来减少应用程序中的内存使用。<br>享元模式的应用有两种， 第一种是用户数据层， 处理内存中保存的大量相似对象的共享数据。<br>第二种是用于DOM层， 享元作为中央事件管理器， 避免将事件处理程序附加到父容器中的每个子元素上， 而是将事件处理程序附加到这个父容器上。<br>以下情况发生时便可以使用享元模式。<br>一个程序中使用了大量的相似对象。对象的大多数状态都可以变为外部状态。剥离出对象的外部状态之后， 可以用相对较少的共享对象取代大量对象。</p>
<p>该代码还未被优化：<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> Book = function(id, title, author, genre, pageCount, publisherID, ISBN, checkoutDate, checkoutMember, dueReturnDate, availability) &#123;</div><div class="line">	<span class="keyword">this</span>.id = id;</div><div class="line">	<span class="keyword">this</span>.title = title;</div><div class="line">	<span class="keyword">this</span>.author = author;</div><div class="line">	<span class="keyword">this</span>.genre = genre;</div><div class="line">	<span class="keyword">this</span>.pageCount = pageCount;</div><div class="line">	<span class="keyword">this</span>.publisherID = publisherID;</div><div class="line">	<span class="keyword">this</span>.ISBN = ISBN;</div><div class="line">	<span class="keyword">this</span>.checkoutDate = checkoutDate;</div><div class="line">	<span class="keyword">this</span>.checkoutMember = checkoutMember;</div><div class="line">	<span class="keyword">this</span>.dueReturnDate = dueReturnDate;</div><div class="line">	<span class="keyword">this</span>.availability = availability;</div><div class="line">&#125;;</div><div class="line">Book.prototype = &#123;</div><div class="line">	getTitle: function() &#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.title;</div><div class="line">	&#125;,</div><div class="line">	getAuthor: function() &#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.author;</div><div class="line">	&#125;,</div><div class="line">	getISBN: function() &#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.ISBN;</div><div class="line">	&#125;,</div><div class="line"></div><div class="line">	<span class="comment">// 更新借出状态</span></div><div class="line">	updateCheckoutStatus: function(bookID, newStatus, checkoutDate, checkoutMember, newReturnDate) &#123;</div><div class="line">		<span class="keyword">this</span>.id = bookID;</div><div class="line">		<span class="keyword">this</span>.availability = newStatus;</div><div class="line">		<span class="keyword">this</span>.checkoutDate = checkoutDate;</div><div class="line">		<span class="keyword">this</span>.checkoutMember = checkoutMember;</div><div class="line">		<span class="keyword">this</span>.dueReturnDate = newReturnDate;</div><div class="line">	&#125;,</div><div class="line">	<span class="comment">// 续借</span></div><div class="line">	extendCheckoutPeriod: function(bookID, newReturnDate) &#123;</div><div class="line">		<span class="keyword">this</span>.id = bookID;</div><div class="line">		<span class="keyword">this</span>.dueReturnDate = newReturnDate;</div><div class="line">	&#125;,</div><div class="line">	<span class="comment">// 是否到期</span></div><div class="line">	isPastDue: function(bookID) &#123;</div><div class="line">		<span class="keyword">var</span> currentDate = new Date();</div><div class="line">		<span class="keyword">return</span> currentDate.getTime() &gt; Date.parse(<span class="keyword">this</span>.dueReturnDate);</div><div class="line">	&#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>图书可能大批量增加， 并且每种图书都有不同的版本和数量， 几千个book对象在内存里可想而知， 用享元模式来优化。<br>将数据分成内部和外部两种数据， 和book对象相关的数据（ title, author 等） 可以归结为内部属性， 而（ checkoutMember, dueReturnDate等） 可以归结为外部属性。<br>可以在同一本书里共享同一个对象了， 因为不管谁借的书， 只要书是同一本书， 基本信息是一样的：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*享元模式优化代码*/</span></div><div class="line"><span class="keyword">var</span> Book = <span class="function"><span class="keyword">function</span>(<span class="params">title, author, genre, pageCount, publisherID, ISBN</span>) </span>&#123;</div><div class="line">	<span class="keyword">this</span>.title = title;</div><div class="line">	<span class="keyword">this</span>.author = author;</div><div class="line">	<span class="keyword">this</span>.genre = genre;</div><div class="line">	<span class="keyword">this</span>.pageCount = pageCount;</div><div class="line">	<span class="keyword">this</span>.publisherID = publisherID;</div><div class="line">	<span class="keyword">this</span>.ISBN = ISBN;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// 定义工厂， 检查之前是否创建该book的对象， 如果有就返回， 没有就重新创建并存储以便后面可以继续访问， 确保每一种书只创建一个对象：</span></div><div class="line"><span class="comment">/* Book工厂 单例 */</span></div><div class="line"><span class="keyword">var</span> BookFactory = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	<span class="keyword">var</span> existingBooks = &#123;&#125;;</div><div class="line">	<span class="keyword">return</span> &#123;</div><div class="line">		<span class="attr">createBook</span>: <span class="function"><span class="keyword">function</span>(<span class="params">title, author, genre, pageCount, publisherID, ISBN</span>) </span>&#123;</div><div class="line">			<span class="comment">/*查找之前是否创建*/</span></div><div class="line">			<span class="keyword">var</span> existingBook = existingBooks[ISBN];</div><div class="line">			<span class="keyword">if</span> (existingBook) &#123;</div><div class="line">				<span class="keyword">return</span> existingBook;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				<span class="comment">/* 如果没有，就创建一个，然后保存*/</span></div><div class="line">				<span class="keyword">var</span> book = <span class="keyword">new</span> Book(title, author, genre, pageCount, publisherID, ISBN);</div><div class="line">				existingBooks[ISBN] = book;</div><div class="line">				<span class="keyword">return</span> book;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">// 外部状态， 相对就简单了， 除了封装好的book， 其它都在这里管理：</span></div><div class="line"><span class="comment">/*BookRecordManager 借书管理类 单例*/</span></div><div class="line"><span class="keyword">var</span> BookRecordManager = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	<span class="keyword">var</span> bookRecordDatabase = &#123;&#125;;</div><div class="line">	<span class="keyword">return</span> &#123;</div><div class="line">		<span class="comment">/*添加借书记录*/</span></div><div class="line">		addBookRecord: <span class="function"><span class="keyword">function</span>(<span class="params">id, title, author, genre, pageCount, publisherID, ISBN, checkoutDate, checkoutMember, dueReturnDate, availability</span>) </span>&#123;</div><div class="line">			<span class="keyword">var</span> book = bookFactory.createBook(title, author, genre, pageCount, publisherID, ISBN);</div><div class="line">			bookRecordDatabase[id] = &#123;</div><div class="line">				<span class="attr">checkoutMember</span>: checkoutMember,</div><div class="line">				<span class="attr">checkoutDate</span>: checkoutDate,</div><div class="line">				<span class="attr">dueReturnDate</span>: dueReturnDate,</div><div class="line">				<span class="attr">availability</span>: availability,</div><div class="line">				<span class="attr">book</span>: book;</div><div class="line">			&#125;;</div><div class="line">		&#125;,</div><div class="line">		<span class="attr">updateCheckoutStatus</span>: <span class="function"><span class="keyword">function</span>(<span class="params">bookID, newStatus, checkoutDate, checkoutMember, newReturnDate</span>) </span>&#123;</div><div class="line">			<span class="keyword">var</span> record = bookRecordDatabase[bookID];</div><div class="line">			record.availability = newStatus;</div><div class="line">			record.checkoutDate = checkoutDate;</div><div class="line">			record.checkoutMember = checkoutMember;</div><div class="line">			record.dueReturnDate = newReturnDate;</div><div class="line">		&#125;,</div><div class="line">		<span class="attr">extendCheckoutPeriod</span>: <span class="function"><span class="keyword">function</span>(<span class="params">bookID, newReturnDate</span>) </span>&#123;</div><div class="line">			bookRecordDatabase[bookID].dueReturnDate = newReturnDate;</div><div class="line">		&#125;,</div><div class="line">		<span class="attr">isPastDue</span>: <span class="function"><span class="keyword">function</span>(<span class="params">bookID</span>) </span>&#123;</div><div class="line">			<span class="keyword">var</span> currentDate = <span class="keyword">new</span> <span class="built_in">Date</span>();</div><div class="line">			<span class="keyword">return</span> currentDate.getTime() &gt; <span class="built_in">Date</span>.parse(bookRecordDatabase[bookID].dueReturnDate);</div><div class="line">		&#125;</div><div class="line">	&#125;;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>将同一种图书的相同信息保存在一个bookmanager对象里， 而且只保存一份； 相比之前的代码， 节约了很多内存。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> Upload = <span class="function"><span class="keyword">function</span>(<span class="params">uploadType</span>) </span>&#123;</div><div class="line">	<span class="keyword">this</span>.uploadType = uploadType;</div><div class="line">&#125;;</div><div class="line">Upload.prototype.delFile = <span class="function"><span class="keyword">function</span>(<span class="params">id</span>) </span>&#123;</div><div class="line">	uploadManager.setExternalState(id, <span class="keyword">this</span>);</div><div class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>.fileSize &lt; <span class="number">3000</span>) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.dom.parentNode.removeChild(<span class="keyword">this</span>.dom);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> (<span class="built_in">window</span>.confirm(<span class="string">'确定要删除该文件吗? '</span> + <span class="keyword">this</span>.fileName)) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.dom.parentNode.removeChild(<span class="keyword">this</span>.dom);</div><div class="line">	&#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// 工厂进行对象实例化</span></div><div class="line"><span class="keyword">var</span> UploadFactory = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	<span class="keyword">var</span> createdFlyWeightObjs = &#123;&#125;;</div><div class="line">	<span class="keyword">return</span> &#123;</div><div class="line">		<span class="attr">create</span>: <span class="function"><span class="keyword">function</span>(<span class="params">uploadType</span>) </span>&#123;</div><div class="line">			<span class="keyword">if</span> (createdFlyWeightObjs[uploadType]) &#123;</div><div class="line">				<span class="keyword">return</span> createdFlyWeightObjs[uploadType];</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span> createdFlyWeightObjs[uploadType] = <span class="keyword">new</span> Upload(uploadType);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;)();</div><div class="line"><span class="comment">// 管理器封装外部状态</span></div><div class="line"><span class="keyword">var</span> uploadManager = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	<span class="keyword">var</span> uploadDatabase = &#123;&#125;;</div><div class="line">	<span class="keyword">return</span> &#123;</div><div class="line">		<span class="attr">add</span>: <span class="function"><span class="keyword">function</span>(<span class="params">id, uploadType, fileName, fileSize</span>) </span>&#123;</div><div class="line">			<span class="keyword">var</span> flyWeightObj = UploadFactory.create(uploadType);</div><div class="line">			<span class="keyword">var</span> dom = <span class="built_in">document</span>.createElement(<span class="string">'div'</span>);</div><div class="line">			dom.innerHTML =</div><div class="line">				<span class="string">'&lt;span&gt;文件名称:'</span> + fileName + <span class="string">', 文件大小: '</span> + fileSize + <span class="string">'&lt;/span&gt;'</span> +</div><div class="line">				<span class="string">'&lt;button class="delFile"&gt;删除&lt;/button&gt;'</span>;</div><div class="line">			dom.querySelector(<span class="string">'.delFile'</span>).onclick = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">				flyWeightObj.delFile(id);</div><div class="line">			&#125;</div><div class="line">			<span class="built_in">document</span>.body.appendChild(dom);</div><div class="line">			uploadDatabase[id] = &#123;</div><div class="line">				<span class="attr">fileName</span>: fileName,</div><div class="line">				<span class="attr">fileSize</span>: fileSize,</div><div class="line">				<span class="attr">dom</span>: dom</div><div class="line">			&#125;;</div><div class="line">			<span class="keyword">return</span> flyWeightObj;</div><div class="line">		&#125;,</div><div class="line">		<span class="attr">setExternalState</span>: <span class="function"><span class="keyword">function</span>(<span class="params">id, flyWeightObj</span>) </span>&#123;</div><div class="line">			<span class="keyword">var</span> uploadData = uploadDatabase[id];</div><div class="line">			<span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> uploadData) &#123;</div><div class="line">				flyWeightObj[i] = uploadData[i];</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;)();</div><div class="line"><span class="comment">// 开始触发上传动作的 startUpload 函数：</span></div><div class="line"><span class="keyword">var</span> id = <span class="number">0</span>;</div><div class="line"><span class="built_in">window</span>.startUpload = <span class="function"><span class="keyword">function</span>(<span class="params">uploadType, files</span>) </span>&#123;</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, file; file = files[i++];) &#123;</div><div class="line">		<span class="keyword">var</span> uploadObj = uploadManager.add(++id, uploadType, file.fileName, file.fileSize);</div><div class="line">	&#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">startUpload(<span class="string">'plugin'</span>, [&#123;</div><div class="line">	<span class="attr">fileName</span>: <span class="string">'1.txt'</span>,</div><div class="line">	<span class="attr">fileSize</span>: <span class="number">1000</span></div><div class="line">&#125;, &#123;</div><div class="line">	<span class="attr">fileName</span>: <span class="string">'2.html'</span>,</div><div class="line">	<span class="attr">fileSize</span>: <span class="number">3000</span></div><div class="line">&#125;, &#123;</div><div class="line">	<span class="attr">fileName</span>: <span class="string">'3.txt'</span>,</div><div class="line">	<span class="attr">fileSize</span>: <span class="number">5000</span></div><div class="line">&#125;]);</div><div class="line">startUpload(<span class="string">'flash'</span>, [&#123;</div><div class="line">	<span class="attr">fileName</span>: <span class="string">'4.txt'</span>,</div><div class="line">	<span class="attr">fileSize</span>: <span class="number">1000</span></div><div class="line">&#125;, &#123;</div><div class="line">	<span class="attr">fileName</span>: <span class="string">'5.html'</span>,</div><div class="line">	<span class="attr">fileSize</span>: <span class="number">3000</span></div><div class="line">&#125;, &#123;</div><div class="line">	<span class="attr">fileName</span>: <span class="string">'6.txt'</span>,</div><div class="line">	<span class="attr">fileSize</span>: <span class="number">5000</span></div><div class="line">&#125;]);</div></pre></td></tr></table></figure></p>
<p>在JavaScript中应用享元模式两种方式， 第一种是应用在数据层上， 主要是应用在内存里大量相似的对象上； 第二种是应用在DOM层上， 享元可以用在中央事件管理器上用来避免给父容器里的每个子元素都附加事件句柄。</p>
<p>享元与数据层，Flyweight中有两个重要概念–内部状态intrinsic和外部状态extrinsic， 内部状态就是在对象里通过内部方法管理， 而外部信息可以在通过外部删除或者保存。<br>这里需要产生不同的新对象， 所以Flyweight模式中常出现Factory模式， Flyweight的内部状态是用来共享的， Flyweight factory负责维护一个Flyweight pool(模式池) 来存放内部状态的对象。</p>
<p>每天打卡， 如果把每条签到记录都当做一个对象， 同一个学生的不同天的签到记录都是一个新对象。<br>但其中学生信息数据完全可以脱离出来， 成为享元。<br>可以创建一个学生工厂用于管理这个享元：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 定义学生接口</span></div><div class="line"><span class="keyword">var</span> StudentInterface = <span class="keyword">new</span> Interface(<span class="string">"StudentInterface"</span>, [<span class="string">"sayHello"</span>, <span class="string">"work"</span>, <span class="string">"sayBye"</span>]);</div><div class="line"><span class="comment">// 创建学生类</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Student</span>(<span class="params">name, id</span>) </span>&#123;</div><div class="line">	Interface.checkImplements(<span class="keyword">this</span>, StudentInterface);</div><div class="line">	<span class="keyword">this</span>.name = name;</div><div class="line">	<span class="keyword">this</span>.id = id;</div><div class="line">&#125;</div><div class="line"><span class="comment">// 实现学生接口中的方法</span></div><div class="line">Student.prototype.work = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	<span class="built_in">console</span>.log(<span class="keyword">this</span>.name + <span class="string">"working..."</span>);</div><div class="line">&#125;;</div><div class="line"></div><div class="line">Student.prototype.sayHello = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	<span class="built_in">console</span>.log(<span class="keyword">this</span>.name + <span class="string">"comming..."</span>);</div><div class="line">&#125;;</div><div class="line"></div><div class="line">Student.prototype.sayBye = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	<span class="built_in">console</span>.log(<span class="keyword">this</span>.name + <span class="string">"leaving..."</span>);</div><div class="line">&#125;;</div><div class="line"><span class="comment">// 创建学生工厂</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">StudentFactory</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	<span class="keyword">var</span> students = &#123;&#125;;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">function</span> <span class="title">createStudent</span>(<span class="params">id, name</span>) </span>&#123;</div><div class="line">		<span class="keyword">if</span> (!students[id]) &#123;</div><div class="line">			students[id] = <span class="keyword">new</span> Student(name, id);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> students[id];</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> &#123;</div><div class="line">		<span class="attr">createStudent</span>: createStudent</div><div class="line">	&#125;;</div><div class="line">&#125;</div><div class="line"><span class="comment">// 签到管理系统</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> StudentManager = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	<span class="comment">// 签到数据库</span></div><div class="line">	<span class="keyword">var</span> attendance = &#123;&#125;;</div><div class="line">	<span class="comment">// 学生工厂</span></div><div class="line">	<span class="keyword">var</span> studentFactory = <span class="keyword">new</span> StudentFactory();</div><div class="line">	<span class="comment">// 签到</span></div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">function</span> <span class="title">signIn</span>(<span class="params">id, name</span>) </span>&#123;</div><div class="line">		<span class="keyword">var</span> student = studentFactory.createStudent(id, name);</div><div class="line">		attendance[id] = attendance[id] || [];</div><div class="line">		attendance[id].push(&#123;</div><div class="line">			<span class="attr">student</span>: student,</div><div class="line">			<span class="attr">signInTime</span>: <span class="keyword">new</span> <span class="built_in">Date</span>(),</div><div class="line">			<span class="attr">state</span>: <span class="string">"signIn"</span></div><div class="line">		&#125;);</div><div class="line">		student.sayHello();</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// 干活</span></div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">function</span> <span class="title">work</span>(<span class="params">id, name</span>) </span>&#123;</div><div class="line">		<span class="keyword">var</span> attend = attendance[id];</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">var</span> i = attend.length; i--;) &#123;</div><div class="line">			<span class="keyword">if</span> (attend[i].state === <span class="string">"signIn"</span>) &#123;</div><div class="line">				attend[i].student.work();</div><div class="line">				attend[i].state = <span class="string">"worked"</span>;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// 签退</span></div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">function</span> <span class="title">signOut</span>(<span class="params">id, name</span>) </span>&#123;</div><div class="line">		<span class="keyword">var</span> attend = attendance[id];</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">var</span> i = attend.length; i--;) &#123;</div><div class="line">			<span class="keyword">if</span> (attend[i].state === <span class="string">"worked"</span>) &#123;</div><div class="line">				attend[i].state = <span class="string">"signOut"</span>;</div><div class="line">				attend[i].signOutTime = <span class="keyword">new</span> <span class="built_in">Date</span>();</div><div class="line">				attend[i].student.sayBye();</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> &#123;</div><div class="line">		<span class="attr">signIn</span>: signIn,</div><div class="line">		<span class="attr">work</span>: work,</div><div class="line">		<span class="attr">signOut</span>: signOut</div><div class="line">	&#125;;</div><div class="line">&#125;());</div></pre></td></tr></table></figure></p>
<p>这样在每次签到的时候， 会去学生工厂申请学生信息。<br>学生工厂中如果没有这个学生的信息， 将创建， 否则直接返回学生信息的引用。<br>所有同一学生的出勤公用一个学生信息对象。</p>
<p>享元模式与DOM<br>关于DOM的事件冒泡， 在这里就不多说了，举两个例子。</p>
<p>例1： 事件集中管理<br>如果很多相似类型的元素或者结构（ 如菜单， 或ul里多个li） 都需要监控click事件的话， 那就需要多每个元素进行事件绑定， 如果元素非常多， 结合冒泡， 一个子元素有事件触发， 触发以后事件将冒泡到上一级元素， 利用这个特性， 使用享元模式， 对这些相似元素的父级元素进行事件监控，再判断里面哪个子元素有事件触发了， 进行进一步的操作。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">stateManager = &#123;</div><div class="line">	<span class="attr">fly</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">		<span class="keyword">var</span> self = <span class="keyword">this</span>;</div><div class="line">		$(<span class="string">'#container'</span>).unbind().bind(<span class="string">"click"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</div><div class="line">			<span class="keyword">var</span> target = $(e.originalTarget || e.srcElement);</div><div class="line">			<span class="comment">// 判断是哪一个子元素      </span></div><div class="line">			<span class="keyword">if</span> (target.is(<span class="string">"div.toggle"</span>)) &#123; </div><div class="line">				self.handleClick(target); </div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;,</div><div class="line">	<span class="attr">handleClick</span>: <span class="function"><span class="keyword">function</span>(<span class="params">elem</span>) </span>&#123; </div><div class="line">		elem.find(<span class="string">'span'</span>).toggle(<span class="string">'slow'</span>); </div><div class="line">	&#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>例2： 应用享元模式提升性能<br>一般在事件的回调函数里使用元素对象， 会用到$(this) 这种形式， 其实重复创建了新对象， 因为本身回调函数里的this已经是DOM元素自身了：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">$(<span class="string">'div'</span>).bind(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; </div><div class="line">	<span class="built_in">console</span>.log(<span class="string">'You clicked: '</span> + $(<span class="keyword">this</span>).attr(<span class="string">'id'</span>)); </div><div class="line">&#125;); </div><div class="line"><span class="comment">// 要避免再次对DOM元素进行生成jQuery对象，因为这里可以直接使用DOM元素自身了</span></div><div class="line">$(<span class="string">'div'</span>).bind(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123; </div><div class="line">	<span class="built_in">console</span>.log(<span class="string">'You clicked: '</span> + <span class="keyword">this</span>.id);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">如果非要用$(<span class="keyword">this</span>) 这样的形式， 也可以实现自己的单实例模式， 比如实现一个jQuery.signle(<span class="keyword">this</span>) 这样的函数以便返回DOM元素自身：</div><div class="line"></div><div class="line">jQuery.single = (<span class="function"><span class="keyword">function</span>(<span class="params">o</span>) </span>&#123;</div><div class="line">	<span class="keyword">var</span> collection = jQuery([<span class="number">1</span>]);</div><div class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">element</span>) </span>&#123; </div><div class="line">		<span class="comment">// 将元素放到集合里       </span></div><div class="line">		collection[<span class="number">0</span>] = element; </div><div class="line">		<span class="comment">// 返回集合 </span></div><div class="line">		<span class="keyword">return</span> collection;</div><div class="line">	&#125;;</div><div class="line">&#125;);</div><div class="line"></div><div class="line">$(<span class="string">'div'</span>).bind(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">	<span class="keyword">var</span> html = jQuery.single(<span class="keyword">this</span>).next().html();</div><div class="line">	<span class="built_in">console</span>.log(html);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>这样就是原样返回DOM元素自身了， 而不进行jQuery对象的创建。</p>

				</div>
				<!-- about -->
				
			</div>
			<!-- pagination -->
			
			<div class="comment-section">
	
	


</div>
		</div>
		
	</div>


		<footer>
			 
<a id="gotop" href="#" title="back to top"><i class="mdi-hardware-keyboard-arrow-up"></i></a>

		</footer>
	</div>
	<!-- <script src="/libs/bs/js/bootstrap.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->
	<script src="/js/highlight.js"></script> 
	<script>hljs.initHighlightingOnLoad();var timeEnd = new Date();console.log('耗时：' + (timeEnd - timeStart));</script>
	<!-- <script>(typeof $().modal == 'function')|| document.write('<script src="/libs/bs/js/bootstrap.min.js" type="text/javascript"><\/script>')</script>-->
	<!-- material design -->
	<!-- <script src="/libs/bs-material/js/ripples.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/ripples.min.js"></script> -->
	<!-- <script src="/libs/bs-material/js/material.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/bootstrap-material/0.3.0/js/material.min.js"></script>-->
	<!-- toc -->
	<!-- <script src="/libs/tocify/jquery-ui.min.js"></script> -->
	<!-- <script src="//apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script> -->
	<!-- <script src="/libs/tocify/jquery.tocify.custom.js"></script> -->
	<!-- <script src="/js/main.js"></script> -->
</body>
</html>
